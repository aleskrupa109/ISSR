<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ISSŘ - Příprava řízení</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet">
    <style>
        /* ===========================================
           ISSŘ HLAVIČKA
           =========================================== */
        .issr-header {
            background-color: #004289;
            height: 56px;
            display: flex;
            align-items: center;
            padding: 0 24px;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1), 0 2px 4px rgba(0,0,0,0.06);
        }

        .issr-header__logo {
            display: flex;
            align-items: center;
            gap: 12px;
            text-decoration: none;
            color: white;
        }

        .issr-header__logo-img {
            height: 40px;
            width: auto;
        }

        .issr-header__title {
            font-size: 12px;
            font-weight: 400;
            color: white;
            letter-spacing: 0.5px;
            white-space: nowrap;
        }

        .issr-header__search {
            flex: 1;
            max-width: 500px;
            margin: 0 40px;
        }

        .issr-header__search-input {
            width: 100%;
            height: 32px;
            padding: 0 16px;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            outline: none;
        }

        .issr-header__search-input::placeholder {
            color: #adb5bd;
        }

        .issr-header__actions {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-left: auto;
        }

        .issr-header__notification {
            position: relative;
            color: white;
            cursor: pointer;
        }

        .issr-header__notification-icon {
            width: 20px;
            height: 20px;
        }

        .issr-header__notification-badge {
            position: absolute;
            top: -6px;
            right: -8px;
            background-color: #0066cc;
            color: white;
            font-size: 10px;
            font-weight: 600;
            min-width: 16px;
            height: 16px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 4px;
        }

        .issr-header__user {
            display: flex;
            align-items: center;
            gap: 8px;
            color: white;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
        }

        .issr-header__user-icon {
            width: 16px;
            height: 16px;
        }

        @media (max-width: 992px) {
            .issr-header__search {
                max-width: 300px;
                margin: 0 20px;
            }
            
            .issr-header__title {
                display: none;
            }
        }

        @media (max-width: 768px) {
            .issr-header {
                padding: 0 16px;
            }
            
            .issr-header__search {
                display: none;
            }
        }

        /* ===========================================
           STYLY STRÁNKY
           =========================================== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Roboto', -apple-system, BlinkMacSystemFont, sans-serif !important;
            font-size: 13px !important;
            color: #333 !important;
            background: #f5f5f5 !important;
            line-height: 1.5 !important;
            text-align: left !important;
        }

        * {
            text-align: left !important;
        }

        .btn, .btn-primary, .btn-secondary, .btn-back, .control-card-action {
            text-align: center !important;
        }

        /* Main layout */
        .main-content {
            display: flex;
            flex-direction: column;
            min-height: calc(100vh - 56px);
        }

        /* Case header - sticky */
        .case-header {
            background: #fff;
            position: sticky;
            top: 56px;
            z-index: 100;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        /* Workflow stepper */
        .workflow-bar {
            display: flex !important;
            align-items: center !important;
            justify-content: space-between !important;
            padding: 10px 32px !important;
            background: #f8f9fa !important;
            border-bottom: 1px solid #e0e0e0 !important;
            flex-wrap: nowrap !important;
        }

        .workflow-stepper {
            display: flex !important;
            align-items: center !important;
            gap: 6px !important;
            flex-wrap: nowrap !important;
        }

        .workflow-step {
            display: inline-flex !important;
            align-items: center !important;
            gap: 6px !important;
            padding: 6px 12px !important;
            border-radius: 16px !important;
            font-size: 12px !important;
            font-weight: 400 !important;
            color: #5f6368 !important;
            background: #fff !important;
            border: 1px solid #dadce0 !important;
            cursor: default !important;
            transition: all 0.15s !important;
            white-space: nowrap !important;
        }

        .workflow-step .step-number {
            width: 18px !important;
            height: 18px !important;
            min-width: 18px !important;
            border-radius: 50% !important;
            background: #f1f3f4 !important;
            color: #5f6368 !important;
            display: inline-flex !important;
            align-items: center !important;
            justify-content: center !important;
            font-size: 10px !important;
            font-weight: 500 !important;
        }

        .workflow-step.active {
            background: #004289 !important;
            border-color: #004289 !important;
            color: #fff !important;
        }

        .workflow-step.active .step-number {
            background: rgba(255,255,255,0.25) !important;
            color: #fff !important;
        }

        .workflow-step.completed {
            background: #e6f4ea !important;
            border-color: #ceead6 !important;
            color: #137333 !important;
        }

        .workflow-step.completed .step-number {
            background: #137333 !important;
            color: #fff !important;
        }

        .workflow-step-connector {
            width: 20px !important;
            height: 2px !important;
            min-width: 20px !important;
            background: #dadce0 !important;
            flex-shrink: 0 !important;
        }

        .workflow-step-connector.completed {
            background: #137333 !important;
        }

        .case-header-main {
            padding: 16px 32px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 24px;
            border-bottom: 1px solid #f0f0f0;
        }

        .case-header-left {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        
        /* Akční tlačítka v hlavičce */
        .case-header-actions {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .header-action-btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 14px;
            background: #fff;
            border: 1px solid #dadce0;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            color: #202124;
            cursor: pointer;
            transition: all 0.15s;
            text-decoration: none;
            white-space: nowrap;
        }
        
        .header-action-btn:hover {
            background: #f1f3f4;
            border-color: #5f6368;
        }
        
        .header-action-btn .material-icons-outlined {
            font-size: 18px;
            color: #5f6368;
        }
        
        .header-action-btn.has-issues {
            border-color: #f9ab00;
            background: #fef7e0;
        }
        
        .header-action-btn.has-issues:hover {
            background: #feefc3;
            border-color: #f29900;
        }
        
        .header-action-btn.has-issues .material-icons-outlined {
            color: #b06000;
        }
        
        .header-action-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 18px;
            height: 18px;
            padding: 0 5px;
            background: #ea4335;
            color: #fff;
            border-radius: 9px;
            font-size: 11px;
            font-weight: 500;
        }
        
        .header-action-badge.warning {
            background: #f9ab00;
            color: #202124;
        }
        
        /* Dropdown menu pro Akce řízení */
        .action-dropdown {
            position: relative;
        }
        
        .action-dropdown-menu {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 4px;
            min-width: 220px;
            background: #fff;
            border: 1px solid #dadce0;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            display: none;
        }
        
        .action-dropdown-menu.open {
            display: block;
        }
        
        .action-dropdown-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 14px;
            font-size: 13px;
            color: #202124;
            cursor: pointer;
            transition: background 0.1s;
        }
        
        .action-dropdown-item:first-child {
            border-radius: 8px 8px 0 0;
        }
        
        .action-dropdown-item:last-child {
            border-radius: 0 0 8px 8px;
        }
        
        .action-dropdown-item:hover {
            background: #f1f3f4;
        }
        
        .action-dropdown-item .material-icons-outlined {
            font-size: 18px;
            color: #5f6368;
        }
        
        .action-dropdown-item.danger {
            color: #c5221f;
        }
        
        .action-dropdown-item.danger .material-icons-outlined {
            color: #c5221f;
        }
        
        .action-dropdown-divider {
            height: 1px;
            background: #e8eaed;
            margin: 4px 0;
        }
        
        /* Slideout panel */
        .slideout-panel {
            position: fixed;
            top: 0;
            right: -500px;
            width: 500px;
            height: 100vh;
            background: #fff;
            box-shadow: -4px 0 20px rgba(0,0,0,0.15);
            z-index: 2000;
            display: flex;
            flex-direction: column;
            transition: right 0.3s ease;
        }
        
        .slideout-panel.open {
            right: 0;
        }
        
        .slideout-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.3);
            z-index: 1999;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        
        .slideout-overlay.open {
            opacity: 1;
            visibility: visible;
        }
        
        .slideout-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 20px;
            border-bottom: 1px solid #e8eaed;
            background: #f8f9fa;
        }
        
        .slideout-title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 16px;
            font-weight: 500;
            color: #202124;
        }
        
        .slideout-title .material-icons-outlined {
            font-size: 22px;
            color: #5f6368;
        }
        
        .slideout-close {
            width: 36px;
            height: 36px;
            border: none;
            background: transparent;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #5f6368;
            transition: background 0.15s;
        }
        
        .slideout-close:hover {
            background: #e8eaed;
        }
        
        .slideout-body {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }
        
        .slideout-footer {
            padding: 16px 20px;
            border-top: 1px solid #e8eaed;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        
        /* Sekce v slideout panelu nedostatků */
        .issues-group {
            margin-bottom: 24px;
        }
        
        .issues-group-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 12px;
            background: #f1f3f4;
            border-radius: 6px;
            margin-bottom: 12px;
        }
        
        .issues-group-title {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            font-weight: 500;
            color: #202124;
        }
        
        .issues-group-title .material-icons-outlined {
            font-size: 18px;
        }
        
        .issues-group-badge {
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 500;
        }
        
        .issues-group-badge.warning {
            background: #fef7e0;
            color: #b06000;
        }
        
        .issues-group-badge.error {
            background: #fce8e6;
            color: #c5221f;
        }
        
        .issues-group-badge.info {
            background: #e8f4fd;
            color: #004289;
        }
        
        .global-issue-item {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            padding: 10px 12px;
            background: #fff;
            border: 1px solid #e8eaed;
            border-radius: 6px;
            margin-bottom: 8px;
        }
        
        .global-issue-item.resolved {
            background: #e6f4ea;
            border-color: #ceead6;
        }
        
        .global-issue-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        
        .global-issue-icon.warning {
            background: #fef7e0;
            color: #b06000;
        }
        
        .global-issue-icon.error {
            background: #fce8e6;
            color: #c5221f;
        }
        
        .global-issue-icon.resolved {
            background: #ceead6;
            color: #137333;
        }
        
        .global-issue-icon .material-icons-outlined {
            font-size: 14px;
        }
        
        .global-issue-content {
            flex: 1;
        }
        
        .global-issue-text {
            font-size: 13px;
            color: #202124;
            margin-bottom: 4px;
        }
        
        .global-issue-meta {
            font-size: 11px;
            color: #5f6368;
        }
        
        .global-issue-actions {
            display: flex;
            gap: 4px;
        }
        
        .global-issue-btn {
            width: 28px;
            height: 28px;
            border: 1px solid #dadce0;
            background: #fff;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #5f6368;
            transition: all 0.15s;
        }
        
        .global-issue-btn:hover {
            background: #f1f3f4;
        }
        
        .global-issue-btn.resolve:hover {
            background: #e6f4ea;
            border-color: #137333;
            color: #137333;
        }
        
        .global-issue-btn .material-icons-outlined {
            font-size: 16px;
        }
        
        /* Sekce v slideout panelu údaje řízení */
        .data-section {
            margin-bottom: 24px;
        }
        
        .data-section-title {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            font-weight: 500;
            color: #5f6368;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .data-section-title .material-icons-outlined {
            font-size: 18px;
        }
        
        .data-row {
            display: flex;
            align-items: flex-start;
            padding: 10px 0;
            border-bottom: 1px solid #f1f3f4;
        }
        
        .data-row:last-child {
            border-bottom: none;
        }
        
        .data-label {
            width: 140px;
            flex-shrink: 0;
            font-size: 12px;
            color: #5f6368;
            padding-top: 2px;
        }
        
        .data-value {
            flex: 1;
            font-size: 13px;
            color: #202124;
        }
        
        .data-value.editable {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .data-edit-btn {
            width: 24px;
            height: 24px;
            border: none;
            background: transparent;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #5f6368;
            opacity: 0;
            transition: all 0.15s;
        }
        
        .data-row:hover .data-edit-btn {
            opacity: 1;
        }
        
        .data-edit-btn:hover {
            background: #e8eaed;
            color: #202124;
        }
        
        .data-edit-btn .material-icons-outlined {
            font-size: 16px;
        }
        
        .data-list {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        
        .data-list-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 10px;
            background: #f8f9fa;
            border-radius: 4px;
            font-size: 12px;
        }
        
        .data-list-item .material-icons-outlined {
            font-size: 16px;
            color: #5f6368;
        }

        .btn-back {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            border: 1px solid #dadce0;
            border-radius: 8px;
            background: #fff;
            color: #5f6368;
            cursor: pointer;
            transition: all 0.15s;
            text-decoration: none;
        }

        .btn-back:hover {
            background: #f1f3f4;
            border-color: #5f6368;
        }

        .case-info {
            flex: 1;
        }

        .case-number {
            font-size: 12px !important;
            color: #5f6368 !important;
            font-family: 'Roboto Mono', monospace !important;
            margin-bottom: 2px !important;
        }

        .case-title {
            font-size: 18px !important;
            font-weight: 500 !important;
            color: #202124 !important;
            font-style: normal !important;
        }

        .case-meta {
            display: flex !important;
            align-items: center !important;
            gap: 16px !important;
            margin-top: 4px !important;
        }

        .case-meta-item {
            display: inline-flex !important;
            align-items: center !important;
            gap: 4px !important;
            font-size: 12px !important;
            color: #5f6368 !important;
        }

        .case-meta-item .material-icons-outlined {
            font-size: 16px;
        }

        .case-meta-link {
            text-decoration: none;
            color: #1a73e8 !important;
            cursor: pointer;
            padding: 4px 8px;
            margin: -4px -8px;
            border-radius: 4px;
            transition: background 0.15s;
        }
        .case-meta-link:hover {
            background: #e8f0fe;
        }
        .case-meta-link .material-icons-outlined {
            color: #1a73e8;
        }

        .case-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
        }

        .case-badge.draft {
            background: #fef7e0;
            color: #b06000;
        }

        .case-badge.active {
            background: #e6f4ea;
            color: #137333;
        }

        .case-badge.fast {
            background: #e8f1fa;
            color: #004289;
        }

        /* Document access bar */
        .document-access-bar {
            background: #f8f9fa !important;
            border-top: 1px solid #e0e0e0 !important;
            padding: 10px 32px !important;
            display: flex !important;
            align-items: center !important;
            gap: 16px !important;
        }

        .document-access-label {
            font-size: 11px !important;
            color: #5f6368 !important;
            font-weight: 500 !important;
            text-transform: uppercase !important;
            letter-spacing: 0.5px !important;
        }

        .document-access-buttons {
            display: flex !important;
            gap: 8px !important;
            flex-wrap: nowrap !important;
            margin-left: 24px !important;
        }

        .doc-access-btn {
            display: inline-flex !important;
            align-items: center !important;
            gap: 6px !important;
            padding: 8px 14px !important;
            background: #fff !important;
            border: 1px solid #dadce0 !important;
            border-radius: 6px !important;
            font-size: 13px !important;
            font-weight: 400 !important;
            color: #202124 !important;
            cursor: pointer !important;
            transition: all 0.15s !important;
            text-decoration: none !important;
            white-space: nowrap !important;
            height: auto !important;
            min-height: 0 !important;
            line-height: 1.4 !important;
        }

        .doc-access-btn:hover {
            background: #e8f4fd !important;
            border-color: #004289 !important;
            color: #004289 !important;
        }

        .doc-access-btn .material-icons-outlined {
            font-size: 18px !important;
            color: #5f6368 !important;
        }

        .doc-access-btn:hover .material-icons-outlined {
            color: #004289 !important;
        }

        .doc-access-btn .badge {
            background: #004289 !important;
            color: #fff !important;
            padding: 2px 8px !important;
            border-radius: 10px !important;
            font-size: 11px !important;
            font-weight: 500 !important;
            margin-left: 2px !important;
        }

        /* Page content */
        .page-content {
            flex: 1;
            padding: 24px 32px;
        }

        /* Section header */
        .section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .section-title {
            display: flex !important;
            align-items: center !important;
            gap: 10px !important;
            font-size: 16px !important;
            font-weight: 500 !important;
            color: #202124 !important;
            font-style: normal !important;
        }

        .section-title .material-icons-outlined {
            font-size: 24px !important;
            color: #004289 !important;
        }
        
        .section-customize-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 28px;
            height: 28px;
            padding: 0;
            margin-left: 4px;
            background: transparent;
            border: 1px solid transparent;
            border-radius: 4px;
            color: #5f6368;
            cursor: pointer;
            transition: all 0.15s;
        }
        
        .section-customize-btn:hover {
            background: #f1f3f4;
            border-color: #dadce0;
            color: #1a73e8;
        }
        
        .section-customize-btn .material-icons-outlined {
            font-size: 18px !important;
            color: inherit !important;
        }

        .section-progress {
            display: flex !important;
            align-items: center !important;
            gap: 8px !important;
            font-size: 13px !important;
            color: #5f6368 !important;
        }

        .progress-bar {
            width: 120px;
            height: 6px;
            background: #e0e0e0;
            border-radius: 3px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: #34a853;
            border-radius: 3px;
            transition: width 0.3s;
        }

        /* Control cards grid */
        .control-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
            margin-bottom: 24px;
        }

        .control-card {
            background: #fff;
            border: 1px solid #e0e0e0;
            border-radius: 12px;
            overflow: hidden;
            transition: all 0.15s;
        }

        .control-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }

        .control-card.disabled {
            opacity: 0.6;
            pointer-events: none;
        }

        .control-card-header {
            padding: 16px;
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            gap: 12px;
        }

        .control-card-icon {
            width: 44px;
            height: 44px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .control-card-icon .material-icons-outlined {
            font-size: 24px;
        }

        /* Status colors */
        .status-waiting .control-card-icon {
            background: #f5f5f5;
            color: #9aa0a6;
        }

        .status-ready .control-card-icon {
            background: #e8f1fa;
            color: #004289;
        }

        .status-in-progress .control-card-icon {
            background: #fef7e0;
            color: #b06000;
        }

        .status-done .control-card-icon {
            background: #e6f4ea;
            color: #137333;
        }

        .status-problem .control-card-icon {
            background: #fce8e6;
            color: #c5221f;
        }

        .control-card-status {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
        }

        .status-waiting .control-card-status {
            background: #f5f5f5;
            color: #5f6368;
        }

        .status-ready .control-card-status {
            background: #e8f1fa;
            color: #004289;
        }

        .status-in-progress .control-card-status {
            background: #fef7e0;
            color: #b06000;
        }

        .status-done .control-card-status {
            background: #e6f4ea;
            color: #137333;
        }

        .status-problem .control-card-status {
            background: #fce8e6;
            color: #c5221f;
        }
        
        .status-blocked .control-card-status {
            background: #fce8e6;
            color: #c5221f;
        }
        
        .status-blocked .control-card-icon {
            background: #f5f5f5;
            color: #9aa0a6;
        }
        
        .status-blocked .control-card-title {
            color: #9aa0a6 !important;
        }
        
        .status-blocked .control-card-desc {
            color: #c5221f !important;
        }

        .control-card-body {
            padding: 0 16px 16px !important;
        }

        .control-card-title {
            font-size: 15px !important;
            font-weight: 500 !important;
            color: #202124 !important;
            margin-bottom: 4px !important;
            font-style: normal !important;
        }

        .control-card-desc {
            font-size: 12px !important;
            color: #5f6368 !important;
            line-height: 1.4 !important;
            margin-bottom: 12px !important;
            font-style: normal !important;
        }

        .control-card-action {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 14px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s;
            text-decoration: none;
            border: none;
        }

        .status-waiting .control-card-action {
            background: #f5f5f5;
            color: #9aa0a6;
            cursor: not-allowed;
        }

        .status-ready .control-card-action {
            background: #004289;
            color: #fff;
        }

        .status-ready .control-card-action:hover {
            background: #1b4d7a;
        }

        .status-in-progress .control-card-action {
            background: #fef7e0;
            color: #b06000;
            border: 1px solid #f5e6b3;
        }

        .status-done .control-card-action {
            background: #e6f4ea;
            color: #137333;
            border: 1px solid #ceead6;
        }

        .status-problem .control-card-action {
            background: #fce8e6;
            color: #c5221f;
            border: 1px solid #f5c6c3;
        }

        .control-card-action .material-icons-outlined {
            font-size: 18px;
        }

        /* Summary card */
        .summary-card {
            background: #fff;
            border: 1px solid #e0e0e0;
            border-radius: 12px;
            padding: 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 24px;
        }

        .summary-content {
            flex: 1;
        }

        .summary-title {
            font-size: 16px !important;
            font-weight: 500 !important;
            color: #202124 !important;
            margin-bottom: 4px !important;
            font-style: normal !important;
        }

        .summary-desc {
            font-size: 13px !important;
            color: #5f6368 !important;
            font-style: normal !important;
        }

        .summary-actions {
            display: flex;
            gap: 12px;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 12px 24px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s;
            text-decoration: none;
            border: 1px solid;
            white-space: nowrap;
        }

        .btn-primary {
            background: #004289;
            color: #fff;
            border-color: #004289;
        }

        .btn-primary:hover {
            background: #1b4d7a;
            border-color: #1b4d7a;
        }

        .btn-primary:disabled {
            background: #dadce0;
            border-color: #dadce0;
            color: #9aa0a6;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: #fff;
            color: #5f6368;
            border-color: #dadce0;
        }

        .btn-secondary:hover {
            background: #f5f5f5;
            border-color: #5f6368;
        }

        .btn .material-icons-outlined {
            font-size: 18px;
        }

        /* Popis stavby sekce */
        .popis-preview {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 10px 12px;
            background: #f8f9fa;
            border: 1px solid #e8eaed;
            border-radius: 6px;
        }
        
        .popis-preview-text {
            flex: 1;
            font-size: 13px;
            color: #3c4043;
            line-height: 1.5;
            max-height: 60px;
            overflow: hidden;
            position: relative;
        }
        
        .popis-preview-text::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 24px;
            background: linear-gradient(transparent, #f8f9fa);
        }
        
        .popis-edit-btn {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 6px 12px;
            background: #fff;
            border: 1px solid #dadce0;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            color: #1a73e8;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.15s;
        }
        
        .popis-edit-btn:hover {
            background: #e8f0fe;
            border-color: #1a73e8;
        }
        
        .popis-edit-btn .material-icons-outlined {
            font-size: 16px;
        }
        
        .popis-textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #dadce0;
            border-radius: 6px;
            font-size: 13px;
            font-family: inherit;
            line-height: 1.6;
            color: #202124;
            resize: vertical;
            min-height: 150px;
        }
        
        .popis-textarea:focus {
            outline: none;
            border-color: #1a73e8;
            box-shadow: 0 0 0 2px rgba(26, 115, 232, 0.2);
        }
        
        .popis-ai-btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 14px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            color: #fff;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .popis-ai-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        .popis-ai-btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            transform: none;
        }
        
        .popis-ai-btn .material-icons-outlined {
            font-size: 16px;
        }
        
        .popis-ai-btn .spinning {
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        .popis-stavby-collapsed:hover {
            background: #f8f9fa;
            border-radius: 4px;
            margin: -4px;
            padding: 4px;
        }
        
        .popis-stavby-collapsed:hover .popis-expand-btn {
            background: #e8f0fe;
            border-color: #1a73e8;
        }
        
        .popis-expand-btn:hover {
            background: #e8f0fe !important;
            border-color: #1a73e8 !important;
        }

        /* Info panel */
        .info-panel {
            background: #e8f1fa;
            border: 1px solid #c5d9f0;
            border-radius: 12px;
            padding: 16px 20px;
            margin-bottom: 24px;
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }

        .info-panel .material-icons-outlined {
            font-size: 20px;
            color: #004289;
            flex-shrink: 0;
        }

        .info-panel-content {
            flex: 1;
        }

        .info-panel-title {
            font-size: 14px !important;
            font-weight: 500 !important;
            color: #1a4d7c !important;
            margin-bottom: 2px !important;
            font-style: normal !important;
        }

        .info-panel-text {
            font-size: 13px !important;
            color: #1a4d7c !important;
            font-style: normal !important;
        }

        .info-panel.warning {
            background: #fef7e0 !important;
            border-color: #f5e6b3 !important;
        }

        .info-panel.warning .material-icons-outlined {
            color: #b06000 !important;
        }

        .info-panel.warning .info-panel-title {
            color: #7a4200 !important;
        }

        .info-panel.warning .info-panel-text {
            color: #7a4200 !important;
        }

        .info-panel.error {
            background: #fce8e6 !important;
            border-color: #f5c6c3 !important;
        }

        .info-panel.error .material-icons-outlined {
            color: #c5221f !important;
        }

        .info-panel.error .info-panel-title {
            color: #a50e0e !important;
        }

        .info-panel.error .info-panel-text {
            color: #a50e0e !important;
        }

        .info-panel.schedule {
            background: #e8f1fa !important;
            border-color: #c2d9f2 !important;
        }

        .info-panel.schedule .material-icons-outlined {
            color: #004289 !important;
        }

        .info-panel.schedule .info-panel-title {
            color: #003366 !important;
        }

        .info-panel.schedule .info-panel-text {
            color: #003366 !important;
        }

        /* Phase tabs */
        .phase-tabs {
            display: flex;
            gap: 4px;
            margin-bottom: 24px;
            background: #f1f3f4;
            padding: 4px;
            border-radius: 10px;
        }

        .phase-tab {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 12px 16px;
            background: transparent;
            border: none;
            border-radius: 8px;
            font-size: 14px !important;
            font-weight: 500 !important;
            color: #5f6368 !important;
            cursor: pointer;
            transition: all 0.2s;
            font-style: normal !important;
        }

        .phase-tab:hover {
            background: #e8eaed;
        }

        .phase-tab.active {
            background: #fff;
            color: #202124 !important;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .phase-tab .material-icons-outlined {
            font-size: 20px;
        }

        .phase-tab-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 20px;
            height: 20px;
            padding: 0 6px;
            background: #e8eaed;
            border-radius: 10px;
            font-size: 11px !important;
            font-weight: 600 !important;
        }

        .phase-tab.active .phase-tab-badge {
            background: #e8f0fe;
            color: #1a73e8;
        }

        .phase-tab-badge.done {
            background: #e6f4ea !important;
            color: #137333 !important;
        }

        .phase-content {
            display: none;
        }

        .phase-content.active {
            display: block;
        }

        /* Pozemky overlay styles */
        .parcels-readonly-section {
            margin-bottom: 24px;
        }

        .parcels-readonly-title {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px !important;
            font-weight: 500 !important;
            color: #202124 !important;
            margin-bottom: 12px;
            font-style: normal !important;
        }

        .parcels-readonly-title .material-icons-outlined {
            font-size: 18px;
            color: #1a73e8;
        }

        .parcels-readonly-badge {
            margin-left: auto;
            padding: 2px 8px;
            background: #e8f0fe;
            color: #1a73e8;
            border-radius: 4px;
            font-size: 11px !important;
            font-weight: 500 !important;
        }

        .parcel-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .parcel-chip {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 14px;
            background: #e8f0fe;
            border: 1px solid #c2d7f2;
            border-radius: 8px;
            font-size: 13px !important;
            color: #202124 !important;
            font-style: normal !important;
        }

        .parcel-chip-icon {
            width: 24px;
            height: 24px;
            background: #1a73e8;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .parcel-chip-icon .material-icons-outlined {
            font-size: 16px;
            color: #fff;
        }

        .parcel-chip-content {
            display: flex;
            flex-direction: column;
        }

        .parcel-chip-number {
            font-weight: 500 !important;
            font-family: 'Roboto Mono', monospace !important;
            font-size: 13px !important;
        }

        .parcel-chip-katastr {
            font-size: 11px !important;
            color: #5f6368 !important;
        }

        .parcel-chip-area {
            color: #5f6368 !important;
            font-size: 12px !important;
            margin-left: auto;
            padding-left: 12px;
        }

        /* Sousední pozemky - interaktivní */
        .parcels-interactive-section {
            margin-top: 0;
        }

        .parcels-section-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 16px;
        }

        .parcels-section-title {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px !important;
            font-weight: 500 !important;
            color: #202124 !important;
            font-style: normal !important;
        }

        .parcels-section-title .material-icons-outlined {
            font-size: 18px;
            color: #f57c00;
        }

        .parcels-section-count {
            margin-left: auto;
            padding: 2px 8px;
            background: #fff3e0;
            color: #e65100;
            border-radius: 4px;
            font-size: 11px !important;
            font-weight: 500 !important;
        }

        .parcels-search-row {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
        }

        .parcels-search-input {
            flex: 1;
            padding: 10px 14px;
            border: 1px solid #dadce0;
            border-radius: 6px;
            font-size: 14px !important;
            font-style: normal !important;
        }

        .parcels-search-input:focus {
            outline: none;
            border-color: #1a73e8;
            box-shadow: 0 0 0 2px rgba(26, 115, 232, 0.2);
        }

        .btn-search {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 10px 16px;
            background: #1a73e8;
            color: #fff !important;
            border: none;
            border-radius: 6px;
            font-size: 13px !important;
            font-weight: 500 !important;
            cursor: pointer;
            font-style: normal !important;
        }

        .btn-search:hover {
            background: #1557b0;
        }

        .btn-map {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 10px 16px;
            background: #fff;
            color: #5f6368 !important;
            border: 1px solid #dadce0;
            border-radius: 6px;
            font-size: 13px !important;
            font-weight: 500 !important;
            cursor: pointer;
            font-style: normal !important;
        }

        .btn-map:hover {
            background: #f8f9fa;
            border-color: #5f6368;
        }

        .btn-map .material-icons-outlined {
            font-size: 18px;
        }

        .sousedni-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-height: 280px;
            overflow-y: auto;
        }

        .sousedni-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 14px;
            background: #fff8e1;
            border: 1px solid #ffe082;
            border-radius: 8px;
        }

        .sousedni-item .parcel-chip-icon {
            background: #f57c00;
        }

        .sousedni-item-content {
            flex: 1;
        }

        .sousedni-item-number {
            font-size: 13px !important;
            font-weight: 500 !important;
            color: #202124 !important;
            font-family: 'Roboto Mono', monospace !important;
            font-style: normal !important;
        }

        .sousedni-item-katastr {
            font-size: 11px !important;
            color: #5f6368 !important;
            font-style: normal !important;
        }

        .sousedni-item-owner {
            font-size: 12px !important;
            color: #5f6368 !important;
            margin-top: 2px;
            font-style: normal !important;
        }

        .sousedni-item-remove {
            width: 28px;
            height: 28px;
            background: transparent;
            border: none;
            border-radius: 4px;
            color: #5f6368;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .sousedni-item-remove:hover {
            background: #ffecb3;
            color: #e65100;
        }

        .sousedni-empty {
            padding: 32px 24px;
            text-align: center;
            background: #fafafa;
            border: 2px dashed #e0e0e0;
            border-radius: 8px;
        }

        .sousedni-empty .material-icons-outlined {
            font-size: 40px;
            color: #bdbdbd;
            margin-bottom: 12px;
        }

        .sousedni-empty-text {
            font-size: 14px !important;
            color: #5f6368 !important;
            font-style: normal !important;
        }

        .sousedni-empty-hint {
            font-size: 12px !important;
            color: #9aa0a6 !important;
            margin-top: 4px;
            font-style: normal !important;
        }

        /* Auto-detect button */
        .btn-autodetect {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 10px 16px;
            background: linear-gradient(135deg, #7c3aed 0%, #5b21b6 100%);
            color: #fff !important;
            border: none;
            border-radius: 6px;
            font-size: 13px !important;
            font-weight: 500 !important;
            cursor: pointer;
            font-style: normal !important;
            margin-bottom: 16px;
        }

        .btn-autodetect:hover {
            background: linear-gradient(135deg, #6d28d9 0%, #4c1d95 100%);
        }

        .btn-autodetect .material-icons-outlined {
            font-size: 18px;
        }
        .status-warning .control-card-icon {
            background: #fef7e0 !important;
            color: #b06000 !important;
        }

        .status-warning .control-card-status {
            background: #fef7e0 !important;
            color: #b06000 !important;
        }

        .status-error .control-card-icon {
            background: #fce8e6 !important;
            color: #c5221f !important;
        }

        .status-error .control-card-status {
            background: #fce8e6 !important;
            color: #c5221f !important;
        }

        /* Výběr příslušného SÚ */
        .su-selection-section {
            margin-top: 20px;
            padding: 16px;
            background: #fff8e1;
            border: 1px solid #ffe082;
            border-radius: 8px;
            display: none;
        }

        .su-selection-section.visible {
            display: block;
        }

        .su-selection-title {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px !important;
            font-weight: 500 !important;
            color: #e65100 !important;
            margin-bottom: 12px;
            font-style: normal !important;
        }

        .su-selection-title .material-icons-outlined {
            font-size: 18px;
            color: #f57c00;
        }

        .su-selection-desc {
            font-size: 12px !important;
            color: #795548 !important;
            margin-bottom: 12px;
            font-style: normal !important;
        }

        .su-select-wrapper {
            position: relative;
        }

        .su-select {
            width: 100%;
            padding: 12px 40px 12px 14px;
            font-size: 14px !important;
            border: 1px solid #dadce0;
            border-radius: 6px;
            background: #fff;
            color: #202124 !important;
            cursor: pointer;
            appearance: none;
            font-style: normal !important;
            font-family: 'Roboto', sans-serif !important;
        }

        .su-select:focus {
            outline: none;
            border-color: #f57c00;
            box-shadow: 0 0 0 2px rgba(245, 124, 0, 0.2);
        }

        .su-select-wrapper {
            position: relative;
        }

        /* Searchable dropdown */
        .su-search-select {
            position: relative;
        }
        
        .su-search-input-wrapper {
            position: relative;
            display: flex;
            align-items: center;
        }
        
        .su-search-icon {
            position: absolute;
            left: 12px;
            color: #5f6368;
            font-size: 20px;
            pointer-events: none;
        }
        
        .su-search-input {
            width: 100%;
            padding: 12px 40px 12px 42px;
            font-size: 14px;
            border: 1px solid #dadce0;
            border-radius: 6px;
            background: #fff;
            color: #202124;
            font-family: 'Roboto', sans-serif;
            transition: all 0.15s;
        }
        
        .su-search-input:focus {
            outline: none;
            border-color: #f57c00;
            box-shadow: 0 0 0 2px rgba(245, 124, 0, 0.2);
        }
        
        .su-search-input::placeholder {
            color: #9aa0a6;
        }
        
        .su-search-input.selected {
            background: #fff8e1;
            border-color: #f57c00;
        }
        
        .su-search-clear {
            position: absolute;
            right: 8px;
            width: 28px;
            height: 28px;
            display: none;
            align-items: center;
            justify-content: center;
            border: none;
            background: transparent;
            border-radius: 50%;
            cursor: pointer;
            color: #5f6368;
        }
        
        .su-search-clear:hover {
            background: #f1f3f4;
            color: #202124;
        }
        
        .su-search-input.selected + .su-search-clear {
            display: flex;
        }
        
        .su-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            max-height: 320px;
            overflow-y: auto;
            background: #fff;
            border: 1px solid #dadce0;
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 100;
            display: none;
            margin-top: 4px;
        }
        
        .su-dropdown.open {
            display: block;
        }
        
        .su-dropdown-group {
            border-bottom: 1px solid #f1f3f4;
        }
        
        .su-dropdown-group:last-of-type {
            border-bottom: none;
        }
        
        .su-dropdown-group.hidden {
            display: none;
        }
        
        .su-dropdown-group-title {
            padding: 10px 14px 6px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            color: #5f6368;
            background: #f8f9fa;
            position: sticky;
            top: 0;
        }
        
        .su-dropdown-option {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 14px;
            cursor: pointer;
            transition: background 0.1s;
        }
        
        .su-dropdown-option:hover {
            background: #f1f3f4;
        }
        
        .su-dropdown-option.hidden {
            display: none;
        }
        
        .su-dropdown-option.selected {
            background: #fff8e1;
        }
        
        .su-option-name {
            font-size: 13px;
            color: #202124;
        }
        
        .su-option-type {
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            padding: 2px 6px;
            background: #e8eaed;
            border-radius: 3px;
            color: #5f6368;
        }
        
        .su-dropdown-empty {
            padding: 24px;
            text-align: center;
            color: #9aa0a6;
        }
        
        .su-dropdown-empty .material-icons-outlined {
            font-size: 32px;
            display: block;
            margin-bottom: 8px;
        }

        .su-selected-info {
            margin-top: 12px;
            padding: 12px;
            background: #fff;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            display: none;
        }

        .su-selected-info.visible {
            display: block;
        }

        .su-selected-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }

        .su-selected-icon {
            width: 32px;
            height: 32px;
            background: #e8f1fa;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .su-selected-icon .material-icons-outlined {
            font-size: 18px;
            color: #004289;
        }

        .su-selected-name {
            font-size: 14px !important;
            font-weight: 500 !important;
            color: #202124 !important;
            font-style: normal !important;
        }

        .su-selected-details {
            font-size: 12px !important;
            color: #5f6368 !important;
            margin-top: 4px;
            font-style: normal !important;
        }

        .su-selected-details span {
            display: block;
            margin-bottom: 2px;
        }

        /* Kontrola dokumentace - rozšířené styly */
        .doc-check-section {
            margin-bottom: 20px;
        }

        .doc-check-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }

        .doc-check-title {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px !important;
            font-weight: 500 !important;
            color: #202124 !important;
            font-style: normal !important;
        }

        .doc-check-title .material-icons-outlined {
            font-size: 18px;
            color: #004289;
        }

        .doc-check-badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px !important;
            font-weight: 500 !important;
        }

        .doc-check-badge.pending {
            background: #f5f5f5;
            color: #5f6368;
        }

        .doc-check-badge.running {
            background: #e8f1fa;
            color: #004289;
        }

        .doc-check-badge.success {
            background: #e6f4ea;
            color: #137333;
        }

        .doc-check-badge.warning {
            background: #fef7e0;
            color: #b06000;
        }

        .doc-check-badge.error {
            background: #fce8e6;
            color: #c5221f;
        }

        /* Seznam dokumentů */
        .doc-list {
            display: flex;
            flex-direction: column;
            gap: 6px;
            max-height: 280px;
            overflow-y: auto;
        }

        .doc-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 12px;
            background: #f8f9fa;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.15s;
        }

        .doc-item:hover {
            background: #e8f1fa;
            border-color: #c5d9f0;
        }

        .doc-item.checked {
            background: #e6f4ea;
            border-color: #ceead6;
        }

        .doc-item.has-issue {
            background: #fef7e0;
            border-color: #ffe082;
        }

        .doc-item-checkbox {
            width: 20px;
            height: 20px;
            border: 2px solid #dadce0;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            transition: all 0.15s;
        }

        .doc-item.checked .doc-item-checkbox {
            background: #137333;
            border-color: #137333;
            color: #fff;
        }

        .doc-item.has-issue .doc-item-checkbox {
            background: #f57c00;
            border-color: #f57c00;
            color: #fff;
        }

        .doc-item-checkbox .material-icons-outlined {
            font-size: 16px;
            display: none;
        }

        .doc-item.checked .doc-item-checkbox .material-icons-outlined,
        .doc-item.has-issue .doc-item-checkbox .material-icons-outlined {
            display: block;
        }

        .doc-item-content {
            flex: 1;
            min-width: 0;
        }

        .doc-item-name {
            font-size: 13px !important;
            font-weight: 500 !important;
            color: #202124 !important;
            font-style: normal !important;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .doc-item-meta {
            font-size: 11px !important;
            color: #5f6368 !important;
            font-style: normal !important;
            display: flex;
            gap: 12px;
            margin-top: 2px;
        }

        .doc-item-actions {
            display: flex;
            gap: 4px;
        }

        .doc-item-btn {
            width: 28px;
            height: 28px;
            border: none;
            background: transparent;
            border-radius: 4px;
            color: #5f6368;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .doc-item-btn:hover {
            background: rgba(0,0,0,0.08);
            color: #202124;
        }

        .doc-item-btn.issue-btn:hover {
            background: #fff3e0;
            color: #e65100;
        }

        .doc-item-btn .material-icons-outlined {
            font-size: 18px;
        }

        /* Automatická kontrola */
        .auto-check-section {
            margin-bottom: 20px;
            padding: 16px;
            background: #f8f9fa;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
        }

        .auto-check-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }

        .auto-check-title {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px !important;
            font-weight: 500 !important;
            color: #202124 !important;
            font-style: normal !important;
        }

        .auto-check-title .material-icons-outlined {
            font-size: 18px;
            color: #7c3aed;
        }

        .btn-run-check {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 14px;
            background: linear-gradient(135deg, #7c3aed 0%, #5b21b6 100%);
            color: #fff !important;
            border: none;
            border-radius: 6px;
            font-size: 12px !important;
            font-weight: 500 !important;
            cursor: pointer;
            font-style: normal !important;
        }

        .btn-run-check:hover {
            background: linear-gradient(135deg, #6d28d9 0%, #4c1d95 100%);
        }

        .btn-run-check:disabled {
            background: #dadce0;
            cursor: not-allowed;
        }

        .btn-run-check .material-icons-outlined {
            font-size: 16px;
        }

        /* ED stromová struktura */
        .ed-tree {
            font-size: 13px;
        }

        .ed-tree-header {
            display: flex;
            flex-direction: column;
            gap: 8px;
            padding: 12px;
            background: #e8f1fa;
            border-radius: 8px;
            margin-bottom: 12px;
        }

        .ed-tree-header-top {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .ed-tree-header .material-icons-outlined {
            font-size: 20px;
            color: #004289;
        }

        .ed-version-selector {
            display: flex;
            align-items: center;
            padding-top: 8px;
            border-top: 1px solid #c5d9f0;
        }

        .ed-version-select {
            padding: 6px 10px;
            border: 1px solid #c5d9f0;
            border-radius: 4px;
            font-size: 12px;
            background: #fff;
            color: #202124;
            cursor: pointer;
            flex: 1;
        }

        .ed-version-select:focus {
            outline: none;
            border-color: #004289;
            box-shadow: 0 0 0 2px rgba(35, 98, 162, 0.2);
        }

        /* ED Breadcrumb a tlačítko Zpět */
        .ed-breadcrumb {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 0 8px;
        }
        
        .ed-back-btn {
            background: #e8f0fe !important;
            border-color: #1a73e8 !important;
            color: #1a73e8 !important;
        }
        
        .ed-back-btn:hover {
            background: #d2e3fc !important;
        }
        
        /* Kategorie stavby styly */
        .stavba-kategorie-section {
            background: #fafafa;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 20px;
        }
        
        .stavba-kategorie-section .control-section-title {
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .stavba-field {
            margin-bottom: 16px;
        }
        
        .stavba-field:last-child {
            margin-bottom: 0;
        }
        
        .stavba-field-label {
            font-size: 12px;
            font-weight: 600;
            color: #202124;
            margin-bottom: 8px;
        }
        
        .stavba-field-hint {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 11px;
            color: #5f6368;
            margin-top: 6px;
        }
        
        .stavba-field-hint .material-icons-outlined {
            font-size: 14px;
        }
        
        .stavba-toggle-group {
            display: flex;
            gap: 8px;
        }
        
        .stavba-toggle {
            cursor: pointer;
        }
        
        .stavba-toggle input {
            display: none;
        }
        
        .stavba-toggle-label {
            display: inline-block;
            padding: 8px 20px;
            background: #fff;
            border: 1px solid #dadce0;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            color: #5f6368;
            transition: all 0.15s;
        }
        
        .stavba-toggle input:checked + .stavba-toggle-label {
            background: #e8f0fe;
            border-color: #1a73e8;
            color: #1a73e8;
        }
        
        .stavba-kategorie-options {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
        }
        
        .stavba-kategorie-option {
            cursor: pointer;
        }
        
        .stavba-kategorie-option input {
            display: none;
        }
        
        .stavba-kategorie-box {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 12px 8px;
            background: #fff;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            text-align: center;
            transition: all 0.15s;
        }
        
        .stavba-kategorie-option input:checked + .stavba-kategorie-box {
            background: #e8f0fe;
            border-color: #1a73e8;
        }
        
        .stavba-kategorie-box:hover {
            border-color: #bdc1c6;
        }
        
        .kategorie-name {
            font-size: 13px;
            font-weight: 600;
            color: #202124;
            margin-bottom: 2px;
        }
        
        .kategorie-desc {
            font-size: 10px;
            color: #5f6368;
        }
        
        /* Soubor staveb */
        .stavba-soubor-wrapper {
            background: #fff;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .stavba-soubor-item {
            border-bottom: 1px solid #e0e0e0;
        }
        
        .stavba-soubor-item:last-child {
            border-bottom: none;
        }
        
        .stavba-soubor-header {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 12px;
            background: #f8f9fa;
            font-size: 12px;
            font-weight: 600;
            color: #202124;
        }
        
        .stavba-soubor-header .material-icons-outlined {
            font-size: 18px;
            color: #5f6368;
        }
        
        .stavba-soubor-item.hlavni .stavba-soubor-header {
            background: #fff8e1;
        }
        
        .stavba-soubor-item.hlavni .stavba-soubor-header .material-icons-outlined {
            color: #f57c00;
        }
        
        .stavba-soubor-badge {
            font-size: 10px;
            font-weight: 500;
            padding: 2px 6px;
            background: #f57c00;
            color: #fff;
            border-radius: 4px;
            margin-left: auto;
        }
        
        .stavba-soubor-content {
            padding: 12px;
        }
        
        .stavba-soubor-nazev {
            margin-bottom: 10px;
        }
        
        .stavba-input {
            width: 100%;
            padding: 8px 12px;
            font-size: 13px;
            border: 1px solid #dadce0;
            border-radius: 6px;
            font-family: inherit;
        }
        
        .stavba-input:focus {
            outline: none;
            border-color: #1a73e8;
            box-shadow: 0 0 0 2px rgba(26, 115, 232, 0.2);
        }
        
        .stavba-kategorie-mini {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }
        
        .kategorie-mini-option {
            cursor: pointer;
        }
        
        .kategorie-mini-option input {
            display: none;
        }
        
        .kategorie-mini-option span {
            display: inline-block;
            padding: 6px 12px;
            font-size: 11px;
            font-weight: 500;
            background: #f1f3f4;
            border: 1px solid transparent;
            border-radius: 4px;
            color: #5f6368;
            transition: all 0.15s;
        }
        
        .kategorie-mini-option input:checked + span {
            background: #e8f0fe;
            border-color: #1a73e8;
            color: #1a73e8;
        }
        
        .vedlejsi-stavby-list {
            margin-bottom: 10px;
        }
        
        .vedlejsi-stavba-row {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
            align-items: center;
        }
        
        .vedlejsi-stavba-row .stavba-input {
            flex: 1;
        }
        
        .stavba-select {
            padding: 8px 12px;
            font-size: 12px;
            border: 1px solid #dadce0;
            border-radius: 6px;
            background: #fff;
            font-family: inherit;
            min-width: 100px;
        }
        
        .stavba-select:focus {
            outline: none;
            border-color: #1a73e8;
        }
        
        .vedlejsi-remove {
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            background: transparent;
            border-radius: 50%;
            cursor: pointer;
            color: #5f6368;
        }
        
        .vedlejsi-remove:hover {
            background: #fce8e6;
            color: #c5221f;
        }
        
        .vedlejsi-remove .material-icons-outlined {
            font-size: 18px;
        }
        
        .btn-add-vedlejsi {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 8px 12px;
            font-size: 12px;
            font-weight: 500;
            color: #1a73e8;
            background: transparent;
            border: 1px dashed #1a73e8;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.15s;
        }
        
        .btn-add-vedlejsi:hover {
            background: #e8f0fe;
        }
        
        .btn-add-vedlejsi .material-icons-outlined {
            font-size: 16px;
        }
        
        .stavba-soubor-summary {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-top: 12px;
            padding: 10px 12px;
            background: #e8f5e9;
            border-radius: 6px;
            font-size: 12px;
            color: #1b5e20;
        }
        
        .stavba-soubor-summary .material-icons-outlined {
            font-size: 18px;
        }

        .ed-folder {
            margin-left: 0;
            margin-bottom: 2px;
        }

        .ed-folder.nested {
            margin-left: 20px;
        }

        .ed-folder-header {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 10px;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.15s;
        }

        .ed-folder-header:hover {
            background: #f5f5f5;
        }

        .ed-folder-header .folder-icon {
            font-size: 18px;
            color: #f9a825;
            transition: transform 0.2s;
        }

        .ed-folder.open > .ed-folder-header .folder-icon {
            color: #f57c00;
        }

        .ed-folder-header .folder-name {
            flex: 1;
            font-weight: 500;
            color: #202124;
        }

        .ed-folder-header .folder-count {
            font-size: 11px;
            color: #5f6368;
            padding: 2px 8px;
            background: #f1f3f4;
            border-radius: 10px;
        }

        .ed-folder-content {
            display: none;
            margin-left: 24px;
            padding-left: 12px;
            border-left: 1px solid #e0e0e0;
        }

        .ed-folder.open > .ed-folder-content {
            display: block;
        }

        .ed-file {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 10px;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.15s;
        }

        .ed-file:hover {
            background: #e8f1fa;
        }

        .ed-file .material-icons-outlined {
            font-size: 16px;
            color: #c62828;
        }

        .ed-file .file-name {
            flex: 1;
            color: #202124;
        }

        .ed-file .file-size {
            font-size: 11px;
            color: #5f6368;
        }

        .ed-file-more {
            padding: 6px 10px;
            font-size: 12px;
            color: #5f6368;
            font-style: italic;
        }

        .ed-folder.empty .ed-folder-header {
            cursor: default;
        }

        .ed-folder.empty .ed-folder-header:hover {
            background: transparent;
        }

        /* Kontrola částí dokumentace */
        .doc-parts-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .doc-part-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 12px;
            background: #f8f9fa;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            transition: all 0.15s;
        }

        .doc-part-item.status-ok {
            background: #e6f4ea;
            border-color: #ceead6;
        }

        .doc-part-item.status-warning {
            background: #fef7e0;
            border-color: #ffe082;
        }

        .doc-part-item.status-error {
            background: #fce8e6;
            border-color: #f5c6c3;
        }

        .doc-part-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .doc-part-letter {
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #004289;
            color: #fff;
            border-radius: 6px;
            font-weight: 600;
            font-size: 14px;
        }

        .doc-part-item.status-ok .doc-part-letter {
            background: #137333;
        }

        .doc-part-item.status-warning .doc-part-letter {
            background: #f57c00;
        }

        .doc-part-item.status-error .doc-part-letter {
            background: #c5221f;
        }

        .doc-part-name {
            font-weight: 500;
            color: #202124;
        }

        .doc-part-status {
            display: flex;
            gap: 4px;
        }

        .doc-part-btn {
            width: 32px;
            height: 32px;
            border: 1px solid #dadce0;
            background: #fff;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s;
            color: #9aa0a6;
        }

        .doc-part-btn:hover {
            border-color: #5f6368;
        }

        .doc-part-btn .material-icons-outlined {
            font-size: 18px;
        }

        /* Nekontrolováno - šedé zaškrtnutí */
        .doc-part-btn.ok.unchecked {
            background: #f1f3f4;
            border-color: #dadce0;
            color: #9aa0a6;
        }

        .doc-part-btn.ok.active {
            background: #137333;
            border-color: #137333;
            color: #fff;
        }

        .doc-part-btn.warning.active {
            background: #f57c00;
            border-color: #f57c00;
            color: #fff;
        }

        .doc-part-btn.error.active {
            background: #c5221f;
            border-color: #c5221f;
            color: #fff;
        }

        /* Sekce nedostatků podle částí dokumentace */
        .doc-part-item {
            display: flex;
            align-items: center;
        }
        
        .part-issues-section {
            background: #fef7f6;
            border: 1px solid #f5c6c5;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
        }
        
        .part-issues-header {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
            font-weight: 500;
            color: #c5221f;
            margin-bottom: 12px;
        }
        
        .part-issues-header .part-letter {
            width: 24px;
            height: 24px;
            background: #c5221f;
            color: #fff;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 600;
        }
        
        .part-issues-list {
            margin-bottom: 12px;
        }
        
        .part-issue-item {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            padding: 10px 12px;
            background: #fff;
            border: 1px solid #e8eaed;
            border-radius: 6px;
            margin-bottom: 8px;
        }
        
        .part-issue-item:last-child {
            margin-bottom: 0;
        }
        
        .part-issue-icon {
            width: 20px;
            height: 20px;
            background: #fce8e6;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            margin-top: 2px;
        }
        
        .part-issue-icon .material-icons-outlined {
            font-size: 12px;
            color: #c5221f;
        }
        
        .part-issue-content {
            flex: 1;
            font-size: 13px;
            color: #202124;
            line-height: 1.5;
        }
        
        .part-issue-remove {
            width: 24px;
            height: 24px;
            border: none;
            background: transparent;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #9aa0a6;
            transition: all 0.15s;
            flex-shrink: 0;
        }
        
        .part-issue-remove:hover {
            background: #fce8e6;
            color: #c5221f;
        }
        
        .part-issue-remove .material-icons-outlined {
            font-size: 16px;
        }
        
        .part-issues-add {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .part-issue-textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #dadce0;
            border-radius: 6px;
            font-size: 13px;
            font-family: inherit;
            background: #fff;
            color: #202124;
            resize: vertical;
            min-height: 70px;
            line-height: 1.5;
        }
        
        .part-issue-textarea:focus {
            outline: none;
            border-color: #c5221f;
            box-shadow: 0 0 0 2px rgba(197, 34, 31, 0.1);
        }
        
        .part-issue-textarea::placeholder {
            color: #9aa0a6;
        }
        
        .btn-add-part-issue {
            align-self: flex-start;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 14px;
            background: #fff;
            border: 1px solid #c5221f;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            color: #c5221f;
            cursor: pointer;
            transition: all 0.15s;
        }
        
        .btn-add-part-issue:hover {
            background: #fce8e6;
        }
        
        .btn-add-part-issue .material-icons-outlined {
            font-size: 18px;
        }
        
        /* Strukturovaný formulář pro nedostatky */
        .part-issues-add-structured {
            display: flex;
            flex-direction: column;
            gap: 6px;
            padding-top: 6px;
            border-top: 1px dashed #e0e0e0;
            margin-top: 4px;
        }
        
        .issue-form-row {
            display: flex;
            gap: 6px;
        }
        
        .issue-ref-input {
            padding: 7px 10px;
            border: 1px solid #dadce0;
            border-radius: 5px;
            font-size: 12px;
            font-family: 'Roboto Mono', monospace;
            color: #202124;
            background: #f8f9fa;
        }
        
        .issue-ref-input:focus {
            outline: none;
            border-color: #c5221f;
            background: #fff;
        }
        
        .issue-text-input, .issue-examples-input {
            flex: 1;
            padding: 7px 10px;
            border: 1px solid #dadce0;
            border-radius: 5px;
            font-size: 12px;
            font-family: inherit;
            color: #202124;
        }
        
        .issue-text-input:focus, .issue-examples-input:focus {
            outline: none;
            border-color: #c5221f;
            box-shadow: 0 0 0 1px rgba(197, 34, 31, 0.1);
        }
        
        .issue-text-input::placeholder, .issue-examples-input::placeholder, .issue-ref-input::placeholder {
            color: #9aa0a6;
            font-family: inherit;
        }
        
        .issue-examples-input {
            font-size: 11px;
            color: #5f6368;
            border-style: dashed;
        }
        
        .issue-form-actions {
            display: flex;
            justify-content: flex-end;
        }
        
        /* Rendered issue s referencí a příklady */
        .part-issue-item .issue-reference {
            display: inline-block;
            font-family: 'Roboto Mono', monospace;
            font-size: 11px;
            font-weight: 600;
            color: #5f6368;
            background: #f1f3f4;
            padding: 1px 5px;
            border-radius: 3px;
            margin-right: 4px;
        }
        
        .part-issue-item .issue-examples {
            display: block;
            font-size: 11px;
            color: #80868b;
            margin-top: 2px;
            font-style: italic;
        }
        
        /* Průřezové nedostatky — fialový motiv */
        #partIssuesCross {
            background: #f3e5f5;
            border-color: #ce93d8;
        }
        
        #partIssuesCross .part-issues-header {
            color: #6a1b9a;
        }
        
        .issues-empty {
            text-align: center;
            padding: 30px 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px dashed #dadce0;
        }
        
        /* Auto issues sekce - modrá varianta */
        #autoIssuesSection {
            background: #e8f4fd;
            border-color: #c2e0ff;
        }
        
        #autoIssuesSection .part-issues-header {
            color: #1a73e8;
        }
        
        #autoIssuesSection .part-issue-icon {
            background: #d2e3fc;
        }
        
        #autoIssuesSection .part-issue-icon .material-icons-outlined {
            color: #1a73e8;
        }

        /* Pozemky - rozšířené styly */
        .pozemky-section {
            margin-bottom: 20px;
        }

        .pozemky-section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }

        .pozemky-section-title {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            font-weight: 500;
            color: #202124;
        }

        .pozemky-section-title .material-icons-outlined {
            font-size: 18px;
            color: #004289;
        }

        .pozemky-section-badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
            background: #e8f1fa;
            color: #004289;
        }

        /* Metoda výběru sousedů */
        .neighbor-method-selector {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
        }

        .neighbor-method-btn {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            padding: 12px 8px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            background: #fff;
            cursor: pointer;
            transition: all 0.15s;
        }

        .neighbor-method-btn:hover {
            border-color: #004289;
            background: #f8fbff;
        }

        .neighbor-method-btn.active {
            border-color: #004289;
            background: #e8f1fa;
        }

        .neighbor-method-btn .material-icons-outlined {
            font-size: 24px;
            color: #5f6368;
        }

        .neighbor-method-btn.active .material-icons-outlined {
            color: #004289;
        }

        .neighbor-method-btn span:last-child {
            font-size: 11px;
            color: #5f6368;
            text-align: center;
        }

        .neighbor-method-btn.active span:last-child {
            color: #004289;
            font-weight: 500;
        }

        /* Polygon input */
        .polygon-input-section {
            display: none;
            padding: 16px;
            background: #f8f9fa;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            margin-bottom: 16px;
        }

        .polygon-input-section.visible {
            display: block;
        }

        .polygon-input-row {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .polygon-input-label {
            font-size: 13px;
            color: #202124;
            white-space: nowrap;
        }

        .polygon-input {
            width: 80px;
            padding: 8px 12px;
            border: 1px solid #dadce0;
            border-radius: 6px;
            font-size: 14px;
            text-align: center;
        }

        .polygon-input:focus {
            outline: none;
            border-color: #004289;
            box-shadow: 0 0 0 2px rgba(35, 98, 162, 0.2);
        }

        .polygon-input-unit {
            font-size: 13px;
            color: #5f6368;
        }

        .btn-generate-polygon {
            margin-left: auto;
            padding: 8px 16px;
            background: #004289;
            color: #fff;
            border: none;
            border-radius: 6px;
            font-size: 13px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .btn-generate-polygon:hover {
            background: #1a4a7a;
        }

        /* Ověření KN */
        .kn-verify-section {
            margin-top: 20px;
            padding: 16px;
            background: #f8f9fa;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
        }

        .kn-verify-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }

        .kn-verify-title {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            font-weight: 500;
            color: #202124;
        }

        .kn-verify-title .material-icons-outlined {
            font-size: 18px;
            color: #7c3aed;
        }

        .btn-verify-kn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 14px;
            background: linear-gradient(135deg, #7c3aed 0%, #5b21b6 100%);
            color: #fff;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
        }

        .btn-verify-kn:hover {
            background: linear-gradient(135deg, #6d28d9 0%, #4c1d95 100%);
        }

        .btn-verify-kn:disabled {
            background: #dadce0;
            cursor: not-allowed;
        }

        .kn-verify-results {
            display: none;
        }

        .kn-verify-results.visible {
            display: block;
        }

        /* Vlastníci z KN */
        .owner-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-height: 200px;
            overflow-y: auto;
        }

        .owner-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 12px;
            background: #fff;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
        }

        .owner-item.verified {
            border-color: #ceead6;
            background: #f0faf3;
        }

        .owner-item-icon {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #e8f1fa;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .owner-item-icon .material-icons-outlined {
            font-size: 18px;
            color: #004289;
        }

        .owner-item-content {
            flex: 1;
            min-width: 0;
        }

        .owner-item-name {
            font-size: 13px;
            font-weight: 500;
            color: #202124;
        }

        .owner-item-parcels {
            font-size: 11px;
            color: #5f6368;
        }

        .owner-item-relations {
            display: flex;
            gap: 6px;
            margin-top: 4px;
        }

        .owner-relation-badge {
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: 500;
        }

        .owner-relation-badge.vlastnik {
            background: #e8f1fa;
            color: #004289;
        }

        .owner-relation-badge.zastava {
            background: #fef7e0;
            color: #b06000;
        }

        .owner-relation-badge.vecne-bremeno {
            background: #fce8e6;
            color: #c5221f;
        }

        .owner-item-actions {
            display: flex;
            gap: 4px;
        }

        .owner-item-btn {
            width: 28px;
            height: 28px;
            border: none;
            background: transparent;
            border-radius: 4px;
            color: #5f6368;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .owner-item-btn:hover {
            background: rgba(0,0,0,0.08);
            color: #202124;
        }

        .owner-item-btn .material-icons-outlined {
            font-size: 18px;
        }

        /* Účastníci info */
        .ucastnici-info {
            margin-top: 16px;
            padding: 12px;
            background: #e6f4ea;
            border: 1px solid #ceead6;
            border-radius: 8px;
            display: none;
        }

        .ucastnici-info.visible {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .ucastnici-info .material-icons-outlined {
            font-size: 20px;
            color: #137333;
        }

        .ucastnici-info-text {
            font-size: 13px;
            color: #137333;
        }

        /* Parcel chip rozšířený */
        .parcel-chip-extended {
            display: flex;
            flex-direction: column;
            padding: 12px;
            background: #fff;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .parcel-chip-extended.verified {
            border-color: #ceead6;
            background: #f0faf3;
        }

        .parcel-chip-extended-header {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .parcel-chip-extended-info {
            flex: 1;
        }

        .parcel-chip-extended-number {
            font-size: 14px;
            font-weight: 500;
            color: #202124;
        }

        .parcel-chip-extended-katastr {
            font-size: 12px;
            color: #5f6368;
        }

        .parcel-chip-extended-owner {
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid #e0e0e0;
            font-size: 12px;
            color: #5f6368;
        }

        .parcel-chip-extended-owner strong {
            color: #202124;
        }

        /* Pozemky záměru - editovatelné */
        
        /* Přepínač zobrazení pozemků */
        .pozemky-view-toggle {
            display: inline-flex;
            align-items: center;
            gap: 2px;
            margin-left: 8px;
            background: #f1f3f4;
            border-radius: 4px;
            padding: 2px;
        }
        
        .pozemky-view-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 20px;
            border: none;
            background: transparent;
            border-radius: 3px;
            color: #5f6368;
            cursor: pointer;
            padding: 0;
        }
        
        .pozemky-view-btn:hover {
            background: #e0e0e0;
        }
        
        .pozemky-view-btn.active {
            background: #fff;
            color: #1a73e8;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        
        .pozemky-view-btn .material-icons-outlined {
            font-size: 16px;
        }
        
        /* Kompaktní chip prezentace pozemků */
        .pozemky-chips-container {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-bottom: 8px;
        }
        
        .pozemek-chip {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px 4px 10px;
            background: #f8f9fa;
            border: 1px solid #e0e0e0;
            border-radius: 16px;
            font-size: 12px;
            color: #202124;
            white-space: nowrap;
            transition: all 0.15s;
        }
        
        .pozemek-chip:hover {
            background: #fff;
            border-color: #dadce0;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .pozemek-chip.zamer {
            background: #e8f0fe;
            border-color: #c2d7f7;
        }
        
        .pozemek-chip.zamer:hover {
            background: #d2e3fc;
            border-color: #1a73e8;
        }
        
        .pozemek-chip.soused {
            background: #f1f3f4;
            border-color: #dadce0;
        }
        
        .pozemek-chip .chip-icon {
            font-size: 14px;
            color: #5f6368;
        }
        
        .pozemek-chip.zamer .chip-icon {
            color: #1a73e8;
        }
        
        .pozemek-chip .chip-parcela {
            font-weight: 500;
        }
        
        .pozemek-chip .chip-ku {
            font-size: 10px;
            color: #80868b;
            margin-left: 2px;
        }
        
        .pozemek-chip .chip-remove {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 16px;
            height: 16px;
            border: none;
            background: transparent;
            border-radius: 50%;
            color: #9aa0a6;
            cursor: pointer;
            padding: 0;
            margin-left: 2px;
        }
        
        .pozemek-chip .chip-remove:hover {
            background: rgba(0,0,0,0.08);
            color: #c5221f;
        }
        
        .pozemek-chip .chip-remove .material-icons-outlined {
            font-size: 14px;
        }
        
        /* Řádkové zobrazení pozemků */
        .pozemky-list-container {
            display: flex;
            flex-direction: column;
            gap: 0;
            margin-bottom: 8px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            overflow: hidden;
        }
        
        /* Hlavička tabulky s řazením */
        .pozemky-list-header {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 10px;
            background: #f8f9fa;
            font-size: 11px;
            font-weight: 500;
            color: #5f6368;
            border-bottom: 1px solid #e0e0e0;
            user-select: none;
        }
        
        .pozemky-list-header .header-col {
            display: flex;
            align-items: center;
            gap: 2px;
            cursor: pointer;
            padding: 2px 4px;
            border-radius: 3px;
            transition: background 0.15s;
        }
        
        .pozemky-list-header .header-col:hover {
            background: #e8e8e8;
        }
        
        .pozemky-list-header .header-col.active {
            color: #1a73e8;
            background: #e8f0fe;
        }
        
        .pozemky-list-header .header-col .sort-icon {
            font-size: 14px;
            opacity: 0.4;
        }
        
        .pozemky-list-header .header-col.active .sort-icon {
            opacity: 1;
        }
        
        .pozemky-list-header .header-col.asc .sort-icon {
            transform: rotate(180deg);
        }
        
        .pozemky-list-header .col-icon { width: 20px; }
        .pozemky-list-header .col-parcela { min-width: 70px; }
        .pozemky-list-header .col-katastr { min-width: 120px; }
        .pozemky-list-header .col-kod { min-width: 60px; }
        .pozemky-list-header .col-plocha { min-width: 70px; text-align: right; }
        .pozemky-list-header .col-actions { width: 20px; margin-left: auto; }
        
        .pozemek-row {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 10px;
            background: #fff;
            font-size: 12px;
            border-bottom: 1px solid #f1f3f4;
        }
        
        .pozemek-row:last-child {
            border-bottom: none;
        }
        
        .pozemek-row:hover {
            background: #f8f9fa;
        }
        
        .pozemek-row.zamer {
            background: #f8fbff;
        }
        
        .pozemek-row.zamer:hover {
            background: #eef5fc;
        }
        
        .pozemek-row .row-icon {
            font-size: 16px;
            color: #5f6368;
            width: 20px;
            text-align: center;
        }
        
        .pozemek-row.zamer .row-icon {
            color: #1a73e8;
        }
        
        .pozemek-row .row-parcela {
            font-weight: 600;
            min-width: 70px;
            color: #202124;
        }
        
        .pozemek-row .row-katastr {
            color: #5f6368;
            min-width: 120px;
        }
        
        .pozemek-row .row-kod {
            color: #9aa0a6;
            font-size: 11px;
            min-width: 60px;
        }
        
        .pozemek-row .row-plocha {
            color: #5f6368;
            min-width: 70px;
            text-align: right;
        }
        
        .pozemek-row .row-remove {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 20px;
            height: 20px;
            border: none;
            background: transparent;
            border-radius: 4px;
            color: #9aa0a6;
            cursor: pointer;
            padding: 0;
            margin-left: auto;
        }
        
        .pozemek-row .row-remove:hover {
            background: #fce8e6;
            color: #c5221f;
        }
        
        .pozemek-row .row-remove .material-icons-outlined {
            font-size: 16px;
        }
        }
        
        .parcel-chip-extended-header {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .parcel-chip-extended .parcel-chip-remove {
            width: 28px;
            height: 28px;
            border: none;
            background: transparent;
            border-radius: 4px;
            color: #9aa0a6;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-left: auto;
            flex-shrink: 0;
        }

        .parcel-chip-extended .parcel-chip-remove:hover {
            background: #fce8e6;
            color: #c5221f;
        }

        .parcel-chip-extended .parcel-chip-remove .material-icons-outlined {
            font-size: 18px;
        }

        /* ==========================================
           SESKUPENÉ ZOBRAZENÍ POZEMKŮ PODLE K.Ú.
           ========================================== */
        .pozemky-grouped-container {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 8px;
        }
        
        /* Vyhledávací panel */
        .pozemky-grouped-search {
            display: flex;
            gap: 8px;
            padding: 10px 12px;
            background: #f8f9fa;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .pozemky-search-field {
            position: relative;
            flex: 1;
        }
        
        .pozemky-search-field .material-icons-outlined {
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 18px;
            color: #9aa0a6;
            pointer-events: none;
        }
        
        .pozemky-search-input {
            width: 100%;
            padding: 7px 10px 7px 34px;
            border: 1px solid #dadce0;
            border-radius: 6px;
            font-size: 12px;
            background: #fff;
        }
        
        .pozemky-search-input:focus {
            outline: none;
            border-color: #1a73e8;
            box-shadow: 0 0 0 2px rgba(26, 115, 232, 0.1);
        }
        
        .pozemky-search-input::placeholder {
            color: #9aa0a6;
        }
        
        .pozemky-filter-select {
            min-width: 160px;
            padding: 7px 30px 7px 10px;
            border: 1px solid #dadce0;
            border-radius: 6px;
            font-size: 12px;
            background: #fff url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='%235f6368'%3E%3Cpath d='M7 10l5 5 5-5z'/%3E%3C/svg%3E") no-repeat right 8px center;
            appearance: none;
            cursor: pointer;
        }
        
        .pozemky-filter-select:focus {
            outline: none;
            border-color: #1a73e8;
        }
        
        /* Skupina k.ú. */
        .pozemky-ku-group {
            border-bottom: 1px solid #e0e0e0;
        }
        
        .pozemky-ku-group:last-child {
            border-bottom: none;
        }
        
        .pozemky-ku-group.hidden {
            display: none;
        }
        
        .pozemky-ku-header {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            background: #fff;
            cursor: pointer;
            user-select: none;
            transition: background 0.15s;
        }
        
        .pozemky-ku-header:hover {
            background: #f8f9fa;
        }
        
        .pozemky-ku-header.expanded {
            background: #e8f0fe;
            border-bottom: 1px solid #c2dbfc;
        }
        
        .pozemky-ku-expand {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: transform 0.2s, background 0.15s;
        }
        
        .pozemky-ku-header:hover .pozemky-ku-expand {
            background: #e0e0e0;
        }
        
        .pozemky-ku-header.expanded .pozemky-ku-expand {
            transform: rotate(90deg);
            background: #c2dbfc;
        }
        
        .pozemky-ku-expand .material-icons-outlined {
            font-size: 20px;
            color: #5f6368;
        }
        
        .pozemky-ku-info {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .pozemky-ku-name {
            font-size: 13px;
            font-weight: 600;
            color: #202124;
        }
        
        .pozemky-ku-code {
            font-size: 11px;
            color: #9aa0a6;
        }
        
        .pozemky-ku-count {
            padding: 2px 8px;
            background: #e8eaed;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 600;
            color: #5f6368;
        }
        
        .pozemky-ku-header.expanded .pozemky-ku-count {
            background: #1a73e8;
            color: #fff;
        }
        
        /* Seznam pozemků ve skupině */
        .pozemky-ku-content {
            display: none;
            background: #fafbfc;
        }
        
        .pozemky-ku-group.expanded .pozemky-ku-content {
            display: block;
        }
        
        .pozemky-ku-list {
            padding: 0;
        }
        
        .pozemky-ku-row {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px 8px 46px;
            border-bottom: 1px solid #f0f0f0;
            font-size: 12px;
            transition: background 0.15s;
        }
        
        .pozemky-ku-row:last-child {
            border-bottom: none;
        }
        
        .pozemky-ku-row:hover {
            background: #f0f4f9;
        }
        
        .pozemky-ku-row.highlighted {
            background: #fff8e1;
            animation: highlightPulse 1s ease;
        }
        
        @keyframes highlightPulse {
            0%, 100% { background: #fff8e1; }
            50% { background: #fff3c4; }
        }
        
        .pozemky-ku-row.hidden {
            display: none;
        }
        
        .pozemky-ku-row .row-icon {
            font-size: 16px;
            color: #5f6368;
            width: 20px;
            text-align: center;
        }
        
        .pozemky-ku-row.zamer .row-icon {
            color: #1a73e8;
        }
        
        .pozemky-ku-row .row-parcela {
            font-weight: 600;
            min-width: 80px;
            color: #202124;
        }
        
        .pozemky-ku-row .row-typ {
            color: #5f6368;
            min-width: 100px;
        }
        
        .pozemky-ku-row .row-plocha {
            color: #5f6368;
            min-width: 70px;
            text-align: right;
        }
        
        .pozemky-ku-row .row-remove {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
            border: none;
            background: transparent;
            border-radius: 4px;
            color: #9aa0a6;
            cursor: pointer;
            padding: 0;
            margin-left: auto;
        }
        
        .pozemky-ku-row .row-remove:hover {
            background: #fce8e6;
            color: #c5221f;
        }
        
        .pozemky-ku-row .row-remove .material-icons-outlined {
            font-size: 16px;
        }
        
        /* Prázdný stav vyhledávání */
        .pozemky-no-results {
            padding: 24px;
            text-align: center;
            color: #5f6368;
            font-size: 13px;
        }
        
        .pozemky-no-results .material-icons-outlined {
            font-size: 32px;
            color: #9aa0a6;
            display: block;
            margin-bottom: 8px;
        }

        /* ==========================================
           INTERAKTIVNÍ KATASTRÁLNÍ MAPA
           ========================================== */
        .katastr-map-container {
            display: flex;
            flex-direction: column;
            height: 100%;
            background: #f5f7f5;
        }
        
        /* Horní panel s ovládáním */
        .katastr-map-toolbar {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 14px;
            background: #fff;
            border-bottom: 1px solid #e0e0e0;
            flex-shrink: 0;
        }
        
        .katastr-map-title {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
            font-weight: 600;
            color: #202124;
        }
        
        .katastr-map-title .material-icons-outlined {
            font-size: 18px;
            color: #1a73e8;
        }
        
        .katastr-map-zoom {
            display: flex;
            align-items: center;
            gap: 4px;
            margin-left: auto;
        }
        
        .katastr-zoom-btn {
            width: 28px;
            height: 28px;
            border: 1px solid #dadce0;
            background: #fff;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s;
        }
        
        .katastr-zoom-btn:hover {
            background: #f1f3f4;
            border-color: #1a73e8;
        }
        
        .katastr-zoom-btn .material-icons-outlined {
            font-size: 18px;
            color: #5f6368;
        }
        
        .katastr-zoom-level {
            font-size: 11px;
            color: #5f6368;
            min-width: 40px;
            text-align: center;
        }
        
        .katastr-layers-btn {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 5px 10px;
            border: 1px solid #dadce0;
            background: #fff;
            border-radius: 4px;
            font-size: 11px;
            color: #5f6368;
            cursor: pointer;
            transition: all 0.15s;
        }
        
        .katastr-layers-btn:hover {
            background: #f1f3f4;
        }
        
        .katastr-layers-btn .material-icons-outlined {
            font-size: 16px;
        }
        
        /* Hlavní oblast mapy */
        .katastr-map-viewport {
            flex: 1;
            position: relative;
            overflow: hidden;
            cursor: grab;
        }
        
        .katastr-map-viewport:active {
            cursor: grabbing;
        }
        
        .katastr-map-svg {
            width: 100%;
            height: 100%;
            display: block;
        }
        
        /* Styly pro parcely */
        .parcela-polygon {
            stroke: #5f6368;
            stroke-width: 1;
            cursor: pointer;
            transition: all 0.15s;
        }
        
        /* Typy parcel */
        .parcela-polygon.typ-ornapuda {
            fill: #f5e6c8;
        }
        
        .parcela-polygon.typ-travni {
            fill: #c8e6c9;
        }
        
        .parcela-polygon.typ-zastavena {
            fill: #ffcdd2;
        }
        
        .parcela-polygon.typ-les {
            fill: #a5d6a7;
        }
        
        .parcela-polygon.typ-voda {
            fill: #b3e5fc;
        }
        
        .parcela-polygon.typ-zahrada {
            fill: #dcedc8;
        }
        
        .parcela-polygon.typ-ostatni {
            fill: #e0e0e0;
        }
        
        /* Hover efekt */
        .parcela-polygon:hover {
            stroke: #1a73e8;
            stroke-width: 2;
            filter: brightness(1.05);
        }
        
        /* Vybraná parcela */
        .parcela-polygon.selected {
            stroke: #f9a825;
            stroke-width: 3;
            filter: brightness(1.1);
        }
        
        /* Pozemky záměru */
        .parcela-polygon.zamer {
            stroke: #1a73e8;
            stroke-width: 2;
            stroke-dasharray: none;
        }
        
        .parcela-polygon.zamer::after {
            content: '';
        }
        
        /* Sousední pozemky */
        .parcela-polygon.soused {
            stroke: #34a853;
            stroke-width: 2;
        }
        
        /* Budovy */
        .budova-polygon {
            fill: #795548;
            stroke: #5d4037;
            stroke-width: 1;
            cursor: pointer;
        }
        
        .budova-polygon:hover {
            fill: #8d6e63;
        }
        
        /* Čísla parcel */
        .parcela-label {
            font-size: 10px;
            font-family: Arial, sans-serif;
            fill: #37474f;
            pointer-events: none;
            text-anchor: middle;
            dominant-baseline: middle;
            font-weight: 500;
        }
        
        .parcela-label.large {
            font-size: 12px;
        }
        
        .parcela-label.stavebni {
            font-size: 9px;
            fill: #5d4037;
        }
        
        /* Hranice k.ú. */
        .ku-boundary {
            fill: none;
            stroke: #e91e63;
            stroke-width: 2;
            stroke-dasharray: 8 4;
            pointer-events: none;
        }
        
        /* Cesty */
        .cesta-line {
            fill: none;
            stroke: #9e9e9e;
            stroke-width: 6;
        }
        
        .cesta-line.hlavni {
            stroke: #ffc107;
            stroke-width: 8;
        }
        
        /* Mini mapa v rohu */
        .katastr-minimap {
            position: absolute;
            bottom: 12px;
            left: 12px;
            width: 120px;
            height: 90px;
            background: #fff;
            border: 1px solid #dadce0;
            border-radius: 6px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            overflow: hidden;
        }
        
        .katastr-minimap svg {
            width: 100%;
            height: 100%;
        }
        
        .minimap-viewport {
            fill: rgba(26, 115, 232, 0.2);
            stroke: #1a73e8;
            stroke-width: 2;
        }
        
        /* Měřítko */
        .katastr-scale {
            position: absolute;
            bottom: 12px;
            right: 12px;
            background: rgba(255,255,255,0.9);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 10px;
            color: #5f6368;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .katastr-scale-bar {
            width: 50px;
            height: 4px;
            background: linear-gradient(to right, #202124 50%, transparent 50%);
            background-size: 10px 4px;
            border: 1px solid #202124;
        }
        
        /* Legenda */
        .katastr-legend {
            position: absolute;
            top: 12px;
            left: 12px;
            background: rgba(255,255,255,0.95);
            border: 1px solid #dadce0;
            border-radius: 6px;
            padding: 8px 10px;
            font-size: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .katastr-legend-title {
            font-weight: 600;
            margin-bottom: 6px;
            color: #202124;
        }
        
        .katastr-legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 3px;
        }
        
        .katastr-legend-color {
            width: 14px;
            height: 10px;
            border-radius: 2px;
            border: 1px solid rgba(0,0,0,0.2);
        }
        
        /* Info panel vybrané parcely */
        .katastr-info-panel {
            position: absolute;
            bottom: 12px;
            left: 50%;
            transform: translateX(-50%);
            background: #fff;
            border: 1px solid #dadce0;
            border-radius: 8px;
            padding: 12px 16px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: none;
            min-width: 280px;
        }
        
        .katastr-info-panel.visible {
            display: block;
        }
        
        .katastr-info-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
        }
        
        .katastr-info-parcela {
            font-size: 16px;
            font-weight: 700;
            color: #202124;
        }
        
        .katastr-info-close {
            width: 24px;
            height: 24px;
            border: none;
            background: transparent;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .katastr-info-close:hover {
            background: #f1f3f4;
        }
        
        .katastr-info-close .material-icons-outlined {
            font-size: 18px;
            color: #5f6368;
        }
        
        .katastr-info-details {
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 4px 12px;
            font-size: 12px;
            margin-bottom: 10px;
        }
        
        .katastr-info-label {
            color: #5f6368;
        }
        
        .katastr-info-value {
            color: #202124;
            font-weight: 500;
        }
        
        .katastr-info-actions {
            display: flex;
            gap: 8px;
        }
        
        .katastr-info-btn {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #dadce0;
            border-radius: 6px;
            background: #fff;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            transition: all 0.15s;
        }
        
        .katastr-info-btn:hover {
            background: #f1f3f4;
        }
        
        .katastr-info-btn.primary {
            background: #1a73e8;
            border-color: #1a73e8;
            color: #fff;
        }
        
        .katastr-info-btn.primary:hover {
            background: #1557b0;
        }
        
        .katastr-info-btn .material-icons-outlined {
            font-size: 16px;
        }
        
        /* Tooltip při hoveru */
        .katastr-tooltip {
            position: absolute;
            background: rgba(32, 33, 36, 0.9);
            color: #fff;
            padding: 6px 10px;
            border-radius: 4px;
            font-size: 11px;
            pointer-events: none;
            z-index: 100;
            white-space: nowrap;
            display: none;
        }
        
        .katastr-tooltip.visible {
            display: block;
        }
        
        /* Vyhledávání k.ú. */
        .katastr-search-container {
            position: relative;
            display: flex;
            align-items: center;
            background: #f1f3f4;
            border-radius: 6px;
            padding: 0 10px;
            flex: 1;
            max-width: 280px;
        }
        
        .katastr-search-container > .material-icons-outlined {
            font-size: 18px;
            color: #5f6368;
        }
        
        .katastr-search-input {
            border: none;
            background: transparent;
            padding: 7px 10px;
            font-size: 12px;
            width: 100%;
            outline: none;
        }
        
        .katastr-search-input::placeholder {
            color: #9aa0a6;
        }
        
        .katastr-search-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            margin-top: 4px;
            background: #fff;
            border: 1px solid #dadce0;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 200;
            display: none;
            max-height: 280px;
            overflow-y: auto;
        }
        
        .katastr-search-dropdown.visible {
            display: block;
        }
        
        .katastr-search-group {
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .katastr-search-group:last-child {
            border-bottom: none;
        }
        
        .katastr-search-group-title {
            padding: 4px 12px;
            font-size: 10px;
            font-weight: 600;
            color: #9aa0a6;
            text-transform: uppercase;
        }
        
        .katastr-search-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            cursor: pointer;
            font-size: 12px;
            color: #202124;
        }
        
        .katastr-search-item:hover {
            background: #f1f3f4;
        }
        
        .katastr-search-item .material-icons-outlined {
            font-size: 16px;
            color: #5f6368;
        }
        
        /* Toolbar separator a nástroje */
        .katastr-tools-separator {
            width: 1px;
            height: 24px;
            background: #dadce0;
            margin: 0 4px;
        }
        
        .katastr-tool-btn {
            width: 32px;
            height: 32px;
            border: 1px solid #dadce0;
            background: #fff;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s;
        }
        
        .katastr-tool-btn:hover {
            background: #f1f3f4;
            border-color: #1a73e8;
        }
        
        .katastr-tool-btn.active {
            background: #e8f0fe;
            border-color: #1a73e8;
            color: #1a73e8;
        }
        
        .katastr-tool-btn .material-icons-outlined {
            font-size: 18px;
            color: inherit;
        }
        
        /* Polygon selection banner */
        .katastr-polygon-banner {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 14px;
            background: #e8f0fe;
            border-bottom: 1px solid #c2dbfc;
            font-size: 12px;
            color: #1a73e8;
        }
        
        .katastr-polygon-banner .material-icons-outlined {
            font-size: 18px;
        }
        
        .katastr-polygon-banner button {
            margin-left: auto;
            padding: 4px 12px;
            border: 1px solid #1a73e8;
            background: #fff;
            border-radius: 4px;
            font-size: 11px;
            color: #1a73e8;
            cursor: pointer;
        }
        
        .katastr-polygon-banner button:hover {
            background: #fff;
            border-color: #1557b0;
            color: #1557b0;
        }
        
        /* Polygon selection SVG */
        .selection-polygon {
            fill: rgba(26, 115, 232, 0.1);
            stroke: #1a73e8;
            stroke-width: 2;
            stroke-dasharray: 5 3;
        }
        
        .selection-point {
            fill: #1a73e8;
            stroke: #fff;
            stroke-width: 2;
            cursor: pointer;
        }
        
        .selection-line {
            stroke: #1a73e8;
            stroke-width: 2;
            stroke-dasharray: 5 3;
            fill: none;
        }
        
        /* VÝRAZNĚJŠÍ OZNAČENÍ POZEMKŮ ZÁMĚRU A SOUSEDNÍCH */
        
        /* Pozemky záměru - modrý šrafovaný vzor + silné ohraničení */
        .parcela-polygon.zamer {
            stroke: #1565c0 !important;
            stroke-width: 3 !important;
            filter: none;
        }
        
        .parcela-overlay-zamer {
            fill: url(#zamerPattern);
            stroke: none;
            pointer-events: none;
        }
        
        /* Sousední pozemky - zelený tečkovaný vzor + silné ohraničení */
        .parcela-polygon.soused {
            stroke: #2e7d32 !important;
            stroke-width: 3 !important;
            stroke-dasharray: 6 3;
            filter: none;
        }
        
        .parcela-overlay-soused {
            fill: url(#sousedPattern);
            stroke: none;
            pointer-events: none;
        }
        
        /* Info panel - tlačítko pro odstranění */
        .katastr-info-btn.danger {
            background: #fff;
            border-color: #ea4335;
            color: #ea4335;
        }
        
        .katastr-info-btn.danger:hover {
            background: #fce8e6;
        }
        
        .katastr-info-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* Výběrová tabulka pro polygon selection */
        .katastr-selection-panel {
            position: absolute;
            bottom: 12px;
            left: 50%;
            transform: translateX(-50%);
            background: #fff;
            border: 1px solid #dadce0;
            border-radius: 8px;
            padding: 12px 16px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: none;
            min-width: 300px;
        }
        
        .katastr-selection-panel.visible {
            display: block;
        }
        
        .katastr-selection-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        
        .katastr-selection-title {
            font-size: 14px;
            font-weight: 600;
            color: #202124;
        }
        
        .katastr-selection-count {
            font-size: 12px;
            color: #5f6368;
        }
        
        .katastr-selection-list {
            max-height: 120px;
            overflow-y: auto;
            margin-bottom: 10px;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
        }
        
        .katastr-selection-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 10px;
            font-size: 12px;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .katastr-selection-item:last-child {
            border-bottom: none;
        }
        
        .katastr-selection-actions {
            display: flex;
            gap: 8px;
        }

        /* ==========================================
           KONTROLA SOULADU S ÚPD - ULTRA KOMPAKTNÍ
           ========================================== */
        
        /* Layout switch */
        .upd-layout-switch {
            display: flex;
            gap: 2px;
            background: #f1f3f4;
            padding: 2px;
            border-radius: 4px;
        }
        
        .upd-layout-btn {
            width: 32px;
            height: 28px;
            border: none;
            background: transparent;
            border-radius: 3px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #5f6368;
        }
        
        .upd-layout-btn:hover {
            background: #e0e0e0;
        }
        
        .upd-layout-btn.active {
            background: #fff;
            color: #1a73e8;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        
        .upd-layout-btn .material-icons-outlined {
            font-size: 18px;
        }
        
        /* Control body layouts */
        #controlUP .control-body {
            display: flex;
            flex-direction: row;
        }
        
        #controlUP.layout-horizontal .control-body {
            flex-direction: column;
        }
        
        /* Vertical layout (default) - panels stacked, control on right */
        .upd-viewers-stack {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 1px;
            background: #ccc;
            min-width: 0;
        }
        
        /* Horizontal layout - panels side by side, control on bottom right */
        #controlUP.layout-horizontal .upd-viewers-stack {
            flex-direction: row;
        }
        
        .upd-viewers-stack {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 1px;
            background: #ccc;
            min-width: 0;
        }
        
        .upd-viewer-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #fff;
            min-height: 0;
        }
        
        .upd-viewer-toolbar {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px;
            background: #f5f5f5;
            border-bottom: 1px solid #e0e0e0;
            flex-shrink: 0;
        }
        
        .upd-viewer-tabs {
            display: flex;
            gap: 2px;
        }
        
        .upd-vtab {
            padding: 3px 8px;
            border: 1px solid #dadce0;
            background: #fff;
            border-radius: 3px;
            font-size: 11px;
            font-weight: 500;
            color: #5f6368;
            cursor: pointer;
        }
        
        .upd-vtab:hover { background: #f1f3f4; }
        .upd-vtab.active { background: #1a73e8; border-color: #1a73e8; color: #fff; }
        
        .upd-viewer-btn {
            margin-left: auto;
            width: 24px;
            height: 24px;
            border: none;
            background: transparent;
            border-radius: 3px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #5f6368;
        }
        
        .upd-viewer-btn:hover { background: #e0e0e0; }
        .upd-viewer-btn .material-icons-outlined { font-size: 16px; }
        
        .upd-viewer-content {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f0f0f0;
            overflow: hidden;
            position: relative;
        }
        
        /* Image container pro zoom/pan */
        .upd-image-container {
            width: 100%;
            height: 100%;
            overflow: hidden;
            cursor: grab;
            position: relative;
        }
        
        .upd-image-container:active {
            cursor: grabbing;
        }
        
        .upd-image-container img {
            position: absolute;
            transform-origin: 0 0;
            max-width: none;
            user-select: none;
            -webkit-user-drag: none;
            opacity: 0;
            transition: opacity 0.2s;
        }
        
        .upd-image-container img.loaded {
            opacity: 1;
        }
        
        /* Zoom controls */
        .upd-zoom-controls {
            display: flex;
            gap: 2px;
            margin-left: auto;
        }
        
        .upd-zoom-btn {
            width: 24px;
            height: 24px;
            border: 1px solid #dadce0;
            background: #fff;
            border-radius: 3px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            color: #5f6368;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .upd-zoom-btn:hover {
            background: #f1f3f4;
        }
        
        /* Iframe fallback */
        .upd-iframe-fallback {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 8px;
            background: #f5f5f5;
            color: #9aa0a6;
        }
        
        .upd-iframe-fallback .material-icons-outlined {
            font-size: 40px;
        }
        
        .upd-viewer-placeholder {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            color: #bbb;
        }
        
        .upd-viewer-placeholder .material-icons-outlined { font-size: 48px; }
        
        .upd-link {
            padding: 4px 10px;
            background: #fff;
            border: 1px solid #dadce0;
            border-radius: 3px;
            font-size: 11px;
            color: #1a73e8;
            text-decoration: none;
        }
        
        .upd-link:hover { background: #e8f0fe; }
        
        /* Pravý panel - vertikální layout */
        .upd-control-panel {
            width: 150px;
            flex-shrink: 0;
            background: #f8f9fa;
            border-left: 1px solid #e0e0e0;
            padding: 8px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            overflow-y: auto;
        }
        
        .upd-check-item {
            background: #fff;
            border-radius: 4px;
            padding: 8px;
            border: 1px solid #e0e0e0;
        }
        
        .upd-check-item.done-ok { background: #e6f4ea; border-color: #34a853; }
        .upd-check-item.done-error { background: #fce8e6; border-color: #ea4335; }
        
        .upd-check-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 6px;
        }
        
        .upd-check-label {
            font-size: 12px;
            font-weight: 600;
            color: #202124;
        }
        
        .upd-check-status {
            font-size: 14px;
            font-weight: 600;
        }
        
        .upd-check-status.ok { color: #137333; }
        .upd-check-status.error { color: #c5221f; }
        
        .upd-check-mini-label {
            font-size: 10px;
            color: #5f6368;
            margin: 6px 0 4px;
        }
        
        .upd-check-buttons {
            display: flex;
            gap: 6px;
        }
        
        .upd-btn-yes, .upd-btn-no {
            flex: 1;
            padding: 6px;
            border: 1px solid #dadce0;
            background: #fff;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
        }
        
        .upd-btn-yes:hover { background: #e6f4ea; border-color: #34a853; }
        .upd-btn-no:hover { background: #fce8e6; border-color: #ea4335; }
        .upd-btn-yes.selected { background: #34a853; border-color: #34a853; color: #fff; }
        .upd-btn-no.selected { background: #ea4335; border-color: #ea4335; color: #fff; }
        
        .upd-note-input {
            width: 100%;
            margin-top: 8px;
            padding: 8px;
            border: 1px solid #f5c6c5;
            border-radius: 4px;
            font-size: 11px;
            font-family: inherit;
            resize: vertical;
            min-height: 60px;
            background: #fff;
        }
        
        .upd-note-input:focus { outline: none; border-color: #ea4335; }
        
        .upd-no-up-info {
            margin-top: 6px;
            padding: 4px 8px;
            background: #fff8e1;
            border-radius: 3px;
            font-size: 10px;
            color: #e65100;
            text-align: center;
        }
        
        /* Horizontální layout - kontroly dole */
        #controlUP.layout-horizontal .upd-control-panel {
            width: 100%;
            height: 56px;
            flex-direction: row;
            align-items: center;
            justify-content: flex-end;
            border-left: none;
            border-top: 1px solid #e0e0e0;
            padding: 8px 16px;
            gap: 20px;
            overflow-x: auto;
            overflow-y: hidden;
            flex-shrink: 0;
        }
        
        #controlUP.layout-horizontal .upd-check-item {
            display: flex;
            flex-direction: row;
            align-items: center;
            gap: 10px;
            min-width: auto;
            max-width: none;
            padding: 6px 12px;
        }
        
        #controlUP.layout-horizontal .upd-check-row {
            margin-bottom: 0;
        }
        
        #controlUP.layout-horizontal .upd-check-buttons {
            gap: 4px;
        }
        
        #controlUP.layout-horizontal .upd-btn-yes,
        #controlUP.layout-horizontal .upd-btn-no {
            padding: 4px 8px;
            min-width: 32px;
        }
        
        #controlUP.layout-horizontal .upd-check-mini-label {
            margin: 0;
            white-space: nowrap;
        }
        
        /* ÚP kontrola v horizontálním layoutu */
        #controlUP.layout-horizontal .upd-check-item#checkUp > #upSouladSection {
            display: none;
            flex-direction: row;
            align-items: center;
            gap: 8px;
        }
        
        #controlUP.layout-horizontal .upd-check-item#checkUp > #upSouladSection[style*="block"] {
            display: flex !important;
        }
        
        #controlUP.layout-horizontal .upd-check-item#checkUp > .upd-no-up-info {
            margin-top: 0;
            white-space: nowrap;
        }
        
        /* Skrýt textarea v horizontálním layoutu - používáme modal */
        #controlUP.layout-horizontal .upd-note-input {
            display: none !important;
        }
        
        /* Indikátor nesouladu - malá ikonka */
        .upd-nesoulad-indicator {
            display: none;
            width: 22px;
            height: 22px;
            background: #ea4335;
            border-radius: 4px;
            color: #fff;
            font-size: 12px;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            margin-left: 4px;
            flex-shrink: 0;
        }
        
        .upd-nesoulad-indicator:hover {
            background: #c5221f;
        }
        
        .upd-nesoulad-indicator.visible {
            display: flex;
        }
        
        /* Modální dialog pro nesoulad */
        .upd-nesoulad-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 10000;
            align-items: center;
            justify-content: center;
        }
        
        .upd-nesoulad-modal.open {
            display: flex;
        }
        
        .upd-nesoulad-modal-content {
            background: #fff;
            border-radius: 8px;
            width: 500px;
            max-width: 90%;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        }
        
        .upd-nesoulad-modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 20px;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .upd-nesoulad-modal-title {
            font-size: 16px;
            font-weight: 600;
            color: #c5221f;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .upd-nesoulad-modal-close {
            width: 32px;
            height: 32px;
            border: none;
            background: transparent;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #5f6368;
        }
        
        .upd-nesoulad-modal-close:hover {
            background: #f1f3f4;
        }
        
        .upd-nesoulad-modal-body {
            padding: 20px;
        }
        
        .upd-nesoulad-modal-body label {
            display: block;
            font-size: 13px;
            font-weight: 500;
            color: #202124;
            margin-bottom: 8px;
        }
        
        .upd-nesoulad-modal-textarea {
            width: 100%;
            min-height: 150px;
            padding: 12px;
            border: 1px solid #dadce0;
            border-radius: 6px;
            font-size: 14px;
            font-family: inherit;
            resize: vertical;
            line-height: 1.5;
        }
        
        .upd-nesoulad-modal-textarea:focus {
            outline: none;
            border-color: #1a73e8;
            box-shadow: 0 0 0 2px rgba(26,115,232,0.2);
        }
        
        .upd-nesoulad-modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            padding: 16px 20px;
            border-top: 1px solid #e0e0e0;
        }
        
        .btn-sm {
            padding: 4px 10px !important;
            font-size: 11px !important;
        }
        
        .btn-sm .material-icons-outlined {
            font-size: 14px !important;
        }

        .pozemky-add-section {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px dashed #e0e0e0;
        }

        .pozemky-add-row {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .pozemky-add-input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #dadce0;
            border-radius: 6px;
            font-size: 13px;
            outline: none;
        }

        .pozemky-add-input:focus {
            border-color: #1a73e8;
            box-shadow: 0 0 0 2px rgba(26, 115, 232, 0.2);
        }

        .pozemky-add-input::placeholder {
            color: #9aa0a6;
        }

        .btn-add-pozemek {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            padding: 8px 14px;
            background: #fff;
            border: 1px solid #dadce0;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            color: #5f6368;
            cursor: pointer;
            transition: all 0.15s;
        }

        .btn-add-pozemek:hover {
            background: #e8f1fa;
            border-color: #004289;
            color: #004289;
        }

        .btn-add-pozemek .material-icons-outlined {
            font-size: 16px;
        }

        .pozemky-empty-note {
            padding: 16px;
            background: #fff8e1;
            border: 1px solid #ffe082;
            border-radius: 8px;
            font-size: 12px;
            color: #e65100;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .pozemky-empty-note .material-icons-outlined {
            font-size: 18px;
        }

        .auto-check-results {
            display: none;
        }

        .auto-check-results.visible {
            display: block;
        }

        .check-result-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 0;
            border-bottom: 1px solid #e0e0e0;
        }

        .check-result-item:last-child {
            border-bottom: none;
            padding-bottom: 0;
        }

        .check-result-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .check-result-icon .material-icons-outlined {
            font-size: 16px;
        }

        .check-result-icon.success {
            background: #e6f4ea;
            color: #137333;
        }

        .check-result-icon.warning {
            background: #fef7e0;
            color: #f57c00;
        }

        .check-result-icon.error {
            background: #fce8e6;
            color: #c5221f;
        }

        .check-result-content {
            flex: 1;
        }

        .check-result-label {
            font-size: 13px !important;
            color: #202124 !important;
            font-style: normal !important;
        }

        .check-result-detail {
            font-size: 11px !important;
            color: #5f6368 !important;
            font-style: normal !important;
        }

        .check-result-action {
            font-size: 12px !important;
            color: #004289 !important;
            cursor: pointer;
            font-style: normal !important;
        }

        .check-result-action:hover {
            text-decoration: underline;
        }

        /* Seznam nedostatků */
        .issues-section {
            margin-top: 20px;
            padding: 16px;
            background: #fff8e1;
            border: 1px solid #ffe082;
            border-radius: 8px;
            display: block;
        }

        .issues-section.visible {
            display: block;
        }

        .issues-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }

        .issues-title {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px !important;
            font-weight: 500 !important;
            color: #e65100 !important;
            font-style: normal !important;
        }

        .issues-title .material-icons-outlined {
            font-size: 18px;
        }

        .issues-count {
            padding: 4px 10px;
            background: #ff6d00;
            color: #fff;
            border-radius: 12px;
            font-size: 11px !important;
            font-weight: 600 !important;
        }

        .issues-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 12px;
        }

        .issue-item {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            padding: 10px 12px;
            background: #fff;
            border: 1px solid #ffe082;
            border-radius: 6px;
        }

        .issue-item-icon {
            width: 24px;
            height: 24px;
            background: #ff6d00;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .issue-item-icon .material-icons-outlined {
            font-size: 14px;
            color: #fff;
        }

        .issue-item-content {
            flex: 1;
        }

        .issue-item-doc {
            font-size: 12px !important;
            font-weight: 500 !important;
            color: #e65100 !important;
            font-style: normal !important;
        }

        .issue-item-text {
            font-size: 13px !important;
            color: #202124 !important;
            font-style: normal !important;
            margin-top: 2px;
        }

        .issue-item-remove {
            width: 24px;
            height: 24px;
            border: none;
            background: transparent;
            border-radius: 4px;
            color: #9aa0a6;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .issue-item-remove:hover {
            background: #ffecb3;
            color: #e65100;
        }

        .issue-item-remove .material-icons-outlined {
            font-size: 18px;
        }

        /* Přidat nedostatek */
        .add-issue-row {
            display: flex;
            gap: 8px;
        }

        .add-issue-section {
            margin-top: 12px;
        }

        .add-issue-type-toggle {
            display: flex;
            gap: 4px;
            margin-bottom: 8px;
        }

        .issue-type-btn {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 6px 12px;
            background: #fff;
            color: #5f6368;
            border: 1px solid #dadce0;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.15s;
        }

        .issue-type-btn:hover {
            background: #f8f9fa;
            border-color: #5f6368;
        }

        .issue-type-btn.active {
            background: #e8f1fa;
            border-color: #004289;
            color: #004289;
        }

        .issue-type-btn .material-icons-outlined {
            font-size: 16px;
        }

        .add-issue-textarea-row {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .add-issue-textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #dadce0;
            border-radius: 6px;
            font-size: 13px;
            font-family: inherit;
            resize: vertical;
            min-height: 80px;
        }

        .add-issue-textarea:focus {
            outline: none;
            border-color: #f57c00;
            box-shadow: 0 0 0 2px rgba(245, 124, 0, 0.2);
        }

        .btn-add-issue-full {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            padding: 10px 16px;
            background: #ff6d00;
            color: #fff;
            border: none;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            align-self: flex-end;
        }

        .btn-add-issue-full:hover {
            background: #e65100;
        }

        .btn-add-issue-full .material-icons-outlined {
            font-size: 18px;
        }

        .add-issue-select {
            width: 180px;
            padding: 8px 12px;
            border: 1px solid #dadce0;
            border-radius: 6px;
            font-size: 13px !important;
            background: #fff;
            font-style: normal !important;
        }

        .add-issue-input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #dadce0;
            border-radius: 6px;
            font-size: 13px !important;
            font-style: normal !important;
        }

        .add-issue-input:focus,
        .add-issue-select:focus {
            outline: none;
            border-color: #f57c00;
            box-shadow: 0 0 0 2px rgba(245, 124, 0, 0.2);
        }

        .btn-add-issue {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 8px 14px;
            background: #ff6d00;
            color: #fff !important;
            border: none;
            border-radius: 6px;
            font-size: 12px !important;
            font-weight: 500 !important;
            cursor: pointer;
            font-style: normal !important;
        }

        .btn-add-issue:hover {
            background: #e65100;
        }

        .btn-add-issue .material-icons-outlined {
            font-size: 16px;
        }

        /* Loading animace pro automatickou kontrolu */
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .btn-run-check.loading .material-icons-outlined {
            animation: spin 1s linear infinite;
        }

        /* Control fullscreen overlay */
        .control-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #fff;
            z-index: 1500;
            display: none;
            flex-direction: column;
        }

        .control-overlay.open {
            display: flex;
        }

        .control-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 24px;
            background: #fff;
            border-bottom: 1px solid #e0e0e0;
            flex-shrink: 0;
            position: relative;
        }

        .control-header-left {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        
        .control-header-center {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            align-items: center;
        }

        .control-close {
            width: 40px;
            height: 40px;
            border: none;
            background: transparent;
            color: #5f6368;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .control-close:hover {
            background: #f1f3f4;
        }

        .control-title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 16px !important;
            font-weight: 500 !important;
            color: #202124 !important;
            font-style: normal !important;
        }

        .control-title .material-icons-outlined {
            font-size: 24px;
            color: #004289;
        }

        .control-body {
            flex: 1;
            display: flex;
            overflow: hidden;
            min-height: 0;
        }

        /* Left panel - document viewer */
        .control-viewer {
            flex: 0 0 60%;
            display: flex;
            flex-direction: column;
            border-right: 1px solid #e0e0e0;
            background: #f5f5f5;
        }

        .viewer-tabs {
            display: flex;
            gap: 4px;
            padding: 12px 16px;
            background: #fff;
            border-bottom: 1px solid #e0e0e0;
            flex-shrink: 0;
            align-items: center;
        }
        
        .viewer-tabs-left {
            display: flex;
            gap: 4px;
            flex: 1;
            flex-wrap: wrap;
        }
        
        .viewer-tabs-right {
            display: flex;
            gap: 8px;
            align-items: center;
            margin-left: auto;
        }
        
        .btn-vse-ok {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 16px;
            background: #fff;
            color: #137333;
            border: 1px solid #137333;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.15s;
            white-space: nowrap;
        }
        
        .btn-vse-ok:hover {
            background: #e6f4ea;
        }
        
        .btn-vse-ok:active {
            background: #137333;
            color: #fff;
            transform: scale(0.98);
        }
        
        .btn-vse-ok .material-icons-outlined {
            font-size: 18px;
        }
        
        .viewer-open-external {
            width: 32px;
            height: 32px;
            border: 1px solid #dadce0;
            background: #fff;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #5f6368;
            transition: all 0.15s;
            flex-shrink: 0;
            margin-left: 8px;
        }
        
        .viewer-open-external:hover {
            background: #e8f4fd;
            border-color: #1a73e8;
            color: #1a73e8;
        }
        
        .viewer-open-external .material-icons-outlined {
            font-size: 18px;
        }

        .viewer-tab {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 14px;
            background: #f5f5f5;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            font-size: 12px !important;
            color: #5f6368 !important;
            cursor: pointer;
            transition: all 0.15s;
            font-style: normal !important;
        }

        .viewer-tab:hover {
            background: #e8f1fa;
            border-color: #004289;
            color: #004289 !important;
        }

        .viewer-tab.active {
            background: #004289;
            border-color: #004289;
            color: #fff !important;
        }

        .viewer-tab .material-icons-outlined {
            font-size: 16px;
        }

        .viewer-tab .badge {
            background: rgba(255,255,255,0.2);
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 10px;
        }

        .viewer-tab:not(.active) .badge {
            background: #e8f1fa;
            color: #004289;
        }

        .viewer-content {
            flex: 1;
            padding: 24px;
            overflow-y: auto;
        }
        
        /* Viewer bez padding pro mapu */
        .viewer-content:has(.katastr-map-container) {
            padding: 0;
            overflow: hidden;
        }
        
        #viewer-pozemky:not(.viewer-placeholder) {
            height: 100%;
        }

        .viewer-placeholder {
            background: #fff;
            border: 2px dashed #dadce0;
            border-radius: 12px;
            padding: 60px 40px;
            text-align: center;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .viewer-placeholder .material-icons-outlined {
            font-size: 64px;
            color: #9aa0a6;
            margin-bottom: 16px;
        }

        .viewer-placeholder-title {
            font-size: 16px !important;
            font-weight: 500 !important;
            color: #202124 !important;
            margin-bottom: 8px !important;
            font-style: normal !important;
        }

        .viewer-placeholder-text {
            font-size: 13px !important;
            color: #5f6368 !important;
            font-style: normal !important;
        }

        /* Right panel - control form */
        .control-form {
            flex: 0 0 40%;
            display: flex;
            flex-direction: column;
            background: #fff;
            min-height: 0;
            overflow: hidden;
        }

        .control-form-body {
            flex: 1;
            padding: 24px;
            overflow-y: auto;
            min-height: 0;
        }

        .control-form-footer {
            padding: 16px 24px;
            border-top: 1px solid #e0e0e0;
            background: #fafafa;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
            flex-shrink: 0;
        }

        .control-form-footer-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .control-form-footer-right {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .auto-save-indicator {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            color: #5f6368;
        }

        .auto-save-indicator .material-icons-outlined {
            font-size: 16px;
        }

        .auto-save-indicator.saving {
            color: #f57c00;
        }

        .auto-save-indicator.saving .material-icons-outlined {
            animation: spin 1s linear infinite;
        }

        .auto-save-indicator.saved {
            color: #137333;
        }

        /* ==========================================
           KONTROLA ŽÁDOSTI - NOVÝ DESIGN
           ========================================== */
        
        /* Levé okno - strukturovaná data */
        .zadost-data-viewer {
            flex: 0 0 60%;
            display: flex;
            flex-direction: column;
            border-right: 1px solid #e0e0e0;
        }
        
        .zadost-data-content {
            flex: 1;
            overflow-y: auto;
            padding: 0;
            background: #f8f9fa;
        }
        
        .zadost-data-tab {
            display: none;
            padding: 20px;
        }
        
        .zadost-data-tab.active {
            display: block;
        }
        
        /* ==========================================
           ZNOVUPOUŽITELNÉ KOMPONENTY - READ-ONLY ŽÁDOST
           ========================================== */
        .zadost-readonly-content {
            padding: 16px;
            overflow-y: auto;
            max-height: 100%;
        }
        
        .zadost-readonly-section {
            background: #fff;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            margin-bottom: 12px;
            overflow: hidden;
        }
        
        .zadost-readonly-header {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 14px;
            background: #f8f9fa;
            border-bottom: 1px solid #e0e0e0;
            font-size: 13px;
            font-weight: 600;
            color: #202124;
        }
        
        .zadost-readonly-header .material-icons-outlined {
            font-size: 18px;
            color: #5f6368;
        }
        
        .zadost-readonly-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1px;
            background: #e0e0e0;
        }
        
        .zadost-readonly-item {
            background: #fff;
            padding: 10px 14px;
        }
        
        .zadost-readonly-item.full-width {
            grid-column: 1 / -1;
        }
        
        .zadost-readonly-label {
            font-size: 11px;
            color: #5f6368;
            margin-bottom: 3px;
        }
        
        .zadost-readonly-value {
            font-size: 13px;
            color: #202124;
            font-weight: 500;
        }
        
        .zadost-readonly-value .material-icons-outlined {
            font-size: 16px;
            margin-right: 4px;
        }
        
        .zadost-readonly-table {
            padding: 12px 14px;
        }
        
        .zadost-readonly-table table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }
        
        .zadost-readonly-table th {
            text-align: left;
            padding: 8px 10px;
            background: #f8f9fa;
            border: 1px solid #e0e0e0;
            font-weight: 600;
            color: #5f6368;
        }
        
        .zadost-readonly-table td {
            padding: 8px 10px;
            border: 1px solid #e0e0e0;
            color: #202124;
        }
        
        /* Reusable tab content containers */
        .reusable-zadost-data,
        .reusable-formular-preview {
            height: 100%;
            overflow-y: auto;
        }
        
        .reusable-zadost-data {
            display: none;
        }
        
        .reusable-zadost-data.active,
        .reusable-formular-preview.active {
            display: block;
        }
        
        .zadost-data-section {
            background: #fff;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            margin-bottom: 16px;
            overflow: hidden;
            transition: border-color 0.2s;
        }
        
        .zadost-data-section.status-ok {
            border-color: #34a853;
        }
        
        .zadost-data-section.status-ok .zadost-data-section-header {
            background: #e6f4ea;
            border-bottom-color: #ceead6;
        }
        
        .zadost-data-section.status-vada {
            border-color: #ea4335;
        }
        
        .zadost-data-section.status-vada .zadost-data-section-header {
            background: #fce8e6;
            border-bottom-color: #f5c6c2;
        }
        
        /* Inline kontrolní panel v sekci */
        .zadost-section-controls {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 16px;
            background: #fafafa;
            border-top: 1px solid #e0e0e0;
        }
        
        .zadost-section-status {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            color: #5f6368;
        }
        
        .zadost-section-status .material-icons-outlined {
            font-size: 16px;
        }
        
        .zadost-section-status.status-ok {
            color: #137333;
        }
        
        .zadost-section-status.status-vada {
            color: #c5221f;
        }
        
        .zadost-section-actions {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .zadost-section-btn {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 6px 12px;
            border: 1px solid #dadce0;
            border-radius: 4px;
            background: #fff;
            font-size: 12px;
            font-weight: 500;
            color: #5f6368;
            cursor: pointer;
            transition: all 0.15s;
        }
        
        .zadost-section-btn:hover {
            background: #f8f9fa;
            border-color: #c0c0c0;
        }
        
        .zadost-section-btn .material-icons-outlined {
            font-size: 16px;
        }
        
        .zadost-section-btn.btn-ok {
            color: #137333;
            border-color: #137333;
        }
        
        .zadost-section-btn.btn-ok:hover {
            background: #e6f4ea;
        }
        
        .zadost-section-btn.btn-ok.active {
            background: #137333;
            color: #fff;
            border-color: #137333;
        }
        
        .zadost-section-btn.btn-vada {
            color: #c5221f;
            border-color: #c5221f;
        }
        
        .zadost-section-btn.btn-vada:hover {
            background: #fce8e6;
        }
        
        .zadost-section-btn.btn-vada.active {
            background: #c5221f;
            color: #fff;
            border-color: #c5221f;
        }
        
        /* Pravý panel - Nedostatky */
        .zadost-deficiency-panel {
            flex: 0 0 40%;
            display: flex;
            flex-direction: column;
            background: #fff;
        }
        
        .deficiency-panel-header {
            padding: 16px 20px;
            border-bottom: 1px solid #e0e0e0;
            background: #f8f9fa;
        }
        
        .deficiency-panel-title {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            font-weight: 600;
            color: #202124;
            margin-bottom: 8px;
        }
        
        .deficiency-panel-title .material-icons-outlined {
            font-size: 20px;
            color: #ea4335;
        }
        
        .deficiency-panel-summary {
            display: flex;
            gap: 16px;
            font-size: 12px;
        }
        
        .deficiency-stat {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .deficiency-stat.ok { color: #137333; }
        .deficiency-stat.vada { color: #c5221f; }
        .deficiency-stat.pending { color: #5f6368; }
        
        .deficiency-panel-content {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
        }
        
        .deficiency-empty {
            text-align: center;
            padding: 40px 20px;
            color: #9aa0a6;
        }
        
        .deficiency-empty .material-icons-outlined {
            font-size: 48px;
            margin-bottom: 12px;
            color: #137333;
        }
        
        .deficiency-empty-title {
            font-size: 14px;
            font-weight: 500;
            color: #202124;
            margin-bottom: 4px;
        }
        
        .deficiency-empty-text {
            font-size: 12px;
        }
        
        /* Seznam nedostatků */
        .deficiency-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .deficiency-item {
            background: #fce8e6;
            border: 1px solid #f5c6c2;
            border-radius: 8px;
            padding: 12px;
        }
        
        .deficiency-item-header {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            gap: 8px;
            margin-bottom: 8px;
        }
        
        .deficiency-item-section {
            font-size: 11px;
            font-weight: 600;
            color: #c5221f;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }
        
        .deficiency-item-remove {
            width: 20px;
            height: 20px;
            border: none;
            background: transparent;
            color: #c5221f;
            cursor: pointer;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
        }
        
        .deficiency-item-remove:hover {
            background: rgba(197, 34, 31, 0.1);
        }
        
        .deficiency-item-remove .material-icons-outlined {
            font-size: 16px;
        }
        
        .deficiency-item-text {
            font-size: 13px;
            color: #202124;
            margin-bottom: 8px;
        }
        
        .deficiency-item-textarea {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid #f5c6c2;
            border-radius: 4px;
            background: #fff;
            font-size: 12px;
            font-family: inherit;
            resize: vertical;
            min-height: 60px;
        }
        
        .deficiency-item-textarea:focus {
            outline: none;
            border-color: #c5221f;
            box-shadow: 0 0 0 2px rgba(197, 34, 31, 0.1);
        }
        
        .deficiency-item-textarea::placeholder {
            color: #9aa0a6;
        }
        
        /* Footer s výsledkem */
        .deficiency-panel-footer {
            padding: 16px;
            border-top: 1px solid #e0e0e0;
            background: #f8f9fa;
        }
        
        .deficiency-result {
            padding: 12px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 13px;
        }
        
        .deficiency-result.positive {
            background: #e6f4ea;
            border: 1px solid #ceead6;
            color: #137333;
        }
        
        .deficiency-result.negative {
            background: #fce8e6;
            border: 1px solid #f5c6c2;
            color: #c5221f;
        }
        
        .deficiency-result.pending {
            background: #fff8e1;
            border: 1px solid #ffe082;
            color: #e65100;
        }
        
        .deficiency-result .material-icons-outlined {
            font-size: 20px;
        }
        
        .deficiency-panel-actions {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
            margin-top: 12px;
        }
        
        /* Přepínání režimů pravého panelu */
        .zadost-panel-mode {
            display: none;
            flex-direction: column;
            height: 100%;
        }
        .zadost-panel-mode.active {
            display: flex;
        }
        
        /* Režim kontroly formuláře - checklist */
        .formular-checklist-content {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
        }
        
        .formular-checklist-intro {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            padding: 12px;
            background: #e8f0fe;
            border-radius: 8px;
            margin-bottom: 16px;
            font-size: 12px;
            color: #1a73e8;
        }
        
        .formular-checklist-intro .material-icons-outlined {
            font-size: 18px;
            flex-shrink: 0;
        }
        
        .formular-checklist {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .formular-check-item {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            background: #fff;
            transition: all 0.15s;
        }
        
        .formular-check-item.status-ok {
            border-color: #ceead6;
            background: #f6fef8;
        }
        
        .formular-check-item.status-vada {
            border-color: #f5c6c2;
            background: #fef6f5;
        }
        
        .formular-check-item.status-skip {
            border-color: #e0e0e0;
            background: #f8f9fa;
            opacity: 0.7;
        }
        
        .formular-check-header {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 14px;
        }
        
        .formular-check-icon {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            background: #f1f3f4;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        
        .formular-check-icon .material-icons-outlined {
            font-size: 20px;
            color: #5f6368;
        }
        
        .formular-check-item.status-ok .formular-check-icon {
            background: #e6f4ea;
        }
        .formular-check-item.status-ok .formular-check-icon .material-icons-outlined {
            color: #137333;
        }
        
        .formular-check-item.status-vada .formular-check-icon {
            background: #fce8e6;
        }
        .formular-check-item.status-vada .formular-check-icon .material-icons-outlined {
            color: #c5221f;
        }
        
        .formular-check-title {
            flex: 1;
            font-size: 13px;
            font-weight: 500;
            color: #202124;
        }
        
        .formular-check-status {
            display: flex;
            align-items: center;
        }
        
        .formular-check-status .material-icons-outlined {
            font-size: 22px;
            color: #9aa0a6;
        }
        
        .formular-check-item.status-ok .formular-check-status .material-icons-outlined {
            color: #137333;
        }
        
        .formular-check-item.status-vada .formular-check-status .material-icons-outlined {
            color: #c5221f;
        }
        
        .formular-check-item.status-skip .formular-check-status .material-icons-outlined {
            color: #9aa0a6;
        }
        
        .formular-check-actions {
            display: flex;
            gap: 8px;
            padding: 0 14px 12px;
        }
        
        .formular-btn-ok,
        .formular-btn-vada,
        .formular-btn-skip {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s;
            border: 1px solid;
        }
        
        .formular-btn-ok {
            background: #fff;
            border-color: #ceead6;
            color: #137333;
        }
        .formular-btn-ok:hover {
            background: #e6f4ea;
        }
        .formular-btn-ok .material-icons-outlined {
            font-size: 16px;
        }
        
        .formular-btn-vada {
            background: #fff;
            border-color: #f5c6c2;
            color: #c5221f;
        }
        .formular-btn-vada:hover {
            background: #fce8e6;
        }
        .formular-btn-vada .material-icons-outlined {
            font-size: 16px;
        }
        
        .formular-btn-skip {
            background: #fff;
            border-color: #e0e0e0;
            color: #5f6368;
        }
        .formular-btn-skip:hover {
            background: #f1f3f4;
        }
        .formular-btn-skip .material-icons-outlined {
            font-size: 16px;
        }
        
        /* Skrýt tlačítka po označení */
        .formular-check-item.status-ok .formular-check-actions,
        .formular-check-item.status-vada .formular-check-actions,
        .formular-check-item.status-skip .formular-check-actions {
            display: none;
        }
        
        .formular-check-vada-input {
            padding: 0 14px 12px;
        }
        
        .formular-check-vada-input textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #f5c6c2;
            border-radius: 6px;
            background: #fff;
            font-size: 12px;
            font-family: inherit;
            resize: vertical;
            min-height: 60px;
        }
        
        .formular-check-vada-input textarea:focus {
            outline: none;
            border-color: #c5221f;
            box-shadow: 0 0 0 2px rgba(197, 34, 31, 0.1);
        }
        
        .formular-check-vada-input textarea::placeholder {
            color: #9aa0a6;
        }
        
        /* Hlavička panelu formuláře s tlačítkem */
        .deficiency-panel-header-top {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            margin-bottom: 8px;
        }
        
        .btn-vse-ok-small {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 6px 12px;
            background: #e6f4ea;
            border: 1px solid #ceead6;
            border-radius: 6px;
            color: #137333;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s;
        }
        .btn-vse-ok-small:hover {
            background: #ceead6;
        }
        .btn-vse-ok-small .material-icons-outlined {
            font-size: 16px;
        }
        
        /* Tlačítko Změnit */
        .formular-check-change {
            padding: 0 14px 12px;
        }
        
        .formular-btn-change {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 6px 12px;
            background: #fff;
            border: 1px solid #dadce0;
            border-radius: 6px;
            color: #5f6368;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s;
        }
        .formular-btn-change:hover {
            background: #f1f3f4;
            border-color: #5f6368;
        }
        .formular-btn-change .material-icons-outlined {
            font-size: 16px;
        }
        
        /* Přílohy viewer */
        .prilohy-viewer {
            padding: 20px;
        }
        
        .prilohy-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .prilohy-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 14px;
            background: #fff;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            transition: all 0.15s;
        }
        .prilohy-item:hover {
            border-color: #1a73e8;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        }
        
        .prilohy-item-icon {
            width: 40px;
            height: 40px;
            background: #f1f3f4;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        .prilohy-item-icon .material-icons-outlined {
            font-size: 22px;
            color: #5f6368;
        }
        
        .prilohy-item-info {
            flex: 1;
            min-width: 0;
        }
        
        .prilohy-item-name {
            font-size: 13px;
            font-weight: 500;
            color: #202124;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .prilohy-item-meta {
            font-size: 11px;
            color: #5f6368;
            margin-top: 2px;
        }
        
        .prilohy-item-btn {
            width: 36px;
            height: 36px;
            background: transparent;
            border: 1px solid #dadce0;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.15s;
            flex-shrink: 0;
        }
        .prilohy-item-btn:hover {
            background: #e8f0fe;
            border-color: #1a73e8;
        }
        .prilohy-item-btn .material-icons-outlined {
            font-size: 18px;
            color: #5f6368;
        }
        .prilohy-item-btn:hover .material-icons-outlined {
            color: #1a73e8;
        }
        
        .prilohy-note {
            display: flex;
            align-items: flex-start;
            gap: 8px;
            margin-top: 16px;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
            font-size: 12px;
            color: #5f6368;
        }
        .prilohy-note .material-icons-outlined {
            font-size: 18px;
            color: #9aa0a6;
            flex-shrink: 0;
        }
        
        /* Kompaktní verze seznamu příloh (v sekci žádosti) */
        .prilohy-list-compact {
            margin-top: 12px;
        }
        .prilohy-list-compact .prilohy-item {
            padding: 10px 12px;
        }
        .prilohy-list-compact .prilohy-item-icon {
            width: 36px;
            height: 36px;
        }
        .prilohy-list-compact .prilohy-item-icon .material-icons-outlined {
            font-size: 20px;
        }
        .prilohy-list-compact .prilohy-item-btn {
            width: 32px;
            height: 32px;
        }
        .prilohy-list-compact .prilohy-item-btn .material-icons-outlined {
            font-size: 16px;
        }
        
        /* Stav neaplikuje se */
        .prilohy-item.prilohy-item-na {
            background: #f8f9fa;
            border-color: #e0e0e0;
            opacity: 0.7;
        }
        .prilohy-item.prilohy-item-na:hover {
            border-color: #e0e0e0;
            box-shadow: none;
        }
        .prilohy-item-na .prilohy-item-icon {
            background: #f1f3f4;
        }
        .prilohy-item-na .prilohy-item-icon .material-icons-outlined {
            color: #9aa0a6;
        }
        .prilohy-item-na .prilohy-item-name {
            color: #5f6368;
        }
        .prilohy-item-na .prilohy-item-meta {
            font-style: italic;
        }
        
        /* Záložka Přílohy - disabled stav */
        .viewer-tab.tab-disabled {
            opacity: 0.5;
            pointer-events: none;
        }
        
        /* ==========================================
           DOKLADOVÁ ČÁST - NÁHLED V KONTROLE ŽÁDOSTI
           ========================================== */
        .doklady-viewer {
            padding: 16px;
            overflow-y: auto;
            max-height: 100%;
        }
        
        .doklady-section {
            background: #fff;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            margin-bottom: 12px;
            overflow: hidden;
        }
        
        .doklady-section-header {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 14px;
            background: #f8f9fa;
            border-bottom: 1px solid #e0e0e0;
            font-size: 13px;
            font-weight: 600;
            color: #202124;
        }
        
        .doklady-section-header .material-icons-outlined {
            font-size: 18px;
            color: #5f6368;
        }
        
        .doklady-count {
            margin-left: auto;
            background: #e8eaed;
            color: #5f6368;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 600;
        }
        
        .doklady-list {
            display: flex;
            flex-direction: column;
        }
        
        .doklady-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 14px;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .doklady-item:last-child {
            border-bottom: none;
        }
        
        .doklady-item-icon {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        
        .doklady-item-icon .material-icons-outlined {
            font-size: 18px;
        }
        
        .doklady-item.status-ok .doklady-item-icon {
            background: #e6f4ea;
        }
        .doklady-item.status-ok .doklady-item-icon .material-icons-outlined {
            color: #34a853;
        }
        
        .doklady-item.status-pending .doklady-item-icon {
            background: #fff3e0;
        }
        .doklady-item.status-pending .doklady-item-icon .material-icons-outlined {
            color: #e65100;
        }
        
        .doklady-item.status-error .doklady-item-icon {
            background: #fce8e6;
        }
        .doklady-item.status-error .doklady-item-icon .material-icons-outlined {
            color: #ea4335;
        }
        
        .doklady-item-info {
            flex: 1;
            min-width: 0;
        }
        
        .doklady-item-name {
            font-size: 13px;
            font-weight: 500;
            color: #202124;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .doklady-item-meta {
            font-size: 11px;
            color: #5f6368;
            margin-top: 2px;
        }
        
        .doklady-item-btn {
            width: 32px;
            height: 32px;
            border: none;
            background: transparent;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }
        
        .doklady-item-btn:hover:not(:disabled) {
            background: #f1f3f4;
        }
        
        .doklady-item-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }
        
        .doklady-item-btn .material-icons-outlined {
            font-size: 18px;
            color: #5f6368;
        }
        
        .doklady-note {
            display: flex;
            align-items: flex-start;
            gap: 8px;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 6px;
            font-size: 12px;
            color: #5f6368;
            margin-top: 8px;
        }
        
        .doklady-note .material-icons-outlined {
            font-size: 16px;
            color: #9aa0a6;
            flex-shrink: 0;
            margin-top: 1px;
        }
        
        /* Badge stavu sekce v hlavičce */
        .section-status-badge {
            margin-left: auto;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .section-status-badge.ok {
            background: #e6f4ea;
            color: #137333;
        }
        
        .section-status-badge.vada {
            background: #fce8e6;
            color: #c5221f;
        }
        
        /* Inline přílohy v sekci */
        .zadost-prilohy-inline {
            padding: 12px 16px;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        
        .priloha-inline-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            padding: 6px 10px;
            background: #f8f9fa;
            border-radius: 4px;
        }
        
        .priloha-inline-item .material-icons-outlined {
            font-size: 16px;
        }
        
        .priloha-inline-item.ok {
            background: #e6f4ea;
            color: #137333;
        }
        
        .priloha-inline-item.na {
            color: #9aa0a6;
        }
        
        .priloha-inline-item.pending {
            background: #fff3e0;
            color: #e65100;
            font-weight: 500;
        }
        
        .priloha-inline-item.pending .material-icons-outlined {
            color: #e65100;
        }
        
        /* Náhled formuláře žádosti */
        .formular-preview {
            background: #fff;
            border: 1px solid #d0d0d0;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin: 16px;
            font-family: 'Times New Roman', serif;
        }
        
        .formular-header {
            display: flex;
            align-items: flex-start;
            gap: 16px;
            padding: 20px;
            border-bottom: 2px solid #000;
        }
        
        .formular-logo {
            width: 60px;
            height: 60px;
            border: 2px solid #000;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .formular-logo .material-icons-outlined {
            font-size: 36px;
        }
        
        .formular-title-block {
            flex: 1;
        }
        
        .formular-title {
            font-size: 18px;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .formular-subtitle {
            font-size: 11px;
            color: #444;
            margin-top: 4px;
        }
        
        .formular-cislo {
            text-align: right;
        }
        
        .formular-cislo-label {
            font-size: 10px;
            color: #666;
            text-transform: uppercase;
        }
        
        .formular-cislo-value {
            font-size: 13px;
            font-weight: bold;
            font-family: monospace;
        }
        
        .formular-section {
            padding: 16px 20px;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .formular-section:last-of-type {
            border-bottom: none;
        }
        
        .formular-section-title {
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            background: #f0f0f0;
            padding: 6px 10px;
            margin: -16px -20px 16px -20px;
            border-bottom: 1px solid #d0d0d0;
        }
        
        .formular-subsection {
            margin-bottom: 16px;
        }
        
        .formular-subsection:last-child {
            margin-bottom: 0;
        }
        
        .formular-subsection-title {
            font-size: 11px;
            font-weight: bold;
            color: #333;
            margin-bottom: 8px;
        }
        
        .formular-field-row {
            display: flex;
            gap: 12px;
            margin-bottom: 8px;
        }
        
        .formular-field-row:last-child {
            margin-bottom: 0;
        }
        
        .formular-field {
            flex: 1;
        }
        
        .formular-field.full {
            flex: 100%;
        }
        
        .formular-field-label {
            font-size: 9px;
            color: #666;
            text-transform: uppercase;
            margin-bottom: 2px;
        }
        
        .formular-field-value {
            font-size: 12px;
            padding: 4px 8px;
            background: #fafafa;
            border: 1px solid #d0d0d0;
            border-radius: 2px;
            min-height: 20px;
        }
        
        .formular-field.empty .formular-field-value {
            color: #999;
            font-style: italic;
        }
        
        .formular-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 20px;
            background: #f8f8f8;
            border-top: 1px solid #e0e0e0;
            font-size: 10px;
            color: #666;
        }
        
        .formular-fields {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }
        
        .formular-fields .formular-field.full-width {
            grid-column: 1 / -1;
        }
        
        .formular-page-info {
            font-weight: 500;
        }
        
        .formular-note {
            font-style: italic;
        }
        
        /* Akční tlačítka pro ověření zástupce */
        .zastupce-verify-actions {
            display: flex;
            gap: 8px;
            padding: 12px 16px;
            background: #f8f9fa;
            border-top: 1px solid #e0e0e0;
        }
        
        .zastupce-verify-btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 14px;
            border: 1px solid #dadce0;
            border-radius: 6px;
            background: #fff;
            font-size: 12px;
            font-weight: 500;
            color: #3c4043;
            cursor: pointer;
            transition: all 0.15s;
        }
        
        .zastupce-verify-btn:hover {
            background: #f1f3f4;
            border-color: #c0c0c0;
        }
        
        .zastupce-verify-btn .material-icons-outlined {
            font-size: 18px;
        }
        
        .zastupce-verify-btn.reza {
            border-color: #34a853;
            color: #137333;
        }
        
        .zastupce-verify-btn.reza:hover {
            background: #e6f4ea;
        }
        
        .zastupce-verify-btn.reza .material-icons-outlined {
            color: #34a853;
        }
        
        .zastupce-verify-btn.prilohy {
            border-color: #1a73e8;
            color: #1a73e8;
        }
        
        .zastupce-verify-btn.prilohy:hover {
            background: #e8f0fe;
        }
        
        /* REZA Modal */
        .reza-modal-content {
            padding: 0;
        }
        
        .reza-header {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px 20px;
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
            border-bottom: 1px solid #a5d6a7;
        }
        
        .reza-logo {
            width: 48px;
            height: 48px;
            background: #fff;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .reza-logo .material-icons-outlined {
            font-size: 28px;
            color: #2e7d32;
        }
        
        .reza-header-text {
            flex: 1;
        }
        
        .reza-title {
            font-size: 16px;
            font-weight: 600;
            color: #1b5e20;
        }
        
        .reza-subtitle {
            font-size: 12px;
            color: #388e3c;
            margin-top: 2px;
        }
        
        .reza-verified-badge {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 6px 12px;
            background: #2e7d32;
            color: #fff;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
        }
        
        .reza-verified-badge .material-icons-outlined {
            font-size: 16px;
        }
        
        .reza-body {
            padding: 20px;
        }
        
        .reza-info-section {
            margin-bottom: 16px;
        }
        
        .reza-info-section:last-child {
            margin-bottom: 0;
        }
        
        .reza-info-title {
            font-size: 11px;
            font-weight: 600;
            color: #5f6368;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            margin-bottom: 8px;
        }
        
        .reza-info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }
        
        .reza-info-item {
            background: #f8f9fa;
            padding: 10px 12px;
            border-radius: 6px;
        }
        
        .reza-info-item.full {
            grid-column: 1 / -1;
        }
        
        .reza-info-label {
            font-size: 10px;
            color: #5f6368;
            text-transform: uppercase;
            margin-bottom: 2px;
        }
        
        .reza-info-value {
            font-size: 13px;
            color: #202124;
            font-weight: 500;
        }
        
        .reza-validity {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            background: #e8f5e9;
            color: #2e7d32;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .reza-validity .material-icons-outlined {
            font-size: 16px;
        }
        
        .reza-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 20px;
            background: #f8f9fa;
            border-top: 1px solid #e0e0e0;
        }
        
        .reza-footer-info {
            font-size: 11px;
            color: #5f6368;
        }
        
        .reza-footer-info a {
            color: #1a73e8;
            text-decoration: none;
        }
        
        .reza-footer-info a:hover {
            text-decoration: underline;
        }
        
        .zadost-data-section-header {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 16px;
            background: #f1f3f4;
            border-bottom: 1px solid #e0e0e0;
            font-weight: 600;
            font-size: 13px;
            color: #202124;
        }
        
        .zadost-data-section-header .material-icons-outlined {
            font-size: 18px;
            color: #5f6368;
        }
        
        .zadost-data-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1px;
            background: #e0e0e0;
        }
        
        .zadost-data-item {
            padding: 12px 16px;
            background: #fff;
        }
        
        .zadost-data-item.full-width {
            grid-column: 1 / -1;
        }
        
        .zadost-data-label {
            font-size: 11px;
            font-weight: 500;
            color: #5f6368;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            margin-bottom: 4px;
        }
        
        .zadost-data-value {
            font-size: 13px;
            color: #202124;
        }
        
        .zadost-data-value.text-block {
            line-height: 1.5;
        }
        
        .zadost-data-empty {
            padding: 24px 16px;
            text-align: center;
            color: #9aa0a6;
            font-size: 13px;
        }
        
        .zadost-data-empty .material-icons-outlined {
            font-size: 32px;
            margin-bottom: 8px;
            display: block;
        }
        
        /* Tabulka pozemků */
        .zadost-data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }
        
        .zadost-data-table th {
            padding: 10px 12px;
            background: #f8f9fa;
            border-bottom: 1px solid #e0e0e0;
            text-align: left;
            font-weight: 600;
            color: #5f6368;
            font-size: 11px;
            text-transform: uppercase;
        }
        
        .zadost-data-table td {
            padding: 10px 12px;
            border-bottom: 1px solid #f1f3f4;
            color: #202124;
        }
        
        .zadost-data-table tr:last-child td {
            border-bottom: none;
        }
        
        /* Přílohy v levém okně */
        .zadost-prilohy-list {
            padding: 0;
        }
        
        .zadost-priloha-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 20px;
            background: #fff;
            border-bottom: 1px solid #f1f3f4;
        }
        
        .zadost-priloha-item:last-child {
            border-bottom: none;
        }
        
        .zadost-priloha-item.not-applicable {
            opacity: 0.6;
        }
        
        .zadost-priloha-item.attached {
            background: #fff;
        }
        
        .priloha-icon {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            background: #f1f3f4;
            flex-shrink: 0;
        }
        
        .priloha-icon .material-icons-outlined {
            font-size: 20px;
            color: #5f6368;
        }
        
        .zadost-priloha-item.attached .priloha-icon {
            background: #e8f5e9;
        }
        
        .zadost-priloha-item.attached .priloha-icon .material-icons-outlined {
            color: #2e7d32;
        }
        
        .priloha-info {
            flex: 1;
        }
        
        .priloha-name {
            font-size: 13px;
            font-weight: 500;
            color: #202124;
            margin-bottom: 2px;
        }
        
        .priloha-status {
            font-size: 12px;
            color: #5f6368;
        }
        
        .priloha-link {
            color: #1a73e8;
            text-decoration: none;
        }
        
        .priloha-link:hover {
            text-decoration: underline;
        }
        
        .priloha-action {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            background: transparent;
            border-radius: 50%;
            cursor: pointer;
            color: #5f6368;
        }
        
        .priloha-action:hover {
            background: #f1f3f4;
        }
        
        /* Pravé okno - checklist */
        .zadost-checklist {
            flex: 0 0 40%;
        }
        
        .checklist-section {
            margin-bottom: 24px;
        }
        
        .checklist-section-title {
            font-size: 14px;
            font-weight: 700;
            color: #202124;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 2px solid #e0e0e0;
        }
        
        .checklist-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 12px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            margin-bottom: 8px;
            background: #fff;
            transition: all 0.15s;
        }
        
        .checklist-item:hover {
            border-color: #dadce0;
            background: #fafafa;
        }
        
        .checklist-item.disabled {
            opacity: 0.5;
            background: #f8f9fa;
        }
        
        .checklist-item.checked-ok {
            background: #e8f5e9;
            border-color: #81c784;
        }
        
        .checklist-item.checked-error {
            background: #ffebee;
            border-color: #ef9a9a;
        }
        
        .checklist-text {
            font-size: 13px;
            color: #202124;
            flex: 1;
            padding-right: 12px;
        }
        
        .checklist-actions {
            display: flex;
            gap: 4px;
            flex-shrink: 0;
        }
        
        .checklist-btn {
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid #dadce0;
            border-radius: 4px;
            background: #fff;
            cursor: pointer;
            transition: all 0.15s;
        }
        
        .checklist-btn .material-icons-outlined {
            font-size: 18px;
        }
        
        .checklist-btn.ok {
            color: #5f6368;
        }
        
        .checklist-btn.ok:hover,
        .checklist-btn.ok.active {
            background: #e8f5e9;
            border-color: #81c784;
            color: #2e7d32;
        }
        
        .checklist-btn.error {
            color: #5f6368;
        }
        
        .checklist-btn.error:hover,
        .checklist-btn.error.active {
            background: #ffebee;
            border-color: #ef9a9a;
            color: #c62828;
        }
        
        .checklist-btn.na {
            background: #f1f3f4;
            border-color: #e0e0e0;
            color: #9aa0a6;
            cursor: default;
        }

        /* ==========================================
           ÚČASTNÍCI ŘÍZENÍ - STYLY
           ========================================== */
        .ucastnici-tabs {
            display: flex;
            gap: 0;
            background: #f8f9fa;
            border-bottom: 1px solid #e0e0e0;
            padding: 0;
        }
        
        .ucastnici-tab {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 14px 20px;
            background: transparent;
            border: none;
            border-bottom: 2px solid transparent;
            font-size: 13px;
            font-weight: 500;
            color: #5f6368;
            cursor: pointer;
            transition: all 0.15s;
        }
        
        .ucastnici-tab:hover {
            background: #e8f1fa;
            color: #004289;
        }
        
        .ucastnici-tab.active {
            background: #fff;
            color: #004289;
            border-bottom-color: #004289;
        }
        
        .ucastnici-tab .material-icons-outlined {
            font-size: 18px;
        }
        
        .ucastnici-tab-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 20px;
            height: 20px;
            padding: 0 6px;
            background: #e8eaed;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 600;
            color: #5f6368;
        }
        
        .ucastnici-tab.active .ucastnici-tab-badge {
            background: #e8f1fa;
            color: #004289;
        }
        
        .ucastnici-panel {
            display: none;
            padding: 0;
            overflow-y: auto;
            flex: 1;
        }
        
        .ucastnici-panel.active {
            display: flex;
            flex-direction: column;
        }
        
        .ucastnici-toolbar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            background: #fff;
            border-bottom: 1px solid #e8eaed;
        }
        
        .ucastnici-toolbar-left,
        .ucastnici-toolbar-right {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-ucastnici-action {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 14px;
            background: #fff;
            border: 1px solid #dadce0;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            color: #5f6368;
            cursor: pointer;
            transition: all 0.15s;
        }
        
        .btn-ucastnici-action:hover {
            background: #f8f9fa;
            border-color: #004289;
            color: #004289;
        }
        
        .btn-ucastnici-action.primary {
            background: #004289;
            border-color: #004289;
            color: #fff;
        }
        
        .btn-ucastnici-action.primary:hover {
            background: #003570;
        }
        
        .btn-ucastnici-action .material-icons-outlined {
            font-size: 16px;
        }
        
        .ucastnici-checkbox {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            color: #5f6368;
            cursor: pointer;
        }
        
        .ucastnici-checkbox input {
            cursor: pointer;
        }
        
        /* Skupiny účastníků */
        .ucastnici-group {
            border-bottom: 1px solid #e8eaed;
        }
        
        .ucastnici-group-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            background: #f8f9fa;
        }
        
        .ucastnici-group-title {
            font-size: 13px;
            font-weight: 600;
            color: #202124;
        }
        
        .ucastnici-group-actions {
            display: flex;
            gap: 8px;
        }
        
        .btn-add-ucastnik {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 6px 12px;
            background: #004289;
            border: none;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 500;
            color: #fff;
            cursor: pointer;
            transition: all 0.15s;
        }
        
        .btn-add-ucastnik:hover {
            background: #003570;
        }
        
        .btn-add-ucastnik.secondary {
            background: #fff;
            border: 1px solid #dadce0;
            color: #5f6368;
        }
        
        .btn-add-ucastnik.secondary:hover {
            background: #f8f9fa;
            border-color: #004289;
            color: #004289;
        }
        
        .btn-add-ucastnik .material-icons-outlined {
            font-size: 14px;
        }
        
        /* Tabulka účastníků */
        .ucastnici-table {
            width: 100%;
        }
        
        .ucastnici-row {
            display: flex;
            align-items: center;
            padding: 10px 16px;
            border-bottom: 1px solid #f1f3f4;
            transition: background 0.1s;
        }
        
        .ucastnici-row:hover {
            background: #f8f9fa;
        }
        
        .ucastnici-row:last-child {
            border-bottom: none;
        }
        
        .ucastnici-cell {
            font-size: 13px;
            color: #202124;
        }
        
        .ucastnici-cell.status {
            width: 30px;
            flex-shrink: 0;
        }
        
        .ucastnici-cell.type {
            width: 100px;
            flex-shrink: 0;
            font-size: 11px;
            color: #5f6368;
        }
        
        .ucastnici-cell.name {
            flex: 1;
            font-weight: 500;
            min-width: 150px;
        }
        
        .ucastnici-cell.address {
            flex: 1.5;
            color: #5f6368;
            font-size: 12px;
        }
        
        .ucastnici-cell.actions {
            display: flex;
            gap: 4px;
            justify-content: flex-end;
            width: 150px;
            flex-shrink: 0;
        }
        
        .ucastnici-status {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 22px;
            height: 22px;
        }
        
        .ucastnici-status .material-icons-outlined {
            font-size: 18px;
        }
        
        .ucastnici-status.verified {
            color: #137333;
        }
        
        .ucastnici-status.pending {
            color: #f9ab00;
        }
        
        .ucastnici-status.error {
            color: #c5221f;
        }
        
        .ucastnici-action-btn {
            width: 28px;
            height: 28px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background: transparent;
            border: none;
            border-radius: 4px;
            color: #5f6368;
            cursor: pointer;
            transition: all 0.1s;
        }
        
        .ucastnici-action-btn:hover {
            background: #e8eaed;
            color: #202124;
        }
        
        .ucastnici-action-btn.delete:hover {
            background: #fce8e6;
            color: #c5221f;
        }
        
        .ucastnici-action-btn.favorited {
            color: #f9ab00;
        }
        
        .ucastnici-action-btn .material-icons-outlined {
            font-size: 18px;
        }
        
        .ucastnici-empty {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 24px;
            color: #9aa0a6;
            font-size: 13px;
        }
        
        .ucastnici-empty .material-icons-outlined {
            font-size: 20px;
        }
        
        /* Tabulka zástupců a dalších osob */
        .zastupci-table-wrapper {
            overflow-x: auto;
        }
        
        .zastupci-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }
        
        .zastupci-table th {
            padding: 10px 12px;
            background: #f8f9fa;
            border-bottom: 1px solid #e0e0e0;
            text-align: left;
            font-weight: 500;
            font-size: 11px;
            color: #5f6368;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .zastupci-table td {
            padding: 12px;
            border-bottom: 1px solid #f1f3f4;
            vertical-align: middle;
        }
        
        .zastupci-table tbody tr:hover {
            background: #f8f9fa;
        }
        
        .zastupce-zastoupeni {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
        }
        
        .zastupce-chip {
            display: inline-flex;
            align-items: center;
            padding: 4px 10px;
            background: #e8f1fa;
            border-radius: 12px;
            font-size: 12px;
            color: #004289;
        }
        
        .zastupce-role {
            display: inline-block;
            padding: 3px 8px;
            background: #f1f3f4;
            border-radius: 4px;
            font-size: 11px;
            color: #5f6368;
        }
        
        .dalsi-osoba-poznamka {
            display: inline-block;
            padding: 3px 8px;
            background: #fff3e0;
            border-radius: 4px;
            font-size: 11px;
            color: #e65100;
            font-style: italic;
        }
        
        /* Toggle switch pro doručování */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 40px;
            height: 22px;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #dadce0;
            transition: 0.2s;
            border-radius: 22px;
        }
        
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: 0.2s;
            border-radius: 50%;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }
        
        .toggle-switch input:checked + .toggle-slider {
            background-color: #004289;
        }
        
        .toggle-switch input:checked + .toggle-slider:before {
            transform: translateX(18px);
        }

        /* ==========================================
           OSOBY - DVOUSLOUPCOVÝ LAYOUT
           ========================================== */
        .osoby-layout {
            display: flex;
            gap: 0;
            padding: 0 !important;
            flex: 1;
            min-height: 0;
            overflow: hidden;
        }
        
        /* Levý sloupec - Pozemky */
        .osoby-col-pozemky {
            width: 340px;
            min-width: 340px;
            background: #f8f9fa;
            border-right: 1px solid #e0e0e0;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .osoby-pozemky-content {
            flex: 1;
            overflow-y: auto;
        }
        
        /* Pravý sloupec - Účastníci */
        .osoby-col-ucastnici {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background: #fff;
        }
        
        /* Hlavička sloupce */
        .osoby-col-header {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            height: 44px;
            background: #004289;
            color: #fff;
            font-size: 13px;
            font-weight: 600;
            box-sizing: border-box;
            flex-shrink: 0;
        }
        
        .osoby-col-header .material-icons-outlined {
            font-size: 18px;
        }
        
        .btn-overit-vse-sm {
            margin-left: auto;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            background: #fff;
            border: none;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            color: #004289;
            cursor: pointer;
        }
        
        .btn-overit-vse-sm:hover {
            background: #e8f1fa;
        }
        
        .btn-overit-vse-sm .material-icons-outlined {
            font-size: 14px;
        }
        
        /* Bloky pozemků */
        .pozemky-blok {
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            flex-direction: column;
        }
        
        .pozemky-blok-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            flex-shrink: 0;
        }
        
        .pozemky-blok-header.zamer {
            background: #e3f2fd;
            color: #1565c0;
        }
        
        .pozemky-blok-header.soused {
            background: #f3e5f5;
            color: #7b1fa2;
        }
        
        .pozemky-blok-count {
            background: rgba(0,0,0,0.1);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 10px;
        }
        
        .pozemky-blok-list {
            overflow-y: auto;
        }
        
        .pozemek-item {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            font-size: 12px;
            border-bottom: 1px solid #f1f3f4;
        }
        
        .pozemek-item:hover {
            background: #fff;
        }
        
        .pozemek-item .pozemek-parcela {
            font-weight: 600;
            min-width: 50px;
            color: #202124;
        }
        
        .pozemek-item .pozemek-ku {
            color: #9aa0a6;
            font-size: 10px;
            min-width: 55px;
        }
        
        .pozemek-item .pozemek-vlastnik {
            flex: 1;
            color: #5f6368;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-size: 11px;
        }
        
        .pozemek-item .pozemek-vlastnik.verified {
            color: #137333;
        }
        
        .pozemek-item .pozemek-status {
            width: 18px;
        }
        
        .pozemek-item .pozemek-status .material-icons-outlined {
            font-size: 16px;
        }
        
        .pozemek-item .pozemek-status.pending {
            color: #f9ab00;
        }
        
        .pozemek-item .pozemek-status.ok {
            color: #137333;
        }
        
        .btn-overit-sm {
            padding: 2px 8px;
            background: #fff;
            border: 1px solid #dadce0;
            border-radius: 3px;
            font-size: 10px;
            font-weight: 500;
            color: #5f6368;
            cursor: pointer;
        }
        
        .btn-overit-sm:hover {
            border-color: #004289;
            color: #004289;
        }
        
        .btn-overit-sm.done {
            background: #e6f4ea;
            border-color: #137333;
            color: #137333;
            pointer-events: none;
        }
        
        /* Pozemek - rozšířený stav po ověření */
        .pozemek-item.verified {
            flex-wrap: wrap;
            padding-bottom: 8px;
        }
        
        .pozemek-item .pozemek-info-row {
            display: flex;
            align-items: center;
            gap: 6px;
            width: 100%;
            margin-top: 4px;
            padding-left: 0;
        }
        
        .pozemek-overeno-datum {
            font-size: 9px;
            color: #9aa0a6;
            background: #f1f3f4;
            padding: 2px 6px;
            border-radius: 3px;
        }
        
        /* LV tlačítko a dropdown */
        .btn-lv-wrapper {
            position: relative;
            display: inline-block;
        }
        
        .btn-lv {
            display: inline-flex;
            align-items: center;
            gap: 3px;
            padding: 2px 6px;
            background: #fff;
            border: 1px solid #1a73e8;
            border-radius: 3px;
            font-size: 10px;
            font-weight: 500;
            color: #1a73e8;
            cursor: pointer;
            transition: all 0.1s;
        }
        
        .btn-lv:hover {
            background: #e8f1fa;
        }
        
        .btn-lv .material-icons-outlined {
            font-size: 12px;
        }
        
        .lv-dropdown {
            display: none;
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 2px;
            background: #fff;
            border: 1px solid #dadce0;
            border-radius: 4px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            z-index: 9999;
            min-width: 150px;
        }
        
        .lv-dropdown.show {
            display: block;
        }
        
        .lv-dropdown-item {
            display: block;
            width: 100%;
            padding: 8px 12px;
            text-align: left;
            background: none;
            border: none;
            font-size: 11px;
            color: #202124;
            cursor: pointer;
        }
        
        .lv-dropdown-item:hover {
            background: #f1f3f4;
        }
        
        .lv-dropdown-item .lv-item-title {
            font-weight: 500;
        }
        
        .lv-dropdown-item .lv-item-desc {
            font-size: 10px;
            color: #5f6368;
            margin-top: 2px;
        }
        
        /* Tabs v hlavičce účastníků */
        .osoby-tabs-inline {
            display: flex;
            gap: 4px;
        }
        
        .osoby-tab-btn {
            padding: 4px 10px;
            background: rgba(255,255,255,0.15);
            border: none;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
            color: rgba(255,255,255,0.8);
            cursor: pointer;
            transition: all 0.15s;
        }
        
        .osoby-tab-btn:hover {
            background: rgba(255,255,255,0.25);
        }
        
        .osoby-tab-btn.active {
            background: #fff;
            color: #004289;
        }
        
        .osoby-tab-count {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 18px;
            height: 18px;
            padding: 0 5px;
            background: rgba(0,0,0,0.15);
            border-radius: 9px;
            font-size: 10px;
            margin-left: 4px;
        }
        
        .osoby-tab-btn.active .osoby-tab-count {
            background: #e8f1fa;
            color: #004289;
        }
        
        .btn-add-osoba {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            background: #fff;
            border: none;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            color: #004289;
            cursor: pointer;
        }
        
        .btn-add-osoba:hover {
            background: #e8f1fa;
        }
        
        .btn-add-osoba .material-icons-outlined {
            font-size: 14px;
        }
        
        /* Hlavička - akce */
        .osoby-header-actions {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-left: auto;
        }
        
        .btn-overit-osoby {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.4);
            border-radius: 4px;
            font-size: 11px;
            font-weight: 500;
            color: #fff;
            cursor: pointer;
        }
        
        .btn-overit-osoby:hover {
            background: rgba(255,255,255,0.3);
        }
        
        .btn-overit-osoby .material-icons-outlined {
            font-size: 14px;
        }
        
        /* Tlačítko ověřit osobu */
        .btn-overit-osobu {
            padding: 4px;
            background: #fff3e0;
            border: none;
            border-radius: 4px;
            color: #e65100;
            cursor: pointer;
        }
        
        .btn-overit-osobu:hover {
            background: #ffe0b2;
        }
        
        .btn-overit-osobu .material-icons-outlined {
            font-size: 18px;
        }
        
        /* Status ověření */
        .os-status.pending {
            color: #f9ab00;
        }
        
        /* Adresa neověřeno */
        .os-adresa-neovereno {
            color: #9aa0a6;
            font-style: italic;
        }
        
        /* DS info */
        .os-ds-info {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            margin-left: 8px;
            padding: 2px 6px;
            background: #e3f2fd;
            border-radius: 3px;
            font-size: 10px;
            color: #1565c0;
        }
        
        .os-ds-info .material-icons-outlined {
            font-size: 12px;
        }
        
        /* Info o pozemcích u vlastníka */
        .os-pozemky {
            display: inline-block;
            padding: 2px 6px;
            background: #f3e5f5;
            border-radius: 3px;
            font-size: 11px;
            color: #7b1fa2;
            margin-left: 4px;
        }
        
        /* Info o zastoupení */
        .os-zastoupen-info {
            display: block;
            margin-top: 4px;
            padding: 3px 8px;
            background: #e3f2fd;
            border-radius: 4px;
            font-size: 11px;
            color: #1565c0;
        }
        
        .os-zastoupen-info .material-icons-outlined {
            font-size: 14px;
            vertical-align: middle;
            margin-right: 4px;
        }
        
        /* Tlačítko doručování */
        .btn-dorucovani {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 28px;
            height: 28px;
            background: #fff;
            border: 1px solid #dadce0;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.15s;
            overflow: hidden;
        }
        
        .btn-dorucovani .material-icons-outlined {
            font-size: 18px;
            line-height: 1;
        }
        
        .btn-dorucovani.ds {
            background: #e3f2fd;
            border-color: #64b5f6;
            color: #1565c0;
        }
        
        .btn-dorucovani.ds:hover {
            background: #bbdefb;
        }
        
        .btn-dorucovani.posta {
            background: #fff3e0;
            border-color: #ffb74d;
            color: #ef6c00;
        }
        
        .btn-dorucovani.posta:hover {
            background: #ffe0b2;
        }
        
        .btn-dorucovani.nedorucovat {
            background: #ffebee;
            border-color: #ef9a9a;
            color: #c62828;
            position: relative;
        }
        
        .btn-dorucovani.nedorucovat:hover {
            background: #ffcdd2;
        }
        
        .doruc-ceka {
            color: #9aa0a6;
            font-size: 12px;
        }
        
        /* Loading / rotating icon */
        .os-status.loading {
            color: #5f6368;
        }
        
        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        .rotating {
            animation: rotate 1s linear infinite;
        }
        
        /* Panely tabů */
        .osoby-tab-panel {
            display: none;
            flex: 1;
            overflow-y: auto;
        }
        
        .osoby-tab-panel.active {
            display: block;
        }
        
        .osoby-empty-panel {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px;
            color: #9aa0a6;
        }
        
        .osoby-empty-panel .material-icons-outlined {
            font-size: 48px;
            margin-bottom: 12px;
        }
        
        .osoby-empty-panel p {
            margin-bottom: 16px;
        }
        
        /* Tabulka účastníků */
        .osoby-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }
        
        .osoby-table thead {
            background: #f8f9fa;
            position: sticky;
            top: 0;
            z-index: 1;
        }
        
        .osoby-table th {
            padding: 8px 10px;
            text-align: left;
            font-weight: 600;
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: #5f6368;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .osoby-table td {
            padding: 8px 10px;
            border-bottom: 1px solid #f1f3f4;
            vertical-align: middle;
        }
        
        .osoby-table tbody tr:hover {
            background: #f8f9fa;
        }
        
        /* Kategorie řádek */
        .osoby-kategorie-row td {
            padding: 6px 10px !important;
            background: #f5f5f5;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .kategorie-label {
            font-weight: 600;
            font-size: 11px;
            color: #202124;
        }
        
        .btn-nacist-vti {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            margin-left: 12px;
            padding: 3px 10px;
            background: #fff;
            color: #1a73e8;
            border: 1px solid #1a73e8;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s;
        }
        
        .btn-nacist-vti:hover {
            background: #e8f0fe;
        }
        
        .btn-nacist-vti .material-icons-outlined {
            font-size: 14px;
        }
        
        .kategorie-stav {
            margin-left: 8px;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: 500;
        }
        
        .kategorie-stav.ceka {
            background: #fff3e0;
            color: #e65100;
        }
        
        .kategorie-stav.ok {
            background: #e6f4ea;
            color: #137333;
        }
        
        /* Prázdný řádek */
        .osoby-empty-row td {
            color: #9aa0a6;
            font-style: italic;
            padding: 12px 10px !important;
        }
        
        /* Status ikona */
        .os-status {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 20px;
            height: 20px;
        }
        
        .os-status .material-icons-outlined {
            font-size: 18px;
        }
        
        .os-status.ok {
            color: #137333;
        }
        
        .os-status.pending {
            color: #f9ab00;
        }
        
        .os-status.vecne {
            color: #7b1fa2;
        }
        
        /* Zdroj badge */
        .os-zdroj {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
            font-weight: 500;
        }
        
        .os-zdroj.zdroj-zadost {
            background: #e3f2fd;
            color: #1565c0;
        }
        
        .os-zdroj.zdroj-ku {
            background: #f3e5f5;
            color: #7b1fa2;
        }
        
        .os-zdroj.zdroj-kn {
            background: #e6f4ea;
            color: #137333;
        }
        
        .os-zdroj.vti {
            background: #fff3e0;
            color: #e65100;
        }
        
        .os-zdroj.vdi {
            background: #fce4ec;
            color: #c2185b;
        }
        
        /* Role badge */
        .os-role {
            display: inline-block;
            padding: 2px 8px;
            background: #fff3e0;
            border-radius: 3px;
            font-size: 11px;
            font-weight: 500;
            color: #e65100;
        }
        
        /* Akce tlačítka */
        .os-actions {
            white-space: nowrap;
        }
        
        .os-actions button {
            padding: 4px;
            background: transparent;
            border: none;
            border-radius: 4px;
            color: #5f6368;
            cursor: pointer;
        }
        
        .os-actions button:hover {
            background: #e8eaed;
            color: #202124;
        }
        
        .os-actions button.is-favorited {
            color: #f9ab00;
        }
        
        .os-actions button .material-icons-outlined {
            font-size: 18px;
        }
        
        .text-muted {
            color: #9aa0a6;
        }
        
        .text-center {
            text-align: center;
        }

        /* ==========================================
           ZÁSTUPCI - TOOLBAR A FORMULÁŘ
           ========================================== */
        .zastupci-toolbar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 16px;
            background: #f8f9fa;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .zastupci-toolbar-left {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .zastupci-toolbar-right {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .zastupci-info {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            color: #5f6368;
        }
        
        .zastupci-info .material-icons-outlined {
            font-size: 16px;
            color: #1a73e8;
        }
        
        .btn-outline {
            background: #fff;
            border: 1px solid #dadce0;
            color: #5f6368;
        }
        
        .btn-outline:hover {
            background: #f8f9fa;
            border-color: #bdc1c6;
        }
        
        /* Doručování toggle */
        .dorucovat-toggle {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .dorucovat-toggle input[type="checkbox"] {
            width: 16px;
            height: 16px;
            cursor: pointer;
        }
        
        .dorucovat-label {
            font-size: 11px;
            color: #5f6368;
        }
        
        .dorucovat-label.yes {
            color: #137333;
        }
        
        .dorucovat-label.no {
            color: #c5221f;
        }
        
        /* Zastupuje badge */
        .zastupuje-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 3px 8px;
            background: #e8f1fa;
            border-radius: 4px;
            font-size: 11px;
            color: #1565c0;
            margin-right: 4px;
            margin-bottom: 4px;
        }
        
        .zastupuje-badge .material-icons-outlined {
            font-size: 12px;
        }
        
        .zastupuje-cell {
            max-width: 250px;
        }
        
        /* Modal formulář sekce */
        .form-section {
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid #e8eaed;
        }
        
        .form-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }
        
        .form-section-title {
            font-size: 13px;
            font-weight: 600;
            color: #202124;
            margin-bottom: 12px;
        }
        
        .form-row {
            margin-bottom: 12px;
        }
        
        .form-row-2col {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 12px;
        }
        
        .form-row-3col {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 12px;
            margin-bottom: 12px;
        }
        
        .form-row-ico {
            display: flex;
            gap: 12px;
            align-items: flex-end;
            margin-bottom: 8px;
        }
        
        .btn-verify-ico {
            height: 36px;
            white-space: nowrap;
        }
        
        .form-verify-row {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }
        
        .verify-status {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-size: 12px;
        }
        
        .verify-status.loading {
            color: #5f6368;
        }
        
        .verify-status.success {
            color: #137333;
        }
        
        .verify-status.error {
            color: #c5221f;
        }
        
        .verify-status .material-icons-outlined {
            font-size: 16px;
        }
        
        .form-input[readonly] {
            background: #f8f9fa;
            color: #5f6368;
        }
        
        .form-group {
            margin-bottom: 12px;
        }
        
        .form-label {
            display: block;
            font-size: 12px;
            font-weight: 500;
            color: #5f6368;
            margin-bottom: 4px;
        }
        
        .form-input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #dadce0;
            border-radius: 4px;
            font-size: 13px;
            font-family: inherit;
            box-sizing: border-box;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #1a73e8;
            box-shadow: 0 0 0 2px rgba(26, 115, 232, 0.2);
        }
        
        .form-radio-group {
            display: flex;
            gap: 16px;
        }
        
        .form-radio {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
            cursor: pointer;
        }
        
        .form-radio input[type="radio"] {
            width: 16px;
            height: 16px;
            cursor: pointer;
        }
        
        .form-checkbox {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            cursor: pointer;
        }
        
        .form-checkbox input[type="checkbox"] {
            width: 16px;
            height: 16px;
            cursor: pointer;
        }
        
        .form-hint {
            font-size: 11px;
            color: #5f6368;
            margin: 0;
        }
        
        /* Zastupovaní list */
        .zastupovani-list {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
        }
        
        .zastupovani-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 12px;
            border-bottom: 1px solid #f1f3f4;
            cursor: pointer;
            transition: background 0.1s;
        }
        
        .zastupovani-item:last-child {
            border-bottom: none;
        }
        
        .zastupovani-item:hover {
            background: #f8f9fa;
        }
        
        .zastupovani-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        
        .zastupovani-info {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        
        .zastupovani-name {
            font-size: 13px;
            font-weight: 500;
            color: #202124;
        }
        
        .zastupovani-role {
            font-size: 11px;
            color: #5f6368;
        }

        .btn-save-draft {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 12px 24px;
            background: #fff;
            color: #5f6368;
            border: 1px solid #dadce0;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s;
            white-space: nowrap;
        }

        .btn-save-draft:hover {
            background: #f1f3f4;
            border-color: #5f6368;
        }

        .btn-save-draft .material-icons-outlined {
            font-size: 18px;
        }

        .control-section {
            margin-bottom: 24px;
        }

        .control-section:last-child {
            margin-bottom: 0;
        }

        .control-section-title {
            font-size: 13px !important;
            font-weight: 500 !important;
            color: #202124 !important;
            margin-bottom: 12px !important;
            font-style: normal !important;
        }

        .control-option {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 14px 16px;
            background: #f8f9fa;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.15s;
        }

        .control-option:last-child {
            margin-bottom: 0;
        }

        .control-option:hover {
            background: #f0f0f0;
            border-color: #dadce0;
        }

        .control-option.selected {
            background: #e8f1fa;
            border-color: #004289;
        }

        .control-option.selected.negative {
            background: #fce8e6;
            border-color: #f5c6c3;
        }

        .control-option input[type="radio"] {
            width: 18px;
            height: 18px;
            margin-top: 2px;
            accent-color: #004289;
            flex-shrink: 0;
        }

        .control-option-content {
            flex: 1;
        }

        .control-option-label {
            font-size: 14px !important;
            font-weight: 500 !important;
            color: #202124 !important;
            font-style: normal !important;
        }

        .control-option-desc {
            font-size: 12px !important;
            color: #5f6368 !important;
            margin-top: 2px !important;
            font-style: normal !important;
        }

        .control-option.selected.negative .control-option-label {
            color: #a50e0e !important;
        }

        /* Result preview box */
        .result-preview {
            padding: 16px;
            border-radius: 8px;
            margin-top: 16px;
        }

        .result-preview.positive {
            background: #e6f4ea;
            border: 1px solid #ceead6;
        }

        .result-preview.negative {
            background: #fce8e6;
            border: 1px solid #f5c6c3;
        }

        .result-preview.warning {
            background: #fef7e0;
            border: 1px solid #f5e6b3;
        }

        .result-preview.neutral {
            background: #f1f3f4;
            border: 1px solid #dadce0;
        }

        .result-preview-title {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px !important;
            font-weight: 500 !important;
            margin-bottom: 4px !important;
            font-style: normal !important;
        }

        .result-preview.positive .result-preview-title {
            color: #137333 !important;
        }

        .result-preview.negative .result-preview-title {
            color: #a50e0e !important;
        }

        .result-preview.warning .result-preview-title {
            color: #b06000 !important;
        }

        .result-preview.neutral .result-preview-title {
            color: #5f6368 !important;
        }

        .result-preview-title .material-icons-outlined {
            font-size: 20px;
        }

        .result-preview-text {
            font-size: 13px !important;
            font-style: normal !important;
        }

        .result-preview.positive .result-preview-text {
            color: #137333 !important;
        }

        .result-preview.negative .result-preview-text {
            color: #a50e0e !important;
        }

        .result-preview.warning .result-preview-text {
            color: #7a4200 !important;
        }

        .result-preview.neutral .result-preview-text {
            color: #5f6368 !important;
        }

        /* Info box */
        .info-box {
            display: flex;
            gap: 12px;
            padding: 16px;
            border-radius: 8px;
            background: #f8f9fa;
            border: 1px solid #e0e0e0;
        }

        .info-box.warning {
            background: #fef7e0;
            border-color: #f9ab00;
        }

        .info-box.error {
            background: #fce8e6;
            border-color: #ea4335;
        }

        .info-box-icon {
            flex-shrink: 0;
        }

        .info-box-icon .material-icons-outlined {
            font-size: 24px;
            color: #f9ab00;
        }

        .info-box.error .info-box-icon .material-icons-outlined {
            color: #ea4335;
        }

        .info-box-content {
            flex: 1;
        }

        .info-box-title {
            font-size: 14px;
            font-weight: 500;
            color: #202124;
            margin-bottom: 4px;
        }

        .info-box-text {
            font-size: 13px;
            color: #5f6368;
            line-height: 1.5;
        }

        .info-box-text ul {
            margin: 8px 0 0 0;
            padding-left: 20px;
        }

        .info-box-text li {
            margin-bottom: 4px;
        }

        /* Checklist items */
        .checklist-items {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .checklist-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 14px;
            background: #f8f9fa;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.15s;
        }

        .checklist-item:hover {
            background: #f0f0f0;
        }

        .checklist-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: #004289;
            flex-shrink: 0;
        }

        .checklist-item-content {
            flex: 1;
            min-width: 0;
        }

        .checklist-item-title {
            font-size: 13px;
            font-weight: 500;
            color: #202124;
        }

        .checklist-item-desc {
            font-size: 12px;
            color: #5f6368;
            margin-top: 2px;
        }

        .checklist-item-badge {
            font-size: 11px;
            padding: 2px 8px;
            border-radius: 4px;
            flex-shrink: 0;
        }

        .checklist-item-badge.ok {
            background: #e6f4ea;
            color: #137333;
        }

        .checklist-item-badge.neutral {
            background: #f1f3f4;
            color: #5f6368;
        }

        .checklist-item-badge.warning {
            background: #fef7e0;
            color: #7a4200;
        }

        /* Data card komponenty pro zobrazení načtených dat */
        .data-card {
            background: #fff;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            overflow: hidden;
        }

        .data-row {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            border-bottom: 1px solid #f1f3f4;
            gap: 12px;
        }

        .data-row:last-child {
            border-bottom: none;
        }

        .data-row.empty {
            background: #fafafa;
        }

        .data-row.error {
            background: #fce8e6;
        }

        .data-label {
            width: 180px;
            flex-shrink: 0;
            font-size: 12px;
            color: #5f6368;
            font-weight: 500;
        }

        .data-value {
            flex: 1;
            font-size: 13px;
            color: #202124;
        }

        .data-value.muted {
            color: #9aa0a6;
            font-style: italic;
        }

        .data-value .data-link {
            color: #1a73e8;
            cursor: pointer;
        }

        .data-value .data-link:hover {
            text-decoration: underline;
        }

        .data-status {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            transition: all 0.15s;
        }

        .data-status.ok {
            background: #e6f4ea;
            color: #137333;
        }

        .data-status.ok:hover {
            background: #ceead6;
        }

        .data-status.error {
            background: #fce8e6;
            color: #c5221f;
        }

        .data-status.error:hover {
            background: #f5c6c2;
        }

        .data-status.na {
            background: #f1f3f4;
            color: #9aa0a6;
            cursor: default;
        }

        .data-status .material-icons-outlined {
            font-size: 18px;
        }

        .deficiency-note-section {
            margin-top: 16px;
            padding: 16px;
            background: #fef7e0;
            border: 1px solid #f9ab00;
            border-radius: 8px;
        }

        .deficiency-note-section .control-section-title {
            margin-bottom: 12px;
        }

        .deficiency-note-input {
            width: 100%;
            min-height: 80px;
            padding: 12px;
            border: 1px solid #dadce0;
            border-radius: 6px;
            font-size: 13px;
            font-family: inherit;
            resize: vertical;
        }

        .deficiency-note-input:focus {
            outline: none;
            border-color: #1a73e8;
            box-shadow: 0 0 0 2px rgba(26, 115, 232, 0.2);
        }

        .checklist-label {
            flex: 1;
            font-size: 13px !important;
            color: #202124 !important;
            font-style: normal !important;
        }

        .checklist-note {
            font-size: 12px !important;
            color: #9aa0a6 !important;
            font-style: italic !important;
        }

        .checklist-item:has(input:not(:checked)) {
            opacity: 0.6;
        }

        /* ==========================================
           IDENTIFIKACE DO/TDI - Porovnávací matice
           ========================================== */
        .identifikace-ai-section {
            background: linear-gradient(135deg, #f0e6ff 0%, #e6f0ff 100%);
            border: 1px solid #d4c4f0;
            border-radius: 10px;
            padding: 16px;
            margin-bottom: 20px;
        }

        .identifikace-ai-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }

        .identifikace-ai-title {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            font-weight: 600;
            color: #5b21b6;
        }

        .identifikace-ai-title .material-icons-outlined {
            font-size: 18px;
            color: #7c3aed;
        }

        .btn-ai-analyze {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 14px;
            background: linear-gradient(135deg, #7c3aed 0%, #5b21b6 100%);
            color: #fff;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-ai-analyze:hover {
            background: linear-gradient(135deg, #6d28d9 0%, #4c1d95 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(124, 58, 237, 0.3);
        }

        .btn-ai-analyze:disabled {
            background: #d4c4f0;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-ai-analyze .material-icons-outlined {
            font-size: 16px;
        }

        .identifikace-ai-status {
            font-size: 12px;
            color: #5f6368;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .identifikace-ai-status.done {
            color: #137333;
        }

        .identifikace-ai-status .material-icons-outlined {
            font-size: 16px;
        }

        /* Porovnávací matice */
        .subjekty-matrix {
            background: #fff;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 20px;
        }

        .matrix-header {
            display: grid;
            grid-template-columns: 2fr 80px 80px 90px;
            gap: 8px;
            padding: 12px 16px;
            background: #f8f9fa;
            border-bottom: 1px solid #e0e0e0;
            font-size: 11px;
            font-weight: 600;
            color: #5f6368;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .matrix-header-cell {
            text-align: center;
        }

        .matrix-header-cell:first-child {
            text-align: left;
        }

        .matrix-group {
            border-bottom: 1px solid #e0e0e0;
        }

        .matrix-group:last-child {
            border-bottom: none;
        }

        .matrix-group-header {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            background: #f8f9fa;
            font-size: 12px;
            font-weight: 600;
            color: #202124;
            cursor: pointer;
        }

        .matrix-group-header .material-icons-outlined {
            font-size: 18px;
            color: #5f6368;
        }

        .matrix-group-header .group-count {
            margin-left: auto;
            padding: 2px 8px;
            background: #e8eaed;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 500;
            color: #5f6368;
        }

        .matrix-row {
            display: grid;
            grid-template-columns: 2fr 80px 80px 90px;
            gap: 8px;
            padding: 10px 16px;
            border-bottom: 1px solid #f0f0f0;
            align-items: center;
            transition: background 0.15s;
        }

        .matrix-row:last-child {
            border-bottom: none;
        }

        .matrix-row:hover {
            background: #f8f9fa;
        }

        .matrix-row.status-ok {
            background: #f0faf3;
        }

        .matrix-row.status-missing {
            background: #fef7e0;
        }

        .matrix-row.status-extra {
            background: #e8f4fd;
        }

        .matrix-row.status-not-required {
            opacity: 0.6;
        }

        .matrix-subjekt {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .matrix-subjekt-name {
            font-size: 13px;
            font-weight: 500;
            color: #202124;
        }

        .matrix-subjekt-detail {
            font-size: 11px;
            color: #5f6368;
        }

        .matrix-cell {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .matrix-check {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .matrix-check .material-icons-outlined {
            font-size: 16px;
        }

        .matrix-check.yes {
            background: #e6f4ea;
            color: #137333;
        }

        .matrix-check.no {
            background: #f5f5f5;
            color: #9aa0a6;
        }

        .matrix-check.missing {
            background: #fce8e6;
            color: #c5221f;
        }

        .matrix-checkbox {
            width: 20px;
            height: 20px;
            cursor: pointer;
            accent-color: #004289;
        }

        .matrix-docs-btn {
            width: 24px;
            height: 24px;
            border: none;
            background: transparent;
            color: #1a73e8;
            cursor: pointer;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .matrix-docs-btn:hover {
            background: #e8f1fa;
        }

        .matrix-docs-btn .material-icons-outlined {
            font-size: 18px;
        }

        /* Přidat subjekt */
        .matrix-add-row {
            display: flex;
            gap: 8px;
            padding: 12px 16px;
            background: #f8f9fa;
            border-top: 1px solid #e0e0e0;
        }

        .matrix-add-select {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #dadce0;
            border-radius: 6px;
            font-size: 13px;
            background: #fff;
            outline: none;
        }

        .matrix-add-select:focus {
            border-color: #1a73e8;
        }

        .matrix-add-input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #dadce0;
            border-radius: 6px;
            font-size: 13px;
            outline: none;
        }

        .matrix-add-input:focus {
            border-color: #1a73e8;
        }

        .btn-add-subjekt {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 8px 14px;
            background: #fff;
            border: 1px solid #dadce0;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            color: #5f6368;
            cursor: pointer;
            transition: all 0.15s;
        }

        .btn-add-subjekt:hover {
            background: #e8f1fa;
            border-color: #004289;
            color: #004289;
        }

        .btn-add-subjekt .material-icons-outlined {
            font-size: 16px;
        }

        /* Výsledek kontroly */
        .identifikace-result {
            background: #f8f9fa;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            padding: 16px;
            margin-bottom: 20px;
        }

        .identifikace-result-title {
            font-size: 12px;
            font-weight: 600;
            color: #5f6368;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            margin-bottom: 12px;
        }

        .identifikace-result-items {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .identifikace-result-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
        }

        .identifikace-result-item .material-icons-outlined {
            font-size: 18px;
        }

        .identifikace-result-item.ok {
            color: #137333;
        }

        .identifikace-result-item.warning {
            color: #b06000;
        }

        .identifikace-result-item.info {
            color: #004289;
        }

        .identifikace-result-item .count {
            font-weight: 600;
        }

        .identifikace-result-item .detail {
            font-size: 12px;
            color: #5f6368;
            margin-left: 4px;
        }

        /* Tooltip pro dokumenty */
        .docs-tooltip {
            position: absolute;
            background: #fff;
            border: 1px solid #dadce0;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            padding: 12px;
            z-index: 100;
            max-width: 280px;
            font-size: 12px;
        }

        .docs-tooltip-title {
            font-weight: 600;
            color: #202124;
            margin-bottom: 8px;
        }

        .docs-tooltip-item {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 4px 0;
            color: #5f6368;
        }

        .docs-tooltip-item .material-icons-outlined {
            font-size: 16px;
            color: #c62828;
        }

        /* Rozšířená matice - 5 sloupců */
        .matrix-header.extended {
            grid-template-columns: 2fr 70px 70px 100px 80px;
        }

        .matrix-row.extended {
            grid-template-columns: 2fr 70px 70px 100px 80px;
        }

        /* Výsledek dropdown */
        .matrix-vysledek-select {
            padding: 4px 8px;
            border: 1px solid #dadce0;
            border-radius: 4px;
            font-size: 11px;
            background: #fff;
            cursor: pointer;
            min-width: 90px;
        }

        .matrix-vysledek-select:focus {
            outline: none;
            border-color: #1a73e8;
        }

        .matrix-vysledek-select.kladne {
            background: #e6f4ea;
            border-color: #ceead6;
            color: #137333;
        }

        .matrix-vysledek-select.s-podminkami {
            background: #e8f1fa;
            border-color: #c2d9f2;
            color: #004289;
        }

        .matrix-vysledek-select.zaporne {
            background: #fce8e6;
            border-color: #f5c6c3;
            color: #c5221f;
        }

        /* Tlačítko podmínky */
        .btn-podminky {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 2px;
            padding: 4px 8px;
            border: 1px solid #dadce0;
            border-radius: 4px;
            background: #fff;
            font-size: 11px;
            color: #5f6368;
            cursor: pointer;
            transition: all 0.15s;
        }

        .btn-podminky:hover {
            background: #f1f3f4;
            border-color: #5f6368;
        }

        .btn-podminky.has-podminky {
            background: #e8f1fa;
            border-color: #004289;
            color: #004289;
        }

        .btn-podminky .material-icons-outlined {
            font-size: 14px;
        }

        .btn-podminky .podminky-count {
            font-weight: 600;
        }

        /* Modal pro podmínky */
        .podminky-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 3000;
        }

        .podminky-modal-overlay.open {
            display: flex;
        }

        .podminky-modal {
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            width: 700px;
            max-width: 95%;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
        }

        .podminky-modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 20px;
            border-bottom: 1px solid #e0e0e0;
            background: #f8f9fa;
            border-radius: 12px 12px 0 0;
        }

        .podminky-modal-title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 16px;
            font-weight: 600;
            color: #202124;
        }

        .podminky-modal-title .material-icons-outlined {
            font-size: 24px;
            color: #004289;
        }

        .podminky-modal-close {
            width: 32px;
            height: 32px;
            border: none;
            background: transparent;
            color: #5f6368;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .podminky-modal-close:hover {
            background: #e8eaed;
        }

        .podminky-modal-body {
            padding: 20px;
            overflow-y: auto;
            flex: 1;
        }

        .podminky-modal-footer {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: 12px;
            padding: 16px 20px;
            border-top: 1px solid #e0e0e0;
            background: #f8f9fa;
            border-radius: 0 0 12px 12px;
        }

        /* Sekce v modalu */
        .podminky-section {
            margin-bottom: 20px;
        }

        .podminky-section:last-child {
            margin-bottom: 0;
        }

        .podminky-section-title {
            font-size: 12px;
            font-weight: 600;
            color: #5f6368;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            margin-bottom: 12px;
        }

        /* Info o dokumentu */
        .dokument-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            padding: 16px;
            background: #f8f9fa;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
        }

        .dokument-info-item {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .dokument-info-label {
            font-size: 11px;
            color: #5f6368;
            text-transform: uppercase;
        }

        .dokument-info-value {
            font-size: 13px;
            color: #202124;
        }

        .dokument-info-value input {
            width: 100%;
            padding: 6px 10px;
            border: 1px solid #dadce0;
            border-radius: 4px;
            font-size: 13px;
        }

        .dokument-info-value input:focus {
            outline: none;
            border-color: #1a73e8;
        }

        /* Výsledek v modalu */
        .vysledek-options {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .vysledek-option {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.15s;
            flex: 1;
            min-width: 150px;
        }

        .vysledek-option:hover {
            border-color: #9aa0a6;
        }

        .vysledek-option.selected {
            border-color: #004289;
            background: #e8f1fa;
        }

        .vysledek-option.kladne.selected {
            border-color: #137333;
            background: #e6f4ea;
        }

        .vysledek-option.zaporne.selected {
            border-color: #c5221f;
            background: #fce8e6;
        }

        .vysledek-option input {
            display: none;
        }

        .vysledek-option-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .vysledek-option-icon .material-icons-outlined {
            font-size: 16px;
        }

        .vysledek-option.kladne .vysledek-option-icon {
            background: #e6f4ea;
            color: #137333;
        }

        .vysledek-option.s-podminkami .vysledek-option-icon {
            background: #e8f1fa;
            color: #004289;
        }

        .vysledek-option.zaporne .vysledek-option-icon {
            background: #fce8e6;
            color: #c5221f;
        }

        .vysledek-option-label {
            font-size: 13px;
            font-weight: 500;
            color: #202124;
        }

        /* Seznam podmínek */
        .podminky-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .podminka-item {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            padding: 12px;
            background: #fff;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
        }

        .podminka-item.inactive {
            opacity: 0.5;
            background: #f5f5f5;
        }

        .podminka-checkbox {
            margin-top: 2px;
        }

        .podminka-text {
            flex: 1;
            font-size: 13px;
            color: #202124;
            line-height: 1.5;
        }

        .podminka-text textarea {
            width: 100%;
            min-height: 60px;
            padding: 8px;
            border: 1px solid #dadce0;
            border-radius: 4px;
            font-size: 13px;
            font-family: inherit;
            resize: vertical;
        }

        .podminka-text textarea:focus {
            outline: none;
            border-color: #1a73e8;
        }

        .podminka-remove {
            width: 28px;
            height: 28px;
            border: none;
            background: transparent;
            color: #9aa0a6;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .podminka-remove:hover {
            background: #fce8e6;
            color: #c5221f;
        }

        .podminka-remove .material-icons-outlined {
            font-size: 18px;
        }

        /* Přidat podmínku */
        .add-podminka-row {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }

        .add-podminka-input {
            flex: 1;
            padding: 10px 12px;
            border: 1px solid #dadce0;
            border-radius: 6px;
            font-size: 13px;
        }

        .add-podminka-input:focus {
            outline: none;
            border-color: #1a73e8;
        }

        .btn-add-podminka {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 10px 16px;
            background: #fff;
            border: 1px solid #dadce0;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            color: #5f6368;
            cursor: pointer;
        }

        .btn-add-podminka:hover {
            background: #f1f3f4;
            border-color: #5f6368;
        }

        .btn-add-podminka .material-icons-outlined {
            font-size: 18px;
        }

        /* Poznámka úředníka */
        .poznamka-textarea {
            width: 100%;
            min-height: 80px;
            padding: 12px;
            border: 1px solid #dadce0;
            border-radius: 6px;
            font-size: 13px;
            font-family: inherit;
            resize: vertical;
        }

        .poznamka-textarea:focus {
            outline: none;
            border-color: #1a73e8;
        }

        /* Souhrn pro rozhodnutí */
        .souhrn-rozhodnuti {
            margin-top: 20px;
            padding: 16px;
            background: #f0f7ff;
            border: 1px solid #c2d9f2;
            border-radius: 10px;
        }

        .souhrn-rozhodnuti-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }

        .souhrn-rozhodnuti-title {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            font-weight: 600;
            color: #004289;
        }

        .souhrn-rozhodnuti-title .material-icons-outlined {
            font-size: 20px;
        }

        .btn-report {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 14px;
            background: #004289;
            border: none;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            color: #fff;
            cursor: pointer;
            transition: background 0.15s;
        }

        .btn-report:hover {
            background: #003066;
        }

        .btn-report .material-icons-outlined {
            font-size: 18px;
        }

        .souhrn-rozhodnuti-actions {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .souhrn-rozhodnuti-actions .btn-report {
            padding: 6px 12px;
            font-size: 12px;
            background: #fff;
            color: #004289;
            border: 1px solid #004289;
        }

        .souhrn-rozhodnuti-actions .btn-report:hover {
            background: #e8f1fa;
        }

        .souhrn-rozhodnuti-actions .btn-report .material-icons-outlined {
            font-size: 16px;
        }

        .souhrn-stats {
            display: flex;
            gap: 16px;
            flex-wrap: wrap;
        }

        /* Report modal */
        .report-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 3000;
        }

        .report-modal-overlay.open {
            display: flex;
        }

        .report-modal {
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            width: 900px;
            max-width: 95%;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
        }

        .report-modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 20px;
            border-bottom: 1px solid #e0e0e0;
            background: #f8f9fa;
            border-radius: 12px 12px 0 0;
        }

        .report-modal-title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 16px;
            font-weight: 600;
            color: #202124;
        }

        .report-modal-title .material-icons-outlined {
            font-size: 24px;
            color: #004289;
        }

        .report-modal-actions {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .report-modal-close {
            width: 32px;
            height: 32px;
            border: none;
            background: transparent;
            color: #5f6368;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .report-modal-close:hover {
            background: #e8eaed;
        }

        .report-modal-body {
            padding: 20px;
            overflow-y: auto;
            flex: 1;
        }

        .btn-download {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 14px;
            background: #fff;
            border: 1px solid #dadce0;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            color: #202124;
            cursor: pointer;
            transition: all 0.15s;
        }

        .btn-download:hover {
            background: #f1f3f4;
            border-color: #5f6368;
        }

        .btn-download .material-icons-outlined {
            font-size: 18px;
        }

        /* Report content styles */
        .report-content {
            font-family: 'Segoe UI', Roboto, sans-serif;
            font-size: 13px;
            line-height: 1.6;
            color: #202124;
        }

        .report-header {
            text-align: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 2px solid #004289;
        }

        .report-header h1 {
            font-size: 18px;
            font-weight: 600;
            color: #004289;
            margin: 0 0 8px 0;
        }

        .report-header .report-meta {
            font-size: 12px;
            color: #5f6368;
        }

        .report-section {
            margin-bottom: 24px;
        }

        .report-section h2 {
            font-size: 14px;
            font-weight: 600;
            color: #202124;
            margin: 0 0 12px 0;
            padding-bottom: 6px;
            border-bottom: 1px solid #e0e0e0;
        }

        .report-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 12px;
        }

        .report-table th,
        .report-table td {
            padding: 8px 10px;
            text-align: left;
            border: 1px solid #e0e0e0;
            font-size: 12px;
        }

        .report-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #5f6368;
        }

        .report-table tr:nth-child(even) {
            background: #fafafa;
        }

        .report-status {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 500;
        }

        .report-status.kladne {
            background: #e6f4ea;
            color: #137333;
        }

        .report-status.s-podminkami {
            background: #e8f1fa;
            color: #004289;
        }

        .report-status.zaporne {
            background: #fce8e6;
            color: #c5221f;
        }

        .report-status.chybi {
            background: #fff3e0;
            color: #e65100;
        }

        .report-podminky-list {
            margin: 0;
            padding-left: 20px;
        }

        .report-podminky-list li {
            margin-bottom: 4px;
        }

        .report-subjekt-block {
            margin-bottom: 16px;
            padding: 12px;
            background: #f8f9fa;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
        }

        .report-subjekt-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .report-subjekt-name {
            font-weight: 600;
            color: #202124;
        }

        .report-subjekt-meta {
            font-size: 11px;
            color: #5f6368;
            margin-bottom: 8px;
        }

        .report-no-podminky {
            font-style: italic;
            color: #9aa0a6;
            font-size: 12px;
        }

        .report-podminka-skupina {
            margin-bottom: 16px;
            padding: 12px 16px;
            background: #f8f9fa;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
        }

        .report-podminka-subjekt {
            font-size: 14px;
            margin-bottom: 8px;
        }

        .report-podminka-subjekt strong {
            color: #202124;
        }

        .report-podminka-subjekt span {
            margin-left: 12px;
            color: #5f6368;
            font-size: 12px;
        }

        .report-podminka-list {
            margin: 0;
            padding-left: 24px;
        }

        .report-podminka-list li {
            margin-bottom: 6px;
            line-height: 1.5;
        }

        .report-header h2 {
            font-size: 18px;
            font-weight: 600;
            color: #004289;
            margin: 0 0 8px 0;
        }

        .report-header h3 {
            color: #202124;
            border-bottom: 1px solid #e0e0e0;
            padding-bottom: 8px;
            margin-top: 24px;
            font-size: 14px;
        }

        .report-section h3 {
            color: #202124;
            border-bottom: 1px solid #e0e0e0;
            padding-bottom: 8px;
            margin: 0 0 12px 0;
            font-size: 14px;
        }

        .souhrn-stat {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
        }

        .souhrn-stat .material-icons-outlined {
            font-size: 18px;
        }

        .souhrn-stat.ok {
            color: #137333;
        }

        .souhrn-stat.podminky {
            color: #004289;
        }

        .souhrn-stat.warning {
            color: #b06000;
        }

        .souhrn-stat.error {
            color: #c5221f;
        }

        /* AI Control Section */
        .ai-control-section {
            background: linear-gradient(135deg, #f0e6ff 0%, #e6f0ff 100%);
            border: 1px solid #d4c4f0;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 24px;
        }

        .ai-control-header {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px !important;
            font-weight: 600 !important;
            color: #5b21b6 !important;
            margin-bottom: 12px;
            font-style: normal !important;
        }

        .ai-control-header .material-icons-outlined {
            font-size: 20px;
            color: #7c3aed;
        }

        .btn-ai {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 12px 20px;
            background: linear-gradient(135deg, #7c3aed 0%, #5b21b6 100%);
            color: #fff !important;
            border: none;
            border-radius: 8px;
            font-size: 14px !important;
            font-weight: 500 !important;
            cursor: pointer;
            transition: all 0.2s;
            font-style: normal !important;
        }

        .btn-ai:hover {
            background: linear-gradient(135deg, #6d28d9 0%, #4c1d95 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(124, 58, 237, 0.3);
        }

        .btn-ai:disabled {
            background: #d4c4f0;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-ai .material-icons-outlined {
            font-size: 18px;
        }

        /* AI Result Section */
        .ai-result-section {
            background: #f8f5ff;
            border: 1px solid #e4d9f5;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 24px;
        }

        .ai-result-header {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px !important;
            font-weight: 600 !important;
            color: #5b21b6 !important;
            margin-bottom: 16px;
            font-style: normal !important;
        }

        .ai-result-header .material-icons-outlined {
            font-size: 20px;
            color: #7c3aed;
        }

        .ai-result-badge {
            margin-left: auto;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px !important;
            font-weight: 500 !important;
        }

        .ai-result-badge.success {
            background: #dcfce7;
            color: #166534;
        }

        .ai-result-badge.loading {
            background: #fef3c7;
            color: #92400e;
        }

        .ai-report-link {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 16px;
            background: #fff;
            border: 1px solid #e4d9f5;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.15s;
            margin-bottom: 16px;
        }

        .ai-report-link:hover {
            background: #f5f0ff;
            border-color: #c4b5fd;
        }

        .ai-report-link .material-icons-outlined:first-child {
            font-size: 24px;
            color: #7c3aed;
        }

        .ai-report-link-content {
            flex: 1;
        }

        .ai-report-link-title {
            font-size: 14px !important;
            font-weight: 500 !important;
            color: #202124 !important;
            font-style: normal !important;
        }

        .ai-report-link-meta {
            font-size: 12px !important;
            color: #5f6368 !important;
            font-style: normal !important;
        }

        .ai-report-link .material-icons-outlined:last-child {
            font-size: 18px;
            color: #9aa0a6;
        }

        .ai-summary {
            display: flex;
            gap: 16px;
        }

        .ai-summary-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 13px !important;
            font-style: normal !important;
        }

        .ai-summary-item .material-icons-outlined {
            font-size: 18px;
        }

        .ai-summary-item.success {
            color: #166534 !important;
        }

        .ai-summary-item.warning {
            color: #92400e !important;
        }

        .ai-summary-item.error {
            color: #991b1b !important;
        }

        /* AI Report Detail */
        .ai-report-detail {
            background: #fff;
            border: 1px solid #e4d9f5;
            border-radius: 12px;
            margin-bottom: 24px;
            max-height: 400px;
            overflow-y: auto;
        }

        .ai-report-detail-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 20px;
            border-bottom: 1px solid #e4d9f5;
            background: #f8f5ff;
            border-radius: 12px 12px 0 0;
            position: sticky;
            top: 0;
            z-index: 1;
        }

        .ai-report-detail-title {
            font-size: 14px !important;
            font-weight: 600 !important;
            color: #5b21b6 !important;
            font-style: normal !important;
        }

        .ai-report-close {
            width: 28px;
            height: 28px;
            border: none;
            background: transparent;
            color: #5f6368;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .ai-report-close:hover {
            background: #e4d9f5;
        }

        .ai-report-content {
            padding: 16px 20px;
        }

        .ai-report-group {
            margin-bottom: 20px;
        }

        .ai-report-group:last-child {
            margin-bottom: 0;
        }

        .ai-report-group-title {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px !important;
            font-weight: 600 !important;
            margin-bottom: 12px;
            font-style: normal !important;
        }

        .ai-report-group-title .material-icons-outlined {
            font-size: 18px;
        }

        .ai-report-group-title.success {
            color: #166534 !important;
        }

        .ai-report-group-title.warning {
            color: #92400e !important;
        }

        .ai-report-group-title.error {
            color: #991b1b !important;
        }

        .ai-report-item {
            background: #f8f9fa;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 14px 16px;
            margin-bottom: 8px;
        }

        .ai-report-item:last-child {
            margin-bottom: 0;
        }

        .ai-report-item-title {
            font-size: 13px !important;
            font-weight: 500 !important;
            color: #202124 !important;
            font-style: normal !important;
        }

        .ai-report-item-result {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px !important;
            font-weight: 500 !important;
            margin-top: 4px;
            font-style: normal !important;
        }

        .ai-report-item-result.success {
            background: #dcfce7;
            color: #166534;
        }

        .ai-report-item-result.warning {
            background: #fef3c7;
            color: #92400e;
        }

        .ai-report-item-result.error {
            background: #fee2e2;
            color: #991b1b;
        }

        .ai-report-item-detail {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid #e0e0e0;
        }

        .ai-report-source {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
            font-size: 12px !important;
            font-style: normal !important;
        }

        .source-label {
            color: #5f6368 !important;
            flex-shrink: 0;
        }

        .source-path {
            color: #1a73e8 !important;
            font-family: 'Roboto Mono', monospace !important;
            font-size: 11px !important;
        }

        .ai-report-note {
            font-size: 12px !important;
            color: #5f6368 !important;
            margin-top: 8px;
            padding: 8px 12px;
            background: #e8f5e9;
            border-radius: 6px;
            font-style: normal !important;
        }

        .ai-report-note.warning {
            background: #fff8e1;
            color: #795548 !important;
            display: flex;
            align-items: flex-start;
            gap: 8px;
        }

        .ai-report-note.warning .material-icons-outlined {
            font-size: 16px;
            color: #f57c00;
            flex-shrink: 0;
            margin-top: 1px;
        }

        .ai-report-item.collapsed .ai-report-item-detail {
            display: none;
        }

        .ai-report-item.collapsed {
            padding: 10px 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .ai-report-item.collapsed .ai-report-item-title {
            margin-bottom: 0;
        }

        .ai-report-item.collapsed .ai-report-item-result {
            margin-top: 0;
        }

        /* Loading animation */
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .btn-ai.loading {
            animation: pulse 1.5s infinite;
        }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translate(-50%, -20px);
            }
            to {
                opacity: 1;
                transform: translate(-50%, 0);
            }
        }
        
        @keyframes slideUp {
            from {
                opacity: 1;
                transform: translate(-50%, 0);
            }
            to {
                opacity: 0;
                transform: translate(-50%, -20px);
            }
        }
        
        @keyframes toastIn {
            from {
                opacity: 0;
                transform: translate(-50%, 20px);
            }
            to {
                opacity: 1;
                transform: translate(-50%, 0);
            }
        }
        
        @keyframes toastOut {
            from {
                opacity: 1;
                transform: translate(-50%, 0);
            }
            to {
                opacity: 0;
                transform: translate(-50%, 20px);
            }
        }

        /* Modal styles - pro pomocné modály */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .modal-overlay.open {
            display: flex;
        }

        .modal,
        .modal-dialog {
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            max-width: 560px;
            width: 90%;
            max-height: 90vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .modal.modal-large {
            max-width: 900px;
        }

        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 20px;
            border-bottom: 1px solid #e0e0e0;
            flex-shrink: 0;
        }

        .modal-title {
            display: flex !important;
            align-items: center !important;
            gap: 10px !important;
            font-size: 16px !important;
            font-weight: 500 !important;
            color: #202124 !important;
            font-style: normal !important;
        }

        .modal-title .material-icons-outlined {
            font-size: 24px !important;
            color: #004289 !important;
        }

        .modal-close {
            width: 36px;
            height: 36px;
            border: none;
            background: transparent;
            color: #5f6368;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-close:hover {
            background: #f1f3f4;
        }

        .modal-body {
            padding: 20px;
            overflow-y: auto;
            flex: 1;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            padding: 16px 20px;
            border-top: 1px solid #e0e0e0;
            background: #fafafa;
            flex-shrink: 0;
        }

        /* Form elements in modal */
        .form-group {
            margin-bottom: 16px;
        }

        .form-group:last-child {
            margin-bottom: 0;
        }

        .form-label {
            display: block !important;
            font-size: 13px !important;
            font-weight: 500 !important;
            color: #202124 !important;
            margin-bottom: 6px !important;
        }

        .form-select {
            width: 100% !important;
            padding: 10px 12px !important;
            border: 1px solid #dadce0 !important;
            border-radius: 6px !important;
            font-size: 14px !important;
            color: #202124 !important;
            background: #fff !important;
        }

        .form-select:focus {
            outline: none;
            border-color: #004289;
        }

        .form-check-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .form-check {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
            cursor: pointer;
        }

        .form-check:hover {
            background: #f0f0f0;
        }

        .form-check input[type="radio"],
        .form-check input[type="checkbox"] {
            width: 18px;
            height: 18px;
            margin-top: 2px;
            accent-color: #004289;
        }

        .form-check-content {
            flex: 1;
        }

        .form-check-label {
            font-size: 14px !important;
            font-weight: 500 !important;
            color: #202124 !important;
            font-style: normal !important;
        }

        .form-check-desc {
            font-size: 12px !important;
            color: #5f6368 !important;
            margin-top: 2px !important;
            font-style: normal !important;
        }

        /* Result box */
        .result-box {
            padding: 16px;
            border-radius: 8px;
            margin-top: 16px;
        }

        .result-box.success {
            background: #e6f4ea;
            border: 1px solid #ceead6;
        }

        .result-box.warning {
            background: #fef7e0;
            border: 1px solid #f5e6b3;
        }

        .result-box.error {
            background: #fce8e6;
            border: 1px solid #f5c6c3;
        }

        .result-box-title {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 4px;
        }

        .result-box.success .result-box-title {
            color: #137333;
        }

        .result-box.warning .result-box-title {
            color: #b06000;
        }

        .result-box.error .result-box-title {
            color: #c5221f;
        }

        .result-box-title .material-icons-outlined {
            font-size: 20px;
        }

        .result-box-text {
            font-size: 13px;
        }

        .result-box.success .result-box-text {
            color: #137333;
        }

        .result-box.warning .result-box-text {
            color: #7a4200;
        }

        .result-box.error .result-box-text {
            color: #a50e0e;
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .control-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .case-header-main {
                padding: 12px 16px;
                flex-direction: column;
                align-items: flex-start;
            }

            .document-access-bar {
                padding: 10px 16px;
                flex-wrap: wrap;
            }

            .page-content {
                padding: 16px;
            }

            .control-grid {
                grid-template-columns: 1fr;
            }

            .summary-card {
                flex-direction: column;
                text-align: center;
            }

            .summary-actions {
                width: 100%;
            }

            .summary-actions .btn {
                flex: 1;
            }
        }
    </style>
</head>
<body>
    <!-- ISSŘ Hlavička -->
    <header class="issr-header">
        <a href="../index.html" class="issr-header__logo">
            <img src="../images/logo-issr.png" alt="ISSŘ Logo" class="issr-header__logo-img">
            <span class="issr-header__title">INFORMAČNÍ SYSTÉM STAVEBNÍHO ŘÍZENÍ</span>
        </a>
        
        <div class="issr-header__search">
            <input type="text" class="issr-header__search-input" placeholder="Hledat">
        </div>
        
        <div class="issr-header__actions">
            <div class="issr-header__notification">
                <svg class="issr-header__notification-icon" viewBox="0 0 16 16" fill="currentColor">
                    <path d="M8 16a2 2 0 0 0 2-2H6a2 2 0 0 0 2 2M8 1.918l-.797.161A4 4 0 0 0 4 6c0 .628-.134 2.197-.459 3.742-.16.767-.376 1.566-.663 2.258h10.244c-.287-.692-.502-1.49-.663-2.258C12.134 8.197 12 6.628 12 6a4 4 0 0 0-3.203-3.92zM14.22 12c.223.447.481.801.78 1H1c.299-.199.557-.553.78-1C2.68 10.2 3 6.88 3 6c0-2.42 1.72-4.44 4.005-4.901a1 1 0 1 1 1.99 0A5 5 0 0 1 13 6c0 .88.32 4.2 1.22 6"></path>
                </svg>
                <span class="issr-header__notification-badge">2</span>
            </div>
            
            <div class="issr-header__user">
                <span>Aleš Krupa</span>
                <svg class="issr-header__user-icon" viewBox="0 0 16 16" fill="currentColor">
                    <path d="M8 8a3 3 0 1 0 0-6 3 3 0 0 0 0 6m2-3a2 2 0 1 1-4 0 2 2 0 0 1 4 0m4 8c0 1-1 1-1 1H3s-1 0-1-1 1-4 6-4 6 3 6 4m-1-.004c-.001-.246-.154-.986-.832-1.664C11.516 10.68 10.289 10 8 10s-3.516.68-4.168 1.332c-.678.678-.83 1.418-.832 1.664z"></path>
                </svg>
            </div>
        </div>
    </header>

    <main class="main-content">
        <!-- Case header -->
        <header class="case-header">
            <div class="case-header-main">
                <div class="case-header-left">
                    <a href="detail-dokumentu.html" class="btn-back" title="Zpět na detail dokumentu">
                        <span class="material-icons-outlined">arrow_back</span>
                    </a>
                    <div class="case-info">
                        <div class="case-number">SZ DESU/000612/26</div>
                        <h1 class="case-title" id="caseTitleHeader">Oprava zabezpečovacího zařízení v žst. Doudleby n. Orlicí</h1>
                        <div class="case-meta">
                            <a href="../pages/detail-zameru.html" class="case-meta-item case-meta-link" title="Otevřít detail záměru">
                                <span class="material-icons-outlined">inventory_2</span>
                                Záměr Z/2026/1596
                            </a>
                            <span class="case-meta-item">
                                <span class="material-icons-outlined">gavel</span>
                                Povolení stavby
                            </span>
                            <span class="case-meta-item">
                                <span class="material-icons-outlined">train</span>
                                Stavba dráhy
                            </span>
                            <span class="case-badge draft">Kontrola</span>
                            <span class="case-badge fast" id="badgeZrychlene" style="display:none;">
                                <span class="material-icons-outlined" style="font-size: 14px;">bolt</span>
                                Zrychlené řízení
                            </span>
                        </div>
                    </div>
                </div>
                
                <!-- Akční tlačítka -->
                <div class="case-header-actions">
                    <button class="header-action-btn" onclick="openSlideout('udajeRizeni')" title="Údaje řízení">
                        <span class="material-icons-outlined">assignment</span>
                        Údaje řízení
                    </button>
                    <button class="header-action-btn has-issues" onclick="openSlideout('prehledNedostatku')" id="btnNedostatky" title="Přehled nedostatků">
                        <span class="material-icons-outlined">warning_amber</span>
                        Nedostatky
                        <span class="header-action-badge warning" id="nedostatkyBadge">0</span>
                    </button>
                    <div class="action-dropdown">
                        <button class="header-action-btn" onclick="toggleActionDropdown()" id="btnAkceRizeni">
                            <span class="material-icons-outlined">more_vert</span>
                            Akce řízení
                            <span class="material-icons-outlined" style="font-size: 16px; margin-left: -2px;">expand_more</span>
                        </button>
                        <div class="action-dropdown-menu" id="akceRizeniDropdown">
                            <div class="action-dropdown-item" onclick="showActionModal('prerusit')">
                                <span class="material-icons-outlined">pause_circle</span>
                                Přerušit řízení
                            </div>
                            <div class="action-dropdown-item" onclick="showActionModal('postoupit')">
                                <span class="material-icons-outlined">send</span>
                                Postoupit řízení
                            </div>
                            <div class="action-dropdown-item" onclick="showActionModal('predat')">
                                <span class="material-icons-outlined">person_add</span>
                                Předat jinému referentovi
                            </div>
                            <div class="action-dropdown-item" onclick="showActionModal('spojit')">
                                <span class="material-icons-outlined">merge</span>
                                Spojit s jiným řízením
                            </div>
                            <div class="action-dropdown-divider"></div>
                            <div class="action-dropdown-item" onclick="showActionModal('historie')">
                                <span class="material-icons-outlined">history</span>
                                Historie řízení
                            </div>
                            <div class="action-dropdown-divider"></div>
                            <div class="action-dropdown-item danger" onclick="showActionModal('zastavit')">
                                <span class="material-icons-outlined">cancel</span>
                                Zastavit řízení (zpětvzetí)
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Workflow stepper + document access -->
            <div class="workflow-bar" style="display: flex !important; align-items: center !important; justify-content: space-between !important; padding: 12px 32px !important; background: #f8f9fa !important; flex-wrap: nowrap !important;">
                <!-- Document access buttons - vlevo -->
                <div class="document-access-buttons" style="display: flex !important; gap: 8px !important; flex-wrap: nowrap !important;">
                    <a href="#" class="doc-access-btn" style="display: inline-flex !important; align-items: center !important; gap: 6px !important; padding: 6px 12px !important; background: #fff !important; border: 1px solid #dadce0 !important; border-radius: 6px !important; font-size: 12px !important; font-weight: 400 !important; color: #202124 !important; text-decoration: none !important; white-space: nowrap !important;" onclick="openDocModal('zadostModal'); return false;">
                        <span class="material-icons-outlined" style="font-size: 16px !important; color: #5f6368 !important;">description</span>
                        Žádost
                    </a>
                    <a href="#" class="doc-access-btn" style="display: inline-flex !important; align-items: center !important; gap: 6px !important; padding: 6px 12px !important; background: #fff !important; border: 1px solid #dadce0 !important; border-radius: 6px !important; font-size: 12px !important; font-weight: 400 !important; color: #202124 !important; text-decoration: none !important; white-space: nowrap !important;" onclick="openDocModal('prilohyModal'); return false;">
                        <span class="material-icons-outlined" style="font-size: 16px !important; color: #5f6368 !important;">attach_file</span>
                        Přílohy
                        <span class="badge" style="background: #e8f4fd !important; color: #004289 !important; padding: 2px 6px !important; border-radius: 10px !important; font-size: 10px !important; font-weight: 500 !important;">12</span>
                    </a>
                    <a href="#" class="doc-access-btn" style="display: inline-flex !important; align-items: center !important; gap: 6px !important; padding: 6px 12px !important; background: #fff !important; border: 1px solid #dadce0 !important; border-radius: 6px !important; font-size: 12px !important; font-weight: 400 !important; color: #202124 !important; text-decoration: none !important; white-space: nowrap !important;" onclick="openDocModal('eedModal'); return false;">
                        <span class="material-icons-outlined" style="font-size: 16px !important; color: #5f6368 !important;">folder</span>
                        El. dokumentace
                    </a>
                    <a href="#" class="doc-access-btn" style="display: inline-flex !important; align-items: center !important; gap: 6px !important; padding: 6px 12px !important; background: #fff !important; border: 1px solid #dadce0 !important; border-radius: 6px !important; font-size: 12px !important; font-weight: 400 !important; color: #202124 !important; text-decoration: none !important; white-space: nowrap !important;" onclick="openDocModal('dokladyModal'); return false;">
                        <span class="material-icons-outlined" style="font-size: 16px !important; color: #5f6368 !important;">fact_check</span>
                        Dokladová část
                    </a>
                    <a href="#" class="doc-access-btn" style="display: inline-flex !important; align-items: center !important; gap: 6px !important; padding: 6px 12px !important; background: #fff !important; border: 1px solid #dadce0 !important; border-radius: 6px !important; font-size: 12px !important; font-weight: 400 !important; color: #202124 !important; text-decoration: none !important; white-space: nowrap !important;" onclick="openDocModal('bimModal'); return false;">
                        <span class="material-icons-outlined" style="font-size: 16px !important; color: #5f6368 !important;">view_in_ar</span>
                        BIM model
                    </a>
                </div>
                <!-- Workflow stepper - vpravo -->
                <div class="workflow-stepper" style="display: flex !important; align-items: center !important; gap: 8px !important; flex-wrap: nowrap !important;">
                    <div class="workflow-step active" style="display: inline-flex !important; align-items: center !important; gap: 6px !important; padding: 6px 12px !important; border-radius: 16px !important; font-size: 12px !important; font-weight: 400 !important; background: #004289 !important; border: 1px solid #004289 !important; color: #fff !important; white-space: nowrap !important;">
                        <span class="step-number" style="width: 20px !important; height: 20px !important; min-width: 20px !important; border-radius: 50% !important; background: rgba(255,255,255,0.2) !important; color: #fff !important; display: inline-flex !important; align-items: center !important; justify-content: center !important; font-size: 11px !important; font-weight: 500 !important;">1</span>
                        <span style="font-weight: 400 !important;">Příprava řízení</span>
                    </div>
                    <div class="workflow-step-connector" style="width: 24px !important; height: 2px !important; min-width: 24px !important; background: #dadce0 !important; flex-shrink: 0 !important;"></div>
                    <div class="workflow-step" style="display: inline-flex !important; align-items: center !important; gap: 6px !important; padding: 6px 12px !important; border-radius: 16px !important; font-size: 12px !important; font-weight: 400 !important; background: #fff !important; border: 1px solid #e0e0e0 !important; color: #5f6368 !important; white-space: nowrap !important;">
                        <span class="step-number" style="width: 20px !important; height: 20px !important; min-width: 20px !important; border-radius: 50% !important; background: #e0e0e0 !important; color: #5f6368 !important; display: inline-flex !important; align-items: center !important; justify-content: center !important; font-size: 11px !important; font-weight: 500 !important;">2</span>
                        <span style="font-weight: 400 !important;">Projednání</span>
                    </div>
                    <div class="workflow-step-connector" style="width: 24px !important; height: 2px !important; min-width: 24px !important; background: #dadce0 !important; flex-shrink: 0 !important;"></div>
                    <div class="workflow-step" style="display: inline-flex !important; align-items: center !important; gap: 6px !important; padding: 6px 12px !important; border-radius: 16px !important; font-size: 12px !important; font-weight: 400 !important; background: #fff !important; border: 1px solid #e0e0e0 !important; color: #5f6368 !important; white-space: nowrap !important;">
                        <span class="step-number" style="width: 20px !important; height: 20px !important; min-width: 20px !important; border-radius: 50% !important; background: #e0e0e0 !important; color: #5f6368 !important; display: inline-flex !important; align-items: center !important; justify-content: center !important; font-size: 11px !important; font-weight: 500 !important;">3</span>
                        <span style="font-weight: 400 !important;">Rozhodnutí</span>
                    </div>
                </div>
            </div>
        </header>

        <!-- Page content -->
        <div class="page-content">
            <!-- Info panel -->
            <div class="info-panel" id="infoPanel">
                <span class="material-icons-outlined">info</span>
                <div class="info-panel-content">
                    <div class="info-panel-title">Kontrola a příprava řízení</div>
                    <div class="info-panel-text">
                        V tomto kroku proveďte kontroly žádosti a definujte parametry řízení (účastníci, pozemky, dotčené orgány). 
                        Řízení je zahájeno dnem doručení bezvadné žádosti (6. 1. 2026), od tohoto data běží lhůta pro vydání rozhodnutí.
                    </div>
                </div>
            </div>

            <!-- Základní údaje řízení -->
            <div class="rizeni-header-card" style="background: #fff; border: 1px solid #e0e0e0; border-radius: 8px; padding: 20px; margin-bottom: 24px;">
                <div style="display: flex; align-items: flex-start; gap: 24px; flex-wrap: wrap;">
                    <!-- Název stavby - editovatelný -->
                    <div style="flex: 2; min-width: 300px;">
                        <label style="display: block; font-size: 12px; font-weight: 500; color: #5f6368; margin-bottom: 6px;">
                            Název stavby
                            <span style="font-weight: 400; color: #80868b;">(lze upravit)</span>
                        </label>
                        <input type="text" id="nazevStavby" value="Oprava zabezpečovacího zařízení v žst. Doudleby n. Orlicí" 
                            style="width: 100%; padding: 10px 12px; border: 1px solid #dadce0; border-radius: 6px; font-size: 14px; font-family: inherit; color: #202124; background: #fff;"
                            onchange="updateNazevStavby()">
                    </div>
                    <!-- Typ řízení - readonly -->
                    <div style="flex: 1; min-width: 200px;">
                        <label style="display: block; font-size: 12px; font-weight: 500; color: #5f6368; margin-bottom: 6px;">
                            Typ řízení
                            <span style="font-weight: 400; color: #80868b;">(dle žádosti)</span>
                        </label>
                        <div style="padding: 10px 12px; border: 1px solid #e8eaed; border-radius: 6px; font-size: 14px; color: #202124; background: #f8f9fa;">
                            Povolení stavby
                        </div>
                    </div>
                    <!-- Datum doručení -->
                    <div style="flex: 0 0 auto; min-width: 150px;">
                        <label style="display: block; font-size: 12px; font-weight: 500; color: #5f6368; margin-bottom: 6px;">
                            Datum doručení žádosti
                        </label>
                        <div style="padding: 10px 12px; border: 1px solid #e8eaed; border-radius: 6px; font-size: 14px; color: #202124; background: #f8f9fa;">
                            6. 1. 2026
                        </div>
                    </div>
                </div>
                
                <!-- Popis stavby - rozbalovací sekce -->
                <div class="popis-stavby-section" id="popisStavbySection" style="margin-top: 16px; border-top: 1px solid #e8eaed; padding-top: 12px;">
                    <!-- Sbalený stav - pouze titulek a ikona -->
                    <div class="popis-stavby-collapsed" id="popisStavbyCollapsed" style="display: flex; align-items: center; justify-content: space-between; cursor: pointer;" onclick="expandPopisStavby()">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span class="material-icons-outlined" style="font-size: 18px; color: #5f6368;">description</span>
                            <span style="font-size: 13px; font-weight: 500; color: #3c4043;">Popis stavby</span>
                            <span id="popisStatusBadge" class="popis-status-badge" style="display: none; font-size: 11px; padding: 2px 8px; border-radius: 10px; background: #e8f5e9; color: #137333;">Vyplněno</span>
                        </div>
                        <button class="popis-expand-btn" style="display: flex; align-items: center; gap: 4px; padding: 4px 10px; background: transparent; border: 1px solid #dadce0; border-radius: 4px; font-size: 12px; color: #1a73e8; cursor: pointer;" title="Rozbalit popis">
                            <span class="material-icons-outlined" style="font-size: 16px;">expand_more</span>
                        </button>
                    </div>
                    
                    <!-- Rozbalený editor -->
                    <div id="popisStavbyEditor" class="popis-editor" style="display: none; margin-top: 12px;">
                        <div class="popis-editor-hint" style="font-size: 11px; color: #5f6368; margin-bottom: 8px; line-height: 1.4;">
                            <span class="material-icons-outlined" style="font-size: 14px; vertical-align: middle; margin-right: 4px;">info</span>
                            Popis bude použit v úředních dokumentech (vyrozumění o zahájení řízení, oznámení účastníkům). 
                            Měl by obsahovat základní informace o stavbě srozumitelné i pro laiky.
                        </div>
                        <textarea id="popisStavbyTextarea" class="popis-textarea" rows="8" 
                            placeholder="Popište stavbu tak, aby účastníci řízení získali základní představu o záměru...">Předmětem řízení je oprava zabezpečovacího zařízení v žst. Doudleby nad Orlicí na trati č. 010 Pardubice – Lichkov st. hr. Záměr zahrnuje výměnu reléového zabezpečovacího zařízení za elektronické stavědlo, úpravy kabelových tras, přejezdových zabezpečovacích zařízení a sdělovacího zařízení. Stavba je členěna na provozní soubory (PS) a stavební objekty (SO) v k.ú. Doudleby nad Orlicí, Kostelec nad Orlicí, Vamberk a Záměl.</textarea>
                        
                        <div class="popis-editor-actions" style="display: flex; align-items: center; justify-content: space-between; margin-top: 12px; flex-wrap: wrap; gap: 12px;">
                            <button class="popis-ai-btn" onclick="loadPopisFromAI()" id="popisAiBtn">
                                <span class="material-icons-outlined">auto_awesome</span>
                                <span class="popis-ai-text">Načíst z dokumentace (AI)</span>
                                <span class="popis-ai-loading" style="display: none;">
                                    <span class="material-icons-outlined spinning">sync</span>
                                    Načítám z B. Souhrnná technická zpráva...
                                </span>
                            </button>
                            <div style="display: flex; gap: 8px;">
                                <button class="btn btn-secondary" onclick="cancelPopisStavby()">Zrušit</button>
                                <button class="btn btn-primary" onclick="savePopisStavby()">
                                    <span class="material-icons-outlined">check</span>
                                    Uložit popis
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Section header -->
            <div class="section-header">
                <div class="section-title">
                    <span class="material-icons-outlined">checklist</span>
                    Kontrolní panel
                    <button class="section-customize-btn" onclick="openCustomizeControlsModal()" title="Upravit uspořádání kontrol">
                        <span class="material-icons-outlined">tune</span>
                    </button>
                </div>
                <div class="section-progress">
                    <span id="progressText">0 z 9 kontrol</span>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <!-- Control cards -->
            <div class="control-grid">
                <!-- 1. Příslušnost -->
                <div class="control-card status-ready" id="card-prislusnost">
                    <div class="control-card-header">
                        <div class="control-card-icon">
                            <span class="material-icons-outlined">account_balance</span>
                        </div>
                        <span class="control-card-status">K provedení</span>
                    </div>
                    <div class="control-card-body">
                        <div class="control-card-title">Příslušnost</div>
                        <div class="control-card-desc">Ověření věcné a místní příslušnosti stavebního úřadu</div>
                        <button class="control-card-action" onclick="openControl('controlPrislusnost')">
                            <span class="material-icons-outlined">play_arrow</span>
                            Provést kontrolu
                        </button>
                    </div>
                </div>

                <!-- 2. Kontrola žádosti -->
                <div class="control-card status-waiting disabled" id="card-zadost">
                    <div class="control-card-header">
                        <div class="control-card-icon">
                            <span class="material-icons-outlined">fact_check</span>
                        </div>
                        <span class="control-card-status">Čeká</span>
                    </div>
                    <div class="control-card-body">
                        <div class="control-card-title">Kontrola žádosti</div>
                        <div class="control-card-desc">Náležitosti žádosti podle § 184 a § 185 SZ</div>
                        <button class="control-card-action">
                            <span class="material-icons-outlined">lock</span>
                            Nejprve příslušnost
                        </button>
                    </div>
                </div>

                <!-- 3. Dokumentace -->
                <div class="control-card status-waiting disabled" id="card-dokumentace">
                    <div class="control-card-header">
                        <div class="control-card-icon">
                            <span class="material-icons-outlined">architecture</span>
                        </div>
                        <span class="control-card-status">Čeká</span>
                    </div>
                    <div class="control-card-body">
                        <div class="control-card-title">Dokumentace</div>
                        <div class="control-card-desc">Kontrola úplnosti, podpisů a formátu projektové dokumentace</div>
                        <button class="control-card-action">
                            <span class="material-icons-outlined">lock</span>
                            Nejprve kontrola žádosti
                        </button>
                    </div>
                </div>

                <!-- 4. Pozemky -->
                <div class="control-card status-waiting disabled" id="card-pozemky">
                    <div class="control-card-header">
                        <div class="control-card-icon">
                            <span class="material-icons-outlined">terrain</span>
                        </div>
                        <span class="control-card-status">Čeká</span>
                    </div>
                    <div class="control-card-body">
                        <div class="control-card-title">Pozemky</div>
                        <div class="control-card-desc">Ověření pozemků záměru a identifikace sousedních parcel</div>
                        <button class="control-card-action">
                            <span class="material-icons-outlined">lock</span>
                            Nejprve dokumentace
                        </button>
                    </div>
                </div>

                <!-- 5. Soulad s ÚPD -->
                <div class="control-card status-waiting disabled" id="card-up">
                    <div class="control-card-header">
                        <div class="control-card-icon">
                            <span class="material-icons-outlined">map</span>
                        </div>
                        <span class="control-card-status">Čeká</span>
                    </div>
                    <div class="control-card-body">
                        <div class="control-card-title">Soulad s ÚPD</div>
                        <div class="control-card-desc">Kontrola souladu záměru s územně plánovací dokumentací</div>
                        <button class="control-card-action">
                            <span class="material-icons-outlined">lock</span>
                            Nejprve pozemky
                        </button>
                    </div>
                </div>

                <!-- 6. Dokladová část (sloučeno z Identifikace DO a Dokladová část) -->
                <div class="control-card status-waiting disabled" id="card-identifikace">
                    <div class="control-card-header">
                        <div class="control-card-icon">
                            <span class="material-icons-outlined">fact_check</span>
                        </div>
                        <span class="control-card-status">Čeká</span>
                    </div>
                    <div class="control-card-body">
                        <div class="control-card-title">Dokladová část</div>
                        <div class="control-card-desc">Stanoviska DO a vyjádření vlastníků sítí</div>
                        <button class="control-card-action">
                            <span class="material-icons-outlined">lock</span>
                            Nejprve pozemky
                        </button>
                    </div>
                </div>

                <!-- 7. Osoby -->
                <div class="control-card status-waiting disabled" id="card-ucastnici">
                    <div class="control-card-header">
                        <div class="control-card-icon">
                            <span class="material-icons-outlined">groups</span>
                        </div>
                        <span class="control-card-status">Čeká</span>
                    </div>
                    <div class="control-card-body">
                        <div class="control-card-title">Osoby</div>
                        <div class="control-card-desc">Ověření vlastníků pozemků a definice osob v řízení</div>
                        <button class="control-card-action">
                            <span class="material-icons-outlined">lock</span>
                            Nejprve pozemky
                        </button>
                    </div>
                </div>

                <!-- 9. Zrychlené řízení -->
                <div class="control-card status-waiting disabled" id="card-zrychlene">
                    <div class="control-card-header">
                        <div class="control-card-icon">
                            <span class="material-icons-outlined">bolt</span>
                        </div>
                        <span class="control-card-status">Čeká</span>
                    </div>
                    <div class="control-card-body">
                        <div class="control-card-title">Zrychlené řízení</div>
                        <div class="control-card-desc">Ověření podmínek pro zrychlené řízení</div>
                        <button class="control-card-action">
                            <span class="material-icons-outlined">lock</span>
                            Nejprve ostatní kontroly
                        </button>
                    </div>
                </div>
            </div>

            <!-- Summary / Action bar -->
            <div class="summary-card">
                <div class="summary-content">
                    <div class="summary-title" id="summaryTitle">Dokončete všechny kontroly</div>
                    <div class="summary-desc" id="summaryDesc">Po dokončení všech kontrol bude možné řízení zahájit.</div>
                </div>
                <div class="summary-actions">
                    <button class="btn btn-primary" id="btnZahajit" disabled onclick="zahajitRizeni()">
                        <span class="material-icons-outlined">play_circle</span>
                        Zahájit řízení
                    </button>
                </div>
            </div>
        </div>
    </main>

    <!-- ============================================ -->
    <!-- KONTROLNÍ OVERLAYE - DVOUPANELOVÝ LAYOUT -->
    <!-- ============================================ -->

    <!-- Kontrola: Příslušnost (všechny podklady) -->
    <div class="control-overlay" id="controlPrislusnost">
        <div class="control-header">
            <div class="control-header-left">
                <button class="control-close" onclick="closeControl('controlPrislusnost')">
                    <span class="material-icons-outlined">close</span>
                </button>
                <div class="control-title">
                    <span class="material-icons-outlined">account_balance</span>
                    Kontrola příslušnosti
                </div>
            </div>
        </div>
        <div class="control-body">
            <div class="control-viewer">
                <div class="viewer-tabs">
                    <div class="viewer-tabs-left" id="prislusnostViewerTabs">
                        <!-- Portál stavebníka -->
                        <button class="viewer-tab active prislusnost-tab-portal" onclick="switchPrislusnostViewerTab(this, 'zadost')">
                            <span class="material-icons-outlined">list_alt</span>
                            Žádost
                        </button>
                        <!-- Vložená žádost -->
                        <button class="viewer-tab prislusnost-tab-vlozena" onclick="switchPrislusnostViewerTab(this, 'formular')" style="display: none;">
                            <span class="material-icons-outlined">picture_as_pdf</span>
                            Formulář žádosti
                        </button>
                        <!-- Společné záložky -->
                        <button class="viewer-tab" onclick="switchPrislusnostViewerTab(this, 'prilohy')">
                            <span class="material-icons-outlined">attach_file</span>
                            Přílohy
                            <span class="badge">12</span>
                        </button>
                        <button class="viewer-tab" onclick="switchPrislusnostViewerTab(this, 'dokumentace')">
                            <span class="material-icons-outlined">folder</span>
                            El. dokumentace
                        </button>
                        <button class="viewer-tab" onclick="switchPrislusnostViewerTab(this, 'doklady')">
                            <span class="material-icons-outlined">fact_check</span>
                            Dokladová část
                        </button>
                    </div>
                    <button class="viewer-open-external" onclick="openViewerExternal('prislusnost')" title="Otevřít v novém okně">
                        <span class="material-icons-outlined">open_in_new</span>
                    </button>
                </div>
                <div class="viewer-content" id="prislusnostViewerContent">
                    <!-- Obsah se přepíná JavaScriptem -->
                    <div id="prislusnostViewerInner"></div>
                </div>
            </div>
            <div class="control-form">
                <div class="control-form-body">
                    <div class="control-section">
                        <div class="control-section-title">Kontrola příslušnosti stavebního úřadu</div>
                        <p style="font-size: 12px; color: #5f6368; margin-bottom: 16px;">
                            Ověřte, zda je stavební úřad věcně a místně příslušný k projednání této žádosti.
                        </p>
                        
                        <!-- Možnost 1: Příslušný -->
                        <label class="control-option selected" id="optionPrislusny" onclick="selectOption(this); updatePrislusnostResult()">
                            <input type="radio" name="prislusnost" value="prislusny" checked>
                            <div class="control-option-content">
                                <div class="control-option-label">
                                    <span class="material-icons-outlined" style="font-size: 18px; color: #137333; vertical-align: middle; margin-right: 6px;">check_circle</span>
                                    Stavební úřad je příslušný
                                </div>
                                <div class="control-option-desc" id="optionPrislusnyDesc">Stavební úřad je věcně i místně příslušný k projednání žádosti</div>
                            </div>
                        </label>
                        
                        <!-- Možnost 2: Nepříslušný (sloučená) - skryto od 1.1.2028 -->
                        <label class="control-option" id="optionNeprislusny" onclick="selectOption(this, true); updatePrislusnostResult()">
                            <input type="radio" name="prislusnost" value="neprislusny">
                            <div class="control-option-content">
                                <div class="control-option-label">
                                    <span class="material-icons-outlined" style="font-size: 18px; color: #b06000; vertical-align: middle; margin-right: 6px;">send</span>
                                    Stavební úřad není věcně nebo místně příslušný
                                </div>
                                <div class="control-option-desc">Řízení bude postoupeno příslušnému stavebnímu úřadu</div>
                            </div>
                        </label>
                        
                        <!-- Info box pro jednotnou stavební správu (od 1.1.2028) -->
                        <div class="platnost-info-box" id="infoJednotnaSprava" style="display: none;">
                            <div class="platnost-info-icon">
                                <span class="material-icons-outlined">info</span>
                            </div>
                            <div class="platnost-info-content">
                                <div class="platnost-info-title">Jednotná státní stavební správa</div>
                                <div class="platnost-info-text">Od 1. 1. 2028 je zavedena jednotná státní stavební správa. Postoupení řízení pro nepříslušnost se již neprovádí — případné interní směrování probíhá automaticky v rámci JSSÚ.</div>
                            </div>
                        </div>
                        
                        <!-- Výběr SÚ - zobrazí se při nepříslušnosti -->
                        <div class="su-selection-section" id="vyberSuSection">
                            <div class="su-selection-title">
                                <span class="material-icons-outlined">account_balance</span>
                                Výběr příslušného stavebního úřadu
                            </div>
                            <div class="su-selection-desc">
                                Vyberte stavební úřad, kterému bude řízení postoupeno.
                            </div>
                            <div class="su-select-wrapper">
                                <div class="su-search-select" id="postoupitSuSearchSelect">
                                    <div class="su-search-input-wrapper">
                                        <span class="material-icons-outlined su-search-icon">search</span>
                                        <input type="text" class="su-search-input" id="postoupitSuSearchInput" 
                                            placeholder="Vyhledejte stavební úřad..." 
                                            onclick="openSuDropdown('postoupit')"
                                            oninput="filterSuOptions('postoupit')">
                                        <input type="hidden" id="postoupitSuSelect" value="">
                                        <button class="su-search-clear" onclick="clearSuSelection('postoupit')" title="Vymazat">
                                            <span class="material-icons-outlined">close</span>
                                        </button>
                                    </div>
                                    <div class="su-dropdown" id="postoupitSuDropdown">
                                        <div class="su-dropdown-group" data-group="desu">
                                            <div class="su-dropdown-group-title">DESÚ – Dopravní a energetický stavební úřad</div>
                                            <div class="su-dropdown-option" data-value="desu" data-type="DESÚ" data-info="Dopravní a energetický stavební úřad|Sokolovská 1955/278, Praha 9|podatelna@desu.gov.cz|Dopravní stavby celostátního významu, energetické stavby" data-search="desú centrála praha dopravní energetický">
                                                <span class="su-option-name">DESÚ – centrála Praha</span>
                                                <span class="su-option-type">DESÚ</span>
                                            </div>
                                        </div>
                                        <div class="su-dropdown-group" data-group="ksu">
                                            <div class="su-dropdown-group-title">Krajské stavební úřady</div>
                                            <div class="su-dropdown-option" data-value="ksu_praha" data-type="Krajský stavební úřad" data-info="Krajský stavební úřad hl. m. Prahy|Jungmannova 35/29, Praha 1|stavebni@praha.eu|Stavby na území hl. m. Prahy spadající do působnosti KSÚ" data-search="ksu krajský praha hlavní město">
                                                <span class="su-option-name">KSÚ hl. m. Prahy</span>
                                                <span class="su-option-type">KSÚ</span>
                                            </div>
                                            <div class="su-dropdown-option" data-value="ksu_stredocesky" data-type="Krajský stavební úřad" data-info="Krajský stavební úřad Středočeského kraje|Zborovská 11, Praha 5|stavebni@kr-s.cz|Stavby na území Středočeského kraje spadající do působnosti KSÚ" data-search="ksu krajský středočeský střední čechy">
                                                <span class="su-option-name">KSÚ Středočeského kraje</span>
                                                <span class="su-option-type">KSÚ</span>
                                            </div>
                                            <div class="su-dropdown-option" data-value="ksu_jihocesky" data-type="Krajský stavební úřad" data-info="Krajský stavební úřad Jihočeského kraje|U Zimního stadionu 1952/2, České Budějovice|stavebni@kraj-jihocesky.cz|Stavby na území Jihočeského kraje spadající do působnosti KSÚ" data-search="ksu krajský jihočeský jižní čechy české budějovice">
                                                <span class="su-option-name">KSÚ Jihočeského kraje</span>
                                                <span class="su-option-type">KSÚ</span>
                                            </div>
                                            <div class="su-dropdown-option" data-value="ksu_plzensky" data-type="Krajský stavební úřad" data-info="Krajský stavební úřad Plzeňského kraje|Škroupova 18, Plzeň|stavebni@plzensky-kraj.cz|Stavby na území Plzeňského kraje spadající do působnosti KSÚ" data-search="ksu krajský plzeňský plzeň">
                                                <span class="su-option-name">KSÚ Plzeňského kraje</span>
                                                <span class="su-option-type">KSÚ</span>
                                            </div>
                                            <div class="su-dropdown-option" data-value="ksu_karlovarsky" data-type="Krajský stavební úřad" data-info="Krajský stavební úřad Karlovarského kraje|Závodní 353/88, Karlovy Vary|stavebni@kr-karlovarsky.cz|Stavby na území Karlovarského kraje spadající do působnosti KSÚ" data-search="ksu krajský karlovarský karlovy vary">
                                                <span class="su-option-name">KSÚ Karlovarského kraje</span>
                                                <span class="su-option-type">KSÚ</span>
                                            </div>
                                            <div class="su-dropdown-option" data-value="ksu_ustecky" data-type="Krajský stavební úřad" data-info="Krajský stavební úřad Ústeckého kraje|Velká Hradební 3118/48, Ústí nad Labem|stavebni@kr-ustecky.cz|Stavby na území Ústeckého kraje spadající do působnosti KSÚ" data-search="ksu krajský ústecký ústí nad labem">
                                                <span class="su-option-name">KSÚ Ústeckého kraje</span>
                                                <span class="su-option-type">KSÚ</span>
                                            </div>
                                            <div class="su-dropdown-option" data-value="ksu_liberecky" data-type="Krajský stavební úřad" data-info="Krajský stavební úřad Libereckého kraje|U Jezu 642/2a, Liberec|stavebni@kraj-lbc.cz|Stavby na území Libereckého kraje spadající do působnosti KSÚ" data-search="ksu krajský liberecký liberec">
                                                <span class="su-option-name">KSÚ Libereckého kraje</span>
                                                <span class="su-option-type">KSÚ</span>
                                            </div>
                                            <div class="su-dropdown-option" data-value="ksu_kralovehradecky" data-type="Krajský stavební úřad" data-info="Krajský stavební úřad Královéhradeckého kraje|Pivovarské náměstí 1245, Hradec Králové|stavebni@kr-kralovehradecky.cz|Stavby na území Královéhradeckého kraje spadající do působnosti KSÚ" data-search="ksu krajský královéhradecký hradec králové">
                                                <span class="su-option-name">KSÚ Královéhradeckého kraje</span>
                                                <span class="su-option-type">KSÚ</span>
                                            </div>
                                            <div class="su-dropdown-option" data-value="ksu_pardubicky" data-type="Krajský stavební úřad" data-info="Krajský stavební úřad Pardubického kraje|Komenského náměstí 125, Pardubice|stavebni@pardubickykraj.cz|Stavby na území Pardubického kraje spadající do působnosti KSÚ" data-search="ksu krajský pardubický pardubice">
                                                <span class="su-option-name">KSÚ Pardubického kraje</span>
                                                <span class="su-option-type">KSÚ</span>
                                            </div>
                                            <div class="su-dropdown-option" data-value="ksu_vysocina" data-type="Krajský stavební úřad" data-info="Krajský stavební úřad Kraje Vysočina|Žižkova 57, Jihlava|stavebni@kr-vysocina.cz|Stavby na území Kraje Vysočina spadající do působnosti KSÚ" data-search="ksu krajský vysočina jihlava">
                                                <span class="su-option-name">KSÚ Kraje Vysočina</span>
                                                <span class="su-option-type">KSÚ</span>
                                            </div>
                                            <div class="su-dropdown-option" data-value="ksu_jihomoravsky" data-type="Krajský stavební úřad" data-info="Krajský stavební úřad Jihomoravského kraje|Žerotínovo náměstí 449/3, Brno|stavebni@kr-jihomoravsky.cz|Stavby na území Jihomoravského kraje spadající do působnosti KSÚ" data-search="ksu krajský jihomoravský brno jižní morava">
                                                <span class="su-option-name">KSÚ Jihomoravského kraje</span>
                                                <span class="su-option-type">KSÚ</span>
                                            </div>
                                            <div class="su-dropdown-option" data-value="ksu_olomoucky" data-type="Krajský stavební úřad" data-info="Krajský stavební úřad Olomouckého kraje|Jeremenkova 40a, Olomouc|stavebni@kr-olomoucky.cz|Stavby na území Olomouckého kraje spadající do působnosti KSÚ" data-search="ksu krajský olomoucký olomouc">
                                                <span class="su-option-name">KSÚ Olomouckého kraje</span>
                                                <span class="su-option-type">KSÚ</span>
                                            </div>
                                            <div class="su-dropdown-option" data-value="ksu_zlinsky" data-type="Krajský stavební úřad" data-info="Krajský stavební úřad Zlínského kraje|třída Tomáše Bati 21, Zlín|stavebni@kr-zlinsky.cz|Stavby na území Zlínského kraje spadající do působnosti KSÚ" data-search="ksu krajský zlínský zlín">
                                                <span class="su-option-name">KSÚ Zlínského kraje</span>
                                                <span class="su-option-type">KSÚ</span>
                                            </div>
                                            <div class="su-dropdown-option" data-value="ksu_moravskoslezsky" data-type="Krajský stavební úřad" data-info="Krajský stavební úřad Moravskoslezského kraje|28. října 117, Ostrava|stavebni@kr-moravskoslezsky.cz|Stavby na území Moravskoslezského kraje spadající do působnosti KSÚ" data-search="ksu krajský moravskoslezský ostrava slezsko">
                                                <span class="su-option-name">KSÚ Moravskoslezského kraje</span>
                                                <span class="su-option-type">KSÚ</span>
                                            </div>
                                        </div>
                                        <div class="su-dropdown-group" data-group="praha">
                                            <div class="su-dropdown-group-title">Praha</div>
                                            <div class="su-dropdown-option" data-value="praha1" data-type="Obecný stavební úřad" data-info="Úřad městské části Praha 1|Vodičkova 18, Praha 1|stavebni@praha1.cz|k.ú. Staré Město, Josefov, Malá Strana, Hradčany" data-search="praha 1 staré město josefov malá strana hradčany">
                                                <span class="su-option-name">ÚMČ Praha 1</span>
                                                <span class="su-option-type">Praha</span>
                                            </div>
                                            <div class="su-dropdown-option" data-value="praha2" data-type="Obecný stavební úřad" data-info="Úřad městské části Praha 2|náměstí Míru 20, Praha 2|stavebni@praha2.cz|k.ú. Nové Město, Vinohrady, Vyšehrad" data-search="praha 2 nové město vinohrady vyšehrad">
                                                <span class="su-option-name">ÚMČ Praha 2</span>
                                                <span class="su-option-type">Praha</span>
                                            </div>
                                            <div class="su-dropdown-option" data-value="praha3" data-type="Obecný stavební úřad" data-info="Úřad městské části Praha 3|Havlíčkovo nám. 700/9, Praha 3|stavebni@praha3.cz|k.ú. Žižkov, Vinohrady" data-search="praha 3 žižkov vinohrady">
                                                <span class="su-option-name">ÚMČ Praha 3</span>
                                                <span class="su-option-type">Praha</span>
                                            </div>
                                            <div class="su-dropdown-option" data-value="praha4" data-type="Obecný stavební úřad" data-info="Úřad městské části Praha 4|Antala Staška 2059/80b, Praha 4|stavebni@praha4.cz|k.ú. Braník, Hodkovičky, Krč, Lhotka, Michle, Nusle, Podolí" data-search="praha 4 braník hodkovičky krč lhotka michle nusle podolí">
                                                <span class="su-option-name">ÚMČ Praha 4</span>
                                                <span class="su-option-type">Praha</span>
                                            </div>
                                            <div class="su-dropdown-option" data-value="praha5" data-type="Obecný stavební úřad" data-info="Úřad městské části Praha 5|náměstí 14. října 4, Praha 5|stavebni@praha5.cz|k.ú. Smíchov, Košíře, Motol, Radlice, Hlubočepy, Jinonice" data-search="praha 5 smíchov košíře motol radlice hlubočepy jinonice">
                                                <span class="su-option-name">ÚMČ Praha 5</span>
                                                <span class="su-option-type">Praha</span>
                                            </div>
                                        </div>
                                        <div class="su-dropdown-group" data-group="stredocesky">
                                            <div class="su-dropdown-group-title">Středočeský kraj</div>
                                            <div class="su-dropdown-option" data-value="kladno" data-type="Obecný stavební úřad" data-info="Magistrát města Kladna|náměstí Starosty Pavla 44, Kladno|stavebni@mestokladno.cz|ORP Kladno" data-search="kladno magistrát orp">
                                                <span class="su-option-name">Magistrát města Kladna</span>
                                                <span class="su-option-type">ORP</span>
                                            </div>
                                            <div class="su-dropdown-option" data-value="benesov" data-type="Obecný stavební úřad" data-info="Městský úřad Benešov|Masarykovo náměstí 100, Benešov|stavebni@benesov-city.cz|ORP Benešov" data-search="benešov městský úřad orp">
                                                <span class="su-option-name">MěÚ Benešov</span>
                                                <span class="su-option-type">ORP</span>
                                            </div>
                                            <div class="su-dropdown-option" data-value="beroun" data-type="Obecný stavební úřad" data-info="Městský úřad Beroun|Husovo náměstí 68, Beroun|stavebni@muberoun.cz|ORP Beroun" data-search="beroun městský úřad orp">
                                                <span class="su-option-name">MěÚ Beroun</span>
                                                <span class="su-option-type">ORP</span>
                                            </div>
                                            <div class="su-dropdown-option" data-value="brandys" data-type="Obecný stavební úřad" data-info="Městský úřad Brandýs n. L. – Stará Boleslav|Masarykovo náměstí 1, Brandýs n. L.|stavebni@brandysko.cz|ORP Brandýs nad Labem" data-search="brandýs nad labem stará boleslav městský úřad orp">
                                                <span class="su-option-name">MěÚ Brandýs nad Labem</span>
                                                <span class="su-option-type">ORP</span>
                                            </div>
                                            <div class="su-dropdown-option" data-value="kolin" data-type="Obecný stavební úřad" data-info="Městský úřad Kolín|Karlovo náměstí 78, Kolín|stavebni@mukolin.cz|ORP Kolín" data-search="kolín městský úřad orp">
                                                <span class="su-option-name">MěÚ Kolín</span>
                                                <span class="su-option-type">ORP</span>
                                            </div>
                                            <div class="su-dropdown-option" data-value="mlboleslav" data-type="Obecný stavební úřad" data-info="Magistrát města Mladá Boleslav|Komenského náměstí 61, Mladá Boleslav|stavebni@mb-net.cz|ORP Mladá Boleslav" data-search="mladá boleslav magistrát orp">
                                                <span class="su-option-name">Magistrát města Mladá Boleslav</span>
                                                <span class="su-option-type">ORP</span>
                                            </div>
                                            <div class="su-dropdown-option" data-value="nymburk" data-type="Obecný stavební úřad" data-info="Městský úřad Nymburk|náměstí Přemyslovců 163, Nymburk|stavebni@meu-nbk.cz|ORP Nymburk" data-search="nymburk městský úřad orp">
                                                <span class="su-option-name">MěÚ Nymburk</span>
                                                <span class="su-option-type">ORP</span>
                                            </div>
                                            <div class="su-dropdown-option" data-value="pribram" data-type="Obecný stavební úřad" data-info="Městský úřad Příbram|Tyršova 108, Příbram|stavebni@pribram.eu|ORP Příbram" data-search="příbram městský úřad orp">
                                                <span class="su-option-name">MěÚ Příbram</span>
                                                <span class="su-option-type">ORP</span>
                                            </div>
                                            <div class="su-dropdown-option" data-value="rakovnik" data-type="Obecný stavební úřad" data-info="Městský úřad Rakovník|Husovo náměstí 27, Rakovník|stavebni@murako.cz|ORP Rakovník" data-search="rakovník městský úřad orp">
                                                <span class="su-option-name">MěÚ Rakovník</span>
                                                <span class="su-option-type">ORP</span>
                                            </div>
                                        </div>
                                        <div class="su-dropdown-group" data-group="kralovehradecky">
                                            <div class="su-dropdown-group-title">Královéhradecký kraj</div>
                                            <div class="su-dropdown-option" data-value="hradec" data-type="Obecný stavební úřad" data-info="Magistrát města Hradec Králové|Československé armády 408/51, Hradec Králové|stavebni@mmhk.cz|ORP Hradec Králové" data-search="hradec králové magistrát orp">
                                                <span class="su-option-name">Magistrát města Hradec Králové</span>
                                                <span class="su-option-type">ORP</span>
                                            </div>
                                            <div class="su-dropdown-option" data-value="jaromer" data-type="Obecný stavební úřad" data-info="Městský úřad Jaroměř|náměstí ČSA 16, Jaroměř|stavebni@jaromer-josefov.cz|ORP Jaroměř" data-search="jaroměř městský úřad orp josefov">
                                                <span class="su-option-name">MěÚ Jaroměř</span>
                                                <span class="su-option-type">ORP</span>
                                            </div>
                                            <div class="su-dropdown-option" data-value="nachod" data-type="Obecný stavební úřad" data-info="Městský úřad Náchod|Masarykovo náměstí 40, Náchod|stavebni@mestonachod.cz|ORP Náchod" data-search="náchod městský úřad orp">
                                                <span class="su-option-name">MěÚ Náchod</span>
                                                <span class="su-option-type">ORP</span>
                                            </div>
                                            <div class="su-dropdown-option" data-value="trutnov" data-type="Obecný stavební úřad" data-info="Městský úřad Trutnov|Slovanské náměstí 165, Trutnov|stavebni@trutnov.cz|ORP Trutnov" data-search="trutnov městský úřad orp">
                                                <span class="su-option-name">MěÚ Trutnov</span>
                                                <span class="su-option-type">ORP</span>
                                            </div>
                                            <div class="su-dropdown-option" data-value="jicin" data-type="Obecný stavební úřad" data-info="Městský úřad Jičín|Žižkovo náměstí 18, Jičín|stavebni@mujicin.cz|ORP Jičín" data-search="jičín městský úřad orp">
                                                <span class="su-option-name">MěÚ Jičín</span>
                                                <span class="su-option-type">ORP</span>
                                            </div>
                                        </div>
                                        <div class="su-dropdown-empty" style="display: none;">
                                            <span class="material-icons-outlined">search_off</span>
                                            Žádný stavební úřad nebyl nalezen
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="su-selected-info" id="postoupitSuInfo">
                                <div class="su-selected-header">
                                    <div class="su-selected-icon">
                                        <span class="material-icons-outlined">account_balance</span>
                                    </div>
                                    <div class="su-selected-name" id="postoupitSuName">—</div>
                                </div>
                                <div class="su-selected-details" id="postoupitSuDetails">
                                    <span><strong>Adresa:</strong> —</span>
                                    <span><strong>E-mail:</strong> —</span>
                                    <span><strong>Působnost:</strong> —</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Zdůvodnění nepříslušnosti - zobrazí se při nepříslušnosti -->
                    <div class="control-section" id="zduvodneniNeprislusnostiSection" style="display: none;">
                        <div class="control-section-title">Zdůvodnění nepříslušnosti</div>
                        <p style="font-size: 12px; color: #5f6368; margin-bottom: 12px;">
                            Uveďte zdůvodnění, proč není stavební úřad příslušný k projednání žádosti. 
                            Text bude součástí dokumentu <strong>Postoupení řízení z důvodu nepříslušnosti</strong>.
                        </p>
                        <textarea id="zduvodneniNeprislusnosti" class="form-textarea" rows="5" 
                            placeholder="Uveďte zdůvodnění nepříslušnosti..."
                            oninput="updatePrislusnostButton()"
                            style="width: 100%; padding: 12px; border: 1px solid #dadce0; border-radius: 6px; font-size: 13px; font-family: inherit; resize: vertical; line-height: 1.5;"></textarea>
                    </div>

                    <div class="result-preview positive" id="resultPrislusnost">
                        <div class="result-preview-title">
                            <span class="material-icons-outlined">check_circle</span>
                            Příslušnost potvrzena
                        </div>
                        <div class="result-preview-text">Stavební úřad je věcně i místně příslušný k projednání této žádosti.</div>
                    </div>
                </div>
                <div class="control-form-footer">
                    <div class="control-form-footer-left">
                        <div class="auto-save-indicator saved" id="autoSavePrislusnost">
                            <span class="material-icons-outlined">cloud_done</span>
                            <span>Automaticky uloženo</span>
                        </div>
                    </div>
                    <div class="control-form-footer-right">
                        <button class="btn btn-secondary" onclick="closeControl('controlPrislusnost')">Zrušit</button>
                        <button class="btn-save-draft" onclick="saveDraft('prislusnost')" title="Uložit rozpracovanou kontrolu">
                            <span class="material-icons-outlined">save</span>
                            Uložit
                        </button>
                        <button class="btn btn-primary" onclick="completePrislusnost()">
                            <span class="material-icons-outlined">check</span>
                            Potvrdit kontrolu
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Kontrola: Kontrola žádosti (§ 184, § 185 SZ) -->
    <div class="control-overlay" id="controlZadost">
        <div class="control-header">
            <div class="control-header-left">
                <button class="control-close" onclick="closeControl('controlZadost')">
                    <span class="material-icons-outlined">close</span>
                </button>
                <div class="control-title">
                    <span class="material-icons-outlined">fact_check</span>
                    Kontrola žádosti
                </div>
            </div>
        </div>
        <div class="control-body">
            <!-- LEVÉ OKNO: Strukturovaná data ze žádosti s inline kontrolami -->
            <div class="control-viewer zadost-data-viewer">
                <div class="viewer-tabs">
                    <div class="viewer-tabs-left">
                        <button class="viewer-tab active" id="tabZadost" onclick="switchZadostDataTab(this, 'zadost')">
                            <span class="material-icons-outlined">list_alt</span>
                            Žádost
                        </button>
                        <button class="viewer-tab" id="tabFormular" onclick="switchZadostDataTab(this, 'formular')">
                            <span class="material-icons-outlined">picture_as_pdf</span>
                            Formulář žádosti
                        </button>
                        <button class="viewer-tab" id="tabPrilohy" onclick="switchZadostDataTab(this, 'prilohy')" style="display: none;">
                            <span class="material-icons-outlined">attach_file</span>
                            Přílohy
                        </button>
                        <button class="viewer-tab" id="tabDoklady" onclick="switchZadostDataTab(this, 'doklady')">
                            <span class="material-icons-outlined">fact_check</span>
                            Dokladová část
                        </button>
                    </div>
                    <div class="viewer-tabs-right">
                        <button class="btn-vse-ok" id="btnVseOkZadost" onclick="setAllSectionsOk()" title="Označit všechny sekce jako v pořádku">
                            <span class="material-icons-outlined">done_all</span>
                            Vše v pořádku
                        </button>
                    </div>
                </div>
                <div class="viewer-content zadost-data-content">
                    <!-- TAB: Žádost - strukturovaná data s inline kontrolami -->
                    <div class="zadost-data-tab active" id="zadostDataZadost">
                        <!-- 1. Údaje o podání -->
                        <div class="zadost-data-section" id="dataSectionPodani" data-section-id="podani">
                            <div class="zadost-data-section-header">
                                <span class="material-icons-outlined">assignment_ind</span>
                                Údaje o podání
                                <span class="section-status-badge" id="statusBadgePodani"></span>
                            </div>
                            <div class="zadost-data-grid">
                                <div class="zadost-data-item">
                                    <div class="zadost-data-label">Podatel (kdo činí podání)</div>
                                    <div class="zadost-data-value" id="podaniPodatel">Správa železnic, s.o.</div>
                                </div>
                                <div class="zadost-data-item">
                                    <div class="zadost-data-label">Vztah k žadateli</div>
                                    <div class="zadost-data-value" id="podaniVztah">
                                        <span style="display: inline-flex; align-items: center; gap: 6px;">
                                            <span class="material-icons-outlined" style="font-size: 18px; color: #34a853;">check_circle</span>
                                            Podatel je sám žadatel
                                        </span>
                                    </div>
                                </div>
                                <div class="zadost-data-item">
                                    <div class="zadost-data-label">Věc podání</div>
                                    <div class="zadost-data-value">Žádost o povolení stavby</div>
                                </div>
                                <div class="zadost-data-item">
                                    <div class="zadost-data-label">Správní orgán</div>
                                    <div class="zadost-data-value">Dopravní a energetický stavební úřad</div>
                                </div>
                            </div>
                            <!-- Akční tlačítka pro ověření (dynamicky zobrazované) -->
                            <div class="zastupce-verify-actions" id="podaniVerifyActions" style="display: none;">
                                <!-- Tlačítka budou doplněna podle typu zastoupení -->
                            </div>
                            <div class="zadost-section-controls">
                                <div class="zadost-section-status" id="sectionStatusPodani">
                                    <span class="material-icons-outlined">radio_button_unchecked</span>
                                    Nezkontrolováno
                                </div>
                                <div class="zadost-section-actions">
                                    <button class="zadost-section-btn btn-ok" onclick="setSectionStatus('podani', 'ok')">
                                        <span class="material-icons-outlined">check</span>
                                        V pořádku
                                    </button>
                                    <button class="zadost-section-btn btn-vada" onclick="setSectionStatus('podani', 'vada')">
                                        <span class="material-icons-outlined">error_outline</span>
                                        Vada
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 2. Žadatel -->
                        <div class="zadost-data-section" id="dataSectionZadatel" data-section-id="zadatel">
                            <div class="zadost-data-section-header">
                                <span class="material-icons-outlined">person</span>
                                Žadatel — Fyzická osoba
                                <span class="section-status-badge" id="statusBadgeZadatel"></span>
                            </div>
                            <div class="zadost-data-grid">
                                <div class="zadost-data-item">
                                    <div class="zadost-data-label">Jméno</div>
                                    <div class="zadost-data-value">Jan</div>
                                </div>
                                <div class="zadost-data-item">
                                    <div class="zadost-data-label">Příjmení</div>
                                    <div class="zadost-data-value">Novák</div>
                                </div>
                                <div class="zadost-data-item">
                                    <div class="zadost-data-label">Datum narození</div>
                                    <div class="zadost-data-value">15. 3. 1985</div>
                                </div>
                                <div class="zadost-data-item">
                                    <div class="zadost-data-label">Místo trvalého pobytu</div>
                                    <div class="zadost-data-value">Dlážděná 1003/7, 110 00 Praha 1</div>
                                </div>
                                <div class="zadost-data-item">
                                    <div class="zadost-data-label">E-mail</div>
                                    <div class="zadost-data-value"><a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="fa909b94d494958c9b91ba9f979b9396d49980">[email&#160;protected]</a></div>
                                </div>
                                <div class="zadost-data-item">
                                    <div class="zadost-data-label">Telefon</div>
                                    <div class="zadost-data-value">+420 601 234 567</div>
                                </div>
                                <div class="zadost-data-item">
                                    <div class="zadost-data-label">Datová schránka</div>
                                    <div class="zadost-data-value">uccchjm</div>
                                </div>
                            </div>
                            <div class="zadost-section-controls">
                                <div class="zadost-section-status" id="sectionStatusZadatel">
                                    <span class="material-icons-outlined">radio_button_unchecked</span>
                                    Nezkontrolováno
                                </div>
                                <div class="zadost-section-actions">
                                    <button class="zadost-section-btn btn-ok" onclick="setSectionStatus('zadatel', 'ok')">
                                        <span class="material-icons-outlined">check</span>
                                        V pořádku
                                    </button>
                                    <button class="zadost-section-btn btn-vada" onclick="setSectionStatus('zadatel', 'vada')">
                                        <span class="material-icons-outlined">error_outline</span>
                                        Vada
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 3. Zástupce -->
                        <div class="zadost-data-section" id="dataSectionZastupce" data-section-id="zastupce">
                            <div class="zadost-data-section-header">
                                <span class="material-icons-outlined">supervisor_account</span>
                                Zástupce na základě plné moci
                                <span class="section-status-badge" id="statusBadgeZastupce"></span>
                            </div>
                            <div class="zadost-data-empty">
                                <span class="material-icons-outlined">person_off</span>
                                Žadatel jedná sám za sebe, zástupce není uveden
                            </div>
                            <div class="zadost-section-controls">
                                <div class="zadost-section-status" id="sectionStatusZastupce">
                                    <span class="material-icons-outlined">radio_button_unchecked</span>
                                    Nezkontrolováno
                                </div>
                                <div class="zadost-section-actions">
                                    <button class="zadost-section-btn btn-ok" onclick="setSectionStatus('zastupce', 'ok')">
                                        <span class="material-icons-outlined">check</span>
                                        V pořádku
                                    </button>
                                    <button class="zadost-section-btn btn-vada" onclick="setSectionStatus('zastupce', 'vada')">
                                        <span class="material-icons-outlined">error_outline</span>
                                        Vada
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 4. Identifikace záměru -->
                        <div class="zadost-data-section" id="dataSectionZamer" data-section-id="zamer">
                            <div class="zadost-data-section-header">
                                <span class="material-icons-outlined">home_work</span>
                                Identifikace záměru
                                <span class="section-status-badge" id="statusBadgeZamer"></span>
                            </div>
                            <div class="zadost-data-grid">
                                <div class="zadost-data-item full-width">
                                    <div class="zadost-data-label">Název záměru</div>
                                    <div class="zadost-data-value">Oprava zabezpečovacího zařízení v žst. Doudleby n. Orlicí</div>
                                </div>
                                <div class="zadost-data-item">
                                    <div class="zadost-data-label">Místo stavby</div>
                                    <div class="zadost-data-value">Doudleby n.O., Vamberk, Záměl</div>
                                </div>
                                <div class="zadost-data-item">
                                    <div class="zadost-data-label">Katastrální území</div>
                                    <div class="zadost-data-value">Doudleby n.O. [631761] + 3 k.ú.</div>
                                </div>
                            </div>
                            <div class="zadost-section-controls">
                                <div class="zadost-section-status" id="sectionStatusZamer">
                                    <span class="material-icons-outlined">radio_button_unchecked</span>
                                    Nezkontrolováno
                                </div>
                                <div class="zadost-section-actions">
                                    <button class="zadost-section-btn btn-ok" onclick="setSectionStatus('zamer', 'ok')">
                                        <span class="material-icons-outlined">check</span>
                                        V pořádku
                                    </button>
                                    <button class="zadost-section-btn btn-vada" onclick="setSectionStatus('zamer', 'vada')">
                                        <span class="material-icons-outlined">error_outline</span>
                                        Vada
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 5. Základní charakteristika záměru -->
                        <div class="zadost-data-section" id="dataSectionCharakteristika" data-section-id="charakteristika">
                            <div class="zadost-data-section-header">
                                <span class="material-icons-outlined">info</span>
                                Základní charakteristika záměru
                                <span class="section-status-badge" id="statusBadgeCharakteristika"></span>
                            </div>
                            <div class="zadost-data-grid">
                                <div class="zadost-data-item">
                                    <div class="zadost-data-label">Druh stavby</div>
                                    <div class="zadost-data-value">Stavba dráhy — dráha celostátní</div>
                                </div>
                                <div class="zadost-data-item">
                                    <div class="zadost-data-label">Účel užívání</div>
                                    <div class="zadost-data-value">Dopravní infrastruktura</div>
                                </div>
                                <div class="zadost-data-item">
                                    <div class="zadost-data-label">Charakter stavby</div>
                                    <div class="zadost-data-value">Trvalá stavba</div>
                                </div>
                                <div class="zadost-data-item">
                                    <div class="zadost-data-label">Zastavěná plocha</div>
                                    <div class="zadost-data-value">185 m²</div>
                                </div>
                            </div>
                            <div class="zadost-section-controls">
                                <div class="zadost-section-status" id="sectionStatusCharakteristika">
                                    <span class="material-icons-outlined">radio_button_unchecked</span>
                                    Nezkontrolováno
                                </div>
                                <div class="zadost-section-actions">
                                    <button class="zadost-section-btn btn-ok" onclick="setSectionStatus('charakteristika', 'ok')">
                                        <span class="material-icons-outlined">check</span>
                                        V pořádku
                                    </button>
                                    <button class="zadost-section-btn btn-vada" onclick="setSectionStatus('charakteristika', 'vada')">
                                        <span class="material-icons-outlined">error_outline</span>
                                        Vada
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 6. Podrobnější informace o záměru -->
                        <div class="zadost-data-section" id="dataSectionPodrobneji" data-section-id="podrobnosti">
                            <div class="zadost-data-section-header">
                                <span class="material-icons-outlined">article</span>
                                Podrobnější informace o záměru
                                <span class="section-status-badge" id="statusBadgePodrobnosti"></span>
                            </div>
                            <div class="zadost-data-grid">
                                <div class="zadost-data-item full-width">
                                    <div class="zadost-data-label">Popis záměru</div>
                                    <div class="zadost-data-value text-block">Oprava zabezpečovacího zařízení v žst. Doudleby nad Orlicí na trati č. 010. Výměna reléového ZZ za elektronické stavědlo ESA 44, úpravy přejezdových ZZ, sdělovacích zařízení a kabelových tras. Členěno na PS a SO ve 4 k.ú.</div>
                                </div>
                                <div class="zadost-data-item">
                                    <div class="zadost-data-label">Počet nadzemních podlaží</div>
                                    <div class="zadost-data-value">2 + podkroví</div>
                                </div>
                                <div class="zadost-data-item">
                                    <div class="zadost-data-label">Počet podzemních podlaží</div>
                                    <div class="zadost-data-value">0</div>
                                </div>
                                <div class="zadost-data-item">
                                    <div class="zadost-data-label">Počet bytových jednotek</div>
                                    <div class="zadost-data-value">1</div>
                                </div>
                                <div class="zadost-data-item">
                                    <div class="zadost-data-label">Obestavěný prostor</div>
                                    <div class="zadost-data-value">1 250 m³</div>
                                </div>
                            </div>
                            <div class="zadost-section-controls">
                                <div class="zadost-section-status" id="sectionStatusPodrobnosti">
                                    <span class="material-icons-outlined">radio_button_unchecked</span>
                                    Nezkontrolováno
                                </div>
                                <div class="zadost-section-actions">
                                    <button class="zadost-section-btn btn-ok" onclick="setSectionStatus('podrobnosti', 'ok')">
                                        <span class="material-icons-outlined">check</span>
                                        V pořádku
                                    </button>
                                    <button class="zadost-section-btn btn-vada" onclick="setSectionStatus('podrobnosti', 'vada')">
                                        <span class="material-icons-outlined">error_outline</span>
                                        Vada
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 7. Pozemky záměru -->
                        <div class="zadost-data-section" id="dataSectionPozemkyZameru" data-section-id="pozemky">
                            <div class="zadost-data-section-header">
                                <span class="material-icons-outlined">terrain</span>
                                Pozemky, které jsou předmětem záměru
                                <span class="section-status-badge" id="statusBadgePozemky"></span>
                            </div>
                            <table class="zadost-data-table">
                                <thead>
                                    <tr>
                                        <th>Parcela</th>
                                        <th>K.ú.</th>
                                        <th>Druh pozemku</th>
                                        <th>Výměra</th>
                                        <th>Vlastník</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td><strong>st. 321</strong></td>
                                        <td>Doudleby n.O.</td>
                                        <td>Zastavěná plocha a nádvoří</td>
                                        <td>—</td>
                                        <td>Správa železnic, s.o.</td>
                                    </tr>
                                    <tr>
                                        <td><strong>1549</strong></td>
                                        <td>Doudleby n.O.</td>
                                        <td>Ostatní plocha — dráha</td>
                                        <td>—</td>
                                        <td>ČR — Správa železnic, s.o.</td>
                                    </tr>
                                    <tr>
                                        <td><strong>1804/1</strong></td>
                                        <td>Vamberk</td>
                                        <td>Ostatní plocha — dráha</td>
                                        <td>—</td>
                                        <td>ČR — Správa železnic, s.o.</td>
                                    </tr>
                                    <tr>
                                        <td colspan="5" style="text-align: center; color: #5f6368; font-style: italic;">… a dalších 35 pozemků</td>
                                    </tr>
                                </tbody>
                            </table>
                            <div class="zadost-section-controls">
                                <div class="zadost-section-status" id="sectionStatusPozemky">
                                    <span class="material-icons-outlined">radio_button_unchecked</span>
                                    Nezkontrolováno
                                </div>
                                <div class="zadost-section-actions">
                                    <button class="zadost-section-btn btn-ok" onclick="setSectionStatus('pozemky', 'ok')">
                                        <span class="material-icons-outlined">check</span>
                                        V pořádku
                                    </button>
                                    <button class="zadost-section-btn btn-vada" onclick="setSectionStatus('pozemky', 'vada')">
                                        <span class="material-icons-outlined">error_outline</span>
                                        Vada
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 8. Přílohy žádosti -->
                        <div class="zadost-data-section" id="dataSectionPrilohyZadosti" data-section-id="prilohy">
                            <div class="zadost-data-section-header">
                                <span class="material-icons-outlined">attach_file</span>
                                Přílohy žádosti
                                <span class="section-status-badge" id="statusBadgePrilohy"></span>
                            </div>
                            <div class="prilohy-list prilohy-list-compact" id="prilohyList">
                                <div class="prilohy-item">
                                    <div class="prilohy-item-icon">
                                        <span class="material-icons-outlined">picture_as_pdf</span>
                                    </div>
                                    <div class="prilohy-item-info">
                                        <div class="prilohy-item-name">SR00X01HLDRP (BPP balíček PD)</div>
                                        <div class="prilohy-item-meta">ZIP/BPP • 247 souborů • Nahráno 6. 1. 2026</div>
                                    </div>
                                    <button class="prilohy-item-btn" title="Zobrazit" onclick="showInlineFile('prilohy')">
                                        <span class="material-icons-outlined">visibility</span>
                                    </button>
                                </div>
                                <div class="prilohy-item">
                                    <div class="prilohy-item-icon">
                                        <span class="material-icons-outlined">picture_as_pdf</span>
                                    </div>
                                    <div class="prilohy-item-info">
                                        <div class="prilohy-item-name">Dokladová část (63 dokladů)</div>
                                        <div class="prilohy-item-meta">PDF • ZS, JES, vyjádření VTI/VDI • Nahráno 6. 1. 2026</div>
                                    </div>
                                    <button class="prilohy-item-btn" title="Zobrazit" onclick="showInlineFile('doklady')">
                                        <span class="material-icons-outlined">visibility</span>
                                    </button>
                                </div>
                                <div class="prilohy-item">
                                    <div class="prilohy-item-icon">
                                        <span class="material-icons-outlined">picture_as_pdf</span>
                                    </div>
                                    <div class="prilohy-item-info">
                                        <div class="prilohy-item-name">PM-036-2024-SŽ - Signal projekt.pdf</div>
                                        <div class="prilohy-item-meta">PDF • Plná moc • 156 KB • Nahráno 6. 1. 2026</div>
                                    </div>
                                    <button class="prilohy-item-btn" title="Zobrazit" onclick="showInlineFile('prilohy','PM-036-2024-SZ - Signal projekt.pdf')">
                                        <span class="material-icons-outlined">visibility</span>
                                    </button>
                                </div>
                                <div class="prilohy-item">
                                    <div class="prilohy-item-icon">
                                        <span class="material-icons-outlined">picture_as_pdf</span>
                                    </div>
                                    <div class="prilohy-item-info">
                                        <div class="prilohy-item-name">PM-037-2024-Mikulová.pdf</div>
                                        <div class="prilohy-item-meta">PDF • Plná moc • 98 KB • Nahráno 6. 1. 2026</div>
                                    </div>
                                    <button class="prilohy-item-btn" title="Zobrazit" onclick="showInlineFile('prilohy','PM-037-2024-Mikulova.pdf')">
                                        <span class="material-icons-outlined">visibility</span>
                                    </button>
                                </div>
                                <div class="prilohy-item">
                                    <div class="prilohy-item-icon">
                                        <span class="material-icons-outlined">picture_as_pdf</span>
                                    </div>
                                    <div class="prilohy-item-info">
                                        <div class="prilohy-item-name">Sousední pozemky do 2m od plánované stavby.pdf</div>
                                        <div class="prilohy-item-meta">PDF • Výpis z KN • 245 KB • Nahráno 6. 1. 2026</div>
                                    </div>
                                    <button class="prilohy-item-btn" title="Zobrazit" onclick="showInlineFile('prilohy','Sousedni pozemky do 2m od planovane stavby.pdf')">
                                        <span class="material-icons-outlined">visibility</span>
                                    </button>
                                </div>
                                <div class="prilohy-item">
                                    <div class="prilohy-item-icon">
                                        <span class="material-icons-outlined">picture_as_pdf</span>
                                    </div>
                                    <div class="prilohy-item-info">
                                        <div class="prilohy-item-name">podle části F k bodu B.pdf</div>
                                        <div class="prilohy-item-meta">PDF • Dle vyhl. č. 149/2024 Sb. • 312 KB • Nahráno 6. 1. 2026</div>
                                    </div>
                                    <button class="prilohy-item-btn" title="Zobrazit" onclick="showInlineFile('prilohy','podle casti F k bodu B.pdf')">
                                        <span class="material-icons-outlined">visibility</span>
                                    </button>
                                </div>
                                <div class="prilohy-item">
                                    <div class="prilohy-item-icon">
                                        <span class="material-icons-outlined">picture_as_pdf</span>
                                    </div>
                                    <div class="prilohy-item-info">
                                        <div class="prilohy-item-name">Pověření ředitele Kosinová 9910 eč 3430.pdf</div>
                                        <div class="prilohy-item-meta">PDF • Pověření k jednání • 78 KB • Nahráno 6. 1. 2026</div>
                                    </div>
                                    <button class="prilohy-item-btn" title="Zobrazit" onclick="showInlineFile('prilohy','Povereni reditele Kosinova 9910 ec 3430.pdf')">
                                        <span class="material-icons-outlined">visibility</span>
                                    </button>
                                </div>
                            </div>
                            <div class="zadost-section-controls">
                                <div class="zadost-section-status" id="sectionStatusPrilohy">
                                    <span class="material-icons-outlined">radio_button_unchecked</span>
                                    Nezkontrolováno
                                </div>
                                <div class="zadost-section-actions">
                                    <button class="zadost-section-btn btn-ok" onclick="setSectionStatus('prilohy', 'ok')">
                                        <span class="material-icons-outlined">check</span>
                                        V pořádku
                                    </button>
                                    <button class="zadost-section-btn btn-vada" onclick="setSectionStatus('prilohy', 'vada')">
                                        <span class="material-icons-outlined">error_outline</span>
                                        Vada
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 9. Výjimky z požadavků (zobrazí se jen u scénáře s výjimkami) -->
                        <div class="zadost-data-section" id="dataSectionVyjimky" data-section-id="vyjimky" style="display: none;">
                            <div class="zadost-data-section-header">
                                <span class="material-icons-outlined">rule</span>
                                Výjimky z obecných požadavků
                                <span style="margin-left: 8px; padding: 2px 8px; background: #fff3e0; color: #ef6c00; border-radius: 4px; font-size: 10px; font-weight: 600;">ŽÁDÁNO</span>
                                <span class="section-status-badge" id="statusBadgeVyjimky"></span>
                            </div>
                            <div class="zadost-data-grid" id="vyjimkyContent">
                                <!-- Dynamicky generované podle scénáře -->
                            </div>
                            <div class="zadost-section-controls">
                                <div class="zadost-section-status" id="sectionStatusVyjimky">
                                    <span class="material-icons-outlined">radio_button_unchecked</span>
                                    Nezkontrolováno
                                </div>
                                <div class="zadost-section-actions">
                                    <button class="zadost-section-btn btn-ok" onclick="setSectionStatus('vyjimky', 'ok')">
                                        <span class="material-icons-outlined">check</span>
                                        V pořádku
                                    </button>
                                    <button class="zadost-section-btn btn-vada" onclick="setSectionStatus('vyjimky', 'vada')">
                                        <span class="material-icons-outlined">error_outline</span>
                                        Vada
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- TAB: Formulář žádosti - náhled PDF -->
                    <div class="zadost-data-tab" id="zadostDataFormular">
                        <div class="formular-preview">
                            <div class="formular-header">
                                <div class="formular-logo">
                                    <span class="material-icons-outlined">account_balance</span>
                                </div>
                                <div class="formular-title-block">
                                    <div class="formular-title">ŽÁDOST O POVOLENÍ STAVBY</div>
                                    <div class="formular-subtitle">podle § 184 zákona č. 283/2021 Sb., stavební zákon</div>
                                </div>
                                <div class="formular-cislo">
                                    <div class="formular-cislo-label">Číslo jednací</div>
                                    <div class="formular-cislo-value">DESU/122/001574/26</div>
                                </div>
                            </div>
                            
                            <div class="formular-section">
                                <div class="formular-section-title">ČÁST A – IDENTIFIKAČNÍ ÚDAJE</div>
                                
                                <div class="formular-subsection">
                                    <div class="formular-subsection-title">A.1 Údaje o stavebníkovi</div>
                                    <div class="formular-field-row">
                                        <div class="formular-field">
                                            <div class="formular-field-label">Jméno a příjmení / Název</div>
                                            <div class="formular-field-value">Správa železnic, s.o.</div>
                                        </div>
                                        <div class="formular-field">
                                            <div class="formular-field-label">Datum narození / IČO</div>
                                            <div class="formular-field-value">15. 3. 1985</div>
                                        </div>
                                    </div>
                                    <div class="formular-field-row">
                                        <div class="formular-field full">
                                            <div class="formular-field-label">Adresa místa trvalého pobytu / Sídlo</div>
                                            <div class="formular-field-value">Dlážděná 1003/7, 110 00 Praha 1</div>
                                        </div>
                                    </div>
                                    <div class="formular-field-row">
                                        <div class="formular-field">
                                            <div class="formular-field-label">Telefon</div>
                                            <div class="formular-field-value">+420 601 234 567</div>
                                        </div>
                                        <div class="formular-field">
                                            <div class="formular-field-label">E-mail</div>
                                            <div class="formular-field-value"><a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="1a707b743474756c7b715a7f777b7376347960">[email&#160;protected]</a></div>
                                        </div>
                                        <div class="formular-field">
                                            <div class="formular-field-label">ID datové schránky</div>
                                            <div class="formular-field-value">uccchjm</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="formular-subsection">
                                    <div class="formular-subsection-title">A.2 Údaje o zástupci stavebníka</div>
                                    <div class="formular-field-row">
                                        <div class="formular-field">
                                            <div class="formular-field-label">Název</div>
                                            <div class="formular-field-value">Signal Projekt s.r.o.</div>
                                        </div>
                                        <div class="formular-field">
                                            <div class="formular-field-label">IČO</div>
                                            <div class="formular-field-value">25525441</div>
                                        </div>
                                    </div>
                                    <div class="formular-field-row">
                                        <div class="formular-field full">
                                            <div class="formular-field-label">Sídlo</div>
                                            <div class="formular-field-value">Vídeňská 546/55, Štýřice, 639 00 Brno 39</div>
                                        </div>
                                    </div>
                                    <div class="formular-field-row">
                                        <div class="formular-field">
                                            <div class="formular-field-label">Jednající</div>
                                            <div class="formular-field-value">Jana Mikulová</div>
                                        </div>
                                        <div class="formular-field">
                                            <div class="formular-field-label">ID datové schránky</div>
                                            <div class="formular-field-value">swz2av2</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="formular-section">
                                <div class="formular-section-title">ČÁST B – ÚDAJE O ZÁMĚRU</div>
                                
                                <div class="formular-subsection">
                                    <div class="formular-subsection-title">B.1 Základní údaje</div>
                                    <div class="formular-field-row">
                                        <div class="formular-field full">
                                            <div class="formular-field-label">Název stavby / záměru</div>
                                            <div class="formular-field-value">Oprava zabezpečovacího zařízení v žst. Doudleby n. Orlicí</div>
                                        </div>
                                    </div>
                                    <div class="formular-field-row">
                                        <div class="formular-field">
                                            <div class="formular-field-label">Místo stavby (obec, ulice)</div>
                                            <div class="formular-field-value">Doudleby n.O., Vamberk, Záměl, Kostelec n.O.</div>
                                        </div>
                                        <div class="formular-field">
                                            <div class="formular-field-label">Katastrální území</div>
                                            <div class="formular-field-value">Doudleby n.O., Kostelec n.O., Vamberk, Záměl</div>
                                        </div>
                                    </div>
                                    <div class="formular-field-row">
                                        <div class="formular-field full">
                                            <div class="formular-field-label">Parcelní čísla pozemků</div>
                                            <div class="formular-field-value">st. 321, st. 916, 139/4, 520/13, 1549, 1550/1, 1550/2, 3334… (celkem 38 parcel)</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="formular-subsection">
                                    <div class="formular-subsection-title">B.2 Charakteristika záměru</div>
                                    <div class="formular-field-row">
                                        <div class="formular-field">
                                            <div class="formular-field-label">Druh stavby</div>
                                            <div class="formular-field-value">Stavba dráhy — dráha celostátní</div>
                                        </div>
                                        <div class="formular-field">
                                            <div class="formular-field-label">Účel užívání</div>
                                            <div class="formular-field-value">Bydlení</div>
                                        </div>
                                    </div>
                                    <div class="formular-field-row">
                                        <div class="formular-field">
                                            <div class="formular-field-label">Zastavěná plocha</div>
                                            <div class="formular-field-value">185 m²</div>
                                        </div>
                                        <div class="formular-field">
                                            <div class="formular-field-label">Obestavěný prostor</div>
                                            <div class="formular-field-value">1 250 m³</div>
                                        </div>
                                        <div class="formular-field">
                                            <div class="formular-field-label">Počet bytů</div>
                                            <div class="formular-field-value">—</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="formular-footer">
                                <div class="formular-page-info">Strana 1 z 3</div>
                                <div class="formular-note">Náhled formuláře dle vyhlášky č. 149/2024 Sb.</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- TAB: Přílohy (aktivní pouze v režimu Formulář) -->
                    <div class="zadost-data-tab" id="zadostDataPrilohy"></div>
                    
                    <!-- TAB: Dokladová část -->
                    <div class="zadost-data-tab" id="zadostDataDoklady"></div>
                    
                </div>
            </div>
            
            <!-- PRAVÉ OKNO: Panel kontroly -->
            <div class="zadost-deficiency-panel">
                <!-- REŽIM: Elektronická žádost (výchozí) -->
                <div class="zadost-panel-mode active" id="panelModeZadost">
                    <div class="deficiency-panel-header">
                        <div class="deficiency-panel-title">
                            <span class="material-icons-outlined">checklist</span>
                            Přehled kontroly
                        </div>
                        <div class="deficiency-panel-summary" id="deficiencySummary">
                            <span class="deficiency-stat ok">
                                <span class="material-icons-outlined">check_circle</span>
                                <span id="statOkCount">0</span> v pořádku
                            </span>
                            <span class="deficiency-stat vada">
                                <span class="material-icons-outlined">error</span>
                                <span id="statVadaCount">0</span> vad
                            </span>
                            <span class="deficiency-stat pending">
                                <span class="material-icons-outlined">radio_button_unchecked</span>
                                <span id="statPendingCount">8</span> zbývá
                            </span>
                        </div>
                    </div>
                    
                    <div class="deficiency-panel-content" id="deficiencyPanelContent">
                        <!-- Výchozí stav - žádné nedostatky -->
                        <div class="deficiency-empty" id="deficiencyEmpty">
                            <span class="material-icons-outlined">task_alt</span>
                            <div class="deficiency-empty-title">Zatím bez nedostatků</div>
                            <div class="deficiency-empty-text">Projděte jednotlivé sekce žádosti a označte je jako „V pořádku" nebo „Vada".</div>
                        </div>
                        
                        <!-- Seznam nedostatků (dynamicky generovaný) -->
                        <div class="deficiency-list" id="deficiencyList" style="display: none;">
                            <!-- Položky budou přidány JavaScriptem -->
                        </div>
                    </div>
                    
                    <div class="deficiency-panel-footer">
                        <div class="deficiency-result pending" id="deficiencyResult">
                            <span class="material-icons-outlined">hourglass_empty</span>
                            <div>
                                <strong>Kontrola probíhá</strong>
                                <div style="font-size: 11px; margin-top: 2px;">Zkontrolujte všech 8 sekcí žádosti</div>
                            </div>
                        </div>
                        <div class="deficiency-panel-actions">
                            <button class="btn btn-secondary" onclick="closeControl('controlZadost')">Zrušit</button>
                            <button class="btn btn-primary" id="btnConfirmZadost" onclick="completeZadostKontrola()" disabled>
                                <span class="material-icons-outlined">check</span>
                                Potvrdit kontrolu
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- REŽIM: Listinný formulář -->
                <div class="zadost-panel-mode" id="panelModeFormular">
                    <div class="deficiency-panel-header">
                        <div class="deficiency-panel-header-top">
                            <div class="deficiency-panel-title">
                                <span class="material-icons-outlined">fact_check</span>
                                Kontrola formuláře
                            </div>
                            <button class="btn-vse-ok-small" onclick="setAllFormularStepsOk()" title="Označit vše jako v pořádku">
                                <span class="material-icons-outlined">done_all</span>
                                Vše v pořádku
                            </button>
                        </div>
                        <div class="deficiency-panel-summary" id="formularSummary">
                            <span class="deficiency-stat ok">
                                <span class="material-icons-outlined">check_circle</span>
                                <span id="formularOkCount">0</span> v pořádku
                            </span>
                            <span class="deficiency-stat vada">
                                <span class="material-icons-outlined">error</span>
                                <span id="formularVadaCount">0</span> vad
                            </span>
                        </div>
                    </div>
                    
                    <div class="formular-checklist-content">
                        <div class="formular-checklist-intro">
                            <span class="material-icons-outlined">info</span>
                            Prohlédněte si naskenovaný formulář vlevo a postupně zkontrolujte jednotlivé části.
                        </div>
                        
                        <!-- Checklist kroků -->
                        <div class="formular-checklist" id="formularChecklist">
                            <!-- Krok 1: Údaje o podání -->
                            <div class="formular-check-item" id="formularCheckPodani" data-step="podani">
                                <div class="formular-check-header">
                                    <div class="formular-check-icon">
                                        <span class="material-icons-outlined">assignment_ind</span>
                                    </div>
                                    <div class="formular-check-title">Údaje o podání</div>
                                    <div class="formular-check-status" id="formularStatusPodani">
                                        <span class="material-icons-outlined">radio_button_unchecked</span>
                                    </div>
                                </div>
                                <div class="formular-check-actions">
                                    <button class="formular-btn-ok" onclick="setFormularStepStatus('podani', 'ok')">
                                        <span class="material-icons-outlined">check</span>
                                        V pořádku
                                    </button>
                                    <button class="formular-btn-vada" onclick="setFormularStepStatus('podani', 'vada')">
                                        <span class="material-icons-outlined">error_outline</span>
                                        Vada
                                    </button>
                                </div>
                                <div class="formular-check-change" id="formularChangePodani" style="display: none;">
                                    <button class="formular-btn-change" onclick="resetFormularStepStatus('podani')">
                                        <span class="material-icons-outlined">edit</span>
                                        Změnit
                                    </button>
                                </div>
                                <div class="formular-check-vada-input" id="formularVadaInputPodani" style="display: none;">
                                    <textarea placeholder="Popište zjištěnou vadu..." id="formularVadaTextPodani"></textarea>
                                </div>
                            </div>
                            
                            <!-- Krok 2: Žadatel -->
                            <div class="formular-check-item" id="formularCheckZadatel" data-step="zadatel">
                                <div class="formular-check-header">
                                    <div class="formular-check-icon">
                                        <span class="material-icons-outlined">person</span>
                                    </div>
                                    <div class="formular-check-title">Žadatel</div>
                                    <div class="formular-check-status" id="formularStatusZadatel">
                                        <span class="material-icons-outlined">radio_button_unchecked</span>
                                    </div>
                                </div>
                                <div class="formular-check-actions">
                                    <button class="formular-btn-ok" onclick="setFormularStepStatus('zadatel', 'ok')">
                                        <span class="material-icons-outlined">check</span>
                                        V pořádku
                                    </button>
                                    <button class="formular-btn-vada" onclick="setFormularStepStatus('zadatel', 'vada')">
                                        <span class="material-icons-outlined">error_outline</span>
                                        Vada
                                    </button>
                                </div>
                                <div class="formular-check-change" id="formularChangeZadatel" style="display: none;">
                                    <button class="formular-btn-change" onclick="resetFormularStepStatus('zadatel')">
                                        <span class="material-icons-outlined">edit</span>
                                        Změnit
                                    </button>
                                </div>
                                <div class="formular-check-vada-input" id="formularVadaInputZadatel" style="display: none;">
                                    <textarea placeholder="Popište zjištěnou vadu..." id="formularVadaTextZadatel"></textarea>
                                </div>
                            </div>
                            
                            <!-- Krok 3: Zástupce -->
                            <div class="formular-check-item" id="formularCheckZastupce" data-step="zastupce">
                                <div class="formular-check-header">
                                    <div class="formular-check-icon">
                                        <span class="material-icons-outlined">supervisor_account</span>
                                    </div>
                                    <div class="formular-check-title">Zástupce</div>
                                    <div class="formular-check-status" id="formularStatusZastupce">
                                        <span class="material-icons-outlined">radio_button_unchecked</span>
                                    </div>
                                </div>
                                <div class="formular-check-actions">
                                    <button class="formular-btn-ok" onclick="setFormularStepStatus('zastupce', 'ok')">
                                        <span class="material-icons-outlined">check</span>
                                        V pořádku
                                    </button>
                                    <button class="formular-btn-vada" onclick="setFormularStepStatus('zastupce', 'vada')">
                                        <span class="material-icons-outlined">error_outline</span>
                                        Vada
                                    </button>
                                    <button class="formular-btn-skip" onclick="setFormularStepStatus('zastupce', 'skip')">
                                        <span class="material-icons-outlined">remove</span>
                                        Neuveden
                                    </button>
                                </div>
                                <div class="formular-check-change" id="formularChangeZastupce" style="display: none;">
                                    <button class="formular-btn-change" onclick="resetFormularStepStatus('zastupce')">
                                        <span class="material-icons-outlined">edit</span>
                                        Změnit
                                    </button>
                                </div>
                                <div class="formular-check-vada-input" id="formularVadaInputZastupce" style="display: none;">
                                    <textarea placeholder="Popište zjištěnou vadu..." id="formularVadaTextZastupce"></textarea>
                                </div>
                            </div>
                            
                            <!-- Krok 4: Identifikace záměru -->
                            <div class="formular-check-item" id="formularCheckZamer" data-step="zamer">
                                <div class="formular-check-header">
                                    <div class="formular-check-icon">
                                        <span class="material-icons-outlined">domain</span>
                                    </div>
                                    <div class="formular-check-title">Identifikace záměru</div>
                                    <div class="formular-check-status" id="formularStatusZamer">
                                        <span class="material-icons-outlined">radio_button_unchecked</span>
                                    </div>
                                </div>
                                <div class="formular-check-actions">
                                    <button class="formular-btn-ok" onclick="setFormularStepStatus('zamer', 'ok')">
                                        <span class="material-icons-outlined">check</span>
                                        V pořádku
                                    </button>
                                    <button class="formular-btn-vada" onclick="setFormularStepStatus('zamer', 'vada')">
                                        <span class="material-icons-outlined">error_outline</span>
                                        Vada
                                    </button>
                                </div>
                                <div class="formular-check-change" id="formularChangeZamer" style="display: none;">
                                    <button class="formular-btn-change" onclick="resetFormularStepStatus('zamer')">
                                        <span class="material-icons-outlined">edit</span>
                                        Změnit
                                    </button>
                                </div>
                                <div class="formular-check-vada-input" id="formularVadaInputZamer" style="display: none;">
                                    <textarea placeholder="Popište zjištěnou vadu..." id="formularVadaTextZamer"></textarea>
                                </div>
                            </div>
                            
                            <!-- Krok 5: Pozemky -->
                            <div class="formular-check-item" id="formularCheckPozemky" data-step="pozemky">
                                <div class="formular-check-header">
                                    <div class="formular-check-icon">
                                        <span class="material-icons-outlined">grid_on</span>
                                    </div>
                                    <div class="formular-check-title">Pozemky záměru</div>
                                    <div class="formular-check-status" id="formularStatusPozemky">
                                        <span class="material-icons-outlined">radio_button_unchecked</span>
                                    </div>
                                </div>
                                <div class="formular-check-actions">
                                    <button class="formular-btn-ok" onclick="setFormularStepStatus('pozemky', 'ok')">
                                        <span class="material-icons-outlined">check</span>
                                        V pořádku
                                    </button>
                                    <button class="formular-btn-vada" onclick="setFormularStepStatus('pozemky', 'vada')">
                                        <span class="material-icons-outlined">error_outline</span>
                                        Vada
                                    </button>
                                </div>
                                <div class="formular-check-change" id="formularChangePozemky" style="display: none;">
                                    <button class="formular-btn-change" onclick="resetFormularStepStatus('pozemky')">
                                        <span class="material-icons-outlined">edit</span>
                                        Změnit
                                    </button>
                                </div>
                                <div class="formular-check-vada-input" id="formularVadaInputPozemky" style="display: none;">
                                    <textarea placeholder="Popište zjištěnou vadu..." id="formularVadaTextPozemky"></textarea>
                                </div>
                            </div>
                            
                            <!-- Krok 6: Přílohy -->
                            <div class="formular-check-item" id="formularCheckPrilohy" data-step="prilohy">
                                <div class="formular-check-header">
                                    <div class="formular-check-icon">
                                        <span class="material-icons-outlined">attach_file</span>
                                    </div>
                                    <div class="formular-check-title">Přílohy žádosti</div>
                                    <div class="formular-check-status" id="formularStatusPrilohy">
                                        <span class="material-icons-outlined">radio_button_unchecked</span>
                                    </div>
                                </div>
                                <div class="formular-check-actions">
                                    <button class="formular-btn-ok" onclick="setFormularStepStatus('prilohy', 'ok')">
                                        <span class="material-icons-outlined">check</span>
                                        V pořádku
                                    </button>
                                    <button class="formular-btn-vada" onclick="setFormularStepStatus('prilohy', 'vada')">
                                        <span class="material-icons-outlined">error_outline</span>
                                        Vada
                                    </button>
                                </div>
                                <div class="formular-check-change" id="formularChangePrilohy" style="display: none;">
                                    <button class="formular-btn-change" onclick="resetFormularStepStatus('prilohy')">
                                        <span class="material-icons-outlined">edit</span>
                                        Změnit
                                    </button>
                                </div>
                                <div class="formular-check-vada-input" id="formularVadaInputPrilohy" style="display: none;">
                                    <textarea placeholder="Popište zjištěnou vadu..." id="formularVadaTextPrilohy"></textarea>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="deficiency-panel-footer">
                        <div class="deficiency-result pending" id="formularResult">
                            <span class="material-icons-outlined">hourglass_empty</span>
                            <div>
                                <strong>Kontrola probíhá</strong>
                                <div style="font-size: 11px; margin-top: 2px;">Zkontrolujte všechny části formuláře</div>
                            </div>
                        </div>
                        <div class="deficiency-panel-actions">
                            <button class="btn btn-secondary" onclick="closeControl('controlZadost')">Zrušit</button>
                            <button class="btn btn-primary" id="btnConfirmFormular" onclick="completeFormularKontrola()" disabled>
                                <span class="material-icons-outlined">check</span>
                                Potvrdit kontrolu
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Kontrola: Pozemky -->
    <div class="control-overlay" id="controlPozemky">
        <div class="control-header">
            <div class="control-header-left">
                <button class="control-close" onclick="closeControl('controlPozemky')">
                    <span class="material-icons-outlined">close</span>
                </button>
                <div class="control-title">
                    <span class="material-icons-outlined">terrain</span>
                    Pozemky
                </div>
            </div>
        </div>
        <div class="control-body">
            <div class="control-viewer">
                <div class="viewer-tabs">
                    <div class="viewer-tabs-left">
                        <button class="viewer-tab active" onclick="switchPozemkyTab(this, 'zadost')">
                            <span class="material-icons-outlined">description</span>
                            Žádost
                        </button>
                        <button class="viewer-tab" onclick="switchPozemkyTab(this, 'situace')">
                            <span class="material-icons-outlined">architecture</span>
                            Situační výkresy
                        </button>
                        <button class="viewer-tab" onclick="switchPozemkyTab(this, 'kn')">
                            <span class="material-icons-outlined">terrain</span>
                            Katastr
                        </button>
                        <button class="viewer-tab" onclick="switchPozemkyTab(this, 'mapa')">
                            <span class="material-icons-outlined">map</span>
                            Mapa
                        </button>
                    </div>
                    <button class="viewer-open-external" onclick="openViewerExternal('pozemky')" title="Otevřít v novém okně">
                        <span class="material-icons-outlined">open_in_new</span>
                    </button>
                </div>
                <div class="viewer-content">
                    <div class="viewer-placeholder" id="viewer-pozemky">
                        <span class="material-icons-outlined">description</span>
                        <div class="viewer-placeholder-title">Žádost o povolení stavby</div>
                        <div class="viewer-placeholder-text">Pozemky uvedené stavebníkem v žádosti</div>
                    </div>
                </div>
            </div>
            <div class="control-form">
                <div class="control-form-body">
                    <!-- Pozemky záměru - ze žádosti, editovatelné -->
                    <div class="pozemky-section">
                        <div class="pozemky-section-header">
                            <div class="pozemky-section-title">
                                <span class="material-icons-outlined">location_on</span>
                                Pozemky záměru
                            </div>
                            <span class="pozemky-section-badge" id="pozemkyZameruCount">5 parcel</span>
                            <div class="pozemky-view-toggle" id="pozemkyZameruToggle">
                                <button class="pozemky-view-btn active" onclick="setPozemkyView('zameru', 'chips')" title="Kompaktní zobrazení">
                                    <span class="material-icons-outlined">view_module</span>
                                </button>
                                <button class="pozemky-view-btn" onclick="setPozemkyView('zameru', 'list')" title="Řádkové zobrazení">
                                    <span class="material-icons-outlined">view_list</span>
                                </button>
                                <button class="pozemky-view-btn" onclick="setPozemkyView('zameru', 'grouped')" title="Seskupené podle k.ú.">
                                    <span class="material-icons-outlined">folder_open</span>
                                </button>
                            </div>
                        </div>
                        <p style="font-size: 12px; color: #5f6368; margin-bottom: 12px;">
                            Pozemky načtené ze žádosti. V případě chyby můžete seznam upravit.
                        </p>
                        <div id="pozemkyZameruList">
                            <!-- Dynamicky renderováno JavaScriptem -->
                        </div>
                        
                        <!-- Přidání pozemku - volba metody -->
                        <p style="font-size: 12px; color: #5f6368; margin: 16px 0 8px 0; font-weight: 500;">
                            Přidat pozemek:
                        </p>
                        <div class="neighbor-method-selector" style="margin-bottom: 12px;">
                            <button class="neighbor-method-btn active" onclick="selectPozemekMethod('rucne')" data-method="rucne">
                                <span class="material-icons-outlined">edit</span>
                                <span>Ručně</span>
                            </button>
                            <button class="neighbor-method-btn" onclick="selectPozemekMethod('mapa')" data-method="mapa">
                                <span class="material-icons-outlined">map</span>
                                <span>Z mapy</span>
                            </button>
                        </div>
                        
                        <!-- Ruční zadání -->
                        <div class="pozemky-add-section" id="pozemekMethodRucne">
                            <div class="pozemky-add-row" style="flex-wrap: wrap; gap: 8px;">
                                <select class="pozemky-add-input" id="pozemekObec" style="flex: 1; min-width: 150px;" onchange="loadKatastralniUzemi()">
                                    <option value="">Vyberte obec...</option>
                                    <option value="doudleby" selected>Doudleby nad Orlicí</option>
                                    <option value="tabor">Tábor</option>
                                    <option value="soběslav">Soběslav</option>
                                    <option value="jiné">Jiná obec...</option>
                                </select>
                                <select class="pozemky-add-input" id="pozemekKU" style="flex: 1; min-width: 150px;">
                                    <option value="">Vyberte k.ú....</option>
                                    <option value="doudleby-631761" selected>Doudleby nad Orlicí</option>
                                    <option value="horusice-779091">Horusice</option>
                                </select>
                                <input type="text" class="pozemky-add-input" id="pozemekZameruInput" placeholder="Číslo parcely..." style="flex: 1; min-width: 120px;">
                                <button class="btn-add-pozemek" onclick="addPozemekZameru()">
                                    <span class="material-icons-outlined">add</span>
                                    Přidat
                                </button>
                            </div>
                        </div>
                        
                        <!-- Z mapy -->
                        <div class="pozemky-add-section" id="pozemekMethodMapa" style="display: none;">
                            <div style="background: #f8f9fa; border: 1px dashed #dadce0; border-radius: 8px; padding: 16px; text-align: center;">
                                <span class="material-icons-outlined" style="font-size: 32px; color: #5f6368; display: block; margin-bottom: 8px;">map</span>
                                <p style="font-size: 12px; color: #5f6368; margin: 0;">
                                    Kliknutím na parcelu v mapě vlevo ji přidáte do seznamu pozemků záměru.
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- Sousední pozemky -->
                    <div class="pozemky-section">
                        <div class="pozemky-section-header">
                            <div class="pozemky-section-title">
                                <span class="material-icons-outlined">grid_view</span>
                                Sousední pozemky
                            </div>
                            <span class="pozemky-section-badge" id="sousedniCount">12 parcel</span>
                            <div class="pozemky-view-toggle" id="sousedniToggle">
                                <button class="pozemky-view-btn active" onclick="setPozemkyView('sousedni', 'chips')" title="Kompaktní zobrazení">
                                    <span class="material-icons-outlined">view_module</span>
                                </button>
                                <button class="pozemky-view-btn" onclick="setPozemkyView('sousedni', 'list')" title="Řádkové zobrazení">
                                    <span class="material-icons-outlined">view_list</span>
                                </button>
                                <button class="pozemky-view-btn" onclick="setPozemkyView('sousedni', 'grouped')" title="Seskupené podle k.ú.">
                                    <span class="material-icons-outlined">folder_open</span>
                                </button>
                            </div>
                        </div>

                        <p style="font-size: 12px; color: #5f6368; margin-bottom: 12px;">
                            Vyberte metodu identifikace sousedních pozemků:
                        </p>

                        <!-- Metoda výběru -->
                        <div class="neighbor-method-selector" id="sousedniMethodSelector">
                            <button class="neighbor-method-btn active" onclick="selectNeighborMethod('auto')" data-method="auto">
                                <span class="material-icons-outlined">auto_awesome</span>
                                <span>Automaticky</span>
                            </button>
                            <button class="neighbor-method-btn" onclick="selectNeighborMethod('rucne')" data-method="rucne">
                                <span class="material-icons-outlined">edit</span>
                                <span>Ručně</span>
                            </button>
                            <button class="neighbor-method-btn" onclick="selectNeighborMethod('mapa')" data-method="mapa">
                                <span class="material-icons-outlined">map</span>
                                <span>Z mapy</span>
                            </button>
                        </div>

                        <!-- Automatická metoda -->
                        <div class="neighbor-method-content" id="methodAuto">
                            <button class="btn-autodetect" onclick="autoDetectSousedni()" id="btnAutoDetect">
                                <span class="material-icons-outlined">auto_awesome</span>
                                Automaticky identifikovat sousedy
                            </button>
                        </div>

                        <!-- Ruční metoda -->
                        <div class="neighbor-method-content" id="methodRucne" style="display: none;">
                            <div class="pozemky-add-row" style="flex-wrap: wrap; gap: 8px;">
                                <select class="pozemky-add-input" id="sousedObec" style="flex: 1; min-width: 150px;" onchange="loadSousedKatastralniUzemi()">
                                    <option value="">Vyberte obec...</option>
                                    <option value="doudleby" selected>Doudleby nad Orlicí</option>
                                    <option value="tabor">Tábor</option>
                                    <option value="soběslav">Soběslav</option>
                                    <option value="jiné">Jiná obec...</option>
                                </select>
                                <select class="pozemky-add-input" id="sousedKU" style="flex: 1; min-width: 150px;">
                                    <option value="">Vyberte k.ú....</option>
                                    <option value="doudleby-631761" selected>Doudleby nad Orlicí</option>
                                    <option value="horusice-779091">Horusice</option>
                                </select>
                                <input type="text" class="pozemky-add-input" id="sousedniSearchInput" placeholder="Číslo parcely..." style="flex: 1; min-width: 120px;">
                                <button class="btn-add-pozemek" onclick="addSousedniRucne()">
                                    <span class="material-icons-outlined">add</span>
                                    Přidat
                                </button>
                            </div>
                        </div>

                        <!-- Z mapy -->
                        <div class="neighbor-method-content" id="methodMapa" style="display: none;">
                            <div style="background: #f8f9fa; border: 1px dashed #dadce0; border-radius: 8px; padding: 16px; text-align: center;">
                                <span class="material-icons-outlined" style="font-size: 32px; color: #5f6368; display: block; margin-bottom: 8px;">map</span>
                                <p style="font-size: 12px; color: #5f6368; margin: 0;">
                                    Kliknutím na parcely v mapě vlevo je přidáte do seznamu sousedních pozemků.
                                </p>
                            </div>
                        </div>

                        <!-- Seznam sousedních parcel -->
                        <div class="sousedni-list" id="sousedniList">
                            <div class="sousedni-empty" id="sousedniEmpty">
                                <span class="material-icons-outlined">grid_view</span>
                                <div class="sousedni-empty-text">Zatím nejsou identifikovány žádné sousední pozemky</div>
                                <div class="sousedni-empty-hint">Použijte některou z metod výše</div>
                            </div>
                        </div>
                    </div>

                    <div class="result-preview positive" id="resultPozemky">
                        <div class="result-preview-title">
                            <span class="material-icons-outlined">check_circle</span>
                            Pozemky identifikovány
                        </div>
                        <div class="result-preview-text">Pozemky záměru a sousední pozemky byly identifikovány. Vlastníci budou určeni v části Osoby.</div>
                    </div>
                </div>
                <div class="control-form-footer">
                    <div class="control-form-footer-left">
                        <div class="auto-save-indicator saved" id="autoSavePozemky">
                            <span class="material-icons-outlined">cloud_done</span>
                            <span>Automaticky uloženo</span>
                        </div>
                    </div>
                    <div class="control-form-footer-right">
                        <button class="btn btn-secondary" onclick="closeControl('controlPozemky')">Zrušit</button>
                        <button class="btn-save-draft" onclick="saveDraft('pozemky')" title="Uložit rozpracovanou kontrolu">
                            <span class="material-icons-outlined">save</span>
                            Uložit
                        </button>
                        <button class="btn btn-primary" id="btnConfirmPozemky" onclick="completePozemky()">
                            <span class="material-icons-outlined">check</span>
                            Potvrdit kontrolu
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="control-overlay" id="controlDokumentace">
        <div class="control-header">
            <div class="control-header-left">
                <button class="control-close" onclick="closeControl('controlDokumentace')">
                    <span class="material-icons-outlined">close</span>
                </button>
                <div class="control-title">
                    <span class="material-icons-outlined">architecture</span>
                    Kontrola dokumentace
                </div>
            </div>
        </div>
        <div class="control-body">
            <!-- Levý panel - prohlížeč struktury dokumentace -->
            <div class="control-viewer">
                <div class="viewer-tabs">
                    <div class="viewer-tabs-left">
                        <button class="viewer-tab ed-back-btn" id="edBackBtn" onclick="backToEdStructure()" style="display: none;">
                            <span class="material-icons-outlined">arrow_back</span>
                            Zpět do ED
                        </button>
                        <div class="ed-breadcrumb" id="edBreadcrumb">
                            <span class="material-icons-outlined" style="font-size: 18px; color: #5f6368;">folder_special</span>
                            <span style="font-weight: 500; color: #202124;">Struktura dokumentace</span>
                        </div>
                    </div>
                    <button class="viewer-open-external" onclick="openViewerExternal('dokumentace')" title="Otevřít v novém okně">
                        <span class="material-icons-outlined">open_in_new</span>
                    </button>
                </div>
                <div class="viewer-content" style="background: #fff;">
                    <!-- Struktura ED -->
                    <div class="ed-tree-container" id="edTreeContainer" style="padding: 16px;">
                        <div class="ed-tree" id="edTree">
                            <div class="ed-tree-header">
                                <div class="ed-tree-header-top">
                                    <span class="material-icons-outlined">folder_special</span>
                                    <strong>SR00X01HLDRP</strong>
                                    <span style="color: #5f6368; font-size: 12px; margin-left: 8px;">Oprava zabezpečovacího zařízení v žst. Doudleby n. Orlicí</span>
                                </div>
                                <div class="ed-version-selector">
                                    <label style="font-size: 11px; color: #5f6368; margin-right: 6px;">Verze:</label>
                                    <select class="ed-version-select" id="edVersionSelect" onchange="changeEdVersion()">
                                        <option value="v3" selected>v3 (aktuální) — 10. 1. 2026</option>
                                        <option value="v2">v2 — 18. 12. 2025</option>
                                        <option value="v1">v1 — 2. 12. 2025</option>
                                    </select>
                                </div>
                            </div>
                            
                            <!-- A. Průvodní zpráva -->
                            <div class="ed-folder" data-section="A">
                                <div class="ed-folder-header" onclick="toggleEdFolder(this)">
                                    <span class="material-icons-outlined folder-icon">folder</span>
                                    <span class="folder-name">A. Průvodní zpráva</span>
                                    <span class="folder-count">1 soubor</span>
                                </div>
                                <div class="ed-folder-content">
                                    <div class="ed-file" onclick="previewEdFile('A - akt..pdf', 'A')">
                                        <span class="material-icons-outlined">description</span>
                                        <span class="file-name">A - akt..pdf</span>
                                        <span class="file-size">245 kB</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- B. Souhrnná technická zpráva -->
                            <div class="ed-folder" data-section="B">
                                <div class="ed-folder-header" onclick="toggleEdFolder(this)">
                                    <span class="material-icons-outlined folder-icon">folder</span>
                                    <span class="folder-name">B. Souhrnná technická zpráva</span>
                                    <span class="folder-count">1 soubor</span>
                                </div>
                                <div class="ed-folder-content">
                                    <div class="ed-file" onclick="previewEdFile('B - akt..pdf', 'B')">
                                        <span class="material-icons-outlined">description</span>
                                        <span class="file-name">B - akt..pdf</span>
                                        <span class="file-size">1.8 MB</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- C. Situační výkresy -->
                            <div class="ed-folder" data-section="C">
                                <div class="ed-folder-header" onclick="toggleEdFolder(this)">
                                    <span class="material-icons-outlined folder-icon">folder</span>
                                    <span class="folder-name">C. Situační výkresy</span>
                                    <span class="folder-count">32 souborů</span>
                                </div>
                                <div class="ed-folder-content">
                                    <div class="ed-folder nested">
                                        <div class="ed-folder-header" onclick="toggleEdFolder(this)">
                                            <span class="material-icons-outlined folder-icon">folder</span>
                                            <span class="folder-name">C.1 Výkres širších vztahů</span>
                                            <span class="folder-count">2 soubory</span>
                                        </div>
                                        <div class="ed-folder-content">
                                            <div class="ed-file" onclick="previewEdFile('C.pdf', 'C')">
                                                <span class="material-icons-outlined">description</span>
                                                <span class="file-name">C.pdf</span>
                                                <span class="file-size">48 kB</span>
                                            </div>
                                            <div class="ed-file" onclick="previewEdFile('C.1-001.pdf', 'C')">
                                                <span class="material-icons-outlined">description</span>
                                                <span class="file-name">C.1-001.pdf</span>
                                                <span class="file-size">890 kB</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="ed-folder nested">
                                        <div class="ed-folder-header" onclick="toggleEdFolder(this)">
                                            <span class="material-icons-outlined folder-icon">folder</span>
                                            <span class="folder-name">C.2 Katastrální situační výkres</span>
                                            <span class="folder-count">15 souborů</span>
                                        </div>
                                        <div class="ed-folder-content">
                                            <div class="ed-file" onclick="previewEdFile('C.2-001 - akt..pdf', 'C')">
                                                <span class="material-icons-outlined">description</span>
                                                <span class="file-name">C.2-001 - akt..pdf</span>
                                                <span class="file-size">1.1 MB</span>
                                            </div>
                                            <div class="ed-file" onclick="previewEdFile('C.2-006- akt..pdf', 'C')">
                                                <span class="material-icons-outlined">description</span>
                                                <span class="file-name">C.2-006- akt..pdf</span>
                                                <span class="file-size">980 kB</span>
                                            </div>
                                            <div class="ed-file-more">+ dalších 13 souborů (C.2-002 … C.2-015)</div>
                                        </div>
                                    </div>
                                    <div class="ed-folder nested">
                                        <div class="ed-folder-header" onclick="toggleEdFolder(this)">
                                            <span class="material-icons-outlined folder-icon">folder</span>
                                            <span class="folder-name">C.3 Koordinační situační výkres</span>
                                            <span class="folder-count">15 souborů</span>
                                        </div>
                                        <div class="ed-folder-content">
                                            <div class="ed-file" onclick="previewEdFile('C.3-001- akt..pdf', 'C')">
                                                <span class="material-icons-outlined">description</span>
                                                <span class="file-name">C.3-001- akt..pdf</span>
                                                <span class="file-size">1.4 MB</span>
                                            </div>
                                            <div class="ed-file-more">+ dalších 14 souborů (C.3-002 … C.3-015)</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- D. Dokumentace objektů -->
                            <div class="ed-folder" data-section="D">
                                <div class="ed-folder-header" onclick="toggleEdFolder(this)">
                                    <span class="material-icons-outlined folder-icon">folder</span>
                                    <span class="folder-name">D. Dokumentace objektů</span>
                                    <span class="folder-count">213 souborů</span>
                                </div>
                                <div class="ed-folder-content">
                                    <!-- D — obálky -->
                                    <div class="ed-file" onclick="previewEdFile('D.pdf', 'D')">
                                        <span class="material-icons-outlined">description</span>
                                        <span class="file-name">D.pdf</span>
                                        <span class="file-size">38 kB</span>
                                    </div>
                                    <div class="ed-file" onclick="previewEdFile('D.1.pdf', 'D')">
                                        <span class="material-icons-outlined">description</span>
                                        <span class="file-name">D.1.pdf</span>
                                        <span class="file-size">42 kB</span>
                                    </div>
                                    <div class="ed-file" onclick="previewEdFile('D.2.pdf', 'D')">
                                        <span class="material-icons-outlined">description</span>
                                        <span class="file-name">D.2.pdf</span>
                                        <span class="file-size">40 kB</span>
                                    </div>
                                    <!-- D.1 SO — Stavební objekty -->
                                    <div class="ed-folder nested">
                                        <div class="ed-folder-header" onclick="toggleEdFolder(this)">
                                            <span class="material-icons-outlined folder-icon">folder</span>
                                            <span class="folder-name">SO — Stavební objekty</span>
                                            <span class="folder-count">12 objektů</span>
                                        </div>
                                        <div class="ed-folder-content">
                                            <div class="ed-folder nested">
                                                <div class="ed-folder-header" onclick="toggleEdFolder(this)">
                                                    <span class="material-icons-outlined folder-icon">folder</span>
                                                    <span class="folder-name">SO 12-12-01 Úprava nástupiště</span>
                                                    <span class="folder-count">5 souborů</span>
                                                </div>
                                                <div class="ed-folder-content">
                                                    <div class="ed-file" onclick="previewEdFile('SO121201_1_001_TZ.pdf', 'D')">
                                                        <span class="material-icons-outlined">description</span>
                                                        <span class="file-name">SO121201_1_001_TZ.pdf</span>
                                                        <span class="file-size">320 kB</span>
                                                    </div>
                                                    <div class="ed-file-more">+ další 4 soubory</div>
                                                </div>
                                            </div>
                                            <div class="ed-folder nested">
                                                <div class="ed-folder-header" onclick="toggleEdFolder(this)">
                                                    <span class="material-icons-outlined folder-icon">folder</span>
                                                    <span class="folder-name">SO 12-71-01 Stavební úpravy výpravní budovy</span>
                                                    <span class="folder-count">4 soubory</span>
                                                </div>
                                                <div class="ed-folder-content">
                                                    <div class="ed-file" onclick="previewEdFile('SO127101_1_001_TZ.pdf', 'D')">
                                                        <span class="material-icons-outlined">description</span>
                                                        <span class="file-name">SO127101_1_001_TZ.pdf</span>
                                                        <span class="file-size">280 kB</span>
                                                    </div>
                                                    <div class="ed-file-more">+ další 3 soubory</div>
                                                </div>
                                            </div>
                                            <div class="ed-folder nested">
                                                <div class="ed-folder-header" onclick="toggleEdFolder(this)">
                                                    <span class="material-icons-outlined folder-icon">folder</span>
                                                    <span class="folder-name">SO 12-71-02 Kabelovod</span>
                                                    <span class="folder-count">9 souborů</span>
                                                </div>
                                                <div class="ed-folder-content">
                                                    <div class="ed-file" onclick="previewEdFile('SO127102_1_001_TZ.pdf', 'D')">
                                                        <span class="material-icons-outlined">description</span>
                                                        <span class="file-name">SO127102_1_001_TZ.pdf</span>
                                                        <span class="file-size">410 kB</span>
                                                    </div>
                                                    <div class="ed-file-more">+ dalších 8 souborů</div>
                                                </div>
                                            </div>
                                            <div class="ed-file-more">+ dalších 9 SO (SO127201–SO128801)</div>
                                        </div>
                                    </div>
                                    <!-- D.2 PS — Provozní soubory -->
                                    <div class="ed-folder nested">
                                        <div class="ed-folder-header" onclick="toggleEdFolder(this)">
                                            <span class="material-icons-outlined folder-icon">folder</span>
                                            <span class="folder-name">PS — Provozní soubory</span>
                                            <span class="folder-count">14 objektů</span>
                                        </div>
                                        <div class="ed-folder-content">
                                            <div class="ed-folder nested">
                                                <div class="ed-folder-header" onclick="toggleEdFolder(this)">
                                                    <span class="material-icons-outlined folder-icon">folder</span>
                                                    <span class="folder-name">PS 11-01-21 Železniční zabezpečovací zařízení</span>
                                                    <span class="folder-count">22 souborů</span>
                                                </div>
                                                <div class="ed-folder-content">
                                                    <div class="ed-file" onclick="previewEdFile('PS110121_1_001 TECHNICKÁ ZPRÁVA.pdf', 'D')">
                                                        <span class="material-icons-outlined">description</span>
                                                        <span class="file-name">PS110121_1_001 TECHNICKÁ ZPRÁVA.pdf</span>
                                                        <span class="file-size">680 kB</span>
                                                    </div>
                                                    <div class="ed-file" onclick="previewEdFile('PS110121_2_011.pdf', 'D')">
                                                        <span class="material-icons-outlined">description</span>
                                                        <span class="file-name">PS110121_2_011.pdf</span>
                                                        <span class="file-size">1.2 MB</span>
                                                    </div>
                                                    <div class="ed-file-more">+ dalších 20 souborů</div>
                                                </div>
                                            </div>
                                            <div class="ed-folder nested">
                                                <div class="ed-folder-header" onclick="toggleEdFolder(this)">
                                                    <span class="material-icons-outlined folder-icon">folder</span>
                                                    <span class="folder-name">PS 12-01-11 Silnoproudá technologie</span>
                                                    <span class="folder-count">37 souborů</span>
                                                </div>
                                                <div class="ed-folder-content">
                                                    <div class="ed-file" onclick="previewEdFile('PS120111_1_001 TECHNICKÁ ZPRÁVA.pdf', 'D')">
                                                        <span class="material-icons-outlined">description</span>
                                                        <span class="file-name">PS120111_1_001 TECHNICKÁ ZPRÁVA.pdf</span>
                                                        <span class="file-size">540 kB</span>
                                                    </div>
                                                    <div class="ed-file" onclick="previewEdFile('PS120111_2_011.pdf', 'D')">
                                                        <span class="material-icons-outlined">description</span>
                                                        <span class="file-name">PS120111_2_011.pdf</span>
                                                        <span class="file-size">1.8 MB</span>
                                                    </div>
                                                    <div class="ed-file-more">+ dalších 35 souborů</div>
                                                </div>
                                            </div>
                                            <div class="ed-folder nested">
                                                <div class="ed-folder-header" onclick="toggleEdFolder(this)">
                                                    <span class="material-icons-outlined folder-icon">folder</span>
                                                    <span class="folder-name">PS 12-02-01 Kabelové rozvody</span>
                                                    <span class="folder-count">8 souborů</span>
                                                </div>
                                                <div class="ed-folder-content">
                                                    <div class="ed-file" onclick="previewEdFile('PS120201_1_001_TZ.pdf', 'D')">
                                                        <span class="material-icons-outlined">description</span>
                                                        <span class="file-name">PS120201_1_001_TZ.pdf</span>
                                                        <span class="file-size">380 kB</span>
                                                    </div>
                                                    <div class="ed-file-more">+ dalších 7 souborů</div>
                                                </div>
                                            </div>
                                            <div class="ed-folder nested" style="border-left: 2px solid #f9ab00;">
                                                <div class="ed-folder-header" onclick="toggleEdFolder(this)">
                                                    <span class="material-icons-outlined folder-icon" style="color: #e37400;">folder</span>
                                                    <span class="folder-name">PS 12-02-11 Staniční zabezpečovací zařízení</span>
                                                    <span class="folder-count" style="color: #e37400;">16 souborů ⚠️ locked</span>
                                                </div>
                                                <div class="ed-folder-content">
                                                    <div class="ed-file" onclick="previewEdFile('PS120211_1_001_TZ.pdf', 'D')">
                                                        <span class="material-icons-outlined" style="color: #e37400;">description</span>
                                                        <span class="file-name">PS120211_1_001_TZ.pdf</span>
                                                        <span class="file-size" style="color: #e37400;">locked</span>
                                                    </div>
                                                    <div class="ed-file-more" style="color: #e37400;">+ dalších 15 souborů (PDF locked — nelze ověřit podpisy)</div>
                                                </div>
                                            </div>
                                            <div class="ed-file-more">+ dalších 10 PS (PS120221–PS140251, z toho 7× locked)</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Náhled dokumentu -->
                    <div class="ed-preview-container" id="edPreviewContainer" style="display: none; padding: 16px; height: 100%;">
                        <div id="edPreviewContent" style="height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; background: #f5f5f5; border-radius: 8px; padding: 40px;">
                            <span class="material-icons-outlined" style="font-size: 64px; color: #9aa0a6; margin-bottom: 16px;">description</span>
                            <div style="font-size: 14px; color: #5f6368;">Vyberte dokument ze struktury</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Pravý panel - kontrolní formulář -->
            <div class="control-form">
                <div class="control-form-body">
                    <!-- Kategorie stavby -->
                    <div class="control-section stavba-kategorie-section">
                        <div class="control-section-title">
                            <span class="material-icons-outlined" style="font-size: 18px; vertical-align: middle; margin-right: 4px;">category</span>
                            Kategorie stavby
                        </div>
                        
                        <!-- Soubor staveb -->
                        <div class="stavba-field">
                            <div class="stavba-field-label">Jde o soubor staveb?</div>
                            <div class="stavba-toggle-group">
                                <label class="stavba-toggle">
                                    <input type="radio" name="souborStaveb" value="ne" checked onchange="toggleSouborStaveb()">
                                    <span class="stavba-toggle-label">Ne</span>
                                </label>
                                <label class="stavba-toggle">
                                    <input type="radio" name="souborStaveb" value="ano" onchange="toggleSouborStaveb()">
                                    <span class="stavba-toggle-label">Ano</span>
                                </label>
                            </div>
                            <div class="stavba-field-hint">
                                <span class="material-icons-outlined">info</span>
                                Údaj přenesen ze žádosti — můžete upravit
                            </div>
                        </div>
                        
                        <!-- Kategorie stavby - jednoduchá -->
                        <div class="stavba-field" id="kategorieJednoduchaField">
                            <div class="stavba-field-label">Kategorie stavby</div>
                            <div class="stavba-kategorie-options">
                                <label class="stavba-kategorie-option">
                                    <input type="radio" name="kategorieStavby" value="vyhrazena">
                                    <span class="stavba-kategorie-box">
                                        <span class="kategorie-name">Vyhrazená</span>
                                        <span class="kategorie-desc">§ 5 vyhl. č. 600/2006</span>
                                    </span>
                                </label>
                                <label class="stavba-kategorie-option">
                                    <input type="radio" name="kategorieStavby" value="ostatni" checked>
                                    <span class="stavba-kategorie-box">
                                        <span class="kategorie-name">Ostatní</span>
                                        <span class="kategorie-desc">Běžné stavby</span>
                                    </span>
                                </label>
                                <label class="stavba-kategorie-option">
                                    <input type="radio" name="kategorieStavby" value="jednoducha">
                                    <span class="stavba-kategorie-box">
                                        <span class="kategorie-name">Jednoduchá</span>
                                        <span class="kategorie-desc">§ 171 SZ</span>
                                    </span>
                                </label>
                                <label class="stavba-kategorie-option">
                                    <input type="radio" name="kategorieStavby" value="drobna">
                                    <span class="stavba-kategorie-box">
                                        <span class="kategorie-name">Drobná</span>
                                        <span class="kategorie-desc">§ 171 SZ</span>
                                    </span>
                                </label>
                            </div>
                        </div>
                        
                        <!-- Kategorie stavby - soubor staveb -->
                        <div class="stavba-field" id="kategorieSouborField" style="display: none;">
                            <div class="stavba-soubor-wrapper">
                                <!-- Hlavní stavba -->
                                <div class="stavba-soubor-item hlavni">
                                    <div class="stavba-soubor-header">
                                        <span class="material-icons-outlined">star</span>
                                        Hlavní stavba
                                        <span class="stavba-soubor-badge">určuje kategorii souboru</span>
                                    </div>
                                    <div class="stavba-soubor-content">
                                        <div class="stavba-soubor-nazev">
                                            <input type="text" class="stavba-input" id="hlavniStavbaNazev" value="Stavba dráhy — zabezpečovací zařízení" placeholder="Název hlavní stavby">
                                        </div>
                                        <div class="stavba-kategorie-mini">
                                            <label class="kategorie-mini-option">
                                                <input type="radio" name="kategorieHlavni" value="vyhrazena">
                                                <span>Vyhrazená</span>
                                            </label>
                                            <label class="kategorie-mini-option">
                                                <input type="radio" name="kategorieHlavni" value="ostatni" checked>
                                                <span>Ostatní</span>
                                            </label>
                                            <label class="kategorie-mini-option">
                                                <input type="radio" name="kategorieHlavni" value="jednoducha">
                                                <span>Jednoduchá</span>
                                            </label>
                                            <label class="kategorie-mini-option">
                                                <input type="radio" name="kategorieHlavni" value="drobna">
                                                <span>Drobná</span>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Vedlejší stavby -->
                                <div class="stavba-soubor-item vedlejsi">
                                    <div class="stavba-soubor-header">
                                        <span class="material-icons-outlined">add_circle_outline</span>
                                        Vedlejší stavby
                                    </div>
                                    <div class="stavba-soubor-content">
                                        <div class="vedlejsi-stavby-list" id="vedlejsiStavbyList">
                                            <div class="vedlejsi-stavba-row">
                                                <input type="text" class="stavba-input" value="Garáž" placeholder="Název stavby">
                                                <select class="stavba-select">
                                                    <option value="ostatni">Ostatní</option>
                                                    <option value="jednoducha" selected>Jednoduchá</option>
                                                    <option value="drobna">Drobná</option>
                                                </select>
                                                <button class="vedlejsi-remove" onclick="removeVedlejsiStavba(this)" title="Odebrat">
                                                    <span class="material-icons-outlined">close</span>
                                                </button>
                                            </div>
                                            <div class="vedlejsi-stavba-row">
                                                <input type="text" class="stavba-input" value="Přípojky inženýrských sítí" placeholder="Název stavby">
                                                <select class="stavba-select">
                                                    <option value="ostatni">Ostatní</option>
                                                    <option value="jednoducha">Jednoduchá</option>
                                                    <option value="drobna" selected>Drobná</option>
                                                </select>
                                                <button class="vedlejsi-remove" onclick="removeVedlejsiStavba(this)" title="Odebrat">
                                                    <span class="material-icons-outlined">close</span>
                                                </button>
                                            </div>
                                        </div>
                                        <button class="btn-add-vedlejsi" onclick="addVedlejsiStavba()">
                                            <span class="material-icons-outlined">add</span>
                                            Přidat vedlejší stavbu
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="stavba-soubor-summary" id="souborSummary">
                                <span class="material-icons-outlined">info</span>
                                <span>Kategorie souboru staveb: <strong>Ostatní</strong> (podle hlavní stavby)</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Automatická kontrola -->
                    <div class="auto-check-section">
                        <div class="auto-check-header">
                            <div class="auto-check-title">
                                <span class="material-icons-outlined">auto_awesome</span>
                                Automatická kontrola (validátor)
                            </div>
                            <button class="btn-run-check" id="btnRunAutoCheck" onclick="runDocAutoCheck()">
                                <span class="material-icons-outlined">play_arrow</span>
                                Spustit kontrolu
                            </button>
                        </div>
                        <p style="font-size: 12px; color: #5f6368; margin-bottom: 0; font-style: normal;" id="autoCheckDesc">
                            Automaticky zkontroluje elektronické podpisy, časová razítka, autorizační razítka a formát souborů PD.
                        </p>
                        <div class="auto-check-results" id="autoCheckResults">
                            <!-- Dynamicky naplněno z runDocAutoCheck() -->
                        </div>
                    </div>

                    <!-- Kontrola přítomnosti částí dokumentace -->
                    <div class="doc-check-section">
                        <div class="doc-check-header">
                            <div class="doc-check-title">
                                <span class="material-icons-outlined">checklist</span>
                                Kontrola jednotlivých částí dokumentace
                            </div>
                        </div>
                        <p style="font-size: 12px; color: #5f6368; margin-bottom: 12px; font-style: normal;">
                            Ověřte, že dokumentace obsahuje všechny požadované části a zkontrolujte správnost jejich obsahu.
                        </p>
                        
                        <div class="doc-parts-list" id="docPartsList">
                            <!-- A. Průvodní zpráva -->
                            <div class="doc-part-item" data-part="A">
                                <div class="doc-part-info">
                                    <span class="doc-part-letter">A</span>
                                    <span class="doc-part-name">Průvodní zpráva</span>
                                </div>
                                <div class="doc-part-status">
                                    <button class="doc-part-btn ok unchecked" onclick="setDocPartStatus('A', 'ok')" title="V pořádku">
                                        <span class="material-icons-outlined">check</span>
                                    </button>
                                    <button class="doc-part-btn error" onclick="setDocPartStatus('A', 'error')" title="Chyba">
                                        <span class="material-icons-outlined">close</span>
                                    </button>
                                </div>
                            </div>
                            
                            <!-- B. Souhrnná technická zpráva -->
                            <div class="doc-part-item" data-part="B">
                                <div class="doc-part-info">
                                    <span class="doc-part-letter">B</span>
                                    <span class="doc-part-name">Souhrnná technická zpráva</span>
                                </div>
                                <div class="doc-part-status">
                                    <button class="doc-part-btn ok unchecked" onclick="setDocPartStatus('B', 'ok')" title="V pořádku">
                                        <span class="material-icons-outlined">check</span>
                                    </button>
                                    <button class="doc-part-btn error" onclick="setDocPartStatus('B', 'error')" title="Chyba">
                                        <span class="material-icons-outlined">close</span>
                                    </button>
                                </div>
                            </div>
                            
                            <!-- C. Situační výkresy -->
                            <div class="doc-part-item" data-part="C">
                                <div class="doc-part-info">
                                    <span class="doc-part-letter">C</span>
                                    <span class="doc-part-name">Situační výkresy</span>
                                </div>
                                <div class="doc-part-status">
                                    <button class="doc-part-btn ok unchecked" onclick="setDocPartStatus('C', 'ok')" title="V pořádku">
                                        <span class="material-icons-outlined">check</span>
                                    </button>
                                    <button class="doc-part-btn error" onclick="setDocPartStatus('C', 'error')" title="Chyba">
                                        <span class="material-icons-outlined">close</span>
                                    </button>
                                </div>
                            </div>
                            
                            <!-- D. Dokumentace objektů -->
                            <div class="doc-part-item" data-part="D">
                                <div class="doc-part-info">
                                    <span class="doc-part-letter">D</span>
                                    <span class="doc-part-name">Dokumentace objektů</span>
                                </div>
                                <div class="doc-part-status">
                                    <button class="doc-part-btn ok unchecked" onclick="setDocPartStatus('D', 'ok')" title="V pořádku">
                                        <span class="material-icons-outlined">check</span>
                                    </button>
                                    <button class="doc-part-btn error" onclick="setDocPartStatus('D', 'error')" title="Chyba">
                                        <span class="material-icons-outlined">close</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Zjištěné nedostatky dokumentace - strukturované podle částí -->
                    <div style="margin: 8px 0;">
                        <button id="btnToggleCross" onclick="toggleCrossSection()" style="
                            display: inline-flex; align-items: center; gap: 6px; padding: 6px 12px;
                            background: #f3e5f5; border: 1px solid #ce93d8; border-radius: 6px;
                            font-size: 12px; color: #7b1fa2; cursor: pointer; width: 100%; justify-content: center;
                        ">
                            <span class="material-icons-outlined" style="font-size: 16px;">link</span>
                            Přidat průřezový nedostatek (přes více částí PD)
                        </button>
                    </div>
                    <div class="issues-section" id="issuesSection">
                        <div class="issues-header">
                            <div class="issues-title">
                                <span class="material-icons-outlined">report_problem</span>
                                Zjištěné nedostatky dokumentace
                            </div>
                            <span class="issues-count" id="issuesCount">0</span>
                        </div>
                        <p style="font-size: 12px; color: #5f6368; margin-bottom: 16px;">
                            Seznam nedostatků se stane součástí dokumentu <strong>Výzva k doplnění a usnesení o přerušení řízení</strong>.
                        </p>
                        
                        <!-- Automaticky zjištěné nedostatky -->
                        <div class="part-issues-section" id="autoIssuesSection" style="display: none;">
                            <div class="part-issues-header">
                                <span class="material-icons-outlined" style="color: #1a73e8;">auto_awesome</span>
                                Automaticky zjištěné nedostatky (validátor)
                            </div>
                            <div class="part-issues-list" id="autoIssuesList">
                                <!-- Automatické nedostatky -->
                            </div>
                        </div>
                        
                        <!-- Sekce pro část A -->
                        <div class="part-issues-section" id="partIssuesA" style="display: none;">
                            <div class="part-issues-header">
                                <span class="part-letter">A</span>
                                Nedostatky v části A. Průvodní zpráva
                            </div>
                            <div class="part-issues-list" id="partIssuesListA"></div>
                            <div class="part-issues-add-structured">
                                <div class="issue-form-row">
                                    <input type="text" class="issue-ref-input" id="partIssueRefA" placeholder="Reference (např. A.1.2)" style="width: 140px;">
                                    <input type="text" class="issue-text-input" id="partIssueTextA" placeholder="Popis nedostatku...">
                                </div>
                                <div class="issue-form-row">
                                    <input type="text" class="issue-examples-input" id="partIssueExamplesA" placeholder="Příklady (např. soubor PS110121_1_001_TZ.pdf, ...)">
                                </div>
                                <div class="issue-form-actions">
                                    <button class="btn-add-part-issue" onclick="addPartIssue('A')">
                                        <span class="material-icons-outlined">add</span>
                                        Přidat nedostatek
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Sekce pro část B -->
                        <div class="part-issues-section" id="partIssuesB" style="display: none;">
                            <div class="part-issues-header">
                                <span class="part-letter">B</span>
                                Nedostatky v části B. Souhrnná technická zpráva
                            </div>
                            <div class="part-issues-list" id="partIssuesListB"></div>
                            <div class="part-issues-add-structured">
                                <div class="issue-form-row">
                                    <input type="text" class="issue-ref-input" id="partIssueRefB" placeholder="Reference (např. B.2.1)" style="width: 140px;">
                                    <input type="text" class="issue-text-input" id="partIssueTextB" placeholder="Popis nedostatku...">
                                </div>
                                <div class="issue-form-row">
                                    <input type="text" class="issue-examples-input" id="partIssueExamplesB" placeholder="Příklady (např. konkrétní soubory, údaje...)">
                                </div>
                                <div class="issue-form-actions">
                                    <button class="btn-add-part-issue" onclick="addPartIssue('B')">
                                        <span class="material-icons-outlined">add</span>
                                        Přidat nedostatek
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Sekce pro část C -->
                        <div class="part-issues-section" id="partIssuesC" style="display: none;">
                            <div class="part-issues-header">
                                <span class="part-letter">C</span>
                                Nedostatky v části C. Situační výkresy
                            </div>
                            <div class="part-issues-list" id="partIssuesListC"></div>
                            <div class="part-issues-add-structured">
                                <div class="issue-form-row">
                                    <input type="text" class="issue-ref-input" id="partIssueRefC" placeholder="Reference (např. C.2)" style="width: 140px;">
                                    <input type="text" class="issue-text-input" id="partIssueTextC" placeholder="Popis nedostatku...">
                                </div>
                                <div class="issue-form-row">
                                    <input type="text" class="issue-examples-input" id="partIssueExamplesC" placeholder="Příklady (např. C.2-001, C.2-009, C.2-015...)">
                                </div>
                                <div class="issue-form-actions">
                                    <button class="btn-add-part-issue" onclick="addPartIssue('C')">
                                        <span class="material-icons-outlined">add</span>
                                        Přidat nedostatek
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Sekce pro část D -->
                        <div class="part-issues-section" id="partIssuesD" style="display: none;">
                            <div class="part-issues-header">
                                <span class="part-letter">D</span>
                                Nedostatky v části D. Dokumentace objektů
                            </div>
                            <div class="part-issues-list" id="partIssuesListD"></div>
                            <div class="part-issues-add-structured">
                                <div class="issue-form-row">
                                    <input type="text" class="issue-ref-input" id="partIssueRefD" placeholder="Reference (např. D.1.1)" style="width: 140px;">
                                    <input type="text" class="issue-text-input" id="partIssueTextD" placeholder="Popis nedostatku...">
                                </div>
                                <div class="issue-form-row">
                                    <input type="text" class="issue-examples-input" id="partIssueExamplesD" placeholder="Příklady (např. PS120201_1_001_TZ, SO127102_1_001_TZ...)">
                                </div>
                                <div class="issue-form-actions">
                                    <button class="btn-add-part-issue" onclick="addPartIssue('D')">
                                        <span class="material-icons-outlined">add</span>
                                        Přidat nedostatek
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Průřezové nedostatky (přes více částí) -->
                        <div class="part-issues-section" id="partIssuesCross" style="display: none;">
                            <div class="part-issues-header">
                                <span class="material-icons-outlined" style="color: #7b1fa2; font-size: 18px;">link</span>
                                Průřezové nedostatky (přes více částí PD)
                            </div>
                            <div class="part-issues-list" id="partIssuesListCross"></div>
                            <div class="part-issues-add-structured">
                                <div class="issue-form-row">
                                    <select class="issue-ref-input" id="partIssueScopeCross" style="width: 160px;">
                                        <option value="A,B">A + B</option>
                                        <option value="A,B,C,D" selected>A + B + C + D</option>
                                        <option value="B,C,D">B + C + D</option>
                                        <option value="C,D">C + D</option>
                                    </select>
                                    <input type="text" class="issue-text-input" id="partIssueTextCross" placeholder="Popis průřezového nedostatku (např. nesoulad PS 12-02-61 mezi částmi PD)...">
                                </div>
                                <div class="issue-form-row">
                                    <input type="text" class="issue-examples-input" id="partIssueExamplesCross" placeholder="Příklady (např. v části A neuvedeno, v části B uvedeno, výkresy C.2-006 přítomny...)">
                                </div>
                                <div class="issue-form-actions">
                                    <button class="btn-add-part-issue" onclick="addCrossCuttingIssue()">
                                        <span class="material-icons-outlined">add</span>
                                        Přidat průřezový nedostatek
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Prázdný stav -->
                        <div class="issues-empty" id="issuesEmpty">
                            <span class="material-icons-outlined" style="font-size: 32px; color: #9aa0a6; margin-bottom: 8px;">check_circle</span>
                            <div style="font-size: 13px; color: #5f6368;">Zatím nebyly zjištěny žádné nedostatky</div>
                        </div>
                    </div>

                    <div class="result-preview neutral" id="resultDokumentace">
                        <div class="result-preview-title">
                            <span class="material-icons-outlined">info</span>
                            Kontrola nebyla dokončena
                        </div>
                        <div class="result-preview-text">Zkontrolujte všechny části dokumentace kliknutím na zaškrtávátko.</div>
                    </div>
                </div>
                <div class="control-form-footer">
                    <div class="control-form-footer-left">
                        <div class="auto-save-indicator saved" id="autoSaveDokumentace">
                            <span class="material-icons-outlined">cloud_done</span>
                            <span>Automaticky uloženo</span>
                        </div>
                    </div>
                    <div class="control-form-footer-right">
                        <button class="btn btn-secondary" onclick="closeControl('controlDokumentace')">Zrušit</button>
                        <button class="btn-save-draft" onclick="saveDraft('dokumentace')" title="Uložit rozpracovanou kontrolu">
                            <span class="material-icons-outlined">save</span>
                            Uložit
                        </button>
                        <button class="btn btn-primary" id="btnConfirmDokumentace" onclick="completeDokumentace()">
                            <span class="material-icons-outlined">check</span>
                            Potvrdit kontrolu
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <!-- Kontrola: Identifikace DO a správců TDI -->
    <div class="control-overlay" id="controlIdentifikace">
        <div class="control-header">
            <div class="control-header-left">
                <button class="control-close" onclick="closeControl('controlIdentifikace')">
                    <span class="material-icons-outlined">close</span>
                </button>
                <div class="control-title">
                    <span class="material-icons-outlined">hub</span>
                    Identifikace DO a správců TDI
                </div>
            </div>
        </div>
        <div class="control-body">
            <div class="control-viewer">
                <div class="viewer-tabs">
                    <div class="viewer-tabs-left">
                        <button class="viewer-tab active" onclick="switchViewerTab(this, 'identifikace', 'dtm')">
                            <span class="material-icons-outlined">layers</span>
                            DTM
                        </button>
                        <button class="viewer-tab" onclick="switchViewerTab(this, 'identifikace', 'doklady')">
                            <span class="material-icons-outlined">folder</span>
                            Dokladová část
                        </button>
                        <button class="viewer-tab" onclick="switchViewerTab(this, 'identifikace', 'zadost')">
                            <span class="material-icons-outlined">description</span>
                            Žádost
                        </button>
                    </div>
                    <button class="viewer-open-external" onclick="openViewerExternal('identifikace')" title="Otevřít v novém okně">
                        <span class="material-icons-outlined">open_in_new</span>
                    </button>
                </div>
                <div class="viewer-content" id="identifikaceViewerContent">
                    <div id="identifikaceViewerInner">
                        <div class="viewer-placeholder">
                            <span class="material-icons-outlined">layers</span>
                            <div class="viewer-placeholder-title">Digitální technická mapa</div>
                            <div class="viewer-placeholder-text">Sítě technické infrastruktury v okolí stavby</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="control-form">
                <div class="control-form-body">
                    <!-- AI Analýza -->
                    <div class="identifikace-ai-section">
                        <div class="identifikace-ai-header">
                            <div class="identifikace-ai-title">
                                <span class="material-icons-outlined">auto_awesome</span>
                                AI Analýza dokladové části
                            </div>
                            <button class="btn-ai-analyze" id="btnAiAnalyzeDoklady" onclick="aiAnalyzeDoklady()">
                                <span class="material-icons-outlined">search</span>
                                Analyzovat přílohy
                            </button>
                        </div>
                        <div class="identifikace-ai-status" id="aiAnalyzeStatus">
                            <span class="material-icons-outlined">info</span>
                            Spusťte analýzu pro automatické rozpoznání přiložených dokumentů
                        </div>
                    </div>

                    <!-- Porovnávací matice -->
                    <div class="control-section">
                        <div class="control-section-title">Přehled stanovisek a vyjádření</div>
                        <p style="font-size: 12px; color: #5f6368; margin-bottom: 12px;">
                            Zkontrolujte přiložené doklady, vyhodnoťte jejich obsah a zadejte podmínky pro rozhodnutí.
                        </p>
                    </div>

                    <div class="subjekty-matrix" id="subjektyMatrix">
                        <!-- Header -->
                        <div class="matrix-header extended">
                            <div class="matrix-header-cell">Subjekt</div>
                            <div class="matrix-header-cell">Žádost</div>
                            <div class="matrix-header-cell">Přiloženo</div>
                            <div class="matrix-header-cell">Výsledek</div>
                            <div class="matrix-header-cell">Podmínky</div>
                        </div>

                        <!-- DO skupina -->
                        <div class="matrix-group" data-group="do" id="matrixGroupDO">
                            <div class="matrix-group-header">
                                <span class="material-icons-outlined">account_balance</span>
                                Dotčené orgány (DO) — závazná stanoviska
                                <span class="group-count" id="countDO">3</span>
                            </div>
                            
                            <!-- Info box pro integrované DO (od 1.1.2028) -->
                            <div class="platnost-info-box integrated-do-info" id="infoIntegrovaneDO" style="display: none;">
                                <div class="platnost-info-icon">
                                    <span class="material-icons-outlined">verified</span>
                                </div>
                                <div class="platnost-info-content">
                                    <div class="platnost-info-title">Integrované dotčené orgány</div>
                                    <div class="platnost-info-text">Od 1. 1. 2028 jsou dotčené orgány integrovány do jednotné státní stavební správy. Závazná stanoviska jsou vydávána automaticky v rámci interního workflow JSSÚ.</div>
                                    <div class="integrated-do-list">
                                        <span class="integrated-do-badge"><span class="material-icons-outlined">check</span> Požární ochrana (HZS)</span>
                                        <span class="integrated-do-badge"><span class="material-icons-outlined">check</span> Hygiena (KHS)</span>
                                        <span class="integrated-do-badge"><span class="material-icons-outlined">check</span> Životní prostředí</span>
                                        <span class="integrated-do-badge"><span class="material-icons-outlined">check</span> Památková péče</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="matrix-group-content" id="matrixDO">
                                <!-- Dynamicky renderováno -->
                            </div>
                        </div>

                        <!-- VTI skupina -->
                        <div class="matrix-group" data-group="vti">
                            <div class="matrix-group-header">
                                <span class="material-icons-outlined">electric_bolt</span>
                                Vlastníci technické infrastruktury (VTI) — vyjádření
                                <span class="group-count" id="countVTI">4</span>
                            </div>
                            <div class="matrix-group-content" id="matrixVTI">
                                <!-- Dynamicky renderováno -->
                            </div>
                        </div>

                        <!-- VDI skupina -->
                        <div class="matrix-group" data-group="vdi">
                            <div class="matrix-group-header">
                                <span class="material-icons-outlined">directions_car</span>
                                Vlastníci dopravní infrastruktury (VDI) — vyjádření
                                <span class="group-count" id="countVDI">1</span>
                            </div>
                            <div class="matrix-group-content" id="matrixVDI">
                                <!-- Dynamicky renderováno -->
                            </div>
                        </div>

                        <!-- Přidat subjekt -->
                        <div class="matrix-add-row">
                            <select class="matrix-add-select" id="addSubjektTyp">
                                <option value="do">DO — Dotčený orgán</option>
                                <option value="vti">VTI — Vlastník tech. infrastruktury</option>
                                <option value="vdi">VDI — Vlastník dopr. infrastruktury</option>
                            </select>
                            <input type="text" class="matrix-add-input" id="addSubjektNazev" placeholder="Název subjektu..." style="flex: 2;">
                            <button class="btn-add-subjekt" onclick="addSubjekt()">
                                <span class="material-icons-outlined">add</span>
                                Přidat
                            </button>
                        </div>
                        <div style="padding: 4px 12px 12px; font-size: 11px; color: #80868b;">
                            Přidejte subjekt, jehož stanovisko/vyjádření by mělo být přiloženo, ale AI ho v dokladové části nenalezla.
                        </div>
                    </div>

                    <!-- Souhrn pro rozhodnutí -->
                    <div class="souhrn-rozhodnuti" id="souhrnRozhodnuti">
                        <div class="souhrn-rozhodnuti-header">
                            <div class="souhrn-rozhodnuti-title">
                                <span class="material-icons-outlined">description</span>
                                Data pro rozhodnutí
                            </div>
                            <div class="souhrn-rozhodnuti-actions" id="reportActions" style="display: none;">
                                <button class="btn-report" onclick="showReportModal()" title="Zobrazit náhled reportu">
                                    <span class="material-icons-outlined">visibility</span>
                                    Náhled
                                </button>
                                <button class="btn-report" onclick="downloadReport('json')" title="Stáhnout data jako JSON">
                                    <span class="material-icons-outlined">data_object</span>
                                    JSON
                                </button>
                                <button class="btn-report" onclick="downloadReport('txt')" title="Stáhnout textový report">
                                    <span class="material-icons-outlined">download</span>
                                    TXT
                                </button>
                            </div>
                        </div>
                        <div class="souhrn-stats" id="souhrnStats">
                            <!-- Dynamicky renderováno -->
                        </div>
                    </div>

                    <!-- Výsledek kontroly -->
                    <div class="identifikace-result" id="identifikaceResult">
                        <div class="identifikace-result-title">Výsledek kontroly</div>
                        <div class="identifikace-result-items" id="identifikaceResultItems">
                            <!-- Dynamicky renderováno -->
                        </div>
                    </div>

                    <!-- Result preview -->
                    <div class="result-preview positive" id="resultIdentifikace">
                        <div class="result-preview-title">
                            <span class="material-icons-outlined">check_circle</span>
                            Čeká na dokončení kontroly
                        </div>
                        <div class="result-preview-text">Zkontrolujte seznam subjektů a označte vyžadované.</div>
                    </div>
                </div>
                <div class="control-form-footer">
                    <div class="control-form-footer-left">
                        <div class="auto-save-indicator saved" id="autoSaveIdentifikace">
                            <span class="material-icons-outlined">cloud_done</span>
                            <span>Automaticky uloženo</span>
                        </div>
                    </div>
                    <div class="control-form-footer-right">
                        <button class="btn btn-secondary" onclick="closeControl('controlIdentifikace')">Zrušit</button>
                        <button class="btn-save-draft" onclick="saveDraft('identifikace')" title="Uložit rozpracovanou kontrolu">
                            <span class="material-icons-outlined">save</span>
                            Uložit
                        </button>
                        <button class="btn btn-primary" id="btnConfirmIdentifikace" onclick="completeIdentifikace()">
                            <span class="material-icons-outlined">check</span>
                            Potvrdit kontrolu
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Kontrola: Soulad s ÚPD -->
    <div class="control-overlay" id="controlUP">
        <div class="control-header">
            <div class="control-header-left">
                <button class="control-close" onclick="closeControl('controlUP')">
                    <span class="material-icons-outlined">close</span>
                </button>
                <div class="control-title">
                    <span class="material-icons-outlined">map</span>
                    Soulad s ÚPD
                </div>
            </div>
            <div class="control-header-center">
                <div class="upd-layout-switch">
                    <button class="upd-layout-btn active" onclick="setUPDLayout('vertical', this)" title="Panely nad sebou">
                        <span class="material-icons-outlined">view_agenda</span>
                    </button>
                    <button class="upd-layout-btn" onclick="setUPDLayout('horizontal', this)" title="Panely vedle sebe">
                        <span class="material-icons-outlined">view_column</span>
                    </button>
                </div>
            </div>
            <div class="control-header-right" style="margin-left: auto; margin-right: 16px;">
                <button class="btn btn-primary" id="btnConfirmUPD" onclick="completeUPD()" disabled>
                    <span class="material-icons-outlined">check</span> Potvrdit kontrolu
                </button>
            </div>
        </div>
        
        <!-- Modální dialog pro nesoulad -->
        <div class="upd-nesoulad-modal" id="nesouladModal">
            <div class="upd-nesoulad-modal-content">
                <div class="upd-nesoulad-modal-header">
                    <div class="upd-nesoulad-modal-title">
                        <span class="material-icons-outlined">warning</span>
                        <span id="nesouladModalTitle">Popis nesouladu</span>
                    </div>
                    <button class="upd-nesoulad-modal-close" onclick="closeNesouladModal()">
                        <span class="material-icons-outlined">close</span>
                    </button>
                </div>
                <div class="upd-nesoulad-modal-body">
                    <label id="nesouladModalLabel">Popište nesoulad s územně plánovací dokumentací:</label>
                    <textarea class="upd-nesoulad-modal-textarea" id="nesouladModalTextarea" 
                        placeholder="Uveďte konkrétní ustanovení, se kterými je záměr v rozporu..."></textarea>
                </div>
                <div class="upd-nesoulad-modal-footer">
                    <button class="btn btn-secondary" onclick="closeNesouladModal()">Zrušit</button>
                    <button class="btn btn-primary" onclick="saveNesouladModal()">
                        <span class="material-icons-outlined">save</span> Uložit
                    </button>
                </div>
            </div>
        </div>
        
        <div class="control-body">
            <!-- Viewery - maximální prostor -->
            <div class="upd-viewers-stack">
                <div class="upd-viewer-panel">
                    <div class="upd-viewer-toolbar">
                        <div class="upd-viewer-tabs">
                            <button class="upd-vtab active" onclick="switchSituaceTab(this, 'c1')">C.1</button>
                            <button class="upd-vtab" onclick="switchSituaceTab(this, 'c2')">C.2</button>
                            <button class="upd-vtab" onclick="switchSituaceTab(this, 'c3')">C.3</button>
                        </div>
                        <div class="upd-zoom-controls">
                            <button class="upd-zoom-btn" onclick="zoomViewer('situace', -0.2)" title="Oddálit">−</button>
                            <button class="upd-zoom-btn" onclick="resetViewer('situace')" title="Reset">⟲</button>
                            <button class="upd-zoom-btn" onclick="zoomViewer('situace', 0.2)" title="Přiblížit">+</button>
                        </div>
                        <button class="upd-viewer-btn" onclick="openImageFullscreen('situace')" title="Nové okno">
                            <span class="material-icons-outlined">open_in_new</span>
                        </button>
                    </div>
                    <div class="upd-viewer-content" id="updSituaceViewer">
                        <div class="upd-image-container" id="situaceContainer">
                            <img src="../images/C-01.png" alt="Situační výkres" id="situaceImage" 
                                 draggable="false" onload="initViewer('situace')">
                        </div>
                    </div>
                </div>
                
                <div class="upd-viewer-panel">
                    <div class="upd-viewer-toolbar">
                        <div class="upd-viewer-tabs">
                            <button class="upd-vtab active" onclick="switchUPDMap('urp', this)">ÚRP</button>
                            <button class="upd-vtab" onclick="switchUPDMap('zur', this)">ZÚR</button>
                            <button class="upd-vtab" onclick="switchUPDMap('up', this)">ÚP</button>
                        </div>
                        <div class="upd-zoom-controls">
                            <button class="upd-zoom-btn" onclick="zoomViewer('upd', -0.2)" title="Oddálit">−</button>
                            <button class="upd-zoom-btn" onclick="resetViewer('upd')" title="Reset">⟲</button>
                            <button class="upd-zoom-btn" onclick="zoomViewer('upd', 0.2)" title="Přiblížit">+</button>
                        </div>
                        <button class="upd-viewer-btn" onclick="openImageFullscreen('upd')" title="Nové okno">
                            <span class="material-icons-outlined">open_in_new</span>
                        </button>
                    </div>
                    <div class="upd-viewer-content" id="updMapViewer">
                        <div class="upd-image-container" id="updContainer">
                            <img src="../images/URP.png" alt="ÚRP" id="updImage" 
                                 draggable="false" onload="initViewer('upd')">
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Kontrolní panel - minimální šířka -->
            <div class="upd-control-panel">
                <div class="upd-check-item" id="checkUrp">
                    <div class="upd-check-row">
                        <span class="upd-check-label">ÚRP</span>
                        <span class="upd-check-status" id="statusUrp"></span>
                    </div>
                    <div class="upd-check-buttons">
                        <button class="upd-btn-yes" onclick="setUPDSoulad('urp', true, this)" title="V souladu">✓</button>
                        <button class="upd-btn-no" onclick="setUPDSoulad('urp', false, this)" title="Rozpor">✗</button>
                        <span class="upd-nesoulad-indicator" id="indicatorUrp" onclick="openNesouladModal('urp')" title="Upravit popis nesouladu">✎</span>
                    </div>
                    <textarea class="upd-note-input" id="noteUrp" style="display:none;" 
                        placeholder="Popište rozpor s Územním rozvojovým plánem..." oninput="updateUPDState()"></textarea>
                </div>
                
                <div class="upd-check-item" id="checkZur">
                    <div class="upd-check-row">
                        <span class="upd-check-label">ZÚR</span>
                        <span class="upd-check-status" id="statusZur"></span>
                    </div>
                    <div class="upd-check-buttons">
                        <button class="upd-btn-yes" onclick="setUPDSoulad('zur', true, this)" title="V souladu">✓</button>
                        <button class="upd-btn-no" onclick="setUPDSoulad('zur', false, this)" title="Rozpor">✗</button>
                        <span class="upd-nesoulad-indicator" id="indicatorZur" onclick="openNesouladModal('zur')" title="Upravit popis nesouladu">✎</span>
                    </div>
                    <textarea class="upd-note-input" id="noteZur" style="display:none;" 
                        placeholder="Popište rozpor se Zásadami územního rozvoje..." oninput="updateUPDState()"></textarea>
                </div>
                
                <div class="upd-check-item" id="checkUp">
                    <div class="upd-check-row">
                        <span class="upd-check-label">ÚP</span>
                        <span class="upd-check-status" id="statusUp"></span>
                    </div>
                    <div class="upd-check-mini-label">Existuje?</div>
                    <div class="upd-check-buttons" id="upExistButtons">
                        <button class="upd-btn-yes" onclick="setUPExistence(true, this)">✓</button>
                        <button class="upd-btn-no" onclick="setUPExistence(false, this)">✗</button>
                    </div>
                    <div id="upSouladSection" style="display:none;">
                        <div class="upd-check-mini-label">Soulad?</div>
                        <div class="upd-check-buttons">
                            <button class="upd-btn-yes" onclick="setUPDSoulad('up', true, this)">✓</button>
                            <button class="upd-btn-no" onclick="setUPDSoulad('up', false, this)">✗</button>
                            <span class="upd-nesoulad-indicator" id="indicatorUp" onclick="openNesouladModal('up')" title="Upravit popis nesouladu">✎</span>
                        </div>
                        <textarea class="upd-note-input" id="noteUp" style="display:none;" 
                            placeholder="Popište rozpor s Územním plánem..." oninput="updateUPDState()"></textarea>
                    </div>
                    <div class="upd-no-up-info" id="noUpInfo" style="display:none;">Posouzení dle § 193</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Kontrola: Osoby -->
    <div class="control-overlay" id="controlUcastnici">
        <div class="control-header">
            <div class="control-header-left">
                <button class="control-close" onclick="closeControl('controlUcastnici')">
                    <span class="material-icons-outlined">close</span>
                </button>
                <div class="control-title">
                    <span class="material-icons-outlined">groups</span>
                    Osoby
                </div>
            </div>
        </div>
        <div class="control-body" style="display: flex; flex-direction: column;">
            <div class="control-form" style="width: 100%; flex: 1; border-left: none; min-height: 0;">
                <div class="control-form-body osoby-layout">
                    
                    <!-- ========== LEVÝ SLOUPEC: POZEMKY ========== -->
                    <div class="osoby-col-pozemky">
                        <div class="osoby-col-header">
                            <span class="material-icons-outlined">terrain</span>
                            Pozemky
                            <button class="btn-overit-vse-sm" onclick="overitVsechnyPozemkyKN()">
                                <span class="material-icons-outlined">verified</span>
                                Načíst osoby z KN
                            </button>
                        </div>
                        
                        <div class="osoby-pozemky-content">
                            <!-- Pozemky záměru -->
                            <div class="pozemky-blok">
                                <div class="pozemky-blok-header zamer">
                                    <span class="pozemky-blok-title">Pozemky záměru</span>
                                    <span class="pozemky-blok-count" id="countZamer">38</span>
                                </div>
                                <div class="pozemky-blok-list" id="listPozemkyZameru">
                                    <div class="pozemek-item" data-parcela="st. 321">
                                        <span class="pozemek-parcela">st. 321</span>
                                        <span class="pozemek-ku">Doudleby n.O.</span>
                                        <span class="pozemek-vlastnik" id="vl2-st321">—</span>
                                        <span class="pozemek-status pending"><span class="material-icons-outlined">schedule</span></span>
                                        <button class="btn-overit-sm" onclick="overitPozemekKN('st. 321', 'Doudleby n.O.')">Ověřit</button>
                                    </div>
                                    <div class="pozemek-item" data-parcela="1549">
                                        <span class="pozemek-parcela">1549</span>
                                        <span class="pozemek-ku">Doudleby n.O.</span>
                                        <span class="pozemek-vlastnik" id="vl2-1549">—</span>
                                        <span class="pozemek-status pending"><span class="material-icons-outlined">schedule</span></span>
                                        <button class="btn-overit-sm" onclick="overitPozemekKN('1549', 'Doudleby n.O.')">Ověřit</button>
                                    </div>
                                    <div class="pozemek-item" style="text-align: center; color: #5f6368; font-style: italic; padding: 8px; justify-content: center;">
                                        … a dalších 36 pozemků
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Sousední pozemky -->
                            <div class="pozemky-blok">
                                <div class="pozemky-blok-header soused">
                                    <span class="pozemky-blok-title">Sousední pozemky</span>
                                    <span class="pozemky-blok-count" id="countSoused">4</span>
                                </div>
                                <div class="pozemky-blok-list" id="listSousedniPozemky">
                                    <div class="pozemek-item" data-parcela="st. 122">
                                        <span class="pozemek-parcela">st. 122</span>
                                        <span class="pozemek-ku">Jaroměř</span>
                                        <span class="pozemek-vlastnik" id="vl-st122">—</span>
                                        <span class="pozemek-status pending"><span class="material-icons-outlined">schedule</span></span>
                                        <button class="btn-overit-sm" onclick="overitPozemekKN('st. 122', 'Jaroměř')">Ověřit</button>
                                    </div>
                                    <div class="pozemek-item" data-parcela="st. 124">
                                        <span class="pozemek-parcela">st. 124</span>
                                        <span class="pozemek-ku">Jaroměř</span>
                                        <span class="pozemek-vlastnik" id="vl-st124">—</span>
                                        <span class="pozemek-status pending"><span class="material-icons-outlined">schedule</span></span>
                                        <button class="btn-overit-sm" onclick="overitPozemekKN('st. 124', 'Jaroměř')">Ověřit</button>
                                    </div>
                                    <div class="pozemek-item" data-parcela="456/2">
                                        <span class="pozemek-parcela">456/2</span>
                                        <span class="pozemek-ku">Jaroměř</span>
                                        <span class="pozemek-vlastnik" id="vl-4562">—</span>
                                        <span class="pozemek-status pending"><span class="material-icons-outlined">schedule</span></span>
                                        <button class="btn-overit-sm" onclick="overitPozemekKN('456/2', 'Jaroměř')">Ověřit</button>
                                    </div>
                                    <div class="pozemek-item" data-parcela="457">
                                        <span class="pozemek-parcela">457</span>
                                        <span class="pozemek-ku">Jaroměř</span>
                                        <span class="pozemek-vlastnik" id="vl-457">—</span>
                                        <span class="pozemek-status pending"><span class="material-icons-outlined">schedule</span></span>
                                        <button class="btn-overit-sm" onclick="overitPozemekKN('457', 'Jaroměř')">Ověřit</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ========== PRAVÝ SLOUPEC: ÚČASTNÍCI ========== -->
                    <div class="osoby-col-ucastnici">
                        <div class="osoby-col-header">
                            <div class="osoby-tabs-inline">
                                <button class="osoby-tab-btn active" onclick="switchOsobyTab(this, 'ucastnici')">
                                    Účastníci <span class="osoby-tab-count" id="tabCountUcastnici">2</span>
                                </button>
                                <button class="osoby-tab-btn" onclick="switchOsobyTab(this, 'zastupci')">
                                    Zástupci <span class="osoby-tab-count" id="tabCountZastupci">0</span>
                                </button>
                                <button class="osoby-tab-btn" onclick="switchOsobyTab(this, 'dotceneOrgany')">
                                    Dotčené orgány <span class="osoby-tab-count" id="tabCountDotceneOrgany">0</span>
                                </button>
                                <button class="osoby-tab-btn" onclick="switchOsobyTab(this, 'dalsi')">
                                    Další osoby <span class="osoby-tab-count" id="tabCountDalsi">1</span>
                                </button>
                            </div>
                            <div class="osoby-header-actions">
                                <button class="btn-overit-osoby" onclick="overitVsechnyOsoby()">
                                    <span class="material-icons-outlined">verified_user</span>
                                    Ověřit všechny
                                </button>
                                <button class="btn-add-osoba" onclick="addUcastnik('manual')">
                                    <span class="material-icons-outlined">add</span>
                                    Přidat
                                </button>
                            </div>
                        </div>
                        
                        <!-- Panel: Účastníci -->
                        <div class="osoby-tab-panel active" id="tabPanelUcastnici">
                            <table class="osoby-table">
                                <thead>
                                    <tr>
                                        <th style="width: 28px;"></th>
                                        <th>Účastník</th>
                                        <th>Adresa / Poznámka</th>
                                        <th style="width: 50px;">Zdroj</th>
                                        <th style="width: 60px;">Doruč.</th>
                                        <th style="width: 110px;"></th>
                                    </tr>
                                </thead>
                                <tbody id="tbodyUcastnici">
                                    <!-- Stavebník -->
                                    <tr class="osoby-kategorie-row">
                                        <td colspan="6">
                                            <span class="kategorie-label">Stavebník / Žadatel</span>
                                        </td>
                                    </tr>
                                    <tr data-osoba-id="jan-novak" data-overeno="true">
                                        <td><span class="os-status ok" title="Ověřeno z Portálu stavebníka"><span class="material-icons-outlined">check_circle</span></span></td>
                                        <td><strong>Správa železnic, s.o.</strong><br><small class="text-muted">Fyzická osoba</small></td>
                                        <td>
                                            Dlážděná 1003/7, 110 00 Praha 1
                                            <span class="os-ds-info"><span class="material-icons-outlined">forward_to_inbox</span> uccchjm</span>
                                        </td>
                                        <td><span class="os-zdroj zdroj-zadost">žádost</span></td>
                                        <td>
                                            <button class="btn-dorucovani ds" onclick="toggleDorucovani(this)" title="Doručit do datové schránky" data-stav="ds" data-ds="uccchjm">
                                                <span class="material-icons-outlined">forward_to_inbox</span>
                                            </button>
                                        </td>
                                        <td class="os-actions">
                                            <button onclick="toggleOblibeny(this)" title="Oblíbený"><span class="material-icons-outlined">star_border</span></button>
                                            <button title="Detail"><span class="material-icons-outlined">visibility</span></button>
                                            <button title="Upravit"><span class="material-icons-outlined">edit</span></button>
                                        </td>
                                    </tr>
                                    
                                    <!-- Obec -->
                                    <tr class="osoby-kategorie-row">
                                        <td colspan="6">
                                            <span class="kategorie-label">Obec</span>
                                        </td>
                                    </tr>
                                    <tr data-osoba-id="mesto-jaromer" data-overeno="false">
                                        <td><span class="os-status pending" title="Neověřeno"><span class="material-icons-outlined">help_outline</span></span></td>
                                        <td><strong>Městys Doudleby n.O.</strong><br><small class="text-muted">Právnická osoba</small></td>
                                        <td class="os-adresa-neovereno">—</td>
                                        <td><span class="os-zdroj zdroj-ku">k.ú.</span></td>
                                        <td>
                                            <span class="doruc-ceka" title="Čeká na ověření">—</span>
                                        </td>
                                        <td class="os-actions">
                                            <button class="btn-overit-osobu" onclick="overitOsobu(this)" title="Ověřit z rejstříku">
                                                <span class="material-icons-outlined">verified_user</span>
                                            </button>
                                            <button class="is-favorited" onclick="toggleOblibeny(this)" title="V oblíbených"><span class="material-icons-outlined">star</span></button>
                                            <button title="Detail"><span class="material-icons-outlined">visibility</span></button>
                                            <button title="Upravit"><span class="material-icons-outlined">edit</span></button>
                                        </td>
                                    </tr>
                                    
                                    <!-- Vlastníci pozemků záměru -->
                                    <tr class="osoby-kategorie-row" id="katVlastniciZameru">
                                        <td colspan="6">
                                            <span class="kategorie-label">Vlastníci pozemků záměru</span>
                                            <span class="kategorie-stav ceka">čeká na ověření z KN</span>
                                        </td>
                                    </tr>
                                    <tr class="osoby-empty-row" id="emptyVlastniciZameru">
                                        <td colspan="6" class="text-center text-muted">
                                            <span class="material-icons-outlined" style="font-size: 16px; vertical-align: middle;">hourglass_empty</span>
                                            Ověřte pozemky záměru
                                        </td>
                                    </tr>
                                    
                                    <!-- Vlastníci sousedních pozemků -->
                                    <tr class="osoby-kategorie-row" id="katVlastniciSousedi">
                                        <td colspan="6">
                                            <span class="kategorie-label">Vlastníci sousedních pozemků</span>
                                            <span class="kategorie-stav ceka">čeká na ověření z KN</span>
                                        </td>
                                    </tr>
                                    <tr class="osoby-empty-row" id="emptyVlastniciSousedi">
                                        <td colspan="6" class="text-center text-muted">
                                            <span class="material-icons-outlined" style="font-size: 16px; vertical-align: middle;">hourglass_empty</span>
                                            Ověřte sousední pozemky
                                        </td>
                                    </tr>
                                    
                                    <!-- Ostatní účastníci -->
                                    <tr class="osoby-kategorie-row">
                                        <td colspan="6">
                                            <span class="kategorie-label">Ostatní účastníci</span>
                                            <button class="btn-nacist-vti" onclick="nacistVTIVDI()">
                                                <span class="material-icons-outlined">download</span>
                                                Načíst VTI/VDI
                                            </button>
                                        </td>
                                    </tr>
                                    <tr class="osoby-empty-row" id="emptyOstatniUcastnici">
                                        <td colspan="6" class="text-center text-muted">
                                            <span class="material-icons-outlined" style="font-size: 16px; vertical-align: middle;">business</span>
                                            Vlastníci infrastruktury — načtěte z Dokladové části
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Panel: Zástupci -->
                        <div class="osoby-tab-panel" id="tabPanelZastupci">
                            <!-- Toolbar zástupců -->
                            <div class="zastupci-toolbar">
                                <div class="zastupci-toolbar-left">
                                    <span class="zastupci-info">
                                        <span class="material-icons-outlined">info</span>
                                        Zástupce doručuje místo zastupovaného účastníka
                                    </span>
                                </div>
                                <div class="zastupci-toolbar-right">
                                    <button class="btn btn-sm btn-secondary" onclick="openPridatZastupceModal()">
                                        <span class="material-icons-outlined">add</span>
                                        Přidat zástupce
                                    </button>
                                    <button class="btn btn-sm btn-outline" onclick="pridatZastupceZOblibenych()">
                                        <span class="material-icons-outlined">star</span>
                                        Z oblíbených
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Tabulka zástupců -->
                            <table class="osoby-table" id="tableZastupci">
                                <thead>
                                    <tr>
                                        <th style="width: 24px;"></th>
                                        <th>Zástupce</th>
                                        <th>Zastupovaný</th>
                                        <th>Role zastupovaného</th>
                                        <th style="width: 90px;">Doručovat</th>
                                        <th style="width: 100px;"></th>
                                    </tr>
                                </thead>
                                <tbody id="tbodyZastupci">
                                    <tr class="osoby-empty-row" id="emptyZastupci">
                                        <td colspan="6" class="text-center text-muted">
                                            <span class="material-icons-outlined" style="font-size: 16px; vertical-align: middle;">supervisor_account</span>
                                            Žádní zástupci — přidejte zástupce tlačítkem výše
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Panel: Dotčené orgány -->
                        <div class="osoby-tab-panel" id="tabPanelDotceneOrgany">
                            
                            <!-- Info box pro integrované DO (od 1.1.2028) -->
                            <div class="platnost-info-box integrated-do-info" id="infoIntegrovaneDOOsoby" style="display: none; margin: 0 0 16px 0;">
                                <div class="platnost-info-icon">
                                    <span class="material-icons-outlined">verified</span>
                                </div>
                                <div class="platnost-info-content">
                                    <div class="platnost-info-title">Integrované dotčené orgány</div>
                                    <div class="platnost-info-text">Od 1. 1. 2028 jsou dotčené orgány integrovány do JSSÚ. Závazná stanoviska jsou vydávána automaticky — není třeba evidovat DO jako samostatné účastníky.</div>
                                </div>
                            </div>
                            
                            <!-- Toolbar dotčených orgánů -->
                            <div class="zastupci-toolbar" id="toolbarDotceneOrgany">
                                <div class="zastupci-toolbar-left">
                                    <span class="zastupci-info">
                                        <span class="material-icons-outlined">info</span>
                                        Dotčené orgány jsou načítány z Dokladové části
                                    </span>
                                </div>
                                <div class="zastupci-toolbar-right">
                                    <button class="btn btn-sm btn-secondary" onclick="nacistDotceneOrgany()">
                                        <span class="material-icons-outlined">download</span>
                                        Načíst z Dokladové části
                                    </button>
                                    <button class="btn btn-sm btn-outline" onclick="pridatDotcenyOrgan()">
                                        <span class="material-icons-outlined">add</span>
                                        Přidat ručně
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Tabulka dotčených orgánů -->
                            <table class="osoby-table" id="tableDotceneOrgany">
                                <thead>
                                    <tr>
                                        <th style="width: 24px;"></th>
                                        <th>Dotčený orgán</th>
                                        <th>Typ závazného stanoviska</th>
                                        <th style="width: 90px;">Stav</th>
                                        <th style="width: 100px;"></th>
                                    </tr>
                                </thead>
                                <tbody id="tbodyDotceneOrgany">
                                    <tr class="osoby-empty-row" id="emptyDotceneOrgany">
                                        <td colspan="5" class="text-center text-muted">
                                            <span class="material-icons-outlined" style="font-size: 16px; vertical-align: middle;">account_balance</span>
                                            Žádné dotčené orgány — načtěte z Dokladové části
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Panel: Další osoby -->
                        <div class="osoby-tab-panel" id="tabPanelDalsi">
                            <table class="osoby-table">
                                <thead>
                                    <tr>
                                        <th style="width: 24px;"></th>
                                        <th>Osoba</th>
                                        <th>Role</th>
                                        <th style="width: 100px;"></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td><span class="os-status ok"><span class="material-icons-outlined">check_circle</span></span></td>
                                        <td><strong>Ing. arch. Alois Hrejsísemnou</strong><br><small class="text-muted">Fyzická osoba</small></td>
                                        <td><span class="os-role">hlavní projektant</span></td>
                                        <td class="os-actions">
                                            <button class="is-favorited" onclick="toggleOblibeny(this)" title="V oblíbených"><span class="material-icons-outlined">star</span></button>
                                            <button title="Detail"><span class="material-icons-outlined">visibility</span></button>
                                            <button title="Upravit"><span class="material-icons-outlined">edit</span></button>
                                            <button title="Odstranit"><span class="material-icons-outlined">delete</span></button>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                </div>
                <div class="control-form-footer">
                    <div class="control-form-footer-left">
                        <div class="auto-save-indicator saved" id="autoSaveUcastnici">
                            <span class="material-icons-outlined">cloud_done</span>
                            <span>Automaticky uloženo</span>
                        </div>
                    </div>
                    <div class="control-form-footer-right">
                        <button class="btn btn-secondary" onclick="closeControl('controlUcastnici')">Zrušit</button>
                        <button class="btn-save-draft" onclick="saveDraft('ucastnici')" title="Uložit rozpracovanou kontrolu">
                            <span class="material-icons-outlined">save</span>
                            Uložit
                        </button>
                        <button class="btn btn-primary" onclick="completeUcastnici()">
                            <span class="material-icons-outlined">check</span>
                            Potvrdit osoby
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Přidat zástupce -->
    <div class="modal-overlay" id="modalPridatZastupce" style="display: none;">
        <div class="modal-dialog" style="max-width: 550px;">
            <div class="modal-header">
                <h3 class="modal-title">
                    <span class="material-icons-outlined">supervisor_account</span>
                    Přidat zástupce
                </h3>
                <button class="modal-close" onclick="closeModalZastupce()">
                    <span class="material-icons-outlined">close</span>
                </button>
            </div>
            <div class="modal-body">
                <!-- Krok 1: Údaje o zástupci -->
                <div class="form-section">
                    <div class="form-section-title">1. Údaje o zástupci</div>
                    
                    <div class="form-row">
                        <label class="form-label">Typ osoby</label>
                        <div class="form-radio-group">
                            <label class="form-radio">
                                <input type="radio" name="zastupce_typ" value="FO" checked onchange="toggleZastupceForm()">
                                <span>Fyzická osoba</span>
                            </label>
                            <label class="form-radio">
                                <input type="radio" name="zastupce_typ" value="PO" onchange="toggleZastupceForm()">
                                <span>Právnická osoba</span>
                            </label>
                        </div>
                    </div>
                    
                    <!-- FO formulář -->
                    <div id="zastupceFormFO">
                        <div class="form-row-3col">
                            <div class="form-group">
                                <label class="form-label">Jméno *</label>
                                <input type="text" class="form-input" id="zastupceJmeno" placeholder="Jan">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Příjmení *</label>
                                <input type="text" class="form-input" id="zastupcePrijmeni" placeholder="Novák">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Datum narození *</label>
                                <input type="date" class="form-input" id="zastupceDatumNarozeni">
                            </div>
                        </div>
                        <div class="form-verify-row">
                            <button type="button" class="btn btn-sm btn-outline" onclick="overitZastupceZRejstriku('FO')">
                                <span class="material-icons-outlined">verified_user</span>
                                Ověřit z rejstříku
                            </button>
                            <span class="verify-status" id="verifyStatusFO"></span>
                        </div>
                        
                        <!-- Doplněné údaje po ověření -->
                        <div id="zastupceDetailFO" style="display: none;">
                            <div class="form-group">
                                <label class="form-label">Adresa trvalého pobytu</label>
                                <input type="text" class="form-input" id="zastupceAdresaFO" readonly>
                            </div>
                        </div>
                    </div>
                    
                    <!-- PO formulář -->
                    <div id="zastupceFormPO" style="display: none;">
                        <div class="form-row-ico">
                            <div class="form-group" style="flex: 1;">
                                <label class="form-label">IČO *</label>
                                <input type="text" class="form-input" id="zastupceICO" placeholder="12345678" maxlength="8">
                            </div>
                            <button type="button" class="btn btn-sm btn-outline btn-verify-ico" onclick="overitZastupceZRejstriku('PO')">
                                <span class="material-icons-outlined">verified_user</span>
                                Ověřit z rejstříku
                            </button>
                        </div>
                        <span class="verify-status" id="verifyStatusPO"></span>
                        
                        <!-- Doplněné údaje po ověření -->
                        <div id="zastupceDetailPO" style="display: none;">
                            <div class="form-group">
                                <label class="form-label">Název organizace</label>
                                <input type="text" class="form-input" id="zastupceNazev" readonly>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Sídlo</label>
                                <input type="text" class="form-input" id="zastupceAdresaPO" readonly>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Krok 2: Výběr zastupovaných -->
                <div class="form-section">
                    <div class="form-section-title">2. Zastupované osoby</div>
                    <p class="form-hint">Vyberte účastníky, které bude zástupce zastupovat. Lze vybrat více osob.</p>
                    
                    <div class="zastupovani-list" id="zastupovaniList">
                        <!-- Stavebník -->
                        <label class="zastupovani-item">
                            <input type="checkbox" name="zastupovani" value="jan-novak">
                            <div class="zastupovani-info">
                                <span class="zastupovani-name">Správa železnic, s.o.</span>
                                <span class="zastupovani-role">Stavebník / Žadatel</span>
                            </div>
                        </label>
                        
                        <!-- Obec -->
                        <label class="zastupovani-item">
                            <input type="checkbox" name="zastupovani" value="mesto-jaromer">
                            <div class="zastupovani-info">
                                <span class="zastupovani-name">Městys Doudleby n.O.</span>
                                <span class="zastupovani-role">Obec</span>
                            </div>
                        </label>
                        
                        <!-- Další účastníci se přidají dynamicky po ověření z KN -->
                        <div id="zastupovaniDynamicList"></div>
                    </div>
                </div>
                
                <!-- Krok 3: Nastavení doručování -->
                <div class="form-section">
                    <div class="form-section-title">3. Nastavení doručování</div>
                    
                    <label class="form-checkbox">
                        <input type="checkbox" id="zastupceNedorucovat" checked>
                        <span>Nedoručovat zastupovaným osobám <small class="text-muted">(doporučeno)</small></span>
                    </label>
                    
                    <p class="form-hint" style="margin-top: 8px;">
                        <span class="material-icons-outlined" style="font-size: 14px; vertical-align: middle;">info</span>
                        Pokud je zaškrtnuto, dokumenty budou doručovány pouze zástupci, nikoliv zastupovaným osobám.
                    </p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModalZastupce()">Zrušit</button>
                <button class="btn btn-primary" onclick="pridatZastupce()">
                    <span class="material-icons-outlined">add</span>
                    Přidat zástupce
                </button>
            </div>
        </div>
    </div>

    <!-- Kontrola: Zrychlené řízení -->
    <div class="control-overlay" id="controlZrychlene">
        <div class="control-header">
            <div class="control-header-left">
                <button class="control-close" onclick="closeControl('controlZrychlene')">
                    <span class="material-icons-outlined">close</span>
                </button>
                <div class="control-title">
                    <span class="material-icons-outlined">bolt</span>
                    Podmínky zrychleného řízení
                </div>
            </div>
        </div>
        <div class="control-body">
            <div class="control-viewer">
                <div class="viewer-tabs">
                    <div class="viewer-tabs-left">
                        <button class="viewer-tab active" onclick="switchViewerTab(this, 'zrychlene', 'zadost')">
                            <span class="material-icons-outlined">description</span>
                            Žádost
                        </button>
                        <button class="viewer-tab" onclick="switchViewerTab(this, 'zrychlene', 'prilohy')">
                            <span class="material-icons-outlined">attach_file</span>
                            Přílohy
                            <span class="badge">12</span>
                        </button>
                        <button class="viewer-tab" onclick="switchViewerTab(this, 'zrychlene', 'eed')">
                            <span class="material-icons-outlined">folder</span>
                            El. dokumentace
                        </button>
                        <button class="viewer-tab" onclick="switchViewerTab(this, 'zrychlene', 'doklady')">
                            <span class="material-icons-outlined">fact_check</span>
                            Dokladová část
                        </button>
                    </div>
                    <button class="viewer-open-external" onclick="openViewerExternal('zrychlene')" title="Otevřít v novém okně">
                        <span class="material-icons-outlined">open_in_new</span>
                    </button>
                </div>
                <div class="viewer-content" id="zrychleneViewerContent">
                    <div id="zrychleneViewerInner">
                        <div class="viewer-placeholder">
                            <span class="material-icons-outlined">description</span>
                            <div class="viewer-placeholder-title">Žádost o povolení stavby</div>
                            <div class="viewer-placeholder-text">Formulář žádosti s údaji o stavebníkovi a záměru</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="control-form">
                <div class="control-form-body">
                    <div class="control-section">
                        <div class="control-section-title">Podmínky podle § 212 stavebního zákona</div>
                        <p style="font-size: 13px; color: #5f6368; margin-bottom: 16px; font-style: normal;">
                            Ověřte splnění všech podmínek pro zrychlené řízení:
                        </p>
                        
                        <label class="control-option selected" style="cursor: default;">
                            <input type="checkbox" name="zr_uplnost" checked onclick="updateZrychleneResult()">
                            <div class="control-option-content">
                                <div class="control-option-label">Žádost je úplná</div>
                            </div>
                        </label>
                        <label class="control-option selected" style="cursor: default;">
                            <input type="checkbox" name="zr_eia" checked onclick="updateZrychleneResult()">
                            <div class="control-option-content">
                                <div class="control-option-label">Záměr nevyžaduje posouzení vlivů na ŽP</div>
                            </div>
                        </label>
                        <label class="control-option selected" style="cursor: default;">
                            <input type="checkbox" name="zr_up" checked onclick="updateZrychleneResult()">
                            <div class="control-option-content">
                                <div class="control-option-label">Záměr je v souladu s ÚP</div>
                            </div>
                        </label>
                        <label class="control-option selected" style="cursor: default;">
                            <input type="checkbox" name="zr_stanoviska" checked onclick="updateZrychleneResult()">
                            <div class="control-option-content">
                                <div class="control-option-label">Stanoviska DO jsou kladná nebo s podmínkami</div>
                            </div>
                        </label>
                        <label class="control-option selected" style="cursor: default;">
                            <input type="checkbox" name="zr_souhlasy" checked onclick="updateZrychleneResult()">
                            <div class="control-option-content">
                                <div class="control-option-label">Souhlasy účastníků jsou přiloženy</div>
                            </div>
                        </label>
                    </div>

                    <div class="result-preview positive" id="resultZrychlene">
                        <div class="result-preview-title">
                            <span class="material-icons-outlined">check_circle</span>
                            Podmínky splněny
                        </div>
                        <div class="result-preview-text">Všechny podmínky pro zrychlené řízení jsou splněny.</div>
                    </div>
                </div>
                <div class="control-form-footer">
                    <div class="control-form-footer-left">
                        <div class="auto-save-indicator saved" id="autoSaveZrychlene">
                            <span class="material-icons-outlined">cloud_done</span>
                            <span>Automaticky uloženo</span>
                        </div>
                    </div>
                    <div class="control-form-footer-right">
                        <button class="btn btn-secondary" onclick="closeControl('controlZrychlene')">Zrušit</button>
                        <button class="btn-save-draft" onclick="saveDraft('zrychlene')" title="Uložit rozpracovanou kontrolu">
                            <span class="material-icons-outlined">save</span>
                            Uložit
                        </button>
                        <button class="btn btn-primary" onclick="completeZrychlene()">
                            <span class="material-icons-outlined">check</span>
                            Potvrdit kontrolu
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ============================================ -->
    <!-- POMOCNÉ MODÁLY PRO NÁHLED DOKUMENTŮ -->
    <!-- ============================================ -->
    <!-- Modal: REZA - Informace o elektronické plné moci -->
    <div class="modal-overlay" id="rezaModal" onclick="closeModal('rezaModal', event)">
        <div class="modal" onclick="event.stopPropagation()" style="max-width: 600px;">
            <div class="modal-header" style="padding: 0; border: none;">
                <div class="reza-header" style="width: 100%; border-radius: 8px 8px 0 0;">
                    <div class="reza-logo">
                        <span class="material-icons-outlined">verified_user</span>
                    </div>
                    <div class="reza-header-text">
                        <div class="reza-title">Registr elektronických zastoupení</div>
                        <div class="reza-subtitle">Ověřená elektronická plná moc</div>
                    </div>
                    <div class="reza-verified-badge">
                        <span class="material-icons-outlined">check_circle</span>
                        Platná
                    </div>
                </div>
                <button class="modal-close" onclick="closeModal('rezaModal')" style="position: absolute; top: 12px; right: 12px; background: rgba(255,255,255,0.9);">
                    <span class="material-icons-outlined">close</span>
                </button>
            </div>
            <div class="reza-body" id="rezaModalBody">
                <!-- Obsah bude doplněn dynamicky -->
            </div>
            <div class="reza-footer">
                <div class="reza-footer-info">
                    Údaje z <a href="#">REZA - Registr elektronických zastoupení</a>
                </div>
                <button class="btn btn-secondary" onclick="closeModal('rezaModal')">Zavřít</button>
            </div>
        </div>
    </div>

    <!-- Modal: Přílohy pro vyhledání plné moci -->
    <div class="modal-overlay" id="prilohyPMModal" onclick="closeModal('prilohyPMModal', event)">
        <div class="modal" onclick="event.stopPropagation()" style="max-width: 700px;">
            <div class="modal-header">
                <div class="modal-title">
                    <span class="material-icons-outlined">attach_file</span>
                    Přílohy žádosti
                </div>
                <button class="modal-close" onclick="closeModal('prilohyPMModal')">
                    <span class="material-icons-outlined">close</span>
                </button>
            </div>
            <div class="modal-body" style="padding: 0;">
                <div style="padding: 12px 20px; background: #fff3e0; border-bottom: 1px solid #ffe082;">
                    <div style="display: flex; align-items: center; gap: 8px; font-size: 13px; color: #e65100;">
                        <span class="material-icons-outlined" style="font-size: 20px;">info</span>
                        <span>Vyhledejte a zkontrolujte potřebné dokumenty v přílohách žádosti (PDF).</span>
                    </div>
                </div>
                <div style="padding: 16px 20px;">
                    <div class="zadost-prilohy-list" id="prilohyPMList">
                        <div class="zadost-priloha-item attached" style="background: #fff3e0; border: 1px solid #ffe082;">
                            <div class="priloha-icon" style="color: #e65100;">
                                <span class="material-icons-outlined">description</span>
                            </div>
                            <div class="priloha-info">
                                <div class="priloha-name" style="font-weight: 600;">Plná moc — SŽ → Signal Projekt s.r.o.</div>
                                <div class="priloha-status">Přiloženo jako PDF • PM-036-2024-SŽ - Signal projekt.pdf • 156 KB</div>
                            </div>
                            <button class="priloha-action" style="background: #e65100; color: #fff; border-radius: 4px; padding: 6px 12px; border: none; cursor: pointer;" title="Otevřít ke kontrole">
                                <span class="material-icons-outlined">visibility</span>
                            </button>
                        </div>
                        
                        <div class="zadost-priloha-item attached">
                            <div class="priloha-icon">
                                <span class="material-icons-outlined">description</span>
                            </div>
                            <div class="priloha-info">
                                <div class="priloha-name">Plná moc — Signal Projekt → Mikulová</div>
                                <div class="priloha-status">Přiloženo jako PDF • PM-037-2024-Mikulová.pdf • 98 KB</div>
                            </div>
                            <button class="priloha-action" title="Otevřít">
                                <span class="material-icons-outlined">visibility</span>
                            </button>
                        </div>
                        
                        <div class="zadost-priloha-item attached">
                            <div class="priloha-icon">
                                <span class="material-icons-outlined">description</span>
                            </div>
                            <div class="priloha-info">
                                <div class="priloha-name">Pověření ředitele — Kosinová (SŽ, s.o.)</div>
                                <div class="priloha-status">Přiloženo jako PDF • Pověření ředitele Kosinová 9910 eč 3430.pdf • 78 KB</div>
                            </div>
                            <button class="priloha-action" title="Otevřít">
                                <span class="material-icons-outlined">visibility</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('prilohyPMModal')">Zavřít</button>
            </div>
        </div>
    </div>


    <!-- Modal pro editaci podmínek subjektu -->
    <div class="podminky-modal-overlay" id="podminkyModal">
        <div class="podminky-modal">
            <div class="podminky-modal-header">
                <div class="podminky-modal-title">
                    <span class="material-icons-outlined">edit_note</span>
                    <span id="podminkyModalTitle">Podmínky subjektu</span>
                </div>
                <button class="podminky-modal-close" onclick="closePodminkyModal()">
                    <span class="material-icons-outlined">close</span>
                </button>
            </div>
            <div class="podminky-modal-body">
                <!-- Info o dokumentu -->
                <div class="podminky-section">
                    <div class="podminky-section-title">Informace o dokladu</div>
                    <div class="dokument-info">
                        <div class="dokument-info-item">
                            <div class="dokument-info-label">Typ dokladu</div>
                            <div class="dokument-info-value" id="podminkyDokTyp">—</div>
                        </div>
                        <div class="dokument-info-item">
                            <div class="dokument-info-label">Číslo jednací</div>
                            <div class="dokument-info-value">
                                <input type="text" id="podminkyDokCj" placeholder="Např. MMHK/349238/2025">
                            </div>
                        </div>
                        <div class="dokument-info-item">
                            <div class="dokument-info-label">Datum vydání</div>
                            <div class="dokument-info-value">
                                <input type="date" id="podminkyDokDatum">
                            </div>
                        </div>
                        <div class="dokument-info-item">
                            <div class="dokument-info-label">Soubor</div>
                            <div class="dokument-info-value" id="podminkyDokSoubor">—</div>
                        </div>
                    </div>
                </div>

                <!-- Výsledek posouzení -->
                <div class="podminky-section">
                    <div class="podminky-section-title">Výsledek posouzení</div>
                    <div class="vysledek-options" id="vysledekOptions">
                        <label class="vysledek-option kladne">
                            <input type="radio" name="vysledekRadio" value="kladne">
                            <div class="vysledek-option-icon">
                                <span class="material-icons-outlined">check_circle</span>
                            </div>
                            <span class="vysledek-option-label">Kladné</span>
                        </label>
                        <label class="vysledek-option s-podminkami">
                            <input type="radio" name="vysledekRadio" value="kladne_s_podminkami">
                            <div class="vysledek-option-icon">
                                <span class="material-icons-outlined">task_alt</span>
                            </div>
                            <span class="vysledek-option-label">Kladné s podmínkami</span>
                        </label>
                        <label class="vysledek-option zaporne">
                            <input type="radio" name="vysledekRadio" value="zaporne">
                            <div class="vysledek-option-icon">
                                <span class="material-icons-outlined">cancel</span>
                            </div>
                            <span class="vysledek-option-label">Záporné</span>
                        </label>
                    </div>
                </div>

                <!-- Seznam podmínek -->
                <div class="podminky-section" id="podminkySectionList" style="display: none;">
                    <div class="podminky-section-title">Podmínky pro rozhodnutí</div>
                    <p style="font-size: 12px; color: #5f6368; margin-bottom: 12px;">
                        Zadejte podmínky, které budou součástí rozhodnutí o povolení stavby.
                    </p>
                    <div class="podminky-list" id="podminkyList">
                        <!-- Dynamicky renderováno -->
                    </div>
                    <div class="add-podminka-row">
                        <input type="text" class="add-podminka-input" id="addPodminkaText" placeholder="Přidat novou podmínku..." onkeypress="if(event.key==='Enter') addPodminka()">
                        <button class="btn-add-podminka" onclick="addPodminka()">
                            <span class="material-icons-outlined">add</span>
                            Přidat
                        </button>
                    </div>
                </div>

                <!-- Poznámka úředníka -->
                <div class="podminky-section">
                    <div class="podminky-section-title">Poznámka úředníka</div>
                    <textarea class="poznamka-textarea" id="podminkyPoznamka" placeholder="Interní poznámka k tomuto subjektu..."></textarea>
                </div>
            </div>
            <div class="podminky-modal-footer">
                <button class="btn btn-secondary" onclick="closePodminkyModal()">Zrušit</button>
                <button class="btn btn-primary" onclick="savePodminkyModal()">
                    <span class="material-icons-outlined">check</span>
                    Uložit změny
                </button>
            </div>
        </div>
    </div>

    <!-- Modal pro report dat pro rozhodnutí -->
    <div class="report-modal-overlay" id="reportModal">
        <div class="report-modal">
            <div class="report-modal-header">
                <div class="report-modal-title">
                    <span class="material-icons-outlined">summarize</span>
                    Report dokladové části
                </div>
                <div class="report-modal-actions">
                    <button class="btn-download" onclick="downloadReportHTML()">
                        <span class="material-icons-outlined">download</span>
                        Stáhnout HTML
                    </button>
                    <button class="btn-download" onclick="downloadReportJSON()">
                        <span class="material-icons-outlined">data_object</span>
                        Stáhnout JSON
                    </button>
                    <button class="report-modal-close" onclick="closeReportModal()">
                        <span class="material-icons-outlined">close</span>
                    </button>
                </div>
            </div>
            <div class="report-modal-body">
                <div class="report-content" id="reportContent">
                    <!-- Dynamicky generováno -->
                </div>
            </div>
        </div>
    </div>

    <!-- Modal pro postoupení řízení -->
    <div class="modal-overlay" id="postoupeniModal" onclick="closeModal('postoupeniModal', event)">
        <div class="modal" onclick="event.stopPropagation()" style="max-width: 600px;">
            <div class="modal-header" style="background: #e8f4fd; border-bottom: 1px solid #c2e0ff;">
                <div class="modal-title" style="display: flex; align-items: center; gap: 10px;">
                    <span class="material-icons-outlined" style="color: #1a73e8;">send</span>
                    Postoupení řízení z důvodu nepříslušnosti
                </div>
                <button class="modal-close" onclick="closeModal('postoupeniModal', event)" style="background: transparent; border: none; cursor: pointer; padding: 8px;">
                    <span class="material-icons-outlined">close</span>
                </button>
            </div>
            <div class="modal-body" style="padding: 24px;">
                <div style="background: #f8f9fa; border-radius: 8px; padding: 16px; margin-bottom: 20px;">
                    <div style="font-size: 12px; color: #5f6368; margin-bottom: 4px;">Řízení bude postoupeno:</div>
                    <div style="font-size: 16px; font-weight: 500; color: #202124;" id="postoupeniSuNazev">—</div>
                    <div style="font-size: 13px; color: #5f6368; margin-top: 4px;" id="postoupeniSuAdresa">—</div>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <div style="font-size: 13px; font-weight: 500; color: #202124; margin-bottom: 8px;">Zdůvodnění nepříslušnosti:</div>
                    <div style="font-size: 13px; color: #5f6368; background: #fff; border: 1px solid #e8eaed; border-radius: 6px; padding: 12px; line-height: 1.5;" id="postoupeniZduvodneni">—</div>
                </div>
                
                <div style="background: #fef7e0; border: 1px solid #fdd835; border-radius: 8px; padding: 16px; display: flex; gap: 12px;">
                    <span class="material-icons-outlined" style="color: #b06000; flex-shrink: 0;">info</span>
                    <div>
                        <div style="font-size: 13px; font-weight: 500; color: #202124; margin-bottom: 4px;">Co se stane po postoupení:</div>
                        <ul style="font-size: 12px; color: #5f6368; margin: 0; padding-left: 16px; line-height: 1.6;">
                            <li>Bude vygenerován dokument <strong>Postoupení řízení z důvodu nepříslušnosti</strong></li>
                            <li>Řízení bude interně předáno příslušnému stavebnímu úřadu prostřednictvím ISSŘ</li>
                            <li>Žadatel bude vyrozuměn o postoupení řízení</li>
                            <li>Řízení bude ve Vašem systému označeno jako postoupené</li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="modal-footer" style="padding: 16px 24px; border-top: 1px solid #e8eaed; display: flex; justify-content: flex-end; gap: 10px; background: #f8f9fa;">
                <button class="btn btn-secondary" onclick="closeModal('postoupeniModal', event)">
                    Zrušit
                </button>
                <button class="btn btn-primary" onclick="confirmPostoupeni()" style="background: #1a73e8;">
                    <span class="material-icons-outlined">send</span>
                    Potvrdit postoupení
                </button>
            </div>
        </div>
    </div>

    <script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script>
        // Globální stav nedostatků - MUSÍ být definován před ostatními funkcemi
        const globalIssues = {
            vyzva: [], // Výzva k doplnění + přerušení
            odlozeni: [], // Odložení žádosti
            postoupeni: [], // Postoupení
            staveni: [], // Stavění lhůty
            zamitnuti: [] // Zamítnutí
        };
        
        // Funkce pro práci s globalIssues
        function addGlobalIssue(type, issue) {
            const id = 'gi-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
            globalIssues[type].push({
                id: id,
                text: issue.text || '',
                hlavniText: issue.hlavniText || issue.text || '',
                source: issue.source || 'manual',
                controlName: issue.controlName || '',
                kategorie: issue.kategorie || null,       // 'autorizace' | 'dokladova_cast' | 'obsah_pd' | 'prurezovy'
                reference: issue.reference || null,        // e.g. 'B.2.1'
                castPD: issue.castPD || null,              // 'A' | 'B' | 'C' | 'D' | null
                doplnek: issue.doplnek || null,            // supplementary text
                priklady: issue.priklady || [],            // examples
                pravniPredpis: issue.pravniPredpis || null,// legal reference
                detaily: issue.detaily || null,            // structured details for complex items
                typAkce: issue.typAkce || 'doplnit',      // 'doplnit' | 'odstranit' | 'uvest_do_souladu'
                resolved: false,
                timestamp: new Date().toISOString()
            });
            updateGlobalIssuesBadge();
            return id;
        }
        
        function removeGlobalIssue(type, id) {
            globalIssues[type] = globalIssues[type].filter(i => i.id !== id);
            updateGlobalIssuesBadge();
            renderGlobalIssues();
        }
        
        function resolveGlobalIssue(type, id) {
            const issue = globalIssues[type].find(i => i.id === id);
            if (issue) {
                issue.resolved = !issue.resolved;
                updateGlobalIssuesBadge();
                renderGlobalIssues();
            }
        }
        
        function updateGlobalIssuesBadge() {
            const total = Object.values(globalIssues).reduce((sum, arr) => 
                sum + arr.filter(i => !i.resolved).length, 0);
            
            const badge = document.getElementById('nedostatkyBadge');
            const btn = document.getElementById('btnNedostatky');
            
            if (badge && btn) {
                badge.textContent = total;
                
                if (total > 0) {
                    btn.classList.add('has-issues');
                    badge.style.display = '';
                } else {
                    btn.classList.remove('has-issues');
                    badge.style.display = 'none';
                }
            }
        }
        
        function renderGlobalIssues() {
            const types = [
                { key: 'vyzva', listId: 'listVyzva', badgeId: 'badgeVyzva', emptyText: 'Žádné nedostatky', iconClass: 'warning' },
                { key: 'odlozeni', listId: 'listOdlozeni', badgeId: 'badgeOdlozeni', emptyText: 'Žádné závažné vady', iconClass: 'error' },
                { key: 'postoupeni', listId: 'listPostoupeni', badgeId: 'badgePostoupeni', emptyText: 'SÚ je příslušný', iconClass: 'warning' },
                { key: 'staveni', listId: 'listStaveni', badgeId: 'badgeStaveni', emptyText: 'Všechna stanoviska jsou k dispozici', iconClass: 'warning' },
                { key: 'zamitnuti', listId: 'listZamitnuti', badgeId: 'badgeZamitnuti', emptyText: 'Žádné důvody pro zamítnutí', iconClass: 'error' }
            ];
            
            types.forEach(t => {
                const list = document.getElementById(t.listId);
                const badge = document.getElementById(t.badgeId);
                if (!list || !badge) return;
                
                const issues = globalIssues[t.key];
                const unresolvedCount = issues.filter(i => !i.resolved).length;
                
                badge.textContent = unresolvedCount;
                
                if (issues.length === 0) {
                    list.innerHTML = `
                        <div style="text-align: center; padding: 20px; color: #9aa0a6; font-size: 13px;">
                            <span class="material-icons-outlined" style="font-size: 32px; margin-bottom: 8px; display: block;">check_circle</span>
                            ${t.emptyText}
                        </div>
                    `;
                } else {
                    list.innerHTML = issues.map(issue => {
                        const kategorieLabel = {
                            'autorizace': '🔴 Autorizace',
                            'dokladova_cast': '🟠 Dokladová část',
                            'obsah_pd': '🟣 Obsah PD',
                            'prurezovy': '🔵 Průřezový',
                            'formalni': '🔵 Formální'
                        };
                        const katBadge = issue.kategorie ? `<span style="display:inline-block;font-size:11px;padding:1px 6px;border-radius:8px;background:#f1f3f4;color:#3c4043;margin-right:6px;">${kategorieLabel[issue.kategorie] || issue.kategorie}</span>` : '';
                        const displayText = (issue.hlavniText || issue.text || '').replace(/\n/g, '<br>');
                        return `
                        <div class="global-issue-item ${issue.resolved ? 'resolved' : ''}">
                            <div class="global-issue-icon ${issue.resolved ? 'resolved' : t.iconClass}">
                                <span class="material-icons-outlined">${issue.resolved ? 'check' : 'warning'}</span>
                            </div>
                            <div class="global-issue-content">
                                <div class="global-issue-text">${katBadge}${displayText}</div>
                                <div class="global-issue-meta">
                                    ${issue.controlName ? issue.controlName + ' • ' : ''}
                                    ${issue.source === 'auto' ? 'Automaticky zjištěno' : 'Ručně přidáno'}
                                    ${issue.pravniPredpis ? ' • ' + issue.pravniPredpis : ''}
                                </div>
                            </div>
                            <div class="global-issue-actions">
                                <button class="global-issue-btn resolve" onclick="resolveGlobalIssue('${t.key}', '${issue.id}')" title="${issue.resolved ? 'Označit jako nevyřešené' : 'Označit jako vyřešené'}">
                                    <span class="material-icons-outlined">${issue.resolved ? 'undo' : 'check'}</span>
                                </button>
                                <button class="global-issue-btn" onclick="removeGlobalIssue('${t.key}', '${issue.id}')" title="Odebrat">
                                    <span class="material-icons-outlined">close</span>
                                </button>
                            </div>
                        </div>
                    `}).join('');
                }
            });
        }

        // State management
        const controls = {
            prislusnost: { done: false, depends: [], result: 'ok' },
            zadost: { done: false, depends: ['prislusnost'], result: 'ok' },
            dokumentace: { done: false, depends: ['prislusnost', 'zadost'], result: 'ok' },
            pozemky: { done: false, depends: ['prislusnost', 'zadost', 'dokumentace'], result: 'ok' },
            up: { done: false, depends: ['prislusnost', 'zadost', 'dokumentace', 'pozemky'], result: 'ok' },
            identifikace: { done: false, depends: ['pozemky'], result: 'ok' },
            ucastnici: { done: false, depends: ['zadost'], result: 'ok' },
            zrychlene: { done: false, depends: ['prislusnost', 'zadost', 'dokumentace', 'pozemky', 'up', 'identifikace', 'ucastnici'], result: 'ok' }
        };

        // Akce hlavního tlačítka: 'zahajit' | 'vyzva' | 'postoupit' | 'disabled'
        let _btnAction = 'disabled';

        // Control overlay functions
        function openControl(controlId) {
            document.getElementById(controlId).classList.add('open');
            document.body.style.overflow = 'hidden';
            
            // Inicializace specifických kontrol
            if (controlId === 'controlIdentifikace') {
                setTimeout(initIdentifikaceMatrix, 100);
            }
            
            // Pro kontrolu žádosti - nastavit správný režim podle typu podání
            if (controlId === 'controlZadost') {
                initZadostControlMode();
            }
            
            // Pro kontrolu příslušnosti - nastavit viewer podle typu podání
            if (controlId === 'controlPrislusnost') {
                initControlViewer('controlPrislusnost');
            }
            
            // Pro kontrolu ÚPD - inicializovat image viewery a reset stavu
            if (controlId === 'controlUP') {
                // Reset stavu pokud kontrola ještě není hotová
                if (!controls.up.done) {
                    resetUPDControl();
                }
                
                setTimeout(() => {
                    initViewer('situace');
                    initViewer('upd');
                }, 100);
            }
        }
        
        // Reset stavu kontroly ÚPD
        function resetUPDControl() {
            // Reset stavu - modifikujeme vlastnosti, ne celý objekt (protože je const)
            updState.urp.checked = false;
            updState.urp.soulad = null;
            updState.urp.text = '';
            
            updState.zur.checked = false;
            updState.zur.soulad = null;
            updState.zur.text = '';
            
            updState.up.checked = false;
            updState.up.soulad = null;
            updState.up.text = '';
            updState.up.exists = null;
            
            // Reset UI
            ['Urp', 'Zur', 'Up'].forEach(step => {
                const checkItem = document.getElementById('check' + step);
                if (checkItem) {
                    checkItem.classList.remove('done-ok', 'done-error');
                }
                
                const status = document.getElementById('status' + step);
                if (status) {
                    status.textContent = '';
                    status.classList.remove('ok', 'error');
                }
                
                const noteInput = document.getElementById('note' + step);
                if (noteInput) {
                    noteInput.value = '';
                    noteInput.style.display = 'none';
                }
                
                const indicator = document.getElementById('indicator' + step);
                if (indicator) {
                    indicator.classList.remove('visible');
                }
            });
            
            // Reset tlačítek
            document.querySelectorAll('#controlUP .upd-btn-yes, #controlUP .upd-btn-no').forEach(btn => {
                btn.classList.remove('selected');
            });
            
            // Skrýt sekce pro ÚP
            const souladSection = document.getElementById('upSouladSection');
            if (souladSection) souladSection.style.display = 'none';
            
            const noUpInfo = document.getElementById('noUpInfo');
            if (noUpInfo) noUpInfo.style.display = 'none';
            
            // Aktualizovat tlačítko
            updateUPDState();
        }

        function closeControl(controlId) {
            document.getElementById(controlId).classList.remove('open');
            document.body.style.overflow = '';
        }

        // Modal functions (pro náhled dokumentů z headeru)
        function openModal(modalId) {
            document.getElementById(modalId).classList.add('open');
            document.body.style.overflow = 'hidden';
        }

        function closeModal(modalId, event) {
            if (event && event.target !== event.currentTarget) return;
            document.getElementById(modalId).classList.remove('open');
            document.body.style.overflow = '';
        }
        
        // Otevření REZA modalu s informacemi o elektronickém zastoupení
        function openRezaModal(zastupceData) {
            const body = document.getElementById('rezaModalBody');
            
            // Typ zastoupení
            const typText = zastupceData.typZastoupeni === 'plna-moc' ? 'Plná moc' : 
                           (zastupceData.typZastoupeni === 'povereni' ? 'Pověření' : 'Statutární zástupce');
            
            body.innerHTML = `
                <div class="reza-info-section">
                    <div class="reza-info-title">Zmocnitel (zastoupený)</div>
                    <div class="reza-info-grid">
                        <div class="reza-info-item full">
                            <div class="reza-info-label">Jméno / Název</div>
                            <div class="reza-info-value">${zastupceData.zmocnitel || 'Správa železnic, s.o.'}</div>
                        </div>
                        <div class="reza-info-item">
                            <div class="reza-info-label">Datum narození / IČO</div>
                            <div class="reza-info-value">${zastupceData.zmocnitelId || '15. 3. 1985'}</div>
                        </div>
                    </div>
                </div>
                
                <div class="reza-info-section">
                    <div class="reza-info-title">Zmocněnec (zástupce)</div>
                    <div class="reza-info-grid">
                        <div class="reza-info-item full">
                            <div class="reza-info-label">Jméno / Název</div>
                            <div class="reza-info-value">${zastupceData.jmeno || ''} ${zastupceData.prijmeni || zastupceData.nazev || ''}</div>
                        </div>
                        <div class="reza-info-item">
                            <div class="reza-info-label">${zastupceData.ico ? 'IČO' : 'Datum narození'}</div>
                            <div class="reza-info-value">${zastupceData.ico || zastupceData.datumNarozeni || '—'}</div>
                        </div>
                        <div class="reza-info-item">
                            <div class="reza-info-label">Datová schránka</div>
                            <div class="reza-info-value">${zastupceData.ds || '—'}</div>
                        </div>
                    </div>
                </div>
                
                <div class="reza-info-section">
                    <div class="reza-info-title">Údaje o zastoupení</div>
                    <div class="reza-info-grid">
                        <div class="reza-info-item">
                            <div class="reza-info-label">Typ zastoupení</div>
                            <div class="reza-info-value">${typText}</div>
                        </div>
                        <div class="reza-info-item">
                            <div class="reza-info-label">Rozsah</div>
                            <div class="reza-info-value">${zastupceData.rozsah || 'Úplná plná moc'}</div>
                        </div>
                        <div class="reza-info-item full">
                            <div class="reza-info-label">Platnost</div>
                            <div class="reza-info-value">
                                <span class="reza-validity">
                                    <span class="material-icons-outlined">check_circle</span>
                                    ${zastupceData.platnostPM || 'Platná bez omezení'}
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div style="margin-top: 16px; padding: 12px; background: #e8f5e9; border-radius: 6px; display: flex; align-items: center; gap: 10px;">
                    <span class="material-icons-outlined" style="color: #2e7d32; font-size: 24px;">verified</span>
                    <div>
                        <div style="font-size: 13px; font-weight: 600; color: #1b5e20;">Zastoupení ověřeno v REZA</div>
                        <div style="font-size: 11px; color: #388e3c;">Portál stavebníka ověřil platnost zastoupení při podání žádosti</div>
                    </div>
                </div>
            `;
            
            openModal('rezaModal');
        }
        
        // Otevření modalu s přílohami pro vyhledání plné moci
        function openPrilohyPMModal() {
            openModal('prilohyPMModal');
        }
        
        // Alias pro otevření příloh z tlačítka v sekci Přílohy
        function openPrilohyModal() {
            openModal('prilohyPMModal');
        }
        
        // Scrollování na sekci Přílohy v Kontrole žádosti
        function scrollToPrilohy() {
            const prilohySection = document.getElementById('dataSectionPrilohyZadosti');
            if (prilohySection) {
                prilohySection.scrollIntoView({ behavior: 'smooth', block: 'center' });
                // Zvýraznění sekce
                prilohySection.style.boxShadow = '0 0 0 3px #1a73e8';
                setTimeout(() => {
                    prilohySection.style.boxShadow = '';
                }, 2000);
            }
        }
        
        // Otevření modalu pro úpravu uspořádání kontrol
        function openCustomizeControlsModal() {
            // Vytvoření jednoduchého modalu s popisem
            const modal = document.createElement('div');
            modal.className = 'modal-overlay open';
            modal.id = 'customizeControlsModal';
            modal.onclick = function(e) { if (e.target === modal) closeCustomizeControlsModal(); };
            
            modal.innerHTML = `
                <div class="modal" onclick="event.stopPropagation()" style="max-width: 500px;">
                    <div class="modal-header">
                        <div class="modal-title">
                            <span class="material-icons-outlined">tune</span>
                            Uspořádání kontrol
                        </div>
                        <button class="modal-close" onclick="closeCustomizeControlsModal()">
                            <span class="material-icons-outlined">close</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <div style="background: #f8f9fa; border: 2px dashed #dadce0; border-radius: 8px; padding: 32px 24px; text-align: center;">
                            <span class="material-icons-outlined" style="font-size: 48px; color: #9aa0a6; margin-bottom: 16px; display: block;">drag_indicator</span>
                            <p style="font-size: 14px; color: #3c4043; margin: 0 0 12px 0; font-weight: 500;">V ostré verzi by zde bylo možné:</p>
                            <ul style="text-align: left; font-size: 13px; color: #5f6368; margin: 0; padding-left: 24px; line-height: 1.8;">
                                <li>Přetahováním změnit pořadí kontrolních karet</li>
                                <li>Skrýt méně důležité kontroly</li>
                                <li>Seskupit související kontroly do záložek</li>
                                <li>Uložit vlastní uspořádání jako výchozí</li>
                            </ul>
                            <p style="font-size: 12px; color: #80868b; margin: 16px 0 0 0;">
                                <span class="material-icons-outlined" style="font-size: 14px; vertical-align: middle;">info</span>
                                Závislosti a návaznosti mezi kontrolami zůstanou zachovány.
                            </p>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" onclick="closeCustomizeControlsModal()">Zavřít</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            document.body.style.overflow = 'hidden';
        }
        
        function closeCustomizeControlsModal() {
            const modal = document.getElementById('customizeControlsModal');
            if (modal) {
                modal.remove();
                document.body.style.overflow = '';
            }
        }
        
        // Aktualizace názvu stavby v hlavičce
        function updateNazevStavby() {
            const input = document.getElementById('nazevStavby');
            const header = document.getElementById('caseTitleHeader');
            if (input && header) {
                header.textContent = input.value || 'Bez názvu';
            }
        }

        // Popis stavby - funkce pro rozbalení/sbalení editoru
        let originalPopisText = '';
        
        function expandPopisStavby() {
            const collapsed = document.getElementById('popisStavbyCollapsed');
            const editor = document.getElementById('popisStavbyEditor');
            const textarea = document.getElementById('popisStavbyTextarea');
            const expandBtn = collapsed ? collapsed.querySelector('.popis-expand-btn .material-icons-outlined') : null;
            
            // Uložit původní text pro případ zrušení
            originalPopisText = textarea.value;
            
            // Skrýt sbalený stav, zobrazit editor
            if (collapsed) collapsed.style.display = 'none';
            if (editor) editor.style.display = 'block';
            
            // Fokus na textarea
            if (textarea) {
                textarea.focus();
                textarea.setSelectionRange(textarea.value.length, textarea.value.length);
            }
        }
        
        function collapsePopisStavby() {
            const collapsed = document.getElementById('popisStavbyCollapsed');
            const editor = document.getElementById('popisStavbyEditor');
            const textarea = document.getElementById('popisStavbyTextarea');
            const statusBadge = document.getElementById('popisStatusBadge');
            
            // Aktualizovat badge podle obsahu
            if (statusBadge && textarea) {
                const text = textarea.value.trim();
                if (text && text.length > 20) {
                    statusBadge.style.display = 'inline';
                } else {
                    statusBadge.style.display = 'none';
                }
            }
            
            // Skrýt editor, zobrazit sbalený stav
            if (editor) editor.style.display = 'none';
            if (collapsed) collapsed.style.display = 'flex';
        }
        
        function savePopisStavby() {
            collapsePopisStavby();
            
            // Vizuální potvrzení uložení
            const collapsed = document.getElementById('popisStavbyCollapsed');
            if (collapsed) {
                collapsed.style.transition = 'background 0.3s';
                collapsed.style.background = '#e6f4ea';
                setTimeout(() => {
                    collapsed.style.background = '';
                }, 1000);
            }
        }
        
        function cancelPopisStavby() {
            const textarea = document.getElementById('popisStavbyTextarea');
            if (textarea) {
                textarea.value = originalPopisText;
            }
            collapsePopisStavby();
        }
        
        function loadPopisFromAI() {
            const btn = document.getElementById('popisAiBtn');
            const textarea = document.getElementById('popisStavbyTextarea');
            const textSpan = btn.querySelector('.popis-ai-text');
            const loadingSpan = btn.querySelector('.popis-ai-loading');
            
            // Zobrazit loading stav
            btn.disabled = true;
            if (textSpan) textSpan.style.display = 'none';
            if (loadingSpan) loadingSpan.style.display = 'inline-flex';
            
            // Simulace AI načítání (2.5 sekundy)
            setTimeout(() => {
                // AI vygenerovaný popis ze souhrnné technické zprávy
                const aiPopis = `Předmětem stavebního záměru je oprava zabezpečovacího zařízení v žst. Doudleby nad Orlicí na trati č. 010 Pardubice – Lichkov st. hr. Záměr zahrnuje výměnu stávajícího reléového zabezpečovacího zařízení za elektronické stavědlo typu ESA 44, úpravy přejezdových zabezpečovacích zařízení, sdělovacích zařízení a souvisejících kabelových tras.

Stavba je členěna na provozní soubory (PS) a stavební objekty (SO):

PS 11-01-21 – Staniční zabezpečovací zařízení žst. Doudleby n.O.
PS 12-02-11 – Přejezdové ZZ v km 2,345
PS 12-02-71 – Přejezdové ZZ v km 4,567
PS 12-02-81 – Přejezdové ZZ v km 6,789
PS 12-02-01 – Přejezdové ZZ (další)
PS 13-02-51 – Sdělovací zařízení
PS 14-02-51 – Kabelové rozvody
PS 14-03-51 – Napájení zabezpečovacího zařízení

SO 12-12-01 – Kabelovod a kabelové trasy
SO 12-76-01 – Úpravy trakčního vedení
SO 12-86-02 – Úpravy osvětlení
SO 12-88-01 – Demolice

Stavba se nachází v k.ú. Doudleby nad Orlicí (26 pozemků), Kostelec nad Orlicí (1 pozemek), Vamberk (10 pozemků) a Záměl (1 pozemek). Celkem 38 dotčených pozemků ve 4 katastrálních územích.`;
                
                if (textarea) {
                    textarea.value = aiPopis;
                }
                
                // Vrátit button do původního stavu
                btn.disabled = false;
                if (textSpan) textSpan.style.display = 'inline';
                if (loadingSpan) loadingSpan.style.display = 'none';
                
                // Změnit text buttonu
                if (textSpan) textSpan.textContent = 'Načteno z dokumentace';
                btn.style.background = '#e6f4ea';
                btn.style.borderColor = '#34a853';
                btn.style.color = '#137333';
                
            }, 2500);
        }

        // Escape key closes overlays
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                // Výzva editor (highest priority)
                if (document.getElementById('vyzvaEditorOverlay')) {
                    closeVyzvaEditor();
                    return;
                }
                document.querySelectorAll('.control-overlay.open').forEach(function(overlay) {
                    overlay.classList.remove('open');
                });
                document.querySelectorAll('.modal-overlay.open').forEach(function(modal) {
                    modal.classList.remove('open');
                });
                document.body.style.overflow = '';
            }
        });

        // Otevření prohlížeče v novém okně (simulace druhého monitoru)
        function openViewerExternal(controlType) {
            const controlNames = {
                'prislusnost': 'Kontrola příslušnosti',
                'kontrolazadosti': 'Kontrola žádosti',
                'pozemky': 'Pozemky',
                'dokumentace': 'Kontrola dokumentace',
                'identifikace': 'Identifikace subjektů',
                'up': 'Soulad s ÚPD',
                'ucastnici': 'Osoby',
                'zrychlene': 'Zrychlené řízení'
            };
            
            const controlName = controlNames[controlType] || controlType;
            
            // Otevřít nové okno s náhledem
            const newWindow = window.open('', '_blank', 'width=900,height=700,menubar=no,toolbar=no,location=no,status=no');
            
            if (newWindow) {
                newWindow.document.write(`
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title>Prohlížeč dokumentů - ${controlName}</title>
                        <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet">
                        <style>
                            * { margin: 0; padding: 0; box-sizing: border-box; }
                            body { 
                                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                                background: #f5f5f5;
                            }
                            .header {
                                background: #004289;
                                color: #fff;
                                padding: 16px 24px;
                                display: flex;
                                align-items: center;
                                gap: 12px;
                            }
                            .header h1 {
                                font-size: 16px;
                                font-weight: 500;
                            }
                            .header .material-icons-outlined {
                                font-size: 24px;
                            }
                            .tabs {
                                background: #fff;
                                padding: 12px 16px;
                                border-bottom: 1px solid #e0e0e0;
                                display: flex;
                                gap: 8px;
                            }
                            .tab {
                                display: inline-flex;
                                align-items: center;
                                gap: 6px;
                                padding: 8px 14px;
                                background: #f5f5f5;
                                border: 1px solid #e0e0e0;
                                border-radius: 6px;
                                font-size: 13px;
                                color: #5f6368;
                                cursor: pointer;
                            }
                            .tab:hover {
                                background: #e8f1fa;
                                border-color: #004289;
                                color: #004289;
                            }
                            .tab.active {
                                background: #004289;
                                border-color: #004289;
                                color: #fff;
                            }
                            .content {
                                flex: 1;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                text-align: center;
                                padding: 60px 40px;
                                min-height: calc(100vh - 120px);
                            }
                            .placeholder {
                                color: #5f6368;
                            }
                            .placeholder .material-icons-outlined {
                                font-size: 64px;
                                color: #9aa0a6;
                                margin-bottom: 16px;
                            }
                            .placeholder h2 {
                                font-size: 18px;
                                font-weight: 500;
                                color: #202124;
                                margin-bottom: 8px;
                            }
                            .placeholder p {
                                font-size: 13px;
                                color: #5f6368;
                            }
                            .info-badge {
                                display: inline-flex;
                                align-items: center;
                                gap: 6px;
                                margin-top: 20px;
                                padding: 8px 16px;
                                background: #e8f4fd;
                                border-radius: 20px;
                                font-size: 12px;
                                color: #1a73e8;
                            }
                        </style>
                    </head>
                    <body>
                        <div class="header">
                            <span class="material-icons-outlined">monitor</span>
                            <h1>Prohlížeč dokumentů — ${controlName}</h1>
                        </div>
                        <div class="tabs">
                            <button class="tab active">
                                <span class="material-icons-outlined">description</span>
                                Žádost
                            </button>
                            <button class="tab">
                                <span class="material-icons-outlined">attach_file</span>
                                Přílohy
                            </button>
                            <button class="tab">
                                <span class="material-icons-outlined">folder</span>
                                Dokumentace
                            </button>
                        </div>
                        <div class="content">
                            <div class="placeholder">
                                <span class="material-icons-outlined">description</span>
                                <h2>Žádost o povolení stavby</h2>
                                <p>V produkční verzi by se zde zobrazil náhled dokumentu</p>
                                <div class="info-badge">
                                    <span class="material-icons-outlined" style="font-size: 16px;">desktop_windows</span>
                                    Samostatné okno pro druhý monitor
                                </div>
                            </div>
                        </div>
                    </body>
                    </html>
                `);
                newWindow.document.close();
            } else {
                alert('Prohlížeč zablokoval otevření nového okna. Povolte prosím vyskakovací okna pro tuto stránku.');
            }
        }

        // Viewer tab switching
        // Placeholdery pro kontroly s jedním kontejnerem
        const _viewerPlaceholders = {
            zadost:  { icon: 'description', title: 'Žádost o povolení stavby', desc: 'Formulář žádosti s údaji o stavebníkovi a záměru' },
            dtm:     { icon: 'layers', title: 'Digitální technická mapa', desc: 'Sítě technické infrastruktury v okolí stavby' },
            kn:      { icon: 'terrain', title: 'Katastr nemovitostí', desc: 'Informace o vlastnících pozemků a sousedech' },
            uplan:   { icon: 'map', title: 'Územní plán', desc: 'Platný územní plán obce s regulativy' },
            mapa:    { icon: 'map', title: 'Mapa parcel', desc: 'Vizuální zobrazení pozemků záměru a sousedů' }
        };
        
        function switchViewerTab(button, controlType, docType) {
            // Update active tab button
            const tabs = button.parentElement.querySelectorAll('.viewer-tab');
            tabs.forEach(tab => tab.classList.remove('active'));
            button.classList.add('active');

            var vc = document.getElementById(controlType + 'ViewerContent');
            var inner = document.getElementById(controlType + 'ViewerInner');
            if (!vc || !inner) return;

            // Embedded viewer záložky
            if (docType === 'prilohy' || docType === 'eed' || docType === 'doklady') {
                vc.classList.add('ev-active');
                inner.style.height = '100%';
                inner.innerHTML = '';
                var evType = docType === 'eed' ? 'dokumentace' : docType;
                renderEmbeddedViewer(inner.id, evType, controlType + '_' + docType);
                return;
            }
            
            // Statické záložky (placeholder)
            vc.classList.remove('ev-active');
            inner.style.height = '';
            inner.className = '';
            var cfg = _viewerPlaceholders[docType] || _viewerPlaceholders.zadost;
            inner.innerHTML = '<div class="viewer-placeholder"><span class="material-icons-outlined">' + cfg.icon + '</span>' +
                '<div class="viewer-placeholder-title">' + cfg.title + '</div>' +
                '<div class="viewer-placeholder-text">' + cfg.desc + '</div></div>';
        }

        // Option selection with visual feedback
        function selectOption(element, isNegative = false) {
            const container = element.closest('.control-section');
            const options = container.querySelectorAll('.control-option');
            
            options.forEach(opt => {
                opt.classList.remove('selected', 'negative');
            });
            
            element.classList.add('selected');
            if (isNegative) {
                element.classList.add('negative');
            }
        }

        // ==========================================
        // POZEMKY A SOUSEDÉ
        // ==========================================
        // ==========================================
        // POZEMKY A SOUSEDÉ - kompletní logika
        // ==========================================
        
        let pozemkyState = {
            method: 'auto',
            viewModeZameru: 'chips',  // 'chips', 'list' nebo 'grouped'
            viewModeSousedni: 'chips',
            sortZameru: { field: null, asc: true },  // řazení pozemků záměru
            sortSousedni: { field: null, asc: true }, // řazení sousedních
            pozemkyZameru: [
                { cislo: 'st. 321', katastr: 'Doudleby n.O.', kod: '631761', plocha: '—', typ: 'zastavena' },
                { cislo: 'st. 916', katastr: 'Doudleby n.O.', kod: '631761', plocha: '—', typ: 'zastavena' },
                { cislo: '1549', katastr: 'Doudleby n.O.', kod: '631761', plocha: '—', typ: 'pozemkova' },
                { cislo: '1550/1', katastr: 'Doudleby n.O.', kod: '631761', plocha: '—', typ: 'pozemkova' },
                { cislo: '1550/2', katastr: 'Doudleby n.O.', kod: '631761', plocha: '—', typ: 'pozemkova' },
                { cislo: '3334', katastr: 'Doudleby n.O.', kod: '631761', plocha: '—', typ: 'pozemkova' },
                { cislo: '981/31', katastr: 'Kostelec n.O.', kod: '669938', plocha: '—', typ: 'pozemkova' },
                { cislo: 'st. 541', katastr: 'Vamberk', kod: '776131', plocha: '—', typ: 'zastavena' },
                { cislo: '1804/1', katastr: 'Vamberk', kod: '776131', plocha: '—', typ: 'pozemkova' },
                { cislo: '195/3', katastr: 'Záměl', kod: '789747', plocha: '—', typ: 'pozemkova' }
            ],
            sousedniParcely: [
                // U staveb drah se sousední pozemky identifikují z DTM a KN automaticky
            ],
            knVerified: false,
            owners: []
        };
        
        // Funkce pro přepínání zobrazení pozemků
        function setPozemkyView(type, mode) {
            if (type === 'zameru') {
                pozemkyState.viewModeZameru = mode;
                // Aktualizace tlačítek
                const toggle = document.getElementById('pozemkyZameruToggle');
                toggle.querySelectorAll('.pozemky-view-btn').forEach(btn => {
                    btn.classList.toggle('active', btn.getAttribute('onclick').includes(mode));
                });
                renderPozemkyZameru();
            } else if (type === 'sousedni') {
                pozemkyState.viewModeSousedni = mode;
                // Aktualizace tlačítek
                const toggle = document.getElementById('sousedniToggle');
                toggle.querySelectorAll('.pozemky-view-btn').forEach(btn => {
                    btn.classList.toggle('active', btn.getAttribute('onclick').includes(mode));
                });
                renderSousedniParcely();
            }
        }
        
        // Funkce pro řazení pozemků
        function sortPozemky(type, field) {
            const sortState = type === 'zameru' ? pozemkyState.sortZameru : pozemkyState.sortSousedni;
            
            // Přepnout směr řazení pokud klikáme na stejné pole
            if (sortState.field === field) {
                sortState.asc = !sortState.asc;
            } else {
                sortState.field = field;
                sortState.asc = true;
            }
            
            // Seřadit data
            const data = type === 'zameru' ? pozemkyState.pozemkyZameru : pozemkyState.sousedniParcely;
            
            data.sort((a, b) => {
                let valA = a[field];
                let valB = b[field];
                
                // Speciální řazení pro číslo parcely
                if (field === 'cislo') {
                    valA = parseParcela(valA);
                    valB = parseParcela(valB);
                } else {
                    valA = valA.toLowerCase();
                    valB = valB.toLowerCase();
                }
                
                let result = 0;
                if (typeof valA === 'object') {
                    // Porovnání objektů z parseParcela
                    if (valA.isStavebni !== valB.isStavebni) {
                        result = valA.isStavebni ? -1 : 1;
                    } else if (valA.main !== valB.main) {
                        result = valA.main - valB.main;
                    } else {
                        result = valA.sub - valB.sub;
                    }
                } else {
                    result = valA.localeCompare(valB, 'cs');
                }
                
                return sortState.asc ? result : -result;
            });
            
            // Překreslit
            if (type === 'zameru') {
                renderPozemkyZameru();
            } else {
                renderSousedniParcely();
            }
        }
        
        // Pomocná funkce pro parsování čísla parcely
        function parseParcela(cislo) {
            const isStavebni = cislo.toLowerCase().startsWith('st');
            const cleanNum = cislo.replace(/^st\.?\s*/i, '').trim();
            const parts = cleanNum.split('/');
            return {
                isStavebni: isStavebni,
                main: parseInt(parts[0]) || 0,
                sub: parseInt(parts[1]) || 0
            };
        }

        // Inicializace - renderovat pozemky záměru při načtení
        document.addEventListener('DOMContentLoaded', function() {
            renderPozemkyZameru();
            renderSousedniParcely();
            
            // Inicializace badge pro popis stavby
            const textarea = document.getElementById('popisStavbyTextarea');
            const statusBadge = document.getElementById('popisStatusBadge');
            if (textarea && statusBadge && textarea.value.trim().length > 20) {
                statusBadge.style.display = 'inline';
            }
        });

        // ==========================================
        // SESKUPENÉ ZOBRAZENÍ POZEMKŮ PODLE K.Ú.
        // ==========================================
        
        // Generuje HTML pro seskupené zobrazení pozemků
        function renderGroupedPozemky(pozemky, type) {
            // Seskupit pozemky podle katastrálního území
            const grouped = {};
            pozemky.forEach((p, index) => {
                const key = `${p.katastr}|${p.kod}`;
                if (!grouped[key]) {
                    grouped[key] = {
                        katastr: p.katastr,
                        kod: p.kod,
                        pozemky: []
                    };
                }
                grouped[key].pozemky.push({ ...p, originalIndex: index });
            });
            
            // Získat seznam katastrálních území pro filtr
            const kuList = Object.values(grouped).map(g => ({ katastr: g.katastr, kod: g.kod }));
            
            let html = `<div class="pozemky-grouped-container" data-type="${type}">`;
            
            // Vyhledávací panel
            html += `
                <div class="pozemky-grouped-search">
                    <div class="pozemky-search-field">
                        <span class="material-icons-outlined">search</span>
                        <input type="text" class="pozemky-search-input" 
                            id="pozemkySearch_${type}" 
                            placeholder="Vyhledat parcelu (např. st. 321)..." 
                            oninput="filterGroupedPozemky('${type}')">
                    </div>
                    <select class="pozemky-filter-select" id="pozemkyFilter_${type}" onchange="filterGroupedPozemky('${type}')">
                        <option value="">Všechna k.ú. (${kuList.length})</option>
                        ${kuList.map(ku => `<option value="${ku.kod}">${ku.katastr} [${ku.kod}]</option>`).join('')}
                    </select>
                </div>
            `;
            
            // Skupiny k.ú.
            Object.entries(grouped).forEach(([key, group], groupIndex) => {
                html += `
                    <div class="pozemky-ku-group" data-ku="${group.kod}" id="kuGroup_${type}_${group.kod}">
                        <div class="pozemky-ku-header" onclick="toggleKuGroup('${type}', '${group.kod}')">
                            <div class="pozemky-ku-expand">
                                <span class="material-icons-outlined">chevron_right</span>
                            </div>
                            <div class="pozemky-ku-info">
                                <span class="pozemky-ku-name">${group.katastr}</span>
                                <span class="pozemky-ku-code">[${group.kod}]</span>
                            </div>
                            <span class="pozemky-ku-count">${group.pozemky.length}</span>
                        </div>
                        <div class="pozemky-ku-content">
                            <div class="pozemky-ku-list">
                `;
                
                // Seřadit pozemky ve skupině
                group.pozemky.sort((a, b) => {
                    const pa = parseParcela(a.cislo);
                    const pb = parseParcela(b.cislo);
                    if (pa.isStavebni !== pb.isStavebni) return pa.isStavebni ? -1 : 1;
                    if (pa.main !== pb.main) return pa.main - pb.main;
                    return pa.sub - pb.sub;
                });
                
                group.pozemky.forEach(p => {
                    const icon = p.typ === 'zastavena' || p.cislo.toLowerCase().startsWith('st') ? 'crop_square' : 'grass';
                    const rowClass = type === 'zameru' ? 'zamer' : 'soused';
                    const removeFunc = type === 'zameru' ? 'removePozemekZameru' : 'removeSousedni';
                    
                    html += `
                        <div class="pozemky-ku-row ${rowClass}" data-parcela="${p.cislo.toLowerCase()}">
                            <span class="material-icons-outlined row-icon">${icon}</span>
                            <span class="row-parcela">${p.cislo}</span>
                            <span class="row-typ">${p.typ === 'zastavena' ? 'Zastavěná pl.' : 'Pozemková'}</span>
                            <span class="row-plocha">${p.plocha}</span>
                            <button class="row-remove" onclick="${removeFunc}(${p.originalIndex})" title="Odebrat">
                                <span class="material-icons-outlined">close</span>
                            </button>
                        </div>
                    `;
                });
                
                html += `
                            </div>
                        </div>
                    </div>
                `;
            });
            
            // Prázdný stav pro vyhledávání
            html += `
                <div class="pozemky-no-results" id="pozemkyNoResults_${type}" style="display: none;">
                    <span class="material-icons-outlined">search_off</span>
                    Žádné pozemky neodpovídají filtru
                </div>
            `;
            
            html += '</div>';
            
            return html;
        }
        
        // Přepínání rozbalení skupiny k.ú.
        function toggleKuGroup(type, kod) {
            const group = document.getElementById(`kuGroup_${type}_${kod}`);
            const header = group.querySelector('.pozemky-ku-header');
            
            group.classList.toggle('expanded');
            header.classList.toggle('expanded');
        }
        
        // Filtrování pozemků v seskupeném zobrazení
        function filterGroupedPozemky(type) {
            const searchInput = document.getElementById(`pozemkySearch_${type}`);
            const filterSelect = document.getElementById(`pozemkyFilter_${type}`);
            const noResults = document.getElementById(`pozemkyNoResults_${type}`);
            
            const searchValue = searchInput.value.toLowerCase().trim();
            const filterKu = filterSelect.value;
            
            const container = document.querySelector(`.pozemky-grouped-container[data-type="${type}"]`);
            const groups = container.querySelectorAll('.pozemky-ku-group');
            
            let totalVisible = 0;
            
            groups.forEach(group => {
                const groupKu = group.dataset.ku;
                const rows = group.querySelectorAll('.pozemky-ku-row');
                
                // Filtr podle k.ú.
                if (filterKu && groupKu !== filterKu) {
                    group.classList.add('hidden');
                    return;
                }
                
                group.classList.remove('hidden');
                
                // Filtr podle čísla parcely
                let visibleInGroup = 0;
                rows.forEach(row => {
                    const parcela = row.dataset.parcela;
                    if (searchValue && !parcela.includes(searchValue)) {
                        row.classList.add('hidden');
                    } else {
                        row.classList.remove('hidden');
                        visibleInGroup++;
                        
                        // Zvýraznění nalezené parcely
                        if (searchValue && parcela.includes(searchValue)) {
                            row.classList.add('highlighted');
                            setTimeout(() => row.classList.remove('highlighted'), 2000);
                        }
                    }
                });
                
                // Skrýt skupinu pokud nemá viditelné pozemky
                if (visibleInGroup === 0) {
                    group.classList.add('hidden');
                } else {
                    // Automaticky rozbalit skupinu s výsledky při vyhledávání
                    if (searchValue) {
                        group.classList.add('expanded');
                        group.querySelector('.pozemky-ku-header').classList.add('expanded');
                    }
                }
                
                totalVisible += visibleInGroup;
            });
            
            // Zobrazit/skrýt prázdný stav
            if (noResults) {
                noResults.style.display = totalVisible === 0 ? 'block' : 'none';
            }
        }

        function renderPozemkyZameru() {
            const list = document.getElementById('pozemkyZameruList');
            const countBadge = document.getElementById('pozemkyZameruCount');
            const viewMode = pozemkyState.viewModeZameru;
            const sort = pozemkyState.sortZameru;
            
            if (pozemkyState.pozemkyZameru.length === 0) {
                list.innerHTML = `
                    <div class="pozemky-empty-note">
                        <span class="material-icons-outlined">warning</span>
                        Nejsou definovány žádné pozemky záměru. Přidejte alespoň jeden pozemek.
                    </div>
                `;
                countBadge.textContent = '0 parcel';
            } else {
                const pocet = pozemkyState.pozemkyZameru.length;
                countBadge.textContent = pocet + ' ' + (pocet === 1 ? 'parcela' : (pocet < 5 ? 'parcely' : 'parcel'));
                
                let html = '';
                
                if (viewMode === 'chips') {
                    // Kompaktní chip zobrazení
                    html = '<div class="pozemky-chips-container">';
                    pozemkyState.pozemkyZameru.forEach((p, index) => {
                        const icon = p.typ === 'zastavena' ? 'crop_square' : 'grass';
                        html += `
                            <div class="pozemek-chip zamer" title="k.ú. ${p.katastr} [${p.kod}]${p.plocha !== '—' ? ' • ' + p.plocha : ''}">
                                <span class="material-icons-outlined chip-icon">${icon}</span>
                                <span class="chip-parcela">${p.cislo}</span>
                                <span class="chip-ku">${p.katastr.substring(0, 8)}${p.katastr.length > 8 ? '…' : ''}</span>
                                <button class="chip-remove" onclick="removePozemekZameru(${index})" title="Odebrat">
                                    <span class="material-icons-outlined">close</span>
                                </button>
                            </div>
                        `;
                    });
                    html += '</div>';
                } else if (viewMode === 'grouped') {
                    // Seskupené zobrazení podle k.ú.
                    html = renderGroupedPozemky(pozemkyState.pozemkyZameru, 'zameru');
                } else {
                    // Řádkové zobrazení s hlavičkou
                    const parcelaSortClass = sort.field === 'cislo' ? (sort.asc ? 'active asc' : 'active') : '';
                    const katastrSortClass = sort.field === 'katastr' ? (sort.asc ? 'active asc' : 'active') : '';
                    
                    html = '<div class="pozemky-list-container">';
                    html += `
                        <div class="pozemky-list-header">
                            <span class="col-icon"></span>
                            <span class="header-col col-parcela ${parcelaSortClass}" onclick="sortPozemky('zameru', 'cislo')">
                                Parcela
                                <span class="material-icons-outlined sort-icon">arrow_downward</span>
                            </span>
                            <span class="header-col col-katastr ${katastrSortClass}" onclick="sortPozemky('zameru', 'katastr')">
                                Katastrální území
                                <span class="material-icons-outlined sort-icon">arrow_downward</span>
                            </span>
                            <span class="col-kod">Kód</span>
                            <span class="col-plocha">Plocha</span>
                            <span class="col-actions"></span>
                        </div>
                    `;
                    pozemkyState.pozemkyZameru.forEach((p, index) => {
                        const icon = p.typ === 'zastavena' ? 'crop_square' : 'grass';
                        html += `
                            <div class="pozemek-row zamer">
                                <span class="material-icons-outlined row-icon">${icon}</span>
                                <span class="row-parcela">${p.cislo}</span>
                                <span class="row-katastr">${p.katastr}</span>
                                <span class="row-kod">[${p.kod}]</span>
                                <span class="row-plocha">${p.plocha}</span>
                                <button class="row-remove" onclick="removePozemekZameru(${index})" title="Odebrat">
                                    <span class="material-icons-outlined">close</span>
                                </button>
                            </div>
                        `;
                    });
                    html += '</div>';
                }
                
                list.innerHTML = html;
            }
            
            updatePozemkyState();
        }

        function addPozemekZameru() {
            const obecSelect = document.getElementById('pozemekObec');
            const kuSelect = document.getElementById('pozemekKU');
            const input = document.getElementById('pozemekZameruInput');
            const value = input.value.trim();
            
            if (!value) {
                alert('Zadejte číslo parcely.');
                return;
            }
            
            // Určení katastrálního území
            let katastr = 'Doudleby nad Orlicí';
            let kod = '779091';
            
            if (kuSelect.value) {
                katastr = kuSelect.options[kuSelect.selectedIndex].text;
                kod = kuSelect.value.split('-')[1] || '779091';
            }
            
            // Určení typu parcely podle čísla
            const isZastavena = value.toLowerCase().startsWith('st.');
            
            pozemkyState.pozemkyZameru.push({
                cislo: value,
                katastr: katastr,
                kod: kod,
                plocha: '—',
                typ: isZastavena ? 'zastavena' : 'pozemkova'
            });
            
            renderPozemkyZameru();
            input.value = '';
        }
        
        function selectPozemekMethod(method) {
            // Update tlačítek - pouze pro pozemky záměru
            const pozemkySection = document.getElementById('pozemekMethodRucne').closest('.pozemky-section');
            pozemkySection.querySelectorAll('.neighbor-method-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.method === method);
            });
            
            // Zobrazení správného obsahu
            document.getElementById('pozemekMethodRucne').style.display = method === 'rucne' ? 'block' : 'none';
            document.getElementById('pozemekMethodMapa').style.display = method === 'mapa' ? 'block' : 'none';
            
            // Při volbě Z mapy přepnout viewer na záložku Mapa
            if (method === 'mapa') {
                const mapTab = document.querySelector('#controlPozemky .viewer-tab:nth-child(4)');
                if (mapTab) {
                    switchPozemkyTab(mapTab, 'mapa');
                }
            }
        }
        
        function loadKatastralniUzemi() {
            const obecSelect = document.getElementById('pozemekObec');
            const kuSelect = document.getElementById('pozemekKU');
            const obec = obecSelect.value;
            
            // Reset k.ú. dropdown
            kuSelect.innerHTML = '<option value="">Vyberte k.ú....</option>';
            kuSelect.disabled = true;
            
            if (!obec) return;
            
            // Simulace načtení k.ú. podle obce
            const katastry = {
                'veseli': [
                    { value: 'doudleby-631761', text: 'Doudleby nad Orlicí' },
                    { value: 'horusice-779091', text: 'Horusice' }
                ],
                'tabor': [
                    { value: 'tabor-764621', text: 'Tábor' },
                    { value: 'klokoty-764621', text: 'Klokoty' },
                    { value: 'chotoviny-764621', text: 'Chotoviny' }
                ],
                'soběslav': [
                    { value: 'sobeslav-752177', text: 'Soběslav' },
                    { value: 'chlebov-752177', text: 'Chlebov' }
                ]
            };
            
            if (katastry[obec]) {
                katastry[obec].forEach(ku => {
                    const option = document.createElement('option');
                    option.value = ku.value;
                    option.textContent = ku.text;
                    kuSelect.appendChild(option);
                });
                kuSelect.disabled = false;
            }
        }
        
        function openMapForPozemkyZameru() {
            // Přepnutí na záložku Mapa ve vieweru
            const mapTab = document.querySelector('#controlPozemky .viewer-tab:nth-child(4)');
            if (mapTab) {
                switchPozemkyTab(mapTab, 'mapa');
            }
            alert('V ostré verzi by se zde otevřela katastrální mapa pro výběr pozemků záměru kliknutím na parcely.');
        }

        function removePozemekZameru(index) {
            pozemkyState.pozemkyZameru.splice(index, 1);
            renderPozemkyZameru();
        }

        function switchPozemkyTab(tabEl, view) {
            const tabs = document.querySelectorAll('#controlPozemky .viewer-tab');
            tabs.forEach(t => t.classList.remove('active'));
            tabEl.classList.add('active');
            
            const viewer = document.getElementById('viewer-pozemky');
            
            if (view === 'mapa') {
                // Zobrazit interaktivní katastrální mapu
                viewer.innerHTML = '';
                viewer.classList.remove('viewer-placeholder');
                viewer.appendChild(createKatastrMap());
            } else {
                viewer.classList.add('viewer-placeholder');
                const viewConfig = {
                    'zadost': { icon: 'description', title: 'Žádost o povolení stavby', text: 'Pozemky uvedené stavebníkem v žádosti' },
                    'situace': { icon: 'architecture', title: 'Situační výkresy', text: 'C.1 - C.4 ze složky dokumentace' },
                    'kn': { icon: 'terrain', title: 'Katastr nemovitostí', text: 'Nahlížení do katastru nemovitostí' }
                };
                
                const config = viewConfig[view];
                viewer.innerHTML = `
                    <span class="material-icons-outlined">${config.icon}</span>
                    <div class="viewer-placeholder-title">${config.title}</div>
                    <div class="viewer-placeholder-text">${config.text}</div>
                `;
            }
        }
        
        // ==========================================
        // INTERAKTIVNÍ KATASTRÁLNÍ MAPA
        // ==========================================
        
        // Data parcel pro mapu
        const mapParcelyData = [
            // Pozemky záměru (modré ohraničení)
            { id: 'st142', cislo: 'st. 142', typ: 'zastavena', points: '280,180 320,180 320,220 280,220', plocha: '560 m²', druh: 'Zastavěná plocha', ku: 'Radonice', isZamer: true },
            { id: 'p248-3', cislo: '248/3', typ: 'ornapuda', points: '180,120 280,120 280,220 240,220 240,180 180,180', plocha: '1 240 m²', druh: 'Orná půda', ku: 'Radonice', isZamer: true },
            { id: 'p248-4', cislo: '248/4', typ: 'ornapuda', points: '320,120 400,120 400,180 320,180', plocha: '320 m²', druh: 'Orná půda', ku: 'Radonice', isZamer: true },
            { id: 'st143', cislo: 'st. 143', typ: 'zastavena', points: '340,185 375,185 375,215 340,215', plocha: '180 m²', druh: 'Zastavěná plocha', ku: 'Radonice', isZamer: true },
            { id: 'p251-1', cislo: '251/1', typ: 'travni', points: '280,220 380,220 380,300 320,300 320,260 280,260', plocha: '890 m²', druh: 'Trvalý travní porost', ku: 'Radonice', isZamer: true },
            
            // Sousední pozemky (zelené ohraničení)
            { id: 'p247-1', cislo: '247/1', typ: 'ornapuda', points: '80,120 180,120 180,180 140,180 140,220 80,220', plocha: '1 120 m²', druh: 'Orná půda', ku: 'Radonice', isSoused: true },
            { id: 'p247-2', cislo: '247/2', typ: 'zahrada', points: '80,220 140,220 140,260 80,260', plocha: '450 m²', druh: 'Zahrada', ku: 'Radonice', isSoused: true },
            { id: 'p249', cislo: '249', typ: 'ornapuda', points: '400,120 520,120 520,220 400,220 400,180', plocha: '2 340 m²', druh: 'Orná půda', ku: 'Radonice', isSoused: true },
            { id: 'st140', cislo: 'st. 140', typ: 'zastavena', points: '100,145 135,145 135,175 100,175', plocha: '210 m²', druh: 'Zastavěná plocha', ku: 'Radonice', isSoused: true },
            { id: 'st141', cislo: 'st. 141', typ: 'zastavena', points: '145,185 175,185 175,215 145,215', plocha: '185 m²', druh: 'Zastavěná plocha', ku: 'Radonice', isSoused: true },
            { id: 'p250-1', cislo: '250/1', typ: 'travni', points: '380,220 460,220 460,280 380,280', plocha: '670 m²', druh: 'Trvalý travní porost', ku: 'Radonice', isSoused: true },
            { id: 'p250-2', cislo: '250/2', typ: 'travni', points: '460,220 520,220 520,300 460,300 460,280', plocha: '380 m²', druh: 'Trvalý travní porost', ku: 'Radonice', isSoused: true },
            { id: 'p252', cislo: '252', typ: 'ornapuda', points: '320,300 440,300 440,380 320,380', plocha: '1 560 m²', druh: 'Orná půda', ku: 'Radonice', isSoused: true },
            { id: 'p246-3', cislo: '246/3', typ: 'les', points: '80,260 180,260 180,340 80,340', plocha: '920 m²', druh: 'Lesní pozemek', ku: 'Radonice', isSoused: true },
            { id: 'st139', cislo: 'st. 139', typ: 'zastavena', points: '95,275 130,275 130,310 95,310', plocha: '240 m²', druh: 'Zastavěná plocha', ku: 'Radonice', isSoused: true },
            { id: 'p253-1', cislo: '253/1', typ: 'travni', points: '440,300 520,300 520,360 440,360', plocha: '780 m²', druh: 'Trvalý travní porost', ku: 'Radonice', isSoused: true },
            { id: 'p253-2', cislo: '253/2', typ: 'zahrada', points: '440,360 520,360 520,400 440,400', plocha: '415 m²', druh: 'Zahrada', ku: 'Radonice', isSoused: true },
            
            // Ostatní pozemky
            { id: 'p244', cislo: '244', typ: 'ornapuda', points: '80,60 200,60 200,120 80,120', plocha: '1 800 m²', druh: 'Orná půda', ku: 'Radonice' },
            { id: 'p245', cislo: '245', typ: 'ornapuda', points: '200,60 340,60 340,120 200,120', plocha: '2 100 m²', druh: 'Orná půda', ku: 'Radonice' },
            { id: 'p246-1', cislo: '246/1', typ: 'ornapuda', points: '340,60 480,60 480,120 340,120', plocha: '2 450 m²', druh: 'Orná půda', ku: 'Radonice' },
            { id: 'p246-2', cislo: '246/2', typ: 'ornapuda', points: '480,60 560,60 560,120 520,120 520,80 480,80', plocha: '980 m²', druh: 'Orná půda', ku: 'Radonice' },
            { id: 'p254', cislo: '254', typ: 'travni', points: '180,260 240,260 240,340 180,340', plocha: '720 m²', druh: 'Trvalý travní porost', ku: 'Radonice' },
            { id: 'p255', cislo: '255', typ: 'travni', points: '240,260 320,260 320,340 240,340', plocha: '880 m²', druh: 'Trvalý travní porost', ku: 'Radonice' },
            { id: 'p256', cislo: '256', typ: 'les', points: '80,340 180,340 180,400 80,400', plocha: '1 100 m²', druh: 'Lesní pozemek', ku: 'Radonice' },
            { id: 'p257', cislo: '257', typ: 'travni', points: '180,340 320,340 320,400 180,400', plocha: '1 650 m²', druh: 'Trvalý travní porost', ku: 'Radonice' },
            { id: 'p258', cislo: '258', typ: 'ornapuda', points: '320,380 440,380 440,430 320,430', plocha: '1 200 m²', druh: 'Orná půda', ku: 'Radonice' }
        ];
        
        let mapZoom = 100;
        let selectedParcela = null;
        let mapPolygonMode = false;
        let polygonPoints = [];
        let selectedByPolygon = [];
        
        function createKatastrMap() {
            const container = document.createElement('div');
            container.className = 'katastr-map-container';
            
            container.innerHTML = `
                <div class="katastr-map-toolbar">
                    <div class="katastr-map-title">
                        <span class="material-icons-outlined">map</span>
                        <span id="mapKuTitle">k.ú. Radonice [747076]</span>
                    </div>
                    <div class="katastr-search-container">
                        <span class="material-icons-outlined">search</span>
                        <input type="text" class="katastr-search-input" id="mapSearchInput" 
                            placeholder="Hledat obec nebo k.ú...." 
                            oninput="searchKatastr(this.value)"
                            onfocus="showKatastrDropdown()"
                            autocomplete="off">
                        <div class="katastr-search-dropdown" id="mapSearchDropdown">
                            <div class="katastr-search-group">
                                <div class="katastr-search-group-title">Nedávné</div>
                                <div class="katastr-search-item" onclick="selectKatastr('Radonice', '747076')">
                                    <span class="material-icons-outlined">history</span>
                                    Radonice [747076]
                                </div>
                            </div>
                            <div class="katastr-search-group">
                                <div class="katastr-search-group-title">Výsledky</div>
                                <div class="katastr-search-item" onclick="selectKatastr('Kunratice', '728390')">
                                    <span class="material-icons-outlined">place</span>
                                    Doudleby n.O. [631761], Praha
                                </div>
                                <div class="katastr-search-item" onclick="selectKatastr('Šeberov', '746011')">
                                    <span class="material-icons-outlined">place</span>
                                    Šeberov [746011], Praha
                                </div>
                                <div class="katastr-search-item" onclick="selectKatastr('Doudleby nad Orlicí', '631761')">
                                    <span class="material-icons-outlined">place</span>
                                    Doudleby nad Orlicí [631761]
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="katastr-tools-separator"></div>
                    <div class="katastr-tool-btn ${mapPolygonMode ? 'active' : ''}" onclick="togglePolygonSelect()" id="btnPolygonSelect" title="Výběr polygonem">
                        <span class="material-icons-outlined">polyline</span>
                    </div>
                    <div class="katastr-layers-btn" onclick="toggleMapLayers()">
                        <span class="material-icons-outlined">layers</span>
                        Vrstvy
                    </div>
                    <div class="katastr-map-zoom">
                        <button class="katastr-zoom-btn" onclick="zoomMap(-10)" title="Oddálit">
                            <span class="material-icons-outlined">remove</span>
                        </button>
                        <span class="katastr-zoom-level" id="mapZoomLevel">100%</span>
                        <button class="katastr-zoom-btn" onclick="zoomMap(10)" title="Přiblížit">
                            <span class="material-icons-outlined">add</span>
                        </button>
                    </div>
                </div>
                
                <!-- Polygon mode banner -->
                <div class="katastr-polygon-banner" id="polygonBanner" style="display: none;">
                    <span class="material-icons-outlined">polyline</span>
                    <span>Režim výběru polygonem: klikáním vytvořte body, dvojklikem dokončete výběr</span>
                    <button onclick="cancelPolygonSelect()">Zrušit</button>
                </div>
                
                <div class="katastr-map-viewport" id="mapViewport">
                    <svg class="katastr-map-svg" id="katastrSvg" viewBox="40 30 560 420">
                        <defs>
                            <pattern id="gridPattern" width="20" height="20" patternUnits="userSpaceOnUse">
                                <path d="M 20 0 L 0 0 0 20" fill="none" stroke="#e0e0e0" stroke-width="0.5"/>
                            </pattern>
                            <!-- Vzor pro pozemky záměru -->
                            <pattern id="zamerPattern" width="8" height="8" patternUnits="userSpaceOnUse" patternTransform="rotate(45)">
                                <line x1="0" y1="0" x2="0" y2="8" stroke="#1a73e8" stroke-width="2" opacity="0.3"/>
                            </pattern>
                            <!-- Vzor pro sousední pozemky -->
                            <pattern id="sousedPattern" width="6" height="6" patternUnits="userSpaceOnUse">
                                <circle cx="3" cy="3" r="1" fill="#34a853" opacity="0.4"/>
                            </pattern>
                        </defs>
                        
                        <!-- Pozadí s mřížkou -->
                        <rect x="40" y="30" width="560" height="420" fill="url(#gridPattern)"/>
                        
                        <!-- Parcely budou vygenerovány JS -->
                        <g id="parcelyGroup"></g>
                        
                        <!-- Overlay pro pozemky záměru -->
                        <g id="zamerOverlayGroup"></g>
                        
                        <!-- Overlay pro sousední pozemky -->
                        <g id="sousedOverlayGroup"></g>
                        
                        <!-- Hranice k.ú. -->
                        <rect class="ku-boundary" x="60" y="45" width="520" height="390"/>
                        
                        <!-- Polygon selection -->
                        <g id="polygonSelectGroup">
                            <polygon id="selectionPolygon" class="selection-polygon" points=""/>
                            <g id="selectionPoints"></g>
                        </g>
                        
                        <!-- Labels budou vygenerovány JS -->
                        <g id="labelsGroup"></g>
                    </svg>
                    
                    <!-- Legenda -->
                    <div class="katastr-legend">
                        <div class="katastr-legend-title">Legenda</div>
                        <div class="katastr-legend-item">
                            <div class="katastr-legend-color" style="background: #f5e6c8;"></div>
                            <span>Orná půda</span>
                        </div>
                        <div class="katastr-legend-item">
                            <div class="katastr-legend-color" style="background: #c8e6c9;"></div>
                            <span>Travní porost</span>
                        </div>
                        <div class="katastr-legend-item">
                            <div class="katastr-legend-color" style="background: #ffcdd2;"></div>
                            <span>Zastavěná plocha</span>
                        </div>
                        <div class="katastr-legend-item">
                            <div class="katastr-legend-color" style="background: #a5d6a7;"></div>
                            <span>Les</span>
                        </div>
                        <div class="katastr-legend-item">
                            <div class="katastr-legend-color" style="background: #dcedc8;"></div>
                            <span>Zahrada</span>
                        </div>
                        <div class="katastr-legend-item" style="margin-top: 6px; padding-top: 6px; border-top: 1px solid #e0e0e0;">
                            <div class="katastr-legend-color" style="background: transparent; border: 2px solid #1a73e8;"></div>
                            <span>Pozemky záměru</span>
                        </div>
                        <div class="katastr-legend-item">
                            <div class="katastr-legend-color" style="background: transparent; border: 2px solid #34a853;"></div>
                            <span>Sousední pozemky</span>
                        </div>
                    </div>
                    
                    <!-- Měřítko -->
                    <div class="katastr-scale">
                        <div class="katastr-scale-bar"></div>
                        <span>50 m</span>
                    </div>
                    
                    <!-- Tooltip -->
                    <div class="katastr-tooltip" id="mapTooltip"></div>
                    
                    <!-- Info panel -->
                    <div class="katastr-info-panel" id="mapInfoPanel">
                        <div class="katastr-info-header">
                            <span class="katastr-info-parcela" id="infoParcela">—</span>
                            <button class="katastr-info-close" onclick="closeMapInfo()">
                                <span class="material-icons-outlined">close</span>
                            </button>
                        </div>
                        <div class="katastr-info-details">
                            <span class="katastr-info-label">Katastrální území:</span>
                            <span class="katastr-info-value" id="infoKu">—</span>
                            <span class="katastr-info-label">Druh pozemku:</span>
                            <span class="katastr-info-value" id="infoDruh">—</span>
                            <span class="katastr-info-label">Výměra:</span>
                            <span class="katastr-info-value" id="infoPlocha">—</span>
                        </div>
                        <div class="katastr-info-actions">
                            <button class="katastr-info-btn" onclick="addParcelaAsSoused()" id="btnAddSoused">
                                <span class="material-icons-outlined">add</span>
                                Přidat jako sousední
                            </button>
                            <button class="katastr-info-btn primary" onclick="addParcelaAsZamer()" id="btnAddZamer">
                                <span class="material-icons-outlined">add_location</span>
                                Přidat do záměru
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            // Inicializovat parcely po přidání do DOM
            setTimeout(() => {
                renderMapParcely();
                initMapInteractions();
            }, 50);
            
            return container;
        }
        
        function renderMapParcely() {
            const parcelyGroup = document.getElementById('parcelyGroup');
            const labelsGroup = document.getElementById('labelsGroup');
            const zamerOverlay = document.getElementById('zamerOverlayGroup');
            const sousedOverlay = document.getElementById('sousedOverlayGroup');
            
            if (!parcelyGroup || !labelsGroup) return;
            
            let parcelyHtml = '';
            let labelsHtml = '';
            let zamerOverlayHtml = '';
            let sousedOverlayHtml = '';
            
            mapParcelyData.forEach(p => {
                // Určit CSS třídy
                let classes = `parcela-polygon typ-${p.typ}`;
                if (p.isZamer) classes += ' zamer';
                if (p.isSoused) classes += ' soused';
                
                // Polygon parcely
                parcelyHtml += `<polygon 
                    class="${classes}" 
                    points="${p.points}" 
                    data-id="${p.id}"
                    data-cislo="${p.cislo}"
                    data-ku="${p.ku}"
                    data-druh="${p.druh}"
                    data-plocha="${p.plocha}"
                    data-is-zamer="${p.isZamer || false}"
                    data-is-soused="${p.isSoused || false}"
                />`;
                
                // Přidat overlay pro pozemky záměru (šrafování)
                if (p.isZamer) {
                    zamerOverlayHtml += `<polygon class="parcela-overlay-zamer" points="${p.points}"/>`;
                }
                
                // Přidat overlay pro sousední pozemky (tečky)
                if (p.isSoused) {
                    sousedOverlayHtml += `<polygon class="parcela-overlay-soused" points="${p.points}"/>`;
                }
                
                // Vypočítat střed pro label
                const center = getPolygonCenter(p.points);
                const isStavebni = p.cislo.startsWith('st');
                const labelClass = isStavebni ? 'parcela-label stavebni' : 'parcela-label';
                
                labelsHtml += `<text class="${labelClass}" x="${center.x}" y="${center.y}">${p.cislo}</text>`;
            });
            
            parcelyGroup.innerHTML = parcelyHtml;
            labelsGroup.innerHTML = labelsHtml;
            if (zamerOverlay) zamerOverlay.innerHTML = zamerOverlayHtml;
            if (sousedOverlay) sousedOverlay.innerHTML = sousedOverlayHtml;
        }
        
        function getPolygonCenter(pointsStr) {
            const points = pointsStr.split(' ').map(p => {
                const [x, y] = p.split(',').map(Number);
                return { x, y };
            });
            
            let sumX = 0, sumY = 0;
            points.forEach(p => {
                sumX += p.x;
                sumY += p.y;
            });
            
            return {
                x: Math.round(sumX / points.length),
                y: Math.round(sumY / points.length)
            };
        }
        
        function initMapInteractions() {
            const svg = document.getElementById('katastrSvg');
            const tooltip = document.getElementById('mapTooltip');
            const viewport = document.getElementById('mapViewport');
            
            if (!svg) return;
            
            // Hover efekt a tooltip
            svg.addEventListener('mousemove', (e) => {
                const target = e.target.closest('.parcela-polygon');
                
                if (target) {
                    const cislo = target.dataset.cislo;
                    const plocha = target.dataset.plocha;
                    
                    tooltip.innerHTML = `<strong>${cislo}</strong> • ${plocha}`;
                    tooltip.classList.add('visible');
                    
                    const rect = viewport.getBoundingClientRect();
                    tooltip.style.left = (e.clientX - rect.left + 15) + 'px';
                    tooltip.style.top = (e.clientY - rect.top - 10) + 'px';
                } else {
                    tooltip.classList.remove('visible');
                }
            });
            
            svg.addEventListener('mouseleave', () => {
                tooltip.classList.remove('visible');
            });
            
            // Klik pro výběr parcely
            svg.addEventListener('click', (e) => {
                const target = e.target.closest('.parcela-polygon');
                
                if (target) {
                    // Odznačit předchozí
                    const prev = svg.querySelector('.parcela-polygon.selected');
                    if (prev) prev.classList.remove('selected');
                    
                    // Označit novou
                    target.classList.add('selected');
                    selectedParcela = target.dataset;
                    
                    // Zobrazit info panel
                    showMapInfo(target.dataset);
                }
            });
        }
        
        function showMapInfo(data) {
            const panel = document.getElementById('mapInfoPanel');
            
            document.getElementById('infoParcela').textContent = data.cislo;
            document.getElementById('infoKu').textContent = `${data.ku} [747076]`;
            document.getElementById('infoDruh').textContent = data.druh;
            document.getElementById('infoPlocha').textContent = data.plocha;
            
            // Upravit tlačítka podle stavu
            const btnZamer = document.getElementById('btnAddZamer');
            const btnSoused = document.getElementById('btnAddSoused');
            
            const isZamer = data.isZamer === 'true' || data.isZamer === true;
            const isSoused = data.isSoused === 'true' || data.isSoused === true;
            
            if (isZamer) {
                btnZamer.innerHTML = '<span class="material-icons-outlined">remove_circle_outline</span> Odebrat ze záměru';
                btnZamer.disabled = false;
                btnZamer.classList.remove('primary');
                btnZamer.classList.add('danger');
                btnZamer.onclick = function() { removeParcelaFromZamer(); };
            } else {
                btnZamer.innerHTML = '<span class="material-icons-outlined">add_location</span> Přidat do záměru';
                btnZamer.disabled = false;
                btnZamer.classList.add('primary');
                btnZamer.classList.remove('danger');
                btnZamer.onclick = function() { addParcelaAsZamer(); };
            }
            
            if (isSoused) {
                btnSoused.innerHTML = '<span class="material-icons-outlined">remove_circle_outline</span> Odebrat ze sousedních';
                btnSoused.disabled = false;
                btnSoused.classList.add('danger');
                btnSoused.onclick = function() { removeParcelaFromSoused(); };
            } else {
                btnSoused.innerHTML = '<span class="material-icons-outlined">add</span> Přidat jako sousední';
                btnSoused.disabled = false;
                btnSoused.classList.remove('danger');
                btnSoused.onclick = function() { addParcelaAsSoused(); };
            }
            
            panel.classList.add('visible');
        }
        
        function removeParcelaFromZamer() {
            if (!selectedParcela) return;
            
            // Najít a odstranit z pozemků záměru
            const index = pozemkyState.pozemkyZameru.findIndex(p => p.cislo === selectedParcela.cislo);
            if (index !== -1) {
                pozemkyState.pozemkyZameru.splice(index, 1);
            }
            
            // Aktualizovat mapu data
            const parcelaInData = mapParcelyData.find(p => p.id === selectedParcela.id);
            if (parcelaInData) {
                parcelaInData.isZamer = false;
            }
            
            // Aktualizovat SVG
            const polygon = document.querySelector(`.parcela-polygon[data-id="${selectedParcela.id}"]`);
            if (polygon) {
                polygon.classList.remove('zamer');
                polygon.dataset.isZamer = 'false';
            }
            
            // Aktualizovat selectedParcela
            selectedParcela.isZamer = 'false';
            
            renderPozemkyZameru();
            renderMapParcely();
            showMapInfo(selectedParcela);
            updatePozemkyState();
        }
        
        function removeParcelaFromSoused() {
            if (!selectedParcela) return;
            
            // Najít a odstranit ze sousedních pozemků
            const index = pozemkyState.sousedniParcely.findIndex(p => p.cislo === selectedParcela.cislo);
            if (index !== -1) {
                pozemkyState.sousedniParcely.splice(index, 1);
            }
            
            // Aktualizovat mapu data
            const parcelaInData = mapParcelyData.find(p => p.id === selectedParcela.id);
            if (parcelaInData) {
                parcelaInData.isSoused = false;
            }
            
            // Aktualizovat SVG
            const polygon = document.querySelector(`.parcela-polygon[data-id="${selectedParcela.id}"]`);
            if (polygon) {
                polygon.classList.remove('soused');
                polygon.dataset.isSoused = 'false';
            }
            
            // Aktualizovat selectedParcela
            selectedParcela.isSoused = 'false';
            
            renderSousedniParcely();
            renderMapParcely();
            showMapInfo(selectedParcela);
            updatePozemkyState();
        }
        
        function closeMapInfo() {
            document.getElementById('mapInfoPanel').classList.remove('visible');
            
            const selected = document.querySelector('.parcela-polygon.selected');
            if (selected) selected.classList.remove('selected');
            
            selectedParcela = null;
        }
        
        function zoomMap(delta) {
            mapZoom = Math.max(50, Math.min(200, mapZoom + delta));
            document.getElementById('mapZoomLevel').textContent = mapZoom + '%';
            
            const svg = document.getElementById('katastrSvg');
            if (svg) {
                const scale = mapZoom / 100;
                const viewBoxWidth = 560 / scale;
                const viewBoxHeight = 420 / scale;
                const offsetX = (560 - viewBoxWidth) / 2 + 40;
                const offsetY = (420 - viewBoxHeight) / 2 + 30;
                svg.setAttribute('viewBox', `${offsetX} ${offsetY} ${viewBoxWidth} ${viewBoxHeight}`);
            }
        }
        
        function addParcelaAsZamer() {
            if (!selectedParcela) return;
            
            // Přidat do pozemků záměru
            const isStavebni = selectedParcela.cislo.toLowerCase().startsWith('st');
            pozemkyState.pozemkyZameru.push({
                cislo: selectedParcela.cislo,
                katastr: selectedParcela.ku,
                kod: '747076',
                plocha: selectedParcela.plocha,
                typ: isStavebni ? 'zastavena' : 'pozemkova'
            });
            
            // Aktualizovat mapu
            const parcelaInData = mapParcelyData.find(p => p.id === selectedParcela.id);
            if (parcelaInData) {
                parcelaInData.isZamer = true;
            }
            
            // Aktualizovat SVG
            const polygon = document.querySelector(`.parcela-polygon[data-id="${selectedParcela.id}"]`);
            if (polygon) {
                polygon.classList.add('zamer');
                polygon.dataset.isZamer = 'true';
            }
            
            renderPozemkyZameru();
            renderMapParcely();
            showMapInfo(selectedParcela);
            updatePozemkyState();
        }
        
        function addParcelaAsSoused() {
            if (!selectedParcela) return;
            
            // Přidat do sousedních pozemků
            pozemkyState.sousedniParcely.push({
                cislo: selectedParcela.cislo,
                katastr: selectedParcela.ku,
                kod: '747076',
                plocha: selectedParcela.plocha
            });
            
            // Aktualizovat mapu
            const parcelaInData = mapParcelyData.find(p => p.id === selectedParcela.id);
            if (parcelaInData) {
                parcelaInData.isSoused = true;
            }
            
            // Aktualizovat SVG
            const polygon = document.querySelector(`.parcela-polygon[data-id="${selectedParcela.id}"]`);
            if (polygon) {
                polygon.classList.add('soused');
                polygon.dataset.isSoused = 'true';
            }
            
            renderSousedniParcely();
            renderMapParcely();
            showMapInfo(selectedParcela);
            updatePozemkyState();
        }
        
        // ==========================================
        // VYHLEDÁVÁNÍ KATASTRÁLNÍHO ÚZEMÍ
        // ==========================================
        
        function showKatastrDropdown() {
            const dropdown = document.getElementById('mapSearchDropdown');
            if (dropdown) dropdown.classList.add('visible');
            
            // Zavřít při kliknutí mimo
            setTimeout(() => {
                document.addEventListener('click', hideKatastrDropdown);
            }, 100);
        }
        
        function hideKatastrDropdown(e) {
            const container = document.querySelector('.katastr-search-container');
            if (container && !container.contains(e.target)) {
                const dropdown = document.getElementById('mapSearchDropdown');
                if (dropdown) dropdown.classList.remove('visible');
                document.removeEventListener('click', hideKatastrDropdown);
            }
        }
        
        function searchKatastr(query) {
            // V reálné aplikaci by se zde volalo API
            // Pro simulaci jen ukážeme dropdown
            const dropdown = document.getElementById('mapSearchDropdown');
            if (dropdown && query.length > 0) {
                dropdown.classList.add('visible');
            }
        }
        
        function selectKatastr(name, kod) {
            // Aktualizovat titulek
            const title = document.getElementById('mapKuTitle');
            if (title) title.textContent = `k.ú. ${name} [${kod}]`;
            
            // Zavřít dropdown
            const dropdown = document.getElementById('mapSearchDropdown');
            if (dropdown) dropdown.classList.remove('visible');
            
            // Vyčistit input
            const input = document.getElementById('mapSearchInput');
            if (input) input.value = '';
            
            // V reálné aplikaci by se zde načetla data pro nové k.ú.
            console.log(`Přepnuto na k.ú. ${name} [${kod}]`);
        }
        
        // ==========================================
        // VÝBĚR POLYGONEM
        // ==========================================
        
        function togglePolygonSelect() {
            mapPolygonMode = !mapPolygonMode;
            
            const btn = document.getElementById('btnPolygonSelect');
            const banner = document.getElementById('polygonBanner');
            const viewport = document.getElementById('mapViewport');
            
            if (mapPolygonMode) {
                btn.classList.add('active');
                banner.style.display = 'flex';
                viewport.style.cursor = 'crosshair';
                polygonPoints = [];
                updatePolygonDisplay();
                
                // Přidat event listenery
                const svg = document.getElementById('katastrSvg');
                svg.addEventListener('click', handlePolygonClick);
                svg.addEventListener('dblclick', finishPolygonSelect);
                svg.addEventListener('mousemove', handlePolygonMouseMove);
            } else {
                cancelPolygonSelect();
            }
        }
        
        function cancelPolygonSelect() {
            mapPolygonMode = false;
            polygonPoints = [];
            selectedByPolygon = [];
            
            const btn = document.getElementById('btnPolygonSelect');
            const banner = document.getElementById('polygonBanner');
            const viewport = document.getElementById('mapViewport');
            const selectionPanel = document.getElementById('polygonSelectionPanel');
            
            if (btn) btn.classList.remove('active');
            if (banner) banner.style.display = 'none';
            if (viewport) viewport.style.cursor = 'grab';
            if (selectionPanel) selectionPanel.classList.remove('visible');
            
            updatePolygonDisplay();
            
            // Odstranit event listenery
            const svg = document.getElementById('katastrSvg');
            if (svg) {
                svg.removeEventListener('click', handlePolygonClick);
                svg.removeEventListener('dblclick', finishPolygonSelect);
                svg.removeEventListener('mousemove', handlePolygonMouseMove);
            }
        }
        
        function handlePolygonClick(e) {
            if (!mapPolygonMode) return;
            e.stopPropagation();
            
            const svg = document.getElementById('katastrSvg');
            const pt = svg.createSVGPoint();
            pt.x = e.clientX;
            pt.y = e.clientY;
            const svgP = pt.matrixTransform(svg.getScreenCTM().inverse());
            
            polygonPoints.push({ x: svgP.x, y: svgP.y });
            updatePolygonDisplay();
        }
        
        function handlePolygonMouseMove(e) {
            if (!mapPolygonMode || polygonPoints.length === 0) return;
            
            // Zobrazit dočasnou čáru k aktuální pozici myši
            // (pro jednoduchost vynecháno)
        }
        
        function finishPolygonSelect(e) {
            if (!mapPolygonMode || polygonPoints.length < 3) return;
            e.preventDefault();
            e.stopPropagation();
            
            // Najít parcely uvnitř polygonu
            selectedByPolygon = [];
            
            mapParcelyData.forEach(p => {
                const center = getPolygonCenter(p.points);
                if (isPointInPolygon(center, polygonPoints)) {
                    selectedByPolygon.push(p);
                }
            });
            
            if (selectedByPolygon.length > 0) {
                showPolygonSelectionPanel();
            } else {
                alert('V označené oblasti nebyly nalezeny žádné parcely.');
                cancelPolygonSelect();
            }
        }
        
        function isPointInPolygon(point, polygon) {
            let inside = false;
            for (let i = 0, j = polygon.length - 1; i < polygon.length; j = i++) {
                const xi = polygon[i].x, yi = polygon[i].y;
                const xj = polygon[j].x, yj = polygon[j].y;
                
                if (((yi > point.y) !== (yj > point.y)) &&
                    (point.x < (xj - xi) * (point.y - yi) / (yj - yi) + xi)) {
                    inside = !inside;
                }
            }
            return inside;
        }
        
        function updatePolygonDisplay() {
            const polygon = document.getElementById('selectionPolygon');
            const pointsGroup = document.getElementById('selectionPoints');
            
            if (!polygon || !pointsGroup) return;
            
            if (polygonPoints.length === 0) {
                polygon.setAttribute('points', '');
                pointsGroup.innerHTML = '';
                return;
            }
            
            // Aktualizovat polygon
            const pointsStr = polygonPoints.map(p => `${p.x},${p.y}`).join(' ');
            polygon.setAttribute('points', pointsStr);
            
            // Aktualizovat body
            let pointsHtml = '';
            polygonPoints.forEach((p, i) => {
                pointsHtml += `<circle class="selection-point" cx="${p.x}" cy="${p.y}" r="5" data-index="${i}"/>`;
            });
            pointsGroup.innerHTML = pointsHtml;
        }
        
        function showPolygonSelectionPanel() {
            // Zavřít banner
            const banner = document.getElementById('polygonBanner');
            if (banner) banner.style.display = 'none';
            
            // Zobrazit panel s výběrem
            let panel = document.getElementById('polygonSelectionPanel');
            
            if (!panel) {
                panel = document.createElement('div');
                panel.id = 'polygonSelectionPanel';
                panel.className = 'katastr-selection-panel';
                document.getElementById('mapViewport').appendChild(panel);
            }
            
            let listHtml = '';
            selectedByPolygon.forEach(p => {
                const icon = p.typ === 'zastavena' || p.cislo.startsWith('st') ? 'crop_square' : 'grass';
                const status = p.isZamer ? '🔵' : (p.isSoused ? '🟢' : '');
                listHtml += `
                    <div class="katastr-selection-item">
                        <span class="material-icons-outlined" style="font-size: 14px;">${icon}</span>
                        <span style="font-weight: 500;">${p.cislo}</span>
                        <span style="color: #5f6368; margin-left: auto;">${p.plocha}</span>
                        <span>${status}</span>
                    </div>
                `;
            });
            
            panel.innerHTML = `
                <div class="katastr-selection-header">
                    <span class="katastr-selection-title">Vybrané parcely</span>
                    <span class="katastr-selection-count">${selectedByPolygon.length} parcel</span>
                    <button class="katastr-info-close" onclick="cancelPolygonSelect()">
                        <span class="material-icons-outlined">close</span>
                    </button>
                </div>
                <div class="katastr-selection-list">
                    ${listHtml}
                </div>
                <div class="katastr-selection-actions">
                    <button class="katastr-info-btn" onclick="addPolygonSelectionAsSoused()">
                        <span class="material-icons-outlined">add</span>
                        Jako sousední
                    </button>
                    <button class="katastr-info-btn primary" onclick="addPolygonSelectionAsZamer()">
                        <span class="material-icons-outlined">add_location</span>
                        Do záměru
                    </button>
                </div>
            `;
            
            panel.classList.add('visible');
        }
        
        function addPolygonSelectionAsZamer() {
            selectedByPolygon.forEach(p => {
                if (!p.isZamer) {
                    const isStavebni = p.cislo.toLowerCase().startsWith('st');
                    pozemkyState.pozemkyZameru.push({
                        cislo: p.cislo,
                        katastr: p.ku,
                        kod: '747076',
                        plocha: p.plocha,
                        typ: isStavebni ? 'zastavena' : 'pozemkova'
                    });
                    p.isZamer = true;
                }
            });
            
            renderPozemkyZameru();
            renderMapParcely();
            updatePozemkyState();
            cancelPolygonSelect();
        }
        
        function addPolygonSelectionAsSoused() {
            selectedByPolygon.forEach(p => {
                if (!p.isSoused) {
                    pozemkyState.sousedniParcely.push({
                        cislo: p.cislo,
                        katastr: p.ku,
                        kod: '747076',
                        plocha: p.plocha
                    });
                    p.isSoused = true;
                }
            });
            
            renderSousedniParcely();
            renderMapParcely();
            updatePozemkyState();
            cancelPolygonSelect();
        }

        function toggleMapLayers() {
            // Placeholder pro budoucí funkcionalitu vrstev
            alert('Výběr vrstev: Parcely, Budovy, Ortofoto, BPEJ...\n\n(Funkce v přípravě)');
        }

        function selectNeighborMethod(method) {
            pozemkyState.method = method;
            
            // Update tlačítek - pouze pro sousední pozemky
            const sousedniSelector = document.getElementById('sousedniMethodSelector');
            sousedniSelector.querySelectorAll('.neighbor-method-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.method === method);
            });
            
            // Zobrazení správného obsahu
            document.getElementById('methodAuto').style.display = method === 'auto' ? 'block' : 'none';
            document.getElementById('methodRucne').style.display = method === 'rucne' ? 'block' : 'none';
            document.getElementById('methodMapa').style.display = method === 'mapa' ? 'block' : 'none';
            
            // Při volbě Z mapy přepnout viewer na záložku Mapa
            if (method === 'mapa') {
                const mapTab = document.querySelector('#controlPozemky .viewer-tab:nth-child(4)');
                if (mapTab) {
                    switchPozemkyTab(mapTab, 'mapa');
                }
            }
        }
        
        function autoDetectSousedni() {
            const btn = document.getElementById('btnAutoDetect');
            btn.disabled = true;
            btn.innerHTML = '<span class="material-icons-outlined">hourglass_empty</span>Identifikuji sousedy...';
            
            setTimeout(function() {
                pozemkyState.sousedniParcely = [
                    { cislo: '139/3', katastr: 'Doudleby n.O.', kod: '631761', plocha: '1 250 m²' },
                    { cislo: '520/12', katastr: 'Doudleby n.O.', kod: '631761', plocha: '680 m²' },
                    { cislo: '1548', katastr: 'Doudleby n.O.', kod: '631761', plocha: '3 420 m²' },
                    { cislo: '3333', katastr: 'Doudleby n.O.', kod: '631761', plocha: '1 870 m²' },
                    { cislo: '1803/2', katastr: 'Vamberk', kod: '776131', plocha: '2 150 m²' }
                ];
                
                renderSousedniParcely();
                btn.disabled = false;
                btn.innerHTML = '<span class="material-icons-outlined">auto_awesome</span>Automaticky identifikovat sousedy';
                updatePozemkyState();
            }, 2000);
        }
        
        function loadSousedKatastralniUzemi() {
            const obecSelect = document.getElementById('sousedObec');
            const kuSelect = document.getElementById('sousedKU');
            const obec = obecSelect.value;
            
            // Reset k.ú. dropdown
            kuSelect.innerHTML = '<option value="">Vyberte k.ú....</option>';
            kuSelect.disabled = true;
            
            if (!obec) return;
            
            // Simulace načtení k.ú. podle obce
            const katastry = {
                'veseli': [
                    { value: 'doudleby-631761', text: 'Doudleby nad Orlicí' },
                    { value: 'horusice-779091', text: 'Horusice' }
                ],
                'tabor': [
                    { value: 'tabor-764621', text: 'Tábor' },
                    { value: 'klokoty-764621', text: 'Klokoty' },
                    { value: 'chotoviny-764621', text: 'Chotoviny' }
                ],
                'soběslav': [
                    { value: 'sobeslav-752177', text: 'Soběslav' },
                    { value: 'chlebov-752177', text: 'Chlebov' }
                ]
            };
            
            if (katastry[obec]) {
                katastry[obec].forEach(ku => {
                    const option = document.createElement('option');
                    option.value = ku.value;
                    option.textContent = ku.text;
                    kuSelect.appendChild(option);
                });
                kuSelect.disabled = false;
            }
        }
        
        function addSousedniRucne() {
            const obecSelect = document.getElementById('sousedObec');
            const kuSelect = document.getElementById('sousedKU');
            const input = document.getElementById('sousedniSearchInput');
            const value = input.value.trim();
            
            if (!value) {
                alert('Zadejte číslo parcely.');
                return;
            }
            
            // Určení katastrálního území
            let katastr = 'Doudleby nad Orlicí';
            let kod = '779091';
            
            if (kuSelect.value) {
                katastr = kuSelect.options[kuSelect.selectedIndex].text;
                kod = kuSelect.value.split('-')[1] || '779091';
            }
            
            pozemkyState.sousedniParcely.push({
                cislo: value,
                katastr: katastr,
                kod: kod,
                plocha: '—'
            });
            
            renderSousedniParcely();
            updatePozemkyState();
            input.value = '';
        }
        
        function openMapForSousedni() {
            // Přepnutí na záložku Mapa ve vieweru
            const mapTab = document.querySelector('#controlPozemky .viewer-tab:nth-child(4)');
            if (mapTab) {
                switchPozemkyTab(mapTab, 'mapa');
            }
            alert('V ostré verzi by se zde otevřela katastrální mapa pro výběr sousedních pozemků kliknutím na parcely.');
        }

        function renderSousedniParcely() {
            const list = document.getElementById('sousedniList');
            const empty = document.getElementById('sousedniEmpty');
            const count = document.getElementById('sousedniCount');
            const viewMode = pozemkyState.viewModeSousedni;
            const sort = pozemkyState.sortSousedni;
            
            if (pozemkyState.sousedniParcely.length === 0) {
                if (empty) empty.style.display = 'block';
                count.textContent = '0 parcel';
                list.innerHTML = '<div class="sousedni-empty" id="sousedniEmpty"><span class="material-icons-outlined">grid_view</span><div class="sousedni-empty-text">Zatím nejsou identifikovány žádné sousední pozemky</div><div class="sousedni-empty-hint">Použijte některou z metod výše</div></div>';
            } else {
                const pocet = pozemkyState.sousedniParcely.length;
                count.textContent = pocet + ' ' + (pocet === 1 ? 'parcela' : pocet < 5 ? 'parcely' : 'parcel');
                
                let html = '';
                
                if (viewMode === 'chips') {
                    // Kompaktní chip zobrazení
                    html = '<div class="pozemky-chips-container">';
                    pozemkyState.sousedniParcely.forEach((p, index) => {
                        const icon = p.cislo.startsWith('st') ? 'crop_square' : 'grass';
                        html += `
                            <div class="pozemek-chip soused" title="k.ú. ${p.katastr} [${p.kod}]${p.plocha !== '—' ? ' • ' + p.plocha : ''}">
                                <span class="material-icons-outlined chip-icon">${icon}</span>
                                <span class="chip-parcela">${p.cislo}</span>
                                <span class="chip-ku">${p.katastr.substring(0, 8)}${p.katastr.length > 8 ? '…' : ''}</span>
                                <button class="chip-remove" onclick="removeSousedni(${index})" title="Odebrat">
                                    <span class="material-icons-outlined">close</span>
                                </button>
                            </div>
                        `;
                    });
                    html += '</div>';
                } else if (viewMode === 'grouped') {
                    // Seskupené zobrazení podle k.ú.
                    html = renderGroupedPozemky(pozemkyState.sousedniParcely, 'sousedni');
                } else {
                    // Řádkové zobrazení s hlavičkou
                    const parcelaSortClass = sort.field === 'cislo' ? (sort.asc ? 'active asc' : 'active') : '';
                    const katastrSortClass = sort.field === 'katastr' ? (sort.asc ? 'active asc' : 'active') : '';
                    
                    html = '<div class="pozemky-list-container">';
                    html += `
                        <div class="pozemky-list-header">
                            <span class="col-icon"></span>
                            <span class="header-col col-parcela ${parcelaSortClass}" onclick="sortPozemky('sousedni', 'cislo')">
                                Parcela
                                <span class="material-icons-outlined sort-icon">arrow_downward</span>
                            </span>
                            <span class="header-col col-katastr ${katastrSortClass}" onclick="sortPozemky('sousedni', 'katastr')">
                                Katastrální území
                                <span class="material-icons-outlined sort-icon">arrow_downward</span>
                            </span>
                            <span class="col-kod">Kód</span>
                            <span class="col-plocha">Plocha</span>
                            <span class="col-actions"></span>
                        </div>
                    `;
                    pozemkyState.sousedniParcely.forEach((p, index) => {
                        const icon = p.cislo.startsWith('st') ? 'crop_square' : 'grass';
                        html += `
                            <div class="pozemek-row soused">
                                <span class="material-icons-outlined row-icon">${icon}</span>
                                <span class="row-parcela">${p.cislo}</span>
                                <span class="row-katastr">${p.katastr}</span>
                                <span class="row-kod">[${p.kod}]</span>
                                <span class="row-plocha">${p.plocha}</span>
                                <button class="row-remove" onclick="removeSousedni(${index})" title="Odebrat">
                                    <span class="material-icons-outlined">close</span>
                                </button>
                            </div>
                        `;
                    });
                    html += '</div>';
                }
                
                list.innerHTML = html;
            }
        }

        function removeSousedni(index) {
            pozemkyState.sousedniParcely.splice(index, 1);
            renderSousedniParcely();
            updatePozemkyState();
        }

        function searchSousedni() {
            const input = document.getElementById('sousedniSearchInput');
            const value = input.value.trim();
            if (!value) return;
            
            pozemkyState.sousedniParcely.push({
                cislo: value,
                katastr: 'Radonice',
                kod: '747076',
                plocha: '—'
            });
            
            renderSousedniParcely();
            input.value = '';
            updatePozemkyState();
        }

        function updatePozemkyState() {
            const btnConfirm = document.getElementById('btnConfirmPozemky');
            const resultBox = document.getElementById('resultPozemky');
            
            const hasPozemkyZameru = pozemkyState.pozemkyZameru.length > 0;
            const hasSousedni = pozemkyState.sousedniParcely.length > 0;
            
            // Tlačítko Potvrdit je aktivní, když jsou definovány pozemky záměru a sousední pozemky
            if (hasPozemkyZameru && hasSousedni) {
                btnConfirm.disabled = false;
                resultBox.className = 'result-preview positive';
                resultBox.innerHTML = `
                    <div class="result-preview-title">
                        <span class="material-icons-outlined">check_circle</span>
                        Pozemky identifikovány
                    </div>
                    <div class="result-preview-text">Pozemky záměru (${pozemkyState.pozemkyZameru.length}) a sousední pozemky (${pozemkyState.sousedniParcely.length}) byly identifikovány. Vlastníci budou určeni v části Osoby.</div>
                `;
            } else {
                btnConfirm.disabled = true;
                let missingText = [];
                if (!hasPozemkyZameru) missingText.push('pozemky záměru');
                if (!hasSousedni) missingText.push('sousední pozemky');
                
                resultBox.className = 'result-preview warning';
                resultBox.innerHTML = `
                    <div class="result-preview-title">
                        <span class="material-icons-outlined">info</span>
                        Čeká na dokončení
                    </div>
                    <div class="result-preview-text">Chybí: ${missingText.join(', ')}.</div>
                `;
            }
        }

        function completePozemky() {
            controls.pozemky.done = true;
            controls.pozemky.result = 'ok';
            controls.pozemky.pozemkyZameru = pozemkyState.pozemkyZameru;
            controls.pozemky.sousedniParcely = pozemkyState.sousedniParcely;
            closeControl('controlPozemky');
            updateUI();
        }

        // ==========================================
        // KONTROLA ŽÁDOSTI (§ 184 SZ)
        // ==========================================
        function toggleDataStatus(button) {
            const row = button.closest('.data-row');
            const isOk = button.classList.contains('ok');
            
            if (isOk) {
                // Přepni na error
                button.classList.remove('ok');
                button.classList.add('error');
                button.innerHTML = '<span class="material-icons-outlined">cancel</span>';
                button.title = 'Označit jako v pořádku';
                row.classList.add('error');
            } else {
                // Přepni zpět na ok
                button.classList.remove('error');
                button.classList.add('ok');
                button.innerHTML = '<span class="material-icons-outlined">check_circle</span>';
                button.title = 'Označit jako vadné';
                row.classList.remove('error');
            }
            
            updateZadostResult();
        }

        function updateZadostResult() {
            const resultBox = document.getElementById('resultZadost');
            const btnConfirm = document.getElementById('btnConfirmZadost');
            const deficiencySection = document.getElementById('zadostDeficiencySection');
            
            // Počet položek označených jako vadné
            const errorButtons = document.querySelectorAll('#controlZadost .data-status.error');
            const errorCount = errorButtons.length;
            
            if (errorCount > 0) {
                // Zobraz sekci pro poznámku
                deficiencySection.style.display = 'block';
                
                resultBox.className = 'result-preview warning';
                resultBox.innerHTML = `
                    <div class="result-preview-title">
                        <span class="material-icons-outlined">warning</span>
                        Zjištěny vady v údajích
                    </div>
                    <div class="result-preview-text">${errorCount} ${errorCount === 1 ? 'položka označena' : (errorCount < 5 ? 'položky označeny' : 'položek označeno')} jako vadné. Bude vydána výzva k odstranění vad (§ 185 odst. 2).</div>
                `;
                btnConfirm.innerHTML = '<span class="material-icons-outlined">mail</span>Potvrdit a vydat výzvu';
            } else {
                // Skryj sekci pro poznámku
                deficiencySection.style.display = 'none';
                
                resultBox.className = 'result-preview positive';
                resultBox.innerHTML = `
                    <div class="result-preview-title">
                        <span class="material-icons-outlined">check_circle</span>
                        Údaje v žádosti jsou v pořádku
                    </div>
                    <div class="result-preview-text">Všechny údaje byly zkontrolovány a jsou smysluplné.</div>
                `;
                btnConfirm.innerHTML = '<span class="material-icons-outlined">check</span>Potvrdit kontrolu';
            }
        }

        // ==========================================
        // ZNOVUPOUŽITELNÉ KOMPONENTY - NÁHLED ŽÁDOSTI
        // ==========================================
        
        // Generuje HTML pro strukturovaná data žádosti (read-only verze)
        function generateZadostDataReadOnly() {
            return `
                <div class="zadost-readonly-content">
                    <!-- 1. Údaje o podání -->
                    <div class="zadost-readonly-section">
                        <div class="zadost-readonly-header">
                            <span class="material-icons-outlined">assignment_ind</span>
                            Údaje o podání
                        </div>
                        <div class="zadost-readonly-grid">
                            <div class="zadost-readonly-item">
                                <div class="zadost-readonly-label">Podatel (kdo činí podání)</div>
                                <div class="zadost-readonly-value">Správa železnic, s.o.</div>
                            </div>
                            <div class="zadost-readonly-item">
                                <div class="zadost-readonly-label">Vztah k žadateli</div>
                                <div class="zadost-readonly-value">
                                    <span class="material-icons-outlined" style="font-size: 16px; color: #34a853; vertical-align: middle;">check_circle</span>
                                    Podatel je sám žadatel
                                </div>
                            </div>
                            <div class="zadost-readonly-item">
                                <div class="zadost-readonly-label">Věc podání</div>
                                <div class="zadost-readonly-value">Žádost o povolení stavby</div>
                            </div>
                            <div class="zadost-readonly-item">
                                <div class="zadost-readonly-label">Správní orgán</div>
                                <div class="zadost-readonly-value">Dopravní a energetický stavební úřad</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 2. Žadatel -->
                    <div class="zadost-readonly-section">
                        <div class="zadost-readonly-header">
                            <span class="material-icons-outlined">person</span>
                            Žadatel — Fyzická osoba
                        </div>
                        <div class="zadost-readonly-grid">
                            <div class="zadost-readonly-item">
                                <div class="zadost-readonly-label">Jméno a příjmení</div>
                                <div class="zadost-readonly-value">Správa železnic, s.o.</div>
                            </div>
                            <div class="zadost-readonly-item">
                                <div class="zadost-readonly-label">Datum narození</div>
                                <div class="zadost-readonly-value">15. 3. 1985</div>
                            </div>
                            <div class="zadost-readonly-item">
                                <div class="zadost-readonly-label">Místo trvalého pobytu</div>
                                <div class="zadost-readonly-value">Dlážděná 1003/7, 110 00 Praha 1</div>
                            </div>
                            <div class="zadost-readonly-item">
                                <div class="zadost-readonly-label">Datová schránka</div>
                                <div class="zadost-readonly-value">uccchjm</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 3. Identifikace záměru -->
                    <div class="zadost-readonly-section">
                        <div class="zadost-readonly-header">
                            <span class="material-icons-outlined">domain</span>
                            Identifikace záměru
                        </div>
                        <div class="zadost-readonly-grid">
                            <div class="zadost-readonly-item full-width">
                                <div class="zadost-readonly-label">Název záměru</div>
                                <div class="zadost-readonly-value">Oprava ZZ v žst. Doudleby n. Orlicí</div>
                            </div>
                            <div class="zadost-readonly-item">
                                <div class="zadost-readonly-label">Druh stavby</div>
                                <div class="zadost-readonly-value">Stavba dráhy</div>
                            </div>
                            <div class="zadost-readonly-item">
                                <div class="zadost-readonly-label">Účel stavby</div>
                                <div class="zadost-readonly-value">Stavba dráhy — zabezpečovací zařízení</div>
                            </div>
                            <div class="zadost-readonly-item full-width">
                                <div class="zadost-readonly-label">Místo stavby</div>
                                <div class="zadost-readonly-value">Doudleby n.O., Vamberk, Záměl, Kostelec n.O.</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 4. Pozemky -->
                    <div class="zadost-readonly-section">
                        <div class="zadost-readonly-header">
                            <span class="material-icons-outlined">grid_on</span>
                            Pozemky záměru
                        </div>
                        <div class="zadost-readonly-table">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Parcela</th>
                                        <th>Katastrální území</th>
                                        <th>Výměra</th>
                                        <th>Druh pozemku</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td><strong>st. 321</strong></td>
                                        <td>Doudleby n.O. [631761]</td>
                                        <td>—</td>
                                        <td>Zastavěná plocha</td>
                                    </tr>
                                    <tr>
                                        <td><strong>1549</strong></td>
                                        <td>Doudleby n.O. [631761]</td>
                                        <td>—</td>
                                        <td>Ostatní plocha — dráha</td>
                                    </tr>
                                    <tr>
                                        <td colspan="4" style="text-align: center; color: #5f6368; font-style: italic;">… a dalších 36 pozemků ve 4 k.ú.</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- 5. Charakteristika záměru -->
                    <div class="zadost-readonly-section">
                        <div class="zadost-readonly-header">
                            <span class="material-icons-outlined">architecture</span>
                            Charakteristika záměru
                        </div>
                        <div class="zadost-readonly-grid">
                            <div class="zadost-readonly-item">
                                <div class="zadost-readonly-label">Zastavěná plocha</div>
                                <div class="zadost-readonly-value">—</div>
                            </div>
                            <div class="zadost-readonly-item">
                                <div class="zadost-readonly-label">Obestavěný prostor</div>
                                <div class="zadost-readonly-value">—</div>
                            </div>
                            <div class="zadost-readonly-item">
                                <div class="zadost-readonly-label">Počet podlaží</div>
                                <div class="zadost-readonly-value">—</div>
                            </div>
                            <div class="zadost-readonly-item">
                                <div class="zadost-readonly-label">Počet bytů</div>
                                <div class="zadost-readonly-value">—</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // Generuje HTML pro formulář žádosti (PDF simulace)
        function generateFormularPreview() {
            return `
                <div class="formular-preview">
                    <div class="formular-header">
                        <div class="formular-logo">
                            <span class="material-icons-outlined">account_balance</span>
                        </div>
                        <div class="formular-title-block">
                            <div class="formular-title">ŽÁDOST O POVOLENÍ STAVBY</div>
                            <div class="formular-subtitle">podle § 184 zákona č. 283/2021 Sb., stavební zákon</div>
                        </div>
                        <div class="formular-cislo">
                            <div class="formular-cislo-label">Číslo jednací</div>
                            <div class="formular-cislo-value">DESU/122/001574/26</div>
                        </div>
                    </div>
                    
                    <div class="formular-section">
                        <div class="formular-section-title">ČÁST A – IDENTIFIKAČNÍ ÚDAJE</div>
                        
                        <div class="formular-subsection">
                            <div class="formular-subsection-title">A.1 Údaje o žadateli</div>
                            <div class="formular-fields">
                                <div class="formular-field">
                                    <div class="formular-field-label">Jméno a příjmení / Název</div>
                                    <div class="formular-field-value">Správa železnic, s.o.</div>
                                </div>
                                <div class="formular-field">
                                    <div class="formular-field-label">Datum narození / IČO</div>
                                    <div class="formular-field-value">70994234</div>
                                </div>
                                <div class="formular-field">
                                    <div class="formular-field-label">Adresa místa trvalého pobytu / Sídlo</div>
                                    <div class="formular-field-value">Dlážděná 1003/7, 110 00 Praha 1</div>
                                </div>
                                <div class="formular-field">
                                    <div class="formular-field-label">ID datové schránky</div>
                                    <div class="formular-field-value">uccchjm</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="formular-subsection">
                            <div class="formular-subsection-title">A.2 Údaje o záměru</div>
                            <div class="formular-fields">
                                <div class="formular-field full-width">
                                    <div class="formular-field-label">Název záměru</div>
                                    <div class="formular-field-value">Oprava ZZ v žst. Doudleby n. Orlicí</div>
                                </div>
                                <div class="formular-field">
                                    <div class="formular-field-label">Místo stavby</div>
                                    <div class="formular-field-value">Doudleby n.O., Vamberk, Záměl, Kostelec n.O.</div>
                                </div>
                                <div class="formular-field">
                                    <div class="formular-field-label">Parcelní čísla</div>
                                    <div class="formular-field-value">st. 321, st. 916, 1549, 1550/1… (38 parcel)</div>
                                </div>
                                <div class="formular-field">
                                    <div class="formular-field-label">Katastrální území</div>
                                    <div class="formular-field-value">Doudleby n.O. [631761]</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="formular-section">
                        <div class="formular-section-title">ČÁST B – CHARAKTERISTIKA ZÁMĚRU</div>
                        <div class="formular-fields">
                            <div class="formular-field">
                                <div class="formular-field-label">Druh stavby</div>
                                <div class="formular-field-value">Stavba dráhy</div>
                            </div>
                            <div class="formular-field">
                                <div class="formular-field-label">Účel stavby</div>
                                <div class="formular-field-value">Stavba dráhy — zabezpečovací zařízení</div>
                            </div>
                            <div class="formular-field">
                                <div class="formular-field-label">Zastavěná plocha</div>
                                <div class="formular-field-value">—</div>
                            </div>
                            <div class="formular-field">
                                <div class="formular-field-label">Obestavěný prostor</div>
                                <div class="formular-field-value">—</div>
                            </div>
                            <div class="formular-field">
                                <div class="formular-field-label">Počet podlaží</div>
                                <div class="formular-field-value">—</div>
                            </div>
                            <div class="formular-field">
                                <div class="formular-field-label">Počet bytů</div>
                                <div class="formular-field-value">—</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="formular-footer">
                        <div class="formular-page-info">Strana 1 z 3</div>
                        <div class="formular-note">Náhled formuláře dle vyhlášky č. 149/2024 Sb.</div>
                    </div>
                </div>
            `;
        }
        
        // Inicializuje viewer v kontrole podle typu podání
        function initControlViewer(controlId) {
            const isVlozena = typPodaniZadosti === 'vlozena';
            
            if (controlId === 'controlPrislusnost') {
                // Záložky
                const tabsPortal = document.querySelectorAll('.prislusnost-tab-portal');
                const tabsVlozena = document.querySelectorAll('.prislusnost-tab-vlozena');
                
                tabsPortal.forEach(tab => tab.style.display = isVlozena ? 'none' : '');
                tabsVlozena.forEach(tab => tab.style.display = isVlozena ? '' : 'none');
                
                // Obsah
                const inner = document.getElementById('prislusnostViewerInner');
                
                if (isVlozena) {
                    // Vložená žádost - zobrazit formulář
                    if (inner) {
                        inner.className = 'reusable-formular-preview';
                        inner.style.height = '';
                        inner.innerHTML = generateFormularPreview();
                        _prislusnostCache.formular = inner.innerHTML;
                    }
                    document.getElementById('prislusnostViewerContent')?.classList.remove('ev-active');
                    // Aktivovat správnou záložku
                    document.querySelectorAll('#prislusnostViewerTabs .viewer-tab').forEach(t => t.classList.remove('active'));
                    document.querySelector('.prislusnost-tab-vlozena')?.classList.add('active');
                    _prislusnostCurrentTab = 'formular';
                } else {
                    // Portál stavebníka - zobrazit strukturovaná data
                    if (inner) {
                        inner.className = 'reusable-zadost-data active';
                        inner.style.height = '';
                        inner.innerHTML = generateZadostDataReadOnly();
                        _prislusnostCache.zadost = inner.innerHTML;
                    }
                    document.getElementById('prislusnostViewerContent')?.classList.remove('ev-active');
                    // Aktivovat správnou záložku
                    document.querySelectorAll('#prislusnostViewerTabs .viewer-tab').forEach(t => t.classList.remove('active'));
                    document.querySelector('.prislusnost-tab-portal')?.classList.add('active');
                    _prislusnostCurrentTab = 'zadost';
                }
            }
        }
        
        // Přepínání záložek v kontrole Příslušnost
        // Cache pro obsah záložek příslušnosti (aby se nemusel pokaždé znovu generovat)
        const _prislusnostCache = {};
        let _prislusnostCurrentTab = 'zadost';
        
        function switchPrislusnostViewerTab(btn, tabName) {
            // Deaktivovat všechny záložky
            document.querySelectorAll('#prislusnostViewerTabs .viewer-tab').forEach(t => t.classList.remove('active'));
            btn.classList.add('active');
            _prislusnostCurrentTab = tabName;
            
            var vc = document.getElementById('prislusnostViewerContent');
            var inner = document.getElementById('prislusnostViewerInner');
            
            // Embedded viewer záložky
            if (tabName === 'prilohy' || tabName === 'dokumentace' || tabName === 'doklady') {
                vc.classList.add('ev-active');
                inner.style.height = '100%';
                inner.innerHTML = '';
                var evType = tabName === 'dokumentace' ? 'dokumentace' : tabName;
                renderEmbeddedViewer('prislusnostViewerInner', evType, 'pris_' + tabName);
                return;
            }
            
            // Žádost / Formulář záložky
            vc.classList.remove('ev-active');
            inner.style.height = '';
            inner.className = '';
            
            if (tabName === 'zadost') {
                if (!_prislusnostCache.zadost) {
                    _prislusnostCache.zadost = generateZadostDataReadOnly();
                }
                inner.className = 'reusable-zadost-data active';
                inner.innerHTML = _prislusnostCache.zadost;
            } else if (tabName === 'formular') {
                if (!_prislusnostCache.formular) {
                    _prislusnostCache.formular = generateFormularPreview();
                }
                inner.className = 'reusable-formular-preview';
                inner.innerHTML = _prislusnostCache.formular;
            }
        }

        // ==========================================
        // PLATNOST PRÁVNÍ ÚPRAVY
        // ==========================================
        
        // Platnost: 'do2027' = Do 31.12.2027, 'od2028' = Od 1.1.2028
        let platnostPravniUpravy = 'do2027';
        
        // Aplikovat platnost
        function applyPlatnost(platnost) {
            platnostPravniUpravy = platnost;
            
            // Aktualizovat URL
            const url = new URL(window.location);
            url.searchParams.set('platnost', platnost);
            history.replaceState({}, '', url);
            
            // Aktualizovat zobrazení v simInfo
            updateSimInfoPlatnost();
            
            // Aplikovat změny v UI podle platnosti
            applyPlatnostChanges();
            
            console.log('Platnost právní úpravy změněna na:', platnost);
        }
        
        // Aplikovat změny v UI podle platnosti právní úpravy
        function applyPlatnostChanges() {
            const isOd2028 = platnostPravniUpravy === 'od2028';
            
            // === 1. KONTROLA PŘÍSLUŠNOSTI ===
            
            // Karta příslušnosti - upravit popis
            const cardPrislusnostDesc = document.querySelector('#card-prislusnost .control-card-desc');
            if (cardPrislusnostDesc) {
                if (isOd2028) {
                    cardPrislusnostDesc.textContent = 'Potvrzení přijetí k vyřízení (jednotná stavební správa)';
                } else {
                    cardPrislusnostDesc.textContent = 'Ověření věcné a místní příslušnosti stavebního úřadu';
                }
            }
            
            // Možnost "Nepříslušný" - skrýt/zobrazit
            const optionNeprislusny = document.getElementById('optionNeprislusny');
            if (optionNeprislusny) {
                optionNeprislusny.style.display = isOd2028 ? 'none' : '';
            }
            
            // Popis možnosti "Příslušný" - upravit
            const optionPrislusnyDesc = document.getElementById('optionPrislusnyDesc');
            if (optionPrislusnyDesc) {
                if (isOd2028) {
                    optionPrislusnyDesc.textContent = 'Žádost je přijata k vyřízení v rámci jednotné státní stavební správy';
                } else {
                    optionPrislusnyDesc.textContent = 'Stavební úřad je věcně i místně příslušný k projednání žádosti';
                }
            }
            
            // Info box o jednotné stavební správě
            const infoJednotnaSprava = document.getElementById('infoJednotnaSprava');
            if (infoJednotnaSprava) {
                infoJednotnaSprava.style.display = isOd2028 ? 'flex' : 'none';
            }
            
            // Sekce výběru SÚ pro postoupení - skrýt při od2028
            const vyberSuSection = document.getElementById('vyberSuSection');
            if (vyberSuSection && isOd2028) {
                vyberSuSection.style.display = 'none';
            }
            
            // Sekce zdůvodnění nepříslušnosti - skrýt při od2028
            const zduvodneniSection = document.getElementById('zduvodneniNeprislusnostiSection');
            if (zduvodneniSection && isOd2028) {
                zduvodneniSection.style.display = 'none';
            }
            
            // === 2. IDENTIFIKACE DO - DOKLADOVÁ ČÁST ===
            
            // Info box o integrovaných DO
            const infoIntegrovaneDO = document.getElementById('infoIntegrovaneDO');
            if (infoIntegrovaneDO) {
                infoIntegrovaneDO.style.display = isOd2028 ? 'flex' : 'none';
            }
            
            // === 3. KARTA DOKLADOVÁ ČÁST ===
            
            // Popis karty dokladové části (ID je card-identifikace)
            const cardDokladyDesc = document.querySelector('#card-identifikace .control-card-desc');
            if (cardDokladyDesc) {
                if (isOd2028) {
                    cardDokladyDesc.textContent = 'Integrovaná stanoviska JSSÚ a vyjádření správců sítí';
                } else {
                    cardDokladyDesc.textContent = 'Stanoviska DO a vyjádření vlastníků sítí';
                }
            }
            
            // === 4. ZÁLOŽKA DOTČENÉ ORGÁNY V KONTROLE OSOBY ===
            
            // Info box v záložce Dotčené orgány
            const infoIntegrovaneDOOsoby = document.getElementById('infoIntegrovaneDOOsoby');
            if (infoIntegrovaneDOOsoby) {
                infoIntegrovaneDOOsoby.style.display = isOd2028 ? 'flex' : 'none';
            }
            
            // Toolbar a tabulka dotčených orgánů - skrýt při od2028
            const toolbarDotceneOrgany = document.getElementById('toolbarDotceneOrgany');
            const tableDotceneOrgany = document.getElementById('tableDotceneOrgany');
            if (toolbarDotceneOrgany) {
                toolbarDotceneOrgany.style.display = isOd2028 ? 'none' : '';
            }
            if (tableDotceneOrgany) {
                tableDotceneOrgany.style.display = isOd2028 ? 'none' : '';
            }
            
            // Pokud je volba "nepříslušný" aktivní a přepneme na od2028, resetovat na příslušný
            if (isOd2028) {
                const prislusnyRadio = document.querySelector('input[name="prislusnost"][value="prislusny"]');
                if (prislusnyRadio && !prislusnyRadio.checked) {
                    prislusnyRadio.checked = true;
                    const optionPrislusny = document.getElementById('optionPrislusny');
                    if (optionPrislusny) {
                        document.querySelectorAll('.control-option').forEach(o => o.classList.remove('selected'));
                        optionPrislusny.classList.add('selected');
                    }
                }
            }
        }
        
        // Aktualizovat zobrazení simInfo pro platnost
        function updateSimInfoPlatnost() {
            const simInfoPlatnost = document.getElementById('simInfoPlatnost');
            if (simInfoPlatnost) {
                simInfoPlatnost.textContent = platnostPravniUpravy === 'do2027' ? 'Do 31. 12. 2027' : 'Od 1. 1. 2028';
            }
        }
        
        // ==========================================
        // TYP PODÁNÍ ŽÁDOSTI
        // ==========================================
        
        // Typ podání: 'portal' = Portál stavebníka, 'vlozena' = Vložená žádost
        let typPodaniZadosti = 'portal';
        
        // Aplikovat typ podání
        function applyTypPodani(typ) {
            typPodaniZadosti = typ;
            
            // Aktualizovat URL
            const url = new URL(window.location);
            url.searchParams.set('typPodani', typ);
            history.replaceState({}, '', url);
            
            // Aktualizovat zobrazení v simInfo
            updateSimInfo();
            
            console.log('Typ podání změněn na:', typ);
        }
        
        // Rychlost řízení
        let rychlostRizeni = 'zrychlene';
        
        function applyRychlostRizeni(typ, showToast = true) {
            rychlostRizeni = typ;
            
            // Aktualizovat URL
            const url = new URL(window.location);
            url.searchParams.set('rychlost', typ);
            history.replaceState({}, '', url);
            
            // Zobrazit/skrýt kartu Zrychlené řízení
            const cardZrychlene = document.getElementById('card-zrychlene');
            if (cardZrychlene) {
                if (typ === 'standardni') {
                    cardZrychlene.style.display = 'none';
                } else {
                    cardZrychlene.style.display = '';
                    updateZrychleneRizeniState();
                }
            }
            
            // Zobrazit/skrýt badge Zrychlené řízení v hlavičce
            const badgeZrychlene = document.getElementById('badgeZrychlene');
            if (badgeZrychlene) {
                badgeZrychlene.style.display = typ === 'standardni' ? 'none' : 'inline-flex';
            }
            
            // Aktualizovat zobrazení v simInfo
            updateSimInfo();
            
            if (showToast) {
                showSimToast(typ === 'zrychlene' ? 'Zrychlené řízení' : 'Standardní řízení');
            }
        }
        
        // Aktualizace stavu kontroly Zrychlené řízení
        function updateZrychleneRizeniState() {
            if (rychlostRizeni !== 'zrychlene') return;
            
            const cardZrychlene = document.getElementById('card-zrychlene');
            if (!cardZrychlene) return;
            
            // Kontrola, zda některá kontrola má nedostatky vedoucí k postoupení, přerušení nebo ukončení
            const hasBlockingIssue = checkForBlockingIssues();
            
            if (hasBlockingIssue) {
                // Deaktivovat kontrolu - nelze provést zrychlené řízení
                cardZrychlene.classList.remove('status-waiting', 'status-ready', 'status-done', 'status-warning');
                cardZrychlene.classList.add('disabled', 'status-blocked');
                
                // Aktualizovat popisek a badge
                const descEl = cardZrychlene.querySelector('.control-card-desc');
                if (descEl) {
                    descEl.textContent = 'Nelze provést — zjištěny blokující nedostatky';
                }
                
                const statusBadge = cardZrychlene.querySelector('.control-card-status');
                if (statusBadge) {
                    statusBadge.textContent = 'Blokováno';
                }
                
                const actionBtn = cardZrychlene.querySelector('.control-card-action');
                if (actionBtn) {
                    actionBtn.innerHTML = '<span class="material-icons-outlined">block</span>Nelze provést';
                    actionBtn.onclick = null;
                }
            } else {
                // Odebrat status blocked
                cardZrychlene.classList.remove('status-blocked');
                
                // Obnovit původní popisek
                const descEl = cardZrychlene.querySelector('.control-card-desc');
                if (descEl && !controls.zrychlene.done) {
                    descEl.textContent = 'Splnění podmínek pro zrychlené řízení';
                }
            }
        }
        
        // Kontrola blokujících problémů (postoupení, přerušení, ukončení)
        function checkForBlockingIssues() {
            // Kontrola výsledků kontrol - postoupení, odložení, zastavení
            const blockingResults = ['postoupeno', 'preruseno', 'zastaveno', 'ukonceno', 'error', 'odlozeno'];
            
            for (const controlId in controls) {
                const control = controls[controlId];
                if (control.done && blockingResults.includes(control.result)) {
                    return true;
                }
            }
            
            // Kontrola SÚ nepříslušný
            if (controls.prislusnost && controls.prislusnost.done && controls.prislusnost.result !== 'ok') {
                return true;
            }
            
            return false;
        }
        
        // Aktualizovat zobrazení simInfo
        function updateSimInfo() {
            const simInfoPodani = document.getElementById('simInfoPodani');
            if (simInfoPodani) {
                simInfoPodani.textContent = typPodaniZadosti === 'portal' ? 'Portál stavebníka' : 'Vložená žádost';
            }
            
            const simInfoRychlost = document.getElementById('simInfoRychlost');
            if (simInfoRychlost) {
                simInfoRychlost.textContent = rychlostRizeni === 'zrychlene' ? 'Zrychlené řízení' : 'Standardní řízení';
            }
        }
        
        // Inicializace režimu kontroly žádosti podle typu podání
        function initZadostControlMode() {
            const tabZadost = document.getElementById('tabZadost');
            const tabFormular = document.getElementById('tabFormular');
            const tabPrilohy = document.getElementById('tabPrilohy');
            const btnVseOk = document.getElementById('btnVseOkZadost');
            
            // Resetovat aktivní stav všech záložek a panelů
            document.querySelectorAll('.zadost-data-viewer .viewer-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.zadost-data-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.zadost-panel-mode').forEach(m => m.classList.remove('active'));
            
            if (typPodaniZadosti === 'portal') {
                // Portál stavebníka - zobrazit pouze záložku Žádost
                if (tabZadost) {
                    tabZadost.style.display = '';
                    tabZadost.classList.add('active');
                }
                if (tabFormular) tabFormular.style.display = 'none';
                if (tabPrilohy) tabPrilohy.style.display = 'none';
                if (btnVseOk) btnVseOk.style.display = '';
                
                // Aktivovat panel Žádost
                document.getElementById('zadostDataZadost').classList.add('active');
                document.getElementById('panelModeZadost').classList.add('active');
            } else {
                // Vložená žádost - zobrazit záložky Formulář žádosti a Přílohy
                if (tabZadost) tabZadost.style.display = 'none';
                if (tabFormular) {
                    tabFormular.style.display = '';
                    tabFormular.classList.add('active');
                }
                if (tabPrilohy) tabPrilohy.style.display = '';
                if (btnVseOk) btnVseOk.style.display = 'none';
                
                // Aktivovat panel Formulář
                document.getElementById('zadostDataFormular').classList.add('active');
                document.getElementById('panelModeFormular').classList.add('active');
            }
        }

        // ==========================================
        // KONTROLA ŽÁDOSTI - NOVÝ DESIGN
        // ==========================================
        
        // Sledování aktuálního režimu (zadost/formular)
        let currentZadostMode = 'zadost';
        
        // Přepínání záložek v levém okně (strukturovaná data)
        function switchZadostDataTab(btn, tabName) {
            // Deaktivovat všechny záložky
            document.querySelectorAll('.zadost-data-viewer .viewer-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.zadost-data-tab').forEach(t => t.classList.remove('active'));
            
            // Aktivovat vybranou
            btn.classList.add('active');
            let tabId;
            if (tabName === 'zadost') tabId = 'zadostDataZadost';
            else if (tabName === 'formular') tabId = 'zadostDataFormular';
            else if (tabName === 'prilohy') tabId = 'zadostDataPrilohy';
            else if (tabName === 'doklady') tabId = 'zadostDataDoklady';
            else tabId = 'zadostDataZadost'; // fallback
            
            // Embedded viewers – lazy init BEFORE making visible
            var tabEl = document.getElementById(tabId);
            if (tabName === 'prilohy' && !tabEl.innerHTML.trim()) {
                renderEmbeddedViewer('zadostDataPrilohy', 'prilohy', 'zadPril');
            }
            if (tabName === 'doklady' && !tabEl.innerHTML.trim()) {
                renderEmbeddedViewer('zadostDataDoklady', 'doklady', 'zadDokl');
            }
            
            // Aktivovat záložku (CSS .active řídí zobrazení)
            tabEl.classList.add('active');
            
            // Toggle ev-active on parent viewer-content
            var zadVc = tabEl.closest('.viewer-content');
            if (zadVc) {
                if (tabEl.classList.contains('ev-container')) {
                    zadVc.classList.add('ev-active');
                } else {
                    zadVc.classList.remove('ev-active');
                }
            }
            
            // Přepnout pravý panel podle režimu
            document.querySelectorAll('.zadost-panel-mode').forEach(m => m.classList.remove('active'));
            
            const tabPrilohy = document.getElementById('tabPrilohy');
            const btnVseOk = document.getElementById('btnVseOkZadost');
            
            if (tabName === 'formular' || tabName === 'prilohy') {
                document.getElementById('panelModeFormular').classList.add('active');
                // Skrýt tlačítko "Vše v pořádku" v režimu formuláře
                if (btnVseOk) btnVseOk.style.display = 'none';
                // Zobrazit záložku Přílohy
                if (tabPrilohy) {
                    tabPrilohy.style.display = '';
                    tabPrilohy.classList.remove('tab-disabled');
                }
                currentZadostMode = 'formular';
            } else if (tabName === 'doklady') {
                // Záložka Doklady - ponechat aktuální režim panelu
                const currentPanel = currentZadostMode === 'formular' ? 'panelModeFormular' : 'panelModeZadost';
                document.getElementById(currentPanel).classList.add('active');
            } else {
                document.getElementById('panelModeZadost').classList.add('active');
                // Zobrazit tlačítko "Vše v pořádku" v režimu žádosti
                if (btnVseOk) btnVseOk.style.display = '';
                // Skrýt záložku Přílohy
                if (tabPrilohy) {
                    tabPrilohy.style.display = 'none';
                }
                currentZadostMode = 'zadost';
            }
        }
        
        /**
         * Z inline seznamu příloh přepne na záložku a vybere konkrétní soubor v embedded vieweru.
         * @param {string} tabName - 'prilohy' nebo 'doklady'
         * @param {string} [asciiFile] - název ASCII souboru, pokud chceme předvybrat
         */
        function showInlineFile(tabName, asciiFile) {
            // Najít a kliknout na správný tab button
            const tabBtn = document.getElementById(tabName === 'prilohy' ? 'tabPrilohy' : 'tabDoklady');
            if (tabBtn) {
                // Zobrazit tab Přílohy pokud je skrytý
                if (tabBtn.style.display === 'none') tabBtn.style.display = '';
                switchZadostDataTab(tabBtn, tabName);
            }
            // Předvybrat soubor po krátké prodlevě (čeká na renderEmbeddedViewer)
            if (asciiFile) {
                setTimeout(function() {
                    const tabEl = document.getElementById(tabName === 'prilohy' ? 'zadostDataPrilohy' : 'zadostDataDoklady');
                    if (!tabEl) return;
                    var items = tabEl.querySelectorAll('[data-file]');
                    for (var i = 0; i < items.length; i++) {
                        if (items[i].getAttribute('data-file') === asciiFile) {
                            items[i].click();
                            break;
                        }
                    }
                }, 50);
            }
        }
        
        // Stav kontroly sekcí žádosti
        const zadostSectionState = {
            podani: null,
            zadatel: null,
            zastupce: null,
            zamer: null,
            charakteristika: null,
            podrobnosti: null,
            pozemky: null,
            prilohy: null,
            vyjimky: null
        };
        
        const sectionNames = {
            podani: 'Údaje o podání',
            zadatel: 'Žadatel',
            zastupce: 'Zástupce',
            zamer: 'Identifikace záměru',
            charakteristika: 'Charakteristika záměru',
            podrobnosti: 'Podrobnější informace',
            pozemky: 'Pozemky záměru',
            prilohy: 'Přílohy žádosti',
            vyjimky: 'Výjimky z požadavků'
        };
        
        // Sledování, zda je sekce Zástupce relevantní pro aktuální scénář
        let zastupceRelevant = false;
        
        // Nastavení stavu sekce
        function setSectionStatus(sectionId, status) {
            const section = document.querySelector(`[data-section-id="${sectionId}"]`);
            if (!section) return;
            
            const statusDiv = document.getElementById('sectionStatus' + sectionId.charAt(0).toUpperCase() + sectionId.slice(1));
            const badge = document.getElementById('statusBadge' + sectionId.charAt(0).toUpperCase() + sectionId.slice(1));
            const btnOk = section.querySelector('.btn-ok');
            const btnVada = section.querySelector('.btn-vada');
            
            if (!statusDiv || !badge) return;
            
            // Reset
            section.classList.remove('status-ok', 'status-vada');
            if (btnOk) btnOk.classList.remove('active');
            if (btnVada) btnVada.classList.remove('active');
            badge.className = 'section-status-badge';
            badge.textContent = '';
            
            // Nastavit nový stav
            if (status === 'ok') {
                zadostSectionState[sectionId] = 'ok';
                section.classList.add('status-ok');
                if (btnOk) btnOk.classList.add('active');
                statusDiv.innerHTML = '<span class="material-icons-outlined">check_circle</span> V pořádku';
                statusDiv.className = 'zadost-section-status status-ok';
                badge.classList.add('ok');
                badge.textContent = '✓';
                
                // Propojení: Pokud potvrdím Podání u REZA/statutár, automaticky potvrdit i Zástupce
                if (sectionId === 'podani' && !zastupceRelevant) {
                    // Sekce Zástupce není relevantní, automaticky nastavit na OK
                    const zastSection = document.querySelector('[data-section-id="zastupce"]');
                    if (zastSection && zadostSectionState.zastupce !== 'ok') {
                        setSectionStatus('zastupce', 'ok');
                    }
                }
            } else if (status === 'vada') {
                zadostSectionState[sectionId] = 'vada';
                section.classList.add('status-vada');
                if (btnVada) btnVada.classList.add('active');
                statusDiv.innerHTML = '<span class="material-icons-outlined">error</span> Označeno jako vada';
                statusDiv.className = 'zadost-section-status status-vada';
                badge.classList.add('vada');
                badge.textContent = '!';
                
                // Otevřít panel pro editaci vady
                showDeficiencyEditor(sectionId);
            } else if (status === 'auto-ok') {
                // Automaticky nastaveno na OK (bez možnosti změny)
                zadostSectionState[sectionId] = 'ok';
                section.classList.add('status-ok');
                statusDiv.innerHTML = '<span class="material-icons-outlined">check_circle</span> Automaticky ověřeno';
                statusDiv.className = 'zadost-section-status status-ok';
                badge.classList.add('ok');
                badge.textContent = '✓';
            } else {
                zadostSectionState[sectionId] = null;
                statusDiv.innerHTML = '<span class="material-icons-outlined">radio_button_unchecked</span> Nezkontrolováno';
                statusDiv.className = 'zadost-section-status';
            }
            
            updateDeficiencyPanel();
        }
        
        // Nastavit sekci jako automaticky ověřenou (skrýt tlačítka)
        function setSectionAutoOk(sectionId, reason) {
            const section = document.querySelector(`[data-section-id="${sectionId}"]`);
            if (!section) return;
            
            zadostSectionState[sectionId] = 'ok';
            section.classList.add('status-ok');
            
            const statusDiv = document.getElementById('sectionStatus' + sectionId.charAt(0).toUpperCase() + sectionId.slice(1));
            const badge = document.getElementById('statusBadge' + sectionId.charAt(0).toUpperCase() + sectionId.slice(1));
            const actionsDiv = section.querySelector('.zadost-section-actions');
            
            if (statusDiv) {
                statusDiv.innerHTML = `<span class="material-icons-outlined">check_circle</span> ${reason}`;
                statusDiv.className = 'zadost-section-status status-ok';
            }
            if (badge) {
                badge.className = 'section-status-badge ok';
                badge.textContent = '✓';
            }
            if (actionsDiv) {
                actionsDiv.style.display = 'none';
            }
        }
        
        // Resetovat sekci na standardní stav s tlačítky
        function resetSectionControls(sectionId) {
            const section = document.querySelector(`[data-section-id="${sectionId}"]`);
            if (!section) return;
            
            const actionsDiv = section.querySelector('.zadost-section-actions');
            if (actionsDiv) {
                actionsDiv.style.display = 'flex';
            }
            
            zadostSectionState[sectionId] = null;
            section.classList.remove('status-ok', 'status-vada');
            
            const statusDiv = document.getElementById('sectionStatus' + sectionId.charAt(0).toUpperCase() + sectionId.slice(1));
            const badge = document.getElementById('statusBadge' + sectionId.charAt(0).toUpperCase() + sectionId.slice(1));
            
            if (statusDiv) {
                statusDiv.innerHTML = '<span class="material-icons-outlined">radio_button_unchecked</span> Nezkontrolováno';
                statusDiv.className = 'zadost-section-status';
            }
            if (badge) {
                badge.className = 'section-status-badge';
                badge.textContent = '';
            }
        }
        
        // Nastavit všechny sekce na OK najednou
        function setAllSectionsOk() {
            const allSections = ['podani', 'zadatel', 'zastupce', 'zamer', 'charakteristika', 'podrobnosti', 'pozemky', 'prilohy', 'vyjimky'];
            
            allSections.forEach(sectionId => {
                const section = document.querySelector(`[data-section-id="${sectionId}"]`);
                // Přeskočit skryté sekce
                if (!section || section.style.display === 'none') return;
                // Přeskočit již nastavené sekce
                if (zadostSectionState[sectionId] === 'ok') return;
                
                // Nastavit na OK
                setSectionStatus(sectionId, 'ok');
            });
            
            // Vizuální potvrzení
            const btn = document.querySelector('.btn-vse-ok');
            if (btn) {
                const originalText = btn.innerHTML;
                btn.innerHTML = '<span class="material-icons-outlined">check</span> Hotovo!';
                btn.style.background = '#137333';
                btn.style.color = '#fff';
                btn.style.borderColor = '#137333';
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.style.background = '';
                    btn.style.color = '';
                    btn.style.borderColor = '';
                }, 1500);
            }
        }
        
        // Zobrazit editor nedostatku
        function showDeficiencyEditor(sectionId) {
            // Přepnout na deficiency list
            document.getElementById('deficiencyEmpty').style.display = 'none';
            document.getElementById('deficiencyList').style.display = 'block';
        }
        
        // Aktualizovat panel nedostatků
        function updateDeficiencyPanel() {
            let okCount = 0;
            let vadaCount = 0;
            let pendingCount = 0;
            
            const deficiencies = [];
            
            for (const [key, value] of Object.entries(zadostSectionState)) {
                // Přeskočit sekce které nejsou viditelné
                const section = document.querySelector(`[data-section-id="${key}"]`);
                if (!section || section.style.display === 'none') continue;
                
                if (value === 'ok') okCount++;
                else if (value === 'vada') {
                    vadaCount++;
                    deficiencies.push(key);
                }
                else pendingCount++;
            }
            
            // Aktualizovat statistiky
            document.getElementById('statOkCount').textContent = okCount;
            document.getElementById('statVadaCount').textContent = vadaCount;
            document.getElementById('statPendingCount').textContent = pendingCount;
            
            // Aktualizovat seznam nedostatků
            const listEl = document.getElementById('deficiencyList');
            const emptyEl = document.getElementById('deficiencyEmpty');
            
            if (deficiencies.length === 0) {
                listEl.style.display = 'none';
                emptyEl.style.display = 'block';
            } else {
                listEl.style.display = 'block';
                emptyEl.style.display = 'none';
                
                let html = '';
                deficiencies.forEach(sectionId => {
                    html += `
                        <div class="deficiency-item" data-section="${sectionId}">
                            <div class="deficiency-item-header">
                                <div class="deficiency-item-section">${sectionNames[sectionId]}</div>
                                <button class="deficiency-item-remove" onclick="setSectionStatus('${sectionId}', null)" title="Odebrat vadu">
                                    <span class="material-icons-outlined">close</span>
                                </button>
                            </div>
                            <textarea class="deficiency-item-textarea" placeholder="Popište zjištěný nedostatek pro výzvu k doplnění..." 
                                oninput="updateDeficiencyNote('${sectionId}', this.value)">${zadostDeficiencyNotes[sectionId] || ''}</textarea>
                        </div>
                    `;
                });
                listEl.innerHTML = html;
            }
            
            // Aktualizovat výsledek
            const resultEl = document.getElementById('deficiencyResult');
            const btnConfirm = document.getElementById('btnConfirmZadost');
            
            if (pendingCount > 0) {
                resultEl.className = 'deficiency-result pending';
                resultEl.innerHTML = `
                    <span class="material-icons-outlined">hourglass_empty</span>
                    <div>
                        <strong>Kontrola probíhá</strong>
                        <div style="font-size: 11px; margin-top: 2px;">Zbývá zkontrolovat ${pendingCount} ${pendingCount === 1 ? 'sekci' : (pendingCount < 5 ? 'sekce' : 'sekcí')}</div>
                    </div>
                `;
                btnConfirm.disabled = true;
            } else if (vadaCount > 0) {
                resultEl.className = 'deficiency-result negative';
                resultEl.innerHTML = `
                    <span class="material-icons-outlined">error</span>
                    <div>
                        <strong>Žádost má nedostatky</strong>
                        <div style="font-size: 11px; margin-top: 2px;">Nalezeno ${vadaCount} ${vadaCount === 1 ? 'vada' : (vadaCount < 5 ? 'vady' : 'vad')} — bude vydána výzva k doplnění</div>
                    </div>
                `;
                btnConfirm.disabled = false;
            } else {
                resultEl.className = 'deficiency-result positive';
                resultEl.innerHTML = `
                    <span class="material-icons-outlined">check_circle</span>
                    <div>
                        <strong>Žádost je úplná</strong>
                        <div style="font-size: 11px; margin-top: 2px;">Všechny sekce zkontrolovány bez závad</div>
                    </div>
                `;
                btnConfirm.disabled = false;
            }
        }
        
        // Poznámky k nedostatkům
        const zadostDeficiencyNotes = {};
        
        function updateDeficiencyNote(sectionId, value) {
            zadostDeficiencyNotes[sectionId] = value;
        }
        
        // Dokončit kontrolu žádosti
        function completeZadostKontrola() {
            controls.zadost.done = true;
            
            // Spočítat vady z nového stavu sekcí
            let vadaCount = 0;
            const deficiencyNotes = [];
            
            for (const [key, value] of Object.entries(zadostSectionState)) {
                if (value === 'vada') {
                    vadaCount++;
                    if (zadostDeficiencyNotes[key]) {
                        deficiencyNotes.push(`${sectionNames[key]}: ${zadostDeficiencyNotes[key]}`);
                    }
                }
            }
            
            // === PROPAGACE DO globalIssues.vyzva ===
            // Odebrat předchozí issues z kontroly žádosti
            globalIssues.vyzva = globalIssues.vyzva.filter(i => i.controlName !== 'Kontrola žádosti');
            
            if (vadaCount > 0) {
                controls.zadost.result = 'vady';
                controls.zadost.deficiencyNote = deficiencyNotes.join('\n');
                
                // Přidat každou vadu jako globalIssue
                deficiencyNotes.forEach(note => {
                    addGlobalIssue('vyzva', {
                        text: 'Odstranil formální vadu žádosti: ' + note,
                        source: 'auto',
                        controlName: 'Kontrola žádosti',
                        kategorie: 'formalni',
                        typAkce: 'doplnit'
                    });
                });
            } else {
                controls.zadost.result = 'ok';
            }
            
            closeControl('controlZadost');
            updateUI();
        }

        function completeZadost() {
            completeZadostKontrola();
        }

        // ==========================================
        // KONTROLA FORMULÁŘE - checklist režim
        // ==========================================
        
        // Stav kontroly kroků formuláře
        const formularStepState = {
            podani: null,
            zadatel: null,
            zastupce: null,
            zamer: null,
            pozemky: null,
            prilohy: null
        };
        
        const formularStepNames = {
            podani: 'Údaje o podání',
            zadatel: 'Žadatel',
            zastupce: 'Zástupce',
            zamer: 'Identifikace záměru',
            pozemky: 'Pozemky záměru',
            prilohy: 'Přílohy žádosti'
        };
        
        // Poznámky k vadám formuláře
        const formularVadaNotes = {};
        
        // Nastavení stavu kroku formuláře
        function setFormularStepStatus(stepId, status) {
            const capitalizedId = stepId.charAt(0).toUpperCase() + stepId.slice(1);
            const item = document.getElementById('formularCheck' + capitalizedId);
            if (!item) return;
            
            // Odstranit předchozí stav
            item.classList.remove('status-ok', 'status-vada', 'status-skip');
            
            // Nastavit nový stav
            formularStepState[stepId] = status;
            
            // Aktualizovat vzhled položky
            const statusEl = document.getElementById('formularStatus' + capitalizedId);
            const vadaInput = document.getElementById('formularVadaInput' + capitalizedId);
            const changeBtn = document.getElementById('formularChange' + capitalizedId);
            
            if (status === 'ok') {
                item.classList.add('status-ok');
                statusEl.innerHTML = '<span class="material-icons-outlined">check_circle</span>';
                if (vadaInput) vadaInput.style.display = 'none';
                if (changeBtn) changeBtn.style.display = 'block';
            } else if (status === 'vada') {
                item.classList.add('status-vada');
                statusEl.innerHTML = '<span class="material-icons-outlined">error</span>';
                if (vadaInput) vadaInput.style.display = 'block';
                if (changeBtn) changeBtn.style.display = 'block';
            } else if (status === 'skip') {
                item.classList.add('status-skip');
                statusEl.innerHTML = '<span class="material-icons-outlined">remove_circle_outline</span>';
                if (vadaInput) vadaInput.style.display = 'none';
                if (changeBtn) changeBtn.style.display = 'block';
            }
            
            updateFormularSummary();
        }
        
        // Reset stavu kroku formuláře (tlačítko Změnit)
        function resetFormularStepStatus(stepId) {
            const capitalizedId = stepId.charAt(0).toUpperCase() + stepId.slice(1);
            const item = document.getElementById('formularCheck' + capitalizedId);
            if (!item) return;
            
            // Odstranit stav
            item.classList.remove('status-ok', 'status-vada', 'status-skip');
            formularStepState[stepId] = null;
            
            // Reset vzhledu
            const statusEl = document.getElementById('formularStatus' + capitalizedId);
            const vadaInput = document.getElementById('formularVadaInput' + capitalizedId);
            const changeBtn = document.getElementById('formularChange' + capitalizedId);
            const textarea = document.getElementById('formularVadaText' + capitalizedId);
            
            statusEl.innerHTML = '<span class="material-icons-outlined">radio_button_unchecked</span>';
            if (vadaInput) vadaInput.style.display = 'none';
            if (changeBtn) changeBtn.style.display = 'none';
            if (textarea) textarea.value = '';
            
            updateFormularSummary();
        }
        
        // Označit všechny kroky formuláře jako v pořádku
        function setAllFormularStepsOk() {
            for (const stepId of Object.keys(formularStepState)) {
                setFormularStepStatus(stepId, 'ok');
            }
        }
        
        // Aktualizace souhrnu kontroly formuláře
        function updateFormularSummary() {
            let okCount = 0;
            let vadaCount = 0;
            let pendingCount = 0;
            
            for (const [key, value] of Object.entries(formularStepState)) {
                if (value === 'ok' || value === 'skip') {
                    okCount++;
                } else if (value === 'vada') {
                    vadaCount++;
                } else {
                    pendingCount++;
                }
            }
            
            document.getElementById('formularOkCount').textContent = okCount;
            document.getElementById('formularVadaCount').textContent = vadaCount;
            
            const resultEl = document.getElementById('formularResult');
            const btnConfirm = document.getElementById('btnConfirmFormular');
            
            // Kontrola je dokončena, když všechny kroky mají stav
            const allChecked = pendingCount === 0;
            
            if (allChecked) {
                if (vadaCount > 0) {
                    resultEl.className = 'deficiency-result negative';
                    resultEl.innerHTML = `
                        <span class="material-icons-outlined">warning</span>
                        <div>
                            <strong>Zjištěny nedostatky</strong>
                            <div style="font-size: 11px; margin-top: 2px;">Formulář obsahuje ${vadaCount} vad</div>
                        </div>
                    `;
                } else {
                    resultEl.className = 'deficiency-result positive';
                    resultEl.innerHTML = `
                        <span class="material-icons-outlined">check_circle</span>
                        <div>
                            <strong>Kontrola úspěšná</strong>
                            <div style="font-size: 11px; margin-top: 2px;">Formulář je v pořádku</div>
                        </div>
                    `;
                }
                btnConfirm.disabled = false;
            } else {
                resultEl.className = 'deficiency-result pending';
                resultEl.innerHTML = `
                    <span class="material-icons-outlined">hourglass_empty</span>
                    <div>
                        <strong>Kontrola probíhá</strong>
                        <div style="font-size: 11px; margin-top: 2px;">Zbývá zkontrolovat ${pendingCount} částí</div>
                    </div>
                `;
                btnConfirm.disabled = true;
            }
        }
        
        // Dokončit kontrolu formuláře
        function completeFormularKontrola() {
            controls.zadost.done = true;
            
            // Spočítat vady
            let vadaCount = 0;
            const deficiencyNotes = [];
            
            for (const [key, value] of Object.entries(formularStepState)) {
                if (value === 'vada') {
                    vadaCount++;
                    const textarea = document.getElementById('formularVadaText' + key.charAt(0).toUpperCase() + key.slice(1));
                    if (textarea && textarea.value.trim()) {
                        formularVadaNotes[key] = textarea.value.trim();
                        deficiencyNotes.push(`${formularStepNames[key]}: ${textarea.value.trim()}`);
                    }
                }
            }
            
            if (vadaCount > 0) {
                controls.zadost.result = 'vady';
                controls.zadost.deficiencyNote = deficiencyNotes.join('\n');
            } else {
                controls.zadost.result = 'ok';
            }
            
            closeControl('controlZadost');
            updateUI();
        }

        // ==========================================
        // PŘÍSLUŠNOST - update result
        // ==========================================
        function updatePrislusnostResult() {
            const prislusnost = document.querySelector('input[name="prislusnost"]:checked').value;
            const resultBox = document.getElementById('resultPrislusnost');
            const vyberSuSection = document.getElementById('vyberSuSection');
            const zduvodneniSection = document.getElementById('zduvodneniNeprislusnostiSection');

            // Při změně na příslušný - reset výběru
            if (prislusnost === 'prislusny') {
                vyberSuSection.classList.remove('visible');
                document.getElementById('postoupitSuSelect').value = '';
                document.getElementById('postoupitSuSearchInput').value = '';
                document.getElementById('postoupitSuInfo').classList.remove('visible');
                
                // Skrýt zdůvodnění
                if (zduvodneniSection) {
                    zduvodneniSection.style.display = 'none';
                }
                
                // Zobrazit pozitivní výsledek
                resultBox.className = 'result-preview positive';
                resultBox.innerHTML = `
                    <div class="result-preview-title">
                        <span class="material-icons-outlined">check_circle</span>
                        Příslušnost potvrzena
                    </div>
                    <div class="result-preview-text">Stavební úřad je věcně i místně příslušný k projednání této žádosti.</div>
                `;
            } else {
                // Nepříslušný - zobrazit výběr SÚ a zdůvodnění
                vyberSuSection.classList.add('visible');
                
                // Zobrazit zdůvodnění
                if (zduvodneniSection) {
                    zduvodneniSection.style.display = 'block';
                }
                
                const selectedSuValue = document.getElementById('postoupitSuSelect').value;
                
                if (selectedSuValue) {
                    // Je vybrán SÚ - zobrazit info o postoupení
                    const selectedOption = document.querySelector(`#postoupitSuDropdown .su-dropdown-option[data-value="${selectedSuValue}"]`);
                    if (selectedOption) {
                        const suName = selectedOption.querySelector('.su-option-name').textContent;
                        const suType = selectedOption.getAttribute('data-type');
                        const info = selectedOption.getAttribute('data-info').split('|');
                        
                        resultBox.className = 'result-preview negative';
                        resultBox.innerHTML = `
                            <div class="result-preview-title">
                                <span class="material-icons-outlined">send</span>
                                Řízení bude postoupeno
                            </div>
                            <div class="result-preview-text">
                                <strong>${suType}</strong><br>
                                ${info[0]}<br>
                                <span style="color: #5f6368; font-size: 12px;">${info[1]}</span>
                            </div>
                        `;
                    }
                } else {
                    // Není vybrán SÚ - vyzvat k výběru
                    resultBox.className = 'result-preview negative';
                    resultBox.innerHTML = `
                        <div class="result-preview-title">
                            <span class="material-icons-outlined">warning</span>
                            Vyberte příslušný stavební úřad
                        </div>
                        <div class="result-preview-text">Pro postoupení řízení je nutné vybrat stavební úřad, kterému bude řízení postoupeno.</div>
                    `;
                }
            }
            
            // Aktualizace stavu tlačítka potvrdit
            updatePrislusnostButton();
        }
        
        function updatePrislusnostButton() {
            const prislusnost = document.querySelector('input[name="prislusnost"]:checked').value;
            const btnConfirm = document.querySelector('#controlPrislusnost .btn-primary');
            const zduvodneniSection = document.getElementById('zduvodneniNeprislusnostiSection');
            const zduvodneni = zduvodneniSection ? document.getElementById('zduvodneniNeprislusnosti').value.trim() : '';
            
            if (prislusnost === 'neprislusny') {
                const selectedSu = document.getElementById('postoupitSuSelect').value;
                // Tlačítko aktivní pouze pokud je vybrán SÚ a zadáno zdůvodnění
                btnConfirm.disabled = !selectedSu || !zduvodneni;
                btnConfirm.innerHTML = '<span class="material-icons-outlined">send</span>Postoupit řízení';
                btnConfirm.onclick = function() { showPostoupeniModal(); };
            } else {
                btnConfirm.disabled = false;
                btnConfirm.innerHTML = '<span class="material-icons-outlined">check</span>Potvrdit kontrolu';
                btnConfirm.onclick = function() { completePrislusnost(); };
            }
        }
        
        // ==========================================
        // SEARCHABLE DROPDOWN PRO VÝBĚR SÚ
        // ==========================================
        
        // Otevřít dropdown
        function openSuDropdown(type) {
            const dropdownId = type === 'postoupit' ? 'postoupitSuDropdown' : 
                               (type === 'specialni' ? 'specialniSuDropdown' : 'obecnySuDropdown');
            const dropdown = document.getElementById(dropdownId);
            
            // Zavřít ostatní dropdowny
            document.querySelectorAll('.su-dropdown.open').forEach(d => {
                if (d !== dropdown) d.classList.remove('open');
            });
            
            dropdown.classList.add('open');
        }
        
        // Zavřít dropdown při kliknutí mimo
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.su-search-select')) {
                document.querySelectorAll('.su-dropdown.open').forEach(d => d.classList.remove('open'));
            }
        });
        
        // Filtrovat možnosti
        function filterSuOptions(type) {
            const inputId = type === 'postoupit' ? 'postoupitSuSearchInput' : 
                            (type === 'specialni' ? 'specialniSuSearchInput' : 'obecnySuSearchInput');
            const dropdownId = type === 'postoupit' ? 'postoupitSuDropdown' : 
                               (type === 'specialni' ? 'specialniSuDropdown' : 'obecnySuDropdown');
            
            const input = document.getElementById(inputId);
            const dropdown = document.getElementById(dropdownId);
            const searchTerm = input.value.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '');
            
            let visibleCount = 0;
            
            dropdown.querySelectorAll('.su-dropdown-group').forEach(group => {
                let groupVisible = false;
                
                group.querySelectorAll('.su-dropdown-option').forEach(option => {
                    const name = option.querySelector('.su-option-name').textContent.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '');
                    const searchData = (option.dataset.search || '').toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '');
                    
                    if (name.includes(searchTerm) || searchData.includes(searchTerm)) {
                        option.classList.remove('hidden');
                        groupVisible = true;
                        visibleCount++;
                    } else {
                        option.classList.add('hidden');
                    }
                });
                
                if (groupVisible) {
                    group.classList.remove('hidden');
                } else {
                    group.classList.add('hidden');
                }
            });
            
            // Zobrazit/skrýt prázdný stav
            const emptyState = dropdown.querySelector('.su-dropdown-empty');
            if (visibleCount === 0) {
                emptyState.style.display = 'block';
            } else {
                emptyState.style.display = 'none';
            }
            
            // Otevřít dropdown při psaní
            dropdown.classList.add('open');
        }
        
        // Vybrat možnost
        function selectSuOption(type, option) {
            const inputId = type === 'postoupit' ? 'postoupitSuSearchInput' : 
                            (type === 'specialni' ? 'specialniSuSearchInput' : 'obecnySuSearchInput');
            const hiddenInputId = type === 'postoupit' ? 'postoupitSuSelect' : 
                                  (type === 'specialni' ? 'specialniSuSelect' : 'obecnySuSelect');
            const dropdownId = type === 'postoupit' ? 'postoupitSuDropdown' : 
                               (type === 'specialni' ? 'specialniSuDropdown' : 'obecnySuDropdown');
            
            const input = document.getElementById(inputId);
            const hiddenInput = document.getElementById(hiddenInputId);
            const dropdown = document.getElementById(dropdownId);
            
            const value = option.dataset.value;
            const name = option.querySelector('.su-option-name').textContent;
            
            // Nastavit hodnotu
            hiddenInput.value = value;
            input.value = name;
            input.classList.add('selected');
            
            // Označit vybranou možnost
            dropdown.querySelectorAll('.su-dropdown-option').forEach(o => o.classList.remove('selected'));
            option.classList.add('selected');
            
            // Zavřít dropdown
            dropdown.classList.remove('open');
            
            // Aktualizovat info box
            if (type === 'postoupit') {
                updatePostoupitSuInfo(option);
            } else if (type === 'specialni') {
                updateSpecialniSuInfo(option);
            } else {
                updateObecnySuInfo(option);
            }
        }
        
        // Vymazat výběr
        function clearSuSelection(type) {
            const inputId = type === 'postoupit' ? 'postoupitSuSearchInput' : 
                            (type === 'specialni' ? 'specialniSuSearchInput' : 'obecnySuSearchInput');
            const hiddenInputId = type === 'postoupit' ? 'postoupitSuSelect' : 
                                  (type === 'specialni' ? 'specialniSuSelect' : 'obecnySuSelect');
            const dropdownId = type === 'postoupit' ? 'postoupitSuDropdown' : 
                               (type === 'specialni' ? 'specialniSuDropdown' : 'obecnySuDropdown');
            const infoBoxId = type === 'postoupit' ? 'postoupitSuInfo' : 
                              (type === 'specialni' ? 'specialniSuInfo' : 'obecnySuInfo');
            
            const input = document.getElementById(inputId);
            const hiddenInput = document.getElementById(hiddenInputId);
            const dropdown = document.getElementById(dropdownId);
            const infoBox = document.getElementById(infoBoxId);
            
            hiddenInput.value = '';
            input.value = '';
            input.classList.remove('selected');
            
            // Reset filtrování
            dropdown.querySelectorAll('.su-dropdown-group, .su-dropdown-option').forEach(el => el.classList.remove('hidden'));
            dropdown.querySelectorAll('.su-dropdown-option').forEach(o => o.classList.remove('selected'));
            dropdown.querySelector('.su-dropdown-empty').style.display = 'none';
            
            // Skrýt info box
            infoBox.classList.remove('visible');
            
            updatePrislusnostResult();
        }
        
        // Inicializace click handlerů pro dropdown options
        document.addEventListener('DOMContentLoaded', function() {
            // Postoupit dropdown (nový sloučený)
            document.querySelectorAll('#postoupitSuDropdown .su-dropdown-option').forEach(option => {
                option.addEventListener('click', function() {
                    selectSuOption('postoupit', this);
                });
            });
            
            // Staré dropdowny pro zpětnou kompatibilitu
            document.querySelectorAll('#specialniSuDropdown .su-dropdown-option').forEach(option => {
                option.addEventListener('click', function() {
                    selectSuOption('specialni', this);
                });
            });
            
            document.querySelectorAll('#obecnySuDropdown .su-dropdown-option').forEach(option => {
                option.addEventListener('click', function() {
                    selectSuOption('obecny', this);
                });
            });
        });
        
        function updatePostoupitSuInfo(option) {
            const infoBox = document.getElementById('postoupitSuInfo');
            const nameEl = document.getElementById('postoupitSuName');
            const detailsEl = document.getElementById('postoupitSuDetails');
            
            if (option) {
                const info = option.dataset.info.split('|');
                const type = option.dataset.type;
                
                nameEl.textContent = info[0];
                detailsEl.innerHTML = `
                    <span><strong>Typ:</strong> ${type}</span>
                    <span><strong>Adresa:</strong> ${info[1]}</span>
                    <span><strong>E-mail:</strong> ${info[2]}</span>
                    <span><strong>Působnost:</strong> ${info[3] || '—'}</span>
                `;
                infoBox.classList.add('visible');
            } else {
                infoBox.classList.remove('visible');
            }
            
            updatePrislusnostResult();
        }
        
        function updateSpecialniSuInfo(option) {
            const infoBox = document.getElementById('specialniSuInfo');
            const nameEl = document.getElementById('specialniSuName');
            const detailsEl = document.getElementById('specialniSuDetails');
            
            if (option) {
                const info = option.dataset.info.split('|');
                const type = option.dataset.type;
                
                nameEl.textContent = info[0];
                detailsEl.innerHTML = `
                    <span><strong>Typ:</strong> ${type}</span>
                    <span><strong>Adresa:</strong> ${info[1]}</span>
                    <span><strong>E-mail:</strong> ${info[2]}</span>
                    <span><strong>Působnost:</strong> ${info[3] || '—'}</span>
                `;
                infoBox.classList.add('visible');
            } else {
                infoBox.classList.remove('visible');
            }
            
            updatePrislusnostResult();
        }
        
        function updateObecnySuInfo(option) {
            const infoBox = document.getElementById('obecnySuInfo');
            const nameEl = document.getElementById('obecnySuName');
            const detailsEl = document.getElementById('obecnySuDetails');
            
            if (option) {
                const info = option.dataset.info.split('|');
                
                nameEl.textContent = info[0];
                detailsEl.innerHTML = `
                    <span><strong>Adresa:</strong> ${info[1]}</span>
                    <span><strong>E-mail:</strong> ${info[2]}</span>
                    <span><strong>Územní obvod:</strong> ${info[3]}</span>
                `;
                infoBox.classList.add('visible');
            } else {
                infoBox.classList.remove('visible');
            }
            
            updatePrislusnostResult();
        }

        // ==========================================
        // DOKUMENTACE - kompletní logika
        // ==========================================
        
        // Funkce pro uložení rozpracované kontroly
        function saveDraft(controlName) {
            const indicator = document.getElementById('autoSave' + controlName.charAt(0).toUpperCase() + controlName.slice(1));
            if (!indicator) return;
            
            // Simulace ukládání
            indicator.className = 'auto-save-indicator saving';
            indicator.innerHTML = '<span class="material-icons-outlined">sync</span><span>Ukládám...</span>';
            
            setTimeout(function() {
                indicator.className = 'auto-save-indicator saved';
                indicator.innerHTML = '<span class="material-icons-outlined">cloud_done</span><span>Uloženo</span>';
                
                // Zobrazit potvrzení
                setTimeout(function() {
                    indicator.innerHTML = '<span class="material-icons-outlined">cloud_done</span><span>Automaticky uloženo</span>';
                }, 2000);
            }, 800);
        }
        
        // Trigger automatického ukládání při změně (simulace)
        function triggerAutoSave(controlName) {
            const indicator = document.getElementById('autoSave' + controlName.charAt(0).toUpperCase() + controlName.slice(1));
            if (!indicator) return;
            
            indicator.className = 'auto-save-indicator saving';
            indicator.innerHTML = '<span class="material-icons-outlined">sync</span><span>Ukládám...</span>';
            
            setTimeout(function() {
                indicator.className = 'auto-save-indicator saved';
                indicator.innerHTML = '<span class="material-icons-outlined">cloud_done</span><span>Automaticky uloženo</span>';
            }, 500);
        }
        
        // Stav kontrol dokumentace
        let docCheckState = {
            autoCheckDone: false,
            partStatus: { A: 'unchecked', B: 'unchecked', C: 'unchecked', D: 'unchecked' },
            issues: [],
            validatorResults: [],
            currentVersion: 'v3'
        };
        
        function toggleEdFolder(headerEl) {
            const folder = headerEl.closest('.ed-folder');
            if (folder.classList.contains('empty')) return;
            folder.classList.toggle('open');
        }
        
        // Funkce pro návrat do struktury ED z náhledu
        function backToEdStructure() {
            document.getElementById('edTreeContainer').style.display = 'block';
            document.getElementById('edPreviewContainer').style.display = 'none';
            document.getElementById('edBackBtn').style.display = 'none';
            document.getElementById('edBreadcrumb').style.display = 'flex';
        }
        
        function switchDocViewerTab(tabEl, view) {
            // Tato funkce již není potřeba se starými záložkami
            // Zachována pro zpětnou kompatibilitu
            const treeContainer = document.getElementById('edTreeContainer');
            const previewContainer = document.getElementById('edPreviewContainer');
            
            if (view === 'struktura') {
                treeContainer.style.display = 'block';
                previewContainer.style.display = 'none';
                document.getElementById('edBackBtn').style.display = 'none';
                document.getElementById('edBreadcrumb').style.display = 'flex';
            } else {
                treeContainer.style.display = 'none';
                previewContainer.style.display = 'block';
                document.getElementById('edBackBtn').style.display = 'flex';
                document.getElementById('edBreadcrumb').style.display = 'none';
            }
        }
        
        function previewEdFile(fileName, section) {
            // Přepnout kontejnery
            document.getElementById('edTreeContainer').style.display = 'none';
            document.getElementById('edPreviewContainer').style.display = 'block';
            
            // Zobrazit tlačítko Zpět, skrýt breadcrumb
            document.getElementById('edBackBtn').style.display = 'flex';
            document.getElementById('edBreadcrumb').style.display = 'none';
            
            // Zobrazit náhled
            const previewContent = document.getElementById('edPreviewContent');
            const versionLabel = docCheckState.currentVersion === 'v3' ? '' : ` (${docCheckState.currentVersion})`;
            previewContent.innerHTML = `
                <span class="material-icons-outlined" style="font-size: 64px; color: #c62828; margin-bottom: 16px;">picture_as_pdf</span>
                <div style="font-size: 16px; font-weight: 500; color: #202124; margin-bottom: 8px;">${fileName}${versionLabel}</div>
                <div style="font-size: 13px; color: #5f6368;">V ostré verzi by se zde zobrazil náhled dokumentu</div>
            `;
        }
        
        function changeEdVersion() {
            const select = document.getElementById('edVersionSelect');
            const newVersion = select.value;
            docCheckState.currentVersion = newVersion;
            
            // Simulace načtení jiné verze - zavřeme všechny otevřené složky
            document.querySelectorAll('.ed-folder.open').forEach(folder => {
                folder.classList.remove('open');
            });
            
            // Pokud jsme v náhledu, přepneme zpět na strukturu
            backToEdStructure();
        }
        
        // ==========================================
        // KATEGORIE STAVBY A SOUBOR STAVEB
        // ==========================================
        
        function toggleSouborStaveb() {
            const isSoubor = document.querySelector('input[name="souborStaveb"]:checked').value === 'ano';
            const jednoduchyField = document.getElementById('kategorieJednoduchaField');
            const souborField = document.getElementById('kategorieSouborField');
            
            if (isSoubor) {
                jednoduchyField.style.display = 'none';
                souborField.style.display = 'block';
            } else {
                jednoduchyField.style.display = 'block';
                souborField.style.display = 'none';
            }
        }
        
        function addVedlejsiStavba() {
            const list = document.getElementById('vedlejsiStavbyList');
            const newRow = document.createElement('div');
            newRow.className = 'vedlejsi-stavba-row';
            newRow.innerHTML = `
                <input type="text" class="stavba-input" placeholder="Název stavby">
                <select class="stavba-select">
                    <option value="ostatni">Ostatní</option>
                    <option value="jednoducha">Jednoduchá</option>
                    <option value="drobna">Drobná</option>
                </select>
                <button class="vedlejsi-remove" onclick="removeVedlejsiStavba(this)" title="Odebrat">
                    <span class="material-icons-outlined">close</span>
                </button>
            `;
            list.appendChild(newRow);
        }
        
        function removeVedlejsiStavba(btn) {
            const row = btn.closest('.vedlejsi-stavba-row');
            if (row) {
                row.remove();
            }
        }
        
        function updateSouborSummary() {
            const kategorieHlavni = document.querySelector('input[name="kategorieHlavni"]:checked');
            if (kategorieHlavni) {
                const kategorie = kategorieHlavni.value;
                const kategorieText = {
                    'vyhrazena': 'Vyhrazená',
                    'ostatni': 'Ostatní',
                    'jednoducha': 'Jednoduchá',
                    'drobna': 'Drobná'
                }[kategorie] || 'Ostatní';
                
                const summary = document.getElementById('souborSummary');
                summary.innerHTML = `
                    <span class="material-icons-outlined">info</span>
                    <span>Kategorie souboru staveb: <strong>${kategorieText}</strong> (podle hlavní stavby)</span>
                `;
            }
        }
        
        // Přidání event listeneru pro změnu kategorie hlavní stavby
        document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('input[name="kategorieHlavni"]').forEach(input => {
                input.addEventListener('change', updateSouborSummary);
            });
        });
        
        function setDocPartStatus(part, status) {
            docCheckState.partStatus[part] = status;
            
            // Update UI pro tlačítka
            const item = document.querySelector(`.doc-part-item[data-part="${part}"]`);
            if (!item) return;
            
            item.classList.remove('status-ok', 'status-warning', 'status-error', 'status-unchecked');
            item.classList.add('status-' + status);
            
            // Update buttons - odstranit active a unchecked ze všech
            const buttons = item.querySelectorAll('.doc-part-btn');
            buttons.forEach(btn => {
                btn.classList.remove('active', 'unchecked');
            });
            
            // Nastavit správný stav tlačítku
            const targetBtn = item.querySelector('.doc-part-btn.' + status) || item.querySelector('.doc-part-btn.ok');
            if (status === 'ok') {
                targetBtn.classList.add('active');
            } else if (status === 'unchecked') {
                item.querySelector('.doc-part-btn.ok').classList.add('unchecked');
            } else {
                targetBtn.classList.add('active');
            }
            
            // Zobrazení/skrytí sekce pro nedostatky dané části
            const partSection = document.getElementById('partIssues' + part);
            
            if (status === 'error') {
                if (partSection) {
                    partSection.style.display = 'block';
                    // Focus na textarea
                    setTimeout(() => {
                        const textarea = document.getElementById('partIssueText' + part);
                        if (textarea) textarea.focus();
                    }, 100);
                }
            } else {
                if (partSection) {
                    partSection.style.display = 'none';
                }
                // Odeber všechny nedostatky pro tuto část
                docCheckState.issues = docCheckState.issues.filter(i => i.part !== part);
                const listEl = document.getElementById('partIssuesList' + part);
                if (listEl) listEl.innerHTML = '';
                const textEl = document.getElementById('partIssueText' + part);
                if (textEl) textEl.value = '';
            }
            
            updateIssuesVisibility();
            updateDokumentaceResult();
        }
        
        // Přidání nedostatku k části dokumentace (strukturovaný formulář)
        function addPartIssue(part) {
            const textInput = document.getElementById('partIssueText' + part);
            const refInput = document.getElementById('partIssueRef' + part);
            const examplesInput = document.getElementById('partIssueExamples' + part);
            
            const text = textInput ? textInput.value.trim() : '';
            const ref = refInput ? refInput.value.trim() : '';
            const examples = examplesInput ? examplesInput.value.trim() : '';
            
            if (!text) {
                if (textInput) textInput.focus();
                return;
            }
            
            const partNames = {
                A: 'Průvodní zpráva',
                B: 'Souhrnná technická zpráva', 
                C: 'Situační výkresy',
                D: 'Dokumentace objektů'
            };
            
            const issueId = 'issue-' + Date.now();
            
            // Sestavit plný text pro výzvu
            let fullText = `Část ${part}. ${partNames[part]}`;
            if (ref) fullText += `, ${ref}`;
            fullText += `: ${text}`;
            if (examples) fullText += ` (např. ${examples})`;
            
            // Přidat do lokálního stavu
            docCheckState.issues.push({
                id: issueId,
                text: fullText,
                shortText: text,
                reference: ref,
                examples: examples,
                part: part,
                source: 'manual'
            });
            
            // Přidat do globálního seznamu
            addGlobalIssue('vyzva', {
                text: fullText,
                hlavniText: fullText,
                source: 'manual',
                controlName: 'Kontrola dokumentace',
                kategorie: 'obsah_pd',
                castPD: part,
                reference: ref || null,
                priklady: examples ? [examples] : []
            });
            
            // Vyrenderovat
            renderPartIssues(part);
            
            // Vyčistit
            if (textInput) textInput.value = '';
            if (refInput) refInput.value = '';
            if (examplesInput) examplesInput.value = '';
            if (textInput) textInput.focus();
            
            updateIssuesVisibility();
            updateDokumentaceResult();
        }
        
        // Přidání průřezového nedostatku
        function addCrossCuttingIssue() {
            const textInput = document.getElementById('partIssueTextCross');
            const scopeSelect = document.getElementById('partIssueScopeCross');
            const examplesInput = document.getElementById('partIssueExamplesCross');
            
            const text = textInput ? textInput.value.trim() : '';
            const scope = scopeSelect ? scopeSelect.value : 'A,B,C,D';
            const examples = examplesInput ? examplesInput.value.trim() : '';
            
            if (!text) {
                if (textInput) textInput.focus();
                return;
            }
            
            const issueId = 'issue-cross-' + Date.now();
            
            let fullText = `Průřezový nedostatek (části ${scope}): ${text}`;
            if (examples) fullText += ` (${examples})`;
            
            docCheckState.issues.push({
                id: issueId,
                text: fullText,
                shortText: text,
                examples: examples,
                part: 'CROSS',
                scope: scope,
                source: 'manual'
            });
            
            addGlobalIssue('vyzva', {
                text: fullText,
                hlavniText: fullText,
                source: 'manual',
                controlName: 'Kontrola dokumentace',
                kategorie: 'prurezovy',
                castPD: null,
                priklady: examples ? [examples] : []
            });
            
            renderPartIssues('Cross');
            
            if (textInput) textInput.value = '';
            if (examplesInput) examplesInput.value = '';
            if (textInput) textInput.focus();
            
            updateIssuesVisibility();
            updateDokumentaceResult();
        }
        
        // Odebrání nedostatku z části
        function removePartIssue(issueId, part) {
            const issue = docCheckState.issues.find(i => i.id === issueId);
            docCheckState.issues = docCheckState.issues.filter(i => i.id !== issueId);
            
            // Odebrat z globálního seznamu
            if (issue) {
                const globalIssue = globalIssues.vyzva.find(gi => gi.text === issue.text);
                if (globalIssue) {
                    removeGlobalIssue('vyzva', globalIssue.id);
                }
            }
            
            renderPartIssues(part);
            updateIssuesVisibility();
            updateDokumentaceResult();
        }
        
        // Vyrenderování nedostatků pro konkrétní část
        function renderPartIssues(part) {
            const list = document.getElementById('partIssuesList' + part);
            const partKey = part.toUpperCase() === 'CROSS' ? 'CROSS' : part;
            const partIssues = docCheckState.issues.filter(i => i.part === partKey);
            
            if (!list) return;
            
            if (partIssues.length === 0) {
                list.innerHTML = '';
                return;
            }
            
            list.innerHTML = partIssues.map(issue => {
                const refBadge = issue.reference ? `<span class="issue-reference">${issue.reference}</span>` : '';
                const examplesLine = issue.examples ? `<span class="issue-examples">např. ${issue.examples}</span>` : '';
                return `
                    <div class="part-issue-item" data-issue-id="${issue.id}">
                        <div class="part-issue-icon">
                            <span class="material-icons-outlined">warning</span>
                        </div>
                        <div class="part-issue-content">
                            ${refBadge}${issue.shortText || issue.text}
                            ${examplesLine}
                        </div>
                        <button class="part-issue-remove" onclick="removePartIssue('${issue.id}', '${part}')" title="Odebrat">
                            <span class="material-icons-outlined">close</span>
                        </button>
                    </div>
                `;
            }).join('');
        }
        
        // Aktualizace viditelnosti celé sekce nedostatků
        function updateIssuesVisibility() {
            const section = document.getElementById('issuesSection');
            const emptyState = document.getElementById('issuesEmpty');
            const countEl = document.getElementById('issuesCount');
            const autoSection = document.getElementById('autoIssuesSection');
            
            const totalIssues = docCheckState.issues.length;
            const autoIssues = docCheckState.issues.filter(i => i.source === 'auto');
            const crossIssues = docCheckState.issues.filter(i => i.part === 'CROSS');
            const hasPartSections = ['A', 'B', 'C', 'D'].some(p => docCheckState.partStatus[p] === 'error');
            
            countEl.textContent = totalIssues;
            
            // Zobrazení automatických nedostatků
            if (autoIssues.length > 0) {
                autoSection.style.display = 'block';
                renderAutoIssues();
            } else {
                autoSection.style.display = 'none';
            }
            
            // Zobrazení průřezových nedostatků
            const crossSection = document.getElementById('partIssuesCross');
            if (crossSection && crossIssues.length > 0) {
                crossSection.style.display = 'block';
            }
            
            // Zobrazení prázdného stavu
            if (totalIssues === 0 && !hasPartSections) {
                emptyState.style.display = 'block';
            } else {
                emptyState.style.display = 'none';
            }
        }
        
        // Přepínání sekce průřezových nedostatků
        function toggleCrossSection() {
            const section = document.getElementById('partIssuesCross');
            if (section) {
                const isVisible = section.style.display === 'block';
                section.style.display = isVisible ? 'none' : 'block';
                if (!isVisible) {
                    setTimeout(() => {
                        const input = document.getElementById('partIssueTextCross');
                        if (input) input.focus();
                    }, 100);
                }
            }
        }
        
        // Renderování automatických nedostatků
        function renderAutoIssues() {
            const list = document.getElementById('autoIssuesList');
            const autoIssues = docCheckState.issues.filter(i => i.source === 'auto');
            
            list.innerHTML = autoIssues.map(issue => `
                <div class="part-issue-item" data-issue-id="${issue.id}">
                    <div class="part-issue-icon">
                        <span class="material-icons-outlined">auto_awesome</span>
                    </div>
                    <div class="part-issue-content">
                        <div style="font-size:12px;">${issue.shortText || issue.text}</div>
                        ${issue.shortText && issue.text !== issue.shortText ? '<div style="font-size:11px;color:#80868b;margin-top:2px;">' + issue.text + '</div>' : ''}
                    </div>
                    <button class="part-issue-remove" onclick="removeAutoIssue('${issue.id}')" title="Odebrat">
                        <span class="material-icons-outlined">close</span>
                    </button>
                </div>
            `).join('');
        }
        
        function removeAutoIssue(issueId) {
            const issue = docCheckState.issues.find(i => i.id === issueId);
            docCheckState.issues = docCheckState.issues.filter(i => i.id !== issueId);
            
            if (issue) {
                const globalIssue = globalIssues.vyzva.find(gi => gi.text === issue.text);
                if (globalIssue) {
                    removeGlobalIssue('vyzva', globalIssue.id);
                }
            }
            
            updateIssuesVisibility();
            updateDokumentaceResult();
        }
        
        function runDocAutoCheck() {
            const btn = document.getElementById('btnRunAutoCheck');
            const desc = document.getElementById('autoCheckDesc');
            const results = document.getElementById('autoCheckResults');
            
            btn.disabled = true;
            btn.classList.add('loading');
            btn.innerHTML = '<span class="material-icons-outlined">sync</span>Probíhá kontrola...';
            
            // Simulace automatické kontroly validátorem BPP
            setTimeout(function() {
                btn.classList.remove('loading');
                btn.innerHTML = '<span class="material-icons-outlined">refresh</span>Znovu kontrolovat';
                btn.disabled = false;
                btn.style.background = '#137333';
                btn.onclick = function() { btn.style.background = ''; runDocAutoCheck(); };
                
                desc.style.display = 'none';
                
                // Reálné výsledky validátoru pro Z/2026/1596
                const validatorResults = [
                    { icon: 'check', cls: 'success', label: 'Celkový počet souborů', detail: '247 souborů v PD balíčku (verze SR00X01HLDRP)' },
                    { icon: 'check', cls: 'success', label: 'Formát PDF/A', detail: '247/247 souborů ve správném formátu' },
                    { icon: 'warning', cls: 'warning', label: 'Elektronické podpisy — Neplatný', 
                      detail: '~12 souborů: chybí podpis nebo EAR na soupisech příloh (přílohy částí A–D)',
                      issueText: 'Uvedl PD do souladu s § 13 písm. b) zák. č. 360/1992 Sb. — soupisy příloh jednotlivých částí PD neobsahují platný elektronický podpis ani elektronické autorizační razítko (EAR)',
                      kategorie: 'autorizace' },
                    { icon: 'warning', cls: 'warning', label: 'Elektronické podpisy — Technicky nevyhovující',
                      detail: '~30 souborů: uzamčené podpisy v sérii PS120211–PS140251 (PDF locked — nelze ověřit platnost)',
                      issueText: 'Uvedl PD do souladu s § 13 písm. b) zák. č. 360/1992 Sb. — v provozních souborech PS 12-02-11 až PS 14-02-51 jsou elektronické podpisy technicky nevyhovující (PDF locked, nelze ověřit platnost)',
                      kategorie: 'autorizace' },
                    { icon: 'warning', cls: 'warning', label: 'Časová razítka',
                      detail: '1 soubor bez časového razítka (A.1_Průvodní zpráva_soupis.pdf)',
                      issueText: 'Uvedl PD do souladu s § 13 písm. b) zák. č. 360/1992 Sb. — soubor A.1_Průvodní zpráva_soupis.pdf nemá připojené kvalifikované elektronické časové razítko',
                      kategorie: 'autorizace' },
                    { icon: 'check', cls: 'success', label: 'Autorizační razítka (EAR)', detail: 'Projektant má platnou autorizaci ČKAIT č. 0123456, obor dopravní stavby' }
                ];
                
                results.classList.add('visible');
                results.innerHTML = validatorResults.map((r, idx) => {
                    const addBtn = r.issueText ? `
                        <button class="validator-add-btn" id="validatorAddBtn${idx}" onclick="addValidatorIssue(${idx})" title="Přidat do výzvy" style="
                            margin-left: auto; display: inline-flex; align-items: center; gap: 4px; padding: 4px 10px;
                            border: 1px solid #c5221f; border-radius: 4px; background: #fff; color: #c5221f;
                            font-size: 11px; cursor: pointer; white-space: nowrap; flex-shrink: 0;
                        ">
                            <span class="material-icons-outlined" style="font-size: 14px;">add_circle</span>
                            Do výzvy
                        </button>
                    ` : '';
                    return `
                        <div class="check-result-item">
                            <div class="check-result-icon ${r.cls}">
                                <span class="material-icons-outlined">${r.icon}</span>
                            </div>
                            <div class="check-result-content" style="flex: 1;">
                                <div class="check-result-label">${r.label}</div>
                                <div class="check-result-detail">${r.detail}</div>
                            </div>
                            ${addBtn}
                        </div>
                    `;
                }).join('');
                
                // Uložit výsledky pro pozdější reference
                docCheckState.validatorResults = validatorResults;
                docCheckState.autoCheckDone = true;
                updateDokumentaceResult();
            }, 2000);
        }
        
        // Přidat zjištění validátoru do výzvy
        function addValidatorIssue(resultIdx) {
            const r = docCheckState.validatorResults[resultIdx];
            if (!r || !r.issueText) return;
            
            const btn = document.getElementById('validatorAddBtn' + resultIdx);
            
            // Zkontrolovat duplicitu
            const exists = docCheckState.issues.some(i => i.text === r.issueText);
            if (exists) {
                if (btn) { btn.innerHTML = '<span class="material-icons-outlined" style="font-size:14px;">check</span>Již přidáno'; btn.disabled = true; btn.style.opacity = '0.5'; }
                return;
            }
            
            const issueId = 'issue-auto-' + Date.now() + '-' + resultIdx;
            docCheckState.issues.push({ 
                id: issueId,
                text: r.issueText, 
                shortText: r.label + ': ' + r.detail,
                source: 'auto',
                kategorie: r.kategorie || 'autorizace'
            });
            
            addGlobalIssue('vyzva', {
                text: r.issueText,
                source: 'auto',
                controlName: 'Automatická kontrola dokumentace',
                kategorie: r.kategorie || 'autorizace',
                pravniPredpis: '§ 13 písm. b) zák. č. 360/1992 Sb.'
            });
            
            if (btn) {
                btn.innerHTML = '<span class="material-icons-outlined" style="font-size:14px;">check</span>Přidáno';
                btn.disabled = true;
                btn.style.background = '#e6f4ea';
                btn.style.color = '#137333';
                btn.style.borderColor = '#137333';
            }
            
            updateIssuesVisibility();
            updateDokumentaceResult();
        }
        
        // Staré funkce - ponechány pro zpětnou kompatibilitu
        function addIssue() {
            // Tato funkce už není používána v novém UI
        }
        
        function addIssueToList(issueText, source = 'manual') {
            // Tato funkce už není používána v novém UI
        }
        
        function removeIssue(issueId) {
            // Tato funkce už není používána v novém UI
        }
        
        function renderIssues() {
            // Nahrazeno funkcí updateIssuesVisibility
            updateIssuesVisibility();
        }
        
        function updateDokumentaceResult() {
            const resultBox = document.getElementById('resultDokumentace');
            const btnConfirm = document.getElementById('btnConfirmDokumentace');
            const issueCount = docCheckState.issues.length;
            const hasProblems = Object.values(docCheckState.partStatus).some(s => s === 'warning' || s === 'error');
            const allChecked = Object.values(docCheckState.partStatus).every(s => s !== 'unchecked');
            
            if (issueCount > 0 || hasProblems) {
                resultBox.className = 'result-preview warning';
                resultBox.innerHTML = `
                    <div class="result-preview-title">
                        <span class="material-icons-outlined">warning</span>
                        Dokumentace vykazuje nedostatky
                    </div>
                    <div class="result-preview-text">
                        Zjištěno ${issueCount} nedostatků. Bude vydána výzva k doplnění a řízení přerušeno.
                    </div>
                `;
            } else if (!allChecked) {
                resultBox.className = 'result-preview neutral';
                resultBox.innerHTML = `
                    <div class="result-preview-title">
                        <span class="material-icons-outlined">info</span>
                        Kontrola nebyla dokončena
                    </div>
                    <div class="result-preview-text">Zkontrolujte všechny části dokumentace kliknutím na zaškrtávátko.</div>
                `;
            } else {
                resultBox.className = 'result-preview positive';
                resultBox.innerHTML = `
                    <div class="result-preview-title">
                        <span class="material-icons-outlined">check_circle</span>
                        Dokumentace v pořádku
                    </div>
                    <div class="result-preview-text">Všechny části dokumentace jsou přítomny a úplné.</div>
                `;
            }
            
            // Tlačítko je vždy "Potvrdit kontrolu"
            btnConfirm.innerHTML = '<span class="material-icons-outlined">check</span>Potvrdit kontrolu';
        }

        // ==========================================
        // DOKLADOVÁ ČÁST - update result
        // ==========================================
        function updateDokladyResult() {
            const vyjadreni = document.querySelector('input[name="vyjadreni_ss"]:checked').value;
            const stanoviska = document.querySelector('input[name="stanoviska_do"]:checked').value;
            const resultBox = document.getElementById('resultDoklady');

            if (vyjadreni === 'kompletni' && stanoviska === 'kompletni') {
                resultBox.className = 'result-preview positive';
                resultBox.innerHTML = `
                    <div class="result-preview-title">
                        <span class="material-icons-outlined">check_circle</span>
                        Dokladová část v pořádku
                    </div>
                    <div class="result-preview-text">Všechna vyjádření a stanoviska jsou k dispozici.</div>
                `;
            } else if (stanoviska === 'zaporne') {
                resultBox.className = 'result-preview negative';
                resultBox.innerHTML = `
                    <div class="result-preview-title">
                        <span class="material-icons-outlined">cancel</span>
                        Záporné stanovisko DO
                    </div>
                    <div class="result-preview-text">Řízení bude zastaveno z důvodu záporného stanoviska dotčeného orgánu.</div>
                `;
            } else if (vyjadreni === 'chybi') {
                resultBox.className = 'result-preview warning';
                resultBox.innerHTML = `
                    <div class="result-preview-title">
                        <span class="material-icons-outlined">warning</span>
                        Chybí vyjádření
                    </div>
                    <div class="result-preview-text">Bude vydána výzva k doplnění a řízení přerušeno.</div>
                `;
            } else if (stanoviska === 'chybi') {
                resultBox.className = 'result-preview warning';
                resultBox.innerHTML = `
                    <div class="result-preview-title">
                        <span class="material-icons-outlined">schedule</span>
                        Chybí stanovisko DO
                    </div>
                    <div class="result-preview-text">SÚ si stanovisko vyžádá. Běží lhůta 30 dnů.</div>
                `;
            }
        }

        // ==========================================
        // KONTROLA SOULADU S ÚPD - ULTRA KOMPAKTNÍ
        // ==========================================
        
        const updState = {
            urp: { checked: false, soulad: null, text: '' },
            zur: { checked: false, soulad: null, text: '' },
            up: { checked: false, soulad: null, text: '', exists: null }
        };
        
        // Layout přepínání
        function setUPDLayout(layout, btn) {
            const overlay = document.getElementById('controlUP');
            
            // Aktualizovat tlačítka
            btn.parentElement.querySelectorAll('.upd-layout-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            
            // Přepnout layout
            if (layout === 'horizontal') {
                overlay.classList.add('layout-horizontal');
            } else {
                overlay.classList.remove('layout-horizontal');
            }
            
            // Reinicializovat viewery po změně layoutu
            setTimeout(() => {
                const situaceImg = document.getElementById('situaceImage');
                const updImg = document.getElementById('updImage');
                if (situaceImg && situaceImg.complete) initViewer('situace');
                if (updImg && updImg.complete) initViewer('upd');
            }, 100);
        }
        
        // Modální dialog pro nesoulad
        let currentNesouladStep = null;
        
        const nesouladLabels = {
            urp: { title: 'Nesoulad s ÚRP', label: 'Popište rozpor s Územním rozvojovým plánem ČR:' },
            zur: { title: 'Nesoulad se ZÚR', label: 'Popište rozpor se Zásadami územního rozvoje:' },
            up: { title: 'Nesoulad s ÚP', label: 'Popište rozpor s Územním plánem obce:' }
        };
        
        function openNesouladModal(step) {
            currentNesouladStep = step;
            const labels = nesouladLabels[step];
            
            document.getElementById('nesouladModalTitle').textContent = labels.title;
            document.getElementById('nesouladModalLabel').textContent = labels.label;
            
            // Načíst existující text
            const existingText = document.getElementById('note' + step.charAt(0).toUpperCase() + step.slice(1))?.value || '';
            document.getElementById('nesouladModalTextarea').value = existingText;
            
            document.getElementById('nesouladModal').classList.add('open');
            document.getElementById('nesouladModalTextarea').focus();
        }
        
        function closeNesouladModal() {
            document.getElementById('nesouladModal').classList.remove('open');
            currentNesouladStep = null;
        }
        
        function saveNesouladModal() {
            if (!currentNesouladStep) return;
            
            const text = document.getElementById('nesouladModalTextarea').value;
            const noteInput = document.getElementById('note' + currentNesouladStep.charAt(0).toUpperCase() + currentNesouladStep.slice(1));
            if (noteInput) {
                noteInput.value = text;
            }
            
            // Aktualizovat indikátor
            const indicator = document.getElementById('indicator' + currentNesouladStep.charAt(0).toUpperCase() + currentNesouladStep.slice(1));
            if (indicator) {
                indicator.classList.toggle('visible', text.trim().length > 0);
                indicator.title = text.trim().length > 0 ? 'Upravit popis nesouladu' : '';
            }
            
            updateUPDState();
            closeNesouladModal();
        }
        
        // Viewer stav pro zoom/pan
        const viewerState = {
            situace: { scale: 1, x: 0, y: 0, isDragging: false, startX: 0, startY: 0 },
            upd: { scale: 1, x: 0, y: 0, isDragging: false, startX: 0, startY: 0 }
        };
        
        // UPD obrázky a iframe
        const updImages = {
            urp: '../images/URP.png'
        };
        
        // ZÚR a ÚP jako iframe (reálné mapové portály KHK)
        const updIframeUrls = {
            zur: 'https://www.khk.cz/oblasti/uzemni-planovani/zasady-uzemniho-rozvoje-kraje-zur/aktualizace/uplne-zneni-zasad-uzemniho-rozvoje-kralovehradeckeho-kraje-po-vydani-aktualizaci-c-1-2-3-4-5',
            up: 'https://up.khk.cz/upd/_mapy/bezesve_akt/?MAP=zd_hlv&lon=15.8403568&lat=50.436676&scale=200000'
        };
        
        const situaceImages = {
            c1: '../images/C-01.png',
            c2: '../images/C-02.png',
            c3: '../images/C-03.png'
        };
        
        function initViewer(viewerId) {
            const container = document.getElementById(viewerId + 'Container');
            const img = document.getElementById(viewerId + 'Image');
            if (!container || !img) return;
            
            // Počkat až je obrázek načtený
            if (!img.complete || !img.naturalWidth) {
                img.onload = () => initViewer(viewerId);
                return;
            }
            
            const state = viewerState[viewerId];
            
            // Počkat na správné rozměry containeru
            const containerRect = container.getBoundingClientRect();
            if (containerRect.width === 0 || containerRect.height === 0) {
                setTimeout(() => initViewer(viewerId), 50);
                return;
            }
            
            const imgRatio = img.naturalWidth / img.naturalHeight;
            const containerRatio = containerRect.width / containerRect.height;
            
            // Fit to container - obrázek celý viditelný
            if (imgRatio > containerRatio) {
                state.scale = containerRect.width / img.naturalWidth;
            } else {
                state.scale = containerRect.height / img.naturalHeight;
            }
            
            // Omezit maximální scale na 1 (nezoomovat nad 100%)
            state.scale = Math.min(state.scale, 1);
            
            // Center image
            state.x = (containerRect.width - img.naturalWidth * state.scale) / 2;
            state.y = (containerRect.height - img.naturalHeight * state.scale) / 2;
            
            updateViewerTransform(viewerId);
            
            // Zobrazit obrázek po inicializaci
            img.classList.add('loaded');
            
            // Mouse events - přidat pouze jednou
            if (!container.dataset.eventsAttached) {
                container.onmousedown = (e) => startDrag(e, viewerId);
                container.onmousemove = (e) => drag(e, viewerId);
                container.onmouseup = () => endDrag(viewerId);
                container.onmouseleave = () => endDrag(viewerId);
                container.onwheel = (e) => handleWheel(e, viewerId);
                container.dataset.eventsAttached = 'true';
            }
        }
        
        function updateViewerTransform(viewerId) {
            const img = document.getElementById(viewerId + 'Image');
            const state = viewerState[viewerId];
            if (img) {
                img.style.transform = `translate(${state.x}px, ${state.y}px) scale(${state.scale})`;
            }
        }
        
        function startDrag(e, viewerId) {
            const state = viewerState[viewerId];
            state.isDragging = true;
            state.startX = e.clientX - state.x;
            state.startY = e.clientY - state.y;
            e.preventDefault();
        }
        
        function drag(e, viewerId) {
            const state = viewerState[viewerId];
            if (!state.isDragging) return;
            state.x = e.clientX - state.startX;
            state.y = e.clientY - state.startY;
            updateViewerTransform(viewerId);
        }
        
        function endDrag(viewerId) {
            viewerState[viewerId].isDragging = false;
        }
        
        function handleWheel(e, viewerId) {
            e.preventDefault();
            const state = viewerState[viewerId];
            const container = document.getElementById(viewerId + 'Container');
            const rect = container.getBoundingClientRect();
            
            const mouseX = e.clientX - rect.left;
            const mouseY = e.clientY - rect.top;
            
            const delta = e.deltaY > 0 ? -0.1 : 0.1;
            const newScale = Math.max(0.1, Math.min(5, state.scale + delta));
            
            // Zoom towards mouse position
            const scaleRatio = newScale / state.scale;
            state.x = mouseX - (mouseX - state.x) * scaleRatio;
            state.y = mouseY - (mouseY - state.y) * scaleRatio;
            state.scale = newScale;
            
            updateViewerTransform(viewerId);
        }
        
        function zoomViewer(viewerId, delta) {
            const state = viewerState[viewerId];
            const container = document.getElementById(viewerId + 'Container');
            const rect = container.getBoundingClientRect();
            
            const centerX = rect.width / 2;
            const centerY = rect.height / 2;
            
            const newScale = Math.max(0.1, Math.min(5, state.scale + delta));
            const scaleRatio = newScale / state.scale;
            
            state.x = centerX - (centerX - state.x) * scaleRatio;
            state.y = centerY - (centerY - state.y) * scaleRatio;
            state.scale = newScale;
            
            updateViewerTransform(viewerId);
        }
        
        function resetViewer(viewerId) {
            const img = document.getElementById(viewerId + 'Image');
            if (img && img.complete) {
                initViewer(viewerId);
            }
        }
        
        function openImageFullscreen(viewerId) {
            if (viewerId === 'upd') {
                // Zkontrolovat, zda je aktivní ZÚR nebo ÚP tab (iframe)
                const activeTab = document.querySelector('#updMapViewer').closest('.upd-viewer-panel').querySelector('.upd-vtab.active');
                if (activeTab) {
                    const tabText = activeTab.textContent.trim();
                    if (tabText === 'ÚP' && updIframeUrls.up) {
                        window.open(updIframeUrls.up, '_blank');
                        return;
                    }
                    if (tabText === 'ZÚR' && updIframeUrls.zur) {
                        window.open(updIframeUrls.zur, '_blank');
                        return;
                    }
                }
            }
            const img = document.getElementById(viewerId + 'Image');
            if (img) {
                window.open(img.src, '_blank');
            }
        }
        
        function switchSituaceTab(btn, tab) {
            btn.parentElement.querySelectorAll('.upd-vtab').forEach(t => t.classList.remove('active'));
            btn.classList.add('active');
            
            const img = document.getElementById('situaceImage');
            if (img && situaceImages[tab]) {
                img.classList.remove('loaded');
                img.onload = () => initViewer('situace');
                img.src = situaceImages[tab];
            }
        }
        
        function switchUPDMap(type, btn) {
            btn.parentElement.querySelectorAll('.upd-vtab').forEach(t => t.classList.remove('active'));
            btn.classList.add('active');
            
            const viewer = document.getElementById('updMapViewer');
            const panel = viewer.closest('.upd-viewer-panel');
            const zoomControls = panel.querySelector('.upd-zoom-controls');
            
            if (type === 'zur' || type === 'up') {
                // ZÚR a ÚP jako iframe (reálné webové portály KHK)
                const iframeUrl = updIframeUrls[type];
                const label = type === 'zur' ? 'Zásady územního rozvoje KHK' : 'Územní plán — bezešvá mapa KHK';
                viewer.innerHTML = `
                    <iframe src="${iframeUrl}" 
                            style="width: 100%; height: 100%; border: none;"
                            allow="geolocation"
                            id="upIframe"></iframe>
                    <div class="upd-iframe-fallback" id="iframeFallback" style="display: none;">
                        <span class="material-icons-outlined">block</span>
                        <span>Web neumožňuje vložení</span>
                        <a href="${iframeUrl}" target="_blank" class="upd-link">Otevřít v novém okně ↗</a>
                    </div>
                `;
                // Skrýt zoom controls pro iframe
                zoomControls.style.display = 'none';
            } else {
                // ÚRP jako obrázek
                const existingImg = document.getElementById('updImage');
                if (!existingImg) {
                    viewer.innerHTML = `
                        <div class="upd-image-container" id="updContainer">
                            <img src="${updImages[type]}" alt="${type.toUpperCase()}" id="updImage" 
                                 draggable="false" onload="initViewer('upd')">
                        </div>
                    `;
                } else {
                    existingImg.classList.remove('loaded');
                    existingImg.onload = () => initViewer('upd');
                    existingImg.src = updImages[type];
                }
                // Zobrazit zoom controls
                zoomControls.style.display = 'flex';
            }
        }
        
        function setUPDSoulad(step, soulad, btn) {
            updState[step].checked = true;
            updState[step].soulad = soulad;
            
            // Aktualizovat tlačítka
            const parent = btn.closest('.upd-check-buttons');
            parent.querySelectorAll('button').forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
            
            // Zobrazit/skrýt textarea pro nesoulad (vertikální layout)
            const noteInput = document.getElementById('note' + step.charAt(0).toUpperCase() + step.slice(1));
            if (noteInput) {
                noteInput.style.display = soulad ? 'none' : 'block';
            }
            
            // Aktualizovat/skrýt indikátor nesouladu
            const indicator = document.getElementById('indicator' + step.charAt(0).toUpperCase() + step.slice(1));
            if (indicator && soulad) {
                indicator.classList.remove('visible');
            }
            
            // Aktualizovat stav položky
            const checkItem = document.getElementById('check' + step.charAt(0).toUpperCase() + step.slice(1));
            checkItem.classList.remove('done-ok', 'done-error');
            checkItem.classList.add(soulad ? 'done-ok' : 'done-error');
            
            // Aktualizovat status
            const statusEl = document.getElementById('status' + step.charAt(0).toUpperCase() + step.slice(1));
            statusEl.textContent = soulad ? '✓' : '✗';
            statusEl.classList.remove('ok', 'error');
            statusEl.classList.add(soulad ? 'ok' : 'error');
            
            // Při nesouladu v horizontálním layoutu otevřít modal
            if (!soulad) {
                const isHorizontal = document.getElementById('controlUP').classList.contains('layout-horizontal');
                if (isHorizontal) {
                    openNesouladModal(step);
                } else if (noteInput) {
                    noteInput.focus();
                }
            }
            
            updateUPDState();
        }
        
        function setUPExistence(exists, btn) {
            updState.up.exists = exists;
            
            // Aktualizovat tlačítka
            const parent = btn.closest('.upd-check-buttons');
            parent.querySelectorAll('button').forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
            
            // Zobrazit/skrýt relevantní sekce
            const souladSection = document.getElementById('upSouladSection');
            const noUpInfo = document.getElementById('noUpInfo');
            
            if (exists) {
                souladSection.style.display = 'block';
                noUpInfo.style.display = 'none';
            } else {
                souladSection.style.display = 'none';
                noUpInfo.style.display = 'block';
                // Při neexistenci ÚP je kontrola hotová
                updState.up.checked = true;
                updState.up.soulad = true;
                
                // Aktualizovat vizuální stav
                const checkItem = document.getElementById('checkUp');
                checkItem.classList.add('done-ok');
                const statusEl = document.getElementById('statusUp');
                statusEl.textContent = 'N/A';
                statusEl.classList.add('ok');
            }
            
            updateUPDState();
        }
        
        function updateUPDState() {
            // Aktualizovat tlačítko potvrzení
            const btn = document.getElementById('btnConfirmUPD');
            if (!btn) return;
            
            const allChecked = updState.urp.checked && updState.zur.checked && updState.up.checked;
            const hasNesoulad = (updState.urp.checked && !updState.urp.soulad) || 
                               (updState.zur.checked && !updState.zur.soulad) || 
                               (updState.up.checked && !updState.up.soulad);
            
            // Kontrola vyplnění zdůvodnění nesouladů + aktualizace indikátorů
            let nesouladTextsOk = true;
            ['urp', 'zur', 'up'].forEach(step => {
                const noteValue = document.getElementById('note' + step.charAt(0).toUpperCase() + step.slice(1))?.value?.trim() || '';
                const indicator = document.getElementById('indicator' + step.charAt(0).toUpperCase() + step.slice(1));
                
                const needsText = !updState[step].soulad && updState[step].checked && (step !== 'up' || updState.up.exists !== false);
                
                if (needsText) {
                    if (!noteValue) nesouladTextsOk = false;
                    // Zobrazit indikátor pokud je text vyplněn
                    if (indicator) {
                        indicator.classList.toggle('visible', noteValue.length > 0);
                    }
                } else {
                    if (indicator) indicator.classList.remove('visible');
                }
            });
            
            const canConfirm = allChecked && (!hasNesoulad || nesouladTextsOk);
            btn.disabled = !canConfirm;
            
            if (hasNesoulad && allChecked) {
                btn.innerHTML = '<span class="material-icons-outlined">gavel</span> Zamítnout';
            } else {
                btn.innerHTML = '<span class="material-icons-outlined">check</span> Potvrdit kontrolu';
            }
        }
        
        function completeUPD() {
            const hasNesoulad = (updState.urp.checked && !updState.urp.soulad) || 
                               (updState.zur.checked && !updState.zur.soulad) || 
                               (updState.up.checked && !updState.up.soulad);
            
            // Sesbírat texty nesouladů
            let nesouladTexts = [];
            if (!updState.urp.soulad && updState.urp.checked) {
                const text = document.getElementById('noteUrp')?.value || '';
                if (text) nesouladTexts.push('ÚRP: ' + text);
            }
            if (!updState.zur.soulad && updState.zur.checked) {
                const text = document.getElementById('noteZur')?.value || '';
                if (text) nesouladTexts.push('ZÚR: ' + text);
            }
            if (!updState.up.soulad && updState.up.checked && updState.up.exists !== false) {
                const text = document.getElementById('noteUp')?.value || '';
                if (text) nesouladTexts.push('ÚP: ' + text);
            }
            
            controls.up.done = true;
            controls.up.result = hasNesoulad ? 'warning' : 'ok';
            
            // Přidat nesoulady do globálních issues
            if (hasNesoulad && nesouladTexts.length > 0) {
                addGlobalIssue('vyzva', {
                    text: 'Nesoulad s ÚPD:\n' + nesouladTexts.join('\n'),
                    source: 'upd-control',
                    controlName: 'Soulad s ÚPD'
                });
            }
            
            updateUI();
            closeControl('controlUP');
            
            // Zobrazit toast
            if (hasNesoulad) {
                showToast('Kontrola dokončena — zjištěn nesoulad s ÚPD', 'warning');
            } else {
                showToast('Kontrola dokončena — záměr je v souladu s ÚPD', 'success');
            }
        }

        // ==========================================
        // ZRYCHLENÉ ŘÍZENÍ - update result
        // ==========================================
        function updateZrychleneResult() {
            const checkboxes = document.querySelectorAll('#controlZrychlene input[type="checkbox"]');
            let allChecked = true;
            
            checkboxes.forEach(cb => {
                const option = cb.closest('.control-option');
                if (cb.checked) {
                    option.classList.add('selected');
                } else {
                    option.classList.remove('selected');
                    allChecked = false;
                }
            });

            const resultBox = document.getElementById('resultZrychlene');
            if (allChecked) {
                resultBox.className = 'result-preview positive';
                resultBox.innerHTML = `
                    <div class="result-preview-title">
                        <span class="material-icons-outlined">check_circle</span>
                        Podmínky splněny
                    </div>
                    <div class="result-preview-text">Všechny podmínky pro zrychlené řízení jsou splněny.</div>
                `;
            } else {
                resultBox.className = 'result-preview warning';
                resultBox.innerHTML = `
                    <div class="result-preview-title">
                        <span class="material-icons-outlined">warning</span>
                        Podmínky nesplněny
                    </div>
                    <div class="result-preview-text">Řízení bude vedeno standardním způsobem.</div>
                `;
            }
        }

        // ==========================================
        // INFO PANEL UPDATE
        // ==========================================
        function updateInfoPanel() {
            const infoPanel = document.getElementById('infoPanel');
            
            // Zkontroluj stav příslušnosti
            if (controls.prislusnost.done && controls.prislusnost.result === 'neprislusny') {
                const postoupit = controls.prislusnost.postoupit;
                let suNazev = 'příslušnému stavebnímu úřadu';
                
                if (postoupit) {
                    const info = postoupit.info.split('|');
                    suNazev = info[0];
                }
                
                infoPanel.className = 'info-panel error';
                infoPanel.innerHTML = `
                    <span class="material-icons-outlined">send</span>
                    <div class="info-panel-content">
                        <div class="info-panel-title">Řízení bude postoupeno</div>
                        <div class="info-panel-text">
                            Stavební úřad není příslušný. Řízení bude postoupeno: <strong>${suNazev}</strong>.<br>
                            Další kontroly nejsou vyžadovány.
                        </div>
                    </div>
                `;
                return;
            }

            // Zkontroluj stav dokumentace
            if (controls.dokumentace.done && controls.dokumentace.result === 'vady') {
                infoPanel.className = 'info-panel warning';
                infoPanel.innerHTML = `
                    <span class="material-icons-outlined">warning</span>
                    <div class="info-panel-content">
                        <div class="info-panel-title">Dokumentace vykazuje vady</div>
                        <div class="info-panel-text">
                            Bude vydána výzva k doplnění a řízení přerušeno. Po odstranění vad pokračujte v kontrolách.
                        </div>
                    </div>
                `;
                return;
            }

            // Zkontroluj vady žádosti
            if (controls.zadost.done && controls.zadost.result === 'vady') {
                infoPanel.className = 'info-panel warning';
                infoPanel.innerHTML = `
                    <span class="material-icons-outlined">mail</span>
                    <div class="info-panel-content">
                        <div class="info-panel-title">Žádost vykazuje vady</div>
                        <div class="info-panel-text">
                            Bude vydána výzva k odstranění vad (§ 185 odst. 2) a řízení přerušeno do 10 dnů od zahájení.
                            Můžete pokračovat v kontrolách nebo rovnou vydat výzvu.
                        </div>
                    </div>
                `;
                return;
            }

            // Zkontroluj chybějící vyjádření VTI/VDI (vada žádosti)
            if (controls.identifikace.done && controls.identifikace.result === 'vady') {
                const pocet = controls.identifikace.chybiVTI_VDI ? controls.identifikace.chybiVTI_VDI.length : 0;
                infoPanel.className = 'info-panel warning';
                infoPanel.innerHTML = `
                    <span class="material-icons-outlined">warning</span>
                    <div class="info-panel-content">
                        <div class="info-panel-title">Chybí vyjádření vlastníků sítí</div>
                        <div class="info-panel-text">
                            Chybí ${pocet} ${pocet === 1 ? 'vyjádření' : 'vyjádření'} VTI/VDI. Jedná se o vadu žádosti.<br>
                            Bude vydána výzva k doplnění stavebníkovi.
                        </div>
                    </div>
                `;
                return;
            }

            // Zkontroluj chybějící stanoviska DO (SÚ si vyžádá sám)
            if (controls.identifikace.done && controls.identifikace.result === 'vyzidat_do') {
                const pocet = controls.identifikace.chybiDO ? controls.identifikace.chybiDO.length : 0;
                const doNames = controls.identifikace.chybiDO ? controls.identifikace.chybiDO.join(', ') : '';
                infoPanel.className = 'info-panel schedule';
                infoPanel.innerHTML = `
                    <span class="material-icons-outlined">schedule_send</span>
                    <div class="info-panel-content">
                        <div class="info-panel-title">Vyžádat závazná stanoviska DO</div>
                        <div class="info-panel-text">
                            Chybí ${pocet} závazné ${pocet === 1 ? 'stanovisko' : 'stanoviska'} DO: <strong>${doNames}</strong>.<br>
                            SÚ si stanoviska vyžádá. Staví se lhůta pro rozhodnutí. DO mají 30 dnů na vydání stanoviska.
                        </div>
                    </div>
                `;
                return;
            }

            // Standardní stav
            infoPanel.className = 'info-panel';
            infoPanel.innerHTML = `
                <span class="material-icons-outlined">info</span>
                <div class="info-panel-content">
                    <div class="info-panel-title">Kontrola a příprava řízení</div>
                    <div class="info-panel-text">
                        V tomto kroku proveďte kontroly žádosti a definujte parametry řízení (účastníci, pozemky, dotčené orgány). 
                        Řízení je zahájeno dnem doručení bezvadné žádosti (6. 1. 2026), od tohoto data běží lhůta pro vydání rozhodnutí.
                    </div>
                </div>
            `;
        }

        // ==========================================
        // UPDATE UI
        // ==========================================
        function updateUI() {
            let completedCount = 0;
            const totalCount = Object.keys(controls).length;
            const isPrislusny = !controls.prislusnost.done || controls.prislusnost.result === 'ok';
            
            // Kontrola, zda jsou zjištěny vady (pro tlačítko Výzva k doplnění)
            const hasVady = Object.values(controls).some(c => c.done && (c.result === 'vady' || c.result === 'warning'));

            for (const [key, control] of Object.entries(controls)) {
                const card = document.getElementById('card-' + key);
                if (!card) continue;
                
                // Kontroly s vadami neblokují ostatní kontroly - stačí že jsou done
                let dependenciesMet = control.depends.every(dep => controls[dep].done);
                
                // Pokud SÚ není příslušný, nic dalšího nelze dělat
                if (!isPrislusny && key !== 'prislusnost') {
                    dependenciesMet = false;
                }

                // Remove all status classes
                card.classList.remove('status-waiting', 'status-ready', 'status-done', 'status-warning', 'status-error', 'disabled');

                if (control.done) {
                    if (control.result === 'ok') {
                        card.classList.add('status-done');
                    } else if (control.result === 'vady' || control.result === 'warning') {
                        card.classList.add('status-warning');
                    } else {
                        card.classList.add('status-error');
                    }
                    completedCount++;
                    updateCardContent(key, 'done');
                } else if (dependenciesMet) {
                    card.classList.add('status-ready');
                    updateCardContent(key, 'ready');
                } else {
                    card.classList.add('status-waiting', 'disabled');
                    updateCardContent(key, 'waiting');
                }
            }

            // Update progress
            document.getElementById('progressText').textContent = completedCount + ' z ' + totalCount + ' kontrol';
            document.getElementById('progressFill').style.width = (completedCount / totalCount * 100) + '%';

            // Update info panel
            updateInfoPanel();

            // Update summary
            const allDone = Object.values(controls).every(c => c.done);
            const allOk = Object.values(controls).every(c => c.result === 'ok');
            const hasBlocking = Object.values(controls).some(c => c.done && c.result === 'error');
            
            if (!isPrislusny) {
                document.getElementById('summaryTitle').textContent = 'Stavební úřad není příslušný';
                document.getElementById('summaryDesc').textContent = 'Řízení bude postoupeno příslušnému stavebnímu úřadu.';
                document.getElementById('btnZahajit').disabled = false;
                document.getElementById('btnZahajit').innerHTML = '<span class="material-icons-outlined">send</span>Postoupit řízení';
                _btnAction = 'postoupit';
            } else if (allDone && allOk) {
                document.getElementById('summaryTitle').textContent = 'Všechny kontroly dokončeny';
                document.getElementById('summaryDesc').textContent = 'Řízení je připraveno k zahájení. Lhůta začne běžet od 6. 1. 2026.';
                document.getElementById('btnZahajit').disabled = false;
                document.getElementById('btnZahajit').innerHTML = '<span class="material-icons-outlined">play_circle</span>Zahájit řízení';
                _btnAction = 'zahajit';
            } else if (allDone && hasVady && !hasBlocking) {
                // Všechny kontroly hotové, ale jsou vady - nabídnout Výzvu k doplnění
                document.getElementById('summaryTitle').textContent = 'Zjištěny nedostatky v žádosti';
                document.getElementById('summaryDesc').textContent = 'Kontroly dokončeny. Žádost vykazuje nedostatky, bude vydána výzva k doplnění.';
                document.getElementById('btnZahajit').disabled = false;
                document.getElementById('btnZahajit').innerHTML = '<span class="material-icons-outlined">mail</span>Vydat výzvu k doplnění';
                _btnAction = 'vyzva';
            } else if (hasVady) {
                // Jsou vady, ale ne všechny kontroly hotové
                const remaining = Object.values(controls).filter(c => !c.done).length;
                document.getElementById('summaryTitle').textContent = 'Zjištěny nedostatky';
                document.getElementById('summaryDesc').textContent = 'Zjištěny nedostatky. Zbývá ' + remaining + ' kontrol. Dokončete kontroly nebo vydejte výzvu.';
                document.getElementById('btnZahajit').disabled = false;
                document.getElementById('btnZahajit').innerHTML = '<span class="material-icons-outlined">mail</span>Vydat výzvu k doplnění';
                _btnAction = 'vyzva';
            } else if (hasBlocking) {
                document.getElementById('summaryTitle').textContent = 'Řízení nelze pokračovat';
                document.getElementById('summaryDesc').textContent = 'Některé kontroly blokují pokračování řízení.';
                document.getElementById('btnZahajit').disabled = true;
                document.getElementById('btnZahajit').innerHTML = '<span class="material-icons-outlined">block</span>Řízení blokováno';
                _btnAction = 'disabled';
            } else {
                document.getElementById('summaryTitle').textContent = 'Dokončete všechny kontroly';
                const remaining = Object.values(controls).filter(c => !c.done).length;
                document.getElementById('summaryDesc').textContent = 'Zbývá ' + remaining + ' kontrol k dokončení.';
                document.getElementById('btnZahajit').disabled = true;
                document.getElementById('btnZahajit').innerHTML = '<span class="material-icons-outlined">play_circle</span>Zahájit řízení';
                _btnAction = 'disabled';
            }
            
            // Aktualizovat stav kontroly Zrychlené řízení
            updateZrychleneRizeniState();
        }

        function updateCardContent(key, status) {
            const card = document.getElementById('card-' + key);
            const statusBadge = card.querySelector('.control-card-status');
            const actionBtn = card.querySelector('.control-card-action');

            const config = {
                prislusnost: { controlId: 'controlPrislusnost', readyText: 'Provést kontrolu', doneText: 'Příslušný', doneTextNeg: 'Nepříslušný' },
                zadost: { controlId: 'controlZadost', readyText: 'Zkontrolovat žádost', doneText: 'Úplná', doneTextNeg: 'Odložení' },
                dokumentace: { controlId: 'controlDokumentace', readyText: 'Provést kontrolu', doneText: 'V pořádku', doneTextNeg: 'Vykazuje vady' },
                pozemky: { controlId: 'controlPozemky', readyText: 'Identifikovat pozemky', doneText: 'Identifikováno', doneTextNeg: 'Identifikováno' },
                up: { controlId: 'controlUP', readyText: 'Provést kontrolu', doneText: 'V souladu', doneTextNeg: 'Nesoulad' },
                identifikace: { controlId: 'controlIdentifikace', readyText: 'Provést kontrolu', doneText: 'V pořádku', doneTextNeg: 'Chybí doklady' },
                ucastnici: { controlId: 'controlUcastnici', readyText: 'Definovat osoby', doneText: 'Kompletní', doneTextNeg: 'Kompletní' },
                zrychlene: { controlId: 'controlZrychlene', readyText: 'Ověřit podmínky', doneText: 'Splněno', doneTextNeg: 'Nesplněno' }
            };

            const ctrl = controls[key];
            const cfg = config[key];

            if (status === 'done') {
                if (ctrl.result === 'ok') {
                    statusBadge.textContent = 'Hotovo';
                    actionBtn.innerHTML = '<span class="material-icons-outlined">check_circle</span>' + cfg.doneText;
                } else if (ctrl.result === 'vady' || ctrl.result === 'warning') {
                    statusBadge.textContent = 'Vady';
                    actionBtn.innerHTML = '<span class="material-icons-outlined">warning</span>' + cfg.doneTextNeg;
                } else {
                    statusBadge.textContent = 'Blokuje';
                    actionBtn.innerHTML = '<span class="material-icons-outlined">cancel</span>' + cfg.doneTextNeg;
                }
                actionBtn.onclick = function() { openControl(cfg.controlId); };
            } else if (status === 'ready') {
                statusBadge.textContent = 'K provedení';
                actionBtn.innerHTML = '<span class="material-icons-outlined">play_arrow</span>' + cfg.readyText;
                actionBtn.onclick = function() { openControl(cfg.controlId); };
            } else {
                statusBadge.textContent = 'Čeká';
                const waitingOn = ctrl.depends.find(dep => !controls[dep].done);
                const waitingText = {
                    prislusnost: 'Nejprve příslušnost',
                    dokumentace: 'Nejprve dokumentace',
                    pozemky: 'Nejprve pozemky',
                    identifikace: 'Nejprve identifikace',
                    doklady: 'Nejprve doklady',
                    up: 'Nejprve územní plán',
                    ucastnici: 'Nejprve osoby'
                };
                actionBtn.innerHTML = '<span class="material-icons-outlined">lock</span>' + (waitingText[waitingOn] || 'Nejprve ostatní kontroly');
                actionBtn.onclick = null;
            }
        }

        // ==========================================
        // COMPLETE CONTROL FUNCTIONS
        // ==========================================
        function completePrislusnost() {
            const prislusnost = document.querySelector('input[name="prislusnost"]:checked').value;
            
            controls.prislusnost.done = true;
            
            if (prislusnost === 'neprislusny') {
                controls.prislusnost.result = 'neprislusny';
                const selectedValue = document.getElementById('postoupitSuSelect').value;
                const selectedOption = document.querySelector(`#postoupitSuDropdown .su-dropdown-option[data-value="${selectedValue}"]`);
                
                if (selectedOption) {
                    controls.prislusnost.postoupit = {
                        nazev: selectedOption.querySelector('.su-option-name').textContent,
                        typSu: selectedOption.getAttribute('data-type'),
                        info: selectedOption.getAttribute('data-info')
                    };
                }
            } else {
                controls.prislusnost.result = 'ok';
                controls.prislusnost.postoupit = null;
            }
            
            closeControl('controlPrislusnost');
            updateUI();
        }
        
        // Zobrazení modálu pro postoupení řízení
        function showPostoupeniModal() {
            const zduvodneni = document.getElementById('zduvodneniNeprislusnosti').value.trim();
            const selectedValue = document.getElementById('postoupitSuSelect').value;
            const selectedOption = document.querySelector(`#postoupitSuDropdown .su-dropdown-option[data-value="${selectedValue}"]`);
            
            let suNazev = '';
            let suAdresa = '';
            
            if (selectedOption) {
                const info = selectedOption.getAttribute('data-info').split('|');
                suNazev = info[0];
                suAdresa = info[1];
            }
            
            // Naplnit modál
            document.getElementById('postoupeniSuNazev').textContent = suNazev;
            document.getElementById('postoupeniSuAdresa').textContent = suAdresa;
            document.getElementById('postoupeniZduvodneni').textContent = zduvodneni;
            
            // Zavřít kontrolu a otevřít modál
            closeControl('controlPrislusnost');
            openModal('postoupeniModal');
        }
        
        // Potvrzení postoupení řízení
        function confirmPostoupeni() {
            const zduvodneni = document.getElementById('zduvodneniNeprislusnosti').value.trim();
            const selectedValue = document.getElementById('postoupitSuSelect').value;
            const selectedOption = document.querySelector(`#postoupitSuDropdown .su-dropdown-option[data-value="${selectedValue}"]`);
            
            controls.prislusnost.done = true;
            controls.prislusnost.result = 'neprislusny';
            
            if (selectedOption) {
                const typSu = selectedOption.getAttribute('data-type');
                controls.prislusnost.postoupit = {
                    nazev: selectedOption.querySelector('.su-option-name').textContent,
                    typSu: typSu,
                    info: selectedOption.getAttribute('data-info'),
                    zduvodneni: zduvodneni
                };
            }
            
            // Přidat do globálního seznamu nedostatků (typ: postoupení)
            addGlobalIssue('postoupeni', {
                text: 'SÚ není příslušný - řízení postoupeno',
                source: 'auto',
                controlName: 'Kontrola příslušnosti'
            });
            
            closeModal('postoupeniModal', null);
            
            // Zobrazit potvrzení
            showPostoupeniConfirmation();
        }
        
        // Zobrazení potvrzení o postoupení
        function showPostoupeniConfirmation() {
            const info = controls.prislusnost.postoupit.info.split('|');
            const nazev = info[0];
            
            // Vytvořit jednoduchý confirmation toast/banner
            const banner = document.createElement('div');
            banner.className = 'confirmation-banner';
            banner.style.cssText = `
                position: fixed;
                top: 80px;
                left: 50%;
                transform: translateX(-50%);
                background: #137333;
                color: #fff;
                padding: 16px 24px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.2);
                z-index: 3000;
                display: flex;
                align-items: center;
                gap: 12px;
                font-size: 14px;
                animation: slideDown 0.3s ease;
            `;
            banner.innerHTML = `
                <span class="material-icons-outlined" style="font-size: 24px;">check_circle</span>
                <div>
                    <div style="font-weight: 500;">Řízení bylo postoupeno</div>
                    <div style="font-size: 12px; opacity: 0.9; margin-top: 2px;">${nazev}</div>
                </div>
            `;
            
            document.body.appendChild(banner);
            
            // Odstranit po 5 sekundách
            setTimeout(() => {
                banner.style.animation = 'slideUp 0.3s ease';
                setTimeout(() => banner.remove(), 300);
            }, 5000);
            
            updateUI();
        }

        function completeDokumentace() {
            controls.dokumentace.done = true;
            
            const hasProblems = Object.values(docCheckState.partStatus).some(s => s === 'error');
            
            if (docCheckState.issues.length > 0 || hasProblems) {
                controls.dokumentace.result = 'vady';
                controls.dokumentace.issues = [...docCheckState.issues];
            } else {
                controls.dokumentace.result = 'ok';
                controls.dokumentace.issues = [];
            }
            
            // Propagace — odebrat staré issues z této kontroly (idempotentní)
            // Poznámka: jednotlivé nedostatky se přidávají průběžně v addPartIssue/addValidatorIssue,
            // takže zde jen odebereme ty, co uživatel mezitím smazal
            const currentIssueTexts = new Set(docCheckState.issues.map(i => i.text));
            globalIssues.vyzva = globalIssues.vyzva.filter(gi => {
                if (gi.controlName === 'Kontrola dokumentace' || gi.controlName === 'Automatická kontrola dokumentace') {
                    return currentIssueTexts.has(gi.text) || currentIssueTexts.has(gi.hlavniText);
                }
                return true;
            });
            updateGlobalIssuesBadge();
            renderGlobalIssues();
            
            closeControl('controlDokumentace');
            updateUI();
        }

        // ==========================================
        // DOKLADOVÁ ČÁST - DO, VTI, VDI
        // ==========================================
        let identifikaceState = {
            aiAnalyzaDone: false,
            editingSubjektIndex: null,
            subjekty: [
                // Prázdné — subjekty se načtou AI analýzou dokladové části
            ]
        };

        // Inicializace renderování při otevření
        function initIdentifikaceMatrix() {
            renderIdentifikaceMatrix();
            updateIdentifikaceResult();
            updateSouhrnRozhodnuti();
        }

        function renderIdentifikaceMatrix() {
            const groups = {
                do: { container: document.getElementById('matrixDO'), countEl: document.getElementById('countDO'), items: [] },
                vti: { container: document.getElementById('matrixVTI'), countEl: document.getElementById('countVTI'), items: [] },
                vdi: { container: document.getElementById('matrixVDI'), countEl: document.getElementById('countVDI'), items: [] }
            };

            // Rozdělit subjekty do skupin
            identifikaceState.subjekty.forEach((s, index) => {
                if (groups[s.typ]) {
                    groups[s.typ].items.push({ ...s, index });
                }
            });

            // Prázdný stav — před AI analýzou
            if (identifikaceState.subjekty.length === 0) {
                const emptyHtml = `
                    <div style="text-align: center; padding: 24px; color: #9aa0a6; font-size: 13px;">
                        <span class="material-icons-outlined" style="font-size: 28px; display: block; margin-bottom: 8px;">search_off</span>
                        Spusťte AI analýzu pro načtení dokladů z přílohy žádosti
                    </div>
                `;
                for (const [typ, group] of Object.entries(groups)) {
                    group.countEl.textContent = '0';
                    group.container.innerHTML = emptyHtml;
                }
                return;
            }

            // Renderovat každou skupinu
            for (const [typ, group] of Object.entries(groups)) {
                group.countEl.textContent = group.items.length;
                
                let html = '';
                group.items.forEach(s => {
                    const rowClass = getRowStatusClass(s);
                    
                    // Sloupec Žádost
                    const zeZadostiCheck = s.zeZadosti 
                        ? '<div class="matrix-check yes"><span class="material-icons-outlined">check</span></div>'
                        : '<div class="matrix-check no"><span class="material-icons-outlined">remove</span></div>';
                    
                    // Sloupec Přiloženo
                    let prilozenoCheck;
                    if (s.prilozeno) {
                        prilozenoCheck = '<div class="matrix-check yes"><span class="material-icons-outlined">check</span></div>';
                    } else if (identifikaceState.aiAnalyzaDone) {
                        prilozenoCheck = '<div class="matrix-check missing"><span class="material-icons-outlined">close</span></div>';
                    } else {
                        prilozenoCheck = '<div class="matrix-check no"><span class="material-icons-outlined">remove</span></div>';
                    }

                    // Sloupec Výsledek
                    let vysledekHtml = '';
                    if (s.prilozeno) {
                        const vysledekClass = s.vysledek === 'kladne' ? 'kladne' : (s.vysledek === 'kladne_s_podminkami' ? 's-podminkami' : (s.vysledek === 'zaporne' ? 'zaporne' : ''));
                        vysledekHtml = `
                            <select class="matrix-vysledek-select ${vysledekClass}" onchange="setVysledek(${s.index}, this.value)">
                                <option value="" ${!s.vysledek ? 'selected' : ''}>—</option>
                                <option value="kladne" ${s.vysledek === 'kladne' ? 'selected' : ''}>Kladné</option>
                                <option value="kladne_s_podminkami" ${s.vysledek === 'kladne_s_podminkami' ? 'selected' : ''}>S podmínkami</option>
                                <option value="zaporne" ${s.vysledek === 'zaporne' ? 'selected' : ''}>Záporné</option>
                            </select>
                        `;
                    } else {
                        vysledekHtml = '<span style="color: #9aa0a6; font-size: 11px;">—</span>';
                    }

                    // Sloupec Podmínky
                    let podminkyHtml = '';
                    if (s.prilozeno) {
                        const pocetPodminek = s.podminky.filter(p => p.aktivni).length;
                        const hasClass = pocetPodminek > 0 ? 'has-podminky' : '';
                        podminkyHtml = `
                            <button class="btn-podminky ${hasClass}" onclick="openPodminkyModal(${s.index})">
                                <span class="material-icons-outlined">edit_note</span>
                                <span class="podminky-count">${pocetPodminek}</span>
                            </button>
                        `;
                    } else {
                        podminkyHtml = '<span style="color: #9aa0a6; font-size: 11px;">—</span>';
                    }
                    
                    // Poznámka/varování pod řádkem
                    let poznamkaHtml = '';
                    if (s.poznamka) {
                        const isWarning = s.poznamka.includes('POZOR') || s.poznamka.includes('vypršela') || s.poznamka.includes('nelze považovat') || s.poznamka.includes('chybí zcela');
                        const warnColor = isWarning ? '#ea8600' : '#5f6368';
                        const warnIcon = isWarning ? 'warning' : 'info';
                        poznamkaHtml = `
                            <div class="matrix-row-note" style="grid-column: 1 / -1; padding: 2px 12px 6px 28px; font-size: 11px; color: ${warnColor}; display: flex; align-items: center; gap: 4px;">
                                <span class="material-icons-outlined" style="font-size: 14px;">${warnIcon}</span>
                                ${s.poznamka}
                            </div>
                        `;
                    }

                    html += `
                        <div class="matrix-row extended ${rowClass}" data-index="${s.index}">
                            <div class="matrix-subjekt">
                                <div class="matrix-subjekt-name">${s.nazev}</div>
                                <div class="matrix-subjekt-detail">${s.detail}${s.dokument && s.dokument.nazevSouboru ? ' <span style="color:#80868b;font-size:10px;">📄 ' + s.dokument.nazevSouboru + '</span>' : ''}</div>
                            </div>
                            <div class="matrix-cell">${zeZadostiCheck}</div>
                            <div class="matrix-cell">${prilozenoCheck}</div>
                            <div class="matrix-cell">${vysledekHtml}</div>
                            <div class="matrix-cell">${podminkyHtml}</div>
                        </div>
                        ${poznamkaHtml}
                    `;
                });
                
                if (group.items.length === 0) {
                    html = `<div style="text-align: center; padding: 12px; color: #9aa0a6; font-size: 12px;">Žádné subjekty v této kategorii</div>`;
                }
                group.container.innerHTML = html;
            }
        }

        function getRowStatusClass(s) {
            if (!s.prilozeno && identifikaceState.aiAnalyzaDone) return 'status-missing';
            if (s.prilozeno && s.vysledek === 'zaporne') return 'status-missing';
            if (s.prilozeno && s.poznamka && (s.poznamka.includes('vypršela') || s.poznamka.includes('nelze považovat'))) return 'status-extra'; // warning orange
            if (s.prilozeno && s.vysledek === 'kladne_s_podminkami') return 'status-ok';
            if (s.prilozeno && s.vysledek === 'kladne') return 'status-ok';
            if (s.prilozeno && !s.vysledek) return 'status-extra';
            return '';
        }

        function setVysledek(index, value) {
            identifikaceState.subjekty[index].vysledek = value || null;
            renderIdentifikaceMatrix();
            updateIdentifikaceResult();
            updateSouhrnRozhodnuti();
        }

        // Modal pro podmínky
        function openPodminkyModal(index) {
            identifikaceState.editingSubjektIndex = index;
            const s = identifikaceState.subjekty[index];
            
            // Nastavit titulek
            document.getElementById('podminkyModalTitle').textContent = s.nazev;
            
            // Typ dokladu
            const typLabels = { jes: 'Jednotné environmentální stanovisko', zavazne_stanovisko: 'Závazné stanovisko', vyjadreni: 'Vyjádření' };
            document.getElementById('podminkyDokTyp').textContent = typLabels[s.dokument.typ] || s.dokument.typ;
            
            // Metadata dokumentu
            document.getElementById('podminkyDokCj').value = s.dokument.cisloJednaci || '';
            document.getElementById('podminkyDokDatum').value = s.dokument.datumVydani || '';
            document.getElementById('podminkyDokSoubor').textContent = s.dokument.nazevSouboru || '—';
            
            // Výsledek
            document.querySelectorAll('#vysledekOptions .vysledek-option').forEach(opt => {
                const input = opt.querySelector('input');
                input.checked = input.value === s.vysledek;
                opt.classList.toggle('selected', input.checked);
            });
            
            // Podmínky section viditelnost
            const showPodminky = s.vysledek === 'kladne_s_podminkami';
            document.getElementById('podminkySectionList').style.display = showPodminky ? 'block' : 'none';
            
            // Renderovat podmínky
            renderPodminkyList();
            
            // Poznámka
            document.getElementById('podminkyPoznamka').value = s.poznamka || '';
            
            // Otevřít modal
            document.getElementById('podminkyModal').classList.add('open');
        }

        function closePodminkyModal() {
            document.getElementById('podminkyModal').classList.remove('open');
            identifikaceState.editingSubjektIndex = null;
        }

        function renderPodminkyList() {
            const index = identifikaceState.editingSubjektIndex;
            if (index === null) return;
            
            const s = identifikaceState.subjekty[index];
            const list = document.getElementById('podminkyList');
            
            if (s.podminky.length === 0) {
                list.innerHTML = '<p style="color: #5f6368; font-size: 12px; font-style: italic;">Zatím nebyly přidány žádné podmínky.</p>';
                return;
            }
            
            let html = '';
            s.podminky.forEach((p, i) => {
                html += `
                    <div class="podminka-item ${p.aktivni ? '' : 'inactive'}">
                        <input type="checkbox" class="podminka-checkbox" ${p.aktivni ? 'checked' : ''} 
                            onchange="togglePodminka(${i}, this.checked)">
                        <div class="podminka-text">${p.text}</div>
                        <button class="podminka-remove" onclick="removePodminka(${i})">
                            <span class="material-icons-outlined">close</span>
                        </button>
                    </div>
                `;
            });
            list.innerHTML = html;
        }

        function addPodminka() {
            const index = identifikaceState.editingSubjektIndex;
            if (index === null) return;
            
            const input = document.getElementById('addPodminkaText');
            const text = input.value.trim();
            if (!text) return;
            
            identifikaceState.subjekty[index].podminky.push({ text: text, aktivni: true });
            input.value = '';
            renderPodminkyList();
        }

        function removePodminka(podminkaIndex) {
            const index = identifikaceState.editingSubjektIndex;
            if (index === null) return;
            
            identifikaceState.subjekty[index].podminky.splice(podminkaIndex, 1);
            renderPodminkyList();
        }

        function togglePodminka(podminkaIndex, checked) {
            const index = identifikaceState.editingSubjektIndex;
            if (index === null) return;
            
            identifikaceState.subjekty[index].podminky[podminkaIndex].aktivni = checked;
            renderPodminkyList();
        }

        function savePodminkyModal() {
            const index = identifikaceState.editingSubjektIndex;
            if (index === null) return;
            
            const s = identifikaceState.subjekty[index];
            
            // Uložit metadata dokumentu
            s.dokument.cisloJednaci = document.getElementById('podminkyDokCj').value;
            s.dokument.datumVydani = document.getElementById('podminkyDokDatum').value;
            
            // Uložit výsledek
            const selectedRadio = document.querySelector('#vysledekOptions input:checked');
            s.vysledek = selectedRadio ? selectedRadio.value : null;
            
            // Uložit poznámku
            s.poznamka = document.getElementById('podminkyPoznamka').value;
            
            closePodminkyModal();
            renderIdentifikaceMatrix();
            updateIdentifikaceResult();
            updateSouhrnRozhodnuti();
        }

        // Event listener pro výsledek radio v modalu
        document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('#vysledekOptions .vysledek-option').forEach(opt => {
                opt.addEventListener('click', function() {
                    document.querySelectorAll('#vysledekOptions .vysledek-option').forEach(o => o.classList.remove('selected'));
                    this.classList.add('selected');
                    this.querySelector('input').checked = true;
                    
                    // Zobrazit/skrýt podmínky section
                    const showPodminky = this.querySelector('input').value === 'kladne_s_podminkami';
                    document.getElementById('podminkySectionList').style.display = showPodminky ? 'block' : 'none';
                });
            });
        });

        function aiAnalyzeDoklady() {
            const btn = document.getElementById('btnAiAnalyzeDoklady');
            const status = document.getElementById('aiAnalyzeStatus');
            
            btn.disabled = true;
            btn.innerHTML = '<span class="material-icons-outlined">hourglass_empty</span>Analyzuji...';
            status.innerHTML = '<span class="material-icons-outlined">sync</span>Probíhá AI analýza dokladové části — identifikace dokumentů z PDF příloh...';
            status.className = 'identifikace-ai-status';

            setTimeout(function() {
                // ===== AI analyzuje PDF přílohy a identifikuje jednotlivé doklady =====
                // Zachovat případné manuálně přidané subjekty
                const manualSubjekty = identifikaceState.subjekty.filter(s => s.source === 'manual');
                
                identifikaceState.subjekty = [
                    // DO — závazná stanoviska
                    { id: 'koord_zs', typ: 'do', nazev: 'MěÚ Kostelec n.O. — koordinované ZS', detail: 'Koordinované závazné stanovisko',
                      zeZadosti: true, prilozeno: true, 
                      dokument: { typ: 'zavazne_stanovisko', cisloJednaci: 'R/2025/18662/4', datumVydani: '2025-03-04', nazevSouboru: '1.1._MěÚ Kostelec nO-koord.záv.stan..pdf' },
                      vysledek: 'kladne_s_podminkami',
                      podminky: [{ text: 'Podmínky jednotlivých DO zahrnuty v koordinovaném ZS.', aktivni: true }],
                      poznamka: '' },
                    { id: 'jes', typ: 'do', nazev: 'MěÚ Rychnov n.K. — JES', detail: 'Jednotné environmentální stanovisko',
                      zeZadosti: true, prilozeno: true,
                      dokument: { typ: 'zavazne_stanovisko', cisloJednaci: 'R/2025/14716', datumVydani: '2025-02-20', nazevSouboru: '1.2._MěÚ Rychnov nK-JES.pdf' },
                      vysledek: 'kladne', podminky: [], poznamka: '' },
                    { id: 'pcr', typ: 'do', nazev: 'Policie ČR, DI Rychnov n.K.', detail: 'Dopravní inspektorát',
                      zeZadosti: true, prilozeno: true,
                      dokument: { typ: 'zavazne_stanovisko', cisloJednaci: 'KRPH-69305/ČJ-2024-050706', datumVydani: '2024-07-10', nazevSouboru: '1.7._PČR DI-záv.stan..pdf' },
                      vysledek: 'kladne', podminky: [], poznamka: '' },
                    { id: 'du', typ: 'do', nazev: 'Drážní úřad', detail: 'Stanovisko k PD stavby dráhy',
                      zeZadosti: true, prilozeno: true,
                      dokument: { typ: 'zavazne_stanovisko', cisloJednaci: 'DUCR-44974/24/Bd', datumVydani: '2024-11-15', nazevSouboru: '1.8._Drážní úřad-záv.stan..pdf' },
                      vysledek: 'kladne_s_podminkami',
                      podminky: [{ text: 'Při realizaci stavby dodržet podmínky Drážního úřadu pro provoz na dráze.', aktivni: true }],
                      poznamka: '' },
                    { id: 'obec_doudleby', typ: 'do', nazev: 'Městys Doudleby n.O.', detail: 'Souhlas obce',
                      zeZadosti: true, prilozeno: true,
                      dokument: { typ: 'zavazne_stanovisko', cisloJednaci: '', datumVydani: '2025-04-10', nazevSouboru: '1.3._Městys Doudleby-souhlas.pdf' },
                      vysledek: 'kladne', podminky: [], poznamka: '' },
                    { id: 'obec_zamel', typ: 'do', nazev: 'Obec Záměl', detail: 'Souhlas obce',
                      zeZadosti: true, prilozeno: true,
                      dokument: { typ: 'zavazne_stanovisko', cisloJednaci: '', datumVydani: '2025-04-08', nazevSouboru: '1.4._Obec Záměl-souhlas.pdf' },
                      vysledek: 'kladne', podminky: [], poznamka: '' },
                    { id: 'natura_100', typ: 'do', nazev: 'KÚKHK — NATURA 2000 (100)', detail: 'Hodnocení vlivů na lokality Natura',
                      zeZadosti: true, prilozeno: true,
                      dokument: { typ: 'zavazne_stanovisko', cisloJednaci: 'KUKHK-100/2025', datumVydani: '2025-01-15', nazevSouboru: '3.1._KÚKHK-NATURA-100.pdf' },
                      vysledek: 'kladne', podminky: [], poznamka: '' },
                    
                    // VTI — přiložena a v pořádku
                    { id: 'cetin', typ: 'vti', nazev: 'CETIN a.s.', detail: 'Elektronické komunikace',
                      zeZadosti: true, prilozeno: true,
                      dokument: { typ: 'vyjadreni', cisloJednaci: '629637/24', datumVydani: '2024-07-22', nazevSouboru: '4.2.1._CETIN-vyj.exist..pdf' },
                      vysledek: 'kladne', podminky: [], poznamka: '' },
                    { id: 'cez_dso_exist', typ: 'vti', nazev: 'ČEZ Distribuce a.s. — existence', detail: 'Elektřina — DTM',
                      zeZadosti: true, prilozeno: true,
                      dokument: { typ: 'vyjadreni', cisloJednaci: '0101699963', datumVydani: '2024-07-20', nazevSouboru: '4.2.3._ČEZ DSO-vyj.exist..pdf' },
                      vysledek: 'kladne', podminky: [], poznamka: '' },
                    { id: 'cez_dso_pd', typ: 'vti', nazev: 'ČEZ Distribuce a.s. — k PD', detail: 'Elektřina — souhlas k PD',
                      zeZadosti: true, prilozeno: true,
                      dokument: { typ: 'vyjadreni', cisloJednaci: '0101757128', datumVydani: '2024-10-15', nazevSouboru: '4.2.4._ČEZ DSO-souhlas k PD.pdf' },
                      vysledek: 'kladne', podminky: [], poznamka: '' },
                    { id: 'gasnet_exist', typ: 'vti', nazev: 'GasNet s.r.o. — existence', detail: 'Plyn — DTM',
                      zeZadosti: true, prilozeno: true,
                      dokument: { typ: 'vyjadreni', cisloJednaci: '5002723740', datumVydani: '2024-07-18', nazevSouboru: '4.2.8._GasNet-vyj.exist..pdf' },
                      vysledek: 'kladne', podminky: [], poznamka: '' },
                    { id: 'gasnet_pd', typ: 'vti', nazev: 'GasNet s.r.o. — k PD', detail: 'Plyn — souhlas k PD',
                      zeZadosti: true, prilozeno: true,
                      dokument: { typ: 'vyjadreni', cisloJednaci: '5002789456', datumVydani: '2024-11-20', nazevSouboru: '4.2.9._GasNet-souhlas k PD.pdf' },
                      vysledek: 'kladne', podminky: [], poznamka: '' },
                    { id: 'ceps', typ: 'vti', nazev: 'ČEPS a.s.', detail: 'Přenosová soustava — DTM',
                      zeZadosti: true, prilozeno: true,
                      dokument: { typ: 'vyjadreni', cisloJednaci: '', datumVydani: '2024-08-05', nazevSouboru: '4.2.15._ČEPS-vyj.exist..pdf' },
                      vysledek: 'kladne', podminky: [], poznamka: '' },
                    { id: 'aqua', typ: 'vti', nazev: 'AQUA SERVIS a.s.', detail: 'Vodovod a kanalizace — DTM',
                      zeZadosti: true, prilozeno: true,
                      dokument: { typ: 'vyjadreni', cisloJednaci: '', datumVydani: '2024-08-12', nazevSouboru: '4.2.17._AQUA SERVIS-vyj.exist..pdf' },
                      vysledek: 'kladne', podminky: [], poznamka: '' },
                    { id: 'cd_telematika', typ: 'vti', nazev: 'ČD - Telematika a.s.', detail: 'Telekomunikace na dráze — DTM',
                      zeZadosti: true, prilozeno: true,
                      dokument: { typ: 'vyjadreni', cisloJednaci: '', datumVydani: '2024-09-10', nazevSouboru: '4.2.29._ČD Telematika-vyj.exist..pdf' },
                      vysledek: 'kladne', podminky: [], poznamka: '' },
                    { id: 'sz_souhrnne', typ: 'vti', nazev: 'Správa železnic — souhrnné stanovisko', detail: 'Správce dráhy',
                      zeZadosti: true, prilozeno: true,
                      dokument: { typ: 'vyjadreni', cisloJednaci: '', datumVydani: '2025-06-15', nazevSouboru: '4.2.35._SŽ-souhrnné stanovisko.pdf' },
                      vysledek: 'kladne_s_podminkami',
                      podminky: [{ text: 'Stavba bude realizována při zajištění bezpečnosti železničního provozu.', aktivni: true }],
                      poznamka: '' },
                    
                    // VTI — přiložena, ale prošla platnost
                    { id: 'tmobile', typ: 'vti', nazev: 'T-Mobile Czech Republic a.s.', detail: 'Mobilní síť — DTM',
                      zeZadosti: true, prilozeno: true,
                      dokument: { typ: 'vyjadreni', cisloJednaci: 'E42955/24', datumVydani: '2024-07-19', nazevSouboru: '4.2.10._T-Mobile-vyj.exist..pdf' },
                      vysledek: 'kladne', podminky: [],
                      poznamka: 'POZOR: Platnost vyjádření č.j. E42955/24 ze dne 19.7.2024 vypršela' },
                    { id: 'vodafone', typ: 'vti', nazev: 'Vodafone Czech Republic a.s.', detail: 'Mobilní síť — DTM',
                      zeZadosti: true, prilozeno: true,
                      dokument: { typ: 'vyjadreni', cisloJednaci: 'MW9910256208716969', datumVydani: '2024-07-19', nazevSouboru: '4.2.11._Vodafone-vyj.exist..pdf' },
                      vysledek: 'kladne', podminky: [],
                      poznamka: 'POZOR: Platnost vyjádření č.j. MW991025... ze dne 19.7.2024 vypršela' },
                    { id: 'mo_exist', typ: 'vti', nazev: 'Ministerstvo obrany — existence', detail: 'Vojenská infrastruktura',
                      zeZadosti: true, prilozeno: true,
                      dokument: { typ: 'vyjadreni', cisloJednaci: 'MO 628844/2024-1322', datumVydani: '2024-08-06', nazevSouboru: '4.2.34._MO-vyj.-exist..pdf' },
                      vysledek: 'kladne', podminky: [],
                      poznamka: 'POZOR: Platnost vyjádření č.j. MO 628844/2024-1322 ze dne 6.8.2024 vypršela' },
                    
                    // VTI — chybí zcela (z DTM, ale dokument nepřiložen)
                    { id: 'cra', typ: 'vti', nazev: 'České radiokomunikace a.s.', detail: 'RR spoje — DTM',
                      zeZadosti: false, prilozeno: false,
                      dokument: { typ: 'vyjadreni', cisloJednaci: '', datumVydani: '', nazevSouboru: '' },
                      vysledek: null, podminky: [],
                      poznamka: 'Dle DTM: RR_spoje — vyjádření chybí zcela' },
                    { id: 'spu', typ: 'vti', nazev: 'Státní pozemkový úřad', detail: 'Meliorace KH 07 — DTM k.ú. Záměl',
                      zeZadosti: false, prilozeno: false,
                      dokument: { typ: 'vyjadreni', cisloJednaci: '', datumVydani: '', nazevSouboru: '' },
                      vysledek: null, podminky: [],
                      poznamka: 'Dle DTM: meliorace KH 07, k.ú. Záměl — vyjádření chybí zcela' },
                    
                    // VDI
                    { id: 'rsd', typ: 'vdi', nazev: 'ŘSD ČR, s.p.', detail: 'Silniční doprava — DTM k.ú. Doudleby, Vamberk',
                      zeZadosti: false, prilozeno: false,
                      dokument: { typ: 'vyjadreni', cisloJednaci: '', datumVydani: '', nazevSouboru: '' },
                      vysledek: null, podminky: [],
                      poznamka: 'Dle DTM: silniční doprava, k.ú. Doudleby n.O., Vamberk — vyjádření chybí zcela' },
                    { id: 'sskhk', typ: 'vdi', nazev: 'SSKHK, p.p. (Správa silnic KHK)', detail: 'Silnice II. a III. třídy — DTM',
                      zeZadosti: true, prilozeno: true,
                      dokument: { typ: 'vyjadreni', cisloJednaci: '', datumVydani: '2024-09-20', nazevSouboru: '6.6._SSKHK-souhlas na výkr..pdf' },
                      vysledek: 'kladne', podminky: [],
                      poznamka: 'Předložen souhlas na výkrese 01 — nelze považovat za vyjádření dle DTM pro k.ú. Doudleby, Kostelec' },
                    { id: 'cd_rsm', typ: 'vdi', nazev: 'České dráhy a.s. — RSM HK', detail: 'Provozovatel dráhy',
                      zeZadosti: true, prilozeno: true,
                      dokument: { typ: 'vyjadreni', cisloJednaci: '', datumVydani: '2025-01-10', nazevSouboru: '6.2._ČD RSM-exist.+souhlas PD.pdf' },
                      vysledek: 'kladne', podminky: [], poznamka: '' }
                ];
                
                // Připojit zpět manuálně přidané subjekty
                manualSubjekty.forEach(s => identifikaceState.subjekty.push(s));

                identifikaceState.aiAnalyzaDone = true;
                
                // Tlačítko se změní na "Znovu analyzovat"
                btn.disabled = false;
                btn.innerHTML = '<span class="material-icons-outlined">refresh</span>Znovu analyzovat';
                btn.onclick = function() { rerunAiAnalyza(); };
                
                const nalezeno = identifikaceState.subjekty.filter(s => s.prilozeno).length;
                const celkem = identifikaceState.subjekty.length;
                const chybi = celkem - nalezeno;
                const expired = identifikaceState.subjekty.filter(s => s.poznamka && s.poznamka.includes('vypršela')).length;
                let statusText = 'Nalezeno ' + nalezeno + '/' + celkem + ' dokumentů';
                if (chybi > 0) statusText += ', ' + chybi + ' chybí';
                if (expired > 0) statusText += ', ' + expired + '× prošla platnost';
                status.innerHTML = '<span class="material-icons-outlined">check_circle</span>' + statusText;
                status.className = 'identifikace-ai-status done';

                renderIdentifikaceMatrix();
                updateIdentifikaceResult();
                updateSouhrnRozhodnuti();
            }, 2000);
        }
        
        function rerunAiAnalyza() {
            // Reset a znovu spustit — zachovat manuálně přidané subjekty
            identifikaceState.aiAnalyzaDone = false;
            renderIdentifikaceMatrix();
            aiAnalyzeDoklady();
        }

        function showDocsTooltip(index, btnEl) {
            const s = identifikaceState.subjekty[index];
            alert('Dokument: ' + s.dokument.nazevSouboru + '\nČ.j.: ' + s.dokument.cisloJednaci + '\nDatum: ' + s.dokument.datumVydani);
        }

        function addSubjekt() {
            const typSelect = document.getElementById('addSubjektTyp');
            const nazevInput = document.getElementById('addSubjektNazev');
            
            const typ = typSelect.value;
            const nazev = nazevInput.value.trim();
            
            if (!nazev) {
                alert('Zadejte název subjektu');
                return;
            }

            const typLabels = { do: 'Dotčený orgán', vti: 'Technická infrastruktura', vdi: 'Dopravní infrastruktura' };
            const dokTyp = typ === 'do' ? 'zavazne_stanovisko' : 'vyjadreni';

            identifikaceState.subjekty.push({
                id: 'custom_' + Date.now(),
                typ: typ,
                nazev: nazev,
                detail: typLabels[typ],
                zeZadosti: false,
                prilozeno: false,
                dokument: { typ: dokTyp, cisloJednaci: '', datumVydani: '', nazevSouboru: '' },
                vysledek: null,
                podminky: [],
                poznamka: 'Ručně přidáno referentem — vyjádření/stanovisko chybí',
                source: 'manual'
            });

            nazevInput.value = '';
            renderIdentifikaceMatrix();
            updateIdentifikaceResult();
            updateSouhrnRozhodnuti();
            showToast('Přidán subjekt: ' + nazev);
        }

        function updateSouhrnRozhodnuti() {
            const stats = document.getElementById('souhrnStats');
            const reportActions = document.getElementById('reportActions');
            
            const prilozene = identifikaceState.subjekty.filter(s => s.prilozeno);
            const kladne = prilozene.filter(s => s.vysledek === 'kladne').length;
            const sPodminkami = prilozene.filter(s => s.vysledek === 'kladne_s_podminkami').length;
            const zaporne = prilozene.filter(s => s.vysledek === 'zaporne').length;
            const celkemPodminek = identifikaceState.subjekty.reduce((sum, s) => sum + s.podminky.filter(p => p.aktivni).length, 0);
            const chybiDO = identifikaceState.subjekty.filter(s => !s.prilozeno && identifikaceState.aiAnalyzaDone && s.typ === 'do').length;
            const chybiVTI = identifikaceState.subjekty.filter(s => !s.prilozeno && identifikaceState.aiAnalyzaDone && (s.typ === 'vti' || s.typ === 'vdi')).length;
            
            // Zobrazit tlačítka reportu pokud jsou nějaká data
            if (reportActions) {
                reportActions.style.display = (identifikaceState.aiAnalyzaDone && prilozene.length > 0) ? 'flex' : 'none';
            }
            
            let html = `
                <div class="souhrn-stat ok">
                    <span class="material-icons-outlined">check_circle</span>
                    Kladné: ${kladne}
                </div>
                <div class="souhrn-stat podminky">
                    <span class="material-icons-outlined">task_alt</span>
                    S podmínkami: ${sPodminkami} (celkem ${celkemPodminek} podmínek)
                </div>
            `;
            
            if (zaporne > 0) {
                html += `
                    <div class="souhrn-stat error">
                        <span class="material-icons-outlined">cancel</span>
                        Záporné: ${zaporne}
                    </div>
                `;
            }
            
            if (chybiDO > 0) {
                html += `
                    <div class="souhrn-stat warning">
                        <span class="material-icons-outlined">schedule_send</span>
                        Vyžádat DO: ${chybiDO}
                    </div>
                `;
            }
            
            if (chybiVTI > 0) {
                html += `
                    <div class="souhrn-stat warning">
                        <span class="material-icons-outlined">warning</span>
                        Chybí VTI/VDI: ${chybiVTI}
                    </div>
                `;
            }
            
            stats.innerHTML = html;
        }

        // ==========================================
        // REPORT FUNCTIONS
        // ==========================================
        
        function generateReportData() {
            const typLabels = { do: 'Dotčený orgán', vti: 'Vlastník tech. infrastruktury', vdi: 'Vlastník dopr. infrastruktury' };
            const vysledekLabels = { kladne: 'Kladné', kladne_s_podminkami: 'Kladné s podmínkami', zaporne: 'Záporné' };
            const dokTypLabels = { jes: 'Jednotné environmentální stanovisko', zavazne_stanovisko: 'Závazné stanovisko', vyjadreni: 'Vyjádření' };
            
            return {
                metadata: {
                    datumVytvoreni: new Date().toISOString(),
                    spisZn: 'SZ DESU/000612/26',
                    nazevZameru: 'Oprava zabezpečovacího zařízení v žst. Doudleby n. Orlicí'
                },
                souhrn: {
                    celkemSubjektu: identifikaceState.subjekty.length,
                    prilozenoDokumentu: identifikaceState.subjekty.filter(s => s.prilozeno).length,
                    kladnych: identifikaceState.subjekty.filter(s => s.vysledek === 'kladne').length,
                    sPodminkami: identifikaceState.subjekty.filter(s => s.vysledek === 'kladne_s_podminkami').length,
                    zapornych: identifikaceState.subjekty.filter(s => s.vysledek === 'zaporne').length,
                    celkemPodminek: identifikaceState.subjekty.reduce((sum, s) => sum + s.podminky.filter(p => p.aktivni).length, 0),
                    chybiDO: identifikaceState.subjekty.filter(s => !s.prilozeno && s.typ === 'do').map(s => s.nazev),
                    chybiVTI_VDI: identifikaceState.subjekty.filter(s => !s.prilozeno && (s.typ === 'vti' || s.typ === 'vdi')).map(s => s.nazev)
                },
                subjekty: identifikaceState.subjekty.map(s => ({
                    id: s.id,
                    nazev: s.nazev,
                    typ: s.typ,
                    typLabel: typLabels[s.typ],
                    detail: s.detail,
                    prilozeno: s.prilozeno,
                    dokument: s.dokument ? {
                        typ: s.dokument.typ,
                        typLabel: dokTypLabels[s.dokument.typ],
                        cisloJednaci: s.dokument.cisloJednaci,
                        datumVydani: s.dokument.datumVydani,
                        nazevSouboru: s.dokument.nazevSouboru
                    } : null,
                    vysledek: s.vysledek,
                    vysledekLabel: vysledekLabels[s.vysledek] || null,
                    podminky: s.podminky.filter(p => p.aktivni).map(p => p.text),
                    poznamka: s.poznamka
                })),
                podminkyProRozhodnuti: identifikaceState.subjekty
                    .filter(s => s.podminky.some(p => p.aktivni))
                    .map(s => ({
                        subjekt: s.nazev,
                        cisloJednaci: s.dokument?.cisloJednaci || '',
                        datumVydani: s.dokument?.datumVydani || '',
                        podminky: s.podminky.filter(p => p.aktivni).map(p => p.text)
                    }))
            };
        }

        function showReportModal() {
            const data = generateReportData();
            const content = document.getElementById('reportContent');
            
            let html = `
                <div class="report-header">
                    <h2>REPORT DOKLADOVÉ ČÁSTI</h2>
                    <p>Spis. zn.: ${data.metadata.spisZn}</p>
                    <p>${data.metadata.nazevZameru}</p>
                    <p style="font-size: 11px; color: #5f6368;">Vygenerováno: ${new Date().toLocaleString('cs-CZ')}</p>
                </div>

                <div class="report-section">
                    <h3>SOUHRN</h3>
                    <table class="report-table">
                        <tr><td>Celkem subjektů:</td><td><strong>${data.souhrn.celkemSubjektu}</strong></td></tr>
                        <tr><td>Přiloženo dokumentů:</td><td><strong>${data.souhrn.prilozenoDokumentu}</strong></td></tr>
                        <tr><td>Kladných:</td><td><strong style="color: #137333;">${data.souhrn.kladnych}</strong></td></tr>
                        <tr><td>S podmínkami:</td><td><strong style="color: #004289;">${data.souhrn.sPodminkami}</strong></td></tr>
                        <tr><td>Záporných:</td><td><strong style="color: #c5221f;">${data.souhrn.zapornych}</strong></td></tr>
                        <tr><td>Celkem podmínek:</td><td><strong>${data.souhrn.celkemPodminek}</strong></td></tr>
                    </table>
            `;
            
            if (data.souhrn.chybiDO.length > 0) {
                html += `<p style="color: #b06000; margin-top: 12px;"><strong>⚠ Chybí závazná stanoviska DO:</strong> ${data.souhrn.chybiDO.join(', ')}</p>`;
            }
            if (data.souhrn.chybiVTI_VDI.length > 0) {
                html += `<p style="color: #b06000;"><strong>⚠ Chybí vyjádření VTI/VDI:</strong> ${data.souhrn.chybiVTI_VDI.join(', ')}</p>`;
            }
            
            html += `</div>`;

            // Přehled stanovisek a vyjádření
            html += `
                <div class="report-section">
                    <h3>PŘEHLED STANOVISEK A VYJÁDŘENÍ</h3>
                    <table class="report-table full-width">
                        <thead>
                            <tr>
                                <th>Subjekt</th>
                                <th>Typ</th>
                                <th>Č.j.</th>
                                <th>Datum</th>
                                <th>Výsledek</th>
                                <th>Podmínek</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            data.subjekty.filter(s => s.prilozeno).forEach(s => {
                const vysledekClass = s.vysledek === 'kladne' ? 'color: #137333;' : (s.vysledek === 'zaporne' ? 'color: #c5221f;' : 'color: #004289;');
                html += `
                    <tr>
                        <td><strong>${s.nazev}</strong><br><small>${s.detail}</small></td>
                        <td>${s.typLabel}</td>
                        <td>${s.dokument?.cisloJednaci || '—'}</td>
                        <td>${s.dokument?.datumVydani || '—'}</td>
                        <td style="${vysledekClass}">${s.vysledekLabel || '—'}</td>
                        <td>${s.podminky.length}</td>
                    </tr>
                `;
            });
            
            html += `</tbody></table></div>`;

            // Podmínky pro rozhodnutí
            if (data.podminkyProRozhodnuti.length > 0) {
                html += `
                    <div class="report-section">
                        <h3>PODMÍNKY PRO ROZHODNUTÍ</h3>
                        <p style="font-size: 12px; color: #5f6368; margin-bottom: 16px;">
                            Následující podmínky budou součástí rozhodnutí o povolení stavby.
                        </p>
                `;
                
                let podminkaIndex = 1;
                data.podminkyProRozhodnuti.forEach((skupina, i) => {
                    html += `
                        <div class="report-podminka-skupina">
                            <div class="report-podminka-subjekt">
                                <strong>${skupina.subjekt}</strong>
                                ${skupina.cisloJednaci ? `<span>č.j.: ${skupina.cisloJednaci}</span>` : ''}
                                ${skupina.datumVydani ? `<span>ze dne ${skupina.datumVydani}</span>` : ''}
                            </div>
                            <ol class="report-podminka-list" start="${podminkaIndex}">
                    `;
                    skupina.podminky.forEach(p => {
                        html += `<li>${p}</li>`;
                        podminkaIndex++;
                    });
                    html += `</ol></div>`;
                });
                
                html += `</div>`;
            }

            content.innerHTML = html;
            document.getElementById('reportModal').classList.add('open');
        }

        function closeReportModal() {
            document.getElementById('reportModal').classList.remove('open');
        }

        function downloadReport(format) {
            const data = generateReportData();
            
            if (format === 'json') {
                downloadReportJSON(data);
            } else if (format === 'txt') {
                downloadReportTXT(data);
            }
        }

        function downloadReportJSON(data) {
            if (!data) data = generateReportData();
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `report_dokladova_cast_${data.metadata.spisZn}_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function downloadReportTXT(data) {
            if (!data) data = generateReportData();
            
            let txt = `REPORT DOKLADOVÉ ČÁSTI
${'='.repeat(60)}
Spis. zn.: ${data.metadata.spisZn}
Záměr: ${data.metadata.nazevZameru}
Vygenerováno: ${new Date().toLocaleString('cs-CZ')}

SOUHRN
${'-'.repeat(60)}
Celkem subjektů: ${data.souhrn.celkemSubjektu}
Přiloženo dokumentů: ${data.souhrn.prilozenoDokumentu}
Kladných: ${data.souhrn.kladnych}
S podmínkami: ${data.souhrn.sPodminkami}
Záporných: ${data.souhrn.zapornych}
Celkem podmínek: ${data.souhrn.celkemPodminek}
`;
            
            if (data.souhrn.chybiDO.length > 0) {
                txt += `\n⚠ Chybí závazná stanoviska DO: ${data.souhrn.chybiDO.join(', ')}`;
            }
            if (data.souhrn.chybiVTI_VDI.length > 0) {
                txt += `\n⚠ Chybí vyjádření VTI/VDI: ${data.souhrn.chybiVTI_VDI.join(', ')}`;
            }

            txt += `\n\nPŘEHLED STANOVISEK A VYJÁDŘENÍ
${'-'.repeat(60)}\n`;
            
            data.subjekty.filter(s => s.prilozeno).forEach((s, i) => {
                txt += `
${i + 1}. ${s.nazev} (${s.typLabel})
   Č.j.: ${s.dokument?.cisloJednaci || '—'}
   Datum: ${s.dokument?.datumVydani || '—'}
   Výsledek: ${s.vysledekLabel || '—'}
   Podmínek: ${s.podminky.length}
`;
            });

            if (data.podminkyProRozhodnuti.length > 0) {
                txt += `\n\nPODMÍNKY PRO ROZHODNUTÍ
${'-'.repeat(60)}
Následující podmínky budou součástí rozhodnutí o povolení stavby:\n`;
                
                let podminkaIndex = 1;
                data.podminkyProRozhodnuti.forEach(skupina => {
                    txt += `\n${skupina.subjekt}`;
                    if (skupina.cisloJednaci) txt += ` (č.j.: ${skupina.cisloJednaci}`;
                    if (skupina.datumVydani) txt += ` ze dne ${skupina.datumVydani}`;
                    if (skupina.cisloJednaci) txt += `)`;
                    txt += `:\n`;
                    
                    skupina.podminky.forEach(p => {
                        txt += `   ${podminkaIndex}. ${p}\n`;
                        podminkaIndex++;
                    });
                });
            }

            txt += `\n${'='.repeat(60)}
Konec reportu
`;
            
            const blob = new Blob([txt], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `report_dokladova_cast_${data.metadata.spisZn}_${new Date().toISOString().split('T')[0]}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function downloadReportHTML() {
            const data = generateReportData();
            const reportContent = document.getElementById('reportContent').innerHTML;
            
            const html = `<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <title>Report dokladové části - ${data.metadata.spisZn}</title>
    <style>
        body { font-family: 'Segoe UI', Roboto, sans-serif; max-width: 900px; margin: 40px auto; padding: 20px; }
        h2 { color: #004289; margin: 0; }
        h3 { color: #202124; border-bottom: 1px solid #e0e0e0; padding-bottom: 8px; margin-top: 24px; }
        table { border-collapse: collapse; margin: 12px 0; }
        table.full-width { width: 100%; }
        th, td { padding: 8px 12px; text-align: left; border: 1px solid #e0e0e0; }
        th { background: #f8f9fa; font-weight: 600; }
        .report-header { text-align: center; margin-bottom: 24px; padding-bottom: 16px; border-bottom: 2px solid #004289; }
        .report-section { margin-bottom: 24px; }
        .report-podminka-skupina { margin-bottom: 16px; padding: 12px; background: #f8f9fa; border-radius: 8px; }
        .report-podminka-subjekt { font-size: 14px; margin-bottom: 8px; }
        .report-podminka-subjekt span { margin-left: 12px; color: #5f6368; font-size: 12px; }
        .report-podminka-list { margin: 0; padding-left: 24px; }
        .report-podminka-list li { margin-bottom: 6px; }
        small { color: #5f6368; }
    </style>
</head>
<body>
${reportContent}
</body>
</html>`;
            
            const blob = new Blob([html], { type: 'text/html;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `report_dokladova_cast_${data.metadata.spisZn}_${new Date().toISOString().split('T')[0]}.html`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function updateIdentifikaceResult() {
            const resultItems = document.getElementById('identifikaceResultItems');
            const resultPreview = document.getElementById('resultIdentifikace');
            
            const prilozene = identifikaceState.subjekty.filter(s => s.prilozeno);
            const chybiDO = identifikaceState.subjekty.filter(s => !s.prilozeno && identifikaceState.aiAnalyzaDone && s.typ === 'do');
            const chybiVTI_VDI = identifikaceState.subjekty.filter(s => !s.prilozeno && identifikaceState.aiAnalyzaDone && (s.typ === 'vti' || s.typ === 'vdi'));
            const zaporne = prilozene.filter(s => s.vysledek === 'zaporne');
            const bezVysledku = prilozene.filter(s => !s.vysledek);

            let html = '';
            
            // Přiložené dokumenty
            html += `
                <div class="identifikace-result-item ok">
                    <span class="material-icons-outlined">description</span>
                    <span>Přiloženo: <span class="count">${prilozene.length}</span> dokumentů</span>
                </div>
            `;

            // Záporné stanovisko
            if (zaporne.length > 0) {
                const zaporneNames = zaporne.map(s => s.nazev).join(', ');
                html += `
                    <div class="identifikace-result-item error">
                        <span class="material-icons-outlined">cancel</span>
                        <span>Záporné stanovisko: <span class="count">${zaporne.length}</span></span>
                        <span class="detail">(${zaporneNames})</span>
                    </div>
                `;
            }

            // Chybějící závazná stanoviska DO - SÚ si vyžádá sám
            if (chybiDO.length > 0) {
                const chybiDONames = chybiDO.map(s => s.nazev).join(', ');
                html += `
                    <div class="identifikace-result-item warning">
                        <span class="material-icons-outlined">schedule_send</span>
                        <span>Vyžádat stanovisko: <span class="count">${chybiDO.length}</span> DO</span>
                        <span class="detail">(${chybiDONames})</span>
                    </div>
                    <div class="identifikace-result-item info" style="margin-left: 26px; font-size: 12px;">
                        <span class="material-icons-outlined">info</span>
                        <span>Staví se lhůta pro rozhodnutí • DO má 30 dnů na vydání stanoviska</span>
                    </div>
                `;
            }

            // Chybějící vyjádření VTI/VDI - vada žádosti
            if (chybiVTI_VDI.length > 0) {
                const chybiVTINames = chybiVTI_VDI.map(s => s.nazev).join(', ');
                html += `
                    <div class="identifikace-result-item warning">
                        <span class="material-icons-outlined">warning</span>
                        <span>Chybí vyjádření: <span class="count">${chybiVTI_VDI.length}</span> VTI/VDI</span>
                        <span class="detail">(${chybiVTINames})</span>
                    </div>
                    <div class="identifikace-result-item info" style="margin-left: 26px; font-size: 12px;">
                        <span class="material-icons-outlined">mail</span>
                        <span>Bude vydána výzva k doplnění stavebníkovi</span>
                    </div>
                `;
            }

            // Dokumenty bez hodnocení
            if (bezVysledku.length > 0 && identifikaceState.aiAnalyzaDone) {
                html += `
                    <div class="identifikace-result-item info">
                        <span class="material-icons-outlined">pending</span>
                        <span>Čeká na vyhodnocení: <span class="count">${bezVysledku.length}</span></span>
                    </div>
                `;
            }

            // Vše v pořádku
            if (chybiDO.length === 0 && chybiVTI_VDI.length === 0 && zaporne.length === 0 && bezVysledku.length === 0 && identifikaceState.aiAnalyzaDone) {
                html += `
                    <div class="identifikace-result-item ok">
                        <span class="material-icons-outlined">check_circle</span>
                        <span>Kontrola dokladové části dokončena</span>
                    </div>
                `;
            }

            resultItems.innerHTML = html;

            // Update result preview
            if (!identifikaceState.aiAnalyzaDone) {
                resultPreview.className = 'result-preview';
                resultPreview.innerHTML = `
                    <div class="result-preview-title">
                        <span class="material-icons-outlined">info</span>
                        Čeká na AI analýzu
                    </div>
                    <div class="result-preview-text">Spusťte AI analýzu dokladové části pro automatické rozpoznání přiložených dokumentů.</div>
                `;
            } else if (zaporne.length > 0) {
                resultPreview.className = 'result-preview negative';
                resultPreview.innerHTML = `
                    <div class="result-preview-title">
                        <span class="material-icons-outlined">cancel</span>
                        Záporné stanovisko
                    </div>
                    <div class="result-preview-text">
                        ${zaporne.map(s => s.nazev).join(', ')} vydal(y) záporné stanovisko.<br>
                        Záměru nelze vyhovět nebo je třeba řešit rozpor.
                    </div>
                `;
            } else if (chybiVTI_VDI.length > 0) {
                resultPreview.className = 'result-preview warning';
                resultPreview.innerHTML = `
                    <div class="result-preview-title">
                        <span class="material-icons-outlined">warning</span>
                        Chybí vyjádření VTI/VDI
                    </div>
                    <div class="result-preview-text">
                        Chybí ${chybiVTI_VDI.length} vyjádření vlastníků sítí. Vada žádosti → výzva k doplnění.
                    </div>
                `;
            } else if (chybiDO.length > 0) {
                resultPreview.className = 'result-preview warning';
                resultPreview.innerHTML = `
                    <div class="result-preview-title">
                        <span class="material-icons-outlined">schedule_send</span>
                        Vyžádat stanoviska DO
                    </div>
                    <div class="result-preview-text">
                        Chybí ${chybiDO.length} závazné stanovisko DO. SÚ si vyžádá. Staví se lhůta.
                    </div>
                `;
            } else if (bezVysledku.length > 0) {
                resultPreview.className = 'result-preview';
                resultPreview.innerHTML = `
                    <div class="result-preview-title">
                        <span class="material-icons-outlined">pending</span>
                        Dokončete vyhodnocení
                    </div>
                    <div class="result-preview-text">
                        ${bezVysledku.length} dokumentů čeká na vyhodnocení výsledku (kladné/záporné/s podmínkami).
                    </div>
                `;
            } else {
                const celkemPodminek = identifikaceState.subjekty.reduce((sum, s) => sum + s.podminky.filter(p => p.aktivni).length, 0);
                resultPreview.className = 'result-preview positive';
                resultPreview.innerHTML = `
                    <div class="result-preview-title">
                        <span class="material-icons-outlined">check_circle</span>
                        Dokladová část v pořádku
                    </div>
                    <div class="result-preview-text">
                        Všechny dokumenty zkontrolovány. Celkem ${celkemPodminek} podmínek pro rozhodnutí.
                    </div>
                `;
            }
        }

        function completeIdentifikace() {
            const chybiDO = identifikaceState.subjekty.filter(s => !s.prilozeno && identifikaceState.aiAnalyzaDone && s.typ === 'do');
            const chybiVTI_VDI = identifikaceState.subjekty.filter(s => !s.prilozeno && identifikaceState.aiAnalyzaDone && (s.typ === 'vti' || s.typ === 'vdi'));
            const zaporne = identifikaceState.subjekty.filter(s => s.vysledek === 'zaporne');
            
            // Subjekty s prošlou platností (mají poznámku o expiraci)
            const proslaPlatnost = identifikaceState.subjekty.filter(s => 
                s.prilozeno && s.poznamka && s.poznamka.includes('platnost') && s.poznamka.includes('vypršela')
            );
            
            // Subjekty s nedostatečným typem dokladu
            const nedostatecny = identifikaceState.subjekty.filter(s => 
                s.prilozeno && s.poznamka && s.poznamka.includes('nelze považovat')
            );
            
            controls.identifikace.done = true;
            
            // Uložit kompletní data pro generování rozhodnutí
            controls.identifikace.subjekty = JSON.parse(JSON.stringify(identifikaceState.subjekty));
            controls.identifikace.chybiDO = chybiDO.map(s => s.nazev);
            controls.identifikace.chybiVTI_VDI = chybiVTI_VDI.map(s => s.nazev);
            
            // Data pro rozhodnutí - podmínky seskupené podle subjektu
            controls.identifikace.dataProRozhodnuti = {
                stanoviskaAVyjadreni: identifikaceState.subjekty.filter(s => s.prilozeno).map(s => ({
                    nazev: s.nazev,
                    typ: s.typ,
                    dokument: s.dokument,
                    vysledek: s.vysledek,
                    podminky: s.podminky.filter(p => p.aktivni).map(p => p.text)
                })),
                podminkyProRozhodnuti: identifikaceState.subjekty
                    .filter(s => s.podminky.some(p => p.aktivni))
                    .map(s => ({
                        subjekt: s.nazev,
                        cisloJednaci: s.dokument.cisloJednaci,
                        datumVydani: s.dokument.datumVydani,
                        podminky: s.podminky.filter(p => p.aktivni).map(p => p.text)
                    }))
            };
            
            // === PROPAGACE DO globalIssues.vyzva ===
            // Nejprve odebrat předchozí issues z této kontroly
            globalIssues.vyzva = globalIssues.vyzva.filter(i => i.controlName !== 'Dokladová část');
            
            const hasDeficiencies = chybiVTI_VDI.length > 0 || proslaPlatnost.length > 0 || nedostatecny.length > 0;
            
            if (hasDeficiencies) {
                // Sestavit strukturovaný text pro výzvu
                const parts = [];
                
                if (chybiVTI_VDI.length > 0) {
                    parts.push('Doplnil vyjádření vlastníků technické a dopravní infrastruktury dle § 181 odst. 1 písm. d) SZ: ' + 
                        chybiVTI_VDI.map(s => s.nazev + (s.poznamka ? ' (' + s.detail + ')' : '')).join(', ') + '.');
                }
                
                if (proslaPlatnost.length > 0) {
                    parts.push('Doplnil aktuální vyjádření (platnost vypršela): ' + 
                        proslaPlatnost.map(s => s.nazev + ' (č.j. ' + s.dokument.cisloJednaci + ' ze dne ' + s.dokument.datumVydani + ')').join(', ') + '.');
                }
                
                if (nedostatecny.length > 0) {
                    parts.push('Doplnil vyjádření v odpovídající formě (souhlas na výkrese nelze považovat za vyjádření dle DTM): ' +
                        nedostatecny.map(s => s.nazev).join(', ') + '.');
                }
                
                addGlobalIssue('vyzva', {
                    text: parts.join('\n'),
                    hlavniText: parts.join('\n'),
                    source: 'auto',
                    controlName: 'Dokladová část',
                    kategorie: 'dokladova_cast',
                    pravniPredpis: '§ 181 odst. 1 písm. d) zák. č. 283/2021 Sb.',
                    typAkce: 'doplnit',
                    detaily: {
                        chybiZcela: chybiVTI_VDI.map(s => ({ nazev: s.nazev, detail: s.detail, poznamka: s.poznamka })),
                        proslaPlatnost: proslaPlatnost.map(s => ({ nazev: s.nazev, cj: s.dokument.cisloJednaci, datum: s.dokument.datumVydani })),
                        nedostatecny: nedostatecny.map(s => ({ nazev: s.nazev, poznamka: s.poznamka }))
                    }
                });
            }
            
            // Určit výsledek kontroly
            if (zaporne.length > 0) {
                controls.identifikace.result = 'error';
            } else if (chybiVTI_VDI.length > 0 || proslaPlatnost.length > 0 || nedostatecny.length > 0) {
                controls.identifikace.result = 'vady';
            } else if (chybiDO.length > 0) {
                controls.identifikace.result = 'vyzidat_do';
            } else {
                controls.identifikace.result = 'ok';
            }
            
            closeControl('controlIdentifikace');
            updateUI();
        }

        // Funkce completeDoklady již není potřeba - sloučena do completeIdentifikace

        // Funkce completeUP nahrazena funkcí completeUPD v nové implementaci kontroly souladu s ÚPD

        // ==========================================
        // ÚČASTNÍCI ŘÍZENÍ - FUNKCE
        // ==========================================
        
        // Přepínání záložek účastníků
        function switchUcastniciTab(tabEl, panelId) {
            // Deaktivovat všechny záložky
            const tabs = document.querySelectorAll('.ucastnici-tab');
            tabs.forEach(t => t.classList.remove('active'));
            tabEl.classList.add('active');
            
            // Skrýt všechny panely
            const panels = document.querySelectorAll('.ucastnici-panel');
            panels.forEach(p => p.classList.remove('active'));
            
            // Zobrazit vybraný panel
            const panelMap = {
                'ucastnici': 'panelUcastnici',
                'zastupci': 'panelZastupci',
                'dalsi': 'panelDalsiOsoby'
            };
            document.getElementById(panelMap[panelId]).classList.add('active');
        }
        
        // Ověřit všechny účastníky
        function overitVsechnyUcastniky() {
            const pendingStatuses = document.querySelectorAll('#panelUcastnici .ucastnici-status.pending');
            pendingStatuses.forEach(status => {
                status.classList.remove('pending');
                status.classList.add('verified');
                status.title = 'Ověřeno';
                status.querySelector('.material-icons-outlined').textContent = 'check_circle';
            });
            
            // Zobrazit potvrzení
            showToast('Všichni účastníci byli ověřeni');
        }
        
        // Toggle oblíbených
        function toggleOblibeny(btn) {
            const icon = btn.querySelector('.material-icons-outlined');
            if (btn.classList.contains('favorited')) {
                btn.classList.remove('favorited');
                icon.textContent = 'star_border';
                btn.title = 'Přidat do oblíbených';
            } else {
                btn.classList.add('favorited');
                icon.textContent = 'star';
                btn.title = 'Odebrat z oblíbených';
            }
        }
        
        // Přidání účastníka
        function addUcastnik(skupina, metoda) {
            const metodaText = {
                'manual': 'ručně',
                'lv': 'z listu vlastnictví',
                'oblibene': 'z oblíbených'
            };
            const skupinaText = {
                'stavebnik': 'Stavebník',
                'obec': 'Obec',
                'vlastnik': 'Vlastník pozemku/stavby',
                'soused': 'Vlastník sousedního pozemku',
                'ostatni': 'Ostatní účastníci'
            };
            alert(`Přidání účastníka ${metodaText[metoda]} do skupiny "${skupinaText[skupina]}" - bude implementováno`);
        }
        
        // Přidání zástupce
        function addZastupce(metoda) {
            if (metoda === 'oblibene') {
                alert('Přidání zástupce z oblíbených - bude implementováno');
            } else {
                alert('Přidání nového zástupce - bude implementováno');
            }
        }
        
        // Přidání další osoby
        function addDalsiOsoba(metoda) {
            if (metoda === 'oblibene') {
                alert('Přidání další osoby z oblíbených - bude implementováno');
            } else {
                alert('Přidání nové další osoby - bude implementováno');
            }
        }
        
        // ==========================================
        // OVĚŘENÍ POZEMKŮ Z KATASTRU NEMOVITOSTÍ
        // ==========================================
        
        // Simulovaná data vlastníků pro demo
        const simulatedKNData = {
            'st. 123': { vlastnik: 'Správa železnic, s.o.', typ: 'FO', adresa: 'Dlážděná 1003/7, 110 00 Praha 1', vecnaPrava: null },
            '456/1': { vlastnik: 'Správa železnic, s.o.', typ: 'FO', adresa: 'Dlážděná 1003/7, 110 00 Praha 1', vecnaPrava: 'VB: ČEZ' },
            'st. 122': { vlastnik: 'Marie Veselá', typ: 'FO', adresa: 'Růžová 45, 551 01 Jaroměř', vecnaPrava: null },
            'st. 124': { vlastnik: 'Petr Svoboda', typ: 'FO', adresa: 'Lipová 78, 551 01 Jaroměř', vecnaPrava: null },
            '456/2': { vlastnik: 'ČEZ Distribuce, a. s.', typ: 'PO', adresa: 'Teplická 874/8, 405 02 Děčín', vecnaPrava: null },
            '457': { vlastnik: 'Městys Doudleby n.O.', typ: 'PO', adresa: 'nám. ČSA 16, 551 01 Jaroměř', vecnaPrava: null }
        };
        
        // Přepínání tabů v sekci účastníků
        function switchOsobyTab(btn, tabId) {
            // Odebrat active ze všech tabů
            document.querySelectorAll('.osoby-tab-btn').forEach(t => t.classList.remove('active'));
            btn.classList.add('active');
            
            // Skrýt všechny panely a zobrazit aktivní
            document.querySelectorAll('.osoby-tab-panel').forEach(p => p.classList.remove('active'));
            const panel = document.getElementById('tabPanel' + tabId.charAt(0).toUpperCase() + tabId.slice(1));
            if (panel) panel.classList.add('active');
        }
        
        // Načíst VTI/VDI z Dokladové části
        function nacistVTIVDI() {
            const emptyRow = document.getElementById('emptyOstatniUcastnici');
            if (emptyRow) {
                // Simulace načtení VTI/VDI
                const vtiVdiData = [
                    { nazev: 'ČEZ Distribuce, a.s.', typ: 'VTI', ico: '24729035', ds: 'v95uqfy' },
                    { nazev: 'GasNet, s.r.o.', typ: 'VTI', ico: '27295567', ds: 'rdxzhzt' },
                    { nazev: 'Vodovody a kanalizace Náchod, a.s.', typ: 'VTI', ico: '48172928', ds: 'u9xbgxi' },
                    { nazev: 'Ředitelství silnic a dálnic ČR', typ: 'VDI', ico: '65993390', ds: 'zjq4rhz' }
                ];
                
                let html = '';
                vtiVdiData.forEach(item => {
                    html += `
                        <tr class="osoba-row" data-osoba-id="${item.ico}" data-overeno="false">
                            <td><span class="os-status pending"><span class="material-icons-outlined">help_outline</span></span></td>
                            <td>
                                <strong>${item.nazev}</strong><br>
                                <small class="text-muted">IČO: ${item.ico}</small>
                            </td>
                            <td>
                                <span class="os-ds-info"><span class="material-icons-outlined">forward_to_inbox</span> ${item.ds}</span>
                            </td>
                            <td><span class="os-zdroj ${item.typ.toLowerCase()}">${item.typ}</span></td>
                            <td><span class="doruc-ceka" title="Čeká na ověření">—</span></td>
                            <td class="os-actions">
                                <button class="btn-overit-osobu" onclick="overitOsobu(this)" title="Ověřit z rejstříku"><span class="material-icons-outlined">verified_user</span></button>
                                <button onclick="toggleOblibeny(this)" title="Přidat do oblíbených"><span class="material-icons-outlined">star_border</span></button>
                                <button title="Detail"><span class="material-icons-outlined">visibility</span></button>
                                <button title="Odstranit"><span class="material-icons-outlined">delete</span></button>
                            </td>
                        </tr>
                    `;
                });
                
                emptyRow.outerHTML = html;
                
                // Aktualizovat počet účastníků
                const countEl = document.getElementById('tabCountUcastnici');
                if (countEl) {
                    const currentCount = parseInt(countEl.textContent) || 0;
                    countEl.textContent = currentCount + vtiVdiData.length;
                }
                
                showToast(`Načteno ${vtiVdiData.length} vlastníků infrastruktury z Dokladové části`);
            }
        }
        
        // Načíst dotčené orgány z Dokladové části
        function nacistDotceneOrgany() {
            const emptyRow = document.getElementById('emptyDotceneOrgany');
            if (emptyRow) {
                // Simulace načtení dotčených orgánů
                const dotceneOrganyData = [
                    { nazev: 'Hasičský záchranný sbor Královéhradeckého kraje', typ: 'Požární ochrana', stav: 'vydáno' },
                    { nazev: 'Krajská hygienická stanice Královéhradeckého kraje', typ: 'Ochrana veřejného zdraví', stav: 'vydáno' },
                    { nazev: 'Městský úřad Jaroměř - odbor životního prostředí', typ: 'Ochrana přírody a krajiny', stav: 'čeká' },
                    { nazev: 'Městský úřad Jaroměř - odbor dopravy', typ: 'Napojení na komunikaci', stav: 'vydáno' }
                ];
                
                let html = '';
                dotceneOrganyData.forEach(item => {
                    const stavClass = item.stav === 'vydáno' ? 'ok' : 'pending';
                    const stavText = item.stav === 'vydáno' ? 'Vydáno' : 'Čeká na vydání';
                    const stavIcon = item.stav === 'vydáno' ? 'check_circle' : 'schedule';
                    
                    html += `
                        <tr class="osoba-row">
                            <td><span class="os-status ${stavClass}"><span class="material-icons-outlined">${stavIcon}</span></span></td>
                            <td>
                                <strong>${item.nazev}</strong><br>
                                <small class="text-muted">Dotčený orgán</small>
                            </td>
                            <td><span class="os-role">${item.typ}</span></td>
                            <td><span class="kategorie-stav ${stavClass === 'ok' ? 'ok' : 'ceka'}">${stavText}</span></td>
                            <td class="os-actions">
                                <button title="Detail"><span class="material-icons-outlined">visibility</span></button>
                                <button title="Upravit"><span class="material-icons-outlined">edit</span></button>
                                <button title="Odstranit"><span class="material-icons-outlined">delete</span></button>
                            </td>
                        </tr>
                    `;
                });
                
                emptyRow.outerHTML = html;
                
                // Aktualizovat počet
                const countEl = document.getElementById('tabCountDotceneOrgany');
                if (countEl) {
                    countEl.textContent = dotceneOrganyData.length;
                }
                
                showToast(`Načteno ${dotceneOrganyData.length} dotčených orgánů z Dokladové části`);
            }
        }
        
        // Přidat dotčený orgán ručně
        function pridatDotcenyOrgan() {
            showToast('Otevírám formulář pro přidání dotčeného orgánu...');
            // TODO: Implementovat modal pro ruční přidání
        }
        
        // Ověřit všechny pozemky najednou
        function overitVsechnyPozemkyKN() {
            const rows = document.querySelectorAll('.pozemek-item');
            let delay = 0;
            
            rows.forEach(row => {
                const parcela = row.getAttribute('data-parcela');
                if (parcela) {
                    setTimeout(() => {
                        overitPozemekKNItem(row, parcela);
                    }, delay);
                    delay += 100;
                }
            });
            
            // Po dokončení přidat vlastníky do tabulky
            setTimeout(() => {
                pridatVlastnikyDoTabulky();
                showToast('Všechny pozemky byly ověřeny z KN');
            }, delay + 100);
        }
        
        // Ověřit jeden pozemek
        function overitPozemekKN(parcela, ku) {
            const row = document.querySelector(`.pozemek-item[data-parcela="${parcela}"]`);
            if (row) {
                overitPozemekKNItem(row, parcela);
                setTimeout(() => pridatVlastnikyDoTabulky(), 200);
            }
        }
        
        // Interní funkce pro ověření pozemku
        function overitPozemekKNItem(row, parcela) {
            const vlastnikEl = row.querySelector('.pozemek-vlastnik');
            const statusEl = row.querySelector('.pozemek-status');
            const btnEl = row.querySelector('.btn-overit-sm');
            
            const data = simulatedKNData[parcela];
            
            if (data) {
                // Přidat třídu verified na řádek
                row.classList.add('verified');
                
                vlastnikEl.textContent = data.vlastnik;
                vlastnikEl.classList.add('verified');
                
                statusEl.className = 'pozemek-status ok';
                statusEl.innerHTML = '<span class="material-icons-outlined">check_circle</span>';
                
                // Nahradit tlačítko Ověřit tlačítkem LV
                const lvId = 'lv-' + parcela.replace(/[^a-zA-Z0-9]/g, '');
                btnEl.outerHTML = `
                    <div class="btn-lv-wrapper">
                        <button class="btn-lv" onclick="toggleLVDropdown('${lvId}')">
                            <span class="material-icons-outlined">description</span>
                            LV
                            <span class="material-icons-outlined">expand_more</span>
                        </button>
                        <div class="lv-dropdown" id="${lvId}">
                            <button class="lv-dropdown-item" onclick="openLV('${parcela}', 'castecny')">
                                <div class="lv-item-title">Částečný výpis</div>
                                <div class="lv-item-desc">Pouze tento pozemek</div>
                            </button>
                            <button class="lv-dropdown-item" onclick="openLV('${parcela}', 'uplny')">
                                <div class="lv-item-title">Úplný výpis</div>
                                <div class="lv-item-desc">Celý list vlastnictví</div>
                            </button>
                        </div>
                    </div>
                `;
                
                // Přidat info řádek s datem ověření
                const today = new Date();
                const dateStr = today.toLocaleDateString('cs-CZ');
                const infoRow = document.createElement('div');
                infoRow.className = 'pozemek-info-row';
                infoRow.innerHTML = `<span class="pozemek-overeno-datum">Ověřeno: ${dateStr}</span>`;
                row.appendChild(infoRow);
            }
        }
        
        // Toggle LV dropdown
        function toggleLVDropdown(id) {
            // Zavřít ostatní dropdowny
            document.querySelectorAll('.lv-dropdown.show').forEach(d => {
                if (d.id !== id) d.classList.remove('show');
            });
            
            const dropdown = document.getElementById(id);
            if (dropdown) {
                dropdown.classList.toggle('show');
            }
        }
        
        // Otevřít LV (simulace)
        function openLV(parcela, typ) {
            // Zavřít dropdown
            document.querySelectorAll('.lv-dropdown.show').forEach(d => d.classList.remove('show'));
            
            const typText = typ === 'castecny' ? 'Částečný výpis' : 'Úplný výpis';
            showToast(`Otevírám ${typText} LV pro parcelu ${parcela}...`);
            
            // Simulace otevření v novém okně
            setTimeout(() => {
                // V reálu by se otevřel odkaz na ČÚZK nebo interní systém
                console.log(`Otevření LV: parcela=${parcela}, typ=${typ}`);
            }, 500);
        }
        
        // Zavřít dropdowny při kliknutí mimo
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.btn-lv-wrapper')) {
                document.querySelectorAll('.lv-dropdown.show').forEach(d => d.classList.remove('show'));
            }
        });
        
        // Přidat vlastníky do tabulky účastníků
        function pridatVlastnikyDoTabulky() {
            const tbody = document.getElementById('tbodyUcastnici');
            if (!tbody) return;
            
            // Aktualizovat kategorii vlastníků záměru
            const katZameru = document.getElementById('katVlastniciZameru');
            if (katZameru) {
                const stav = katZameru.querySelector('.kategorie-stav');
                if (stav) {
                    stav.className = 'kategorie-stav ok';
                    stav.textContent = 'z KN';
                }
            }
            
            // Odstranit prázdný řádek vlastníků záměru - přidat jako NEOVĚŘENÉ
            const emptyZameru = document.getElementById('emptyVlastniciZameru');
            if (emptyZameru) {
                emptyZameru.outerHTML = `
                    <tr data-osoba-id="jan-novak-kn" data-overeno="false">
                        <td><span class="os-status pending" title="Neověřeno proti ROS/ROB"><span class="material-icons-outlined">help_outline</span></span></td>
                        <td>
                            <strong>Správa železnic, s.o.</strong><br>
                            <small class="text-muted">Fyzická osoba</small>
                            <span class="os-zastoupen-info" id="zastoupenJanNovak" style="display: none;"></span>
                        </td>
                        <td class="os-adresa-neovereno">
                            <span class="os-pozemky">st. 123, 456/1, 456/2</span>
                        </td>
                        <td><span class="os-zdroj zdroj-kn">KN</span></td>
                        <td><span class="doruc-ceka" title="Čeká na ověření">—</span></td>
                        <td class="os-actions">
                            <button class="btn-overit-osobu" onclick="overitOsobu(this)" title="Ověřit z rejstříku"><span class="material-icons-outlined">verified_user</span></button>
                            <button onclick="toggleOblibeny(this)" title="Oblíbený"><span class="material-icons-outlined">star_border</span></button>
                            <button title="Detail"><span class="material-icons-outlined">visibility</span></button>
                            <button title="Upravit"><span class="material-icons-outlined">edit</span></button>
                        </td>
                    </tr>
                    <tr data-osoba-id="cez-distribuce-vb" data-overeno="false">
                        <td><span class="os-status pending" title="Neověřeno proti ROS/ROB"><span class="material-icons-outlined">help_outline</span></span></td>
                        <td>
                            <strong>ČEZ Distribuce, a. s.</strong><br>
                            <small class="text-muted">Právnická osoba</small>
                        </td>
                        <td>
                            <span class="os-role">věcné břemeno</span>
                            <span class="os-pozemky">p. 456/1</span>
                        </td>
                        <td><span class="os-zdroj zdroj-kn">KN</span></td>
                        <td><span class="doruc-ceka" title="Čeká na ověření">—</span></td>
                        <td class="os-actions">
                            <button class="btn-overit-osobu" onclick="overitOsobu(this)" title="Ověřit z rejstříku"><span class="material-icons-outlined">verified_user</span></button>
                            <button class="is-favorited" onclick="toggleOblibeny(this)" title="V oblíbených"><span class="material-icons-outlined">star</span></button>
                            <button title="Detail"><span class="material-icons-outlined">visibility</span></button>
                            <button title="Upravit"><span class="material-icons-outlined">edit</span></button>
                        </td>
                    </tr>
                `;
            }
            
            // Aktualizovat kategorii vlastníků sousedů
            const katSousedi = document.getElementById('katVlastniciSousedi');
            if (katSousedi) {
                const stav = katSousedi.querySelector('.kategorie-stav');
                if (stav) {
                    stav.className = 'kategorie-stav ok';
                    stav.textContent = 'z KN';
                }
            }
            
            // Odstranit prázdný řádek sousedů - přidat jako NEOVĚŘENÉ
            const emptySousedi = document.getElementById('emptyVlastniciSousedi');
            if (emptySousedi) {
                emptySousedi.outerHTML = `
                    <tr data-osoba-id="marie-vesela" data-overeno="false">
                        <td><span class="os-status pending" title="Neověřeno proti ROS/ROB"><span class="material-icons-outlined">help_outline</span></span></td>
                        <td>
                            <strong>Marie Veselá</strong><br>
                            <small class="text-muted">Fyzická osoba</small>
                            <span class="os-zastoupen-info" id="zastoupenMarieVesela" style="display: none;"></span>
                        </td>
                        <td class="os-adresa-neovereno">
                            <span class="os-pozemky">p. 457/1</span>
                        </td>
                        <td><span class="os-zdroj zdroj-kn">KN</span></td>
                        <td><span class="doruc-ceka" title="Čeká na ověření">—</span></td>
                        <td class="os-actions">
                            <button class="btn-overit-osobu" onclick="overitOsobu(this)" title="Ověřit z rejstříku"><span class="material-icons-outlined">verified_user</span></button>
                            <button onclick="toggleOblibeny(this)" title="Oblíbený"><span class="material-icons-outlined">star_border</span></button>
                            <button title="Detail"><span class="material-icons-outlined">visibility</span></button>
                            <button title="Upravit"><span class="material-icons-outlined">edit</span></button>
                        </td>
                    </tr>
                    <tr data-osoba-id="petr-svoboda" data-overeno="false">
                        <td><span class="os-status pending" title="Neověřeno proti ROS/ROB"><span class="material-icons-outlined">help_outline</span></span></td>
                        <td>
                            <strong>Petr Svoboda</strong><br>
                            <small class="text-muted">Fyzická osoba</small>
                            <span class="os-zastoupen-info" id="zastoupenPetrSvoboda" style="display: none;"></span>
                        </td>
                        <td class="os-adresa-neovereno">
                            <span class="os-pozemky">p. 457/2, 458</span>
                        </td>
                        <td><span class="os-zdroj zdroj-kn">KN</span></td>
                        <td><span class="doruc-ceka" title="Čeká na ověření">—</span></td>
                        <td class="os-actions">
                            <button class="btn-overit-osobu" onclick="overitOsobu(this)" title="Ověřit z rejstříku"><span class="material-icons-outlined">verified_user</span></button>
                            <button onclick="toggleOblibeny(this)" title="Oblíbený"><span class="material-icons-outlined">star_border</span></button>
                            <button title="Detail"><span class="material-icons-outlined">visibility</span></button>
                            <button title="Upravit"><span class="material-icons-outlined">edit</span></button>
                        </td>
                    </tr>
                    <tr data-osoba-id="cez-distribuce" data-overeno="false">
                        <td><span class="os-status pending" title="Neověřeno proti ROS/ROB"><span class="material-icons-outlined">help_outline</span></span></td>
                        <td>
                            <strong>ČEZ Distribuce, a. s.</strong><br>
                            <small class="text-muted">Právnická osoba</small>
                        </td>
                        <td class="os-adresa-neovereno">
                            <span class="os-pozemky">p. 459/1</span>
                        </td>
                        <td><span class="os-zdroj zdroj-kn">KN</span></td>
                        <td><span class="doruc-ceka" title="Čeká na ověření">—</span></td>
                        <td class="os-actions">
                            <button class="btn-overit-osobu" onclick="overitOsobu(this)" title="Ověřit z rejstříku"><span class="material-icons-outlined">verified_user</span></button>
                            <button class="is-favorited" onclick="toggleOblibeny(this)" title="V oblíbených"><span class="material-icons-outlined">star</span></button>
                            <button title="Detail"><span class="material-icons-outlined">visibility</span></button>
                            <button title="Upravit"><span class="material-icons-outlined">edit</span></button>
                        </td>
                    </tr>
                `;
            }
            
            // Aktualizovat počty
            const countEl = document.getElementById('tabCountUcastnici');
            if (countEl) countEl.textContent = '7';
        }
        
        // ==========================================
        // OVĚŘOVÁNÍ OSOB - FUNKCE
        // ==========================================
        
        // Simulovaná data z rejstříků ROB/ROS
        const rejstrikData = {
            'jan-novak': { adresa: 'Dlážděná 1003/7, 110 00 Praha 1', ds: 'uccchjm', typ: 'FO' },
            'jan-novak-kn': { adresa: 'Dlážděná 1003/7, 110 00 Praha 1', ds: 'uccchjm', typ: 'FO' },
            'mesto-jaromer': { adresa: 'nám. ČSA 16, 551 01 Jaroměř', ds: 'xyz789m', typ: 'PO' },
            'cez-distribuce-vb': { adresa: 'Teplická 874/8, 405 02 Děčín', ds: 'cezdis01', typ: 'PO' },
            'cez-distribuce': { adresa: 'Teplická 874/8, 405 02 Děčín', ds: 'cezdis01', typ: 'PO' },
            'marie-vesela': { adresa: 'Růžová 45, 551 01 Jaroměř', ds: null, typ: 'FO' },
            'petr-svoboda': { adresa: 'Lipová 78, 551 01 Jaroměř', ds: null, typ: 'FO' }
        };
        
        // Ověřit všechny neověřené osoby
        function overitVsechnyOsoby() {
            // Ověřit všechny neověřené osoby včetně VTI/VDI
            const neovereneOsoby = document.querySelectorAll('#tabPanelUcastnici tr[data-overeno="false"]');
            
            if (neovereneOsoby.length === 0) {
                showToast('Všechny osoby jsou již ověřeny');
                return;
            }
            
            showToast(`Ověřuji ${neovereneOsoby.length} osob z ROS/ROB...`);
            
            let delay = 0;
            neovereneOsoby.forEach((row, index) => {
                setTimeout(() => {
                    overitOsobuRow(row);
                }, delay);
                delay += 300;
            });
            
            setTimeout(() => {
                showToast('Všechny osoby byly ověřeny');
            }, delay + 200);
        }
        
        // Ověřit jednu osobu (kliknutím na tlačítko)
        function overitOsobu(btn) {
            const row = btn.closest('tr');
            if (!row) return;
            
            overitOsobuRow(row);
            showToast('Osoba byla ověřena');
        }
        
        // Interní funkce pro ověření řádku
        function overitOsobuRow(row) {
            const osobaId = row.getAttribute('data-osoba-id');
            const data = rejstrikData[osobaId];
            
            // Aktualizovat status na ověřeno
            const statusCell = row.querySelector('.os-status');
            if (statusCell) {
                statusCell.className = 'os-status ok';
                statusCell.title = 'Ověřeno z ROB/ROS';
                statusCell.innerHTML = '<span class="material-icons-outlined">check_circle</span>';
            }
            
            // Aktualizovat adresu
            const adresaCell = row.querySelector('td:nth-child(3)');
            if (adresaCell && data) {
                // Zachovat případnou poznámku (věcné břemeno)
                const role = adresaCell.querySelector('.os-role');
                let content = data.adresa;
                
                if (role) {
                    content = role.outerHTML + ' ' + content;
                }
                
                // Přidat DS info pokud existuje
                if (data.ds) {
                    content += ` <span class="os-ds-info"><span class="material-icons-outlined">forward_to_inbox</span> ${data.ds}</span>`;
                }
                
                adresaCell.innerHTML = content;
                adresaCell.classList.remove('os-adresa-neovereno');
            }
            
            // Aktualizovat doručování
            const dorucCell = row.querySelector('td:nth-child(5)');
            if (dorucCell && data) {
                if (data.ds) {
                    // Má datovou schránku - defaultně doručovat do DS
                    dorucCell.innerHTML = `
                        <button class="btn-dorucovani ds" onclick="toggleDorucovani(this)" title="Doručit do datové schránky" data-stav="ds" data-ds="${data.ds}">
                            <span class="material-icons-outlined">forward_to_inbox</span>
                        </button>
                    `;
                } else {
                    // Nemá DS - doručovat poštou
                    dorucCell.innerHTML = `
                        <button class="btn-dorucovani posta" onclick="toggleDorucovani(this)" title="Doručit poštou" data-stav="posta">
                            <span class="material-icons-outlined">mail</span>
                        </button>
                    `;
                }
            }
            
            // Odstranit tlačítko ověřit
            const overitBtn = row.querySelector('.btn-overit-osobu');
            if (overitBtn) {
                overitBtn.remove();
            }
            
            // Označit jako ověřeno
            row.setAttribute('data-overeno', 'true');
        }
        
        // Přepínání způsobu doručování: DS -> Pošta -> Nedoručovat -> DS/Pošta
        function toggleDorucovani(btn) {
            const stav = btn.getAttribute('data-stav');
            const ds = btn.getAttribute('data-ds');
            
            if (stav === 'ds') {
                // DS -> Pošta
                btn.className = 'btn-dorucovani posta';
                btn.setAttribute('data-stav', 'posta');
                btn.title = 'Doručit poštou';
                btn.innerHTML = '<span class="material-icons-outlined">mail</span>';
            } else if (stav === 'posta') {
                // Pošta -> Nedoručovat
                btn.className = 'btn-dorucovani nedorucovat';
                btn.setAttribute('data-stav', 'nedorucovat');
                btn.title = 'Nedoručovat';
                btn.innerHTML = '<span class="material-icons-outlined">do_not_disturb_on</span>';
            } else {
                // Nedoručovat -> DS (pokud má) nebo Pošta
                if (ds) {
                    btn.className = 'btn-dorucovani ds';
                    btn.setAttribute('data-stav', 'ds');
                    btn.title = 'Doručit do datové schránky';
                    btn.innerHTML = '<span class="material-icons-outlined">forward_to_inbox</span>';
                } else {
                    btn.className = 'btn-dorucovani posta';
                    btn.setAttribute('data-stav', 'posta');
                    btn.title = 'Doručit poštou';
                    btn.innerHTML = '<span class="material-icons-outlined">mail</span>';
                }
            }
        }
        
        // ==========================================
        // ZÁSTUPCI - FUNKCE
        // ==========================================
        
        // Stav ověření zástupce
        let zastupceOveren = { FO: false, PO: false };
        
        // Otevřít modal pro přidání zástupce
        function openPridatZastupceModal() {
            // Reset formuláře
            document.getElementById('zastupceJmeno').value = '';
            document.getElementById('zastupcePrijmeni').value = '';
            document.getElementById('zastupceDatumNarozeni').value = '';
            document.getElementById('zastupceICO').value = '';
            document.getElementById('zastupceNazev').value = '';
            
            // Reset ověření
            zastupceOveren = { FO: false, PO: false };
            document.getElementById('verifyStatusFO').innerHTML = '';
            document.getElementById('verifyStatusPO').innerHTML = '';
            document.getElementById('zastupceDetailFO').style.display = 'none';
            document.getElementById('zastupceDetailPO').style.display = 'none';
            document.getElementById('zastupceAdresaFO').value = '';
            document.getElementById('zastupceAdresaPO').value = '';
            
            document.querySelector('input[name="zastupce_typ"][value="FO"]').checked = true;
            toggleZastupceForm();
            
            // Reset checkboxů
            document.querySelectorAll('input[name="zastupovani"]').forEach(cb => cb.checked = false);
            document.getElementById('zastupceNedorucovat').checked = true;
            
            // Aktualizovat seznam zastupovaných (přidat dynamicky načtené vlastníky)
            aktualizovatZastupovaniList();
            
            // Zobrazit modal
            document.getElementById('modalPridatZastupce').style.display = 'flex';
        }
        
        // Zavřít modal zástupce
        function closeModalZastupce() {
            document.getElementById('modalPridatZastupce').style.display = 'none';
        }
        
        // Přepínání mezi FO a PO formulářem
        function toggleZastupceForm() {
            const typ = document.querySelector('input[name="zastupce_typ"]:checked').value;
            document.getElementById('zastupceFormFO').style.display = typ === 'FO' ? 'block' : 'none';
            document.getElementById('zastupceFormPO').style.display = typ === 'PO' ? 'block' : 'none';
        }
        
        // Ověřit zástupce z rejstříku
        function overitZastupceZRejstriku(typ) {
            const statusEl = document.getElementById('verifyStatus' + typ);
            
            if (typ === 'FO') {
                const jmeno = document.getElementById('zastupceJmeno').value.trim();
                const prijmeni = document.getElementById('zastupcePrijmeni').value.trim();
                const datumNar = document.getElementById('zastupceDatumNarozeni').value;
                
                if (!jmeno || !prijmeni || !datumNar) {
                    statusEl.className = 'verify-status error';
                    statusEl.innerHTML = '<span class="material-icons-outlined">error</span> Vyplňte všechna pole';
                    return;
                }
                
                // Simulace ověření
                statusEl.className = 'verify-status loading';
                statusEl.innerHTML = '<span class="material-icons-outlined">hourglass_empty</span> Ověřuji...';
                
                setTimeout(() => {
                    // Simulace úspěšného ověření
                    statusEl.className = 'verify-status success';
                    statusEl.innerHTML = '<span class="material-icons-outlined">check_circle</span> Osoba nalezena v registru obyvatel';
                    
                    // Zobrazit doplněné údaje
                    document.getElementById('zastupceDetailFO').style.display = 'block';
                    document.getElementById('zastupceAdresaFO').value = 'Hlavní 456, 110 00 Praha 1';
                    
                    zastupceOveren.FO = true;
                }, 800);
                
            } else if (typ === 'PO') {
                const ico = document.getElementById('zastupceICO').value.trim();
                
                if (!ico || ico.length !== 8) {
                    statusEl.className = 'verify-status error';
                    statusEl.innerHTML = '<span class="material-icons-outlined">error</span> Zadejte platné IČO (8 číslic)';
                    return;
                }
                
                // Simulace ověření
                statusEl.className = 'verify-status loading';
                statusEl.innerHTML = '<span class="material-icons-outlined">hourglass_empty</span> Ověřuji v ARES...';
                
                setTimeout(() => {
                    // Simulace dat z ARES
                    const aresData = {
                        '12345678': { nazev: 'Advokátní kancelář Novák & Partners s.r.o.', sidlo: 'Václavské náměstí 1, 110 00 Praha 1' },
                        '87654321': { nazev: 'Právní služby Praha a.s.', sidlo: 'Národní 10, 110 00 Praha 1' },
                    };
                    
                    const data = aresData[ico];
                    
                    if (data) {
                        statusEl.className = 'verify-status success';
                        statusEl.innerHTML = '<span class="material-icons-outlined">check_circle</span> Subjekt nalezen v ARES';
                        
                        // Zobrazit doplněné údaje
                        document.getElementById('zastupceDetailPO').style.display = 'block';
                        document.getElementById('zastupceNazev').value = data.nazev;
                        document.getElementById('zastupceAdresaPO').value = data.sidlo;
                        
                        zastupceOveren.PO = true;
                    } else {
                        statusEl.className = 'verify-status error';
                        statusEl.innerHTML = '<span class="material-icons-outlined">error</span> Subjekt nenalezen v ARES';
                        zastupceOveren.PO = false;
                    }
                }, 1000);
            }
        }
        
        // Aktualizovat seznam zastupovaných osob
        function aktualizovatZastupovaniList() {
            const dynamicList = document.getElementById('zastupovaniDynamicList');
            if (!dynamicList) return;
            
            // Přidat vlastníky z KN pokud byli načteni
            const vlastniciRows = document.querySelectorAll('#tbodyUcastnici tr:not(.osoby-kategorie-row):not(.osoby-empty-row)');
            let html = '';
            
            vlastniciRows.forEach((row, index) => {
                const nameEl = row.querySelector('td:nth-child(2) strong');
                if (nameEl) {
                    const name = nameEl.textContent;
                    // Přeskočit již existující v základním seznamu
                    if (name === 'Správa železnic, s.o.' || name === 'Městys Doudleby n.O.') return;
                    
                    const typeEl = row.querySelector('td:nth-child(2) small');
                    const type = typeEl ? typeEl.textContent : '';
                    
                    // Určit roli podle kontextu (zjednodušeně)
                    let role = 'Účastník řízení';
                    const prevRow = row.previousElementSibling;
                    if (prevRow && prevRow.classList.contains('osoby-kategorie-row')) {
                        const katLabel = prevRow.querySelector('.kategorie-label');
                        if (katLabel) role = katLabel.textContent;
                    }
                    
                    html += `
                        <label class="zastupovani-item">
                            <input type="checkbox" name="zastupovani" value="dynamic-${index}">
                            <div class="zastupovani-info">
                                <span class="zastupovani-name">${name}</span>
                                <span class="zastupovani-role">${role}</span>
                            </div>
                        </label>
                    `;
                }
            });
            
            dynamicList.innerHTML = html;
        }
        
        // Přidat zástupce
        function pridatZastupce() {
            const typ = document.querySelector('input[name="zastupce_typ"]:checked').value;
            let jmeno = '';
            let typOsoby = '';
            let adresa = '';
            
            if (typ === 'FO') {
                // Kontrola ověření
                if (!zastupceOveren.FO) {
                    alert('Nejprve ověřte osobu z rejstříku.');
                    return;
                }
                
                const j = document.getElementById('zastupceJmeno').value.trim();
                const p = document.getElementById('zastupcePrijmeni').value.trim();
                jmeno = `${j} ${p}`;
                typOsoby = 'Fyzická osoba';
                adresa = document.getElementById('zastupceAdresaFO').value;
            } else {
                // Kontrola ověření
                if (!zastupceOveren.PO) {
                    alert('Nejprve ověřte subjekt z rejstříku ARES.');
                    return;
                }
                
                jmeno = document.getElementById('zastupceNazev').value.trim();
                typOsoby = 'Právnická osoba';
                adresa = document.getElementById('zastupceAdresaPO').value;
            }
            
            // Získat vybrané zastupované osoby
            const zastupovani = [];
            document.querySelectorAll('input[name="zastupovani"]:checked').forEach(cb => {
                const item = cb.closest('.zastupovani-item');
                const nameEl = item.querySelector('.zastupovani-name');
                const roleEl = item.querySelector('.zastupovani-role');
                if (nameEl) {
                    zastupovani.push({
                        name: nameEl.textContent,
                        role: roleEl ? roleEl.textContent : ''
                    });
                }
            });
            
            if (zastupovani.length === 0) {
                alert('Vyberte alespoň jednu zastupovanou osobu.');
                return;
            }
            
            const nedorucovat = document.getElementById('zastupceNedorucovat').checked;
            
            // Přidat do tabulky
            pridatZastupceDoTabulky(jmeno, typOsoby, zastupovani, nedorucovat);
            
            // Zavřít modal
            closeModalZastupce();
            
            // Aktualizovat počet
            aktualizovatPocetZastupcu();
            
            showToast(`Zástupce ${jmeno} byl přidán`);
        }
        
        // Přidat zástupce do tabulky
        function pridatZastupceDoTabulky(jmeno, typOsoby, zastupovani, nedorucovat) {
            const tbody = document.getElementById('tbodyZastupci');
            if (!tbody) return;
            
            // Odstranit prázdný řádek
            const emptyRow = document.getElementById('emptyZastupci');
            if (emptyRow) emptyRow.remove();
            
            // Vytvořit badges pro zastupované osoby
            const zastupujeBadges = zastupovani.map(z => `
                <span class="zastupuje-badge">
                    <span class="material-icons-outlined">person</span>
                    ${z.name}
                </span>
            `).join('');
            
            // Určit role (první zastupovaný)
            const role = zastupovani[0]?.role || 'Účastník';
            
            // Checkbox pro doručování
            const dorucChecked = !nedorucovat ? 'checked' : '';
            
            const newRow = document.createElement('tr');
            newRow.innerHTML = `
                <td><span class="os-status ok"><span class="material-icons-outlined">check_circle</span></span></td>
                <td>
                    <strong>${jmeno}</strong><br>
                    <small class="text-muted">${typOsoby}</small>
                </td>
                <td class="zastupuje-cell">${zastupujeBadges}</td>
                <td><span class="os-role">${role}</span></td>
                <td>
                    <div class="dorucovat-toggle">
                        <input type="checkbox" ${dorucChecked} onchange="toggleDorucovat(this)" title="Doručovat zástupci">
                        <span class="dorucovat-label ${!nedorucovat ? 'yes' : 'no'}">${!nedorucovat ? 'Ano' : 'Ne'}</span>
                    </div>
                </td>
                <td class="os-actions">
                    <button onclick="toggleOblibeny(this)" title="Oblíbený"><span class="material-icons-outlined">star_border</span></button>
                    <button title="Detail"><span class="material-icons-outlined">visibility</span></button>
                    <button title="Upravit"><span class="material-icons-outlined">edit</span></button>
                    <button title="Odstranit" onclick="odstranZastupce(this)"><span class="material-icons-outlined">delete</span></button>
                </td>
            `;
            
            tbody.appendChild(newRow);
            
            // Označit zastupované účastníky v tabulce Účastníci
            zastupovani.forEach(z => {
                oznacitUcastnikaJakoZastoupeneho(z.name, jmeno);
            });
        }
        
        // Označit účastníka jako zastoupeného
        function oznacitUcastnikaJakoZastoupeneho(ucastnikJmeno, zastupceJmeno) {
            // Najít účastníka podle jména
            const rows = document.querySelectorAll('#tabPanelUcastnici tr[data-osoba-id]');
            rows.forEach(row => {
                const jmenoEl = row.querySelector('td:nth-child(2) strong');
                if (jmenoEl && jmenoEl.textContent.trim() === ucastnikJmeno) {
                    // Najít nebo vytvořit element pro info o zastoupení
                    let zastoupenInfo = row.querySelector('.os-zastoupen-info');
                    if (!zastoupenInfo) {
                        const tdJmeno = row.querySelector('td:nth-child(2)');
                        zastoupenInfo = document.createElement('span');
                        zastoupenInfo.className = 'os-zastoupen-info';
                        tdJmeno.appendChild(zastoupenInfo);
                    }
                    
                    zastoupenInfo.innerHTML = `<span class="material-icons-outlined">supervisor_account</span> Zastoupen: ${zastupceJmeno}`;
                    zastoupenInfo.style.display = 'block';
                }
            });
        }
        
        // Toggle doručování
        function toggleDorucovat(checkbox) {
            const label = checkbox.nextElementSibling;
            if (checkbox.checked) {
                label.textContent = 'Ano';
                label.className = 'dorucovat-label yes';
            } else {
                label.textContent = 'Ne';
                label.className = 'dorucovat-label no';
            }
        }
        
        // Odstranit zástupce
        function odstranZastupce(btn) {
            if (!confirm('Opravdu chcete odstranit tohoto zástupce?')) return;
            
            const row = btn.closest('tr');
            row.remove();
            
            aktualizovatPocetZastupcu();
            
            // Pokud není žádný zástupce, zobrazit prázdný řádek
            const tbody = document.getElementById('tbodyZastupci');
            if (tbody && tbody.children.length === 0) {
                tbody.innerHTML = `
                    <tr class="osoby-empty-row" id="emptyZastupci">
                        <td colspan="6" class="text-center text-muted">
                            <span class="material-icons-outlined" style="font-size: 16px; vertical-align: middle;">supervisor_account</span>
                            Žádní zástupci — přidejte zástupce tlačítkem výše
                        </td>
                    </tr>
                `;
            }
            
            showToast('Zástupce byl odstraněn');
        }
        
        // Aktualizovat počet zástupců
        function aktualizovatPocetZastupcu() {
            const tbody = document.getElementById('tbodyZastupci');
            const countEl = document.getElementById('tabCountZastupci');
            if (!tbody || !countEl) return;
            
            const rows = tbody.querySelectorAll('tr:not(.osoby-empty-row)');
            countEl.textContent = rows.length;
        }
        
        // Přidat zástupce z oblíbených (simulace)
        function pridatZastupceZOblibenych() {
            // Simulace - v reálu by se otevřel modal s oblíbenými
            const oblibeneni = [
                { jmeno: 'JUDr. Pavel Právník', typ: 'Fyzická osoba', adresa: 'Právnická 123, 110 00 Praha 1', datumNar: '1975-05-15' },
                { jmeno: 'Advokátní kancelář Novák & Partners s.r.o.', typ: 'Právnická osoba', ico: '12345678', sidlo: 'Václavské náměstí 1, 110 00 Praha 1' }
            ];
            
            // Zobrazit jednoduchý výběr
            const vyber = prompt(
                'Vyberte oblíbeného zástupce (zadejte číslo):\n\n' +
                oblibeneni.map((o, i) => `${i + 1}. ${o.jmeno}`).join('\n')
            );
            
            if (vyber) {
                const index = parseInt(vyber) - 1;
                if (index >= 0 && index < oblibeneni.length) {
                    const oblibeny = oblibeneni[index];
                    
                    // Reset stavů
                    zastupceOveren = { FO: false, PO: false };
                    document.getElementById('verifyStatusFO').innerHTML = '';
                    document.getElementById('verifyStatusPO').innerHTML = '';
                    document.getElementById('zastupceDetailFO').style.display = 'none';
                    document.getElementById('zastupceDetailPO').style.display = 'none';
                    
                    if (oblibeny.typ === 'Fyzická osoba') {
                        document.querySelector('input[name="zastupce_typ"][value="FO"]').checked = true;
                        const parts = oblibeny.jmeno.split(' ');
                        document.getElementById('zastupceJmeno').value = parts[0] || '';
                        document.getElementById('zastupcePrijmeni').value = parts.slice(1).join(' ') || '';
                        document.getElementById('zastupceDatumNarozeni').value = oblibeny.datumNar || '';
                        
                        // Automaticky nastavit jako ověřeného (z oblíbených)
                        document.getElementById('zastupceDetailFO').style.display = 'block';
                        document.getElementById('zastupceAdresaFO').value = oblibeny.adresa;
                        document.getElementById('verifyStatusFO').className = 'verify-status success';
                        document.getElementById('verifyStatusFO').innerHTML = '<span class="material-icons-outlined">check_circle</span> Z oblíbených';
                        zastupceOveren.FO = true;
                    } else {
                        document.querySelector('input[name="zastupce_typ"][value="PO"]').checked = true;
                        document.getElementById('zastupceICO').value = oblibeny.ico || '';
                        document.getElementById('zastupceNazev').value = oblibeny.jmeno;
                        
                        // Automaticky nastavit jako ověřeného (z oblíbených)
                        document.getElementById('zastupceDetailPO').style.display = 'block';
                        document.getElementById('zastupceAdresaPO').value = oblibeny.sidlo;
                        document.getElementById('verifyStatusPO').className = 'verify-status success';
                        document.getElementById('verifyStatusPO').innerHTML = '<span class="material-icons-outlined">check_circle</span> Z oblíbených';
                        zastupceOveren.PO = true;
                    }
                    
                    toggleZastupceForm();
                    aktualizovatZastupovaniList();
                    document.querySelectorAll('input[name="zastupovani"]').forEach(cb => cb.checked = false);
                    document.getElementById('zastupceNedorucovat').checked = true;
                    document.getElementById('modalPridatZastupce').style.display = 'flex';
                }
            }
        }
        
        // Toast notifikace
        function showToast(message, type = 'success') {
            const existing = document.querySelector('.toast-notification');
            if (existing) existing.remove();
            
            const icons = {
                success: 'check_circle',
                warning: 'warning',
                error: 'error',
                info: 'info'
            };
            const colors = {
                success: '#137333',
                warning: '#b06000',
                error: '#c5221f',
                info: '#1a73e8'
            };
            
            const toast = document.createElement('div');
            toast.className = 'toast-notification';
            toast.innerHTML = `
                <span class="material-icons-outlined" style="color: ${colors[type] || colors.success}">${icons[type] || icons.success}</span>
                ${message}
            `;
            toast.style.cssText = `
                position: fixed;
                bottom: 24px;
                left: 50%;
                transform: translateX(-50%);
                display: inline-flex;
                align-items: center;
                gap: 8px;
                padding: 12px 24px;
                background: #323232;
                color: #fff;
                border-radius: 8px;
                font-size: 14px;
                z-index: 10000;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                animation: toastIn 0.3s ease;
            `;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'toastOut 0.3s ease forwards';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        function completeUcastnici() {
            controls.ucastnici.done = true;
            controls.ucastnici.result = 'ok';
            closeControl('controlUcastnici');
            updateUI();
        }

        function completeZrychlene() {
            const checkboxes = document.querySelectorAll('#controlZrychlene input[type="checkbox"]');
            let allChecked = true;
            checkboxes.forEach(cb => { if (!cb.checked) allChecked = false; });
            
            controls.zrychlene.done = true;
            controls.zrychlene.result = allChecked ? 'ok' : 'warning';
            
            closeControl('controlZrychlene');
            updateUI();
        }

        function zahajitRizeni() {
            if (_btnAction === 'postoupit') {
                const postoupit = controls.prislusnost.postoupit;
                let msg = 'Řízení bude postoupeno příslušnému stavebnímu úřadu.\n\n';
                
                if (postoupit) {
                    const info = postoupit.info.split('|');
                    if (postoupit.typ === 'vecna') {
                        msg += `Typ nepříslušnosti: Věcná\n`;
                        msg += `Příslušný úřad: ${postoupit.typSu}\n`;
                        msg += `Název: ${info[0]}\n`;
                        msg += `Adresa: ${info[1]}\n`;
                        msg += `E-mail: ${info[2]}\n`;
                    } else {
                        msg += `Typ nepříslušnosti: Místní\n`;
                        msg += `Příslušný úřad: ${info[0]}\n`;
                        msg += `Adresa: ${info[1]}\n`;
                        msg += `E-mail: ${info[2]}\n`;
                        msg += `Územní obvod: ${info[3]}\n`;
                    }
                }
                
                msg += '\nV ostré verzi by následovalo flow pro postoupení řízení.';
                alert(msg);
            } else if (_btnAction === 'vyzva') {
                openVyzvaEditor();
            } else {
                // Přechod na krok 3: Projednání
                window.location.href = 'povoleni-3.html';
            }
        }

        // ==========================================
        // EDITOR: Výzva k doplnění + Usnesení o přerušení
        // ==========================================
        function openVyzvaEditor() {
            if (document.getElementById('vyzvaEditorOverlay')) return;

            // === DATOVÝ MODEL DOKUMENTU (JSON) ===
            const issues = globalIssues.vyzva.filter(i => !i.resolved);
            const dnes = new Date();
            const lhutaDate = new Date(dnes.getTime() + 30 * 24 * 60 * 60 * 1000);
            const lhutaStr = lhutaDate.toISOString().split('T')[0];
            const dnesFormatted = dnes.toLocaleDateString('cs-CZ', { day: 'numeric', month: 'long', year: 'numeric' });

            // Kategorizace
            const kategorieMap = {
                'autorizace': 'Autorizace a ověření PD',
                'dokladova_cast': 'Dokladová část',
                'obsah_pd': 'Obsah projektové dokumentace',
                'prurezovy': 'Průřezové nedostatky',
                'formalni': 'Formální nedostatky'
            };
            const grouped = {};
            issues.forEach(i => {
                const k = i.kategorie || 'ostatni';
                if (!grouped[k]) grouped[k] = [];
                grouped[k].push(i);
            });

            // === BLOKY ŠABLONY ===
            // Každý blok má: id, type (auto|semi|edit), source, label, obsah
            const templateBlocks = [
                {
                    id: 'b-header',
                    type: 'auto',
                    source: 'workflow',
                    label: 'Identifikační záhlaví',
                    icon: 'account_balance',
                    locked: true
                },
                {
                    id: 'b-adresat',
                    type: 'auto',
                    source: 'workflow / registr účastníků',
                    label: 'Adresát a záměr',
                    icon: 'person',
                    locked: true
                },
                {
                    id: 'b-uvod',
                    type: 'auto',
                    source: 'workflow',
                    label: 'Úvodní věta výzvy',
                    icon: 'article',
                    locked: true
                },
                {
                    id: 'b-nedostatky',
                    type: 'semi',
                    source: 'moduly kontrol',
                    label: 'Seznam nedostatků',
                    icon: 'checklist',
                    locked: false
                },
                {
                    id: 'b-oduvodneni',
                    type: 'edit',
                    source: 'refstat (volný text)',
                    label: 'Odůvodnění',
                    icon: 'edit_note',
                    locked: false,
                    aiHelper: true
                },
                {
                    id: 'b-vyzva-text',
                    type: 'auto',
                    source: 'šablona + lhůta',
                    label: 'Text výzvy a lhůta',
                    icon: 'timer',
                    locked: true
                },
                {
                    id: 'b-usneseni',
                    type: 'auto',
                    source: 'šablona + záměr',
                    label: 'Usnesení o přerušení',
                    icon: 'gavel',
                    locked: true
                },
                {
                    id: 'b-pouceni',
                    type: 'auto',
                    source: 'šablona',
                    label: 'Poučení',
                    icon: 'info',
                    locked: true
                }
            ];

            // === GENERÁTOR OBSAHU BLOKŮ ===
            function renderBlockContent(block) {
                if (block.id === 'b-header') {
                    return `<div class="doc-block-inner auto-block">
                        <div class="block-field-row">
                            <span class="field-label">Č.j.:</span>
                            <span class="field-value">DESU/122/000147/26</span>
                        </div>
                        <div class="block-field-row">
                            <span class="field-label">Spis. zn.:</span>
                            <span class="field-value">SZ DESU/R/2026/000147</span>
                        </div>
                        <div class="block-field-row">
                            <span class="field-label">Datum:</span>
                            <span class="field-value">${dnesFormatted}</span>
                        </div>
                        <div class="block-field-row">
                            <span class="field-label">Vyřizuje:</span>
                            <span class="field-value">Ing. Tomáš Novák · tomas.novak@desu.gov.cz</span>
                        </div>
                    </div>`;
                }
                if (block.id === 'b-adresat') {
                    return `<div class="doc-block-inner auto-block">
                        <div style="font-size:13px;color:#3c4043;line-height:1.7;">
                            <strong>Správa železnic, státní organizace</strong><br>
                            Dlážděná 1003/7, 110 00 Praha 1-Nové Město<br>
                            <span style="color:#9aa0a6;font-size:12px;">v zastoupení: Signal Projekt s.r.o., Vídeňská 546/55, 639 00 Brno · IDDS: signal01</span>
                        </div>
                    </div>`;
                }
                if (block.id === 'b-uvod') {
                    return `<div class="doc-block-inner auto-block">
                        <p style="font-size:13px;color:#3c4043;line-height:1.7;">
                            DESÚ jako stavební úřad příslušný dle § 33 odst. 2 zákona č. 283/2021 Sb. obdržel
                            dne 6. 1. 2026 žádost stavebníka <strong>Správa železnic, státní organizace</strong>,
                            zastoupeného společností <strong>Signal Projekt s.r.o.</strong>, o vydání povolení záměru:
                            <em style="color:#004289;">„Oprava zabezpečovacího zařízení v žst. Doudleby nad Orlicí"</em>.
                            Po přezkoumání žádosti stavební úřad zjistil následující nedostatky:
                        </p>
                    </div>`;
                }
                if (block.id === 'b-nedostatky') {
                    let html = '<div class="doc-block-inner semi-block">';
                    if (issues.length === 0) {
                        html += `<div class="empty-issues">
                            <span class="material-icons-outlined" style="font-size:28px;color:#9aa0a6;display:block;margin-bottom:6px;">check_circle_outline</span>
                            Žádné nedostatky z kontrol. Přidejte ručně nebo dokončete kontroly.
                        </div>`;
                    } else {
                        let num = 1;
                        Object.entries(grouped).forEach(([kat, items]) => {
                            const label = kategorieMap[kat] || 'Ostatní';
                            html += `<div class="issue-category-label">${label}</div>`;
                            items.forEach(item => {
                                const text = (item.hlavniText || item.text || '').replace(/\n/g, '<br>');
                                const src = item.controlName ? `<span class="issue-source">${item.controlName}</span>` : '';
                                const legal = item.pravniPredpis ? `<div class="issue-legal">${item.pravniPredpis}</div>` : '';
                                html += `<div class="issue-row" id="irow-${item.id}">
                                    <span class="issue-num">${num}.</span>
                                    <div class="issue-body">
                                        <div>${text}${src}</div>
                                        ${legal}
                                    </div>
                                    <button class="issue-remove-btn" onclick="removeIssueRow('${item.id}')" title="Odebrat z výzvy">
                                        <span class="material-icons-outlined" style="font-size:15px;">close</span>
                                    </button>
                                </div>`;
                                num++;
                            });
                        });
                    }
                    html += `<button class="add-issue-btn" onclick="addManualIssue()">
                        <span class="material-icons-outlined" style="font-size:15px;vertical-align:-2px;">add</span>
                        Přidat nedostatek ručně
                    </button>`;
                    html += '</div>';
                    return html;
                }
                if (block.id === 'b-oduvodneni') {
                    return `<div class="doc-block-inner edit-block">
                        <div class="edit-toolbar">
                            <button onclick="fmtDoc('bold')" title="Tučné"><b>B</b></button>
                            <button onclick="fmtDoc('italic')" title="Kurzíva"><i>I</i></button>
                            <button onclick="fmtDoc('underline')" title="Podtrž"><u>U</u></button>
                            <div class="toolbar-sep"></div>
                            <button onclick="fmtDoc('insertUnorderedList')" title="Odrážky">≡</button>
                            <button onclick="fmtDoc('insertOrderedList')" title="Číslov.">1.</button>
                        </div>
                        <div id="oduvodneniEditor" class="rich-editor" contenteditable="true"
                             data-placeholder="Doplňte odůvodnění výzvy — důvody pro vydání, odkaz na kontrolní zjištění, právní základ..."
                             spellcheck="true">
                        </div>
                        <div class="ai-hint-bar">
                            <span class="material-icons-outlined" style="font-size:15px;color:#7c4dff;vertical-align:-3px;">auto_awesome</span>
                            <span style="font-size:12px;color:#7c4dff;font-weight:500;">AI asistent</span>
                            <span style="font-size:12px;color:#9aa0a6;margin:0 6px;">·</span>
                            <span style="font-size:12px;color:#5f6368;">Navrhnout odůvodnění na základě zjištěných nedostatků</span>
                            <button onclick="aiSuggestOduvodneni()" class="ai-suggest-btn">Navrhnout</button>
                        </div>
                    </div>`;
                }
                if (block.id === 'b-vyzva-text') {
                    return `<div class="doc-block-inner auto-block">
                        <p style="font-size:13px;color:#3c4043;line-height:1.7;">
                            DESÚ Vás vyzývá, abyste ve lhůtě
                            <strong style="color:#c0392b;" id="lhutaInlineText">30 dnů</strong>
                            ode dne doručení této výzvy výše uvedené nedostatky odstranili nebo doplnili. Pokud nedostatky neodstraníte,
                            stavební úřad žádost odloží dle § 45 odst. 2 správního řádu.
                        </p>
                    </div>`;
                }
                if (block.id === 'b-usneseni') {
                    return `<div class="doc-block-inner auto-block">
                        <div style="font-size:12px;font-weight:700;color:#1565c0;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:8px;">Usnesení</div>
                        <p style="font-size:13px;color:#3c4043;line-height:1.7;">
                            DESÚ dle § 185 odst. 2 stavebního zákona <strong>přerušuje řízení</strong> o záměru
                            <em>„Oprava zabezpečovacího zařízení v žst. Doudleby nad Orlicí"</em>
                            do doby doplnění žádosti, nejdéle na dobu
                            <strong style="color:#c0392b;" id="lhutaUsneseniText">30 dnů</strong> od doručení výzvy.
                        </p>
                        <p style="font-size:12px;color:#5f6368;margin-top:8px;font-style:italic;">
                            Účastníci řízení: Správa železnic, státní organizace, Dlážděná 1003/7, 110 00 Praha 1-Nové Město
                        </p>
                    </div>`;
                }
                if (block.id === 'b-pouceni') {
                    return `<div class="doc-block-inner auto-block">
                        <p style="font-size:12px;color:#5f6368;line-height:1.6;font-style:italic;">
                            Proti tomuto usnesení se nelze odvolat (§ 185 odst. 2 stavebního zákona).
                        </p>
                    </div>`;
                }
                return '<div class="doc-block-inner auto-block"><em style="color:#9aa0a6;">Obsah bloku</em></div>';
            }

            // === LEGENDA TYPŮ BLOKŮ ===
            const typeConfig = {
                auto: { label: 'Automatický', color: '#1565c0', bg: '#e8f4fd', icon: 'lock', desc: 'Data ze workflow, nelze editovat' },
                semi: { label: 'Poloautomatický', color: '#e65100', bg: '#fff3e0', icon: 'tune', desc: 'Předvyplněno z kontrol, lze upravit' },
                edit: { label: 'Editovatelný', color: '#1b5e20', bg: '#e8f5e9', icon: 'edit', desc: 'Volný text, rich-text editor + AI' }
            };

            // === SESTAVIT HTML LEVÉHO SIDEBARU (struktura šablony) ===
            let sidebarHtml = '';
            templateBlocks.forEach((b, idx) => {
                const tc = typeConfig[b.type];
                sidebarHtml += `
                <div class="block-nav-item" id="nav-${b.id}" onclick="scrollToBlock('${b.id}')">
                    <span class="material-icons-outlined" style="font-size:16px;color:${tc.color};">${b.icon}</span>
                    <div class="block-nav-info">
                        <div class="block-nav-label">${b.label}</div>
                        <div class="block-nav-source">${b.source}</div>
                    </div>
                    <span class="block-type-badge" style="background:${tc.bg};color:${tc.color};">${tc.label}</span>
                </div>`;
            });

            // === SESTAVIT HTML EDITORU DOKUMENTU ===
            let editorHtml = '';
            templateBlocks.forEach(b => {
                const tc = typeConfig[b.type];
                const content = renderBlockContent(b);
                const lockBadge = b.locked
                    ? `<span class="material-icons-outlined block-lock-icon" title="Automaticky generováno ze systému">lock</span>`
                    : (b.type === 'edit' ? `<span class="material-icons-outlined block-lock-icon" style="color:#2e7d32;" title="Editovatelný blok">edit</span>` : `<span class="material-icons-outlined block-lock-icon" style="color:#e65100;" title="Poloautomatický — upravitelný">tune</span>`);

                editorHtml += `
                <div class="doc-block" id="block-${b.id}" data-type="${b.type}">
                    <div class="doc-block-header">
                        <div class="doc-block-title-row">
                            <span class="material-icons-outlined" style="font-size:16px;color:${tc.color};">${b.icon}</span>
                            <span class="doc-block-title">${b.label}</span>
                            <span class="block-source-tag">${b.source}</span>
                        </div>
                        <div style="display:flex;align-items:center;gap:6px;">
                            <span class="block-type-pill" style="background:${tc.bg};color:${tc.color};">
                                <span class="material-icons-outlined" style="font-size:12px;vertical-align:-2px;">${tc.icon}</span>
                                ${tc.label}
                            </span>
                            ${lockBadge}
                        </div>
                    </div>
                    <div class="doc-block-content">
                        ${content}
                    </div>
                </div>`;
            });

            // === SESTAVIT OVERLAY ===
            const overlay = document.createElement('div');
            overlay.id = 'vyzvaEditorOverlay';
            overlay.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.55);z-index:10000;display:flex;align-items:stretch;justify-content:center;padding:24px;';
            overlay.onclick = function(e) { if (e.target === overlay) closeVyzvaEditor(); };

            overlay.innerHTML = `
            <div style="background:#fff;border-radius:12px;width:100%;max-width:1200px;display:flex;flex-direction:column;box-shadow:0 24px 64px rgba(0,0,0,0.25);overflow:hidden;" onclick="event.stopPropagation()">

                <!-- === TOP BAR === -->
                <div style="background:#1a1a2e;padding:12px 20px;display:flex;align-items:center;gap:12px;flex-shrink:0;">
                    <span class="material-icons-outlined" style="color:#e8710a;font-size:20px;">mail</span>
                    <div style="flex:1;">
                        <div style="font-size:14px;font-weight:600;color:#fff;">Editor dokumentu — Výzva k doplnění žádosti</div>
                        <div style="font-size:11px;color:#9aa0a6;margin-top:1px;">sp. zn. R/2026/000147 · Oprava zabezpečovacího zařízení v žst. Doudleby nad Orlicí</div>
                    </div>
                    <!-- Lhůta (editovatelná) -->
                    <div style="display:flex;align-items:center;gap:6px;background:rgba(255,255,255,0.08);border-radius:8px;padding:6px 12px;">
                        <span class="material-icons-outlined" style="font-size:16px;color:#f9ab00;">timer</span>
                        <span style="font-size:12px;color:#9aa0a6;">Lhůta:</span>
                        <input type="number" value="30" min="7" max="90" id="vyzvaLhutaDni"
                            style="width:44px;padding:3px 5px;border:1px solid rgba(255,255,255,0.2);border-radius:4px;font-size:13px;font-weight:600;background:transparent;color:#fff;text-align:center;"
                            onchange="updateLhutaInEditor(this.value)">
                        <span style="font-size:12px;color:#9aa0a6;">dní</span>
                        <input type="date" value="${lhutaStr}" id="vyzvaLhutaDatum"
                            style="padding:3px 6px;border:1px solid rgba(255,255,255,0.2);border-radius:4px;font-size:12px;background:transparent;color:#ccc;">
                    </div>
                    <button onclick="closeVyzvaEditor()" style="background:rgba(255,255,255,0.08);border:none;cursor:pointer;padding:6px;border-radius:6px;color:#9aa0a6;">
                        <span class="material-icons-outlined">close</span>
                    </button>
                </div>

                <!-- === MAIN AREA === -->
                <div style="flex:1;display:flex;overflow:hidden;">

                    <!-- LEFT: Struktura šablony -->
                    <div style="width:260px;min-width:260px;border-right:1px solid #e0e0e0;overflow-y:auto;background:#fafafa;display:flex;flex-direction:column;">
                        <!-- Legenda -->
                        <div style="padding:12px 14px;border-bottom:1px solid #e0e0e0;">
                            <div style="font-size:11px;font-weight:600;color:#5f6368;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:8px;">Struktura šablony</div>
                            <div style="display:flex;flex-direction:column;gap:4px;">
                                <div style="display:flex;align-items:center;gap:6px;font-size:11px;color:#1565c0;">
                                    <span style="width:8px;height:8px;border-radius:2px;background:#e8f4fd;border:1px solid #90caf9;display:inline-block;"></span>
                                    Automatický — ze systému
                                </div>
                                <div style="display:flex;align-items:center;gap:6px;font-size:11px;color:#e65100;">
                                    <span style="width:8px;height:8px;border-radius:2px;background:#fff3e0;border:1px solid #ffcc80;display:inline-block;"></span>
                                    Poloautomatický — z kontrol
                                </div>
                                <div style="display:flex;align-items:center;gap:6px;font-size:11px;color:#1b5e20;">
                                    <span style="width:8px;height:8px;border-radius:2px;background:#e8f5e9;border:1px solid #a5d6a7;display:inline-block;"></span>
                                    Editovatelný — rich-text + AI
                                </div>
                            </div>
                        </div>
                        <!-- Bloky -->
                        <div style="flex:1;padding:8px 0;">
                            ${sidebarHtml}
                        </div>
                        <!-- Statistika -->
                        <div style="padding:10px 14px;border-top:1px solid #e0e0e0;font-size:11px;color:#9aa0a6;">
                            <div style="margin-bottom:3px;">Nedostatků: <strong style="color:#3c4043;">${issues.length}</strong></div>
                            <div>Šablona: <strong style="color:#3c4043;">VYZ-001 v2.4</strong></div>
                        </div>
                    </div>

                    <!-- RIGHT: Editor dokumentu -->
                    <div style="flex:1;overflow-y:auto;background:#f0f2f5;padding:24px 28px;" id="vyzvaEditorCanvas">

                        <!-- Hlavička dokumentu (jen dekorativní v editoru) -->
                        <div style="background:#004289;color:#fff;padding:12px 18px;border-radius:8px 8px 0 0;margin-bottom:0;display:flex;justify-content:space-between;align-items:center;">
                            <div>
                                <div style="font-size:12px;font-weight:700;letter-spacing:0.8px;text-transform:uppercase;">DOPRAVNÍ A ENERGETICKÝ STAVEBNÍ ÚŘAD</div>
                                <div style="font-size:10px;opacity:0.75;margin-top:2px;">Odbor staveb drah · ÚP Praha</div>
                            </div>
                            <div style="font-size:11px;opacity:0.8;text-align:right;">
                                <div>Č.j.: DESU/122/000147/26</div>
                                <div>Spis. zn.: SZ DESU/R/2026/000147</div>
                            </div>
                        </div>

                        <!-- Bloky dokumentu -->
                        <div style="background:#fff;border-radius:0 0 8px 8px;border:1px solid #e0e0e0;border-top:none;margin-bottom:24px;overflow:hidden;">
                            ${editorHtml}
                        </div>

                    </div>
                </div>

                <!-- === FOOTER === -->
                <div style="padding:12px 20px;border-top:1px solid #e0e0e0;display:flex;align-items:center;justify-content:space-between;background:#fafafa;flex-shrink:0;">
                    <div style="font-size:12px;color:#9aa0a6;display:flex;align-items:center;gap:8px;">
                        <span class="material-icons-outlined" style="font-size:15px;">info_outline</span>
                        Dokument bude uložen jako JSON · Výstup do PDF generován při odeslání
                    </div>
                    <div style="display:flex;gap:8px;">
                        <button onclick="closeVyzvaEditor()" style="padding:8px 18px;border:1px solid #dadce0;border-radius:6px;background:#fff;font-size:13px;cursor:pointer;color:#3c4043;">Zrušit</button>
                        <button onclick="exportVyzva('preview')" style="padding:8px 18px;border:1px solid #004289;border-radius:6px;background:#fff;font-size:13px;cursor:pointer;color:#004289;display:flex;align-items:center;gap:5px;">
                            <span class="material-icons-outlined" style="font-size:16px;">visibility</span>Náhled PDF
                        </button>
                        <button onclick="exportVyzva('send')" style="padding:8px 20px;border:none;border-radius:6px;background:#004289;font-size:13px;cursor:pointer;color:#fff;font-weight:500;display:flex;align-items:center;gap:5px;">
                            <span class="material-icons-outlined" style="font-size:16px;">send</span>Vydat a odeslat do DS
                        </button>
                    </div>
                </div>
            </div>

            <!-- INLINE STYLY EDITORU -->
            <style>
                /* Navigace bloků */
                .block-nav-item {
                    display:flex;align-items:flex-start;gap:8px;padding:8px 14px;cursor:pointer;
                    border-bottom:1px solid #f0f0f0;transition:background 0.15s;
                }
                .block-nav-item:hover { background:#f0f4fa; }
                .block-nav-item.active { background:#e8f0fe; border-left:3px solid #004289; }
                .block-nav-info { flex:1;min-width:0; }
                .block-nav-label { font-size:12px;font-weight:500;color:#3c4043;white-space:nowrap;overflow:hidden;text-overflow:ellipsis; }
                .block-nav-source { font-size:10.5px;color:#9aa0a6;margin-top:1px; }
                .block-type-badge { font-size:10px;padding:1px 5px;border-radius:4px;white-space:nowrap;margin-top:2px;flex-shrink:0; }

                /* Bloky editoru */
                .doc-block {
                    border-bottom:1px solid #e8eaf0;
                }
                .doc-block:last-child { border-bottom:none; }
                .doc-block-header {
                    display:flex;align-items:center;justify-content:space-between;
                    padding:8px 16px;background:#f8f9fa;border-bottom:1px solid #e0e0e0;
                }
                .doc-block-title-row { display:flex;align-items:center;gap:6px; }
                .doc-block-title { font-size:12px;font-weight:600;color:#3c4043; }
                .block-source-tag { font-size:10.5px;color:#9aa0a6;background:#f0f0f0;padding:1px 6px;border-radius:3px; }
                .block-type-pill { display:flex;align-items:center;gap:3px;font-size:11px;padding:2px 7px;border-radius:4px; }
                .block-lock-icon { font-size:14px;color:#9aa0a6; }
                .doc-block-content { padding:0; }

                /* Typy bloků */
                .auto-block { padding:12px 16px;background:#f8fbff;font-size:13px; }
                .semi-block { padding:12px 16px;background:#fffdf8; }
                .edit-block { background:#fff; }

                /* Pole auto-bloku */
                .block-field-row { display:flex;gap:6px;font-size:13px;margin-bottom:5px; }
                .field-label { font-weight:500;color:#5f6368;min-width:70px; }
                .field-value { color:#3c4043; }

                /* Nedostatky */
                .issue-category-label {
                    font-size:11px;font-weight:600;color:#004289;text-transform:uppercase;
                    letter-spacing:0.4px;padding:6px 0 4px;margin-top:6px;
                    border-bottom:1px solid #e8f0fe;margin-bottom:6px;
                }
                .issue-row {
                    display:flex;align-items:flex-start;gap:8px;padding:5px 0;
                    border-bottom:1px solid #f1f3f4;
                }
                .issue-num { font-weight:600;color:#9aa0a6;min-width:22px;font-size:13px; }
                .issue-body { flex:1;font-size:13px;line-height:1.55;color:#3c4043; }
                .issue-source { font-size:10.5px;color:#9aa0a6;margin-left:6px;background:#f1f3f4;padding:1px 5px;border-radius:3px; }
                .issue-legal { font-size:11px;color:#5f6368;font-style:italic;margin-top:2px; }
                .issue-remove-btn { background:none;border:none;cursor:pointer;color:#dadce0;padding:2px;flex-shrink:0; }
                .issue-remove-btn:hover { color:#d32f2f; }
                .add-issue-btn {
                    margin-top:10px;padding:5px 12px;background:#f8f9fa;border:1px dashed #dadce0;
                    border-radius:6px;font-size:12px;color:#5f6368;cursor:pointer;
                }
                .add-issue-btn:hover { background:#f0f4fa;color:#004289; }
                .empty-issues { text-align:center;padding:16px;color:#9aa0a6;font-size:12px; }

                /* Rich-text editor */
                .edit-toolbar {
                    padding:6px 12px;background:#f8f9fa;border-bottom:1px solid #e0e0e0;
                    display:flex;align-items:center;gap:2px;
                }
                .edit-toolbar button {
                    padding:3px 7px;border:1px solid #dadce0;border-radius:4px;
                    background:#fff;cursor:pointer;font-size:12px;color:#3c4043;
                }
                .edit-toolbar button:hover { background:#f0f4fa; }
                .toolbar-sep { width:1px;height:18px;background:#e0e0e0;margin:0 4px; }
                .rich-editor {
                    min-height:80px;padding:12px 16px;font-size:13px;line-height:1.7;
                    color:#3c4043;outline:none;
                }
                .rich-editor:empty:before {
                    content:attr(data-placeholder);color:#bdc1c6;font-style:italic;
                }
                .rich-editor:focus { background:#fafffe; }

                /* AI helper */
                .ai-hint-bar {
                    padding:7px 14px;background:#f3e8ff;border-top:1px solid #e9d5ff;
                    display:flex;align-items:center;gap:6px;
                }
                .ai-suggest-btn {
                    margin-left:auto;padding:4px 12px;border:1px solid #7c4dff;
                    border-radius:4px;background:#fff;color:#7c4dff;font-size:12px;
                    cursor:pointer;font-weight:500;
                }
                .ai-suggest-btn:hover { background:#f3e8ff; }
            </style>`;

            document.body.appendChild(overlay);
            document.body.style.overflow = 'hidden';

            // Zvýraznit první blok v navigaci
            setTimeout(() => {
                const first = overlay.querySelector('.block-nav-item');
                if (first) first.classList.add('active');
            }, 50);
        }

        function closeVyzvaEditor() {
            const overlay = document.getElementById('vyzvaEditorOverlay');
            if (overlay) overlay.remove();
            document.body.style.overflow = '';
        }

        // Helper funkce pro editor výzvy
        function updateLhutaInEditor(days) {
            const el1 = document.getElementById('lhutaInlineText');
            const el2 = document.getElementById('lhutaUsneseniText');
            const txt = days + ' dní';
            if (el1) el1.textContent = txt;
            if (el2) el2.textContent = txt;
            const datInput = document.getElementById('vyzvaLhutaDatum');
            if (datInput) {
                datInput.value = new Date(Date.now() + days * 86400000).toISOString().split('T')[0];
            }
        }

        function scrollToBlock(blockId) {
            const el = document.getElementById('block-' + blockId);
            if (el) el.scrollIntoView({ behavior: 'smooth', block: 'start' });
            // Aktivní stav v navigaci
            document.querySelectorAll('.block-nav-item').forEach(n => n.classList.remove('active'));
            const nav = document.getElementById('nav-' + blockId);
            if (nav) nav.classList.add('active');
        }

        function removeIssueRow(issueId) {
            const row = document.getElementById('irow-' + issueId);
            if (row) row.remove();
            // Přenumerovat
            let num = 1;
            document.querySelectorAll('.issue-row').forEach(r => {
                const numEl = r.querySelector('.issue-num');
                if (numEl) numEl.textContent = num++ + '.';
            });
        }

        function addManualIssue() {
            const text = prompt('Zadejte text nedostatku:');
            if (!text || !text.trim()) return;
            const newId = 'manual-' + Date.now();
            const list = document.querySelector('.semi-block');
            if (!list) return;
            const addBtn = list.querySelector('.add-issue-btn');
            const count = list.querySelectorAll('.issue-row').length;
            const row = document.createElement('div');
            row.className = 'issue-row';
            row.id = 'irow-' + newId;
            row.innerHTML = `
                <span class="issue-num">${count + 1}.</span>
                <div class="issue-body">
                    <div>${text.trim()} <span class="issue-source">ručně přidáno</span></div>
                </div>
                <button class="issue-remove-btn" onclick="removeIssueRow('${newId}')" title="Odebrat z výzvy">
                    <span class="material-icons-outlined" style="font-size:15px;">close</span>
                </button>`;
            list.insertBefore(row, addBtn);
        }

        function fmtDoc(cmd) {
            document.execCommand(cmd, false, null);
            document.getElementById('oduvodneniEditor')?.focus();
        }

        function aiSuggestOduvodneni() {
            const editor = document.getElementById('oduvodneniEditor');
            if (!editor) return;
            // Simulace AI návrhu — v ostré verzi API call
            const issues = globalIssues.vyzva.filter(i => !i.resolved);
            const issueCount = issues.length;
            const suggested = `Stavební úřad přezkoumal předloženou žádost a zjistil, že obsahuje ${issueCount} nedostatek${issueCount > 4 ? 'ů' : issueCount > 1 ? 'y' : ''}, který${issueCount > 1 ? 'é' : ''} brání pokračování v řízení. Konkrétní nedostatky jsou specifikovány výše. Stavební úřad proto vydává tuto výzvu k jejich odstranění ve stanovené lhůtě, a to v souladu s § 45 odst. 2 správního řádu.`;
            editor.innerHTML = `<p>${suggested}</p>`;
            // Vizuální feedback
            const btn = document.querySelector('.ai-suggest-btn');
            if (btn) {
                btn.textContent = '✓ Navrženo';
                btn.style.background = '#e8f5e9';
                btn.style.color = '#1b5e20';
                setTimeout(() => { btn.textContent = 'Navrhnout'; btn.style.background = ''; btn.style.color = ''; }, 2000);
            }
        }

        function exportVyzva(action) {
            // Sesbírat aktuální data z editoru
            const lhutaDni = document.getElementById('vyzvaLhutaDni')?.value || 30;
            const lhutaDatum = document.getElementById('vyzvaLhutaDatum')?.value || '';
            const issues = globalIssues.vyzva.filter(i => !i.resolved);

            // Formátovat datum lhůty
            let lhutaFormatted = lhutaDatum;
            if (lhutaDatum) {
                const d = new Date(lhutaDatum);
                lhutaFormatted = d.toLocaleDateString('cs-CZ', { day: 'numeric', month: 'numeric', year: 'numeric' });
            }

            // Datum dnes
            const dnes = new Date();
            const dnesFormatted = dnes.toLocaleDateString('cs-CZ', { day: 'numeric', month: 'long', year: 'numeric' });

            // Kategorizovat nedostatky
            const kategorieMap = {
                'autorizace': 'Autorizace a elektronické ověření projektové dokumentace',
                'dokladova_cast': 'Dokladová část — vyjádření a závazná stanoviska dotčených orgánů',
                'obsah_pd': 'Obsah projektové dokumentace',
                'prurezovy': 'Průřezové nedostatky',
                'formalni': 'Formální nedostatky'
            };

            // Seskupit nedostatky
            const grouped = {};
            issues.forEach(i => {
                const kat = i.kategorie || 'ostatni';
                if (!grouped[kat]) grouped[kat] = [];
                grouped[kat].push(i);
            });

            // Sestavit HTML bloky nedostatků
            const circled = ['①','②','③','④','⑤','⑥','⑦','⑧','⑨','⑩'];
            let nedostatkyBlocks = '';
            let katIdx = 0;
            Object.entries(grouped).forEach(([kat, items]) => {
                const katLabel = kategorieMap[kat] || 'Ostatní';
                const sym = circled[katIdx] || (katIdx + 1) + '.';
                let itemsHtml = '';
                items.forEach(item => {
                    const text = (item.hlavniText || item.text || '').replace(/\n/g, '<br>');
                    const legal = item.pravniPredpis ? `<div class="legal-ref">Právní základ: ${item.pravniPredpis}</div>` : '';
                    itemsHtml += `<div class="nedostatek-item">${text}${legal}</div>`;
                });
                nedostatkyBlocks += `
                <div class="nedostatek-skupina">
                    <div class="nedostatek-hlavicka">${sym} ${katLabel}</div>
                    ${itemsHtml}
                </div>`;
                katIdx++;
            });

            if (!nedostatkyBlocks) {
                nedostatkyBlocks = '<p style="color:#666;font-style:italic;">Nebyly identifikovány žádné nedostatky.</p>';
            }

            const docHtml = `<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="UTF-8">
<title>Výzva k doplnění žádosti — R/2026/000147</title>
<style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: Arial, Helvetica, sans-serif; font-size: 9.5pt; color: #000; background: #f4f4f4; }
    .page { width: 210mm; min-height: 297mm; margin: 0 auto; padding: 18mm 20mm 20mm 20mm; background: #fff; box-shadow: 0 2px 12px rgba(0,0,0,0.15); }
    .header { border-bottom: 2.5px solid #004289; padding-bottom: 8pt; margin-bottom: 10pt; }
    .header-top { display: flex; justify-content: space-between; align-items: flex-start; }
    .header-organ { font-size: 11pt; font-weight: bold; color: #004289; letter-spacing: 0.3px; }
    .header-odbor { font-size: 8.5pt; color: #555; margin-top: 2pt; }
    .header-cj { font-size: 8pt; color: #444; margin-top: 3pt; text-align: right; }
    .info-table { width: 100%; border-collapse: collapse; margin-bottom: 12pt; }
    .info-table td { padding: 2pt 6pt; font-size: 8.5pt; vertical-align: top; }
    .info-table .label { font-weight: bold; width: 80pt; color: #333; }
    .zamer-box { background: #f0f4fa; border-left: 3pt solid #004289; padding: 8pt 10pt; margin-bottom: 14pt; font-size: 9pt; }
    .zamer-title { font-weight: bold; font-size: 10pt; color: #004289; margin-bottom: 3pt; }
    .zamer-meta { font-size: 8pt; color: #555; margin-top: 2pt; }
    .sekce-hlavicka { display: flex; align-items: baseline; gap: 8pt; margin-bottom: 8pt; }
    .sekce-cislo { font-size: 11pt; font-weight: bold; color: #004289; }
    .sekce-nazev { font-size: 10.5pt; font-weight: bold; color: #004289; }
    .sekce-lhuta { font-size: 7.5pt; font-weight: bold; color: #c0392b; background: #fde8e8; border: 1pt solid #e57373; padding: 1.5pt 5pt; border-radius: 3pt; margin-left: auto; }
    .sekce-lhuta-modra { font-size: 7.5pt; font-weight: bold; color: #1565c0; background: #e8f4fd; border: 1pt solid #90caf9; padding: 1.5pt 5pt; border-radius: 3pt; margin-left: auto; }
    .uvodni-text { font-size: 9.5pt; line-height: 1.6; margin-bottom: 12pt; text-align: justify; }
    .nedostatek-skupina { margin-bottom: 12pt; }
    .nedostatek-hlavicka { font-weight: bold; font-size: 9.5pt; color: #1a1a2e; padding: 4pt 0 4pt; border-bottom: 1pt solid #ccc; margin-bottom: 6pt; }
    .nedostatek-item { font-size: 9pt; line-height: 1.55; margin-bottom: 5pt; padding-left: 10pt; text-align: justify; }
    .legal-ref { font-size: 8pt; color: #555; margin-top: 2pt; font-style: italic; }
    .zaverecna-vyzva { font-size: 9pt; line-height: 1.6; font-style: italic; margin: 12pt 0; padding: 8pt 10pt; border: 1pt solid #e0e0e0; background: #fafafa; }
    .oddelovac { border-top: 1pt solid #ccc; margin: 18pt 0 14pt; }
    .usneseni-text { font-size: 9.5pt; line-height: 1.6; margin-bottom: 8pt; text-align: justify; }
    .podnadpis { font-size: 9pt; font-weight: bold; margin: 10pt 0 4pt; color: #333; text-decoration: underline; }
    .oduvodneni-text { font-size: 9pt; line-height: 1.6; text-align: justify; margin-bottom: 6pt; }
    .podpis-blok { margin-top: 24pt; display: flex; justify-content: flex-end; }
    .podpis { text-align: center; min-width: 180pt; }
    .podpis-jmeno { font-weight: bold; font-size: 9.5pt; border-top: 1pt solid #000; padding-top: 4pt; margin-top: 24pt; }
    .podpis-funkce { font-size: 8.5pt; color: #444; }
    .obdrzí { margin-top: 18pt; font-size: 8.5pt; border-top: 1pt dashed #ccc; padding-top: 8pt; }
    .obdrzí-nadpis { font-weight: bold; font-size: 9pt; margin-bottom: 4pt; }
    .obdrzí-item { margin-bottom: 2pt; }
    @media print {
        body { background: white; }
        .page { margin: 0; padding: 15mm 18mm 18mm 18mm; box-shadow: none; }
        .no-print { display: none !important; }
        @page { size: A4; margin: 0; }
    }
    .print-toolbar {
        position: fixed; top: 0; left: 0; right: 0; background: #004289; color: #fff;
        padding: 10px 24px; display: flex; align-items: center; justify-content: space-between;
        z-index: 1000; box-shadow: 0 2px 8px rgba(0,0,0,0.3); font-family: Arial, sans-serif;
    }
    .print-toolbar h3 { font-size: 14px; font-weight: 600; }
    .btn-print { padding: 7px 18px; border: none; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 500; background: #fff; color: #004289; }
    .btn-close-win { padding: 7px 18px; border: none; border-radius: 6px; cursor: pointer; font-size: 13px; background: rgba(255,255,255,0.15); color: #fff; margin-left: 8px; }
    body.with-toolbar .page { margin-top: 56px; }
</style>
</head>
<body class="with-toolbar">
<div class="print-toolbar no-print">
    <h3>&#128196; Náhled dokumentu — Výzva + Usnesení o přerušení řízení</h3>
    <div>
        <button class="btn-print" onclick="window.print()">&#128424; Uložit jako PDF / Tisknout</button>
        <button class="btn-close-win" onclick="window.close()">Zavřít</button>
    </div>
</div>
<div class="page">
    <div class="header">
        <div class="header-top">
            <div>
                <div class="header-organ">DOPRAVNÍ A ENERGETICKÝ STAVEBNÍ ÚŘAD</div>
                <div class="header-odbor">Odbor staveb drah · ÚP Praha</div>
            </div>
            <div>
                <div class="header-cj">Č.j.: DESU/122/000147/26</div>
                <div class="header-cj">Spis. zn.: SZ DESU/R/2026/000147</div>
                <div class="header-cj">Strana 1</div>
            </div>
        </div>
    </div>
    <table class="info-table">
        <tr>
            <td class="label">Spis. zn.</td><td>R/2026/000147</td>
            <td class="label">Záměr</td><td>Z/2026/00147</td>
        </tr>
        <tr>
            <td class="label">Č.j.</td><td>DESU/122/000147/26</td>
            <td class="label">Tel.</td><td>221 220 315</td>
        </tr>
        <tr>
            <td class="label">Vyřizuje</td><td>Ing. Tomáš Novák</td>
            <td class="label">E-mail</td><td>tomas.novak@desu.gov.cz</td>
        </tr>
        <tr>
            <td class="label">Datum</td><td>${dnesFormatted}</td>
            <td class="label">Pracoviště</td><td>Praha</td>
        </tr>
    </table>
    <div class="zamer-box">
        <div class="zamer-title">Záměr: Oprava zabezpečovacího zařízení v žst. Doudleby nad Orlicí</div>
        <div>parc. č. 2345/1, 2345/2 · k.ú. Doudleby nad Orlicí</div>
        <div class="zamer-meta">Stavebník: Správa železnic, státní organizace (IČO: 70994234) · zast. Signal Projekt s.r.o. (IČO: 27376504)</div>
        <div class="zamer-meta">Žádost podána 6. 1. 2026 prostřednictvím Portálu stavebníka</div>
    </div>
    <div class="sekce-hlavicka">
        <span class="sekce-cislo">I.</span>
        <span class="sekce-nazev">Výzva k odstranění nedostatků žádosti</span>
        <span class="sekce-lhuta">LHŮTA ${lhutaDni} DNŮ</span>
    </div>
    <div class="uvodni-text">
        DESÚ jako stavební úřad příslušný dle § 33 odst. 2 zákona č. 283/2021 Sb. zjistil, že žádost neobsahuje požadované
        náležitosti, a proto dle § 185 odst. 2 stavebního zákona vyzývá stavebníka, aby nejpozději do <strong>${lhutaDni} dnů</strong>
        od doručení předloženou žádost doplnil o následující chybějící náležitosti:
    </div>
    ${nedostatkyBlocks}
    <div class="zaverecna-vyzva">
        Pokud nebudou nedostatky žádosti ve stanovené lhůtě odstraněny, bude řízení zastaveno podle
        § 66 odst. 1 písm. c) zákona č. 500/2004 Sb., správní řád.
    </div>
    <div class="oddelovac"></div>
    <div class="sekce-hlavicka">
        <span class="sekce-cislo">II.</span>
        <span class="sekce-nazev">Usnesení o přerušení řízení</span>
        <span class="sekce-lhuta-modra">BEZ ODVOLÁNÍ</span>
    </div>
    <div class="usneseni-text">
        DESÚ dle § 185 odst. 2 stavebního zákona <strong>přerušuje řízení</strong> o záměru zahájené podáním
        žádosti dne 6. 1. 2026 o vydání povolení záměru na stavbu dráhy:
    </div>
    <div style="font-weight:bold;font-size:10pt;text-align:center;margin:10pt 0;color:#004289;">
        Oprava zabezpečovacího zařízení v žst. Doudleby nad Orlicí
    </div>
    <div class="usneseni-text">
        na pozemcích parc. č. 2345/1, 2345/2 v k.ú. Doudleby nad Orlicí, kterou podala
        Správa železnic, státní organizace (IČO 70994234), zastoupena Signal Projekt s.r.o. (IČO 27376504).
    </div>
    <div class="usneseni-text">
        Řízení se přerušuje do doby doplnění žádosti o povolení záměru, nejdéle však na dobu
        <strong>${lhutaDni} dnů</strong> ode dne doručení výzvy.
    </div>
    <div class="usneseni-text"><strong>Účastníci řízení, na něž se vztahuje rozhodnutí:</strong><br>
    Správa železnic, státní organizace, Dlážděná 1003/7, 110 00 Praha 1-Nové Město</div>
    <div class="podnadpis">Odůvodnění:</div>
    <div class="oduvodneni-text">
        Řízení o povolení záměru bylo zahájeno dnem podání žádosti. Stavební úřad zjistil, že žádost neobsahuje
        požadované náležitosti, a proto stavebníka vyzval k doplnění. Současně určil lhůtu k provedení úkonu
        na dobu ${lhutaDni} dnů ode dne doručení výzvy.
    </div>
    <div class="oduvodneni-text">
        Stavební úřad řízení přerušil do doby doplnění žádosti, nejdéle však na dobu ${lhutaDni} dnů ode dne
        doručení výzvy. Po dobu přerušení lhůta podle § 65 odst. 1 správního řádu neběží.
    </div>
    <div class="podnadpis">Poučení:</div>
    <div class="oduvodneni-text">
        Proti tomuto usnesení se podle § 185 odst. 2 stavebního zákona nelze odvolat.
    </div>
    <div class="podpis-blok">
        <div class="podpis">
            <div class="podpis-jmeno">Ing. Jitka Kotásková</div>
            <div class="podpis-funkce">ředitelka</div>
            <div class="podpis-funkce">Odbor staveb drah</div>
        </div>
    </div>
    <div class="obdrzí">
        <div class="obdrzí-nadpis">Obdrží:</div>
        <div class="obdrzí-item">Správa železnic, státní organizace, Dlážděná 1003/7, 110 00 Praha 1-Nové Město</div>
        <div class="obdrzí-item">v zastoupení: Signal Projekt s.r.o., IDDS: signal01</div>
        <div class="obdrzí-item">sídlo: Vídeňská 546/55, 639 00 Brno</div>
        <div class="obdrzí-item" style="margin-top:4pt;">DESÚ — spis</div>
    </div>
</div>
</body>
</html>`;

            const printWin = window.open('', '_blank', 'width=960,height=780,scrollbars=yes,resizable=yes');
            if (!printWin) {
                alert('Prohlížeč zablokoval otevření okna. Povolte prosím pop-up okna pro tuto stránku.');
                return;
            }
            printWin.document.write(docHtml);
            printWin.document.close();

            if (action === 'send') {
                setTimeout(() => { closeVyzvaEditor(); }, 400);
            }
        }

        // Initialize
        updateUI();

        // Force styles after page load (for Nicepage compatibility)
        function forceWorkflowStyles() {
            const workflowBar = document.querySelector('.workflow-bar');
            if (workflowBar) {
                workflowBar.style.cssText = 'display: flex !important; align-items: center !important; justify-content: space-between !important; padding: 10px 32px !important; background: #f8f9fa !important; border-bottom: 1px solid #e0e0e0 !important; flex-wrap: nowrap !important;';
            }
            
            const stepper = document.querySelector('.workflow-stepper');
            if (stepper) {
                stepper.style.cssText = 'display: flex !important; align-items: center !important; gap: 6px !important; flex-wrap: nowrap !important;';
            }
            
            document.querySelectorAll('.workflow-step').forEach(step => {
                const isCompleted = step.classList.contains('completed');
                const isActive = step.classList.contains('active');
                
                let bg = '#fff', border = '#dadce0', color = '#5f6368';
                if (isCompleted) { bg = '#e6f4ea'; border = '#ceead6'; color = '#137333'; }
                if (isActive) { bg = '#004289'; border = '#004289'; color = '#fff'; }
                
                step.style.cssText = `display: inline-flex !important; align-items: center !important; gap: 6px !important; padding: 6px 12px !important; border-radius: 16px !important; font-size: 12px !important; font-weight: 400 !important; background: ${bg} !important; border: 1px solid ${border} !important; color: ${color} !important; white-space: nowrap !important;`;
            });
            
            document.querySelectorAll('.step-number').forEach(num => {
                const step = num.closest('.workflow-step');
                const isCompleted = step && step.classList.contains('completed');
                const isActive = step && step.classList.contains('active');
                
                let bg = '#f1f3f4', color = '#5f6368';
                if (isCompleted) { bg = '#137333'; color = '#fff'; }
                if (isActive) { bg = 'rgba(255,255,255,0.25)'; color = '#fff'; }
                
                num.style.cssText = `width: 18px !important; height: 18px !important; min-width: 18px !important; border-radius: 50% !important; background: ${bg} !important; color: ${color} !important; display: inline-flex !important; align-items: center !important; justify-content: center !important; font-size: 10px !important; font-weight: 500 !important;`;
            });
            
            document.querySelectorAll('.workflow-step-connector').forEach(conn => {
                const isCompleted = conn.classList.contains('completed');
                const bg = isCompleted ? '#137333' : '#dadce0';
                conn.style.cssText = `width: 20px !important; height: 2px !important; min-width: 20px !important; background: ${bg} !important; flex-shrink: 0 !important;`;
            });
            
            const docButtons = document.querySelector('.workflow-bar .document-access-buttons');
            if (docButtons) {
                docButtons.style.cssText = 'display: flex !important; gap: 8px !important; flex-wrap: nowrap !important; margin-left: 24px !important;';
            }
            
            document.querySelectorAll('.workflow-bar .doc-access-btn').forEach(btn => {
                btn.style.cssText = 'display: inline-flex !important; align-items: center !important; gap: 6px !important; padding: 8px 14px !important; background: #fff !important; border: 1px solid #dadce0 !important; border-radius: 6px !important; font-size: 13px !important; font-weight: 400 !important; color: #202124 !important; text-decoration: none !important; white-space: nowrap !important;';
                
                // Style icons inside buttons
                const icon = btn.querySelector('.material-icons-outlined');
                if (icon) {
                    icon.style.cssText = 'font-size: 18px !important; color: #5f6368 !important;';
                }
            });
        }
        
        // Apply on load
        window.addEventListener('load', forceWorkflowStyles);
        document.addEventListener('DOMContentLoaded', forceWorkflowStyles);
        
    </script>
    
    <!-- Slideout overlay -->
    <div class="slideout-overlay" id="slideoutOverlay" onclick="closeAllSlideouts()"></div>
    
    <!-- Slideout: Přehled nedostatků -->
    <div class="slideout-panel" id="prehledNedostatku">
        <div class="slideout-header">
            <div class="slideout-title">
                <span class="material-icons-outlined">warning_amber</span>
                Přehled nedostatků řízení
            </div>
            <button class="slideout-close" onclick="closeSlideout('prehledNedostatku')">
                <span class="material-icons-outlined">close</span>
            </button>
        </div>
        <div class="slideout-body" id="nedostatkyBody">
            <!-- Typ C: Výzva k doplnění -->
            <div class="issues-group" id="groupVyzva">
                <div class="issues-group-header">
                    <div class="issues-group-title">
                        <span class="material-icons-outlined" style="color: #f9ab00;">edit_document</span>
                        Výzva k doplnění + Přerušení řízení
                    </div>
                    <span class="issues-group-badge warning" id="badgeVyzva">0</span>
                </div>
                <p style="font-size: 12px; color: #5f6368; margin-bottom: 12px;">
                    Nedostatky, které povedou k vydání výzvy k doplnění a usnesení o přerušení řízení dle § 185 odst. 1-2.
                </p>
                <div class="issues-group-list" id="listVyzva">
                    <div style="text-align: center; padding: 20px; color: #9aa0a6; font-size: 13px;">
                        <span class="material-icons-outlined" style="font-size: 32px; margin-bottom: 8px; display: block;">check_circle</span>
                        Žádné nedostatky
                    </div>
                </div>
            </div>
            
            <!-- Typ B: Odložení žádosti -->
            <div class="issues-group" id="groupOdlozeni">
                <div class="issues-group-header">
                    <div class="issues-group-title">
                        <span class="material-icons-outlined" style="color: #c5221f;">block</span>
                        Odložení žádosti
                    </div>
                    <span class="issues-group-badge error" id="badgeOdlozeni">0</span>
                </div>
                <p style="font-size: 12px; color: #5f6368; margin-bottom: 12px;">
                    Závažné vady dle § 185 odst. 3 - chybí dokumentace, není zpracována projektantem, nebo není vložena do EED.
                </p>
                <div class="issues-group-list" id="listOdlozeni">
                    <div style="text-align: center; padding: 20px; color: #9aa0a6; font-size: 13px;">
                        <span class="material-icons-outlined" style="font-size: 32px; margin-bottom: 8px; display: block;">check_circle</span>
                        Žádné závažné vady
                    </div>
                </div>
            </div>
            
            <!-- Typ A: Postoupení -->
            <div class="issues-group" id="groupPostoupeni">
                <div class="issues-group-header">
                    <div class="issues-group-title">
                        <span class="material-icons-outlined" style="color: #1a73e8;">send</span>
                        Postoupení řízení
                    </div>
                    <span class="issues-group-badge info" id="badgePostoupeni">0</span>
                </div>
                <p style="font-size: 12px; color: #5f6368; margin-bottom: 12px;">
                    Stavební úřad není příslušný - řízení bude postoupeno příslušnému SÚ.
                </p>
                <div class="issues-group-list" id="listPostoupeni">
                    <div style="text-align: center; padding: 20px; color: #9aa0a6; font-size: 13px;">
                        <span class="material-icons-outlined" style="font-size: 32px; margin-bottom: 8px; display: block;">check_circle</span>
                        SÚ je příslušný
                    </div>
                </div>
            </div>
            
            <!-- Typ D: Stavění lhůty -->
            <div class="issues-group" id="groupStaveni">
                <div class="issues-group-header">
                    <div class="issues-group-title">
                        <span class="material-icons-outlined" style="color: #5f6368;">schedule</span>
                        Stavění lhůty (vyžádání stanovisek)
                    </div>
                    <span class="issues-group-badge info" id="badgeStaveni">0</span>
                </div>
                <p style="font-size: 12px; color: #5f6368; margin-bottom: 12px;">
                    Chybějící stanoviska DO, která si SÚ vyžádá dle § 184 odst. 3. Lhůta pro rozhodnutí se staví.
                </p>
                <div class="issues-group-list" id="listStaveni">
                    <div style="text-align: center; padding: 20px; color: #9aa0a6; font-size: 13px;">
                        <span class="material-icons-outlined" style="font-size: 32px; margin-bottom: 8px; display: block;">check_circle</span>
                        Všechna stanoviska jsou k dispozici
                    </div>
                </div>
            </div>
            
            <!-- Typ E: Zamítnutí -->
            <div class="issues-group" id="groupZamitnuti">
                <div class="issues-group-header">
                    <div class="issues-group-title">
                        <span class="material-icons-outlined" style="color: #c5221f;">gavel</span>
                        Zamítnutí žádosti
                    </div>
                    <span class="issues-group-badge error" id="badgeZamitnuti">0</span>
                </div>
                <p style="font-size: 12px; color: #5f6368; margin-bottom: 12px;">
                    Důvody pro zamítnutí žádosti - např. nesoulad s územně plánovací dokumentací.
                </p>
                <div class="issues-group-list" id="listZamitnuti">
                    <div style="text-align: center; padding: 20px; color: #9aa0a6; font-size: 13px;">
                        <span class="material-icons-outlined" style="font-size: 32px; margin-bottom: 8px; display: block;">check_circle</span>
                        Žádné důvody pro zamítnutí
                    </div>
                </div>
            </div>
        </div>
        <div class="slideout-footer">
            <button class="btn btn-secondary" onclick="exportNedostatky()">
                <span class="material-icons-outlined">download</span>
                Exportovat
            </button>
            <button class="btn btn-primary" onclick="closeSlideout('prehledNedostatku')">
                Zavřít
            </button>
        </div>
    </div>
    
    <!-- Slideout: Údaje řízení -->
    <div class="slideout-panel" id="udajeRizeni">
        <div class="slideout-header">
            <div class="slideout-title">
                <span class="material-icons-outlined">assignment</span>
                Údaje řízení
            </div>
            <button class="slideout-close" onclick="closeSlideout('udajeRizeni')">
                <span class="material-icons-outlined">close</span>
            </button>
        </div>
        <div class="slideout-body">
            <!-- Základní údaje -->
            <div class="data-section">
                <div class="data-section-title">
                    <span class="material-icons-outlined">info</span>
                    Základní údaje
                </div>
                <div class="data-row">
                    <div class="data-label">Spis. značka</div>
                    <div class="data-value">SZ DESU/000612/26</div>
                </div>
                <div class="data-row">
                    <div class="data-label">Název stavby</div>
                    <div class="data-value editable">
                        <span id="udajeNazevStavby">Oprava zabezpečovacího zařízení v žst. Doudleby n. Orlicí</span>
                        <button class="data-edit-btn" onclick="editUdaj('nazevStavby')" title="Upravit">
                            <span class="material-icons-outlined">edit</span>
                        </button>
                    </div>
                </div>
                <div class="data-row">
                    <div class="data-label">Typ řízení</div>
                    <div class="data-value">Povolení stavby</div>
                </div>
                <div class="data-row">
                    <div class="data-label">Druh stavby</div>
                    <div class="data-value">Stavba dráhy</div>
                </div>
                <div class="data-row">
                    <div class="data-label">Datum doručení</div>
                    <div class="data-value">6. 1. 2026</div>
                </div>
                <div class="data-row">
                    <div class="data-label">Stav řízení</div>
                    <div class="data-value"><span class="case-badge draft" style="display: inline-block;">Kontrola</span></div>
                </div>
            </div>
            
            <!-- Lhůty -->
            <div class="data-section">
                <div class="data-section-title">
                    <span class="material-icons-outlined">schedule</span>
                    Lhůty
                </div>
                <div class="data-row">
                    <div class="data-label">Lhůta pro rozhodnutí</div>
                    <div class="data-value">60 dnů (do 6. 3. 2026)</div>
                </div>
                <div class="data-row">
                    <div class="data-label">Stavění lhůty</div>
                    <div class="data-value" style="color: #137333;">Ne</div>
                </div>
            </div>
            
            <!-- Pozemky -->
            <div class="data-section">
                <div class="data-section-title">
                    <span class="material-icons-outlined">landscape</span>
                    Pozemky záměru
                </div>
                <div class="data-list" id="udajePozemky">
                    <div class="data-list-item">
                        <span class="material-icons-outlined">place</span>
                        k.ú. Doudleby nad Orlicí (26 parcel)
                    </div>
                    <div class="data-list-item">
                        <span class="material-icons-outlined">place</span>
                        k.ú. Kostelec nad Orlicí (1 parcela)
                    </div>
                    <div class="data-list-item">
                        <span class="material-icons-outlined">place</span>
                        k.ú. Vamberk (10 parcel)
                    </div>
                    <div class="data-list-item">
                        <span class="material-icons-outlined">place</span>
                        k.ú. Záměl (1 parcela)
                    </div>
                </div>
                <button class="btn btn-secondary" style="margin-top: 12px; width: 100%;" onclick="openControl('controlPozemky')">
                    <span class="material-icons-outlined">edit</span>
                    Upravit pozemky
                </button>
            </div>
            
            <!-- Účastníci -->
            <div class="data-section">
                <div class="data-section-title">
                    <span class="material-icons-outlined">groups</span>
                    Osoby
                </div>
                <div class="data-list" id="udajeUcastnici">
                    <div class="data-list-item">
                        <span class="material-icons-outlined">business</span>
                        Správa železnic, s.o. (stavebník)
                    </div>
                    <div class="data-list-item">
                        <span class="material-icons-outlined">person</span>
                        Signal Projekt s.r.o. (zástupce)
                    </div>
                </div>
                <button class="btn btn-secondary" style="margin-top: 12px; width: 100%;" onclick="openControl('controlUcastnici')">
                    <span class="material-icons-outlined">edit</span>
                    Upravit osoby
                </button>
            </div>
            
            <!-- Referent -->
            <div class="data-section">
                <div class="data-section-title">
                    <span class="material-icons-outlined">badge</span>
                    Zpracování
                </div>
                <div class="data-row">
                    <div class="data-label">Referent</div>
                    <div class="data-value">Ing. et Ing. Martina Homolová Dubová, Ph.D.</div>
                </div>
                <div class="data-row">
                    <div class="data-label">Odbor</div>
                    <div class="data-value">Odbor staveb drah, ÚP Olomouc</div>
                </div>
                <div class="data-row">
                    <div class="data-label">Přiřazeno od</div>
                    <div class="data-value">6. 1. 2026</div>
                </div>
            </div>
        </div>
        <div class="slideout-footer">
            <button class="btn btn-primary" onclick="closeSlideout('udajeRizeni')">
                Zavřít
            </button>
        </div>
    </div>
    
    <script>
        // Slideout panel funkce
        function openSlideout(panelId) {
            document.getElementById('slideoutOverlay').classList.add('open');
            document.getElementById(panelId).classList.add('open');
            document.body.style.overflow = 'hidden';
            
            if (panelId === 'prehledNedostatku') {
                renderGlobalIssues();
            }
        }
        
        function closeSlideout(panelId) {
            document.getElementById('slideoutOverlay').classList.remove('open');
            document.getElementById(panelId).classList.remove('open');
            document.body.style.overflow = '';
        }
        
        function closeAllSlideouts() {
            document.querySelectorAll('.slideout-panel').forEach(panel => {
                panel.classList.remove('open');
            });
            document.getElementById('slideoutOverlay').classList.remove('open');
            document.body.style.overflow = '';
        }
        
        // Dropdown menu
        function toggleActionDropdown() {
            const dropdown = document.getElementById('akceRizeniDropdown');
            dropdown.classList.toggle('open');
            
            // Close on click outside
            if (dropdown.classList.contains('open')) {
                setTimeout(() => {
                    document.addEventListener('click', closeDropdownOnClickOutside);
                }, 0);
            }
        }
        
        function closeDropdownOnClickOutside(e) {
            const dropdown = document.getElementById('akceRizeniDropdown');
            const btn = document.getElementById('btnAkceRizeni');
            if (!dropdown.contains(e.target) && !btn.contains(e.target)) {
                dropdown.classList.remove('open');
                document.removeEventListener('click', closeDropdownOnClickOutside);
            }
        }
        
        function showActionModal(action) {
            document.getElementById('akceRizeniDropdown').classList.remove('open');
            alert('Akce "' + action + '" - bude implementováno');
        }
        
        function exportNedostatky() {
            alert('Export nedostatků - bude implementováno');
        }
        
        function editUdaj(udaj) {
            alert('Úprava údaje "' + udaj + '" - bude implementováno');
        }
        
        // Inicializace badge při načtení
        document.addEventListener('DOMContentLoaded', function() {
            updateGlobalIssuesBadge();
            initSimulationPanel();
        });
    </script>
    
    <!-- ==========================================
         SIMULAČNÍ PANEL - DevTools pro maketu
         ========================================== -->
    <div class="sim-panel minimized" id="simPanel">
        <div class="sim-panel-header" onclick="toggleSimPanel()">
            <div class="sim-panel-title">
                <span class="material-icons-outlined">science</span>
                <span class="sim-panel-title-text">Simulace</span>
            </div>
            <div class="sim-panel-toggle">
                <span class="material-icons-outlined" id="simPanelToggleIcon">expand_more</span>
            </div>
        </div>
        <div class="sim-panel-body" id="simPanelBody">
            <div class="sim-section">
                <div class="sim-section-title">Platnost právní úpravy</div>
                <div class="sim-scenarios">
                    <label class="sim-radio">
                        <input type="radio" name="platnost" value="do2027" checked onchange="applyPlatnost(this.value)">
                        <span class="sim-radio-label">
                            <strong>Do 31. 12. 2027</strong>
                            <small>Současný stav — krajské SÚ, samostatné DO</small>
                        </span>
                    </label>
                    <label class="sim-radio">
                        <input type="radio" name="platnost" value="od2028" onchange="applyPlatnost(this.value)">
                        <span class="sim-radio-label">
                            <strong>Od 1. 1. 2028</strong>
                            <small>Jednotná státní stavební správa, integrované DO</small>
                        </span>
                    </label>
                </div>
            </div>
            <div class="sim-section">
                <div class="sim-section-title">Podání žádosti</div>
                <div class="sim-scenarios">
                    <label class="sim-radio">
                        <input type="radio" name="typPodani" value="portal" checked onchange="applyTypPodani(this.value)">
                        <span class="sim-radio-label">
                            <strong>Portál stavebníka</strong>
                            <small>Elektronická žádost — strukturovaná data</small>
                        </span>
                    </label>
                    <label class="sim-radio">
                        <input type="radio" name="typPodani" value="vlozena" onchange="applyTypPodani(this.value)">
                        <span class="sim-radio-label">
                            <strong>Vložená žádost</strong>
                            <small>Listinná / datová schránka — PDF dokument</small>
                        </span>
                    </label>
                </div>
            </div>
            <div class="sim-section">
                <div class="sim-section-title">Rychlost řízení</div>
                <div class="sim-scenarios">
                    <label class="sim-radio">
                        <input type="radio" name="rychlostRizeni" value="zrychlene" checked onchange="applyRychlostRizeni(this.value)">
                        <span class="sim-radio-label">
                            <strong>Zrychlené řízení</strong>
                            <small>Bez ústního jednání, do 30 dnů</small>
                        </span>
                    </label>
                    <label class="sim-radio">
                        <input type="radio" name="rychlostRizeni" value="standardni" onchange="applyRychlostRizeni(this.value)">
                        <span class="sim-radio-label">
                            <strong>Standardní řízení</strong>
                            <small>S ústním jednáním, do 60 dnů</small>
                        </span>
                    </label>
                </div>
            </div>
            <div class="sim-section">
                <div class="sim-section-title">Scénář žádosti</div>
                <div class="sim-scenarios">
                    <label class="sim-radio">
                        <input type="radio" name="scenar" value="zakladni" checked onchange="applyScenario(this.value)">
                        <span class="sim-radio-label">
                            <strong>Základní</strong>
                            <small>FO žadatel, bez zástupce, vlastník</small>
                        </span>
                    </label>
                    <label class="sim-radio">
                        <input type="radio" name="scenar" value="zastupce-pm" onchange="applyScenario(this.value)">
                        <span class="sim-radio-label">
                            <strong>Zástupce — plná moc</strong>
                            <small>FO + zástupce na základě listinné PM</small>
                        </span>
                    </label>
                    <label class="sim-radio">
                        <input type="radio" name="scenar" value="zastupce-reza" onchange="applyScenario(this.value)">
                        <span class="sim-radio-label">
                            <strong>Zástupce — REZA</strong>
                            <small>FO + zástupce z registru el. zastupování</small>
                        </span>
                    </label>
                    <label class="sim-radio">
                        <input type="radio" name="scenar" value="pravnicka-osoba" onchange="applyScenario(this.value)">
                        <span class="sim-radio-label">
                            <strong>Právnická osoba</strong>
                            <small>PO žadatel (s.r.o.), jednatel</small>
                        </span>
                    </label>
                    <label class="sim-radio">
                        <input type="radio" name="scenar" value="osvc" onchange="applyScenario(this.value)">
                        <span class="sim-radio-label">
                            <strong>OSVČ</strong>
                            <small>Fyzická osoba podnikající</small>
                        </span>
                    </label>
                    <label class="sim-radio">
                        <input type="radio" name="scenar" value="spoluvlastnici" onchange="applyScenario(this.value)">
                        <span class="sim-radio-label">
                            <strong>Spoluvlastníci</strong>
                            <small>Více žadatelů — manželé</small>
                        </span>
                    </label>
                    <label class="sim-radio">
                        <input type="radio" name="scenar" value="neni-vlastnik" onchange="applyScenario(this.value)">
                        <span class="sim-radio-label">
                            <strong>Není vlastník</strong>
                            <small>Žadatel nemá právo k pozemku</small>
                        </span>
                    </label>
                    <label class="sim-radio">
                        <input type="radio" name="scenar" value="s-vyjimkami" onchange="applyScenario(this.value)">
                        <span class="sim-radio-label">
                            <strong>S výjimkami</strong>
                            <small>Obsahuje žádost o výjimku</small>
                        </span>
                    </label>
                    <label class="sim-radio">
                        <input type="radio" name="scenar" value="komplexni" onchange="applyScenario(this.value)">
                        <span class="sim-radio-label">
                            <strong>Komplexní</strong>
                            <small>PO + REZA + není vlastník + výjimka</small>
                        </span>
                    </label>
                </div>
            </div>
            <div class="sim-section">
                <div class="sim-section-title">Aktuální nastavení</div>
                <div class="sim-info" id="simInfo">
                    <div class="sim-info-row">
                        <span class="sim-info-label">Platnost:</span>
                        <span class="sim-info-value" id="simInfoPlatnost">Do 31. 12. 2027</span>
                    </div>
                    <div class="sim-info-row">
                        <span class="sim-info-label">Podání:</span>
                        <span class="sim-info-value" id="simInfoPodani">Portál stavebníka</span>
                    </div>
                    <div class="sim-info-row">
                        <span class="sim-info-label">Rychlost:</span>
                        <span class="sim-info-value" id="simInfoRychlost">Zrychlené řízení</span>
                    </div>
                    <div class="sim-info-row">
                        <span class="sim-info-label">Typ žadatele:</span>
                        <span class="sim-info-value" id="simInfoTyp">Fyzická osoba</span>
                    </div>
                    <div class="sim-info-row">
                        <span class="sim-info-label">Zástupce:</span>
                        <span class="sim-info-value" id="simInfoZastupce">Bez zástupce</span>
                    </div>
                    <div class="sim-info-row">
                        <span class="sim-info-label">Vlastnictví:</span>
                        <span class="sim-info-value" id="simInfoVlastnictvi">Vlastník pozemku</span>
                    </div>
                    <div class="sim-info-row">
                        <span class="sim-info-label">Zvláštnosti:</span>
                        <span class="sim-info-value" id="simInfoZvlastnosti">—</span>
                    </div>
                </div>
            </div>
            <div class="sim-actions">
                <button class="sim-btn" onclick="copyScenarioUrl()">
                    <span class="material-icons-outlined">link</span>
                    Kopírovat URL
                </button>
                <button class="sim-btn" onclick="resetScenario()">
                    <span class="material-icons-outlined">refresh</span>
                    Reset
                </button>
            </div>
        </div>
    </div>
    
    <style>
        /* ==========================================
           PLATNOST PRÁVNÍ ÚPRAVY - INFO BOXY
           ========================================== */
        .platnost-info-box {
            display: flex;
            gap: 12px;
            padding: 14px 16px;
            background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%);
            border: 1px solid #90caf9;
            border-radius: 10px;
            margin: 16px 0;
        }
        
        .platnost-info-icon {
            flex-shrink: 0;
            width: 36px;
            height: 36px;
            background: #fff;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .platnost-info-icon .material-icons-outlined {
            font-size: 20px;
            color: #1565c0;
        }
        
        .platnost-info-content {
            flex: 1;
        }
        
        .platnost-info-title {
            font-size: 13px;
            font-weight: 600;
            color: #1565c0;
            margin-bottom: 4px;
        }
        
        .platnost-info-text {
            font-size: 12px;
            color: #424242;
            line-height: 1.5;
        }
        
        /* Integrované DO badge list */
        .integrated-do-list {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 10px;
        }
        
        .integrated-do-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            background: #fff;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 500;
            color: #2e7d32;
        }
        .integrated-do-badge .material-icons-outlined {
            font-size: 14px;
        }
        
        /* Info box uvnitř matrix skupiny */
        .matrix-group .platnost-info-box {
            margin: 0 0 12px 0;
        }
        
        /* Varianta pro integrované DO */
        .integrated-do-info {
            background: linear-gradient(135deg, #e8f5e9 0%, #f1f8e9 100%);
            border-color: #a5d6a7;
        }
        .integrated-do-info .platnost-info-icon {
            background: #e8f5e9;
        }
        .integrated-do-info .platnost-info-icon .material-icons-outlined {
            color: #2e7d32;
        }
        .integrated-do-info .platnost-info-title {
            color: #2e7d32;
        }
    </style>
    
    <style>
        /* ==========================================
           SIMULAČNÍ PANEL - STYLY
           ========================================== */
        .sim-panel {
            position: fixed;
            bottom: 20px;
            left: 20px;
            width: 320px;
            background: #1a1a2e;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            z-index: 10000;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            overflow: hidden;
            transition: all 0.3s ease;
        }
        
        .sim-panel.minimized {
            width: auto;
        }
        
        .sim-panel.minimized .sim-panel-body {
            display: none;
        }
        
        .sim-panel.minimized .sim-panel-title-text {
            display: none;
        }
        
        .sim-panel-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            cursor: pointer;
            user-select: none;
        }
        
        .sim-panel-title {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #fff;
            font-weight: 600;
            font-size: 13px;
        }
        
        .sim-panel-title .material-icons-outlined {
            font-size: 20px;
        }
        
        .sim-panel-toggle {
            color: rgba(255,255,255,0.8);
        }
        
        .sim-panel-toggle .material-icons-outlined {
            font-size: 20px;
            transition: transform 0.3s;
        }
        
        .sim-panel.minimized .sim-panel-toggle .material-icons-outlined {
            transform: rotate(180deg);
        }
        
        .sim-panel-body {
            padding: 16px;
            max-height: 70vh;
            overflow-y: auto;
        }
        
        .sim-section {
            margin-bottom: 16px;
        }
        
        .sim-section:last-child {
            margin-bottom: 0;
        }
        
        .sim-section-title {
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: #8b8b9e;
            margin-bottom: 10px;
        }
        
        .sim-scenarios {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        
        .sim-radio {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            padding: 10px 12px;
            background: #252542;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.15s;
            border: 1px solid transparent;
        }
        
        .sim-radio:hover {
            background: #2d2d4a;
        }
        
        .sim-radio input {
            margin-top: 3px;
            accent-color: #667eea;
        }
        
        .sim-radio input:checked + .sim-radio-label strong {
            color: #a5b4fc;
        }
        
        .sim-radio:has(input:checked) {
            border-color: #667eea;
            background: #2d2d4a;
        }
        
        .sim-radio-label {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        
        .sim-radio-label strong {
            font-size: 12px;
            font-weight: 600;
            color: #e0e0e0;
        }
        
        .sim-radio-label small {
            font-size: 10px;
            color: #8b8b9e;
        }
        
        .sim-info {
            background: #252542;
            border-radius: 8px;
            padding: 12px;
        }
        
        .sim-info-row {
            display: flex;
            justify-content: space-between;
            padding: 6px 0;
            border-bottom: 1px solid #333355;
        }
        
        .sim-info-row:last-child {
            border-bottom: none;
        }
        
        .sim-info-label {
            font-size: 11px;
            color: #8b8b9e;
        }
        
        .sim-info-value {
            font-size: 11px;
            font-weight: 600;
            color: #e0e0e0;
        }
        
        .sim-actions {
            display: flex;
            gap: 8px;
        }
        
        .sim-btn {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            padding: 10px 12px;
            background: #252542;
            border: none;
            border-radius: 8px;
            color: #a5b4fc;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.15s;
        }
        
        .sim-btn:hover {
            background: #333355;
        }
        
        .sim-btn .material-icons-outlined {
            font-size: 16px;
        }
        
        /* Toast pro kopírování URL */
        .sim-toast {
            position: fixed;
            bottom: 100px;
            left: 20px;
            padding: 12px 20px;
            background: #333;
            color: #fff;
            border-radius: 8px;
            font-size: 13px;
            z-index: 10001;
            animation: simToastIn 0.3s ease;
        }
        
        @keyframes simToastIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
    
    <script>
        // ==========================================
        // SIMULAČNÍ PANEL - JAVASCRIPT
        // ==========================================
        
        // Definice scénářů
        const scenarios = {
            'zakladni': {
                nazev: 'Základní',
                typZadatele: 'fo',
                typZadateleText: 'Fyzická osoba',
                zastupce: null,
                zastupceText: 'Bez zástupce',
                vlastnik: true,
                vlastnikText: 'Vlastník pozemku',
                zvlastnosti: [],
                zvlastnostiText: '—',
                zadatel: {
                    jmeno: 'Jan',
                    prijmeni: 'Novák',
                    datumNarozeni: '15. 3. 1985',
                    trvaleBytem: 'Dlážděná 1003/7, 110 00 Praha 1',
                    email: 'jan.novak@email.cz',
                    telefon: '+420 601 234 567',
                    ds: 'uccchjm'
                }
            },
            'zastupce-pm': {
                nazev: 'Zástupce — plná moc',
                typZadatele: 'fo',
                typZadateleText: 'Fyzická osoba',
                zastupce: 'pm',
                zastupceText: 'Listinná plná moc',
                vlastnik: true,
                vlastnikText: 'Vlastník pozemku',
                zvlastnosti: ['plna-moc'],
                zvlastnostiText: 'Plná moc v příloze',
                zadatel: {
                    jmeno: 'Marie',
                    prijmeni: 'Svobodová',
                    datumNarozeni: '22. 7. 1978',
                    trvaleBytem: 'Lipová 45, 551 01 Jaroměř',
                    email: 'marie.svobodova@email.cz',
                    telefon: '+420 602 345 678',
                    ds: null
                },
                zastupceData: {
                    jmeno: 'Ing. Pavel',
                    prijmeni: 'Projektant',
                    datumNarozeni: '10. 5. 1970',
                    adresa: 'Projektová 789, 500 02 Hradec Králové',
                    ds: 'proj456x',
                    typPM: 'Listinná plná moc',
                    platnostPM: 'Neomezená'
                }
            },
            'zastupce-reza': {
                nazev: 'Zástupce — REZA',
                typZadatele: 'fo',
                typZadateleText: 'Fyzická osoba',
                zastupce: 'reza',
                zastupceText: 'REZA (el. zastupování)',
                vlastnik: true,
                vlastnikText: 'Vlastník pozemku',
                zvlastnosti: ['reza'],
                zvlastnostiText: 'Zástupce z REZA',
                zadatel: {
                    jmeno: 'Petr',
                    prijmeni: 'Horák',
                    datumNarozeni: '3. 11. 1982',
                    trvaleBytem: 'Zahradní 567, 551 01 Jaroměř',
                    email: 'petr.horak@email.cz',
                    telefon: '+420 603 456 789',
                    ds: 'horak01'
                },
                zastupceData: {
                    jmeno: 'JUDr. Anna',
                    prijmeni: 'Advokátová',
                    ico: '12345678',
                    adresa: 'Právní 123, 110 00 Praha 1',
                    ds: 'advo123x',
                    typPM: 'REZA — Registr elektronického zastupování',
                    platnostPM: 'Do 31. 12. 2026',
                    rozsah: 'Stavební řízení'
                }
            },
            'pravnicka-osoba': {
                nazev: 'Právnická osoba',
                typZadatele: 'po',
                typZadateleText: 'Právnická osoba',
                zastupce: 'statutar',
                zastupceText: 'Jednatel (statutární orgán)',
                vlastnik: true,
                vlastnikText: 'Vlastník pozemku',
                zvlastnosti: [],
                zvlastnostiText: '—',
                zadatel: {
                    nazev: 'Správa železnic, státní organizace',
                    ico: '70994234',
                    sidlo: 'Dlážděná 1003/7, 110 00 Praha 1',
                    ds: 'uccchjm',
                    jednatel: 'Pavla Kosinová'
                }
            },
            'osvc': {
                nazev: 'OSVČ',
                typZadatele: 'fo-podnikatel',
                typZadateleText: 'Fyzická osoba podnikající',
                zastupce: null,
                zastupceText: 'Bez zástupce',
                vlastnik: true,
                vlastnikText: 'Vlastník pozemku',
                zvlastnosti: [],
                zvlastnostiText: '—',
                zadatel: {
                    jmeno: 'Karel',
                    prijmeni: 'Podnikavý',
                    datumNarozeni: '18. 9. 1975',
                    trvaleBytem: 'Obchodní 321, 551 01 Jaroměř',
                    ico: '87654321',
                    misto: 'Obchodní 321, 551 01 Jaroměř',
                    email: 'karel@podnikavy.cz',
                    telefon: '+420 604 567 890',
                    ds: 'podn321x'
                }
            },
            'spoluvlastnici': {
                nazev: 'Spoluvlastníci',
                typZadatele: 'fo-vice',
                typZadateleText: 'Více žadatelů (manželé)',
                zastupce: null,
                zastupceText: 'Bez zástupce',
                vlastnik: true,
                vlastnikText: 'Spoluvlastníci pozemku',
                zvlastnosti: ['vice-zadatelu'],
                zvlastnostiText: '2 žadatelé',
                zadatele: [
                    {
                        jmeno: 'Jan',
                        prijmeni: 'Manžel',
                        datumNarozeni: '5. 4. 1980',
                        trvaleBytem: 'Rodinná 111, 551 01 Jaroměř',
                        email: 'jan.manzel@email.cz',
                        telefon: '+420 605 678 901',
                        ds: 'manz01'
                    },
                    {
                        jmeno: 'Jana',
                        prijmeni: 'Manželová',
                        datumNarozeni: '12. 8. 1982',
                        trvaleBytem: 'Rodinná 111, 551 01 Jaroměř',
                        email: 'jana.manzelova@email.cz',
                        telefon: '+420 606 789 012',
                        ds: null
                    }
                ]
            },
            'neni-vlastnik': {
                nazev: 'Není vlastník',
                typZadatele: 'fo',
                typZadateleText: 'Fyzická osoba',
                zastupce: null,
                zastupceText: 'Bez zástupce',
                vlastnik: false,
                vlastnikText: 'NENÍ vlastník pozemku',
                zvlastnosti: ['souhlas-vlastnika'],
                zvlastnostiText: 'Souhlas vlastníka § 187',
                zadatel: {
                    jmeno: 'Tomáš',
                    prijmeni: 'Nájemce',
                    datumNarozeni: '25. 1. 1990',
                    trvaleBytem: 'Nájemní 222, 551 01 Jaroměř',
                    email: 'tomas.najemce@email.cz',
                    telefon: '+420 607 890 123',
                    ds: null
                },
                vlastnikPozemku: {
                    jmeno: 'Městys Doudleby n.O.',
                    typ: 'po',
                    souhlas: true
                }
            },
            's-vyjimkami': {
                nazev: 'S výjimkami',
                typZadatele: 'fo',
                typZadateleText: 'Fyzická osoba',
                zastupce: null,
                zastupceText: 'Bez zástupce',
                vlastnik: true,
                vlastnikText: 'Vlastník pozemku',
                zvlastnosti: ['vyjimka'],
                zvlastnostiText: 'Žádost o výjimku',
                zadatel: {
                    jmeno: 'Jiří',
                    prijmeni: 'Výjimečný',
                    datumNarozeni: '14. 2. 1978',
                    trvaleBytem: 'Speciální 444, 551 01 Jaroměř',
                    email: 'jiri@vyjimecny.cz',
                    telefon: '+420 609 012 345',
                    ds: 'vyji444'
                },
                vyjimka: {
                    typ: 'Odstupová vzdálenost',
                    popis: 'Snížení odstupové vzdálenosti od hranice pozemku z 2 m na 1,5 m',
                    oduvodneni: 'Stávající zástavba, terénní podmínky'
                }
            },
            'komplexni': {
                nazev: 'Komplexní',
                typZadatele: 'po',
                typZadateleText: 'Právnická osoba',
                zastupce: 'reza',
                zastupceText: 'REZA (el. zastupování)',
                vlastnik: false,
                vlastnikText: 'NENÍ vlastník pozemku',
                zvlastnosti: ['reza', 'souhlas-vlastnika', 'vyjimka'],
                zvlastnostiText: 'REZA + Souhlas + Výjimka',
                zadatel: {
                    nazev: 'DEVELOPMENT PLUS a.s.',
                    ico: '99887766',
                    sidlo: 'Developerská 999, 110 00 Praha 1',
                    ds: 'devplus1'
                },
                zastupceData: {
                    nazev: 'PROJEKTY PRO VÁS s.r.o.',
                    ico: '11223344',
                    sidlo: 'Projekční 555, 500 02 Hradec Králové',
                    ds: 'projvas1',
                    typPM: 'REZA — Registr elektronického zastupování',
                    platnostPM: 'Do 31. 12. 2027',
                    rozsah: 'Veškerá stavební řízení'
                },
                vlastnikPozemku: {
                    jmeno: 'Státní pozemkový úřad',
                    typ: 'po',
                    souhlas: true
                },
                vyjimka: {
                    typ: 'Požární odstup',
                    popis: 'Snížení požárního odstupu od sousední budovy',
                    oduvodneni: 'Kompenzováno protipožárním opatřením'
                }
            }
        };
        
        let currentScenario = 'zakladni';
        
        // Inicializace panelu
        function initSimulationPanel() {
            // Načíst parametry z URL
            const urlParams = new URLSearchParams(window.location.search);
            
            // Načíst platnost z URL
            const platnostFromUrl = urlParams.get('platnost');
            if (platnostFromUrl && (platnostFromUrl === 'do2027' || platnostFromUrl === 'od2028')) {
                platnostPravniUpravy = platnostFromUrl;
                document.querySelector(`input[name="platnost"][value="${platnostFromUrl}"]`).checked = true;
            }
            updateSimInfoPlatnost();
            
            // Načíst typ podání z URL
            const typPodaniFromUrl = urlParams.get('typPodani');
            if (typPodaniFromUrl && (typPodaniFromUrl === 'portal' || typPodaniFromUrl === 'vlozena')) {
                typPodaniZadosti = typPodaniFromUrl;
                document.querySelector(`input[name="typPodani"][value="${typPodaniFromUrl}"]`).checked = true;
            }
            
            // Načíst rychlost řízení z URL
            const rychlostFromUrl = urlParams.get('rychlost');
            if (rychlostFromUrl && (rychlostFromUrl === 'zrychlene' || rychlostFromUrl === 'standardni')) {
                rychlostRizeni = rychlostFromUrl;
                document.querySelector(`input[name="rychlostRizeni"][value="${rychlostFromUrl}"]`).checked = true;
            }
            // Vždy aplikovat rychlost řízení (pro správné zobrazení badge a karty), bez toastu
            applyRychlostRizeni(rychlostRizeni, false);
            
            updateSimInfo();
            
            // Načíst scénář z URL
            const scenarFromUrl = urlParams.get('scenar');
            
            if (scenarFromUrl && scenarios[scenarFromUrl]) {
                currentScenario = scenarFromUrl;
                document.querySelector(`input[name="scenar"][value="${scenarFromUrl}"]`).checked = true;
                applyScenario(scenarFromUrl, false);
            }
            
            // Aplikovat změny podle platnosti
            applyPlatnostChanges();
        }
        
        // Přepnout panel (minimalizovat/maximalizovat)
        function toggleSimPanel() {
            const panel = document.getElementById('simPanel');
            panel.classList.toggle('minimized');
        }
        
        // Aplikovat scénář
        function applyScenario(scenarioId, updateUrl = true) {
            currentScenario = scenarioId;
            const scenario = scenarios[scenarioId];
            
            if (!scenario) return;
            
            // Aktualizovat info panel
            document.getElementById('simInfoTyp').textContent = scenario.typZadateleText;
            document.getElementById('simInfoZastupce').textContent = scenario.zastupceText;
            document.getElementById('simInfoVlastnictvi').textContent = scenario.vlastnikText;
            document.getElementById('simInfoZvlastnosti').textContent = scenario.zvlastnostiText;
            
            // Aktualizovat URL
            if (updateUrl) {
                const url = new URL(window.location);
                url.searchParams.set('scenar', scenarioId);
                window.history.replaceState({}, '', url);
            }
            
            // Aktualizovat data v kontrole žádosti
            updateKontrolaZadostiData(scenario);
            
            // Aktualizovat checklist
            updateKontrolaZadostiChecklist(scenario);
            
            // Toast
            showSimToast(`Scénář: ${scenario.nazev}`);
        }
        
        // Aktualizovat strukturovaná data v kontrole žádosti
        function updateKontrolaZadostiData(scenario) {
            const sectionZadatel = document.getElementById('dataSectionZadatel');
            const sectionZastupce = document.getElementById('dataSectionZastupce');
            
            if (!sectionZadatel) return;
            
            // Helper funkce pro generování kontrolních prvků
            function getSectionControls(sectionId) {
                const currentStatus = zadostSectionState[sectionId];
                let statusHtml = '';
                let btnOkActive = '';
                let btnVadaActive = '';
                
                if (currentStatus === 'ok') {
                    statusHtml = '<span class="material-icons-outlined">check_circle</span> V pořádku';
                    btnOkActive = ' active';
                } else if (currentStatus === 'vada') {
                    statusHtml = '<span class="material-icons-outlined">error</span> Označeno jako vada';
                    btnVadaActive = ' active';
                } else {
                    statusHtml = '<span class="material-icons-outlined">radio_button_unchecked</span> Nezkontrolováno';
                }
                
                return `
                    <div class="zadost-section-controls">
                        <div class="zadost-section-status${currentStatus ? ' status-' + currentStatus : ''}" id="sectionStatus${sectionId.charAt(0).toUpperCase() + sectionId.slice(1)}">
                            ${statusHtml}
                        </div>
                        <div class="zadost-section-actions">
                            <button class="zadost-section-btn btn-ok${btnOkActive}" onclick="setSectionStatus('${sectionId}', 'ok')">
                                <span class="material-icons-outlined">check</span>
                                V pořádku
                            </button>
                            <button class="zadost-section-btn btn-vada${btnVadaActive}" onclick="setSectionStatus('${sectionId}', 'vada')">
                                <span class="material-icons-outlined">error_outline</span>
                                Vada
                            </button>
                        </div>
                    </div>
                `;
            }
            
            // Helper pro status badge v hlavičce
            function getStatusBadge(sectionId) {
                const currentStatus = zadostSectionState[sectionId];
                if (currentStatus === 'ok') {
                    return '<span class="section-status-badge ok" id="statusBadge' + sectionId.charAt(0).toUpperCase() + sectionId.slice(1) + '">✓</span>';
                } else if (currentStatus === 'vada') {
                    return '<span class="section-status-badge vada" id="statusBadge' + sectionId.charAt(0).toUpperCase() + sectionId.slice(1) + '">!</span>';
                }
                return '<span class="section-status-badge" id="statusBadge' + sectionId.charAt(0).toUpperCase() + sectionId.slice(1) + '"></span>';
            }
            
            // Aktualizovat sekci Údaje o podání (podatel vs. žadatel)
            const podaniPodatel = document.getElementById('podaniPodatel');
            const podaniVztah = document.getElementById('podaniVztah');
            const podaniVerifyActions = document.getElementById('podaniVerifyActions');
            
            if (podaniPodatel && podaniVztah && podaniVerifyActions) {
                // Určit jméno podavatele
                let podatelJmeno = '';
                if (scenario.zastupce && scenario.zastupceData) {
                    // Podatel je zástupce
                    const zast = scenario.zastupceData;
                    podatelJmeno = zast.nazev || (zast.jmeno + ' ' + zast.prijmeni);
                } else if (scenario.typZadatele === 'po' && scenario.zadatel) {
                    // Podatel je jednatel PO
                    podatelJmeno = scenario.zadatel.jednatel || scenario.zadatel.nazev;
                } else if (scenario.zadatel) {
                    // Podatel je sám žadatel
                    podatelJmeno = scenario.zadatel.jmeno + ' ' + scenario.zadatel.prijmeni;
                } else if (scenario.zadatele && scenario.zadatele[0]) {
                    // Více žadatelů - první je podatel
                    podatelJmeno = scenario.zadatele[0].jmeno + ' ' + scenario.zadatele[0].prijmeni;
                }
                
                podaniPodatel.textContent = podatelJmeno;
                
                // Určit vztah k žadateli a akční tlačítka
                const isReza = scenario.zastupce === 'reza';
                const isPM = scenario.zastupce === 'pm';
                const isPovereni = scenario.zastupce === 'povereni';
                const isStatutar = scenario.zastupce === 'statutar';
                
                if (!scenario.zastupce || scenario.zastupce === null) {
                    // Podatel je sám žadatel
                    podaniVztah.innerHTML = `
                        <span style="display: inline-flex; align-items: center; gap: 6px;">
                            <span class="material-icons-outlined" style="font-size: 18px; color: #34a853;">check_circle</span>
                            Podatel je sám žadatel
                        </span>
                    `;
                    podaniVerifyActions.style.display = 'none';
                } else if (isReza) {
                    // Zástupce s elektronickou plnou mocí (REZA)
                    podaniVztah.innerHTML = `
                        <span style="display: inline-flex; align-items: center; gap: 6px;">
                            <span class="material-icons-outlined" style="font-size: 18px; color: #1a73e8;">supervisor_account</span>
                            Zástupce na základě plné moci
                            <span style="padding: 2px 8px; background: #e8f5e9; color: #2e7d32; border-radius: 4px; font-size: 10px; font-weight: 600;">REZA</span>
                        </span>
                    `;
                    podaniVerifyActions.style.display = 'flex';
                    podaniVerifyActions.innerHTML = `
                        <button class="zastupce-verify-btn reza" onclick="openRezaModal(scenarios[currentScenario].zastupceData || {})">
                            <span class="material-icons-outlined">verified_user</span>
                            Zobrazit plnou moc v REZA
                        </button>
                    `;
                } else if (isPM) {
                    // Zástupce s listinnou plnou mocí
                    podaniVztah.innerHTML = `
                        <span style="display: inline-flex; align-items: center; gap: 6px;">
                            <span class="material-icons-outlined" style="font-size: 18px; color: #e65100;">supervisor_account</span>
                            Zástupce na základě plné moci
                            <span style="padding: 2px 8px; background: #fff3e0; color: #e65100; border-radius: 4px; font-size: 10px; font-weight: 600;">LISTINNÁ</span>
                        </span>
                    `;
                    podaniVerifyActions.style.display = 'flex';
                    podaniVerifyActions.innerHTML = `
                        <button class="zastupce-verify-btn prilohy" onclick="openPrilohyPMModal()">
                            <span class="material-icons-outlined">search</span>
                            Najít plnou moc v přílohách
                        </button>
                    `;
                } else if (isPovereni) {
                    // Pověřená osoba
                    const isPovereniReza = scenario.povereniTyp === 'reza';
                    podaniVztah.innerHTML = `
                        <span style="display: inline-flex; align-items: center; gap: 6px;">
                            <span class="material-icons-outlined" style="font-size: 18px; color: #7b1fa2;">badge</span>
                            Pověřená osoba
                            <span style="padding: 2px 8px; background: ${isPovereniReza ? '#e8f5e9' : '#fff3e0'}; color: ${isPovereniReza ? '#2e7d32' : '#e65100'}; border-radius: 4px; font-size: 10px; font-weight: 600;">${isPovereniReza ? 'REZA' : 'LISTINNÉ'}</span>
                        </span>
                    `;
                    podaniVerifyActions.style.display = 'flex';
                    if (isPovereniReza) {
                        podaniVerifyActions.innerHTML = `
                            <button class="zastupce-verify-btn reza" onclick="openRezaModal({typZastoupeni: 'povereni', ...scenarios[currentScenario].zastupceData})">
                                <span class="material-icons-outlined">verified_user</span>
                                Zobrazit pověření v REZA
                            </button>
                        `;
                    } else {
                        podaniVerifyActions.innerHTML = `
                            <button class="zastupce-verify-btn prilohy" onclick="openPrilohyPMModal()">
                                <span class="material-icons-outlined">search</span>
                                Najít pověření v přílohách
                            </button>
                        `;
                    }
                } else if (isStatutar) {
                    // Statutární zástupce
                    podaniVztah.innerHTML = `
                        <span style="display: inline-flex; align-items: center; gap: 6px;">
                            <span class="material-icons-outlined" style="font-size: 18px; color: #2e7d32;">verified</span>
                            Statutární zástupce právnické osoby
                            <span style="padding: 2px 8px; background: #e8f5e9; color: #2e7d32; border-radius: 4px; font-size: 10px; font-weight: 600;">REZA</span>
                        </span>
                    `;
                    podaniVerifyActions.style.display = 'flex';
                    podaniVerifyActions.innerHTML = `
                        <button class="zastupce-verify-btn reza" onclick="openRezaModal({typZastoupeni: 'statutar', jmeno: '${scenario.zadatel?.jednatel || ""}', zmocnitel: '${scenario.zadatel?.nazev || ""}', zmocnitelId: '${scenario.zadatel?.ico || ""}'})">
                            <span class="material-icons-outlined">verified_user</span>
                            Ověřeno v REZA
                        </button>
                    `;
                }
            }
            
            // Aktualizovat sekci žadatele
            if (scenario.typZadatele === 'fo') {
                const z = scenario.zadatel;
                sectionZadatel.innerHTML = `
                    <div class="zadost-data-section-header">
                        <span class="material-icons-outlined">person</span>
                        Žadatel — Fyzická osoba
                        ${getStatusBadge('zadatel')}
                    </div>
                    <div class="zadost-data-grid">
                        <div class="zadost-data-item">
                            <div class="zadost-data-label">Jméno</div>
                            <div class="zadost-data-value">${z.jmeno}</div>
                        </div>
                        <div class="zadost-data-item">
                            <div class="zadost-data-label">Příjmení</div>
                            <div class="zadost-data-value">${z.prijmeni}</div>
                        </div>
                        <div class="zadost-data-item">
                            <div class="zadost-data-label">Datum narození</div>
                            <div class="zadost-data-value">${z.datumNarozeni}</div>
                        </div>
                        <div class="zadost-data-item">
                            <div class="zadost-data-label">Místo trvalého pobytu</div>
                            <div class="zadost-data-value">${z.trvaleBytem}</div>
                        </div>
                        <div class="zadost-data-item">
                            <div class="zadost-data-label">E-mail</div>
                            <div class="zadost-data-value">${z.email}</div>
                        </div>
                        <div class="zadost-data-item">
                            <div class="zadost-data-label">Telefon</div>
                            <div class="zadost-data-value">${z.telefon}</div>
                        </div>
                        <div class="zadost-data-item">
                            <div class="zadost-data-label">Datová schránka</div>
                            <div class="zadost-data-value">${z.ds || '<span style="color:#9aa0a6;">Nemá zřízenu</span>'}</div>
                        </div>
                    </div>
                    ${getSectionControls('zadatel')}
                `;
            } else if (scenario.typZadatele === 'fo-podnikatel') {
                const z = scenario.zadatel;
                sectionZadatel.innerHTML = `
                    <div class="zadost-data-section-header">
                        <span class="material-icons-outlined">badge</span>
                        Žadatel — Fyzická osoba podnikající
                        ${getStatusBadge('zadatel')}
                    </div>
                    <div class="zadost-data-grid">
                        <div class="zadost-data-item">
                            <div class="zadost-data-label">Jméno</div>
                            <div class="zadost-data-value">${z.jmeno}</div>
                        </div>
                        <div class="zadost-data-item">
                            <div class="zadost-data-label">Příjmení</div>
                            <div class="zadost-data-value">${z.prijmeni}</div>
                        </div>
                        <div class="zadost-data-item">
                            <div class="zadost-data-label">Datum narození</div>
                            <div class="zadost-data-value">${z.datumNarozeni}</div>
                        </div>
                        <div class="zadost-data-item">
                            <div class="zadost-data-label">Místo trvalého pobytu</div>
                            <div class="zadost-data-value">${z.trvaleBytem}</div>
                        </div>
                        <div class="zadost-data-item">
                            <div class="zadost-data-label">IČO</div>
                            <div class="zadost-data-value"><strong>${z.ico}</strong></div>
                        </div>
                        <div class="zadost-data-item">
                            <div class="zadost-data-label">Místo podnikání</div>
                            <div class="zadost-data-value">${z.misto}</div>
                        </div>
                        <div class="zadost-data-item">
                            <div class="zadost-data-label">E-mail</div>
                            <div class="zadost-data-value">${z.email}</div>
                        </div>
                        <div class="zadost-data-item">
                            <div class="zadost-data-label">Datová schránka</div>
                            <div class="zadost-data-value">${z.ds}</div>
                        </div>
                    </div>
                    ${getSectionControls('zadatel')}
                `;
            } else if (scenario.typZadatele === 'po') {
                const z = scenario.zadatel;
                sectionZadatel.innerHTML = `
                    <div class="zadost-data-section-header">
                        <span class="material-icons-outlined">business</span>
                        Žadatel — Právnická osoba
                        ${getStatusBadge('zadatel')}
                    </div>
                    <div class="zadost-data-grid">
                        <div class="zadost-data-item full-width">
                            <div class="zadost-data-label">Název / Obchodní firma</div>
                            <div class="zadost-data-value"><strong>${z.nazev}</strong></div>
                        </div>
                        <div class="zadost-data-item">
                            <div class="zadost-data-label">IČO</div>
                            <div class="zadost-data-value"><strong>${z.ico}</strong></div>
                        </div>
                        <div class="zadost-data-item">
                            <div class="zadost-data-label">Sídlo</div>
                            <div class="zadost-data-value">${z.sidlo}</div>
                        </div>
                        <div class="zadost-data-item">
                            <div class="zadost-data-label">Datová schránka</div>
                            <div class="zadost-data-value">${z.ds}</div>
                        </div>
                        ${z.jednatel ? `
                        <div class="zadost-data-item">
                            <div class="zadost-data-label">Jednatel</div>
                            <div class="zadost-data-value">${z.jednatel}</div>
                        </div>
                        ` : ''}
                    </div>
                    ${getSectionControls('zadatel')}
                `;
            } else if (scenario.typZadatele === 'fo-vice') {
                let html = `
                    <div class="zadost-data-section-header">
                        <span class="material-icons-outlined">group</span>
                        Žadatelé — Spoluvlastníci (${scenario.zadatele.length})
                        ${getStatusBadge('zadatel')}
                    </div>
                `;
                scenario.zadatele.forEach((z, index) => {
                    html += `
                        <div style="padding: 8px 16px; background: #f8f9fa; font-weight: 600; font-size: 12px; color: #5f6368; border-bottom: 1px solid #e0e0e0;">
                            Žadatel ${index + 1}
                        </div>
                        <div class="zadost-data-grid">
                            <div class="zadost-data-item">
                                <div class="zadost-data-label">Jméno</div>
                                <div class="zadost-data-value">${z.jmeno}</div>
                            </div>
                            <div class="zadost-data-item">
                                <div class="zadost-data-label">Příjmení</div>
                                <div class="zadost-data-value">${z.prijmeni}</div>
                            </div>
                            <div class="zadost-data-item">
                                <div class="zadost-data-label">Datum narození</div>
                                <div class="zadost-data-value">${z.datumNarozeni}</div>
                            </div>
                            <div class="zadost-data-item">
                                <div class="zadost-data-label">Trvalé bydliště</div>
                                <div class="zadost-data-value">${z.trvaleBytem}</div>
                            </div>
                            <div class="zadost-data-item">
                                <div class="zadost-data-label">Datová schránka</div>
                                <div class="zadost-data-value">${z.ds || '<span style="color:#9aa0a6;">Nemá zřízenu</span>'}</div>
                            </div>
                        </div>
                    `;
                });
                html += getSectionControls('zadatel');
                sectionZadatel.innerHTML = html;
            }
            
            // Aktualizovat CSS třídu sekce podle stavu
            sectionZadatel.classList.remove('status-ok', 'status-vada');
            if (zadostSectionState.zadatel === 'ok') {
                sectionZadatel.classList.add('status-ok');
            } else if (zadostSectionState.zadatel === 'vada') {
                sectionZadatel.classList.add('status-vada');
            }
            
            // Aktualizovat sekci zástupce
            // Určit, zda je sekce Zástupce relevantní (potřebuje ruční kontrolu)
            const isRezaZastupce = scenario.zastupce === 'reza';
            const isPmZastupce = scenario.zastupce === 'pm';
            const isStatutarZastupce = scenario.zastupce === 'statutar';
            
            // Zástupce je relevantní jen u listinné PM (potřeba najít v přílohách)
            zastupceRelevant = isPmZastupce;
            
            if (scenario.zastupce && scenario.zastupceData) {
                const zast = scenario.zastupceData;
                const isReza = scenario.zastupce === 'reza';
                const isPO = zast.ico && zast.nazev;
                
                // Určit typ zastoupení pro tlačítka
                const typZastoupeni = zast.typZastoupeni || 'plna-moc'; // plna-moc, povereni
                
                let zastupceHtml = `
                    <div class="zadost-data-section-header">
                        <span class="material-icons-outlined">supervisor_account</span>
                        Zástupce na základě ${isReza ? 'REZA' : 'plné moci'}
                        ${isReza ? '<span style="margin-left: 8px; padding: 2px 8px; background: #e8f5e9; color: #2e7d32; border-radius: 4px; font-size: 10px; font-weight: 600;">REZA</span>' : '<span style="margin-left: 8px; padding: 2px 8px; background: #fff3e0; color: #e65100; border-radius: 4px; font-size: 10px; font-weight: 600;">LISTINNÁ</span>'}
                        ${getStatusBadge('zastupce')}
                    </div>
                    <div class="zadost-data-grid">
                `;
                
                if (isPO) {
                    zastupceHtml += `
                        <div class="zadost-data-item full-width">
                            <div class="zadost-data-label">Název / Obchodní firma</div>
                            <div class="zadost-data-value"><strong>${zast.nazev}</strong></div>
                        </div>
                        <div class="zadost-data-item">
                            <div class="zadost-data-label">IČO</div>
                            <div class="zadost-data-value">${zast.ico}</div>
                        </div>
                        <div class="zadost-data-item">
                            <div class="zadost-data-label">Sídlo</div>
                            <div class="zadost-data-value">${zast.sidlo}</div>
                        </div>
                    `;
                } else {
                    zastupceHtml += `
                        <div class="zadost-data-item">
                            <div class="zadost-data-label">Jméno a příjmení</div>
                            <div class="zadost-data-value">${zast.jmeno} ${zast.prijmeni}</div>
                        </div>
                        ${zast.datumNarozeni ? `
                        <div class="zadost-data-item">
                            <div class="zadost-data-label">Datum narození</div>
                            <div class="zadost-data-value">${zast.datumNarozeni}</div>
                        </div>
                        ` : ''}
                        ${zast.ico ? `
                        <div class="zadost-data-item">
                            <div class="zadost-data-label">IČO</div>
                            <div class="zadost-data-value">${zast.ico}</div>
                        </div>
                        ` : ''}
                        <div class="zadost-data-item">
                            <div class="zadost-data-label">Adresa</div>
                            <div class="zadost-data-value">${zast.adresa}</div>
                        </div>
                    `;
                }
                
                zastupceHtml += `
                        <div class="zadost-data-item">
                            <div class="zadost-data-label">Datová schránka</div>
                            <div class="zadost-data-value">${zast.ds}</div>
                        </div>
                        <div class="zadost-data-item full-width" style="background: ${isReza ? '#e8f5e9' : '#fff3e0'};">
                            <div class="zadost-data-label">Typ zmocnění</div>
                            <div class="zadost-data-value">${zast.typPM}</div>
                        </div>
                        <div class="zadost-data-item">
                            <div class="zadost-data-label">Platnost</div>
                            <div class="zadost-data-value">${zast.platnostPM}</div>
                        </div>
                        ${zast.rozsah ? `
                        <div class="zadost-data-item">
                            <div class="zadost-data-label">Rozsah zmocnění</div>
                            <div class="zadost-data-value">${zast.rozsah}</div>
                        </div>
                        ` : ''}
                    </div>
                `;
                
                // Přidat ověřovací tlačítka a kontroly podle typu
                if (isReza) {
                    // REZA - automaticky ověřeno, jen info tlačítko
                    zastupceHtml += `
                    <div class="zastupce-verify-actions">
                        <button class="zastupce-verify-btn reza" onclick="openRezaModal(${JSON.stringify(zast).replace(/"/g, '&quot;')})">
                            <span class="material-icons-outlined">verified_user</span>
                            Zobrazit v REZA
                        </button>
                    </div>
                    <div class="zadost-section-controls">
                        <div class="zadost-section-status status-ok" id="sectionStatusZastupce">
                            <span class="material-icons-outlined">check_circle</span> Ověřeno v REZA
                        </div>
                    </div>
                    `;
                    // Automaticky nastavit na OK
                    setTimeout(() => setSectionAutoOk('zastupce', 'Ověřeno v REZA'), 100);
                } else {
                    // Listinná PM - potřeba ruční kontroly
                    zastupceHtml += `
                    <div class="zastupce-verify-actions">
                        <button class="zastupce-verify-btn prilohy" onclick="openPrilohyPMModal()">
                            <span class="material-icons-outlined">search</span>
                            Najít plnou moc v přílohách
                        </button>
                    </div>
                    `;
                    zastupceHtml += getSectionControls('zastupce');
                }
                
                sectionZastupce.innerHTML = zastupceHtml;
            } else if (scenario.zastupce === 'statutar') {
                sectionZastupce.innerHTML = `
                    <div class="zadost-data-section-header">
                        <span class="material-icons-outlined">supervisor_account</span>
                        Zástupce — Statutární orgán
                        <span style="margin-left: 8px; padding: 2px 8px; background: #e8f5e9; color: #2e7d32; border-radius: 4px; font-size: 10px; font-weight: 600;">REZA</span>
                        ${getStatusBadge('zastupce')}
                    </div>
                    <div class="zadost-data-empty" style="background: #e8f5e9; color: #2e7d32;">
                        <span class="material-icons-outlined">verified</span>
                        Za právnickou osobu jedná jednatel jako statutární orgán
                    </div>
                    <div class="zastupce-verify-actions">
                        <button class="zastupce-verify-btn reza" onclick="openRezaModal({typZastoupeni: 'statutar', jmeno: '${scenario.zadatel?.jednatel || "Ing. Pavel Horák"}', zmocnitel: '${scenario.zadatel?.nazev || ""}', zmocnitelId: '${scenario.zadatel?.ico || ""}'})">
                            <span class="material-icons-outlined">verified_user</span>
                            Ověřeno v REZA
                        </button>
                    </div>
                    <div class="zadost-section-controls">
                        <div class="zadost-section-status status-ok" id="sectionStatusZastupce">
                            <span class="material-icons-outlined">check_circle</span> Ověřeno v REZA
                        </div>
                    </div>
                `;
                // Automaticky nastavit na OK
                setTimeout(() => setSectionAutoOk('zastupce', 'Ověřeno v REZA'), 100);
            } else {
                // Žádný zástupce - automaticky OK
                sectionZastupce.innerHTML = `
                    <div class="zadost-data-section-header">
                        <span class="material-icons-outlined">supervisor_account</span>
                        Zástupce
                        ${getStatusBadge('zastupce')}
                    </div>
                    <div class="zadost-data-empty">
                        <span class="material-icons-outlined">person_off</span>
                        Žadatel jedná sám za sebe, zástupce není uveden
                    </div>
                    <div class="zadost-section-controls">
                        <div class="zadost-section-status status-ok" id="sectionStatusZastupce">
                            <span class="material-icons-outlined">check_circle</span> Není potřeba kontrolovat
                        </div>
                    </div>
                `;
                // Automaticky nastavit na OK
                setTimeout(() => setSectionAutoOk('zastupce', 'Není potřeba kontrolovat'), 100);
            }
            
            // Aktualizovat CSS třídu sekce zástupce podle stavu
            sectionZastupce.classList.remove('status-ok', 'status-vada');
            if (zadostSectionState.zastupce === 'ok') {
                sectionZastupce.classList.add('status-ok');
            } else if (zadostSectionState.zastupce === 'vada') {
                sectionZastupce.classList.add('status-vada');
            }
            
            // Aktualizovat sekci Přílohy podle scénáře
            const prilohyList = document.getElementById('prilohyList');
            const prilohyVerifyActions = document.getElementById('prilohyVerifyActions');
            
            if (prilohyList) {
                let prilohyHtml = '';
                
                // Plná moc
                if (scenario.zastupce === 'pm') {
                    prilohyHtml += `
                        <div class="priloha-inline-item pending">
                            <span class="material-icons-outlined">description</span>
                            Plná moc — <strong>ke kontrole</strong>
                        </div>
                    `;
                    prilohyVerifyActions.style.display = 'flex';
                } else if (scenario.zastupce === 'reza' || scenario.zastupce === 'statutar') {
                    prilohyHtml += `
                        <div class="priloha-inline-item na">
                            <span class="material-icons-outlined">remove_circle_outline</span>
                            Plná moc — ověřeno v REZA
                        </div>
                    `;
                } else {
                    prilohyHtml += `
                        <div class="priloha-inline-item na">
                            <span class="material-icons-outlined">remove_circle_outline</span>
                            Plná moc — neaplikuje se (žadatel jedná sám)
                        </div>
                    `;
                }
                
                // Souhlas vlastníka pozemku
                if (!scenario.vlastnik) {
                    prilohyHtml += `
                        <div class="priloha-inline-item pending">
                            <span class="material-icons-outlined">description</span>
                            Souhlas vlastníka pozemku — <strong>ke kontrole</strong>
                        </div>
                    `;
                    prilohyVerifyActions.style.display = 'flex';
                } else {
                    prilohyHtml += `
                        <div class="priloha-inline-item na">
                            <span class="material-icons-outlined">remove_circle_outline</span>
                            Souhlas vlastníka pozemku — neaplikuje se (žadatel je vlastník)
                        </div>
                    `;
                }
                
                // Pokud nejsou žádné přílohy ke kontrole, skrýt tlačítko
                if (!scenario.zastupce || scenario.zastupce !== 'pm') {
                    if (scenario.vlastnik) {
                        prilohyVerifyActions.style.display = 'none';
                    }
                }
                
                prilohyList.innerHTML = prilohyHtml;
            }
            
            // Aktualizovat sekci výjimek
            const sectionVyjimky = document.getElementById('dataSectionVyjimky');
            if (sectionVyjimky) {
                if (scenario.vyjimka) {
                    // Zobrazit sekci výjimek
                    sectionVyjimky.style.display = 'block';
                    sectionVyjimky.innerHTML = `
                        <div class="zadost-data-section-header">
                            <span class="material-icons-outlined">rule</span>
                            Výjimky z obecných požadavků
                            <span style="margin-left: 8px; padding: 2px 8px; background: #fff3e0; color: #ef6c00; border-radius: 4px; font-size: 10px; font-weight: 600;">ŽÁDÁNO</span>
                            ${getStatusBadge('vyjimky')}
                        </div>
                        <div class="zadost-data-grid">
                            <div class="zadost-data-item full-width">
                                <div class="zadost-data-label">Typ výjimky</div>
                                <div class="zadost-data-value"><strong>${scenario.vyjimka.typ}</strong></div>
                            </div>
                            <div class="zadost-data-item full-width">
                                <div class="zadost-data-label">Popis</div>
                                <div class="zadost-data-value">${scenario.vyjimka.popis}</div>
                            </div>
                            <div class="zadost-data-item full-width">
                                <div class="zadost-data-label">Odůvodnění žadatele</div>
                                <div class="zadost-data-value" style="background: #fffde7; padding: 8px; border-radius: 4px; font-style: italic;">${scenario.vyjimka.oduvodneni}</div>
                            </div>
                        </div>
                        ${getSectionControls('vyjimky')}
                    `;
                    // Reset stavu výjimek
                    resetSectionControls('vyjimky');
                } else {
                    // Skrýt sekci výjimek a nastavit automaticky OK
                    sectionVyjimky.style.display = 'none';
                    zadostSectionState.vyjimky = 'ok';
                }
            }
            
            // Aktualizovat deficiency panel
            setTimeout(() => updateDeficiencyPanel(), 150);
        }
        
        // Aktualizovat checklist podle scénáře
        function updateKontrolaZadostiChecklist(scenario) {
            const checklist = document.querySelector('.zadost-checklist');
            if (!checklist) return;
            
            // Reset všech položek
            checklist.querySelectorAll('.checklist-item').forEach(item => {
                item.classList.remove('disabled', 'checked-ok', 'checked-error');
                const actions = item.querySelector('.checklist-actions');
                if (actions) {
                    actions.innerHTML = `
                        <button class="checklist-btn ok" onclick="toggleChecklistItem(this, 'ok')" title="V pořádku">
                            <span class="material-icons-outlined">check</span>
                        </button>
                        <button class="checklist-btn error" onclick="toggleChecklistItem(this, 'error')" title="Vadné">
                            <span class="material-icons-outlined">close</span>
                        </button>
                    `;
                }
            });
            
            // Nastavit disabled položky podle scénáře
            const setDisabled = (text) => {
                checklist.querySelectorAll('.checklist-item').forEach(item => {
                    if (item.querySelector('.checklist-text').textContent.includes(text)) {
                        item.classList.add('disabled');
                        item.querySelector('.checklist-actions').innerHTML = `
                            <button class="checklist-btn na" disabled title="Neaplikuje se">
                                <span class="material-icons-outlined">remove</span>
                            </button>
                        `;
                    }
                });
            };
            
            const setEnabled = (text) => {
                checklist.querySelectorAll('.checklist-item').forEach(item => {
                    if (item.querySelector('.checklist-text').textContent.includes(text)) {
                        item.classList.remove('disabled');
                        item.querySelector('.checklist-actions').innerHTML = `
                            <button class="checklist-btn ok" onclick="toggleChecklistItem(this, 'ok')" title="V pořádku">
                                <span class="material-icons-outlined">check</span>
                            </button>
                            <button class="checklist-btn error" onclick="toggleChecklistItem(this, 'error')" title="Vadné">
                                <span class="material-icons-outlined">close</span>
                            </button>
                        `;
                    }
                });
            };
            
            // Typ žadatele
            if (scenario.typZadatele === 'fo') {
                setDisabled('Fyzická osoba podnikající');
                setDisabled('Právnická osoba uvedla');
            } else if (scenario.typZadatele === 'fo-podnikatel') {
                setDisabled('Právnická osoba uvedla');
                setEnabled('Fyzická osoba podnikající');
            } else if (scenario.typZadatele === 'po') {
                setDisabled('Fyzická osoba uvedla jméno');
                setDisabled('Fyzická osoba podnikající');
                setEnabled('Právnická osoba uvedla');
            } else if (scenario.typZadatele === 'fo-vice') {
                setDisabled('Fyzická osoba podnikající');
                setDisabled('Právnická osoba uvedla');
            }
            
            // Plná moc
            if (scenario.zastupce === 'pm' || scenario.zastupce === 'reza') {
                setEnabled('Plná moc');
            } else {
                setDisabled('Plná moc');
            }
            
            // Vlastnictví
            if (!scenario.vlastnik) {
                setEnabled('Souhlas vlastníka');
                setEnabled('Čestné prohlášení');
            } else {
                setDisabled('Souhlas vlastníka');
                setDisabled('Čestné prohlášení');
            }
            
            // Výjimky
            if (scenario.vyjimka) {
                setEnabled('Popis a odůvodnění výjimky');
            } else {
                setDisabled('Popis a odůvodnění výjimky');
            }
        }
        
        // Kopírovat URL scénáře
        function copyScenarioUrl() {
            const url = window.location.href;
            navigator.clipboard.writeText(url).then(() => {
                showSimToast('URL zkopírována do schránky');
            });
        }
        
        // Reset na základní scénář
        function resetScenario() {
            document.querySelector('input[name="scenar"][value="zakladni"]').checked = true;
            applyScenario('zakladni');
        }
        
        // Toast pro simulační panel
        function showSimToast(message) {
            const existing = document.querySelector('.sim-toast');
            if (existing) existing.remove();
            
            const toast = document.createElement('div');
            toast.className = 'sim-toast';
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 2000);
        }
        
        // Inicializace při načtení stránky
        document.addEventListener('DOMContentLoaded', function() {
            initSimulationPanel();
        });
    </script>
    <script src="doc-modals.js"></script>
    <script>initDocModals({ basePath: '../docs/' });</script>
</body>
</html>
